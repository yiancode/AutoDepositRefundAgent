# çŸ¥è¯†æ˜Ÿçƒè®­ç»ƒè¥è‡ªåŠ¨æŠ¼é‡‘é€€æ¬¾ç³»ç»Ÿ - æŠ€æœ¯æ–¹æ¡ˆ

| **ç‰ˆæœ¬** | v1.1       |
| -------- |------------|
| **ä½œè€…** | æ˜“å®‰ç³»ç»Ÿæ¶æ„å¸ˆ    |
| **æ—¥æœŸ** | 2025-12-06 |
| **çŠ¶æ€** | å·²å‘å¸ƒ        |
| **SSOTå¼•ç”¨** | [çŠ¶æ€æšä¸¾å®šä¹‰.md](./çŠ¶æ€æšä¸¾å®šä¹‰.md) |

**ä¿®è®¢è®°å½•**

| ç‰ˆæœ¬ | ä¿®è®¢å†…å®¹ | æ—¥æœŸ | ç¼–åˆ¶äºº |
|------|----------|------|--------|
| v0.1 | åˆç‰ˆï¼ˆåŸºäºä¼ ç»Ÿæ¨¡æ¿ï¼‰ | 2025-10-24 | - |
| v0.2 | é‡æ„ä¸º AI åä½œç‰ˆï¼Œå¢åŠ ç”¨æˆ·æ—…ç¨‹ã€æ•…äº‹å¡ç‰‡ã€C4 æ¶æ„ | 2025-11-29 | - |
| v1.0 | æ•´åˆæ‰€æœ‰æ–‡æ¡£ä¸ºç»Ÿä¸€æŠ€æœ¯æ–¹æ¡ˆï¼Œå‘å¸ƒç‰ˆ | 2025-12-05 | - |
| v1.1 | ä¿®å¤æ–‡æ¡£é“¾æ¥ï¼Œæ·»åŠ  SSOT å¼•ç”¨ï¼Œç»Ÿä¸€çŠ¶æ€å€¼å¤§å°å†™ | 2025-12-06 | - |

---

## ç›®å½•

1. [åè¯è§£é‡Š](#ä¸€åè¯è§£é‡Š)
2. [éœ€æ±‚èƒŒæ™¯](#äºŒéœ€æ±‚èƒŒæ™¯)
3. [éœ€æ±‚åˆ†æ](#ä¸‰éœ€æ±‚åˆ†æ)
4. [æ¦‚è¦è®¾è®¡](#å››æ¦‚è¦è®¾è®¡)
5. [è¯¦ç»†è®¾è®¡](#äº”è¯¦ç»†è®¾è®¡)
6. [é£é™©ä¸åº”å¯¹](#å…­é£é™©ä¸åº”å¯¹)
7. [æµ‹è¯•æ–¹æ¡ˆ](#ä¸ƒæµ‹è¯•æ–¹æ¡ˆ)
8. [æŒ‡æ ‡ç›‘æ§](#å…«æŒ‡æ ‡ç›‘æ§)
9. [ä¸Šçº¿æ–¹æ¡ˆ](#ä¹ä¸Šçº¿æ–¹æ¡ˆ)
10. [å‚è€ƒæ–‡çŒ®](#åå‚è€ƒæ–‡çŒ®)
11. [é™„å½•ï¼šAI åä½œå¢å¼º](#é™„å½•ai-åä½œå¢å¼º)

---

# ä¸€ã€åè¯è§£é‡Š

| æœ¯è¯­ | è§£é‡Š |
|------|------|
| **çŸ¥è¯†æ˜Ÿçƒ** | çŸ¥è¯†ä»˜è´¹ç¤¾ç¾¤å¹³å°ï¼Œç”¨æˆ·åœ¨æ­¤æ‰“å¡å­¦ä¹  |
| **è®­ç»ƒè¥** | é™æ—¶æ‰“å¡æ´»åŠ¨ï¼Œä¼šå‘˜ç¼´çº³æŠ¼é‡‘å‚ä¸ |
| **æŠ¼é‡‘** | ä¼šå‘˜æŠ¥åæ—¶ç¼´çº³çš„ä¿è¯é‡‘ï¼Œå®Œæˆæ‰“å¡åé€€è¿˜ |
| **æ‰“å¡** | ä¼šå‘˜åœ¨çŸ¥è¯†æ˜Ÿçƒå‘å¸ƒå­¦ä¹ å†…å®¹çš„è¡Œä¸º |
| **H5 æŠ¥åé“¾æ¥** | ç”¨æˆ·é€šè¿‡å¾®ä¿¡ OAuth ç™»å½•åè®¿é—®çš„æŠ¥åé¡µé¢ |
| **å›ºå®šäºŒç»´ç ** | å¾®ä¿¡æ”¶æ¬¾ç ï¼Œç”¨æˆ·æ‰«ç åéœ€æ‰‹åŠ¨å¡«å†™æ˜Ÿçƒä¿¡æ¯ |
| **bind_status** | ç»‘å®šçŠ¶æ€ï¼špending/completed/expired/manual_review/closed |
| **bind_method** | ç»‘å®šæ–¹å¼ï¼šh5_bindplanet/user_fill/manual |
| **å®½é™å¤©æ•°** | æ‰“å¡å¤©æ•°è®¡ç®—æ—¶é¢å¤–ç»™äºˆçš„å®½é™ï¼ˆé»˜è®¤1å¤©ï¼‰ |
| **å¾®ä¿¡ OAuth** | å¾®ä¿¡å…¬ä¼—å·æˆæƒç™»å½•ï¼Œç”¨äºè·å–ç”¨æˆ·å¾®ä¿¡èº«ä»½ |
| **å¾®ä¿¡ OpenID** | å¾®ä¿¡å…¬ä¼—å·ç”¨æˆ·å”¯ä¸€æ ‡è¯†ï¼ŒåŒä¸€ç”¨æˆ·åœ¨ä¸åŒå…¬ä¼—å·ä¸‹ OpenID ä¸åŒ |
| **access_token** | ç³»ç»Ÿè®¿é—®ç¥¨æ®ï¼Œæ ¼å¼ `tk_` + UUIDï¼Œç”¨äº H5 æ•æ„Ÿæ¥å£è®¤è¯ |

---

# äºŒã€éœ€æ±‚èƒŒæ™¯

## 2.1 ä¸šåŠ¡ç°çŠ¶

ç›®å‰çŸ¥è¯†æ˜Ÿçƒè®­ç»ƒè¥çš„æŠ¼é‡‘æ”¶å–ã€æ‰“å¡æ ¸å¯¹ã€é€€æ¬¾æ“ä½œå…¨éƒ¨æ‰‹åŠ¨å®Œæˆï¼š
- æ¯æœˆæœ‰ **5-10 ä¸ªè®­ç»ƒè¥**åŒæ—¶è¿›è¡Œ
- å•ä¸ªè®­ç»ƒè¥æœ€å¤š **1000 äºº**å‚ä¸
- äººå·¥å¤„ç†å·¥ä½œé‡å·¨å¤§ï¼Œæ•ˆç‡ä½ä¸”å®¹æ˜“å‡ºé”™

## 2.2 æ ¸å¿ƒç—›ç‚¹

| ç—›ç‚¹ | æè¿° | å½±å“ |
|------|------|------|
| èº«ä»½åŒ¹é…å›°éš¾ | æ”¯ä»˜å¾®ä¿¡åä¸æ˜Ÿçƒæ˜µç§°ä¸ä¸€è‡´ | é€€æ¬¾é”™è¯¯ã€æŠ•è¯‰å¢åŠ  |
| æ‰‹åŠ¨æ“ä½œç¹ç | å¯¼å‡ºâ†’å¯¹æ¯”â†’é€€æ¬¾â†’é€šçŸ¥å…¨æ‰‹å·¥ | å•è¥è€—æ—¶ 2-4 å°æ—¶ |
| æ•°æ®åˆ†æ•£ | æ”¯ä»˜åœ¨å¾®ä¿¡ã€æ‰“å¡åœ¨æ˜Ÿçƒ | æ ¸å¯¹å›°éš¾ã€æ˜“é—æ¼ |
| å“åº”å»¶è¿Ÿ | é€€æ¬¾ä¾èµ–äººå·¥æ’æœŸ | ç”¨æˆ·ä½“éªŒå·® |

## 2.3 å»ºè®¾ç›®æ ‡

æ„å»ºä¸€å¥—è‡ªåŠ¨åŒ–ç³»ç»Ÿï¼Œå®ç°ï¼š
- **è‡ªåŠ¨åŒ–æ”¯ä»˜æµç¨‹**ï¼šä¼šå‘˜æ”¯ä»˜æŠ¼é‡‘åç«‹å³è·å¾—å…¥ç¾¤äºŒç»´ç 
- **è‡ªåŠ¨åŒ–æ•°æ®åŒæ­¥**ï¼šæ¯æ—¥è‡ªåŠ¨åŒæ­¥çŸ¥è¯†æ˜Ÿçƒæ‰“å¡æ•°æ®
- **æ··åˆåŒ¹é…è¯†åˆ«**ï¼šå¤šç§æ–¹å¼ç¡®ä¿èº«ä»½åŒ¹é…å‡†ç¡®ç‡
- **åŠè‡ªåŠ¨é€€æ¬¾**ï¼šç³»ç»Ÿåˆ¤æ–­ + äººå·¥å®¡æ ¸ + è‡ªåŠ¨é€€æ¬¾

---

# ä¸‰ã€éœ€æ±‚åˆ†æ

## 3.1 ç”¨æˆ·è§’è‰²

| è§’è‰² | æè¿° | ä¸»è¦ç›®æ ‡ |
|------|------|----------|
| **è¶…çº§ç®¡ç†å‘˜** | æ˜Ÿä¸»æœ¬äºº | ç³»ç»Ÿé…ç½®ã€å…¨å±€ç®¡ç† |
| **ç®¡ç†å‘˜** | è¿è¥äººå‘˜ | å®¡æ ¸é€€æ¬¾ã€æŸ¥çœ‹æŠ¥è¡¨ |
| **æ•™ç»ƒ** | é¡¹ç›®æ•™ç»ƒ | æŸ¥çœ‹è´Ÿè´£é¡¹ç›®ã€å‚¬ä¿ƒæ‰“å¡ |
| **å¿—æ„¿è€…** | é¡¹ç›®å¿—æ„¿è€… | æŸ¥çœ‹é¡¹ç›®ã€å‚¬ä¿ƒæ‰“å¡ |
| **ä¼šå‘˜** | çŸ¥è¯†æ˜Ÿçƒä¼šå‘˜ | æ”¯ä»˜æŠ¼é‡‘ã€æ‰“å¡ã€è·å–é€€æ¬¾ |

## 3.2 æ ¸å¿ƒè¯‰æ±‚

### ä¼šå‘˜è¯‰æ±‚
- æ”¯ä»˜åå¿«é€Ÿè·å¾—å…¥ç¾¤æ–¹å¼
- å®æ—¶æŸ¥çœ‹æ‰“å¡è¿›åº¦
- åŠæ—¶æ”¶åˆ°é€€æ¬¾

### ç®¡ç†å‘˜è¯‰æ±‚
- å‡å°‘æ‰‹åŠ¨æ“ä½œæ—¶é—´
- å‡†ç¡®çš„èº«ä»½åŒ¹é…
- æ¸…æ™°çš„æ•°æ®æŠ¥è¡¨

## 3.3 ç›®æ ‡ä¸æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰å€¼ | ç›®æ ‡å€¼ | éªŒè¯æ–¹å¼ |
|------|--------|--------|----------|
| äººå·¥æ“ä½œæ—¶é—´ | 100% | < 10% | æ“ä½œæ—¥å¿—ç»Ÿè®¡ |
| é€€æ¬¾å‡†ç¡®ç‡ | 95% | 100% | é€€æ¬¾ç»“æœå®¡è®¡ |
| æ”¯ä»˜åˆ°è¿›ç¾¤æ—¶é—´ | äººå·¥å¤„ç† | < 3 ç§’ | æ¥å£å“åº”ç›‘æ§ |
| å•è¥å¤„ç†æ—¶é—´ | 2-4 å°æ—¶ | < 10 åˆ†é’Ÿ | è®¡æ—¶æµ‹è¯• |

## 3.4 éç›®æ ‡ï¼ˆScope Outï¼‰

- âŒ æœ¬æ¬¡ä¸åŒ…å«ï¼šä¼šå‘˜ç«¯ App å¼€å‘ï¼ˆä»… H5ï¼‰
- âŒ æš‚ä¸æ”¯æŒï¼šå¤šçŸ¥è¯†æ˜Ÿçƒç®¡ç†
- âŒ åç»­ç‰ˆæœ¬å†è€ƒè™‘ï¼šç§¯åˆ†æ¿€åŠ±ä½“ç³»ã€æ•°æ®é¢„æµ‹åˆ†æ

## 3.5 éªŒæ”¶æ ‡å‡†

| Story ID | åŠŸèƒ½ç‚¹ | éªŒæ”¶æ ‡å‡† | ä¼˜å…ˆçº§ |
|----------|--------|----------|--------|
| S1.1 | åˆ›å»ºè®­ç»ƒè¥ | å¡«å†™è¡¨å•åæˆåŠŸåˆ›å»ºï¼Œç”ŸæˆæŠ¥åé“¾æ¥ | P0 |
| S2.1 | æ”¯ä»˜æŠ¼é‡‘ | å¾®ä¿¡æ”¯ä»˜æˆåŠŸåæ˜¾ç¤ºç¾¤äºŒç»´ç  | P0 |
| S2.2 | æ”¯ä»˜å›è°ƒ | Webhook 3 ç§’å†…å¤„ç†å®Œæˆï¼Œä¿å­˜æ”¯ä»˜æ˜ å°„ | P0 |
| S2.3 | æ”¯ä»˜åç»‘å®š | å›ºå®šäºŒç»´ç ç”¨æˆ·å¯é€šè¿‡ H5 é¡µé¢ç»‘å®šæ˜Ÿçƒä¿¡æ¯ | P0 |
| S3.1 | æ‰“å¡åŒæ­¥ | æ¯æ—¥ 01:00 è‡ªåŠ¨åŒæ­¥ï¼Œå¤±è´¥å‘Šè­¦ | P0 |
| S4.1 | ç»‘å®šå¤„ç† | H5 ä¸»è·¯å¾„è‡ªåŠ¨ç»‘å®šï¼Œé™çº§è·¯å¾„ç”¨æˆ·å¡«å†™æˆ–äººå·¥å¤„ç† | P0 |
| S5.1 | å®¡æ ¸é€€æ¬¾ | ç®¡ç†å‘˜å¯æ‰¹é‡å®¡æ ¸é€šè¿‡/æ‹’ç» | P0 |
| S5.2 | æ‰§è¡Œé€€æ¬¾ | è°ƒç”¨å¾®ä¿¡é€€æ¬¾ API æˆåŠŸç‡ â‰¥ 99% | P0 |

---

# å››ã€æ¦‚è¦è®¾è®¡

## 4.1 æ”¯ä»˜-èº«ä»½ç»‘å®šæ–¹æ¡ˆ

é‡‡ç”¨ **H5 ä¸»è·¯å¾„ + é™çº§è·¯å¾„** åŒè·¯å¾„æ–¹æ¡ˆï¼ˆäº’æ–¥ï¼‰ï¼š

| æ”¯ä»˜æ–¹å¼ | è¦†ç›–ç‡ | å‡†ç¡®ç‡ | å®ç°æ–¹å¼ |
|----------|--------|--------|----------|
| H5 ä¸»è·¯å¾„ | 80% | 100% | ç”¨æˆ· OAuth ç™»å½•åç»‘å®šæ˜Ÿçƒèº«ä»½ï¼Œç›´æ¥æ”¯ä»˜ |
| é™çº§è·¯å¾„-ç”¨æˆ·å¡«å†™ | 15% | 95% | ç”¨æˆ·æ‰«å›ºå®šäºŒç»´ç æ”¯ä»˜åï¼ŒH5 é¡µé¢å¡«å†™æ˜Ÿçƒä¿¡æ¯ |
| äººå·¥å¤„ç† | 5% | 100% | è¶…æ—¶æœªç»‘å®šæˆ–ä¿¡æ¯å¼‚å¸¸ç”±ç®¡ç†å‘˜äººå·¥ç»‘å®š |

## 4.2 æŠ€æœ¯é€‰å‹

| å±‚çº§ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ | é€‰å‹ç†ç”± |
|------|---------|------|----------|
| **åç«¯è¯­è¨€** | Java | 17+ | ä¼ä¸šçº§ç¨³å®šæ€§ |
| **åç«¯æ¡†æ¶** | Spring Boot | 3.2+ | ç”Ÿæ€æˆç†Ÿ |
| **æ•°æ®åº“** | PostgreSQL | 15+ | JSONB æ”¯æŒå¼º |
| **ç¼“å­˜** | Redis | 7.x | é«˜æ€§èƒ½ç¼“å­˜ |
| **æ¶ˆæ¯é˜Ÿåˆ—** | RabbitMQ | 3.12+ | äº‹åŠ¡æ€§æ¶ˆæ¯ |
| **å‰ç«¯æ¡†æ¶** | Vue 3 | 3.3+ | ç»„åˆå¼ API |
| **H5 UI** | Vant | 4.x | ç§»åŠ¨ç«¯å‹å¥½ |
| **åå° UI** | Element Plus | 2.4+ | ä¼ä¸šçº§ç»„ä»¶ |
| **OAuthè®¤è¯** | å¾®ä¿¡å…¬ä¼—å· OAuth 2.0 | - | ç”¨æˆ·èº«ä»½è¯†åˆ«ï¼ˆè¯¦è§ [OAuthå®‰å…¨æŒ‡å—](../security/OAuthå®‰å…¨æŒ‡å—.md)ï¼‰ |

### ADR-001: æ•°æ®åº“é€‰å‹å†³ç­–

**è€ƒè™‘çš„æ–¹æ¡ˆ**ï¼š

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| MySQL | ç”Ÿæ€æˆç†Ÿã€è¿ç»´ç†Ÿæ‚‰ | JSON æ”¯æŒå¼± |
| PostgreSQL | JSON æ”¯æŒå¼ºã€åŠŸèƒ½ä¸°å¯Œ | è¿ç»´ç»éªŒç›¸å¯¹å°‘ |

**å†³ç­–**ï¼šé€‰æ‹© PostgreSQL 15+

**ç†ç”±**ï¼š
- å¼ºå¤§çš„ JSONB æ”¯æŒï¼Œé€‚åˆå­˜å‚¨ API å“åº”
- å®Œå–„çš„äº‹åŠ¡å’Œå¹¶å‘æ§åˆ¶
- äº‘æœåŠ¡å•†æ”¯æŒå®Œå–„

## 4.3 ç³»ç»Ÿä¸Šä¸‹æ–‡ï¼ˆC4 Level 1ï¼‰

```mermaid
C4Context
    title ç³»ç»Ÿä¸Šä¸‹æ–‡å›¾ - çŸ¥è¯†æ˜Ÿçƒè®­ç»ƒè¥æŠ¼é‡‘é€€æ¬¾ç³»ç»Ÿ

    Person(member, "ä¼šå‘˜", "çŸ¥è¯†æ˜Ÿçƒä¼šå‘˜ï¼Œå‚ä¸è®­ç»ƒè¥æ‰“å¡")
    Person(admin, "ç®¡ç†å‘˜", "è¿è¥äººå‘˜ï¼Œç®¡ç†è®­ç»ƒè¥å’Œå®¡æ ¸é€€æ¬¾")
    Person(coach, "æ•™ç»ƒ", "é¡¹ç›®æ•™ç»ƒï¼ŒæŸ¥çœ‹è´Ÿè´£é¡¹ç›®æ•°æ®")

    System(campSystem, "è®­ç»ƒè¥æŠ¼é‡‘é€€æ¬¾ç³»ç»Ÿ", "è‡ªåŠ¨åŒ–å¤„ç†æŠ¥åæ”¯ä»˜ã€æ‰“å¡åŒæ­¥ã€èº«ä»½åŒ¹é…ã€é€€æ¬¾å®¡æ ¸")

    System_Ext(zsxq, "çŸ¥è¯†æ˜Ÿçƒ", "æä¾›æ‰“å¡æ•°æ®API")
    System_Ext(wechatPay, "å¾®ä¿¡æ”¯ä»˜", "å¤„ç†æ”¶æ¬¾å’Œé€€æ¬¾")
    System_Ext(wechatWork, "ä¼ä¸šå¾®ä¿¡", "æ¶ˆæ¯é€šçŸ¥æ¨é€")

    Rel(member, campSystem, "æŠ¥åæ”¯ä»˜ã€æŸ¥çœ‹è¿›åº¦", "H5/HTTPS")
    Rel(admin, campSystem, "ç®¡ç†è®­ç»ƒè¥ã€å®¡æ ¸é€€æ¬¾", "Web/HTTPS")
    Rel(coach, campSystem, "æŸ¥çœ‹é¡¹ç›®æ•°æ®", "Web/HTTPS")

    Rel(campSystem, zsxq, "åŒæ­¥æ‰“å¡æ•°æ®", "REST API")
    Rel(campSystem, wechatPay, "åˆ›å»ºæ”¯ä»˜ã€æ‰§è¡Œé€€æ¬¾", "REST API")
    Rel(campSystem, wechatWork, "å‘é€é€šçŸ¥æ¶ˆæ¯", "REST API")
```

## 4.4 å®¹å™¨æ¶æ„ï¼ˆC4 Level 2ï¼‰

> **éƒ¨ç½²å½¢æ€è¯´æ˜**ï¼šv1 é‡‡ç”¨å•èŠ‚ç‚¹éƒ¨ç½²ï¼Œæ‰€æœ‰æœåŠ¡è¿è¡Œåœ¨ä¸€å°æœåŠ¡å™¨ä¸Šã€‚æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRabbitMQï¼‰ä¸º**å¯é€‰æ‰©å±•**ï¼ŒåˆæœŸä½¿ç”¨ Spring å†…ç½®çš„å¼‚æ­¥ä»»åŠ¡æ›¿ä»£ï¼Œåç»­æ ¹æ®è´Ÿè½½æƒ…å†µå¯ç”¨ã€‚

```mermaid
C4Container
    title å®¹å™¨å›¾ - ç³»ç»Ÿå†…éƒ¨ç»“æ„ï¼ˆå•èŠ‚ç‚¹éƒ¨ç½²ï¼‰

    Person(member, "ä¼šå‘˜")
    Person(admin, "ç®¡ç†å‘˜")

    System_Boundary(system, "è®­ç»ƒè¥æŠ¼é‡‘é€€æ¬¾ç³»ç»Ÿ") {
        Container(h5Web, "H5 ä¼šå‘˜ç«¯", "Vue 3, Vant UI", "æŠ¥åæ”¯ä»˜ã€è¿›åº¦æŸ¥è¯¢ã€é€€æ¬¾æŸ¥çœ‹")
        Container(adminWeb, "Web ç®¡ç†åå°", "Vue 3, Element Plus", "è®­ç»ƒè¥ç®¡ç†ã€é€€æ¬¾å®¡æ ¸ã€ç»Ÿè®¡æŠ¥è¡¨")

        Container(apiServer, "API æœåŠ¡", "Spring Boot 3.2, Java 17", "æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€RESTful APIã€SSL ç»ˆæ­¢ã€é™æµ")

        Container(scheduler, "å®šæ—¶ä»»åŠ¡", "Spring Scheduler", "æ‰“å¡åŒæ­¥ã€é€€æ¬¾æ‰§è¡Œã€æ•°æ®æ¸…ç†")

        ContainerDb(postgres, "PostgreSQL", "PostgreSQL 15", "ä¸šåŠ¡æ•°æ®å­˜å‚¨")
        ContainerDb(redis, "Redis", "Redis 7", "ç¼“å­˜ã€ä¼šè¯ã€é™æµè®¡æ•°")
    }

    System_Ext(zsxq, "çŸ¥è¯†æ˜Ÿçƒ API")
    System_Ext(wechatPay, "å¾®ä¿¡æ”¯ä»˜")
    System_Ext(wechatWork, "ä¼ä¸šå¾®ä¿¡é€šçŸ¥")

    Rel(member, h5Web, "ä½¿ç”¨", "HTTPS")
    Rel(admin, adminWeb, "ä½¿ç”¨", "HTTPS")

    Rel(h5Web, apiServer, "è°ƒç”¨", "HTTPS/REST")
    Rel(adminWeb, apiServer, "è°ƒç”¨", "HTTPS/REST")

    Rel(apiServer, postgres, "è¯»å†™", "JDBC")
    Rel(apiServer, redis, "ç¼“å­˜", "Redis Protocol")

    Rel(scheduler, apiServer, "è°ƒç”¨", "å†…éƒ¨æ–¹æ³•")

    Rel(apiServer, zsxq, "åŒæ­¥æ‰“å¡", "HTTPS/REST")
    Rel(apiServer, wechatPay, "æ”¯ä»˜/é€€æ¬¾", "HTTPS/REST")
    Rel(apiServer, wechatWork, "é€šçŸ¥", "HTTPS/REST")
```

**æ‰©å±•è·¯å¾„**ï¼ˆåç»­å®¹é‡æå‡æ—¶å¯ç”¨ï¼‰ï¼š
| é˜¶æ®µ | è§¦å‘æ¡ä»¶ | æ‰©å±•ç»„ä»¶ |
|------|----------|----------|
| é˜¶æ®µ 1 | å½“å‰ | å•èŠ‚ç‚¹ API + PostgreSQL + Redis |
| é˜¶æ®µ 2 | å¹¶å‘ > 100 QPS | æ·»åŠ  Nginx åå‘ä»£ç† |
| é˜¶æ®µ 3 | å¼‚æ­¥ä»»åŠ¡ç§¯å‹ | å¼•å…¥ RabbitMQ æ¶ˆæ¯é˜Ÿåˆ— |
| é˜¶æ®µ 4 | éœ€è¦é«˜å¯ç”¨ | åŒèŠ‚ç‚¹ API + PostgreSQL ä¸»ä» |

---

# äº”ã€è¯¦ç»†è®¾è®¡

## 5.1 ç”¨æˆ·æ—…ç¨‹

> **âš ï¸ 2025-12 æ›´æ–°è¯´æ˜**ï¼š
> - åŸ"åŠ¨æ€äºŒç»´ç è·¯å¾„"ä¾èµ– H5 èƒ½è·å–æ˜Ÿçƒç™»å½•æ€ï¼Œå®é™…ä¸å¯è¡Œ
> - æ–°æ–¹æ¡ˆé‡‡ç”¨**å¾®ä¿¡å…¬ä¼—å· OAuth ç™»å½• + æ‰‹åŠ¨å¡«å†™æ˜Ÿçƒä¿¡æ¯**æ¨¡å¼
> - è¯¦è§ä¸‹æ–¹"ä¸»è·¯å¾„ï¼ˆOAuth + ç»‘å®šï¼‰"å’Œ"é™çº§è·¯å¾„ï¼ˆå›ºå®šäºŒç»´ç ï¼‰"

### 5.1.0 ç”¨æˆ·æŠ¥åæµç¨‹æ¦‚è§ˆï¼ˆæ–°ï¼‰

```mermaid
flowchart TD
    A[ç”¨æˆ·ç‚¹å‡» H5 é“¾æ¥] --> B{æ˜¯å¦å·²ç™»å½•?}
    B -->|å¦| C[è·³è½¬å¾®ä¿¡ OAuth æˆæƒ]
    C --> D[åˆ›å»º/è·å– wechat_user]
    B -->|æ˜¯| D
    D --> E{æ˜Ÿçƒæ˜¯å¦å·²ç»‘å®š?}
    E -->|å¦| F[æ˜¾ç¤ºç»‘å®šé¡µé¢]
    F --> G[ç”¨æˆ·å¡«å†™æ˜Ÿçƒæ˜µç§°/ID]
    G --> H{æœ¬åœ°éªŒè¯}
    H -->|éªŒè¯é€šè¿‡| I[ç»‘å®šæˆåŠŸ]
    H -->|æœªæ‰¾åˆ°/ä¸åŒ¹é…| J[æç¤ºé£é™©åå…è®¸ç»§ç»­]
    J --> I
    E -->|æ˜¯| K[è¿›å…¥è®­ç»ƒè¥é¡µé¢]
    I --> K
    K --> L{å½“å‰è®­ç»ƒè¥çŠ¶æ€?}
    L -->|æœªæŠ¥å| M[æ˜¾ç¤ºæŠ¥åé¡µ]
    L -->|å·²æŠ¥åæœªæ”¯ä»˜| N[æ˜¾ç¤ºå¾…æ”¯ä»˜é¡µ]
    L -->|å·²æŠ¥åå·²æ”¯ä»˜| O[æ˜¾ç¤ºè¿›åº¦æŸ¥è¯¢é¡µ]
    M --> P[ç¡®è®¤å¹¶æ”¯ä»˜]
    P --> Q[æ”¯ä»˜æˆåŠŸ â†’ æ˜¾ç¤ºç¾¤äºŒç»´ç ]
```

### 5.1.1 ç”¨æˆ·æ—…ç¨‹æ¦‚è¦

æ”¯æŒä¸‰ç§ç”¨æˆ·è·¯å¾„ï¼š

| è·¯å¾„ | è¦†ç›–ç‡ | å‡†ç¡®ç‡ | ç‰¹ç‚¹ |
|-----|--------|--------|------|
| **ä¸»è·¯å¾„ï¼ˆOAuth + ç»‘å®šï¼‰** | 80% | 100% | æ¨èï¼ŒOAuth ç™»å½•åç»‘å®šæ˜Ÿçƒèº«ä»½ |
| **é™çº§è·¯å¾„ï¼ˆå›ºå®šäºŒç»´ç ï¼‰** | 15% | 95% | æ‰«å›ºå®šç æ”¯ä»˜åæ‰‹åŠ¨å¡«å†™æ˜Ÿçƒä¿¡æ¯ |
| **äººå·¥å¤„ç†è·¯å¾„** | 5% | 100% | è¶…æ—¶æœªç»‘å®šç”±ç®¡ç†å‘˜å¤„ç† |

### 5.1.2 å…³é”®æ—¶åˆ» (Moments of Truth)

| æ—¶åˆ» | è§¦å‘ç‚¹ | ç”¨æˆ·æœŸæœ› | è®¾è®¡å¯¹ç­– |
|------|--------|----------|----------|
| **MOT1: æ”¯ä»˜** | ç‚¹å‡»æ”¯ä»˜æŒ‰é’® | 3ç§’å†…è·³è½¬ | é¢„åŠ è½½æ”¯ä»˜å‚æ•° |
| **MOT2: è¿›ç¾¤** | æ”¯ä»˜æˆåŠŸå | ç«‹å³çœ‹åˆ°äºŒç»´ç  | Webhook å®æ—¶å¤„ç† |
| **MOT3: é€€æ¬¾** | è®­ç»ƒè¥ç»“æŸ | 24å°æ—¶å†…æ”¶åˆ° | è‡ªåŠ¨åŒ–é€€æ¬¾æµç¨‹ |

### 5.1.3 è¯¦ç»†å›¾è¡¨

> **ğŸ“Š å®Œæ•´ç”¨æˆ·æ—…ç¨‹å›¾ã€UI åŸå‹ã€æƒ…ç»ªæ›²çº¿** â†’ è¯¦è§ [ç”¨æˆ·æ—…ç¨‹å›¾](../diagrams/ç”¨æˆ·æ—…ç¨‹å›¾.md)

## 5.2 ä¸šåŠ¡æµç¨‹è®¾è®¡

### 5.2.1 è®­ç»ƒè¥å…¨ç”Ÿå‘½å‘¨æœŸ

```mermaid
flowchart TB
    subgraph å‡†å¤‡é˜¶æ®µ
        A1[åˆ›å»ºè®­ç»ƒè¥] --> A2[é…ç½®æ‰“å¡è¦æ±‚]
        A2 --> A3[è®¾ç½®æŠ¼é‡‘é‡‘é¢]
        A3 --> A4[ç”ŸæˆæŠ¥åé“¾æ¥]
        A4 --> A5[å‘å¸ƒè®­ç»ƒè¥]
    end

    subgraph æŠ¥åé˜¶æ®µ
        B1[ä¼šå‘˜æ‰«ç ] --> B2[å¡«å†™æŠ¥åä¿¡æ¯]
        B2 --> B3[æ”¯ä»˜æŠ¼é‡‘]
        B3 --> B4[è·å–ç¾¤äºŒç»´ç ]
        B4 --> B5[åŠ å…¥è®­ç»ƒè¥ç¾¤]
    end

    subgraph è¿›è¡Œé˜¶æ®µ
        C1[æ¯æ—¥æ‰“å¡æé†’] --> C2[ä¼šå‘˜æ‰“å¡]
        C2 --> C3[æ‰“å¡æ•°æ®åŒæ­¥]
        C3 --> C4[è¿›åº¦ç»Ÿè®¡æ›´æ–°]
        C4 --> C1
    end

    subgraph ç»“ç®—é˜¶æ®µ
        D1[è®­ç»ƒè¥ç»“æŸ] --> D2[è·å–æ‰“å¡æ•°æ®]
        D2 --> D3[è®¡ç®—åˆæ ¼åå•]
        D3 --> D4[åŒ¹é…æ”¯ä»˜è®°å½•]
        D4 --> D5[ç”Ÿæˆé€€æ¬¾åå•]
        D5 --> D6[ç®¡ç†å‘˜å®¡æ ¸]
        D6 --> D7[æ‰§è¡Œé€€æ¬¾]
        D7 --> D8[é€šçŸ¥ä¼šå‘˜]
    end

    A5 --> B1
    B5 --> C1
    C4 -.->|è®­ç»ƒè¥ç»“æŸ| D1
```

### 5.2.2 æ ¸å¿ƒä¸šåŠ¡æµç¨‹æ¦‚è¦

| æµç¨‹ | è¯´æ˜ | å…³é”®èŠ‚ç‚¹ |
|-----|------|---------|
| **æŠ¥åæ”¯ä»˜** | H5 ä¸»è·¯å¾„ vs é™çº§è·¯å¾„ï¼ˆäº’æ–¥ï¼‰ | OAuth â†’ ç»‘å®š â†’ æ”¯ä»˜ â†’ æ˜¾ç¤ºç¾¤äºŒç»´ç  |
| **é€€æ¬¾å®¡æ ¸** | ä»…å·²ç»‘å®šç”¨æˆ·è‡ªåŠ¨é€€æ¬¾ï¼Œæœªç»‘å®šéœ€äººå·¥å¤„ç† | ç”Ÿæˆåå• â†’ å®¡æ ¸ â†’ æ‰§è¡Œé€€æ¬¾ |
| **ç»‘å®šå¤„ç†** | ç”¨æˆ·ä¸»åŠ¨ç»‘å®šæˆ–ç®¡ç†å‘˜äººå·¥å¤„ç† | pending â†’ completed/expired â†’ manual_review |
| **æ‰“å¡åŒæ­¥** | å®šæ—¶ä»çŸ¥è¯†æ˜Ÿçƒ API åŒæ­¥ | API è·å– â†’ è§£æ â†’ å®½é™è§„åˆ™ â†’ åˆæ ¼åˆ¤å®š |
| **å¼‚å¸¸å¤„ç†** | æ”¯ä»˜/åŒæ­¥/é€€æ¬¾ä¸‰ç±»å¼‚å¸¸ | é‡è¯• â†’ å‘Šè­¦ â†’ äººå·¥å¤„ç† |

### 5.2.3 è¯¦ç»†æµç¨‹å›¾

> **ğŸ“Š å®Œæ•´ä¸šåŠ¡æµç¨‹å›¾ï¼ˆæŠ¥å/é€€æ¬¾/ç»‘å®š/åŒæ­¥/å¼‚å¸¸å¤„ç†ï¼‰** â†’ è¯¦è§ [ä¸šåŠ¡æµç¨‹å›¾](../diagrams/ä¸šåŠ¡æµç¨‹å›¾.md)

## 5.3 æ—¶åºå›¾è®¾è®¡

### 5.3.1 æ ¸å¿ƒæ—¶åºæ¦‚è¦

| åœºæ™¯ | å‚ä¸è€… | å…³é”®æ­¥éª¤ |
|-----|--------|---------|
| **æ”¯ä»˜å›è°ƒ** | å¾®ä¿¡æ”¯ä»˜â†’APIâ†’DBâ†’H5 | ç­¾åéªŒè¯ â†’ å¹‚ç­‰æ£€æŸ¥ â†’ è§£æattach â†’ ç»‘å®šå¤„ç† |
| **å›ºå®šç æ”¯ä»˜+ç»‘å®š** | ä¼šå‘˜â†’å¾®ä¿¡â†’APIâ†’H5 | æ”¯ä»˜å›è°ƒ(æ— attach) â†’ ä¿å­˜pending â†’ ç”¨æˆ·å¡«å†™ â†’ ç»‘å®šå®Œæˆ |
| **æ‰“å¡åŒæ­¥** | Schedulerâ†’APIâ†’çŸ¥è¯†æ˜Ÿçƒ | å®šæ—¶è§¦å‘ â†’ APIè°ƒç”¨ â†’ ç¿»é¡µå¤„ç† â†’ ç»Ÿè®¡è®¡ç®— |
| **é€€æ¬¾æ‰§è¡Œ** | Adminâ†’APIâ†’MQâ†’é€€æ¬¾æœåŠ¡â†’å¾®ä¿¡ | æ‰¹é‡å®¡æ ¸ â†’ æ¶ˆæ¯é˜Ÿåˆ— â†’ è°ƒç”¨API â†’ æˆåŠŸ/é‡è¯• |
| **ç»‘å®šè¶…æ—¶** | Schedulerâ†’APIâ†’Notify | å®šæ—¶æ£€æŸ¥ â†’ æ›´æ–°expired â†’ è½¬äººå·¥å®¡æ ¸ |
| **Cookieè¿‡æœŸ** | Schedulerâ†’APIâ†’Alert | è¯†åˆ«401 â†’ æš‚åœåŒæ­¥ â†’ å‘Šè­¦é€šçŸ¥ â†’ äººå·¥æ›´æ–° |

### 5.3.2 è¯¦ç»†æ—¶åºå›¾

> **ğŸ“Š å®Œæ•´æ—¶åºå›¾ï¼ˆæ”¯ä»˜/ç»‘å®š/åŒæ­¥/é€€æ¬¾/å¼‚å¸¸ï¼‰** â†’ è¯¦è§ [æ—¶åºå›¾](../diagrams/æ—¶åºå›¾.md)

## 5.4 çŠ¶æ€æœºè®¾è®¡

### 5.4.1 æ ¸å¿ƒçŠ¶æ€æœºæ¦‚è¦

| å®ä½“ | çŠ¶æ€æµè½¬ | å…³é”®è½¬æ¢ç‚¹ |
|-----|---------|-----------|
| **è®­ç»ƒè¥** | è‰ç¨¿â†’å¾…å‘å¸ƒâ†’æŠ¥åä¸­â†’è¿›è¡Œä¸­â†’å·²ç»“æŸâ†’ç»“ç®—ä¸­â†’å·²å½’æ¡£ | å‘å¸ƒ/å¼€å§‹/ç»“æŸ/ç»“ç®— |
| **æ”¯ä»˜æ˜ å°„ç»‘å®š** | å¾…ç»‘å®šâ†’å·²ç»‘å®š / å¾…ç»‘å®šâ†’å·²è¿‡æœŸâ†’äººå·¥å®¡æ ¸â†’å·²å…³é—­ | ç”¨æˆ·å¡«å†™/è¶…æ—¶/äººå·¥å¤„ç† |
| **è®¢å•/æ”¯ä»˜** | å¾…æ”¯ä»˜â†’æ”¯ä»˜ä¸­â†’å·²æ”¯ä»˜â†’é€€æ¬¾ä¸­â†’å·²é€€æ¬¾ | æ”¯ä»˜æˆåŠŸ/å‘èµ·é€€æ¬¾/é€€æ¬¾æˆåŠŸ |
| **é€€æ¬¾** | å¾…å®¡æ ¸â†’å®¡æ ¸é€šè¿‡â†’å¾…é€€æ¬¾â†’é€€æ¬¾ä¸­â†’é€€æ¬¾æˆåŠŸ | å®¡æ ¸/æ‰§è¡Œ/å®Œæˆ |
| **æ‰“å¡åŒæ­¥** | å¾…åŒæ­¥â†’åŒæ­¥ä¸­â†’åŒæ­¥æˆåŠŸ/å¤±è´¥ | å®šæ—¶è§¦å‘/APIè°ƒç”¨ |
| **ç”¨æˆ·æ‰“å¡** | æœªå¼€å§‹â†’è¿›è¡Œä¸­â†’å·²å®Œæˆ/æœªè¾¾æ ‡â†’å¾…é€€æ¬¾â†’å·²é€€æ¬¾ | å¼€å§‹/è¾¾æ ‡åˆ¤å®š/é€€æ¬¾ |

### 5.4.2 ç»‘å®šçŠ¶æ€è¯´æ˜

> çŠ¶æ€å€¼å¼•ç”¨ [çŠ¶æ€æšä¸¾å®šä¹‰.md](./çŠ¶æ€æšä¸¾å®šä¹‰.md#1-bind_status---æ”¯ä»˜ç»‘å®šçŠ¶æ€)

| çŠ¶æ€ | ç¼–ç  | bind_method | è¯´æ˜ |
|-----|------|-------------|------|
| å·²ç»‘å®šï¼ˆH5ï¼‰ | `completed` | `h5_bindplanet` | ä¸»è·¯å¾„ OAuth æ”¯ä»˜ |
| å·²ç»‘å®šï¼ˆå¡«å†™ï¼‰ | `completed` | `user_fill` | é™çº§è·¯å¾„ç”¨æˆ·å¡«å†™ |
| å·²ç»‘å®šï¼ˆäººå·¥ï¼‰ | `completed` | `manual` | ç®¡ç†å‘˜æ‰‹åŠ¨ç»‘å®š |
| å¾…ç»‘å®š | `pending` | - | ç­‰å¾…ç”¨æˆ·å¡«å†™ |
| å·²è¿‡æœŸ | `expired` | - | è¶…è¿‡7å¤©æœªç»‘å®š |
| äººå·¥å®¡æ ¸ä¸­ | `manual_review` | - | ç­‰å¾…ç®¡ç†å‘˜å¤„ç† |
| å·²å…³é—­ | `closed` | - | æ— æ³•åŒ¹é… |

### 5.4.3 è¯¦ç»†çŠ¶æ€æœºå›¾

> **ğŸ“Š å®Œæ•´çŠ¶æ€æœºå›¾ï¼ˆè®­ç»ƒè¥/æ”¯ä»˜/ç»‘å®š/é€€æ¬¾/åŒæ­¥ï¼‰** â†’ è¯¦è§ [çŠ¶æ€æœº](../diagrams/çŠ¶æ€æœº.md)

## 5.5 ç»„ä»¶è®¾è®¡ï¼ˆC4 Level 3ï¼‰

```mermaid
C4Component
    title API æœåŠ¡ç»„ä»¶å›¾ï¼ˆå«æ··åˆåŒ¹é…æ–¹æ¡ˆï¼‰

    Container_Boundary(api, "API æœåŠ¡") {
        Component(campCtrl, "CampController", "Controller", "è®­ç»ƒè¥ CRUD æ¥å£")
        Component(payCtrl, "PaymentController", "Controller", "æ”¯ä»˜ç›¸å…³æ¥å£")
        Component(bindCtrl, "BindController", "Controller", "æ”¯ä»˜ç»‘å®šæ¥å£ï¼ˆæ–°å¢ï¼‰")
        Component(authCtrl, "AuthController", "Controller", "OAuthè®¤è¯æ¥å£")
        Component(refundCtrl, "RefundController", "Controller", "é€€æ¬¾ç›¸å…³æ¥å£")
        Component(statsCtrl, "StatsController", "Controller", "ç»Ÿè®¡æŠ¥è¡¨æ¥å£")
        Component(webhookCtrl, "WebhookController", "Controller", "å›è°ƒå¤„ç†æ¥å£")

        Component(campSvc, "CampService", "Service", "è®­ç»ƒè¥ä¸šåŠ¡é€»è¾‘")
        Component(paySvc, "PaymentService", "Service", "æ”¯ä»˜ä¸šåŠ¡é€»è¾‘")
        Component(bindSvc, "PaymentBindService", "Service", "æ”¯ä»˜ç»‘å®šæœåŠ¡ï¼ˆæ–°å¢ï¼‰")
        Component(authSvc, "FastAuthService", "Service", "OAuthè®¤è¯æœåŠ¡ - è¯¦è§FastAuthæ¥å…¥æ–¹æ¡ˆÂ§3.4")
        Component(checkinSvc, "CheckinService", "Service", "æ‰“å¡ä¸šåŠ¡é€»è¾‘ - åŒæ­¥é€»è¾‘è¯¦è§FastAuthæ¥å…¥æ–¹æ¡ˆÂ§2.5")
        Component(matchSvc, "MatchService", "Service", "èº«ä»½åŒ¹é…é€»è¾‘")
        Component(refundSvc, "RefundService", "Service", "é€€æ¬¾ä¸šåŠ¡é€»è¾‘")
        Component(statsSvc, "StatsService", "Service", "ç»Ÿè®¡ä¸šåŠ¡é€»è¾‘")

        Component(campMapper, "CampMapper", "DAO", "è®­ç»ƒè¥æ•°æ®è®¿é—®")
        Component(memberMapper, "MemberMapper", "DAO", "ä¼šå‘˜æ•°æ®è®¿é—®")
        Component(orderMapper, "PaymentMapper", "DAO", "æ”¯ä»˜è®°å½•æ•°æ®è®¿é—®ï¼ˆå«ç»‘å®šä¿¡æ¯ï¼‰")
        Component(bindLogMapper, "PaymentBindStatusLogMapper", "DAO", "ç»‘å®šçŠ¶æ€æ—¥å¿—è®¿é—®")
        Component(authSessionMapper, "AuthSessionMapper", "DAO", "è®¤è¯ä¼šè¯æ•°æ®è®¿é—®")
        Component(refundMapper, "RefundMapper", "DAO", "é€€æ¬¾æ•°æ®è®¿é—®")

        Component(zsxqMgr, "PlanetApiManager", "Manager", "çŸ¥è¯†æ˜Ÿçƒ API å°è£…")
        Component(wxPayMgr, "WechatPayManager", "Manager", "å¾®ä¿¡æ”¯ä»˜ API å°è£…")
        Component(wxMsgMgr, "WechatMsgManager", "Manager", "ä¼ä¸šå¾®ä¿¡æ¶ˆæ¯å°è£…")
        Component(wxOAuthMgr, "WechatOAuthManager", "Manager", "å¾®ä¿¡å…¬ä¼—å· OAuth å°è£…")
    }

    Rel(campCtrl, campSvc, "è°ƒç”¨")
    Rel(payCtrl, paySvc, "è°ƒç”¨")
    Rel(bindCtrl, bindSvc, "è°ƒç”¨")
    Rel(authCtrl, authSvc, "è°ƒç”¨")
    Rel(refundCtrl, refundSvc, "è°ƒç”¨")
    Rel(statsCtrl, statsSvc, "è°ƒç”¨")
    Rel(webhookCtrl, paySvc, "è°ƒç”¨")
    Rel(webhookCtrl, bindSvc, "è°ƒç”¨")

    Rel(campSvc, campMapper, "è°ƒç”¨")
    Rel(paySvc, orderMapper, "è°ƒç”¨")
    Rel(paySvc, wxPayMgr, "è°ƒç”¨")
    Rel(bindSvc, orderMapper, "è°ƒç”¨")
    Rel(bindSvc, bindLogMapper, "è°ƒç”¨")
    Rel(bindSvc, matchSvc, "è°ƒç”¨")
    Rel(authSvc, authSessionMapper, "è°ƒç”¨")
    Rel(authSvc, wxOAuthMgr, "è°ƒç”¨")
    Rel(authSvc, memberMapper, "è°ƒç”¨")
    Rel(checkinSvc, zsxqMgr, "è°ƒç”¨")
    Rel(checkinSvc, memberMapper, "è°ƒç”¨")
    Rel(matchSvc, memberMapper, "è°ƒç”¨")
    Rel(matchSvc, orderMapper, "è°ƒç”¨")
    Rel(refundSvc, refundMapper, "è°ƒç”¨")
    Rel(refundSvc, matchSvc, "è°ƒç”¨")
    Rel(refundSvc, wxPayMgr, "è°ƒç”¨")
    Rel(refundSvc, wxMsgMgr, "è°ƒç”¨")
```

### 5.5.1 é¡¹ç›®ç»“æ„

```
src/main/java/com/example/camp/
â”œâ”€â”€ CampApplication.java                    # å¯åŠ¨ç±»
â”œâ”€â”€ config/                                 # é…ç½®ç±»
â”‚   â”œâ”€â”€ WebMvcConfig.java
â”‚   â”œâ”€â”€ SecurityConfig.java
â”‚   â”œâ”€â”€ RedisConfig.java
â”‚   â””â”€â”€ MyBatisPlusConfig.java
â”œâ”€â”€ controller/                             # æ§åˆ¶å™¨å±‚
â”‚   â”œâ”€â”€ admin/                              # ç®¡ç†ç«¯æ¥å£
â”‚   â”‚   â”œâ”€â”€ CampController.java
â”‚   â”‚   â”œâ”€â”€ MemberController.java
â”‚   â”‚   â”œâ”€â”€ RefundController.java
â”‚   â”‚   â””â”€â”€ StatisticsController.java
â”‚   â”œâ”€â”€ auth/                               # è®¤è¯æ¥å£
â”‚   â”‚   â””â”€â”€ AuthController.java             # OAuth æˆæƒã€å›è°ƒã€ç»‘å®šï¼ˆè¯¦è§FastAuthæ¥å…¥æ–¹æ¡ˆÂ§2.7.1ï¼‰
â”‚   â”œâ”€â”€ h5/                                 # H5ç«¯æ¥å£
â”‚   â”‚   â”œâ”€â”€ CampH5Controller.java
â”‚   â”‚   â”œâ”€â”€ PaymentH5Controller.java
â”‚   â”‚   â””â”€â”€ ProgressH5Controller.java
â”‚   â””â”€â”€ webhook/                            # Webhookæ¥å£
â”‚       â””â”€â”€ WechatPayWebhookController.java
â”œâ”€â”€ service/                                # æœåŠ¡å±‚
â”‚   â”œâ”€â”€ CampService.java
â”‚   â”œâ”€â”€ MemberService.java
â”‚   â”œâ”€â”€ PaymentService.java
â”‚   â”œâ”€â”€ PaymentBindService.java          # æ”¯ä»˜ç»‘å®šæœåŠ¡ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ FastAuthService.java             # OAuthè®¤è¯æœåŠ¡ï¼ˆè¯¦è§FastAuthæ¥å…¥æ–¹æ¡ˆÂ§3.4ï¼‰
â”‚   â”œâ”€â”€ CheckinService.java              # æ‰“å¡æœåŠ¡ï¼ˆä¼šå‘˜åŒæ­¥è¯¦è§FastAuthæ¥å…¥æ–¹æ¡ˆÂ§2.5ï¼‰
â”‚   â”œâ”€â”€ MatchService.java
â”‚   â”œâ”€â”€ RefundService.java
â”‚   â””â”€â”€ impl/
â”œâ”€â”€ manager/                                # ç¬¬ä¸‰æ–¹APIå°è£…
â”‚   â”œâ”€â”€ WechatPayManager.java
â”‚   â”œâ”€â”€ WechatOAuthManager.java          # å¾®ä¿¡å…¬ä¼—å· OAuth å°è£…ï¼ˆè¯¦è§FastAuthæ¥å…¥æ–¹æ¡ˆÂ§3.4.1ï¼‰
â”‚   â”œâ”€â”€ PlanetApiManager.java            # çŸ¥è¯†æ˜Ÿçƒ APIï¼ˆä¼šå‘˜åŒæ­¥è¯¦è§FastAuthæ¥å…¥æ–¹æ¡ˆÂ§2.4.1ï¼‰
â”‚   â””â”€â”€ WechatNotifyManager.java
â”œâ”€â”€ mapper/                                 # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ CampMapper.java
â”‚   â”œâ”€â”€ MemberMapper.java
â”‚   â”œâ”€â”€ PaymentMapper.java                 # æ”¯ä»˜è®°å½•ï¼ˆå«ç»‘å®šä¿¡æ¯ï¼‰
â”‚   â”œâ”€â”€ PaymentBindStatusLogMapper.java    # ç»‘å®šçŠ¶æ€æ—¥å¿—
â”‚   â”œâ”€â”€ AuthSessionMapper.java             # è®¤è¯ä¼šè¯ï¼ˆFastAuth æ•°æ®åº“è®¾è®¡è¯¦è§FastAuthæ¥å…¥æ–¹æ¡ˆÂ§3.5ï¼‰
â”‚   â””â”€â”€ RefundMapper.java
â”œâ”€â”€ entity/                                 # å®ä½“ç±»
â”œâ”€â”€ dto/                                    # æ•°æ®ä¼ è¾“å¯¹è±¡
â”œâ”€â”€ enums/                                  # æšä¸¾ç±»
â”‚   â”œâ”€â”€ CampStatus.java
â”‚   â”œâ”€â”€ PaymentStatus.java
â”‚   â”œâ”€â”€ BindStatus.java                     # ç»‘å®šçŠ¶æ€æšä¸¾ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ PaymentBindMethod.java              # ç»‘å®šæ–¹å¼æšä¸¾ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ MatchStatus.java
â”‚   â””â”€â”€ RefundStatus.java
â”œâ”€â”€ common/                                 # å…¬å…±ç±»
â”‚   â”œâ”€â”€ Result.java
â”‚   â”œâ”€â”€ PageResult.java
â”‚   â””â”€â”€ exception/
â”œâ”€â”€ schedule/                               # å®šæ—¶ä»»åŠ¡
â”‚   â”œâ”€â”€ CheckinSyncTask.java
â”‚   â””â”€â”€ BindExpireTask.java                 # ç»‘å®šè¶…æ—¶æ£€æŸ¥ï¼ˆæ–°å¢ï¼‰
â””â”€â”€ util/                                   # å·¥å…·ç±»
```

### 5.5.2 æ ¸å¿ƒæœåŠ¡æ¥å£

```java
// PaymentBindServiceï¼ˆæ”¯ä»˜ç»‘å®šæœåŠ¡ - æ–°å¢ï¼‰
public interface PaymentBindService {
    // å¤„ç†æ”¯ä»˜å›è°ƒï¼Œåˆ›å»º/æ›´æ–°æ˜ å°„
    void handlePaymentCallback(PaymentCallbackDTO callback);

    // ç”¨æˆ·å¡«å†™ç»‘å®šï¼ˆé™çº§è·¯å¾„ï¼‰
    void bindByUserFill(String orderNo, String planetMemberNumber, String nickname);

    // æ£€æŸ¥å¹¶æ›´æ–°è¿‡æœŸæ˜ å°„ï¼Œè½¬å…¥äººå·¥å®¡æ ¸ï¼ˆå®šæ—¶ä»»åŠ¡è°ƒç”¨ï¼‰
    void checkAndExpireBindings();

    // æŸ¥è¯¢ç»‘å®šçŠ¶æ€
    BindStatusVO getBindStatus(String orderNo);

    // äººå·¥ç»‘å®šï¼ˆç®¡ç†å‘˜æ“ä½œï¼‰
    void manualBind(Long paymentId, String planetMemberNumber, Long operatorId);

    // å…³é—­è®¢å•ï¼ˆç®¡ç†å‘˜æ“ä½œï¼‰
    void closePayment(Long paymentId, String reason, Long operatorId);
}
```

```java
// RefundServiceï¼ˆé€€æ¬¾æœåŠ¡ï¼‰
public interface RefundService {
    void generateRefundList(Long campId);
    void approveRefund(Long refundId, Long operatorId);
    void batchApprove(List<Long> refundIds, Long operatorId);
    void executeRefund(Long refundId);
    void retryFailedRefund(Long refundId);
}
```

```java
// FastAuthServiceï¼ˆOAuthè®¤è¯æœåŠ¡ï¼‰
// å®Œæ•´å®ç°è¯¦è§ï¼šFastAuthæ¥å…¥æ–¹æ¡ˆ Â§3.4.2-3.4.4
public interface FastAuthService {
    // ç”Ÿæˆå¾®ä¿¡æˆæƒURL
    AuthorizeUrlVO generateAuthorizeUrl(String redirectUri, String state);

    // å¤„ç†OAuthå›è°ƒï¼Œåˆ›å»º/æ›´æ–°ä¼šè¯
    AuthCallbackResult handleOAuthCallback(String code, String state);

    // ç»‘å®šçŸ¥è¯†æ˜Ÿçƒè´¦å·
    BindPlanetResult bindPlanetAccount(String accessToken, String planetUserId, String nickname);

    // éªŒè¯ access_token
    AuthSession validateAccessToken(String accessToken);

    // æ¸…ç†è¿‡æœŸä¼šè¯ï¼ˆå®šæ—¶ä»»åŠ¡è°ƒç”¨ï¼‰
    void cleanupExpiredSessions();
}
```

### 5.5.3 æšä¸¾ç±»å®šä¹‰

```java
// BindStatus.java - ç»‘å®šçŠ¶æ€æšä¸¾
public enum BindStatus {
    PENDING("pending", "å¾…ç»‘å®š"),           // é™çº§è·¯å¾„æ”¯ä»˜å
    COMPLETED("completed", "å·²ç»‘å®š"),       // ç»‘å®šæˆåŠŸ
    EXPIRED("expired", "å·²è¿‡æœŸ"),           // 7å¤©æœªç»‘å®š
    MANUAL_REVIEW("manual_review", "äººå·¥å®¡æ ¸ä¸­"),  // è¶…æ—¶è½¬å…¥äººå·¥å®¡æ ¸
    CLOSED("closed", "å·²å…³é—­");             // æ— æ³•åŒ¹é…

    private final String code;
    private final String desc;
}

// PaymentBindMethod.java - ç»‘å®šæ–¹å¼æšä¸¾
public enum PaymentBindMethod {
    H5_BINDPLANET("h5_bindplanet", "H5ç»‘å®š"),    // H5ä¸»è·¯å¾„ï¼šOAuthç™»å½•åç»‘å®š
    USER_FILL("user_fill", "ç”¨æˆ·å¡«å†™"),          // é™çº§è·¯å¾„ï¼šç”¨æˆ·å¡«å†™æ˜Ÿçƒä¿¡æ¯
    MANUAL("manual", "äººå·¥ç»‘å®š");                // ç®¡ç†å‘˜æ“ä½œ

    private final String code;
    private final String desc;
}
```

### 5.5.4 æ ¸å¿ƒæ¨¡å—äº¤äº’

```mermaid
flowchart LR
    subgraph å‰ç«¯å±‚
        H5[H5 ä¼šå‘˜ç«¯]
        Admin[ç®¡ç†åå°]
    end

    subgraph æ¥å…¥å±‚
        Gateway[API ç½‘å…³]
    end

    subgraph ä¸šåŠ¡å±‚
        Camp[è®­ç»ƒè¥æ¨¡å—]
        Member[ä¼šå‘˜æ¨¡å—]
        Payment[æ”¯ä»˜æ¨¡å—]
        Checkin[æ‰“å¡æ¨¡å—]
        Match[åŒ¹é…æ¨¡å—]
        Refund[é€€æ¬¾æ¨¡å—]
    end

    subgraph æ•°æ®å±‚
        DB[(PostgreSQL)]
        Cache[(Redis)]
        MQ[RabbitMQ]
    end

    H5 --> Gateway
    Admin --> Gateway
    Gateway --> Camp
    Gateway --> Member
    Gateway --> Payment

    Camp --> DB
    Member --> DB
    Payment --> DB
    Payment --> Cache
    Checkin --> DB
    Match --> DB
    Match --> Cache
    Refund --> DB
    Refund --> MQ

    Camp --> Member
    Payment --> Member
    Match --> Member
    Match --> Payment
    Refund --> Match
    Refund --> Payment
```

### 5.5.5 æ ¸å¿ƒé¢†åŸŸæ¨¡å‹

```mermaid
classDiagram
    class TrainingCamp {
        +Long id
        +String name
        +BigDecimal deposit
        +LocalDate startDate
        +LocalDate endDate
        +Integer totalDays
        +Integer requiredDays
        +CampStatus status
        +String enrollUrl
        +publish()
        +start()
        +end()
        +settle()
    }

    class CampMember {
        +Long id
        +Long campId
        +Long planetUserId
        +String filledNickname
        +MatchStatus matchStatus
        +Integer matchConfidence
        +Integer checkinCount
        +Boolean eligibleForRefund
        +match()
        +updateCheckin()
    }

    class PaymentRecord {
        +Long id
        +String orderNo
        +Long campId
        +Long memberId
        +BigDecimal payAmount
        +PayStatus payStatus
        +BindStatus bindStatus
        +BindMethod bindMethod
        +LocalDateTime bindDeadline
        +pay()
        +refund()
        +bind()
    }

    class RefundRecord {
        +Long id
        +Long campId
        +Long memberId
        +Long paymentId
        +BigDecimal refundAmount
        +RefundStatus status
        +AuditStatus auditStatus
        +Integer retryCount
        +approve()
        +reject()
        +execute()
        +retry()
    }

    class PlanetUser {
        +Long id
        +String planetUserId
        +String planetNickname
        +String wechatNickname
    }

    class CheckinRecord {
        +Long id
        +Long campId
        +Long planetUserId
        +LocalDate checkinDate
        +String checkinContent
    }

    TrainingCamp "1" --> "*" CampMember
    CampMember "1" --> "0..1" PlanetUser
    CampMember "1" --> "1" PaymentRecord
    CampMember "1" --> "0..1" RefundRecord
    PlanetUser "1" --> "*" CheckinRecord
    TrainingCamp "1" --> "*" CheckinRecord
```

### 5.5.6 æ ¸å¿ƒæœåŠ¡æ¥å£

```mermaid
classDiagram
    class CampService {
        <<interface>>
        +create(CampDTO) Camp
        +update(Long, CampDTO) Camp
        +publish(Long) void
        +getDetail(Long) CampVO
        +listByStatus(CampStatus) List~CampVO~
    }

    class PaymentService {
        <<interface>>
        +createOrder(OrderDTO) PaymentRecord
        +handleCallback(CallbackDTO) void
        +getPayParams(String orderNo) PayParamsVO
    }

    class PaymentBindService {
        <<interface>>
        +handlePaymentCallback(CallbackDTO) void
        +bindByUserFill(String, String, String) void
        +checkAndExpireBindings() void
        +smartMatch(Long) MatchResult
    }

    class MatchService {
        <<interface>>
        +matchMembers(Long) MatchResultVO
        +calculateSimilarity(String, String) Integer
        +manualMatch(Long, Long) void
    }

    class RefundService {
        <<interface>>
        +generateRefundList(Long) void
        +approveRefund(Long, Long) void
        +batchApprove(List~Long~, Long) void
        +executeRefund(Long) void
        +retryFailedRefund(Long) void
    }

    class CheckinService {
        <<interface>>
        +syncCheckins(Long) SyncResult
        +getCheckinStats(Long, Long) CheckinStatsVO
        +calculateEligibility(Long) void
    }

    PaymentService ..> PaymentBindService : uses
    RefundService ..> MatchService : uses
    RefundService ..> PaymentService : uses
    MatchService ..> PaymentBindService : uses
```

### 5.5.7 æ ¸å¿ƒæ•°æ®æµ

```mermaid
flowchart TD
    subgraph æ•°æ®è¾“å…¥
        A1[H5 æŠ¥åè¡¨å•]
        A2[æ”¯ä»˜å›è°ƒ Webhook]
        A3[çŸ¥è¯†æ˜Ÿçƒæ‰“å¡ API]
        A4[ç®¡ç†å‘˜å®¡æ ¸æ“ä½œ]
    end

    subgraph æ•°æ®å¤„ç†
        B1[æŠ¥åä¿¡æ¯æ ¡éªŒ]
        B2[æ”¯ä»˜æ˜ å°„å¤„ç†]
        B3[æ‰“å¡æ•°æ®åŒæ­¥]
        B4[èº«ä»½åŒ¹é…è®¡ç®—]
        B5[é€€æ¬¾å®¡æ ¸å¤„ç†]
    end

    subgraph æ•°æ®å­˜å‚¨
        C1[(ä¼šå‘˜è¡¨)]
        C2[(æ”¯ä»˜è¡¨)]
        C3[(æ‰“å¡è¡¨)]
        C4[(é€€æ¬¾è¡¨)]
    end

    subgraph æ•°æ®è¾“å‡º
        D1[ç¾¤äºŒç»´ç å±•ç¤º]
        D2[æ‰“å¡è¿›åº¦æŸ¥è¯¢]
        D3[é€€æ¬¾ç»“æœé€šçŸ¥]
        D4[ç»Ÿè®¡æŠ¥è¡¨å¯¼å‡º]
    end

    A1 --> B1 --> C1
    A2 --> B2 --> C2
    A3 --> B3 --> C3
    A4 --> B5 --> C4

    C1 --> B4
    C2 --> B4
    C3 --> B4
    B4 --> C4

    C1 --> D1
    C3 --> D2
    C4 --> D3
    C1 & C2 & C3 & C4 --> D4
```

### 5.5.8 å¼‚æ­¥æ•°æ®æµ

> **è®¾è®¡è¯´æ˜**ï¼šç§»é™¤æ™ºèƒ½åŒ¹é…æµç¨‹ï¼Œç»‘å®šè¶…æ—¶æ£€æŸ¥ç›´æ¥è§¦å‘é€šçŸ¥å’Œäººå·¥å®¡æ ¸åˆ—è¡¨æ›´æ–°ã€‚

```mermaid
flowchart LR
    subgraph ç”Ÿäº§è€…
        P1[æ”¯ä»˜å›è°ƒå¤„ç†]
        P2[é€€æ¬¾å®¡æ ¸é€šè¿‡]
        P3[ç»‘å®šè¶…æ—¶æ£€æŸ¥]
        P4[æ‰“å¡åŒæ­¥å®Œæˆ]
    end

    subgraph æ¶ˆæ¯é˜Ÿåˆ—
        Q1[refund.execute]
        Q3[notify.send]
        Q4[stats.update]
    end

    subgraph æ¶ˆè´¹è€…
        C1[é€€æ¬¾æ‰§è¡Œå™¨]
        C3[é€šçŸ¥å‘é€å™¨]
        C4[ç»Ÿè®¡æ›´æ–°å™¨]
    end

    P1 --> Q3
    P2 --> Q1
    P3 --> Q3
    P4 --> Q4

    Q1 --> C1
    Q3 --> C3
    Q4 --> C4

    C1 -->|æˆåŠŸ| Q3
    C1 -->|å¤±è´¥| Q1
```

### 5.5.9 å®‰å…¨åˆ†å±‚æ¶æ„

```mermaid
flowchart TB
    subgraph ç½‘ç»œå±‚
        WAF[Web åº”ç”¨é˜²ç«å¢™]
        CDN[CDN åŠ é€Ÿ]
    end

    subgraph æ¥å…¥å±‚
        SSL[SSL/TLS åŠ å¯†]
        RateLimit[é™æµæ§åˆ¶]
        IPBlack[IP é»‘åå•]
    end

    subgraph è®¤è¯å±‚
        JWT[JWT ä»¤ç‰ŒéªŒè¯]
        RBAC[è§’è‰²æƒé™æ§åˆ¶]
        Sign[ç­¾åéªŒè¯]
    end

    subgraph ä¸šåŠ¡å±‚
        InputValid[è¾“å…¥æ ¡éªŒ]
        SQLInject[SQL æ³¨å…¥é˜²æŠ¤]
        XSS[XSS é˜²æŠ¤]
    end

    subgraph æ•°æ®å±‚
        Encrypt[æ•æ„Ÿæ•°æ®åŠ å¯†]
        Audit[æ“ä½œå®¡è®¡]
        Backup[æ•°æ®å¤‡ä»½]
    end

    WAF --> SSL
    CDN --> SSL
    SSL --> RateLimit --> IPBlack
    IPBlack --> JWT --> RBAC
    JWT --> Sign
    RBAC --> InputValid
    Sign --> InputValid
    InputValid --> SQLInject --> XSS
    XSS --> Encrypt --> Audit --> Backup
```

### 5.5.10 è®¤è¯æˆæƒæµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·è¯·æ±‚] --> B{è¯·æ±‚ç±»å‹}

    B -->|H5 å…¬å¼€æ¥å£| C[æ— éœ€è®¤è¯]
    B -->|ç®¡ç†åå°æ¥å£| D[JWT éªŒè¯]
    B -->|Webhook æ¥å£| E[ç­¾åéªŒè¯]

    D --> F{Token æœ‰æ•ˆ?}
    F -->|æ˜¯| G[è§£æç”¨æˆ·ä¿¡æ¯]
    F -->|å¦| H[è¿”å› 401]

    G --> I{æƒé™æ£€æŸ¥}
    I -->|æœ‰æƒé™| J[æ‰§è¡Œä¸šåŠ¡]
    I -->|æ— æƒé™| K[è¿”å› 403]

    E --> L{ç­¾åæœ‰æ•ˆ?}
    L -->|æ˜¯| M[æ‰§è¡Œå›è°ƒå¤„ç†]
    L -->|å¦| N[è¿”å› FAIL]

    C --> O[æ‰§è¡Œå…¬å¼€é€»è¾‘]

    J --> P[è®°å½•æ“ä½œæ—¥å¿—]
    M --> P
    O --> Q[è¿”å›ç»“æœ]
    P --> Q

    subgraph æƒé™çŸ©é˜µ
        R1[admin: å…¨éƒ¨æƒé™]
        R2[manager: è®­ç»ƒè¥ç®¡ç†ã€é€€æ¬¾å®¡æ ¸]
        R3[coach: æŸ¥çœ‹è´Ÿè´£çš„è®­ç»ƒè¥]
        R4[volunteer: æŸ¥çœ‹å‚ä¸çš„è®­ç»ƒè¥]
    end
```

## 5.6 æ•°æ®åº“è®¾è®¡

### 5.6.1 è®¾è®¡åŸåˆ™

1. **å‘½åè§„èŒƒ**ï¼š
   - è¡¨åï¼šå°å†™ + ä¸‹åˆ’çº¿åˆ†éš”ï¼ˆå¦‚ï¼š`training_camp`ï¼‰
   - å­—æ®µåï¼šå°å†™ + ä¸‹åˆ’çº¿åˆ†éš”ï¼ˆå¦‚ï¼š`created_at`ï¼‰
   - ç´¢å¼•åï¼š`idx_è¡¨å_å­—æ®µå`
   - å¤–é”®åï¼š`fk_è¡¨å_å…³è”è¡¨å`

2. **é€šç”¨å­—æ®µ**ï¼š
   - `id`ï¼šä¸»é”®ï¼ŒBIGSERIAL
   - `created_at`ï¼šåˆ›å»ºæ—¶é—´ï¼ŒTIMESTAMP
   - `updated_at`ï¼šæ›´æ–°æ—¶é—´ï¼ŒTIMESTAMP
   - `deleted_at`ï¼šåˆ é™¤æ—¶é—´ï¼ŒTIMESTAMPï¼ˆè½¯åˆ é™¤ï¼‰

3. **æ•°æ®ç±»å‹é€‰æ‹©**ï¼š
   - é‡‘é¢ï¼šDECIMAL(10,2)
   - æ—¥æœŸï¼šDATE
   - æ—¶é—´æˆ³ï¼šTIMESTAMP
   - JSONæ•°æ®ï¼šJSONB
   - æ–‡æœ¬ï¼šVARCHAR(é•¿åº¦) æˆ– TEXT

### 5.6.2 ER å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  training_camp  â”‚ è®­ç»ƒè¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ 1
        â”‚
        â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  camp_member    â”‚ è®­ç»ƒè¥ä¼šå‘˜å…³ç³»
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ 1              1 â”‚
        â”‚                  â”‚
        â”‚ 1              N â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  payment_record â”‚    â”‚  planet_user    â”‚ çŸ¥è¯†æ˜Ÿçƒç”¨æˆ·
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ 1                  â”‚ 1
        â”‚                    â”‚
        â”‚ 1                  â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  refund_record  â”‚    â”‚  checkin_record â”‚ æ‰“å¡è®°å½•
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  system_user    â”‚    â”‚  role           â”‚ è§’è‰²
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ N                  â”‚ 1
        â”‚                    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  operation_log  â”‚ æ“ä½œæ—¥å¿—
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  system_config  â”‚ ç³»ç»Ÿé…ç½®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.6.3 æ ¸å¿ƒè¡¨ç»“æ„

> å®Œæ•´çš„è¡¨ç»“æ„å®šä¹‰ã€å­—æ®µè¯´æ˜ã€çº¦æŸå’Œç´¢å¼•è¯¦è§ï¼šğŸ“„ **[æ•°æ®åº“è®¾è®¡.md](./æ•°æ®åº“è®¾è®¡.md)**

#### æ ¸å¿ƒä¸šåŠ¡è¡¨æ¦‚è§ˆ

| è¡¨å | è¯´æ˜ | æ ¸å¿ƒå­—æ®µ |
|------|------|----------|
| `training_camp` | è®­ç»ƒè¥ | name, deposit, start_date, end_date, required_days, status |
| `planet_user` | çŸ¥è¯†æ˜Ÿçƒç”¨æˆ· | planet_user_id, planet_nickname |
| `camp_member` | è®­ç»ƒè¥ä¼šå‘˜ | camp_id, planet_user_id, match_status, checkin_count |
| `payment_record` | æ”¯ä»˜è®°å½• | order_no, pay_amount, pay_status, **bind_status**, **bind_method** |
| `refund_record` | é€€æ¬¾è®°å½• | refund_amount, refund_status, audit_status |
| `checkin_record` | æ‰“å¡è®°å½• | checkin_date, checkin_time |

#### æ”¯ä»˜æ˜ å°„å…³é”®å­—æ®µï¼ˆæ··åˆæ–¹æ¡ˆï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `bind_status` | VARCHAR(20) | pending/completed/expired/manual_review/closed |
| `bind_method` | VARCHAR(20) | h5_bindplanet/user_fill/manual |
| `bind_deadline` | TIMESTAMP | ç»‘å®šæˆªæ­¢æ—¶é—´ï¼ˆæ”¯ä»˜å 7 å¤©ï¼‰ |

#### çŠ¶æ€æ—¥å¿—è¡¨ï¼ˆå®¡è®¡è¿½è¸ªï¼‰

| è¡¨å | è¯´æ˜ |
|------|------|
| `camp_status_log` | è®­ç»ƒè¥çŠ¶æ€å˜æ›´æ—¥å¿— |
| `payment_bind_status_log` | æ”¯ä»˜ç»‘å®šçŠ¶æ€å˜æ›´æ—¥å¿— |
| `order_status_log` | è®¢å•çŠ¶æ€å˜æ›´æ—¥å¿— |
| `refund_status_log` | é€€æ¬¾çŠ¶æ€å˜æ›´æ—¥å¿— |
| `member_status_log` | ä¼šå‘˜çŠ¶æ€å˜æ›´æ—¥å¿— |

### 5.6.4 è§†å›¾è®¾è®¡

#### ä¼šå‘˜å®Œæ•´ä¿¡æ¯è§†å›¾

```sql
CREATE OR REPLACE VIEW v_member_full_info AS
SELECT
    cm.id AS member_id,
    cm.camp_id,
    tc.name AS camp_name,
    tc.start_date,
    tc.end_date,
    tc.total_days,
    tc.required_days,
    tc.deposit,

    -- ä¼šå‘˜å¡«å†™ä¿¡æ¯
    cm.filled_planet_nickname,
    cm.filled_planet_user_id,
    cm.filled_wechat_nickname,

    -- åŒ¹é…ä¿¡æ¯
    cm.match_status,

    -- çŸ¥è¯†æ˜Ÿçƒç”¨æˆ·ä¿¡æ¯
    pu.member_number AS planet_member_number,
    pu.user_nickname AS planet_nickname,
    pu.wechat_nickname,

    -- è¿›ç¾¤çŠ¶æ€
    cm.joined_group,
    cm.joined_at,

    -- æ‰“å¡ç»Ÿè®¡
    cm.checkin_count,
    cm.checkin_rate,
    cm.last_checkin_time,
    cm.eligible_for_refund,

    -- æ”¯ä»˜ä¿¡æ¯
    pr.order_no,
    pr.pay_amount,
    pr.pay_status,
    pr.pay_time,

    -- é€€æ¬¾ä¿¡æ¯
    rr.refund_status,
    rr.audit_status,
    rr.refund_amount,
    rr.audit_time,

    cm.created_at,
    cm.updated_at
FROM
    camp_member cm
    INNER JOIN training_camp tc ON cm.camp_id = tc.id
    LEFT JOIN planet_user pu ON cm.planet_user_id = pu.id
    LEFT JOIN payment_record pr ON pr.member_id = cm.id AND pr.pay_status = 'success'
    LEFT JOIN refund_record rr ON rr.member_id = cm.id
WHERE
    cm.deleted_at IS NULL
    AND tc.deleted_at IS NULL;
```

### 5.6.5 æ•°æ®å¤‡ä»½

**å¤‡ä»½ç­–ç•¥**ï¼š
- æ‰§è¡Œæ—¶é—´ï¼šæ¯å¤©å‡Œæ™¨ 3 ç‚¹ï¼ˆcron: `0 3 * * *`ï¼‰
- å­˜å‚¨ä½ç½®ï¼š`/data/backups/db/`
- ä¿ç•™ç­–ç•¥ï¼šè‡ªåŠ¨æ¸…ç† 7 å¤©å‰çš„å¤‡ä»½

```bash
# æ¯æ—¥è‡ªåŠ¨å¤‡ä»½è„šæœ¬
BACKUP_DIR="/data/backups/db"
DATE=$(date +%Y%m%d_%H%M%S)
pg_dump -U camp_user -h localhost camp_db | gzip > "${BACKUP_DIR}/camp_backup_${DATE}.sql.gz"
find ${BACKUP_DIR} -name "camp_backup_*.sql.gz" -mtime +7 -delete

# æ¢å¤æ•°æ®
gunzip < backup_20251024.sql.gz | psql -U camp_user -h localhost camp_db
```

## 5.7 æ¥å£è®¾è®¡

### 5.7.1 URL è§„èŒƒ

```
# ç®¡ç†ç«¯
/api/admin/camps                    # è®­ç»ƒè¥èµ„æº
/api/admin/members                  # ä¼šå‘˜èµ„æº
/api/admin/refunds                  # é€€æ¬¾èµ„æº

# H5ç«¯
/api/h5/camps                       # H5è®­ç»ƒè¥
/api/h5/payments                    # H5æ”¯ä»˜
/api/h5/progress                    # H5è¿›åº¦

# Webhook
/api/webhook/wechat/payment         # å¾®ä¿¡æ”¯ä»˜å›è°ƒ
```

### 5.7.2 ç»Ÿä¸€å“åº”æ ¼å¼

```json
{
  "code": 200,
  "message": "æˆåŠŸ",
  "data": {},
  "timestamp": 1234567890
}
```

**çŠ¶æ€ç å®šä¹‰**ï¼š
- `200`ï¼šæˆåŠŸ
- `400`ï¼šè¯·æ±‚å‚æ•°é”™è¯¯
- `401`ï¼šæœªè®¤è¯
- `403`ï¼šæ— æƒé™
- `404`ï¼šèµ„æºä¸å­˜åœ¨
- `500`ï¼šæœåŠ¡å™¨é”™è¯¯

**ä¸šåŠ¡é”™è¯¯ç ï¼ˆ1001-1999ï¼‰**ï¼š
- **1001-1099**: è®­ç»ƒè¥ç›¸å…³ï¼ˆ1001:ä¸å­˜åœ¨ï¼Œ1002:å·²æ»¡å‘˜ï¼Œ1003:å·²ç»“æŸï¼‰
- **1101-1199**: æ”¯ä»˜ç›¸å…³ï¼ˆ1101:è®¢å•ä¸å­˜åœ¨ï¼Œ1102:é‡å¤æŠ¥åï¼Œ1105:é‡‘é¢ä¸åŒ¹é…ï¼‰
- **1201-1299**: é€€æ¬¾ç›¸å…³ï¼ˆ1201:è®°å½•ä¸å­˜åœ¨ï¼Œ1202:çŠ¶æ€å¼‚å¸¸ï¼‰
- **1301-1399**: è®¤è¯/æˆæƒï¼ˆ1301:Tokenæ— æ•ˆï¼Œ1302:Tokenè¿‡æœŸï¼Œ1303:æƒé™ä¸è¶³ï¼‰
- **1401-1499**: ç»‘å®šç›¸å…³ï¼ˆ1401:è´¦å·æœªæ‰¾åˆ°ï¼Œ1402:è´¦å·å·²ç»‘å®šï¼‰

**ç³»ç»Ÿé”™è¯¯ç ï¼ˆ2001-2999ï¼‰**ï¼š
- **2001-2099**: æ•°æ®åº“ï¼ˆ2001:è¿æ¥å¤±è´¥ï¼‰
- **2101-2199**: ç¼“å­˜ï¼ˆ2101:Redisè¿æ¥å¤±è´¥ï¼‰

**ç¬¬ä¸‰æ–¹é”™è¯¯ç ï¼ˆ3001-3999ï¼‰**ï¼š
- **3001-3099**: å¾®ä¿¡æ”¯ä»˜ï¼ˆ3001:æœåŠ¡å¼‚å¸¸ï¼‰
- **3101-3199**: çŸ¥è¯†æ˜ŸçƒAPIï¼ˆ3101:APIå¼‚å¸¸ï¼‰
- **3201-3299**: è…¾è®¯äº‘ï¼ˆ3201:COSå¼‚å¸¸ï¼‰
- **3301-3399**: ä¼ä¸šå¾®ä¿¡ï¼ˆ3301:é€šçŸ¥å¤±è´¥ï¼‰

### 5.7.3 æ ¸å¿ƒæ¥å£åˆ—è¡¨

#### ç®¡ç†ç«¯æ¥å£

| æ–¹æ³• | è·¯å¾„ | æè¿° |
|------|------|------|
| POST | /api/admin/camps | åˆ›å»ºè®­ç»ƒè¥ |
| GET | /api/admin/camps | è®­ç»ƒè¥åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰ |
| GET | /api/admin/camps/{campId} | è®­ç»ƒè¥è¯¦æƒ… |
| PUT | /api/admin/camps/{campId} | æ›´æ–°è®­ç»ƒè¥ |
| DELETE | /api/admin/camps/{campId} | åˆ é™¤è®­ç»ƒè¥ |
| POST | /api/admin/camps/{campId}/publish | å‘å¸ƒè®­ç»ƒè¥ |
| GET | /api/admin/members | ä¼šå‘˜åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰ |
| GET | /api/admin/members/{memberId} | ä¼šå‘˜è¯¦æƒ… |
| POST | /api/admin/members/{memberId}/match | æ‰‹åŠ¨åŒ¹é…ä¼šå‘˜ |
| GET | /api/admin/refunds/pending | å¾…å®¡æ ¸åˆ—è¡¨ |
| POST | /api/admin/refunds/{refundId}/approve | å®¡æ ¸é€šè¿‡ |
| POST | /api/admin/refunds/batch-approve | æ‰¹é‡å®¡æ ¸ |
| GET | /api/admin/refunds/records | é€€æ¬¾è®°å½• |
| POST | /api/admin/refunds/{refundId}/retry | é‡è¯•å¤±è´¥é€€æ¬¾ |

#### H5ç«¯æ¥å£

| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| GET | /api/h5/camps | è®­ç»ƒè¥åˆ—è¡¨ | æ—  |
| GET | /api/h5/camps/{campId} | è®­ç»ƒè¥è¯¦æƒ… | æ—  |
| POST | /api/h5/payments | åˆ›å»ºæ”¯ä»˜è®¢å• | æ—  |
| GET | /api/h5/payments/{orderNo}/params | è·å–æ”¯ä»˜å‚æ•° | æ—  |
| GET | /api/h5/payments/{orderNo}/status | æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€ | æ—  |
| POST | /api/h5/payments/bind | ç”¨æˆ·ç»‘å®šæ˜Ÿçƒä¿¡æ¯ | **ç¥¨æ®** |
| GET | /api/h5/payments/{orderNo}/qrcode | è·å–ç¾¤äºŒç»´ç  | **ç¥¨æ®** |
| GET | /api/h5/progress/{memberId} | æŸ¥è¯¢æ‰“å¡è¿›åº¦ | **ç¥¨æ®** |

> **è¯´æ˜**ï¼š
> - æ ‡æ³¨"ç¥¨æ®"çš„æ¥å£éœ€è¦åœ¨ Header ä¸­ä¼ é€’ `X-Access-Token`
> - *`/payments/{orderNo}/status` æ— éœ€ç¥¨æ®ï¼Œæ”¯ä»˜æˆåŠŸæ—¶å“åº”ä¸­è¿”å› `accessToken`

#### è®¤è¯ç®¡ç†æ¥å£

| æ–¹æ³• | è·¯å¾„ | æè¿° | è®¤è¯ |
|------|------|------|------|
| GET | /api/auth/authorize | è·å–å¾®ä¿¡å…¬ä¼—å·æˆæƒåœ°å€ | æ—  |
| GET | /api/auth/callback/wechat-mp | å¾®ä¿¡OAuthå›è°ƒå¤„ç† | æ—  |
| POST | /api/auth/bindPlanet | ç»‘å®šçŸ¥è¯†æ˜Ÿçƒè´¦å· | Bearer Token |

> **è¯´æ˜**ï¼šOAuth è®¤è¯æµç¨‹ç”¨äºè·å–ç”¨æˆ·å¾®ä¿¡èº«ä»½ï¼Œå»ºç«‹å¾®ä¿¡ OpenID ä¸çŸ¥è¯†æ˜Ÿçƒè´¦å·çš„ç»‘å®šå…³ç³»ã€‚
> **è¯¦ç»†è®¾è®¡**ï¼šå‚è§ [OAuthå®‰å…¨æŒ‡å—](../security/OAuthå®‰å…¨æŒ‡å—.md)

#### Webhook æ¥å£

| æ–¹æ³• | è·¯å¾„ | æè¿° |
|------|------|------|
| POST | /api/webhook/wechat/payment | æ”¯ä»˜ç»“æœé€šçŸ¥ |
| POST | /api/webhook/wechat/refund | é€€æ¬¾ç»“æœé€šçŸ¥ |

### 5.7.4 æ¥å£è®¤è¯

> **âš ï¸ 2025-12 æ›´æ–°**ï¼šH5 ç«¯ä¸»è·¯å¾„å·²æ”¹ä¸º JWT Token è®¤è¯ï¼ˆåŸºäºå¾®ä¿¡ OAuth ç™»å½•ï¼‰ã€‚
> åŸ Access Token æœºåˆ¶ä»…ç”¨äºé™çº§è·¯å¾„ï¼ˆå›ºå®šäºŒç»´ç æ”¯ä»˜ï¼‰åœºæ™¯ã€‚

| æ¥å£ç±»å‹ | è®¤è¯æ–¹å¼ | è¯´æ˜ |
|----------|----------|------|
| ç®¡ç†åå° | JWT Token | `Authorization: Bearer {token}` |
| H5ç«¯ï¼ˆä¸»è·¯å¾„ï¼‰ | **JWT Tokenï¼ˆæ–°ï¼‰** | OAuth ç™»å½•åè·å–ï¼Œ`Authorization: Bearer {token}` |
| H5ç«¯ï¼ˆé™çº§è·¯å¾„ï¼‰ | Access Token | å›ºå®šäºŒç»´ç æ”¯ä»˜åœºæ™¯ï¼Œ`X-Access-Token: {token}` |
| H5ç«¯ï¼ˆå…¬å¼€ï¼‰ | æ— éœ€è®¤è¯ | è®­ç»ƒè¥åˆ—è¡¨/è¯¦æƒ… |
| Webhook | ç­¾åéªŒè¯ | éªŒè¯å¾®ä¿¡æ”¯ä»˜ç­¾å |

#### H5 ä¸»è·¯å¾„è®¤è¯ï¼ˆJWT Tokenï¼Œæ–°ï¼‰

**è®¤è¯æµç¨‹**ï¼š

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant H5 as H5 å‰ç«¯
    participant API as åç«¯ API
    participant WX as å¾®ä¿¡å…¬ä¼—å·

    U->>H5: ç‚¹å‡»æŠ¥åé“¾æ¥
    H5->>H5: æ£€æŸ¥æœ¬åœ° JWT Token
    alt æ—  Token æˆ–å·²è¿‡æœŸ
        H5->>API: GET /api/h5/auth/wechat?returnUrl=xxx
        API-->>H5: è¿”å›å¾®ä¿¡æˆæƒ URL
        H5->>WX: è·³è½¬å¾®ä¿¡æˆæƒé¡µ
        U->>WX: åŒæ„æˆæƒ
        WX->>API: å›è°ƒ /api/h5/auth/callback?code=xxx
        API->>API: è·å– openidï¼Œåˆ›å»º/è·å– wechat_user
        API->>API: ç”Ÿæˆ JWT Token
        API-->>H5: é‡å®šå‘å¹¶è¿”å› Token
    end
    H5->>API: åç»­è¯·æ±‚æºå¸¦ JWT Token
```

**JWT Token å±æ€§**ï¼š

| å±æ€§ | å€¼ |
|------|-----|
| æ ¼å¼ | JWT (HS256) |
| æœ‰æ•ˆæœŸ | 30 å¤© |
| è½½è· | `{ h5UserId, wechatOpenId, exp }` |
| Header | `Authorization: Bearer {token}` |

**ç›¸å…³æ¥å£**ï¼š

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/api/h5/auth/wechat` | è·å–å¾®ä¿¡ OAuth æˆæƒ URL |
| GET | `/api/h5/auth/callback` | OAuth å›è°ƒï¼Œè¿”å› JWT Token |
| GET | `/api/h5/user/profile` | è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ |
| POST | `/api/h5/bind-planet` | ç»‘å®šæ˜Ÿçƒè´¦å· |

---

#### H5 é™çº§è·¯å¾„è®¤è¯ï¼ˆAccess Tokenï¼Œä¿ç•™ï¼‰

> ç”¨äºå›ºå®šäºŒç»´ç æ”¯ä»˜åœºæ™¯ï¼šç”¨æˆ·ç›´æ¥æ‰«ç æ”¯ä»˜ï¼Œæ”¯ä»˜åéœ€å¡«å†™æ˜Ÿçƒä¿¡æ¯ç»‘å®šã€‚

**è®¾è®¡ç›®çš„**ï¼šé˜²æ­¢è®¢å•å·æšä¸¾å’ŒæŠ¢ç»‘å®šæ”»å‡»ã€‚

| å±æ€§ | å€¼ |
|------|-----|
| æ ¼å¼ | UUID v4ï¼Œå‰ç¼€ `tk_` |
| æœ‰æ•ˆæœŸ | **è®­ç»ƒè¥ç»“æŸå 7 å¤©**ï¼ˆåŠ¨æ€è®¡ç®—ï¼Œè¦†ç›–æ•´ä¸ªè®­ç»ƒè¥å‘¨æœŸï¼‰ |
| ç”Ÿæˆæ—¶æœº | æ”¯ä»˜æˆåŠŸåï¼Œåœ¨ `/payments/{orderNo}/status` å“åº”ä¸­è¿”å› |
| é€‚ç”¨æ¥å£ | `/payments/bind`ã€`/payments/{orderNo}/qrcode`ã€`/progress/{memberId}` |

> **æœ‰æ•ˆæœŸè¯´æ˜**ï¼šå…¸å‹è®­ç»ƒè¥æŒç»­ 21-30 å¤©ï¼Œç¥¨æ®æœ‰æ•ˆæœŸéœ€è¦†ç›–æ•´ä¸ªå‘¨æœŸåŠç»“ç®—æœŸã€‚

**ç¥¨æ®çŠ¶æ€**ï¼š
- `active`ï¼šå¯ç”¨äºç»‘å®šå’ŒæŸ¥è¯¢
- `bound`ï¼šå·²å®Œæˆç»‘å®šï¼Œä»å¯ç”¨äºæŸ¥è¯¢
- `expired`ï¼šç¥¨æ®è¿‡æœŸï¼ˆè®­ç»ƒè¥ç»“æŸ +7 å¤©åï¼‰ï¼Œæ‰€æœ‰æ¥å£ä¸å¯ç”¨

#### Redis å­˜å‚¨è®¾è®¡

**Key å‘½åè§„èŒƒ**ï¼š
```
access_token:{token}          # ç¥¨æ®ä¸»é”®
access_token:order:{orderNo}  # è®¢å•å· â†’ ç¥¨æ®åæŸ¥ç´¢å¼•
```

**æ•°æ®ç»“æ„**ï¼ˆHashï¼‰ï¼š
```redis
HSET access_token:tk_1a2b3c4d5e6f
    token          "tk_1a2b3c4d5e6f"
    order_no       "ord_20251203_123456"
    member_id      "123"
    camp_id        "1"
    status         "active"          # active/bound/expired
    created_at     "2025-12-03T10:00:00Z"
    expires_at     "2026-01-15T23:59:59Z"   # è®­ç»ƒè¥ç»“æŸ +7å¤©
    bound_at       ""                # ç»‘å®šæ—¶é—´ï¼ˆstatus=boundæ—¶å¡«å……ï¼‰

# æœ‰æ•ˆæœŸè®¾ç½®
EXPIREAT access_token:tk_1a2b3c4d5e6f 1736985599
```

**åæŸ¥ç´¢å¼•**ï¼ˆStringï¼‰ï¼š
```redis
SET access_token:order:ord_20251203_123456 "tk_1a2b3c4d5e6f"
EXPIREAT access_token:order:ord_20251203_123456 1736985599
```

#### ç¥¨æ®çŠ¶æ€æœº

```mermaid
stateDiagram-v2
    [*] --> active: æ”¯ä»˜æˆåŠŸåç”Ÿæˆ

    active --> bound: ç”¨æˆ·å®Œæˆç»‘å®š
    active --> expired: è¶…è¿‡æœ‰æ•ˆæœŸ

    bound --> expired: è¶…è¿‡æœ‰æ•ˆæœŸ

    expired --> [*]: å®šæ—¶æ¸…ç†

    note right of active
        å¯ç”¨æ“ä½œï¼š
        - ç»‘å®šæ˜Ÿçƒè´¦å·
        - æŸ¥è¯¢è®¢å•çŠ¶æ€
        - è·å–ç¾¤äºŒç»´ç 
    end note

    note right of bound
        å¯ç”¨æ“ä½œï¼š
        - æŸ¥è¯¢è®¢å•çŠ¶æ€
        - è·å–ç¾¤äºŒç»´ç 
        - æŸ¥è¯¢æ‰“å¡è¿›åº¦
        ä¸å¯æ“ä½œï¼š
        - ç»‘å®šï¼ˆå·²ç»‘å®šï¼‰
    end note

    note right of expired
        æ‰€æœ‰æ¥å£è¿”å› 401
        æç¤ºç¥¨æ®å·²è¿‡æœŸ
    end note
```

**çŠ¶æ€è½¬æ¢äº‹ä»¶**ï¼š

| äº‹ä»¶ | è§¦å‘æ¡ä»¶ | æ¥æºçŠ¶æ€ | ç›®æ ‡çŠ¶æ€ | å‰¯ä½œç”¨ |
|------|----------|----------|----------|--------|
| CREATE | æ”¯ä»˜æˆåŠŸ | - | active | ç”Ÿæˆç¥¨æ®ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ |
| BIND | ç”¨æˆ·ç»‘å®šæˆåŠŸ | active | bound | æ›´æ–° `bound_at` å­—æ®µ |
| EXPIRE | è¶…è¿‡æœ‰æ•ˆæœŸ | active/bound | expired | å®šæ—¶ä»»åŠ¡æ¸…ç† Redis |

**ç¥¨æ®éªŒè¯æµç¨‹**ï¼š

```java
// ä¼ªä»£ç ï¼šéªŒè¯ access_token
public AccessTokenInfo validateToken(String token) throws TokenException {
    // 1. æ£€æŸ¥æ ¼å¼
    if (!token.startsWith("tk_")) {
        throw new TokenException("INVALID_FORMAT", "æ— æ•ˆçš„ç¥¨æ®æ ¼å¼");
    }

    // 2. ä» Redis è·å–
    String key = "access_token:" + token;
    Map<String, String> data = redisTemplate.opsForHash().entries(key);

    if (data.isEmpty()) {
        throw new TokenException("TOKEN_NOT_FOUND", "ç¥¨æ®ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ");
    }

    // 3. æ£€æŸ¥çŠ¶æ€
    String status = data.get("status");
    if ("expired".equals(status)) {
        throw new TokenException("TOKEN_EXPIRED", "ç¥¨æ®å·²è¿‡æœŸ");
    }

    // 4. æ£€æŸ¥æœ‰æ•ˆæœŸï¼ˆåŒé‡ä¿é™©ï¼‰
    Instant expiresAt = Instant.parse(data.get("expires_at"));
    if (Instant.now().isAfter(expiresAt)) {
        // æ›´æ–°çŠ¶æ€ä¸º expired
        redisTemplate.opsForHash().put(key, "status", "expired");
        throw new TokenException("TOKEN_EXPIRED", "ç¥¨æ®å·²è¿‡æœŸ");
    }

    // 5. è¿”å›ç¥¨æ®ä¿¡æ¯
    return AccessTokenInfo.fromRedisData(data);
}
```

**ç¥¨æ®ç”Ÿæˆç¤ºä¾‹**ï¼š

```java
// ä¼ªä»£ç ï¼šæ”¯ä»˜æˆåŠŸåç”Ÿæˆç¥¨æ®
public String generateAccessToken(PaymentRecord payment, TrainingCamp camp) {
    String token = "tk_" + UUID.randomUUID().toString().replace("-", "");

    // è®¡ç®—æœ‰æ•ˆæœŸï¼šè®­ç»ƒè¥ç»“æŸ +7å¤©
    LocalDateTime expiresAt = camp.getEndDate().plusDays(7).atTime(23, 59, 59);

    // å­˜å‚¨åˆ° Redis
    String key = "access_token:" + token;
    Map<String, String> data = new HashMap<>();
    data.put("token", token);
    data.put("order_no", payment.getOrderNo());
    // member_id å¯èƒ½ä¸º nullï¼ˆæ”¯ä»˜æˆåŠŸæ—¶å°šæœªç»‘å®šï¼‰ï¼Œå…ˆå†™ç©ºä¸²ï¼Œç»‘å®šåå†æ›´æ–°
    data.put("member_id", payment.getMemberId() != null ? String.valueOf(payment.getMemberId()) : "");
    data.put("camp_id", String.valueOf(payment.getCampId()));
    data.put("status", "active");
    data.put("created_at", Instant.now().toString());
    data.put("expires_at", expiresAt.toInstant(ZoneOffset.UTC).toString());
    data.put("bound_at", "");

    redisTemplate.opsForHash().putAll(key, data);

    // è®¾ç½®è¿‡æœŸæ—¶é—´
    redisTemplate.expireAt(key, Date.from(expiresAt.toInstant(ZoneOffset.UTC)));

    // åˆ›å»ºåæŸ¥ç´¢å¼•
    String indexKey = "access_token:order:" + payment.getOrderNo();
    redisTemplate.opsForValue().set(indexKey, token);
    redisTemplate.expireAt(indexKey, Date.from(expiresAt.toInstant(ZoneOffset.UTC)));

    return token;
}
```

## 5.8 å®šæ—¶ä»»åŠ¡è®¾è®¡

### 5.8.1 å®šæ—¶ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | Cron è¡¨è¾¾å¼ | æ‰§è¡Œæ—¶é—´ | åŠŸèƒ½è¯´æ˜ |
|------|-------------|----------|----------|
| æ‰“å¡æ•°æ®åŒæ­¥ | `0 0 1 * * ?` | æ¯å¤© 01:00 | ä»çŸ¥è¯†æ˜Ÿçƒ API åŒæ­¥æ‰“å¡æ•°æ®ï¼Œæ›´æ–°ä¼šå‘˜è¿›åº¦ï¼Œå¤±è´¥å‘Šè­¦ |
| ç»‘å®šè¶…æ—¶æ£€æŸ¥ | `0 0 2 * * ?` | æ¯å¤© 02:00 | æ£€æŸ¥ `bind_status=pending` ä¸”è¶…æ—¶çš„è®°å½•ï¼Œæ›´æ–°ä¸º `expired`ï¼Œè½¬å…¥äººå·¥å®¡æ ¸æµç¨‹ï¼ˆ`manual_review`ï¼‰ |
| é€€æ¬¾è§¦å‘ | `0 0 3 * * ?` | æ¯å¤© 03:00 | æŸ¥è¯¢æ˜¨æ—¥ç»“æŸçš„è®­ç»ƒè¥ï¼Œç”Ÿæˆé€€æ¬¾å®¡æ ¸åˆ—è¡¨ï¼Œé€šçŸ¥ç®¡ç†å‘˜ |
| è®­ç»ƒè¥çŠ¶æ€æ›´æ–° | `0 5 0 * * ?` | æ¯å¤© 00:05 | æ ¹æ®æ—¥æœŸè‡ªåŠ¨æ›´æ–°è®­ç»ƒè¥çŠ¶æ€ |
| **è¿›ç¾¤æé†’** | `0 0 10 * * ?` | æ¯å¤© 10:00 | æ£€æŸ¥æ”¯ä»˜æˆåŠŸä½†24å°æ—¶æœªè¿›ç¾¤çš„ä¼šå‘˜ï¼Œå‘é€æé†’ |
| **æ‰“å¡æé†’** | `0 0 20 * * ?` | æ¯å¤© 20:00 | å‘å½“æ—¥æœªæ‰“å¡ä¸”è®­ç»ƒè¥è¿›è¡Œä¸­çš„ä¼šå‘˜å‘é€æé†’ |
| **ç»“æŸæé†’** | `0 0 9 * * ?` | æ¯å¤© 09:00 | æ£€æŸ¥æ˜å¤©ç»“æŸçš„è®­ç»ƒè¥ï¼Œæé†’æœªå®Œæˆæ‰“å¡çš„ä¼šå‘˜ |
| **æ”¯ä»˜è½®è¯¢å…œåº•** | `0 0 * * * ?` | æ¯å°æ—¶æ•´ç‚¹ | è½®è¯¢å¾®ä¿¡æ”¯ä»˜è®°å½•ï¼Œè¡¥å½•ç¼ºå¤±çš„Webhookå›è°ƒ |

### 5.8.2 é€šçŸ¥åŠŸèƒ½è¯¦ç»†è®¾è®¡

#### é€šçŸ¥æ¸ é“

| æ¸ é“ | ä¼˜å…ˆçº§ | é€‚ç”¨åœºæ™¯ | æŠ€æœ¯å®ç° |
|------|--------|----------|----------|
| ä¼ä¸šå¾®ä¿¡åº”ç”¨æ¶ˆæ¯ | é«˜ | é€€æ¬¾é€šçŸ¥ã€å¼‚å¸¸å‘Šè­¦ | ä¼ä¸šå¾®ä¿¡API |
| çŸ­ä¿¡ | é«˜ | é‡è¦æé†’ï¼ˆå¯é€‰ï¼‰ | é˜¿é‡Œäº‘çŸ­ä¿¡ |
| ç«™å†…æ¶ˆæ¯ | ä¸­ | æ‰“å¡æé†’ã€è¿›åº¦é€šçŸ¥ | ç³»ç»Ÿå†…éƒ¨ |

#### é€šçŸ¥ç±»å‹æ¸…å•

| é€šçŸ¥ç±»å‹ | è§¦å‘æ—¶æœº | æ¥æ”¶å¯¹è±¡ | æ¸ é“ | æ¨¡æ¿ç¤ºä¾‹ |
|----------|----------|----------|------|----------|
| æ”¯ä»˜æˆåŠŸ | æ”¯ä»˜å›è°ƒæˆåŠŸ | ä¼šå‘˜ | ç«™å†… | æ­å–œæŠ¥åæˆåŠŸï¼Œè¯·å°½å¿«æ‰«ç å…¥ç¾¤ |
| è¿›ç¾¤æé†’ | æ”¯ä»˜å24å°æ—¶æœªè¿›ç¾¤ | ä¼šå‘˜ | ä¼å¾®/ç«™å†… | æ‚¨å·²æŠ¥åã€{è¥å}ã€‘ï¼Œè¯·å°½å¿«å…¥ç¾¤ |
| æ‰“å¡æé†’ | æ¯æ—¥20:00 | å½“æ—¥æœªæ‰“å¡ä¼šå‘˜ | ç«™å†… | ä»Šæ—¥æ‰“å¡è¿˜æœªå®Œæˆï¼ŒåŠ æ²¹ï¼ |
| ç»“æŸæé†’ | ç»“æŸå‰1å¤© | æœªå®Œæˆç›®æ ‡ä¼šå‘˜ | ä¼å¾®/ç«™å†… | ã€{è¥å}ã€‘æ˜å¤©ç»“æŸï¼Œæ‚¨è¿˜å·®{n}å¤© |
| é€€æ¬¾æˆåŠŸ | é€€æ¬¾æ‰§è¡ŒæˆåŠŸ | ä¼šå‘˜ | ä¼å¾®/ç«™å†… | æ‚¨çš„æŠ¼é‡‘Â¥{é‡‘é¢}å·²é€€è¿˜ |
| é€€æ¬¾å¤±è´¥ | é€€æ¬¾æ‰§è¡Œå¤±è´¥ | ç®¡ç†å‘˜ | ä¼å¾® | é€€æ¬¾å¤±è´¥ï¼Œè¯·å¤„ç†ï¼š{åŸå› } |
| Cookieè¿‡æœŸ | APIè¿”å›401/403 | ç®¡ç†å‘˜ | ä¼å¾® | çŸ¥è¯†æ˜ŸçƒCookieå·²è¿‡æœŸï¼Œè¯·æ›´æ–° |

#### è¿›ç¾¤æé†’æµç¨‹

```mermaid
flowchart TD
    A[å®šæ—¶ä»»åŠ¡è§¦å‘<br/>æ¯å¤© 10:00] --> B[æŸ¥è¯¢æ”¯ä»˜æˆåŠŸè®°å½•]
    B --> C[ç­›é€‰æ¡ä»¶]
    C --> D{joined_group = false<br/>AND pay_time < now - 24h<br/>AND camp.status = ONGOING}
    D -->|ç¬¦åˆ| E[è·å–ä¼šå‘˜ä¿¡æ¯]
    D -->|ä¸ç¬¦åˆ| F[è·³è¿‡]
    E --> G{å·²å‘é€æé†’?}
    G -->|æ˜¯| H[æ£€æŸ¥æ˜¯å¦éœ€è¦å†æ¬¡æé†’<br/>é—´éš” â‰¥ 24h]
    G -->|å¦| I[å‘é€é¦–æ¬¡æé†’]
    H -->|éœ€è¦| I
    H -->|ä¸éœ€è¦| F
    I --> J[è®°å½•æé†’æ—¥å¿—]
    J --> K[æ›´æ–° last_remind_time]
```

#### æ‰“å¡æé†’æµç¨‹

```mermaid
flowchart TD
    A[å®šæ—¶ä»»åŠ¡è§¦å‘<br/>æ¯å¤© 20:00] --> B[æŸ¥è¯¢è¿›è¡Œä¸­çš„è®­ç»ƒè¥]
    B --> C[éå†è®­ç»ƒè¥]
    C --> D[è·å–ä»Šæ—¥æœªæ‰“å¡ä¼šå‘˜]
    D --> E{ä¼šå‘˜åˆ—è¡¨ä¸ºç©º?}
    E -->|æ˜¯| F[å¤„ç†ä¸‹ä¸€ä¸ªè®­ç»ƒè¥]
    E -->|å¦| G[æ‰¹é‡å‘é€æ‰“å¡æé†’]
    G --> H[è®°å½•æé†’æ—¥å¿—]
    H --> I{è¿˜æœ‰è®­ç»ƒè¥?}
    I -->|æ˜¯| C
    I -->|å¦| J[ä»»åŠ¡å®Œæˆ]
```

#### é¡¹ç›®ç»“æŸæé†’æµç¨‹

```mermaid
flowchart TD
    A[å®šæ—¶ä»»åŠ¡è§¦å‘<br/>æ¯å¤© 09:00] --> B[æŸ¥è¯¢æ˜å¤©ç»“æŸçš„è®­ç»ƒè¥]
    B --> C{æ‰¾åˆ°è®­ç»ƒè¥?}
    C -->|å¦| D[ä»»åŠ¡ç»“æŸ]
    C -->|æ˜¯| E[éå†è®­ç»ƒè¥]
    E --> F[è·å–ä¼šå‘˜æ‰“å¡ç»Ÿè®¡]
    F --> G{checkin_count < required_days?}
    G -->|æ˜¯| H[åŠ å…¥æé†’åˆ—è¡¨]
    G -->|å¦| I[è·³è¿‡]
    H --> J[è®¡ç®—å·®è·å¤©æ•°]
    J --> K[å‘é€ç»“æŸæé†’<br/>åŒ…å«å·®è·ä¿¡æ¯]
    I --> L{è¿˜æœ‰ä¼šå‘˜?}
    K --> L
    L -->|æ˜¯| F
    L -->|å¦| M{è¿˜æœ‰è®­ç»ƒè¥?}
    M -->|æ˜¯| E
    M -->|å¦| D
```

### 5.8.3 æ”¯ä»˜è½®è¯¢å…œåº•æœºåˆ¶

#### è®¾è®¡èƒŒæ™¯

å¾®ä¿¡æ”¯ä»˜ Webhook å›è°ƒå¯èƒ½å› ç½‘ç»œé—®é¢˜ä¸¢å¤±ï¼Œéœ€è¦è½®è¯¢æœºåˆ¶å…œåº•ç¡®ä¿æ”¯ä»˜è®°å½•å®Œæ•´ã€‚

#### è½®è¯¢æµç¨‹

```mermaid
sequenceDiagram
    autonumber
    participant Scheduler as å®šæ—¶è°ƒåº¦å™¨
    participant API as APIæœåŠ¡
    participant DB as æ•°æ®åº“
    participant WX as å¾®ä¿¡æ”¯ä»˜

    Scheduler->>API: è§¦å‘è½®è¯¢ä»»åŠ¡<br/>æ¯å°æ—¶æ•´ç‚¹
    API->>DB: æŸ¥è¯¢è¿›è¡Œä¸­çš„è®­ç»ƒè¥
    DB-->>API: è¿”å›è®­ç»ƒè¥åˆ—è¡¨

    loop æ¯ä¸ªè®­ç»ƒè¥
        API->>WX: æŸ¥è¯¢æ”¶æ¬¾è®°å½•<br/>GET /cgi-bin/externalpay/get_bill_list
        WX-->>API: è¿”å›æ”¯ä»˜åˆ—è¡¨

        loop æ¯æ¡æ”¯ä»˜è®°å½•
            API->>DB: æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨<br/>æŒ‰ transaction_id æŸ¥è¯¢
            DB-->>API: è¿”å›æŸ¥è¯¢ç»“æœ

            alt ä¸å­˜åœ¨
                API->>DB: åˆ›å»ºæ”¯ä»˜è®°å½•<br/>bind_status=pending
                API->>API: è§¦å‘æ™ºèƒ½åŒ¹é…
                API->>DB: è®°å½•è¡¥å½•æ—¥å¿—
            else å·²å­˜åœ¨
                API->>API: è·³è¿‡
            end
        end
    end

    API-->>Scheduler: è½®è¯¢å®Œæˆ
```

#### è½®è¯¢ç­–ç•¥

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| æ‰§è¡Œé¢‘ç‡ | æ¯å°æ—¶ | å¹³è¡¡å®æ—¶æ€§å’ŒAPIè°ƒç”¨é‡ |
| æŸ¥è¯¢èŒƒå›´ | æœ€è¿‘24å°æ—¶ | é¿å…é‡å¤å¤„ç† |
| å¹¶å‘æ§åˆ¶ | å•å®ä¾‹æ‰§è¡Œ | Redis åˆ†å¸ƒå¼é” |
| å¤±è´¥é‡è¯• | 3æ¬¡ | æŒ‡æ•°é€€é¿ |

#### è¡¥å½•å¤„ç†é€»è¾‘

```java
// ä¼ªä»£ç ï¼šæ”¯ä»˜è®°å½•è¡¥å½•
public void processPolledPayment(WechatPayRecord record) {
    // 1. å¹‚ç­‰æ£€æŸ¥
    if (paymentRepository.existsByTransactionId(record.getTransactionId())) {
        return; // å·²å­˜åœ¨ï¼Œè·³è¿‡
    }

    // 2. åˆ›å»ºæ”¯ä»˜è®°å½•
    PaymentRecord payment = new PaymentRecord();
    payment.setOrderNo(generateOrderNo());
    payment.setTransactionId(record.getTransactionId());
    payment.setPayAmount(record.getAmount());
    payment.setPayTime(record.getPayTime());
    payment.setPayerWechatName(record.getPayerName());
    payment.setCampId(matchCampByAmount(record.getAmount())); // æŒ‰é‡‘é¢åŒ¹é…è®­ç»ƒè¥
    payment.setBindStatus(BindStatus.PENDING);
    payment.setBindDeadline(LocalDateTime.now().plusDays(7));
    payment.setSource("POLLING"); // æ ‡è®°æ¥æºä¸ºè½®è¯¢è¡¥å½•

    paymentRepository.save(payment);

    // 3. å°è¯•æ™ºèƒ½åŒ¹é…
    matchService.trySmartMatch(payment.getId());

    // 4. è®°å½•è¡¥å½•æ—¥å¿—
    logService.recordPollingRecovery(payment);
}
```

### 5.8.4 é€šçŸ¥æ¶ˆæ¯è¡¨è®¾è®¡

```sql
-- é€šçŸ¥æ¶ˆæ¯è¡¨
CREATE TABLE notification_message (
    id BIGSERIAL PRIMARY KEY,

    -- æ¥æ”¶è€…ä¿¡æ¯
    recipient_type VARCHAR(20) NOT NULL COMMENT 'æ¥æ”¶è€…ç±»å‹: member-ä¼šå‘˜, admin-ç®¡ç†å‘˜',
    recipient_id BIGINT NOT NULL COMMENT 'æ¥æ”¶è€…ID',

    -- æ¶ˆæ¯å†…å®¹
    message_type VARCHAR(50) NOT NULL COMMENT 'æ¶ˆæ¯ç±»å‹: payment_success, join_remind, checkin_remind, etc.',
    title VARCHAR(200) NOT NULL COMMENT 'æ¶ˆæ¯æ ‡é¢˜',
    content TEXT NOT NULL COMMENT 'æ¶ˆæ¯å†…å®¹',

    -- å…³è”ä¿¡æ¯
    camp_id BIGINT COMMENT 'å…³è”è®­ç»ƒè¥ID',
    member_id BIGINT COMMENT 'å…³è”ä¼šå‘˜ID',
    extra_data JSONB COMMENT 'é¢å¤–æ•°æ®',

    -- å‘é€çŠ¶æ€
    channel VARCHAR(20) NOT NULL COMMENT 'å‘é€æ¸ é“: wechat-ä¼å¾®, sms-çŸ­ä¿¡, internal-ç«™å†…',
    send_status VARCHAR(20) NOT NULL DEFAULT 'pending' COMMENT 'å‘é€çŠ¶æ€: pending-å¾…å‘é€, sent-å·²å‘é€, failed-å¤±è´¥',
    send_time TIMESTAMP COMMENT 'å‘é€æ—¶é—´',
    retry_count INTEGER DEFAULT 0 COMMENT 'é‡è¯•æ¬¡æ•°',
    error_message TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',

    -- é˜…è¯»çŠ¶æ€
    read_status BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å·²è¯»',
    read_time TIMESTAMP COMMENT 'é˜…è¯»æ—¶é—´',

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_nm_recipient ON notification_message(recipient_type, recipient_id);
CREATE INDEX idx_nm_type ON notification_message(message_type);
CREATE INDEX idx_nm_status ON notification_message(send_status) WHERE send_status = 'pending';
CREATE INDEX idx_nm_camp ON notification_message(camp_id);

COMMENT ON TABLE notification_message IS 'é€šçŸ¥æ¶ˆæ¯è¡¨';
```

### 5.8.5 é€šçŸ¥æœåŠ¡ç»„ä»¶

```mermaid
C4Component
    title é€šçŸ¥æœåŠ¡ç»„ä»¶å›¾

    Container_Boundary(notify, "é€šçŸ¥æœåŠ¡") {
        Component(notifyCtrl, "NotificationController", "Controller", "é€šçŸ¥æŸ¥è¯¢æ¥å£")
        Component(notifySvc, "NotificationService", "Service", "é€šçŸ¥ä¸šåŠ¡é€»è¾‘")
        Component(templateSvc, "TemplateService", "Service", "æ¶ˆæ¯æ¨¡æ¿æ¸²æŸ“")

        Component(wechatSender, "WechatMsgSender", "Sender", "ä¼ä¸šå¾®ä¿¡æ¶ˆæ¯å‘é€")
        Component(smsSender, "SmsSender", "Sender", "çŸ­ä¿¡å‘é€")
        Component(internalSender, "InternalSender", "Sender", "ç«™å†…æ¶ˆæ¯å­˜å‚¨")

        Component(notifyMapper, "NotificationMapper", "DAO", "é€šçŸ¥æ•°æ®è®¿é—®")
    }

    Rel(notifyCtrl, notifySvc, "è°ƒç”¨")
    Rel(notifySvc, templateSvc, "æ¸²æŸ“æ¨¡æ¿")
    Rel(notifySvc, wechatSender, "å‘é€ä¼å¾®æ¶ˆæ¯")
    Rel(notifySvc, smsSender, "å‘é€çŸ­ä¿¡")
    Rel(notifySvc, internalSender, "å­˜å‚¨ç«™å†…æ¶ˆæ¯")
    Rel(notifySvc, notifyMapper, "æŒä¹…åŒ–")
```

## 5.9 å®‰å…¨è®¾è®¡

### 5.9.1 èº«ä»½è®¤è¯

| åœºæ™¯ | æ–¹æ¡ˆ | è¯´æ˜ |
|------|------|------|
| ç®¡ç†åå° | JWT Token | æœ‰æ•ˆæœŸ 24 å°æ—¶ |
| å¯†ç å­˜å‚¨ | BCrypt | ä¸å¯é€†åŠ å¯† |
| æ•æ„Ÿé…ç½® | AES-GCM | å¯†é’¥æ¥æºç¯å¢ƒå˜é‡ |

### 5.9.2 æƒé™æ§åˆ¶

åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ï¼š

| è§’è‰² | æƒé™èŒƒå›´ |
|------|----------|
| admin | å…¨éƒ¨æƒé™ |
| manager | è®­ç»ƒè¥ç®¡ç†ã€é€€æ¬¾å®¡æ ¸ |
| coach | æŸ¥çœ‹è´Ÿè´£çš„è®­ç»ƒè¥ |
| volunteer | æŸ¥çœ‹å‚ä¸çš„è®­ç»ƒè¥ |

### 5.9.3 æ¥å£é˜²åˆ·

**é™æµç­–ç•¥**ï¼š
- å…¨å±€ï¼šæ¯ IP æ¯åˆ†é’Ÿ â‰¤ 100 æ¬¡
- ç™»å½•æ¥å£ï¼šæ¯ IP æ¯åˆ†é’Ÿ â‰¤ 10 æ¬¡
- Webhookï¼šæ”¾å®½è¿æ¥ä½†åšå¥½å¹‚ç­‰

### 5.9.4 æ•°æ®å®‰å…¨

- HTTPS é€šä¿¡
- SQL æ³¨å…¥é˜²æŠ¤ï¼ˆMyBatis Plus å‚æ•°åŒ–æŸ¥è¯¢ï¼‰
- XSS é˜²æŠ¤ï¼ˆå‰ç«¯è¾“å…¥è¿‡æ»¤ï¼‰
- CSRF é˜²æŠ¤ï¼ˆToken éªŒè¯ï¼‰

## 5.10 éƒ¨ç½²æ¶æ„

### 5.10.1 éƒ¨ç½²å›¾

> **å½“å‰å½¢æ€**ï¼šå•èŠ‚ç‚¹éƒ¨ç½²ï¼Œé€‚åˆæ—¥æ´» < 1000 ç”¨æˆ·çš„ä¸šåŠ¡è§„æ¨¡ã€‚

```mermaid
flowchart TB
    subgraph Cloud["äº‘æœåŠ¡å™¨ (è…¾è®¯äº‘ å•èŠ‚ç‚¹)"]
        api["API æœåŠ¡<br/>Spring Boot 3.2<br/>å†…ç½® Tomcat + SSL"]
        h5Static["H5 å‰ç«¯<br/>é™æ€èµ„æº"]
        adminStatic["ç®¡ç†åå°<br/>é™æ€èµ„æº"]
    end

    subgraph RDS["äº‘æ•°æ®åº“"]
        postgres[("PostgreSQL 15<br/>å•å®ä¾‹")]
    end

    subgraph Cache["äº‘ç¼“å­˜"]
        redis[("Redis 7<br/>å•å®ä¾‹")]
    end

    User["ç”¨æˆ·"] -->|HTTPS| api
    api -->|JDBC| postgres
    api -->|Redis| redis
    api -.->|é™æ€æ–‡ä»¶| h5Static
    api -.->|é™æ€æ–‡ä»¶| adminStatic
```

**å¯é€‰æ‰©å±•**ï¼ˆåç»­æŒ‰éœ€å¯ç”¨ï¼‰ï¼š
```mermaid
flowchart LR
    subgraph æ‰©å±•ç»„ä»¶
        nginx["Nginx åå‘ä»£ç†<br/>ï¼ˆå¹¶å‘ > 100 QPSï¼‰"]
        mq["RabbitMQ<br/>ï¼ˆå¼‚æ­¥ä»»åŠ¡ç§¯å‹ï¼‰"]
        pgSlave[("PostgreSQL ä»åº“<br/>ï¼ˆè¯»å†™åˆ†ç¦»ï¼‰")]
    end
```

### 5.10.2 æœåŠ¡å™¨é…ç½®

**ç”Ÿäº§ç¯å¢ƒï¼ˆå•æœºç‰ˆï¼‰**ï¼š
- CPUï¼š2æ ¸
- å†…å­˜ï¼š4GB
- ç¡¬ç›˜ï¼š50GB SSD
- å¸¦å®½ï¼š3Mbps

**ç›®å½•ç»“æ„**ï¼š

```
/data/
â”œâ”€â”€ app/                          # åº”ç”¨ç›®å½•
â”‚   â”œâ”€â”€ camp-api.jar              # åç«¯JARåŒ…
â”‚   â”œâ”€â”€ h5/                       # H5å‰ç«¯é™æ€æ–‡ä»¶
â”‚   â””â”€â”€ admin/                    # ç®¡ç†åå°é™æ€æ–‡ä»¶
â”œâ”€â”€ logs/                         # æ—¥å¿—ç›®å½•
â”œâ”€â”€ uploads/                      # ä¸Šä¼ æ–‡ä»¶ç›®å½•
â”œâ”€â”€ backups/                      # å¤‡ä»½ç›®å½•
â””â”€â”€ config/                       # é…ç½®æ–‡ä»¶ç›®å½•
```

### 5.10.3 Nginx é…ç½®

**é…ç½®è¦ç‚¹**ï¼š
- ç›‘å¬ 443 ç«¯å£ï¼Œå¯ç”¨ SSL/HTTP2
- é…ç½® SSL è¯ä¹¦è·¯å¾„
- å¯ç”¨é™æµï¼š`limit_req_zone` æ¯ IP 10r/s
- é™æ€èµ„æºï¼š`/h5` å’Œ `/admin` åˆ†åˆ«æŒ‡å‘å‰ç«¯ç›®å½•ï¼Œå¯ç”¨ `try_files`
- API ä»£ç†ï¼š`/api` åå‘ä»£ç†åˆ° 8080 ç«¯å£ï¼Œè®¾ç½® `X-Real-IP` å¤´

### 5.10.4 SystemD æœåŠ¡é…ç½®

**é…ç½®è¦ç‚¹**ï¼ˆæ–‡ä»¶è·¯å¾„ï¼š`/etc/systemd/system/camp-api.service`ï¼‰ï¼š
- æœåŠ¡ç±»å‹ï¼š`simple`ï¼Œè¿è¡Œç”¨æˆ·ï¼š`camp`
- å·¥ä½œç›®å½•ï¼š`/data/app`
- JVM å‚æ•°ï¼š`-Xms2g -Xmx4g -Dspring.profiles.active=prod`
- è‡ªåŠ¨é‡å¯ï¼š`Restart=always`ï¼Œé—´éš” 10 ç§’

**å¯åŠ¨å‘½ä»¤**ï¼š`systemctl daemon-reload && systemctl enable camp-api && systemctl start camp-api`

---

# å…­ã€é£é™©ä¸åº”å¯¹

## 6.1 æŠ€æœ¯é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | åº”å¯¹æªæ–½ |
|------|------|------|----------|
| çŸ¥è¯†æ˜Ÿçƒ API å˜æ›´ | ä¸­ | é«˜ | å°è£… Manager å±‚éš”ç¦»å˜åŒ–ï¼Œç›‘æ§ API å“åº” |
| çŸ¥è¯†æ˜Ÿçƒ Cookie è¿‡æœŸ | é«˜ | é«˜ | ç›‘æ§ 401/403 å“åº”ï¼Œè‡ªåŠ¨å‘Šè­¦é€šçŸ¥æ›´æ–° |
| å¾®ä¿¡æ”¯ä»˜å›è°ƒä¸¢å¤± | ä½ | é«˜ | å¹‚ç­‰å¤„ç† + å®šæ—¶æŸ¥è¯¢è¡¥å¿ |
| èº«ä»½åŒ¹é…å‡†ç¡®ç‡ä¸è¶³ | ä¸­ | ä¸­ | äººå·¥å®¡æ ¸å…œåº•ï¼ŒæŒç»­ä¼˜åŒ–ç®—æ³• |
| æ•°æ®åº“æ€§èƒ½ç“¶é¢ˆ | ä½ | ä¸­ | åˆç†ç´¢å¼• + è¯»å†™åˆ†ç¦» + ç¼“å­˜ |

## 6.2 ä¸šåŠ¡é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | åº”å¯¹æªæ–½ |
|------|------|------|----------|
| é€€æ¬¾é‡‘é¢é”™è¯¯ | ä½ | é«˜ | äººå·¥å®¡æ ¸æµç¨‹ï¼Œé€€æ¬¾å‰äºŒæ¬¡ç¡®è®¤ |
| ç”¨æˆ·ä¿¡æ¯æ³„éœ² | ä½ | é«˜ | åŠ å¯†å­˜å‚¨ï¼Œæœ€å°æƒé™åŸåˆ™ |
| å¹¶å‘æŠ¥åå†²çª | ä¸­ | ä¸­ | æ•°æ®åº“å”¯ä¸€çº¦æŸï¼Œå¹‚ç­‰è®¾è®¡ |

## 6.3 åº”æ€¥é¢„æ¡ˆ

| åœºæ™¯ | å¤„ç†æµç¨‹ |
|------|----------|
| çŸ¥è¯†æ˜Ÿçƒ API ä¸å¯ç”¨ | æš‚åœåŒæ­¥ä»»åŠ¡ â†’ å‘Šè­¦é€šçŸ¥ â†’ æ¢å¤åè¡¥å¿åŒæ­¥ |
| å¾®ä¿¡æ”¯ä»˜æ•…éšœ | å¼•å¯¼ç”¨æˆ·ç¨åé‡è¯• â†’ è®°å½•å¼‚å¸¸è®¢å• â†’ äººå·¥è·Ÿè¿› |
| é€€æ¬¾æ‰§è¡Œå¤±è´¥ | è‡ªåŠ¨é‡è¯• 3 æ¬¡ â†’ æ ‡è®°äººå·¥å¤„ç† â†’ ç®¡ç†å‘˜ä»‹å…¥ |
| æ•°æ®åº“æ•…éšœ | åˆ‡æ¢ä»åº“ â†’ ä¿®å¤ä¸»åº“ â†’ æ¢å¤åŒæ­¥ |

---

# ä¸ƒã€æµ‹è¯•æ–¹æ¡ˆ

## 7.1 æµ‹è¯•ç­–ç•¥

| æµ‹è¯•ç±»å‹ | è¦†ç›–èŒƒå›´ | å·¥å…· |
|----------|----------|------|
| å•å…ƒæµ‹è¯• | Service å±‚æ ¸å¿ƒé€»è¾‘ | JUnit 5 + Mockito |
| é›†æˆæµ‹è¯• | API æ¥å£ + æ•°æ®åº“ | Spring Boot Test |
| E2E æµ‹è¯• | å…³é”®ç”¨æˆ·æµç¨‹ | Cypress |
| æ€§èƒ½æµ‹è¯• | é«˜å¹¶å‘åœºæ™¯ | JMeter |

## 7.2 å…³é”®æµ‹è¯•ç”¨ä¾‹

| ID | åœºæ™¯ | è¾“å…¥ | é¢„æœŸè¾“å‡º | ä¼˜å…ˆçº§ |
|----|------|------|----------|--------|
| T1 | åˆ›å»ºè®­ç»ƒè¥ | å®Œæ•´è¡¨å• | åˆ›å»ºæˆåŠŸï¼Œè¿”å› ID | P0 |
| T2 | H5ä¸»è·¯å¾„æ”¯ä»˜å›è°ƒ | æœ‰æ•ˆç­¾å + wechat_user_id | bind_status=completed, bind_method=h5_bindplanet | P0 |
| T3 | é™çº§è·¯å¾„æ”¯ä»˜å›è°ƒ | æœ‰æ•ˆç­¾åï¼Œæ—  wechat_user_id | bind_status=pending, bind_deadline=7å¤©å | P0 |
| T4 | ç”¨æˆ·ç»‘å®š | æœ‰æ•ˆè®¢å•å· + æ˜Ÿçƒä¿¡æ¯ | bind_status=completed, bind_method=user_fill | P0 |
| T5 | ç»‘å®šè¶…æ—¶ | è¶…è¿‡ 7 å¤©çš„ pending è®°å½• | bind_status=expired â†’ manual_review | P0 |
| T6 | æ‰“å¡åŒæ­¥ | æœ‰æ•ˆ Cookie | åŒæ­¥æˆåŠŸï¼Œæ›´æ–°ç»Ÿè®¡ | P0 |
| T7 | äººå·¥ç»‘å®š | ç®¡ç†å‘˜é€‰æ‹©æ˜Ÿçƒä¼šå‘˜ | bind_status=completed, bind_method=manual | P0 |
| T8 | æ‰§è¡Œé€€æ¬¾ | å®¡æ ¸é€šè¿‡ | è°ƒç”¨ API æˆåŠŸ | P0 |

## 7.3 éªŒæ”¶ç”¨ä¾‹

```gherkin
Feature: æ”¯ä»˜å›è°ƒå¤„ç†ï¼ˆåŒè·¯å¾„æ–¹æ¡ˆï¼‰

  Scenario: H5ä¸»è·¯å¾„æ”¯ä»˜å›è°ƒï¼ˆOAuth ç™»å½•åæ”¯ä»˜ï¼‰
    Given ç”¨æˆ·é€šè¿‡ H5 é“¾æ¥ OAuth ç™»å½•åæ”¯ä»˜ï¼Œå›è°ƒåŒ…å« wechat_user_id
    When æ”¶åˆ°æ”¯ä»˜å›è°ƒ
    Then bind_status=completed, bind_method=h5_bindplanet

  Scenario: é™çº§è·¯å¾„æ”¯ä»˜å›è°ƒï¼ˆå›ºå®šäºŒç»´ç ï¼‰
    Given ç”¨æˆ·é€šè¿‡å›ºå®šæ”¶æ¬¾ç æ”¯ä»˜ï¼Œæ—  wechat_user_id
    When æ”¶åˆ°æ”¯ä»˜å›è°ƒ
    Then bind_status=pending, bind_deadline=7å¤©å

  Scenario: ç»‘å®šè¶…æ—¶è½¬äººå·¥å®¡æ ¸
    Given æ”¯ä»˜è®°å½• bind_status=pending ä¸”è¶…è¿‡ 7 å¤©
    When å®šæ—¶ä»»åŠ¡æ£€æŸ¥ç»‘å®šè¶…æ—¶
    Then bind_status=manual_reviewï¼Œé€šçŸ¥ç®¡ç†å‘˜å¤„ç†
```

## 7.4 è¦†ç›–ç‡ç›®æ ‡

```
è¡Œè¦†ç›–ç‡ (Lines): > 80%
åˆ†æ”¯è¦†ç›–ç‡ (Branches): > 50%
å‡½æ•°è¦†ç›–ç‡ (Functions): > 80%
```

---

# å…«ã€æŒ‡æ ‡ç›‘æ§

## 8.1 ä¸šåŠ¡æŒ‡æ ‡

| æŒ‡æ ‡ | è®¡ç®—æ–¹å¼ | å‘Šè­¦é˜ˆå€¼ |
|------|----------|----------|
| æ—¥æŠ¥åäººæ•° | COUNT(æ–°å¢ä¼šå‘˜) | - |
| æ”¯ä»˜æˆåŠŸç‡ | æˆåŠŸæ”¯ä»˜ / æ€»æ”¯ä»˜è¯·æ±‚ | < 95% |
| ç»‘å®šå®Œæˆç‡ | completed / (completed + pending + expired) | < 90% |
| é€€æ¬¾æˆåŠŸç‡ | æˆåŠŸé€€æ¬¾ / æ€»é€€æ¬¾è¯·æ±‚ | < 99% |
| å¹³å‡æ‰“å¡å®Œæˆç‡ | AVG(checkin_rate) | - |

## 8.2 æŠ€æœ¯æŒ‡æ ‡

| æŒ‡æ ‡ | å‘Šè­¦é˜ˆå€¼ | ç›‘æ§æ–¹å¼ |
|------|----------|----------|
| API å“åº”æ—¶é—´ P99 | > 2s | Micrometer |
| API é”™è¯¯ç‡ | > 1% | Prometheus |
| æ•°æ®åº“è¿æ¥æ•° | > 80% | PgBouncer |
| Redis å†…å­˜ä½¿ç”¨ | > 80% | Redis Info |
| JVM å †å†…å­˜ | > 85% | Actuator |

## 8.3 å‘Šè­¦é…ç½®

| å‘Šè­¦åç§° | è§¦å‘æ¡ä»¶ | çº§åˆ« | é€šçŸ¥æ¸ é“ |
|----------|----------|------|----------|
| æ¥å£é”™è¯¯ç‡ | > 1% æŒç»­ 5min | P1 | ç”µè¯+ä¼å¾® |
| å“åº”è¶…æ—¶ | P99 > 2s æŒç»­ 5min | P2 | ä¼å¾® |
| æ‰“å¡åŒæ­¥å¤±è´¥ | è¿ç»­å¤±è´¥ 3 æ¬¡ | P1 | ç”µè¯+ä¼å¾® |
| é€€æ¬¾å¤±è´¥ | ä»»æ„å¤±è´¥ | P1 | ä¼å¾® |

## 8.4 æ—¥å¿—è§„èŒƒ

| çº§åˆ« | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|------|----------|------|
| ERROR | å½±å“åŠŸèƒ½çš„é”™è¯¯ | é€€æ¬¾ API è°ƒç”¨å¤±è´¥ |
| WARN | æ½œåœ¨é—®é¢˜ | é‡è¯•æˆåŠŸã€é™çº§å¤„ç† |
| INFO | å…³é”®ä¸šåŠ¡èŠ‚ç‚¹ | é€€æ¬¾æˆåŠŸã€çŠ¶æ€å˜æ›´ |
| DEBUG | å¼€å‘è°ƒè¯• | è¯·æ±‚å‚æ•°ã€å“åº”è¯¦æƒ… |

**æ—¥å¿—æ ¼å¼**ï¼š
```json
{
  "timestamp": "ISO8601",
  "level": "INFO",
  "trace_id": "é“¾è·¯ID",
  "action": "refund_success",
  "member_id": 123,
  "amount": 99.00
}
```

---

# ä¹ã€ä¸Šçº¿æ–¹æ¡ˆ

## 9.1 ä¸Šçº¿å‰æ£€æŸ¥

- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] ä»£ç  Review å®Œæˆ
- [ ] æ•°æ®åº“å˜æ›´è„šæœ¬å‡†å¤‡
- [ ] é…ç½®é¡¹ç¡®è®¤
- [ ] ç›‘æ§å‘Šè­¦é…ç½®
- [ ] å›æ»šè„šæœ¬å‡†å¤‡

## 9.2 ç°åº¦ç­–ç•¥

| é˜¶æ®µ | æµé‡æ¯”ä¾‹ | è§‚å¯Ÿæ—¶é—´ | é€šè¿‡æ ‡å‡† |
|------|----------|----------|----------|
| é˜¶æ®µ1 | 1% | 30min | é”™è¯¯ç‡ < 0.1% |
| é˜¶æ®µ2 | 10% | 1h | åŒä¸Š |
| é˜¶æ®µ3 | 50% | 2h | åŒä¸Š |
| å…¨é‡ | 100% | - | åŒä¸Š |

## 9.3 å›æ»šæ–¹æ¡ˆ

**è§¦å‘æ¡ä»¶**ï¼š
- é”™è¯¯ç‡ > 1%
- é€€æ¬¾æˆåŠŸç‡ < 95%
- æ ¸å¿ƒæ¥å£ P99 > 2s

**å›æ»šæ­¥éª¤**ï¼š
1. åˆ‡æ¢æµé‡åˆ°æ—§ç‰ˆæœ¬
2. éªŒè¯åŠŸèƒ½æ¢å¤
3. åˆ†æé—®é¢˜åŸå› 

## 9.4 ä¸Šçº¿æ—¶é—´çª—å£

- **æ¨èæ—¶é—´**ï¼šå·¥ä½œæ—¥ 10:00-12:00 æˆ– 14:00-16:00
- **é¿å¼€æ—¶é—´**ï¼šå‘¨æœ«ã€èŠ‚å‡æ—¥ã€è®­ç»ƒè¥ç»“ç®—æ—¥

---

# åã€å‚è€ƒæ–‡çŒ®

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| [PRD](../PRD.md) | äº§å“éœ€æ±‚æ–‡æ¡£ |
| [çŸ¥è¯†æ˜Ÿçƒ API æ–‡æ¡£](https://zsxq.com/api-docs) | æ‰“å¡æ•°æ®æ¥å£ |
| [å¾®ä¿¡æ”¯ä»˜æ–‡æ¡£](https://pay.weixin.qq.com) | æ”¯ä»˜é€€æ¬¾æ¥å£ |
| [Spring Boot å®˜æ–¹æ–‡æ¡£](https://spring.io/projects/spring-boot) | æ¡†æ¶å‚è€ƒ |
| [PostgreSQL å®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/) | æ•°æ®åº“å‚è€ƒ |

---

# é™„å½•ï¼šAI åä½œå¢å¼º

## A.1 æ ¸å¿ƒæœ¯è¯­è¡¨

> è¯¦ç»†æœ¯è¯­å®šä¹‰è§ [ç¬¬ä¸€ç«  åè¯è§£é‡Š](#ä¸€åè¯è§£é‡Š)

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| å¾®ä¿¡æ”¯ä»˜ | ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜å•†æˆ·å·æ¥å…¥çš„ C ç«¯æ”¯ä»˜èƒ½åŠ›ï¼ˆéä¼ä¸šå¾®ä¿¡å†…éƒ¨æ”¯ä»˜ï¼‰ |
| ä¼ä¸šå¾®ä¿¡ | ä»…ç”¨äºæ¶ˆæ¯é€šçŸ¥æ¨é€ï¼Œä¸æ¶‰åŠæ”¯ä»˜åŠŸèƒ½ |
| bind_status | æ”¯ä»˜æ˜ å°„ç»‘å®šçŠ¶æ€ï¼špending/completed/expired/manual_review/closed |
| bind_method | ç»‘å®šæ–¹å¼ï¼šh5_bindplanet/user_fill/manual |
| access_token | H5 è®¿é—®ç¥¨æ®ï¼Œæ ¼å¼ `tk_` + UUID |

---

## A.2 AI æ‰§è¡Œä¸Šä¸‹æ–‡

### é¡¹ç›®å…¥å£ä¸å‚è€ƒæ–‡ä»¶

| ç±»å‹ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| é¡¹ç›®å…¥å£ | `src/main/java/.../CampApplication.java` | Spring Boot å¯åŠ¨ç±» |
| é…ç½®æ–‡ä»¶ | `src/main/resources/application.yml` | ä¸»é…ç½® |
| Controller ç¤ºä¾‹ | `src/.../controller/CampController.java` | æ¥å£é£æ ¼å‚è€ƒ |
| Service ç¤ºä¾‹ | `src/.../service/impl/CampServiceImpl.java` | ä¸šåŠ¡é€»è¾‘å‚è€ƒ |
| Mapper ç¤ºä¾‹ | `src/.../mapper/CampMapper.java` | æ•°æ®è®¿é—®å‚è€ƒ |
| æµ‹è¯•ç¤ºä¾‹ | `src/test/.../CampServiceTest.java` | æµ‹è¯•é£æ ¼å‚è€ƒ |

### ä»£ç çº¦æŸ

**å¿…é¡»éµå®ˆ**ï¼š
- [x] Controller åªåšå‚æ•°æ ¡éªŒå’Œå“åº”å°è£…ï¼Œä¸šåŠ¡é€»è¾‘æ”¾ Service
- [x] ä½¿ç”¨ç»Ÿä¸€å“åº”æ ¼å¼ `Result<T>`
- [x] å¼‚å¸¸ä½¿ç”¨ `BusinessException`ï¼Œç”±å…¨å±€å¤„ç†å™¨æ•è·
- [x] æ•æ„Ÿé…ç½®ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œä¸ç¡¬ç¼–ç 
- [x] æ–°å¢æ¥å£å¿…é¡»æœ‰å•å…ƒæµ‹è¯•

**ç¦æ­¢äº‹é¡¹**ï¼š
- âŒ ä¸è¦åœ¨ Controller å†™ä¸šåŠ¡é€»è¾‘
- âŒ ä¸è¦ä½¿ç”¨ `System.out.println`ï¼Œç”¨ Slf4j Logger
- âŒ ä¸è¦ç¡¬ç¼–ç é…ç½®å€¼
- âŒ ä¸è¦å¿½ç•¥å¼‚å¸¸
- âŒ ä¸è¦å¼•å…¥æœªç»è¯„å®¡çš„ä¾èµ–
- âŒ ä¸è¦æäº¤æ•æ„Ÿä¿¡æ¯åˆ°ä»£ç åº“

### éªŒè¯å‘½ä»¤

#### åç«¯éªŒè¯å‘½ä»¤ï¼ˆbackend/ï¼‰

```bash
cd backend

# ç¼–è¯‘
./gradlew compileJava

# å•å…ƒæµ‹è¯•
./gradlew test

# é›†æˆæµ‹è¯•
./gradlew integrationTest

# ä»£ç é£æ ¼æ£€æŸ¥
./gradlew spotlessCheck

# å®Œæ•´æ£€æŸ¥ï¼ˆç¼–è¯‘+æµ‹è¯•+é£æ ¼ï¼‰
./gradlew check

# å¯åŠ¨æœåŠ¡
./gradlew bootRun

# æ„å»º JAR åŒ…
./gradlew bootJar
```

#### å‰ç«¯éªŒè¯å‘½ä»¤

**H5 ä¼šå‘˜ç«¯ï¼ˆfrontend/h5-member/ï¼‰**ï¼š

```bash
cd frontend/h5-member

# å®‰è£…ä¾èµ–
npm install

# å¼€å‘æœåŠ¡å™¨
npm run dev              # é»˜è®¤ http://localhost:5173

# ç±»å‹æ£€æŸ¥
npm run type-check

# ä»£ç æ£€æŸ¥
npm run lint

# ä»£ç æ ¼å¼åŒ–
npm run format

# å•å…ƒæµ‹è¯•
npm run test:unit

# E2E æµ‹è¯•
npm run test:e2e

# å®Œæ•´æ£€æŸ¥ï¼ˆç±»å‹+æ£€æŸ¥+æµ‹è¯•ï¼‰
npm run lint && npm run type-check && npm run test:unit

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# é¢„è§ˆæ„å»ºç»“æœ
npm run preview
```

**Web ç®¡ç†åå°ï¼ˆfrontend/admin-web/ï¼‰**ï¼š

```bash
cd frontend/admin-web

# å®‰è£…ä¾èµ–
npm install

# å¼€å‘æœåŠ¡å™¨
npm run dev              # é»˜è®¤ http://localhost:5174

# ç±»å‹æ£€æŸ¥
npm run type-check

# ä»£ç æ£€æŸ¥
npm run lint

# ä»£ç æ ¼å¼åŒ–
npm run format

# å•å…ƒæµ‹è¯•
npm run test:unit

# E2E æµ‹è¯•
npm run test:e2e

# å®Œæ•´æ£€æŸ¥ï¼ˆç±»å‹+æ£€æŸ¥+æµ‹è¯•ï¼‰
npm run lint && npm run type-check && npm run test:unit

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# é¢„è§ˆæ„å»ºç»“æœ
npm run preview
```

#### å®Œæ•´éªŒæ”¶å‘½ä»¤ï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰

```bash
# åç«¯éªŒæ”¶
cd backend && ./gradlew check && cd ..

# å‰ç«¯ H5 éªŒæ”¶
cd frontend/h5-member && npm run lint && npm run type-check && npm run test:unit && npm run build && cd ../..

# å‰ç«¯ç®¡ç†åå°éªŒæ”¶
cd frontend/admin-web && npm run lint && npm run type-check && npm run test:unit && npm run build && cd ../..

# æˆ–è€…ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•çš„è„šæœ¬ï¼ˆæ¨èï¼‰
./scripts/verify-all.sh
```

**verify-all.sh è„šæœ¬ç¤ºä¾‹**ï¼š

```bash
#!/bin/bash
set -e

echo "========== åç«¯éªŒæ”¶ =========="
cd backend
./gradlew check
cd ..

echo "========== H5 ä¼šå‘˜ç«¯éªŒæ”¶ =========="
cd frontend/h5-member
npm run lint
npm run type-check
npm run test:unit
npm run build
cd ../..

echo "========== Web ç®¡ç†åå°éªŒæ”¶ =========="
cd frontend/admin-web
npm run lint
npm run type-check
npm run test:unit
npm run build
cd ../..

echo "========== å…¨éƒ¨éªŒæ”¶é€šè¿‡ =========="
```

### ç¯å¢ƒå˜é‡

```bash
# æ•°æ®åº“
DATABASE_URL=jdbc:postgresql://localhost:5432/camp_db
DATABASE_USERNAME=camp_user
DATABASE_PASSWORD=***

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379

# çŸ¥è¯†æ˜Ÿçƒ
ZSXQ_COOKIE=***

# ä¼ä¸šå¾®ä¿¡
WECHAT_CORP_ID=***
WECHAT_APP_SECRET=***
WECHAT_PAY_MCH_ID=***
WECHAT_PAY_KEY=***

# å¾®ä¿¡å…¬ä¼—å· OAuth
# é…ç½®è¯¦è§ï¼šOAuthå®‰å…¨æŒ‡å—
WECHAT_MP_APPID=***
WECHAT_MP_SECRET=***
WECHAT_MP_OAUTH_CALLBACK_URL=https://api.example.com/api/auth/callback/wechat-mp
```

## A.3 åˆ†é˜¶æ®µå¼€å‘è®¡åˆ’

> è¯¦ç»†çš„åˆ†é˜¶æ®µå¼€å‘è®¡åˆ’ï¼ˆStage 0-6ï¼‰ã€ä»»åŠ¡åˆ†è§£ã€éªŒè¯å‘½ä»¤è¯·å‚è§ï¼š
>
> ğŸ“„ **[AIè¾…åŠ©æ•æ·å¼€å‘è®¡åˆ’.md](../guides/AIè¾…åŠ©æ•æ·å¼€å‘è®¡åˆ’.md)**

---

**æ–‡æ¡£ç»“æŸ**
