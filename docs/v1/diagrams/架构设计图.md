# 架构设计图

本文档使用 C4 模型展示知识星球训练营自动押金退款系统的架构设计。

---

## 一、C4 模型概述

C4 模型是一种分层的软件架构可视化方法，包含四个层次：

| 层次 | 英文 | 描述 | 受众 |
|------|------|------|------|
| Level 1 | System Context | 系统上下文 | 所有人 |
| Level 2 | Container | 容器图 | 技术人员 |
| Level 3 | Component | 组件图 | 开发人员 |
| Level 4 | Code | 代码图 | 开发人员 |

---

## 二、Level 1: 系统上下文图

### 2.1 系统上下文

```mermaid
C4Context
    title 系统上下文图 - 知识星球训练营押金退款系统

    Person(member, "会员", "知识星球会员，参与训练营打卡")
    Person(admin, "管理员", "运营人员，管理训练营和审核退款")
    Person(coach, "教练", "项目教练，查看负责项目数据")

    System(campSystem, "训练营押金退款系统", "自动化处理报名支付、打卡同步、身份匹配、退款审核")

    System_Ext(zsxq, "知识星球", "提供打卡数据API")
    System_Ext(wechatPay, "微信支付", "处理收款和退款")
    System_Ext(wechatWork, "企业微信", "消息通知推送")

    Rel(member, campSystem, "报名支付、查看进度", "H5/HTTPS")
    Rel(admin, campSystem, "管理训练营、审核退款", "Web/HTTPS")
    Rel(coach, campSystem, "查看项目数据", "Web/HTTPS")

    Rel(campSystem, zsxq, "同步打卡数据", "REST API")
    Rel(campSystem, wechatPay, "创建支付、执行退款", "REST API")
    Rel(campSystem, wechatWork, "发送通知消息", "REST API")

    UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="1")
```

### 2.2 上下文说明

| 元素 | 类型 | 描述 |
|------|------|:-----|
| 会员 | 用户 | 知识星球会员，通过 H5 页面报名参与训练营 |
| 管理员 | 用户 | 运营人员，通过 Web 后台管理训练营 |
| 教练 | 用户 | 项目教练，查看负责项目的打卡数据 |
| 训练营系统 | 核心系统 | 本系统，处理完整的训练营生命周期 |
| 知识星球 | 外部系统 | 提供会员打卡数据的来源 |
| 微信支付 | 外部系统 | 处理押金收取和退款 |
| 企业微信 | 外部系统 | 发送退款通知等消息 |

---

## 三、Level 2: 容器图

### 3.1 容器架构

```mermaid
C4Container
    title 容器图 - 系统内部结构

    Person(member, "会员")
    Person(admin, "管理员")

    System_Boundary(system, "训练营押金退款系统") {
        Container(h5Web, "H5 会员端", "Vue 3, Vant UI", "报名支付、进度查询、退款查看")
        Container(adminWeb, "Web 管理后台", "Vue 3, Element Plus", "训练营管理、退款审核、统计报表")

        Container(apiGateway, "API 网关", "Nginx", "负载均衡、SSL 终止、限流")
        Container(apiServer, "API 服务", "Spring Boot 3.2, Java 17", "核心业务逻辑、RESTful API")

        Container(scheduler, "定时任务", "Spring Scheduler", "打卡同步、退款执行、数据清理")
        Container(mqConsumer, "消息消费者", "RabbitMQ Consumer", "异步任务处理")

        ContainerDb(postgres, "PostgreSQL", "PostgreSQL 15", "业务数据存储")
        ContainerDb(redis, "Redis", "Redis 7", "缓存、会话、限流计数")
        Container(mq, "消息队列", "RabbitMQ 3.12", "异步任务队列")
    }

    System_Ext(zsxq, "知识星球 API")
    System_Ext(wechatPay, "微信支付")
    System_Ext(wechatWork, "企业微信通知")

    Rel(member, h5Web, "使用", "HTTPS")
    Rel(admin, adminWeb, "使用", "HTTPS")

    Rel(h5Web, apiGateway, "调用", "HTTPS/REST")
    Rel(adminWeb, apiGateway, "调用", "HTTPS/REST")
    Rel(apiGateway, apiServer, "转发", "HTTP")

    Rel(apiServer, postgres, "读写", "JDBC")
    Rel(apiServer, redis, "缓存", "Redis Protocol")
    Rel(apiServer, mq, "发送消息", "AMQP")

    Rel(scheduler, apiServer, "调用", "内部方法")
    Rel(mqConsumer, mq, "消费", "AMQP")
    Rel(mqConsumer, apiServer, "调用", "内部方法")

    Rel(apiServer, zsxq, "同步打卡", "HTTPS/REST")
    Rel(apiServer, wechatPay, "支付/退款", "HTTPS/REST")
    Rel(apiServer, wechatWork, "通知", "HTTPS/REST")
```

### 3.2 容器说明

| 容器 | 技术 | 职责 | 部署方式 |
|------|------|------|----------|
| H5 会员端 | Vue 3 + Vant | 会员报名、支付、进度查询 | CDN + Nginx |
| Web 管理后台 | Vue 3 + Element Plus | 训练营管理、退款审核 | CDN + Nginx |
| API 网关 | Nginx | 负载均衡、限流、SSL | 云主机 |
| API 服务 | Spring Boot 3.2 | 核心业务逻辑 | Docker/云主机 |
| 定时任务 | Spring Scheduler | 打卡同步、定时退款 | 与 API 服务同进程 |
| 消息消费者 | RabbitMQ Consumer | 异步任务处理 | 与 API 服务同进程 |
| PostgreSQL | PostgreSQL 15 | 业务数据持久化 | 云数据库 |
| Redis | Redis 7 | 缓存、会话、限流 | 云 Redis |
| 消息队列 | RabbitMQ 3.12 | 异步任务队列 | 云消息队列 |

---

## 四、Level 3: 组件图

### 4.1 API 服务组件

```mermaid
C4Component
    title API 服务组件图（含混合匹配方案）

    Container_Boundary(api, "API 服务") {
        Component(campCtrl, "CampController", "Controller", "训练营 CRUD 接口")
        Component(payCtrl, "PaymentController", "Controller", "支付相关接口")
        Component(bindCtrl, "BindController", "Controller", "支付绑定接口（新增）")
        Component(refundCtrl, "RefundController", "Controller", "退款相关接口")
        Component(statsCtrl, "StatsController", "Controller", "统计报表接口")
        Component(webhookCtrl, "WebhookController", "Controller", "回调处理接口")

        Component(campSvc, "CampService", "Service", "训练营业务逻辑")
        Component(paySvc, "PaymentService", "Service", "支付业务逻辑")
        Component(mappingSvc, "PaymentMappingService", "Service", "支付映射服务（新增）")
        Component(checkinSvc, "CheckinService", "Service", "打卡业务逻辑")
        Component(matchSvc, "MatchService", "Service", "身份匹配逻辑")
        Component(refundSvc, "RefundService", "Service", "退款业务逻辑")
        Component(statsSvc, "StatsService", "Service", "统计业务逻辑")

        Component(campMapper, "CampMapper", "DAO", "训练营数据访问")
        Component(memberMapper, "MemberMapper", "DAO", "会员数据访问")
        Component(orderMapper, "OrderMapper", "DAO", "订单数据访问")
        Component(mappingMapper, "PaymentMappingMapper", "DAO", "支付映射数据访问（新增）")
        Component(refundMapper, "RefundMapper", "DAO", "退款数据访问")

        Component(zsxqMgr, "PlanetApiManager", "Manager", "知识星球 API 封装")
        Component(wxPayMgr, "WechatPayManager", "Manager", "微信支付 API 封装")
        Component(wxMsgMgr, "WechatMsgManager", "Manager", "企业微信消息封装")
    }

    Rel(campCtrl, campSvc, "调用")
    Rel(payCtrl, paySvc, "调用")
    Rel(bindCtrl, mappingSvc, "调用")
    Rel(refundCtrl, refundSvc, "调用")
    Rel(statsCtrl, statsSvc, "调用")
    Rel(webhookCtrl, paySvc, "调用")
    Rel(webhookCtrl, mappingSvc, "调用")

    Rel(campSvc, campMapper, "调用")
    Rel(paySvc, orderMapper, "调用")
    Rel(paySvc, wxPayMgr, "调用")
    Rel(mappingSvc, mappingMapper, "调用")
    Rel(mappingSvc, matchSvc, "调用")
    Rel(checkinSvc, zsxqMgr, "调用")
    Rel(checkinSvc, memberMapper, "调用")
    Rel(matchSvc, memberMapper, "调用")
    Rel(matchSvc, orderMapper, "调用")
    Rel(matchSvc, mappingMapper, "调用")
    Rel(refundSvc, refundMapper, "调用")
    Rel(refundSvc, matchSvc, "调用")
    Rel(refundSvc, wxPayMgr, "调用")
    Rel(refundSvc, wxMsgMgr, "调用")
```

### 4.2 组件说明

#### Controller 层

| 组件 | 职责 | 主要接口 |
|------|------|----------|
| CampController | 训练营管理 | CRUD、发布、归档 |
| PaymentController | 支付处理 | 创建订单、支付状态查询 |
| BindController | 支付绑定（新增） | 用户填写绑定、查询绑定状态 |
| RefundController | 退款处理 | 生成名单、审核、执行 |
| StatsController | 统计报表 | 各维度数据统计 |
| WebhookController | 回调处理 | 支付回调、退款回调 |

#### Service 层

| 组件 | 职责 | 依赖 |
|------|------|------|
| CampService | 训练营生命周期管理 | CampMapper |
| PaymentService | 支付订单处理 | OrderMapper, WechatPayManager |
| PaymentMappingService | 支付映射管理（新增） | PaymentMappingMapper, MatchService |
| CheckinService | 打卡数据同步 | PlanetApiManager, MemberMapper |
| MatchService | 身份匹配算法 | MemberMapper, OrderMapper, PaymentMappingMapper |
| RefundService | 退款流程处理 | RefundMapper, MatchService, WechatPayManager |
| StatsService | 统计计算 | 多个 Mapper |

#### Manager 层（外部 API 封装）

| 组件 | 职责 | 外部系统 |
|------|------|----------|
| PlanetApiManager | 知识星球 API 调用 | 知识星球 |
| WechatPayManager | 微信支付 API 调用 | 微信支付 |
| WechatMsgManager | 企业微信消息发送 | 企业微信 |

### 4.3 核心模块交互（含混合匹配方案）

```mermaid
flowchart TB
    subgraph 接入层
        H5[H5 会员端]
        Admin[管理后台]
        Webhook[外部回调]
    end

    subgraph API网关
        Gateway[Nginx]
    end

    subgraph 控制层
        Controllers[Controllers]
        BindCtrl[BindController<br/>（新增）]
    end

    subgraph 业务层
        CampSvc[CampService]
        PaySvc[PaymentService]
        MappingSvc[PaymentMappingService<br/>（新增）]
        CheckinSvc[CheckinService]
        MatchSvc[MatchService]
        RefundSvc[RefundService]
    end

    subgraph 集成层
        ZsxqMgr[PlanetApiManager]
        WxPayMgr[WechatPayManager]
        WxMsgMgr[WechatMsgManager]
    end

    subgraph 数据层
        Mappers[MyBatis Mappers]
        MappingMapper[PaymentMappingMapper<br/>（新增）]
        Cache[Redis Cache]
    end

    subgraph 存储层
        DB[(PostgreSQL)]
        Redis[(Redis)]
    end

    H5 --> Gateway
    Admin --> Gateway
    Webhook --> Gateway
    Gateway --> Controllers
    Gateway --> BindCtrl

    Controllers --> CampSvc
    Controllers --> PaySvc
    Controllers --> CheckinSvc
    Controllers --> RefundSvc

    BindCtrl --> MappingSvc
    Webhook --> MappingSvc

    MappingSvc --> MatchSvc
    MappingSvc --> MappingMapper

    CheckinSvc --> MatchSvc
    RefundSvc --> MatchSvc
    MatchSvc --> MappingMapper

    CampSvc --> Mappers
    PaySvc --> Mappers
    CheckinSvc --> Mappers
    RefundSvc --> Mappers

    PaySvc --> WxPayMgr
    CheckinSvc --> ZsxqMgr
    RefundSvc --> WxPayMgr
    RefundSvc --> WxMsgMgr

    Mappers --> DB
    MappingMapper --> DB
    Cache --> Redis
```

---

## 五、Level 4: 代码级设计

### 5.1 核心领域模型

```mermaid
classDiagram
    class Camp {
        +Long id
        +String name
        +String description
        +Integer depositAmount
        +Integer requiredDays
        +Integer totalDays
        +LocalDate startDate
        +LocalDate endDate
        +CampStatus status
        +String qrCodeUrl
        +create()
        +publish()
        +start()
        +end()
        +archive()
    }

    class Member {
        +Long id
        +Long campId
        +String planetNickname
        +String planetId
        +String wechatNickname
        +Integer checkinDays
        +MemberStatus status
        +register()
        +checkin()
        +isQualified()
    }

    class Order {
        +Long id
        +Long memberId
        +Long campId
        +Integer amount
        +String transactionId
        +OrderStatus status
        +create()
        +pay()
        +refund()
    }

    class RefundRecord {
        +Long id
        +Long orderId
        +Long memberId
        +Integer amount
        +Integer confidence
        +RefundStatus status
        +String refundId
        +generate()
        +approve()
        +reject()
        +execute()
    }

    class CheckinRecord {
        +Long id
        +Long memberId
        +LocalDate checkinDate
        +String content
    }

    class PaymentMapping {
        +Long id
        +String outTradeNo
        +String transactionId
        +String planetUserId
        +String planetNickname
        +String wechatNickname
        +Integer amount
        +Long checkinId
        +BindStatus bindStatus
        +BindMethod bindMethod
        +LocalDateTime bindDeadline
        +Integer confidenceScore
        +LocalDateTime paymentTime
        +bind()
        +expire()
        +smartMatch()
    }

    Camp "1" --> "*" Member : 包含
    Member "1" --> "1" Order : 关联
    Member "1" --> "*" CheckinRecord : 打卡记录
    Order "1" --> "0..1" RefundRecord : 退款
    Order "1" --> "0..1" PaymentMapping : 支付映射
```

### 5.2 核心服务接口

```mermaid
classDiagram
    class CampService {
        <<interface>>
        +createCamp(CampDTO) Camp
        +publishCamp(Long) void
        +getCampDetail(Long) CampVO
        +listCamps(CampQuery) PageResult
        +syncCheckins(Long) SyncResult
    }

    class PaymentService {
        <<interface>>
        +createOrder(OrderDTO) Order
        +handlePaymentCallback(CallbackDTO) void
        +queryOrderStatus(String) OrderStatus
    }

    class RefundService {
        <<interface>>
        +generateRefundList(Long) RefundListVO
        +approveRefunds(List~Long~) void
        +rejectRefunds(List~Long~, String) void
        +executeRefund(Long) RefundResult
    }

    class MatchService {
        <<interface>>
        +match(MatchRequest) MatchResult
        +calculateSimilarity(String, String) Double
    }

    class PaymentMappingService {
        <<interface>>
        +createMapping(PaymentCallback) PaymentMapping
        +bindUser(BindRequest) BindResult
        +expirePendingMappings() Integer
        +getMappingByTradeNo(String) PaymentMapping
        +smartMatch(Long) MatchResult
    }

    class CampServiceImpl {
        -CampMapper campMapper
        -MemberMapper memberMapper
        -PlanetApiManager planetApi
    }

    class RefundServiceImpl {
        -RefundMapper refundMapper
        -MatchService matchService
        -WechatPayManager wechatPay
    }

    class PaymentMappingServiceImpl {
        -PaymentMappingMapper mappingMapper
        -MatchService matchService
    }

    CampService <|.. CampServiceImpl
    RefundService <|.. RefundServiceImpl
    PaymentMappingService <|.. PaymentMappingServiceImpl
    RefundServiceImpl --> MatchService
    PaymentMappingServiceImpl --> MatchService
```

---

## 六、部署架构

### 6.1 部署图

```mermaid
flowchart TB
    subgraph CDN["CDN (阿里云CDN)"]
        h5Static["H5 静态资源<br/>HTML/CSS/JS"]
        adminStatic["管理后台静态资源<br/>HTML/CSS/JS"]
    end

    subgraph Cloud["云服务器 (阿里云 ECS)"]
        subgraph NginxNode["Nginx 节点"]
            gateway["API 网关<br/>Nginx 1.24"]
        end

        subgraph App1["应用节点 1"]
            api1["API 服务<br/>Spring Boot"]
        end

        subgraph App2["应用节点 2"]
            api2["API 服务<br/>Spring Boot"]
        end
    end

    subgraph RDS["云数据库 (阿里云 RDS)"]
        pgMaster[("PostgreSQL 主库<br/>PostgreSQL 15")]
        pgSlave[("PostgreSQL 从库<br/>PostgreSQL 15")]
    end

    subgraph Cache["云缓存 (阿里云 Redis)"]
        redis[("Redis<br/>Redis 7")]
    end

    subgraph MQ["云消息队列 (阿里云)"]
        rabbit["RabbitMQ<br/>RabbitMQ 3.12"]
    end

    CDN -->|HTTPS| gateway
    gateway -->|HTTP| api1
    gateway -->|HTTP| api2
    api1 -->|JDBC| pgMaster
    api2 -->|JDBC| pgMaster
    pgMaster -.->|同步| pgSlave
    api1 -->|Redis| redis
    api2 -->|Redis| redis
    api1 -->|AMQP| rabbit
    api2 -->|AMQP| rabbit
```

### 6.2 部署说明

| 层级 | 组件 | 规格 | 数量 |
|------|------|------|------|
| CDN | 静态资源 | - | 多节点 |
| 网关 | Nginx | 2C4G | 1（可扩展） |
| 应用 | API 服务 | 4C8G | 2（可扩展） |
| 数据库 | PostgreSQL | 4C16G | 1主1从 |
| 缓存 | Redis | 2C4G | 1（集群可选） |
| 消息 | RabbitMQ | 2C4G | 1（集群可选） |

---

## 七、数据流架构

### 7.1 核心数据流

```mermaid
flowchart LR
    subgraph 数据输入
        A1[会员报名]
        A2[支付回调]
        A3[打卡同步]
    end

    subgraph 数据处理
        B1[订单服务]
        B2[支付服务]
        B3[打卡服务]
        B4[匹配服务]
        B5[退款服务]
    end

    subgraph 数据存储
        C1[(订单表)]
        C2[(会员表)]
        C3[(打卡表)]
        C4[(退款表)]
    end

    subgraph 数据输出
        D1[退款执行]
        D2[通知推送]
        D3[统计报表]
    end

    A1 --> B1 --> C1
    A1 --> B1 --> C2
    A2 --> B2 --> C1
    A3 --> B3 --> C3

    C2 --> B4
    C1 --> B4
    B4 --> C4

    C4 --> B5 --> D1
    C4 --> B5 --> D2
    C1 --> D3
    C2 --> D3
    C4 --> D3
```

### 7.2 异步数据流

```mermaid
flowchart TB
    subgraph 生产者
        P1[API 服务]
        P2[定时任务]
    end

    subgraph 消息队列
        Q1[退款任务队列]
        Q2[通知任务队列]
        Q3[同步任务队列]
    end

    subgraph 消费者
        C1[退款消费者]
        C2[通知消费者]
        C3[同步消费者]
    end

    subgraph 外部系统
        E1[微信支付]
        E2[企业微信]
        E3[知识星球]
    end

    P1 --> Q1
    P1 --> Q2
    P2 --> Q3

    Q1 --> C1 --> E1
    Q2 --> C2 --> E2
    Q3 --> C3 --> E3
```

---

## 八、安全架构

### 8.1 安全分层

```mermaid
flowchart TB
    subgraph 网络层安全
        N1[HTTPS/TLS 1.3]
        N2[WAF 防护]
        N3[DDoS 防护]
    end

    subgraph 接入层安全
        A1[JWT 认证]
        A2[RBAC 授权]
        A3[接口限流]
        A4[请求签名]
    end

    subgraph 应用层安全
        B1[参数校验]
        B2[SQL 注入防护]
        B3[XSS 防护]
        B4[敏感数据脱敏]
    end

    subgraph 数据层安全
        D1[数据加密存储]
        D2[访问控制]
        D3[审计日志]
    end

    N1 --> A1
    N2 --> A1
    N3 --> A1
    A1 --> B1
    A2 --> B1
    A3 --> B1
    A4 --> B1
    B1 --> D1
    B2 --> D1
    B3 --> D1
    B4 --> D1
```

### 8.2 认证授权流程

```mermaid
sequenceDiagram
    participant Client as 客户端
    participant Gateway as API网关
    participant Auth as 认证服务
    participant API as 业务API

    Client->>Gateway: 请求 + Token
    Gateway->>Gateway: Token 格式校验
    Gateway->>Auth: 验证 Token
    Auth->>Auth: 解析 JWT
    Auth-->>Gateway: 返回用户信息
    Gateway->>Gateway: 权限检查
    Gateway->>API: 转发请求
    API-->>Gateway: 返回结果
    Gateway-->>Client: 响应
```

---

## 相关文档

- [用户旅程图](./用户旅程图.md)
- [业务流程图](./业务流程图.md)
- [时序图](./时序图.md)
- [状态机](./状态机.md)
