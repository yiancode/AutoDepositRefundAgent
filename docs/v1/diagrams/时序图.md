# 时序图

> **文档版本**: v1.3
> **最后更新**: 2025-12-12
> **SSOT引用**: [状态枚举定义.md](../design/状态枚举定义.md) - 时序中涉及的 bind_status、bind_method 等状态值

本文档展示知识星球训练营自动押金退款系统的核心场景交互时序。

> **2025-12 说明**：H5 端训练营列表页和详情页为**公开访问**，无需登录即可浏览。用户点击"立即报名"时才检查登录状态，未登录则触发 OAuth 授权。详见 [OAuth绑定完整时序图](./OAuth绑定完整时序图.md)。

---

## 一、会员报名支付时序（混合方案）

> 支持两种支付路径：OAuth 绑定（推荐）和固定二维码报名（降级/备用）
> 两种路径均要求用户必须填写星球信息后再支付

### 1.1 固定二维码报名流程（先填后付）

> **适用场景**：作为OAuth登录的降级方案，同时预留为星球API封锁后的备用入口

```mermaid
sequenceDiagram
    autonumber
    participant M as 会员
    participant H5 as H5报名页面
    participant API as API服务
    participant DB as 数据库
    participant WX as 微信支付

    M->>H5: 扫描固定二维码<br/>进入报名页面
    H5->>API: GET /api/h5/camps/{campId}
    API->>DB: 查询训练营信息
    DB-->>API: 返回训练营详情
    API-->>H5: 返回训练营信息
    H5-->>M: 显示训练营信息+报名表单

    Note over M,H5: 用户填写星球信息<br/>（页面有"如何获取星球ID"图例引导）

    alt 用户不知道星球ID
        M->>H5: 点击"没有星球ID？"
        H5-->>M: 弹出星球分销海报
        Note over M,H5: 用户扫码加入星球<br/>获取星球ID后返回
    end

    M->>H5: 填写星球ID和昵称
    H5->>API: POST /api/h5/payments<br/>{campId, planetUserId, planetNickname}
    API->>API: 验证训练营状态
    API->>API: 检查重复报名
    API->>DB: 创建支付记录<br/>bind_status=pending<br/>bind_method=user_fill
    DB-->>API: 保存成功
    API->>WX: 调用统一下单API<br/>attach={campId,planetUserId,orderNo}
    WX-->>API: 返回prepay_id
    API-->>H5: 返回支付参数

    M->>WX: 确认支付
    WX-->>M: 支付成功

    WX->>API: POST /api/webhook/wechat/payment<br/>attach包含用户信息
    API->>API: 验证签名
    API->>DB: 更新支付记录<br/>pay_status=success<br/>bind_status=completed
    API->>DB: 创建camp_member记录
    DB-->>API: 更新成功
    API-->>WX: 返回 SUCCESS

    M->>H5: 查询支付结果
    H5->>API: GET /api/h5/orders/{orderNo}/status
    API-->>H5: 返回支付成功+群二维码
    H5-->>M: 显示群二维码
```

### 1.2 非星球用户引导流程

> **适用场景**：用户尚未加入知识星球，需先引导加入后再报名

```mermaid
sequenceDiagram
    autonumber
    participant M as 会员
    participant H5 as H5报名页面
    participant ZSXQ as 知识星球

    M->>H5: 进入报名页面
    H5-->>M: 显示报名表单

    M->>H5: 点击"没有星球ID？点此加入"
    H5-->>M: 弹出模态框<br/>显示星球分销海报

    M->>ZSXQ: 扫码进入知识星球
    ZSXQ-->>M: 付费加入星球
    Note over M,ZSXQ: 用户完成星球付费

    M->>ZSXQ: 打开知识星球App
    M->>ZSXQ: 进入个人中心
    ZSXQ-->>M: 显示星球ID

    M->>H5: 返回报名页面
    H5-->>M: 显示"如何获取星球ID"图例
    M->>H5: 填写星球ID和昵称
    Note over M,H5: 继续正常报名流程
```

### 1.3 星球信息异常处理时序（人工审核场景）

> **设计说明**：当用户填写的星球ID在打卡同步时无法匹配到有效的星球用户时，系统将记录标记为 `manual_review` 状态，由管理员人工处理。
>
> **触发场景**：
> - 打卡同步任务发现星球ID在知识星球中不存在
> - 用户填写的星球昵称与实际不符（可选校验）

```mermaid
sequenceDiagram
    autonumber
    participant Scheduler as 定时调度器
    participant API as API服务
    participant DB as 数据库
    participant Notify as 通知服务

    Scheduler->>API: 触发打卡同步任务
    API->>DB: 查询需同步的会员记录
    DB-->>API: 返回会员列表

    loop 每个会员
        API->>API: 调用知识星球API查询打卡
        alt 星球ID无效/找不到用户
            API->>DB: 更新 bind_status=manual_review<br/>标记原因="星球ID无效"
            DB-->>API: 更新成功
        else 正常同步
            API->>DB: 更新打卡记录
        end
    end

    API->>Notify: 发送人工处理提醒给管理员
    Notify-->>API: 通知发送成功
```

---

## 二、打卡数据同步时序

### 2.1 定时同步流程

```mermaid
sequenceDiagram
    autonumber
    participant Scheduler as 定时调度器
    participant API as API服务
    participant ZSXQ as 知识星球API
    participant DB as 数据库
    participant MQ as 消息队列
    participant Alert as 告警服务

    Scheduler->>API: 触发同步任务
    API->>DB: 获取进行中的训练营
    DB-->>API: 返回训练营列表

    loop 每个训练营
        API->>ZSXQ: GET /checkins/{campId}

        alt API调用成功
            ZSXQ-->>API: 返回打卡数据

            opt 需要翻页
                loop 翻页获取
                    API->>ZSXQ: GET /checkins/{campId}?page=N
                    ZSXQ-->>API: 返回下一页数据
                end
            end

            API->>API: 解析并计算统计
            API->>DB: 更新打卡记录
            DB-->>API: 更新成功
            API->>DB: 记录同步日志
        else API调用失败
            API->>API: 重试（最多3次）

            alt 重试成功
                ZSXQ-->>API: 返回数据
                API->>DB: 更新记录
            else 重试失败
                API->>MQ: 发送失败消息
                MQ->>Alert: 触发告警
                Alert->>Alert: 发送通知
            end
        end
    end

    API-->>Scheduler: 同步完成
```

### 2.2 手动触发同步

```mermaid
sequenceDiagram
    autonumber
    participant Admin as 管理员
    participant Web as 管理后台
    participant API as API服务
    participant DB as 数据库
    participant ZSXQ as 知识星球API
    participant Cache as Redis缓存

    Admin->>Web: 点击"立即同步"
    Web->>API: POST /api/admin/camps/{id}/sync
    API->>Cache: 检查同步锁
    Cache-->>API: 返回锁状态

    alt 已有同步进行中
        API-->>Web: 返回: 同步进行中，请稍后
        Web-->>Admin: 显示提示
    else 无同步锁
        API->>Cache: 设置同步锁（5分钟过期）
        API->>DB: 获取训练营信息
        DB-->>API: 返回训练营详情

        API->>ZSXQ: GET /checkins/{campId}
        ZSXQ-->>API: 返回打卡数据

        API->>API: 解析并计算统计
        API->>DB: 批量更新打卡记录
        DB-->>API: 更新成功

        API->>Cache: 释放同步锁
        API-->>Web: 返回同步结果
        Web-->>Admin: 显示同步完成<br/>更新人数、新增打卡数
    end
```

---

## 三、退款名单生成时序

### 3.1 退款名单生成流程

> **设计说明**：不使用人工审核，仅支持三种绑定方式：
> 1. **H5主路径绑定**（bind_method=h5_bindplanet）- 用户在H5页面主动填写星球信息
> 2. **用户填写绑定**（bind_method=user_fill）- 用户在固定二维码支付后填写信息
> 3. **人工绑定**（bind_method=manual）- 超时未绑定由管理员人工处理

```mermaid
sequenceDiagram
    autonumber
    participant Admin as 管理员
    participant Web as 管理后台
    participant API as API服务
    participant DB as 数据库

    Admin->>Web: 点击"生成退款名单"
    Web->>API: POST /api/admin/camps/{id}/refund-list

    API->>DB: 查询训练营状态
    DB-->>API: 返回训练营信息

    alt 训练营未结束
        API-->>Web: 返回错误：训练营进行中
        Web-->>Admin: 显示错误提示
    else 训练营已结束
        API->>DB: 获取打卡统计
        DB-->>API: 返回打卡数据
        API->>API: 筛选合格用户

        API->>DB: 获取支付记录列表
        DB-->>API: 返回支付记录

        loop 每个合格用户
            API->>DB: 查询 bind_status

            alt bind_status=completed
                Note over API: H5绑定或用户填写<br/>直接使用映射
                API->>API: 加入自动退款名单
            else bind_status=pending
                API->>DB: 检查 bind_deadline
                alt 未过期
                    API->>API: 跳过，等待用户绑定
                else 已过期
                    API->>DB: 更新为 expired → manual_review
                    API->>API: 加入人工处理列表
                end
            else bind_status=expired/manual_review
                API->>API: 加入人工处理列表
            else bind_status=closed
                API->>API: 跳过（已关闭）
            end
        end

        API->>DB: 保存退款名单
        DB-->>API: 保存成功

        API-->>Web: 返回生成结果
        Web-->>Admin: 显示退款名单统计<br/>（自动退款N笔，待人工M笔）
    end
```

---

## 四、退款执行时序

### 4.1 批量退款流程

```mermaid
sequenceDiagram
    autonumber
    participant Admin as 管理员
    participant Web as 管理后台
    participant API as API服务
    participant DB as 数据库
    participant MQ as 消息队列
    participant Refund as 退款服务
    participant WX as 微信支付
    participant Notify as 通知服务

    Admin->>Web: 批量审核通过
    Web->>API: POST /api/admin/refunds/batch-approve
    API->>DB: 更新审核状态
    DB-->>API: 更新成功
    API->>MQ: 发送退款任务
    API-->>Web: 返回处理中
    Web-->>Admin: 显示处理状态

    loop 处理队列消息
        MQ->>Refund: 消费退款任务
        Refund->>DB: 获取退款详情
        DB-->>Refund: 返回退款信息

        Refund->>WX: 调用退款API

        alt 退款成功
            WX-->>Refund: 返回成功
            Refund->>DB: 更新退款状态
            Refund->>Notify: 发送成功通知
            Notify->>Notify: 推送企业微信消息
        else 退款失败
            WX-->>Refund: 返回失败原因

            alt 可重试错误
                Refund->>MQ: 重新入队（延迟）
            else 不可重试
                Refund->>DB: 标记失败
                Refund->>Notify: 发送失败告警
            end
        end
    end
```

### 4.2 单笔退款详细流程

```mermaid
sequenceDiagram
    autonumber
    participant Refund as 退款服务
    participant DB as 数据库
    participant WX as 微信支付
    participant Notify as 通知服务
    participant Alert as 告警服务

    Refund->>DB: 获取退款记录
    DB-->>Refund: 返回退款信息

    Refund->>Refund: 构建退款请求
    Note over Refund: 商户订单号<br/>退款金额<br/>退款原因

    Refund->>WX: POST /refund

    alt HTTP 请求成功
        WX-->>Refund: 返回处理结果

        alt 业务成功
            Refund->>DB: 更新状态=退款成功
            Refund->>DB: 记录退款流水号
            DB-->>Refund: 更新成功

            Refund->>Notify: 发送会员通知
            Note over Notify: "您的押金已退回"
        else 业务失败
            Refund->>Refund: 解析错误码

            alt 余额不足
                Refund->>Alert: 发送紧急告警
                Refund->>DB: 暂停退款任务
            else 订单已退款
                Refund->>DB: 更新状态=已退款
            else 其他错误
                Refund->>DB: 记录失败原因
                Refund->>Refund: 判断是否重试
            end
        end
    else HTTP 请求失败
        Refund->>Refund: 网络重试（最多3次）

        alt 重试成功
            WX-->>Refund: 返回结果
        else 重试失败
            Refund->>DB: 标记网络失败
            Refund->>Alert: 发送告警
        end
    end
```

---

## 五、管理后台关键操作时序

### 5.1 创建训练营

```mermaid
sequenceDiagram
    autonumber
    participant Admin as 管理员
    participant Web as 管理后台
    participant API as API服务
    participant DB as 数据库
    participant QR as 二维码服务

    Admin->>Web: 填写训练营表单
    Web->>Web: 前端校验
    Admin->>Web: 点击创建

    Web->>API: POST /api/admin/camps
    API->>API: 参数校验

    alt 校验失败
        API-->>Web: 返回错误信息
        Web-->>Admin: 显示错误提示
    else 校验通过
        API->>DB: 保存训练营
        DB-->>API: 返回训练营ID

        API->>QR: 生成报名二维码
        QR-->>API: 返回二维码URL

        API->>DB: 更新二维码信息
        DB-->>API: 更新成功

        API-->>Web: 返回创建结果
        Web-->>Admin: 显示成功+二维码
    end
```

### 5.2 查看统计报表

```mermaid
sequenceDiagram
    autonumber
    participant Admin as 管理员
    participant Web as 管理后台
    participant API as API服务
    participant DB as 数据库
    participant Cache as Redis缓存

    Admin->>Web: 进入报表页面
    Web->>API: GET /api/admin/stats/overview

    API->>Cache: 查询缓存

    alt 缓存命中
        Cache-->>API: 返回缓存数据
    else 缓存未命中
        API->>DB: 查询训练营统计
        API->>DB: 查询退款统计
        API->>DB: 查询用户统计
        DB-->>API: 返回统计数据

        API->>API: 聚合计算
        API->>Cache: 写入缓存（5分钟）
    end

    API-->>Web: 返回统计数据
    Web->>Web: 渲染图表
    Web-->>Admin: 显示报表
```

---

## 六、异常场景时序

### 6.1 Token 过期处理

```mermaid
sequenceDiagram
    autonumber
    participant Scheduler as 定时调度器
    participant API as API服务
    participant ZSXQ as 知识星球API
    participant Alert as 告警服务
    participant Admin as 管理员

    Scheduler->>API: 触发同步
    API->>ZSXQ: 调用API
    ZSXQ-->>API: 返回 401/403

    API->>API: 识别 Token 过期
    API->>Alert: 发送告警
    Alert->>Admin: 推送通知（企业微信）

    Note over Admin: 管理员更新 Token

    Admin->>API: 更新环境变量
    API->>API: 重新加载配置

    API->>ZSXQ: 重试 API 调用
    ZSXQ-->>API: 返回成功
```

### 6.2 退款失败重试

```mermaid
sequenceDiagram
    autonumber
    participant MQ as 消息队列
    participant Refund as 退款服务
    participant WX as 微信支付
    participant DB as 数据库
    participant Alert as 告警服务

    MQ->>Refund: 消费退款消息
    Refund->>WX: 调用退款API
    WX-->>Refund: 返回失败（限流）

    Refund->>Refund: 判断可重试
    Refund->>MQ: 重新入队（延迟1秒）

    Note over MQ: 等待1秒

    MQ->>Refund: 第2次消费
    Refund->>WX: 调用退款API
    WX-->>Refund: 返回失败（限流）

    Refund->>MQ: 重新入队（延迟2秒）

    Note over MQ: 等待2秒

    MQ->>Refund: 第3次消费
    Refund->>WX: 调用退款API
    WX-->>Refund: 返回失败

    Refund->>DB: 标记重试失败
    Refund->>Alert: 发送告警
    Alert->>Alert: 通知管理员
```

### 6.3 绑定超时处理时序

> **适用场景**：用户通过固定二维码支付后，在 7 天内未完成星球信息绑定。系统通过定时任务自动检测并处理超时记录。

```mermaid
sequenceDiagram
    autonumber
    participant Scheduler as 定时调度器<br/>（每天 02:00）
    participant API as API服务
    participant DB as 数据库
    participant Notify as 通知服务
    participant Admin as 管理员
    participant User as 会员

    Note over Scheduler,DB: 阶段一：超时检测与状态更新

    Scheduler->>API: 触发绑定超时检查任务
    API->>DB: 查询超时未绑定记录<br/>WHERE bind_status='pending'<br/>AND bind_deadline < NOW()
    DB-->>API: 返回超时记录列表

    alt 无超时记录
        API-->>Scheduler: 任务完成（无需处理）
    else 有超时记录
        loop 每条超时记录
            API->>DB: 更新 bind_status<br/>pending → expired
            API->>DB: 记录 payment_bind_status_log<br/>event='EXPIRE'
            DB-->>API: 更新成功
        end

        Note over API,Notify: 阶段二：通知会员

        API->>Notify: 批量发送绑定提醒<br/>（企业微信模板消息）
        Notify->>User: 发送提醒：您的押金尚未绑定星球账号<br/>请尽快完成绑定以确保退款
        Notify-->>API: 发送结果

        Note over API,Admin: 阶段三：通知管理员

        API->>API: 统计超时记录<br/>按训练营分组
        API->>Notify: 发送管理员汇总通知
        Notify->>Admin: 发送企业微信消息<br/>【绑定超时提醒】<br/>训练营A：3笔超时<br/>训练营B：1笔超时

        API-->>Scheduler: 任务完成
    end
```

### 6.4 超时后用户补绑定时序

> **适用场景**：用户在绑定过期后，通过 H5 页面主动补充绑定星球信息。

```mermaid
sequenceDiagram
    autonumber
    participant User as 会员
    participant H5 as H5 补绑定页面
    participant API as API服务
    participant DB as 数据库
    participant Planet as planet_user表

    User->>H5: 点击通知链接<br/>进入补绑定页面
    H5->>API: GET /api/h5/payments/{orderNo}
    API->>DB: 查询支付记录
    DB-->>API: 返回支付详情<br/>bind_status=expired
    API-->>H5: 返回订单信息+绑定表单

    H5-->>User: 显示订单信息<br/>显示星球信息填写表单

    User->>H5: 填写星球成员编号
    H5->>API: POST /api/h5/payments/{orderNo}/bind<br/>{planetMemberNumber}

    API->>DB: 查询支付记录状态
    DB-->>API: bind_status=expired

    API->>Planet: 查询星球用户<br/>WHERE member_number=?

    alt 星球用户不存在
        Planet-->>API: 未找到
        API-->>H5: 返回错误：星球编号不存在<br/>请检查后重试
        H5-->>User: 显示错误提示
    else 星球用户存在
        Planet-->>API: 返回星球用户信息

        API->>DB: 检查该星球编号是否已被其他支付绑定

        alt 已被其他订单绑定
            DB-->>API: 存在冲突
            API-->>H5: 返回错误：该星球账号已被使用
            H5-->>User: 显示错误提示
        else 未被绑定
            API->>DB: 更新 payment_record<br/>bind_status: expired → completed<br/>bind_method: user_fill
            API->>DB: 更新 camp_member<br/>planet_member_number=?<br/>match_status=matched
            API->>DB: 记录 payment_bind_status_log<br/>event='USER_BIND_AFTER_EXPIRE'
            DB-->>API: 更新成功

            API-->>H5: 返回绑定成功
            H5-->>User: 显示绑定成功<br/>显示群二维码
        end
    end
```

### 6.5 管理员人工绑定时序

> **适用场景**：超时后用户仍未自行绑定，管理员根据支付人微信昵称等信息在后台手动完成绑定。

```mermaid
sequenceDiagram
    autonumber
    participant Admin as 管理员
    participant Web as 管理后台
    participant API as API服务
    participant DB as 数据库
    participant Planet as planet_user表

    Admin->>Web: 进入"待人工处理"列表
    Web->>API: GET /api/admin/payments?bind_status=expired,manual_review
    API->>DB: 查询待处理记录
    DB-->>API: 返回记录列表
    API-->>Web: 返回支付记录列表<br/>包含：订单号、支付人微信名、支付金额、训练营

    Web-->>Admin: 显示待处理列表

    Admin->>Web: 点击某条记录"手动绑定"
    Web->>API: GET /api/admin/payments/{id}
    API-->>Web: 返回支付详情+付款人信息
    Web-->>Admin: 显示详情弹窗<br/>显示星球用户搜索框

    Admin->>Web: 输入关键词搜索星球用户
    Web->>API: GET /api/admin/planet-users?keyword=xxx
    API->>Planet: 模糊搜索<br/>user_nickname LIKE ? OR wechat_nickname LIKE ?
    Planet-->>API: 返回匹配用户列表
    API-->>Web: 返回搜索结果
    Web-->>Admin: 显示匹配的星球用户列表

    Admin->>Web: 选择匹配的星球用户<br/>点击"确认绑定"
    Web->>API: POST /api/admin/payments/{id}/manual-bind<br/>{planetMemberNumber, remark}

    API->>DB: 验证支付记录状态
    API->>DB: 检查星球用户是否已被其他订单绑定

    alt 校验失败
        API-->>Web: 返回错误信息
        Web-->>Admin: 显示错误提示
    else 校验通过
        API->>DB: 更新 payment_record<br/>bind_status: expired/manual_review → completed<br/>bind_method: manual
        API->>DB: 更新 camp_member<br/>planet_member_number=?<br/>match_status=matched
        API->>DB: 记录 payment_bind_status_log<br/>event='MANUAL_BIND'<br/>operator_id=admin_id
        API->>DB: 记录 operation_log<br/>operation_type='MANUAL_BIND'
        DB-->>API: 更新成功

        API-->>Web: 返回绑定成功
        Web-->>Admin: 显示成功提示<br/>刷新列表
    end
```

---

## 相关文档

- [用户旅程图](./用户旅程图.md)
- [业务流程图](./业务流程图.md)
- [状态机](./状态机.md)
- [架构设计图](./架构设计图.md)

---

**变更历史**：
| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v1.4 | 2025-12-12 | 新增6.3-6.5绑定超时处理时序图（架构验证补充） |
| v1.3 | 2025-12-12 | 添加H5公开访问说明，明确列表/详情页无需登录，对齐H5原型 |
| v1.1 | 2025-12-06 | 添加 SSOT 引用、版本信息、变更历史 |
| v1.0 | 2025-11-xx | 初始版本 |
