# v0 版本前期准备清单

## 文档信息
- **版本**：v0.1
- **创建日期**：2025-10-25
- **用途**：开发前必须完成的配置准备工作

---

## 一、企业微信支付相关配置

### 1.1 必需的账号和凭证

#### ✅ 1. 企业微信账号
**用途**：作为收款和退款的主体

**申请流程**：
1. 访问：https://work.weixin.qq.com/
2. 使用企业营业执照注册企业微信
3. 完成企业实名认证（需要1-3个工作日）

**需要准备的材料**：
- 企业营业执照
- 法人身份证
- 对公账户信息（用于打款验证）

**获得的信息**：
```
✓ 企业ID（corpid）：例如 ww1234567890abcdef
✓ 企业微信管理员账号
```

---

#### ✅ 2. 微信商户号
**用途**：企业微信支付的收款账户

**申请流程**：
1. 登录企业微信管理后台
2. 进入"应用管理" → "企业支付"
3. 点击"开通企业支付"
4. 填写商户信息，提交审核（需要1-7个工作日）

**需要准备的材料**：
- 企业营业执照
- 法人身份证
- 对公账户或法人个人银行卡（用于结算）
- 经营场景说明（例如："知识星球训练营押金收取"）

**获得的信息**：
```
✓ 商户号（mch_id）：例如 1234567890
✓ 商户平台登录账号和密码
```

**重要提示**：
- 商户号审核通过后，需要签署《微信支付服务协议》
- 默认T+1结算（第二天到账），可申请D+0（当天到账，需额外费率）

---

#### ✅ 3. API密钥（APIv3密钥）
**用途**：调用微信支付API时进行签名验证

**获取步骤**：
1. 登录微信商户平台：https://pay.weixin.qq.com/
2. 进入"账户中心" → "API安全" → "APIv3密钥"
3. 点击"设置密钥"，输入32位字符串（建议使用随机生成器）
4. 保存密钥（**注意：只显示一次，务必妥善保管**）

**密钥格式**：
```
示例：a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
长度：32位字符（大小写字母+数字）
```

**⚠️ 安全建议**：
- 不要在代码中硬编码，使用环境变量或加密存储
- 定期更换密钥（建议3-6个月更换一次）
- 不同环境使用不同密钥（开发/生产）

---

#### ✅ 4. API证书（用于退款等敏感操作）
**用途**：调用退款API时进行双向SSL认证

**获取步骤**：
1. 登录微信商户平台：https://pay.weixin.qq.com/
2. 进入"账户中心" → "API安全" → "申请API证书"
3. 下载证书工具：https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay7_0.shtml
4. 运行证书工具，生成证书请求文件（CSR）
5. 上传CSR到商户平台
6. 下载证书文件（包含3个文件）

**下载的文件**：
```
apiclient_cert.p12        # 商户证书（重要！用于API调用）
apiclient_cert.pem        # 证书公钥
apiclient_key.pem         # 证书私钥
```

**使用方式**：
```java
// Spring Boot配置示例
@Configuration
public class WechatPayConfig {
    @Value("${wechat.cert.path}")
    private String certPath;

    @Bean
    public SSLContext sslContext() throws Exception {
        KeyStore keyStore = KeyStore.getInstance("PKCS12");
        FileInputStream certStream = new FileInputStream(certPath);
        keyStore.load(certStream, mchId.toCharArray());
        // ... 配置SSLContext
    }
}
```

**⚠️ 证书管理**：
- 证书有效期为5年，到期前需续期
- 证书文件务必保密，不要上传到Git仓库
- 建议放在服务器的 `/opt/certs/` 目录，权限设为 600

---

#### ✅ 5. 平台证书（用于验证微信支付回调）
**用途**：验证微信支付回调通知的签名

**获取方式**：通过API自动下载
```java
// 首次启动时下载平台证书
GET https://api.mch.weixin.qq.com/v3/certificates
```

**说明**：
- 平台证书由微信支付自动签发，定期更新
- 应用启动时自动下载并缓存
- 建议每24小时更新一次

---

### 1.2 需要配置的参数汇总表

| 参数名称 | 英文key | 示例值 | 获取位置 | 用途 |
|---------|---------|--------|---------|------|
| **企业ID** | `corp_id` | `ww1234567890abcdef` | 企业微信管理后台 | 标识企业身份 |
| **商户号** | `mch_id` | `1234567890` | 微信商户平台 | 标识商户身份 |
| **APIv3密钥** | `api_v3_key` | `a1b2c3d4e5...` | 微信商户平台-API安全 | API签名 |
| **商户证书路径** | `cert_path` | `/opt/certs/apiclient_cert.p12` | 本地文件系统 | 退款API认证 |
| **商户证书序列号** | `cert_serial_no` | `1A2B3C4D5E6F...` | 证书文件 | API请求头 |
| **应用Secret** | `agent_secret` | `abc123...` | 企业微信应用配置 | 发送通知消息 |

---

### 1.3 企业微信支付配置流程图

```
┌─────────────────────────────────────────┐
│  1. 注册企业微信账号（1-3天）              │
│     ↓ 获得：企业ID（corpid）              │
└─────────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│  2. 开通企业支付（1-7天）                 │
│     ↓ 获得：商户号（mch_id）              │
└─────────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│  3. 设置APIv3密钥（立即）                │
│     ↓ 获得：32位密钥                     │
└─────────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│  4. 申请API证书（立即）                  │
│     ↓ 下载：apiclient_cert.p12          │
└─────────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│  5. 配置收款账户（立即）                 │
│     ↓ 绑定银行卡/对公账户                │
└─────────────────────────────────────────┘
                ↓
            ✅ 可以开始开发
```

**总耗时预估**：7-10个工作日（主要等待审核）

---

## 二、知识星球相关配置

### 2.1 知识星球账号

#### ✅ 1. 星球主账号
**要求**：拥有知识星球且已付费

**需要准备**：
- 知识星球登录账号（手机号）
- 星球ID（在星球设置中查看）

---

#### ✅ 2. 知识星球Cookie（关键！）
**用途**：调用知识星球非官方API获取打卡数据

**获取步骤**：
1. 打开浏览器（推荐Chrome）
2. 访问知识星球Web版：https://wx.zsxq.com/
3. 登录你的星球账号
4. 按F12打开开发者工具
5. 切换到"Network"（网络）标签
6. 刷新页面
7. 找到任意一个API请求（例如：`/api/v2/topics`）
8. 点击该请求，查看"Headers"（请求头）
9. 找到"Cookie"字段，复制完整内容

**Cookie示例**：
```
Cookie: zsxq_access_token=abc123...; _ga=GA1.2.123456789.1234567890; ...
```

**⚠️ 重要提示**：
- Cookie会过期（通常7-30天），过期后需要重新获取
- 建议在系统中设置"Cookie过期提醒"功能
- 不要分享给他人，Cookie相当于登录凭证

**图解获取流程**：
```
1. 登录知识星球Web版
   https://wx.zsxq.com/

2. 按F12打开开发者工具
   ┌─────────────────────────┐
   │  🌐 浏览器窗口           │
   ├─────────────────────────┤
   │  📋 开发者工具（底部）   │
   │  [Elements][Console][Network] ← 点这里
   └─────────────────────────┘

3. 刷新页面，找到API请求
   Name                        Status  Type
   ├─ topics?count=20          200     xhr  ← 点击这个
   └─ groups/xxx/topics        200     xhr

4. 查看请求头（Headers）
   Request Headers:
   ├─ Cookie: zsxq_access_token=xxx; _ga=... ← 复制这整行
   ├─ User-Agent: Mozilla/5.0...
   └─ ...

5. 粘贴到系统配置中
```

---

#### ✅ 3. 训练营项目ID
**用途**：调用API时指定获取哪个训练营的打卡数据

**获取步骤**：
1. 在知识星球App中打开某个训练营（话题）
2. 分享该话题，复制链接
3. 链接格式：`https://wx.zsxq.com/dweb2/topic/xxxxx`
4. 其中 `xxxxx` 就是项目ID

**示例**：
```
话题链接：https://wx.zsxq.com/dweb2/topic/812345678901234567
项目ID：812345678901234567
```

**配置方式**：
- 每个训练营创建时，需要填写对应的"知识星球项目ID"
- 系统会根据这个ID调用API：`GET /api/v4/topics/{项目ID}/checkins`

---

### 2.2 知识星球API说明

**⚠️ 重要提醒**：知识星球**没有官方公开API**

**当前方案**：
- 使用浏览器抓包获取的非官方API
- 通过Cookie进行身份认证
- API端点可能随时变化，需要定期验证

**API端点（参考，可能变化）**：
```
获取打卡数据：
GET https://api.zsxq.com/v4/topics/{topic_id}/checkins

请求头：
Cookie: zsxq_access_token=xxx; ...

响应示例：
{
  "succeeded": true,
  "resp_data": {
    "checkins": [
      {
        "user_id": "123456",
        "name": "张三",
        "checkin_count": 8,
        "checkin_dates": ["2025-01-01", "2025-01-02", ...]
      }
    ]
  }
}
```

**风险预案**：
- 如果API变化导致无法获取数据，降级方案：手动导出Excel
- 建议在系统中保留"手动导入打卡数据"功能

---

## 三、服务器和域名配置

### 3.1 云服务器

#### ✅ 推荐配置
| 项目 | 配置 | 说明 |
|------|------|------|
| **CPU** | 2核 | 最低配置 |
| **内存** | 4GB | 最低配置 |
| **硬盘** | 40GB SSD | 系统盘 |
| **带宽** | 3Mbps | 按需选择 |
| **系统** | Ubuntu 22.04 LTS | 推荐 |

**推荐服务商**：
- 阿里云：https://www.aliyun.com/
- 腾讯云：https://cloud.tencent.com/
- 华为云：https://www.huaweicloud.com/

**费用预估**：
- 按量付费：约 ¥200-300/月
- 包年优惠：约 ¥1500-2000/年

---

### 3.2 域名配置

#### ✅ 1. 注册域名
**用途**：访问管理后台（例如：`camp-admin.yourdomain.com`）

**注册流程**：
1. 在阿里云/腾讯云购买域名
2. 完成实名认证（需要1-3个工作日）
3. 完成ICP备案（需要7-20个工作日，仅限中国大陆服务器）

**费用**：
- .com域名：约 ¥50-100/年
- .cn域名：约 ¥30-50/年

---

#### ✅ 2. SSL证书（HTTPS）
**用途**：启用HTTPS加密传输（企业微信支付回调必须使用HTTPS）

**免费方案**：Let's Encrypt（推荐）
```bash
# 安装certbot
sudo apt install certbot python3-certbot-nginx

# 申请证书
sudo certbot --nginx -d camp-admin.yourdomain.com

# 自动续期
sudo certbot renew --dry-run
```

**付费方案**：
- 阿里云SSL证书：¥0（免费版）- ¥10000/年（高级版）
- 腾讯云SSL证书：¥0（免费版）- ¥8000/年（高级版）

**⚠️ 关键要求**：
- 企业微信支付回调URL **必须使用HTTPS**
- 证书必须有效（未过期）
- 域名必须与证书匹配

---

### 3.3 数据库

#### ✅ PostgreSQL安装
**方案1：云数据库（推荐生产环境）**
- 阿里云RDS：¥200-500/月
- 腾讯云PostgreSQL：¥150-400/月
- 优点：自动备份、高可用、免运维

**方案2：自建数据库（推荐开发环境）**
```bash
# 安装PostgreSQL 15
sudo apt install postgresql-15

# 创建数据库
sudo -u postgres psql
CREATE DATABASE camp_db;
CREATE USER camp_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE camp_db TO camp_user;
```

---

## 四、开发环境准备

### 4.1 本地开发工具

#### ✅ 必装软件
| 软件 | 版本 | 下载地址 |
|------|------|---------|
| **JDK** | 17+ | https://adoptium.net/ |
| **Maven** | 3.8+ | https://maven.apache.org/ |
| **Node.js** | 18+ | https://nodejs.org/ |
| **PostgreSQL** | 15+ | https://www.postgresql.org/ |
| **IDEA** | 2023+ | https://www.jetbrains.com/idea/ |
| **VS Code** | 最新版 | https://code.visualstudio.com/ |
| **Postman** | 最新版 | https://www.postman.com/ |

#### ✅ VS Code推荐插件
- Vue Language Features (Volar)
- ESLint
- Prettier

#### ✅ IDEA推荐插件
- Lombok
- MyBatis Plus
- RestfulTool

---

### 4.2 开发配置文件模板

#### application.yml（后端配置）
```yaml
server:
  port: 8080

spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/camp_db
    username: camp_user
    password: your_password

# 企业微信支付配置
wechat:
  pay:
    corp-id: ${WECHAT_CORP_ID}           # 从环境变量读取
    mch-id: ${WECHAT_MCH_ID}
    api-v3-key: ${WECHAT_API_V3_KEY}
    cert-path: ${WECHAT_CERT_PATH}
    cert-serial-no: ${WECHAT_CERT_SERIAL_NO}
    notify-url: https://camp-admin.yourdomain.com/api/webhook/wechat/payment

# 知识星球配置
planet:
  cookie: ${PLANET_COOKIE}               # 从环境变量读取
```

#### .env（环境变量文件）
```bash
# 企业微信配置
WECHAT_CORP_ID=ww1234567890abcdef
WECHAT_MCH_ID=1234567890
WECHAT_API_V3_KEY=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
WECHAT_CERT_PATH=/opt/certs/apiclient_cert.p12
WECHAT_CERT_SERIAL_NO=1A2B3C4D5E6F7890

# 知识星球配置
PLANET_COOKIE=zsxq_access_token=xxx; _ga=xxx; ...
```

**⚠️ 安全提醒**：
- `.env` 文件必须加入 `.gitignore`，不要上传到Git仓库
- 生产环境使用云服务商的"密钥管理服务"（KMS）

---

## 五、配置检查清单

### 5.1 开发前检查表

在开始开发之前，请确认以下配置已完成：

#### 企业微信支付
- [ ] 企业微信账号注册完成（获得 corp_id）
- [ ] 企业支付开通审核通过（获得 mch_id）
- [ ] APIv3密钥已设置（32位字符串）
- [ ] API证书已下载（apiclient_cert.p12）
- [ ] 商户证书序列号已获取
- [ ] 结算银行卡已绑定

#### 知识星球
- [ ] 知识星球Cookie已获取
- [ ] 训练营项目ID已获取
- [ ] API端点已测试（可正常获取打卡数据）

#### 服务器和域名
- [ ] 云服务器已购买（2核4G）
- [ ] 域名已注册
- [ ] ICP备案已完成（中国大陆服务器必须）
- [ ] SSL证书已申请（HTTPS）
- [ ] 数据库已安装（PostgreSQL 15+）

#### 开发环境
- [ ] JDK 17已安装
- [ ] Maven已安装
- [ ] Node.js 18已安装
- [ ] PostgreSQL客户端已安装
- [ ] IDEA/VS Code已安装

---

### 5.2 配置测试

#### 测试1：企业微信支付连通性
```bash
# 使用Postman测试
POST https://api.mch.weixin.qq.com/v3/certificates
Headers:
  Authorization: WECHATPAY2-SHA256-RSA2048 ...

# 期望响应：返回平台证书列表
```

#### 测试2：知识星球API连通性
```bash
# 使用Postman测试
GET https://api.zsxq.com/v4/topics/{你的项目ID}/checkins
Headers:
  Cookie: zsxq_access_token=xxx; ...

# 期望响应：返回打卡数据
```

#### 测试3：数据库连接
```bash
psql -h localhost -U camp_user -d camp_db -c "SELECT version();"

# 期望响应：显示PostgreSQL版本号
```

---

## 六、费用预算

### 6.1 一次性费用

| 项目 | 费用 | 说明 |
|------|------|------|
| 域名注册 | ¥50-100 | 首年 |
| SSL证书 | ¥0 | Let's Encrypt免费 |
| **小计** | **¥50-100** | |

### 6.2 月度费用

| 项目 | 费用 | 说明 |
|------|------|------|
| 云服务器 | ¥200-300 | 2核4G |
| 云数据库（可选） | ¥150-400 | PostgreSQL |
| 带宽流量 | ¥20-50 | 按实际使用 |
| **小计** | **¥370-750/月** | |

### 6.3 支付手续费

| 项目 | 费率 | 说明 |
|------|------|------|
| 企业微信支付收款 | 0.6% | 每笔支付 |
| 企业微信退款 | 0% | 退款不收手续费 |

**示例计算**：
```
单期训练营：100人 × ¥99押金 = ¥9900收款
手续费：¥9900 × 0.6% = ¥59.4
实际到账：¥9900 - ¥59.4 = ¥9840.6

退款时：100人 × ¥99 = ¥9900（无手续费）
```

---

## 七、常见问题FAQ

### Q1：企业微信支付审核需要多久？
**A**：通常1-7个工作日，建议提前申请。审核标准：
- 企业资质齐全（营业执照、法人身份证）
- 经营范围符合要求
- 提供真实的业务场景说明

### Q2：知识星球Cookie过期了怎么办？
**A**：重新按照"获取Cookie"步骤操作，替换系统配置中的Cookie即可。建议：
- 在系统中添加"Cookie测试"功能，定期检测
- Cookie过期前7天发送邮件/微信提醒

### Q3：没有企业营业执照可以申请吗？
**A**：不可以。企业微信支付必须是企业主体，个人无法申请。
**替代方案**：
- 使用个人微信收款码（手动退款，v0版本可暂时使用）
- 注册个体工商户（比公司注册简单）

### Q4：服务器必须部署在中国大陆吗？
**A**：不是必须，但建议：
- **中国大陆服务器**：需要ICP备案，访问速度快
- **香港/海外服务器**：无需备案，但微信支付回调可能较慢

### Q5：开发环境可以使用测试商户号吗？
**A**：可以。微信支付提供沙箱环境：
- 申请地址：https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=23_1
- 优点：无需真实支付，可模拟各种场景
- 缺点：数据会定期清空

### Q6：SSL证书过期了怎么办?
**A**：Let's Encrypt证书有效期90天，需定期续期：
```bash
# 自动续期（推荐设置为定时任务）
sudo certbot renew

# 或手动续期
sudo certbot renew --force-renewal
```

---

## 八、应急预案

### 8.1 企业微信支付故障

**问题1：支付回调未收到**
```
原因：
- 回调URL配置错误
- 服务器防火墙拦截
- SSL证书过期

解决方案：
1. 检查回调URL是否为HTTPS
2. 检查服务器80/443端口是否开放
3. 手动调用"查询订单"API补单
```

**问题2：退款失败**
```
常见原因：
- 商户余额不足
- 订单号错误
- 退款金额超过原支付金额

解决方案：
1. 登录商户平台查看余额
2. 检查订单号是否正确
3. 手动在商户平台操作退款
```

---

### 8.2 知识星球API故障

**问题1：Cookie失效**
```
症状：API返回401 Unauthorized

解决方案：
1. 重新获取Cookie
2. 使用降级方案：手动导出打卡数据Excel
```

**问题2：API返回格式变化**
```
症状：数据解析失败

解决方案：
1. 查看API最新响应格式
2. 调整代码中的数据解析逻辑
3. 临时使用手动导入功能
```

---

## 九、配置完成后的验收测试

### 测试步骤：

#### 1. 企业微信支付测试
```
[ ] 创建测试订单
[ ] 使用微信扫码支付1分钱
[ ] 检查是否收到回调通知
[ ] 发起退款
[ ] 检查是否退款成功
```

#### 2. 知识星球API测试
```
[ ] 调用API获取打卡数据
[ ] 检查返回的数据格式是否正确
[ ] 验证用户昵称、打卡次数等字段
```

#### 3. 系统集成测试
```
[ ] 创建一个测试训练营
[ ] 同步知识星球打卡数据
[ ] 生成退款名单
[ ] 执行批量退款（小金额测试）
```

---

## 十、联系方式和技术支持

### 官方文档
- 企业微信支付API文档：https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml
- 企业微信开发文档：https://developer.work.weixin.qq.com/document/

### 技术支持
- 企业微信支付客服：登录商户平台 → 联系客服
- 知识星球客服：App内 → 设置 → 帮助与反馈

---

**✅ 完成以上配置后，即可开始v0版本的开发工作！**

**预计配置耗时**：7-10个工作日（主要等待企业微信支付审核）

---

**文档结束**
