# çŸ¥è¯†æ˜Ÿçƒè®­ç»ƒè¥é€€æ¬¾ç³»ç»Ÿ v0 - è¯¦ç»†æŠ€æœ¯æ–¹æ¡ˆ

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯
- **ç‰ˆæœ¬**: v0.1
- **åˆ›å»ºæ—¥æœŸ**: 2025-10-26
- **ç›®æ ‡**: 2å¤©æ ¸å¿ƒåŠŸèƒ½,4å¤©å®Œæ•´ä¸Šçº¿
- **éƒ¨ç½²åŸŸå**: zsxq.dc401.com

---

## ç›®å½•

- [ä¸€ã€æŠ€æœ¯æ¶æ„è®¾è®¡](#ä¸€æŠ€æœ¯æ¶æ„è®¾è®¡)
- [äºŒã€æŠ€æœ¯é€‰å‹è¯´æ˜](#äºŒæŠ€æœ¯é€‰å‹è¯´æ˜)
- [ä¸‰ã€é¡¹ç›®ç›®å½•ç»“æ„](#ä¸‰é¡¹ç›®ç›®å½•ç»“æ„)
- [å››ã€æ ¸å¿ƒä»£ç å®ç°](#å››æ ¸å¿ƒä»£ç å®ç°)
- [äº”ã€API æ¥å£è®¾è®¡](#äº”api-æ¥å£è®¾è®¡)
- [å…­ã€éƒ¨ç½²æ–¹æ¡ˆ](#å…­éƒ¨ç½²æ–¹æ¡ˆ)
- [ä¸ƒã€æµ‹è¯•æ–¹æ¡ˆ](#ä¸ƒæµ‹è¯•æ–¹æ¡ˆ)
- [å…«ã€é£é™©è¯„ä¼°ä¸åº”å¯¹æ–¹æ¡ˆ](#å…«é£é™©è¯„ä¼°ä¸åº”å¯¹æ–¹æ¡ˆ)
- [ä¹ã€å¼€å‘æ’æœŸ](#ä¹å¼€å‘æ’æœŸ)
- [åã€æ€»ç»“](#åæ€»ç»“)

---

## ä¸€ã€æŠ€æœ¯æ¶æ„è®¾è®¡

### 1.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç”¨æˆ·æµè§ˆå™¨ (4-5äººä½¿ç”¨)                       â”‚
â”‚              https://zsxq.dc401.com                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTPS (Let's Encrypt è‡ªåŠ¨è¯ä¹¦)
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Nginx 1.18+ åå‘ä»£ç†                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  /  (å‰ç«¯é™æ€æ–‡ä»¶)    â”‚  /api/*  (åç«¯APIä»£ç†)        â”‚    â”‚
â”‚  â”‚  â†’ /var/www/web      â”‚  â†’ http://localhost:3013     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                      â”‚
                â†“                      â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   å‰ç«¯é™æ€èµ„æº       â”‚  â”‚   Node.js åç«¯æœåŠ¡      â”‚
    â”‚   Vue 3.3+          â”‚  â”‚   Express.js 4.x        â”‚
    â”‚   Vite 5.x          â”‚  â”‚   Port: 3013            â”‚
    â”‚   Element Plus 2.4+ â”‚  â”‚   PM2 è¿›ç¨‹å®ˆæŠ¤          â”‚
    â”‚                     â”‚  â”‚   Winston æ—¥å¿—(3å¤©)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â†“ APIè°ƒç”¨(æºå¸¦Cookie)
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  çŸ¥è¯†æ˜Ÿçƒ API             â”‚
                            â”‚  api.zsxq.com             â”‚
                            â”‚  - è·å–è®­ç»ƒè¥åˆ—è¡¨         â”‚
                            â”‚  - è·å–æ‰“å¡æ’è¡Œæ¦œ         â”‚
                            â”‚  - æ”¯æŒè‡ªåŠ¨ç¿»é¡µ(200äºº)   â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ•°æ®æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ1: è·å–è®­ç»ƒè¥åˆ—è¡¨                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ã€å‰ç«¯ã€‘è®­ç»ƒè¥åˆ—è¡¨é¡µé¢
    â†“ GET /api/camps?scope=over
    â†“ Headers: X-API-Key: xxx
ã€åç«¯ã€‘API Key é‰´æƒä¸­é—´ä»¶ â†’ éªŒè¯é€šè¿‡
    â†“
ã€åç«¯ã€‘ZsxqService.getCamps()
    â†“ ä»ç¯å¢ƒå˜é‡åŠ¨æ€è¯»å– Cookie
    â†“ è°ƒç”¨çŸ¥è¯†æ˜Ÿçƒ API
ã€çŸ¥è¯†æ˜Ÿçƒã€‘è¿”å›è®­ç»ƒè¥åˆ—è¡¨ JSON
    â†“
ã€åç«¯ã€‘è§£ææ•°æ® â†’ è¿”å›ç»Ÿä¸€æ ¼å¼ JSON
    â†“
ã€å‰ç«¯ã€‘å±•ç¤ºè®­ç»ƒè¥åˆ—è¡¨(åç§°ã€çŠ¶æ€ã€å¤©æ•°ã€äººæ•°)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ2: ç”Ÿæˆé€€æ¬¾åå•                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ã€å‰ç«¯ã€‘ç”¨æˆ·ç‚¹å‡»"ç”Ÿæˆåå•" â†’ è¾“å…¥å®Œæˆå¤©æ•° â†’ ç¡®è®¤å¼¹çª—
    â†“ POST /api/camps/{checkin_id}/refund-list
    â†“ Body: { "required_days": 7 }
    â†“ Headers: X-API-Key: xxx
ã€åç«¯ã€‘å‚æ•°æ ¡éªŒ â†’ required_days <= è®­ç»ƒè¥æ€»å¤©æ•°
    â†“
ã€åç«¯ã€‘RefundService.generateRefundList()
    â†“ è°ƒç”¨ ZsxqService.getRankingList(checkin_id)
    â†“ è‡ªåŠ¨ç¿»é¡µé€»è¾‘:
    â†“   - index=0,1,2... å¾ªç¯è°ƒç”¨
    â†“   - æ¯æ¬¡é—´éš” 200ms(é˜²é™æµ)
    â†“   - åˆå¹¶æ‰€æœ‰æ•°æ®(æ”¯æŒ200äºº)
ã€çŸ¥è¯†æ˜Ÿçƒã€‘è¿”å›æ‰“å¡æ’è¡Œæ¦œ JSON
    â†“
ã€åç«¯ã€‘è®¡ç®—åˆæ ¼åå•:
    â†“   - éå†æ¯ä¸ªç”¨æˆ·
    â†“   - is_qualified = checkined_days >= required_days
    â†“   - ç»Ÿè®¡åˆæ ¼äººæ•°ã€åˆæ ¼ç‡
    â†“
ã€åç«¯ã€‘è¿”å› JSON:
    â†“   - camp_info(è®­ç»ƒè¥ä¿¡æ¯)
    â†“   - refund_list(è¯¦ç»†åå•)
    â†“   - statistics(ç»Ÿè®¡æ•°æ®)
    â†“
ã€å‰ç«¯ã€‘å±•ç¤º:
    â†“   - æ•°æ®æ€»è§ˆ(å¡ç‰‡)
    â†“   - åˆæ ¼äººå‘˜åå•(æ–‡æœ¬+ä¸€é”®å¤åˆ¶)
    â†“   - è¯¦ç»†åå•è¡¨æ ¼
    â†“   - å¯¼å‡º Excel(å‰ç«¯ç”Ÿæˆ)
    â†“   - ä¸‹è½½å›¾ç‰‡(å‰ç«¯ç”Ÿæˆ)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ3: Cookie å¤±æ•ˆå¤„ç†                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ã€çŸ¥è¯†æ˜Ÿçƒã€‘è¿”å› 401 Unauthorized
    â†“
ã€åç«¯ã€‘æ•è·é”™è¯¯ â†’ è¿”å› 403 + æç¤º"Cookieå·²è¿‡æœŸ"
    â†“
ã€å‰ç«¯ã€‘Axios æ‹¦æˆªå™¨æ•è· 403
    â†“ å¼¹çª—æç¤º:"çŸ¥è¯†æ˜Ÿçƒ Cookie å·²è¿‡æœŸ,è¯·ç‚¹å‡»å³ä¸Šè§’æ›´æ–°"
    â†“
ã€ç®¡ç†å‘˜ã€‘ç‚¹å‡»"æ›´æ–°Cookie" â†’ å¼¹çª—è¡¨å•
    â†“ ä»çŸ¥è¯†æ˜ŸçƒæŠ“åŒ…è·å–æ–°Cookie
    â†“ å¡«å…¥: x_timestamp, authorization, x_signature
    â†“ POST /api/config/zsxq-cookie
ã€åç«¯ã€‘éªŒè¯ Cookie â†’ æ›´æ–° .env æ–‡ä»¶ â†’ é‡æ–°åŠ è½½ç¯å¢ƒå˜é‡
    â†“
ã€å‰ç«¯ã€‘æç¤º"æ›´æ–°æˆåŠŸ" â†’ é‡æ–°è¯·æ±‚æ¥å£
```

---

## äºŒã€æŠ€æœ¯é€‰å‹è¯´æ˜

### 2.1 æŠ€æœ¯æ ˆå¯¹æ¯”åˆ†æ

#### åç«¯æŠ€æœ¯é€‰å‹: Node.js vs Python

| ç»´åº¦ | Node.js + Express | Python + FastAPI | æœ€ç»ˆé€‰æ‹© |
|------|-------------------|------------------|---------|
| **å¼€å‘é€Ÿåº¦** | â­â­â­â­â­ ä¸­é—´ä»¶ä¸°å¯Œ,å¿«é€Ÿæ­å»º | â­â­â­â­ å¼‚æ­¥æ”¯æŒå¥½,ä½†ä¾èµ–é…ç½®å¤æ‚ | âœ… Node.js |
| **ä»£ç å¯ç»´æŠ¤æ€§** | â­â­â­â­ JavaScript,å‰åç«¯ç»Ÿä¸€ | â­â­â­â­ å¼ºç±»å‹,é€‚åˆæ•°æ®å¤„ç† | âœ… Node.js |
| **èµ„æºå ç”¨** | â­â­â­â­â­ å•è¿›ç¨‹çº¦50MB | â­â­â­ å•è¿›ç¨‹çº¦100MB+ | âœ… Node.js |
| **ç”Ÿæ€** | â­â­â­â­â­ npmç”Ÿæ€æœ€å¤§ | â­â­â­â­ pipç”Ÿæ€ä¸°å¯Œ | âœ… Node.js |
| **éƒ¨ç½²** | â­â­â­â­â­ `npm install` + `pm2 start` | â­â­â­ éœ€è¦è™šæ‹Ÿç¯å¢ƒ | âœ… Node.js |

**ç»“è®º**: é€‰æ‹© **Node.js + Express.js**
- **ç†ç”±1**: å¼€å‘é€Ÿåº¦æœ€å¿«,2å¤©å®Œæˆæ ¸å¿ƒåŠŸèƒ½çš„æœ€ä½³é€‰æ‹©
- **ç†ç”±2**: æ— æ•°æ®åº“åœºæ™¯,Node.js å¼‚æ­¥ I/O æ€§èƒ½ä¼˜ç§€,é€‚åˆ API ä»£ç†æœåŠ¡
- **ç†ç”±3**: å‰åç«¯éƒ½æ˜¯ JavaScript,é™ä½å›¢é˜Ÿå­¦ä¹ æˆæœ¬
- **ç†ç”±4**: æœåŠ¡å™¨ 2C4G,Node.js èµ„æºå ç”¨æ›´ä½

---

#### å‰ç«¯ UI åº“é€‰å‹: Element Plus vs Ant Design Vue vs Naive UI

| ç»´åº¦ | Element Plus | Ant Design Vue | Naive UI | æœ€ç»ˆé€‰æ‹© |
|------|-------------|----------------|----------|---------|
| **æ–‡æ¡£å®Œå–„åº¦** | â­â­â­â­â­ ä¸­æ–‡æ–‡æ¡£æœ€è¯¦ç»† | â­â­â­â­ æ–‡æ¡£å®Œå–„ | â­â­â­ æ–‡æ¡£è¾ƒå°‘ | âœ… Element Plus |
| **ç»„ä»¶ä¸°å¯Œåº¦** | â­â­â­â­â­ æœ€å…¨é¢ | â­â­â­â­ ä¸°å¯Œ | â­â­â­ åŸºç¡€ç»„ä»¶ | âœ… Element Plus |
| **å­¦ä¹ æˆæœ¬** | â­â­â­â­â­ æœ€ä½,ç¤ºä¾‹ä¸°å¯Œ | â­â­â­ API åå¤æ‚ | â­â­â­â­ ç®€æ´ | âœ… Element Plus |
| **å¼€å‘é€Ÿåº¦** | â­â­â­â­â­ å¤åˆ¶ç²˜è´´å³å¯ | â­â­â­â­ éœ€é…ç½® | â­â­â­ éœ€è‡ªå®šä¹‰ | âœ… Element Plus |
| **ç¤¾åŒºæ´»è·ƒåº¦** | â­â­â­â­â­ Vue 3 ç”Ÿæ€æœ€å¤§ | â­â­â­â­ é˜¿é‡Œæ”¯æŒ | â­â­â­ è¾ƒå° | âœ… Element Plus |
| **é€‚ç”¨åœºæ™¯** | ç®¡ç†åå°é¦–é€‰ | ä¼ä¸šçº§åº”ç”¨ | ç°ä»£åŒ–UI | âœ… Element Plus |

**ç»“è®º**: é€‰æ‹© **Element Plus 2.4+**
- **ç†ç”±1**: æ¡Œé¢ç«¯ç®¡ç†åå°é¦–é€‰,ç»„ä»¶æœ€å®Œå–„(Tableã€Formã€Loadingã€Messageç­‰)
- **ç†ç”±2**: ä¸­æ–‡æ–‡æ¡£æœ€è¯¦ç»†,ç¤ºä¾‹ä»£ç æœ€ä¸°å¯Œ,2å¤©å¿«é€Ÿä¸Šçº¿çš„æœ€ä½³é€‰æ‹©
- **ç†ç”±3**: Vue 3 ç”Ÿæ€ä¸­ä½¿ç”¨æœ€å¹¿æ³›,ç¤¾åŒºé—®é¢˜è§£å†³æ–¹æ¡ˆæœ€å¤š
- **ç†ç”±4**: å¼€å‘æ•ˆç‡æœ€é«˜,å¤åˆ¶å®˜æ–¹ç¤ºä¾‹å³å¯å¿«é€Ÿå®ç°åŠŸèƒ½

---

### 2.2 å®Œæ•´æŠ€æœ¯æ ˆæ¸…å•

#### åç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” | é€‰å‹ç†ç”± |
|------|------|------|---------|
| **Node.js** | 18+ | è¿è¡Œæ—¶ç¯å¢ƒ | LTSç‰ˆæœ¬,ç¨³å®šæ€§å¥½,å¼‚æ­¥I/Oæ€§èƒ½ä¼˜ç§€ |
| **Express.js** | 4.x | Webæ¡†æ¶ | è½»é‡çº§ã€æˆç†Ÿç¨³å®šã€ä¸­é—´ä»¶ç”Ÿæ€ä¸°å¯Œã€æ–‡æ¡£å®Œå–„ |
| **Axios** | 1.x | HTTPå®¢æˆ·ç«¯ | æ”¯æŒæ‹¦æˆªå™¨ã€è¯·æ±‚/å“åº”è½¬æ¢,è°ƒç”¨çŸ¥è¯†æ˜ŸçƒAPIçš„æœ€ä½³é€‰æ‹© |
| **dotenv** | 16.x | ç¯å¢ƒå˜é‡ç®¡ç† | å®‰å…¨å­˜å‚¨Cookieç­‰æ•æ„Ÿä¿¡æ¯,æ”¯æŒåŠ¨æ€æ›´æ–° |
| **Winston** | 3.x | æ—¥å¿—åº“ | åŠŸèƒ½å¼ºå¤§,æ”¯æŒæ—¥å¿—åˆ†çº§ã€æ–‡ä»¶åˆ‡å‰²ã€ä¿ç•™3å¤© |
| **PM2** | 5.x | è¿›ç¨‹ç®¡ç† | è¿›ç¨‹å®ˆæŠ¤ã€è‡ªåŠ¨é‡å¯ã€è´Ÿè½½å‡è¡¡ã€æ—¥å¿—ç®¡ç† |

#### å‰ç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” | é€‰å‹ç†ç”± |
|------|------|------|---------|
| **Vue 3** | 3.3+ | å‰ç«¯æ¡†æ¶ | Composition APIæ˜“äºç»„ç»‡ä»£ç ,æ€§èƒ½ä¼˜ç§€,å“åº”å¼è®¾è®¡ |
| **Vite** | 5.x | æ„å»ºå·¥å…· | æå¿«çš„å¼€å‘æœåŠ¡å™¨å¯åŠ¨é€Ÿåº¦,HMRçƒ­æ›´æ–°,ç”Ÿäº§æ„å»ºä¼˜åŒ– |
| **Element Plus** | 2.4+ | UIç»„ä»¶åº“ | æ¡Œé¢ç«¯ç®¡ç†åå°é¦–é€‰,ç»„ä»¶æœ€å®Œå–„,ä¸­æ–‡æ–‡æ¡£è¯¦ç»† |
| **Vue Router** | 4.x | è·¯ç”±ç®¡ç† | å®˜æ–¹è·¯ç”±,æ”¯æŒè·¯ç”±å®ˆå« |
| **Axios** | 1.x | HTTPå®¢æˆ·ç«¯ | ç»Ÿä¸€çš„HTTPè¯·æ±‚å°è£…,æ”¯æŒæ‹¦æˆªå™¨(API Keyã€é”™è¯¯å¤„ç†) |
| **xlsx.js** | 0.18+ | Excelå¯¼å‡º | å‰ç«¯ç”ŸæˆExcelæ–‡ä»¶,æ”¯æŒæ ·å¼ã€åˆå¹¶å•å…ƒæ ¼ |
| **html2canvas** | 1.4+ | å›¾ç‰‡ç”Ÿæˆ | å°†HTMLå…ƒç´ è½¬ä¸ºCanvaså›¾ç‰‡,ç”ŸæˆPNGä¸‹è½½ |

#### éƒ¨ç½²ä¸è¿ç»´

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” | é€‰å‹ç†ç”± |
|------|------|------|---------|
| **Nginx** | 1.18+ | åå‘ä»£ç† | é™æ€æ–‡ä»¶æœåŠ¡ã€APIä»£ç†ã€HTTPSç»ˆç»“ |
| **Certbot** | 1.x | HTTPSè¯ä¹¦ | Let's Encrypt è‡ªåŠ¨ç”³è¯·å’Œç»­æœŸ(å…è´¹ã€è‡ªåŠ¨åŒ–) |
| **PM2** | 5.x | è¿›ç¨‹å®ˆæŠ¤ | Node.jsè¿›ç¨‹å®ˆæŠ¤ã€è‡ªåŠ¨é‡å¯ã€æ—¥å¿—ç®¡ç†ã€å¼€æœºè‡ªå¯ |

---

## ä¸‰ã€é¡¹ç›®ç›®å½•ç»“æ„

### 3.1 åç«¯ç›®å½•ç»“æ„

```
zsxq-refund-api/                     # åç«¯é¡¹ç›®æ ¹ç›®å½•
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app.js                       # Express åº”ç”¨ä¸»æ–‡ä»¶(å…¥å£)
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ zsxq.config.js           # çŸ¥è¯†æ˜Ÿçƒé…ç½®(ä».envåŠ è½½)
â”‚   â”‚   â”œâ”€â”€ logger.config.js         # Winston æ—¥å¿—é…ç½®(3å¤©ä¿ç•™)
â”‚   â”‚   â””â”€â”€ api-key.config.js        # API Key é…ç½®
â”‚   â”œâ”€â”€ middlewares/
â”‚   â”‚   â”œâ”€â”€ auth.middleware.js       # API Key é‰´æƒä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ error.middleware.js      # ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ logger.middleware.js     # è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶(è®°å½•è¯·æ±‚)
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ camps.route.js           # è·¯ç”±: è®­ç»ƒè¥ç›¸å…³æ¥å£
â”‚   â”‚   â””â”€â”€ config.route.js          # è·¯ç”±: Cookieæ›´æ–°æ¥å£
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ zsxq.service.js          # æœåŠ¡: è°ƒç”¨çŸ¥è¯†æ˜ŸçƒAPI
â”‚   â”‚   â””â”€â”€ refund.service.js        # æœåŠ¡: é€€æ¬¾åå•è®¡ç®—
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ response.util.js         # ç»Ÿä¸€å“åº”æ ¼å¼å°è£…
â”‚       â””â”€â”€ request.util.js          # HTTP è¯·æ±‚å·¥å…·
â”œâ”€â”€ logs/                            # æ—¥å¿—æ–‡ä»¶ç›®å½•(3å¤©è‡ªåŠ¨æ¸…ç†)
â”‚   â”œâ”€â”€ app.log                      # åº”ç”¨æ—¥å¿—
â”‚   â””â”€â”€ error.log                    # é”™è¯¯æ—¥å¿—
â”œâ”€â”€ .env                             # ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶(ç”Ÿäº§ç¯å¢ƒ)
â”œâ”€â”€ .env.example                     # ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶(ç‰ˆæœ¬æ§åˆ¶)
â”œâ”€â”€ package.json                     # ä¾èµ–ç®¡ç†
â”œâ”€â”€ ecosystem.config.js              # PM2 é…ç½®æ–‡ä»¶
â””â”€â”€ README.md                        # åç«¯æ–‡æ¡£
```

### 3.2 å‰ç«¯ç›®å½•ç»“æ„

```
zsxq-refund-web/                     # å‰ç«¯é¡¹ç›®æ ¹ç›®å½•
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.js                      # åº”ç”¨å…¥å£(Vueåˆå§‹åŒ–)
â”‚   â”œâ”€â”€ App.vue                      # æ ¹ç»„ä»¶
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ request.js               # Axios å°è£…(æ‹¦æˆªå™¨ã€API Key)
â”‚   â”‚   â”œâ”€â”€ camps.api.js             # è®­ç»ƒè¥ API è°ƒç”¨
â”‚   â”‚   â””â”€â”€ config.api.js            # é…ç½® API è°ƒç”¨(Cookieæ›´æ–°)
â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â”œâ”€â”€ CampList.vue             # é¡µé¢: è®­ç»ƒè¥åˆ—è¡¨
â”‚   â”‚   â””â”€â”€ RefundList.vue           # é¡µé¢: é€€æ¬¾åå•
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ StatisticsCard.vue       # ç»„ä»¶: ç»Ÿè®¡å¡ç‰‡(æ€»è§ˆæ•°æ®)
â”‚   â”‚   â””â”€â”€ ConfigDialog.vue         # ç»„ä»¶: Cookie é…ç½®å¼¹çª—
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ export-excel.js          # å·¥å…·: Excel å¯¼å‡º(å¸¦æ ·å¼)
â”‚   â”‚   â””â”€â”€ export-image.js          # å·¥å…·: å›¾ç‰‡å¯¼å‡º(1200px)
â”‚   â”œâ”€â”€ router/
â”‚   â”‚   â””â”€â”€ index.js                 # Vue Router é…ç½®
â”‚   â”œâ”€â”€ assets/
â”‚   â”‚   â””â”€â”€ logo.png
â”‚   â””â”€â”€ styles/
â”‚       â””â”€â”€ main.css                 # å…¨å±€æ ·å¼
â”œâ”€â”€ public/
â”‚   â””â”€â”€ favicon.ico
â”œâ”€â”€ index.html                       # HTML æ¨¡æ¿
â”œâ”€â”€ vite.config.js                   # Vite é…ç½®(ä»£ç†ã€æ„å»º)
â”œâ”€â”€ .env.development                 # å¼€å‘ç¯å¢ƒå˜é‡(API Key)
â”œâ”€â”€ .env.production                  # ç”Ÿäº§ç¯å¢ƒå˜é‡(API Key)
â”œâ”€â”€ package.json                     # ä¾èµ–ç®¡ç†
â””â”€â”€ README.md                        # å‰ç«¯æ–‡æ¡£
```

---

## å››ã€æ ¸å¿ƒä»£ç å®ç°

### 4.1 åç«¯æ ¸å¿ƒä»£ç 

#### 4.1.1 å…¥å£æ–‡ä»¶ (app.js)

```javascript
const express = require('express');
const dotenv = require('dotenv');
const logger = require('./config/logger.config');
const authMiddleware = require('./middlewares/auth.middleware');
const loggerMiddleware = require('./middlewares/logger.middleware');
const errorMiddleware = require('./middlewares/error.middleware');
const campsRoute = require('./routes/camps.route');
const configRoute = require('./routes/config.route');

// åŠ è½½ç¯å¢ƒå˜é‡
dotenv.config();

const app = express();
const PORT = process.env.PORT || 3013;

// ä¸­é—´ä»¶
app.use(express.json());
app.use(loggerMiddleware); // è¯·æ±‚æ—¥å¿—

// è·¯ç”±(æ‰€æœ‰æ¥å£éƒ½éœ€è¦API Keyé‰´æƒ)
app.use('/api', authMiddleware);
app.use('/api', campsRoute);
app.use('/api', configRoute);

// ç»Ÿä¸€é”™è¯¯å¤„ç†
app.use(errorMiddleware);

// å¯åŠ¨æœåŠ¡
app.listen(PORT, () => {
  logger.info(`æœåŠ¡å¯åŠ¨æˆåŠŸ,ç«¯å£: ${PORT}`);
});
```

---

#### 4.1.2 çŸ¥è¯†æ˜ŸçƒæœåŠ¡ (zsxq.service.js)

```javascript
const axios = require('axios');
const config = require('../config/zsxq.config');
const logger = require('../config/logger.config');

class ZsxqService {
  constructor() {
    this.baseURL = 'https://api.zsxq.com/v2';
    this.groupId = config.GROUP_ID;
  }

  // è·å–è¯·æ±‚å¤´(ä»ç¯å¢ƒå˜é‡åŠ¨æ€è¯»å–Cookie)
  getHeaders() {
    return {
      'Host': 'api.zsxq.com',
      'content-type': 'application/json; charset=utf-8',
      'x-timestamp': process.env.ZSXQ_TIMESTAMP,
      'authorization': process.env.ZSXQ_AUTHORIZATION,
      'x-signature': process.env.ZSXQ_SIGNATURE,
      'x-request-id': this.generateRequestId(),
      'user-agent': 'xiaomiquan/5.28.1'
    };
  }

  // ç”Ÿæˆéšæœºè¯·æ±‚ID
  generateRequestId() {
    return 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  // è·å–è®­ç»ƒè¥åˆ—è¡¨
  async getCamps(scope = 'over', count = 100) {
    try {
      const url = `${this.baseURL}/groups/${this.groupId}/checkins`;
      const response = await axios.get(url, {
        params: { scope, count },
        headers: this.getHeaders(),
        timeout: 10000
      });

      if (!response.data.succeeded) {
        throw new Error('çŸ¥è¯†æ˜Ÿçƒ API è¿”å›å¤±è´¥');
      }

      logger.info(`è·å–è®­ç»ƒè¥åˆ—è¡¨æˆåŠŸ,scope=${scope},æ•°é‡=${response.data.resp_data.checkins.length}`);
      return response.data.resp_data.checkins;

    } catch (error) {
      logger.error('è·å–è®­ç»ƒè¥åˆ—è¡¨å¤±è´¥:', error.message);

      // Cookieå¤±æ•ˆæ£€æµ‹
      if (error.response && error.response.status === 401) {
        throw new Error('Cookie å·²è¿‡æœŸ,è¯·åœ¨å‰ç«¯é¡µé¢æ›´æ–° Cookie');
      }

      throw error;
    }
  }

  // è·å–æ‰“å¡æ’è¡Œæ¦œ(æ”¯æŒè‡ªåŠ¨ç¿»é¡µ,æœ€å¤š200äºº)
  async getRankingList(checkinId) {
    try {
      const allRankings = [];
      let index = 0;
      const MAX_PAGES = 2; // æœ€å¤šç¿»2é¡µ(200äºº)
      let hasMore = true;

      while (hasMore && index < MAX_PAGES) {
        const url = `${this.baseURL}/groups/${this.groupId}/checkins/${checkinId}/ranking_list`;
        const response = await axios.get(url, {
          params: { type: 'accumulated', index },
          headers: this.getHeaders(),
          timeout: 10000
        });

        if (!response.data.succeeded) {
          throw new Error('çŸ¥è¯†æ˜Ÿçƒ API è¿”å›å¤±è´¥');
        }

        const rankings = response.data.resp_data.ranking_list;
        allRankings.push(...rankings);

        // åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
        hasMore = rankings.length === 100; // å•é¡µæœ€å¤š100æ¡
        index++;

        logger.info(`è·å–æ’è¡Œæ¦œç¬¬ ${index} é¡µ,å½“å‰å…± ${allRankings.length} æ¡`);

        // å»¶è¿Ÿ200ms,é¿å…è§¦å‘é™æµ
        if (hasMore && index < MAX_PAGES) {
          await new Promise(resolve => setTimeout(resolve, 200));
        }
      }

      logger.info(`è·å–æ’è¡Œæ¦œå®Œæˆ,æ€»è®¡ ${allRankings.length} æ¡`);
      return allRankings;

    } catch (error) {
      logger.error('è·å–æ‰“å¡æ’è¡Œæ¦œå¤±è´¥:', error.message);

      // Cookieå¤±æ•ˆæ£€æµ‹
      if (error.response && error.response.status === 401) {
        throw new Error('Cookie å·²è¿‡æœŸ,è¯·åœ¨å‰ç«¯é¡µé¢æ›´æ–° Cookie');
      }

      throw error;
    }
  }

  // éªŒè¯ Cookie æ˜¯å¦æœ‰æ•ˆ(ç”¨äºCookieæ›´æ–°åçš„éªŒè¯)
  async validateCookie() {
    try {
      await this.getCamps('ongoing', 1);
      return true;
    } catch (error) {
      return false;
    }
  }
}

module.exports = new ZsxqService();
```

---

#### 4.1.3 é€€æ¬¾åå•è®¡ç®—æœåŠ¡ (refund.service.js)

```javascript
const zsxqService = require('./zsxq.service');
const logger = require('../config/logger.config');

class RefundService {
  // ç”Ÿæˆé€€æ¬¾åå•
  async generateRefundList(checkinId, requiredDays) {
    logger.info(`å¼€å§‹ç”Ÿæˆé€€æ¬¾åå•,checkinId=${checkinId},requiredDays=${requiredDays}`);

    // 1. è·å–æ‰“å¡æ’è¡Œæ¦œ(è‡ªåŠ¨ç¿»é¡µè·å–å…¨éƒ¨)
    const rankings = await zsxqService.getRankingList(checkinId);

    // 2. è®¡ç®—åˆæ ¼åå•
    const refundList = rankings.map(item => ({
      planet_user_id: item.user.user_id,
      planet_nickname: item.user.name,
      planet_alias: item.user.alias || '',
      rankings: item.rankings,
      checkined_days: item.checkined_days,
      required_days: requiredDays,
      is_qualified: item.checkined_days >= requiredDays
    }));

    // 3. ç»Ÿè®¡æ•°æ®
    const totalCount = refundList.length;
    const qualifiedCount = refundList.filter(item => item.is_qualified).length;
    const qualifiedRate = totalCount > 0
      ? parseFloat((qualifiedCount / totalCount * 100).toFixed(2))
      : 0;

    logger.info(`ç”Ÿæˆé€€æ¬¾åå•å®Œæˆ,æ€»äººæ•°=${totalCount},åˆæ ¼=${qualifiedCount},åˆæ ¼ç‡=${qualifiedRate}%`);

    return {
      refund_list: refundList,
      statistics: {
        total_count: totalCount,
        qualified_count: qualifiedCount,
        qualified_rate: qualifiedRate,
        unqualified_count: totalCount - qualifiedCount
      }
    };
  }
}

module.exports = new RefundService();
```

---

#### 4.1.4 API Key é‰´æƒä¸­é—´ä»¶ (auth.middleware.js)

```javascript
const config = require('../config/api-key.config');
const { errorResponse } = require('../utils/response.util');

function authMiddleware(req, res, next) {
  const apiKey = req.headers['x-api-key'];

  if (!apiKey) {
    return res.status(401).json(errorResponse(401, 'API Key ç¼ºå¤±'));
  }

  if (apiKey !== config.API_KEY) {
    return res.status(401).json(errorResponse(401, 'API Key æ— æ•ˆ'));
  }

  next();
}

module.exports = authMiddleware;
```

---

#### 4.1.5 ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸­é—´ä»¶ (error.middleware.js)

```javascript
const logger = require('../config/logger.config');
const { errorResponse } = require('../utils/response.util');

function errorMiddleware(err, req, res, next) {
  logger.error(`è¯·æ±‚å¤±è´¥: ${req.method} ${req.path}`, {
    error: err.message,
    stack: err.stack
  });

  // Cookie å¤±æ•ˆé”™è¯¯
  if (err.message.includes('Cookie å·²è¿‡æœŸ')) {
    return res.status(403).json(errorResponse(403, err.message));
  }

  // çŸ¥è¯†æ˜Ÿçƒ API é”™è¯¯
  if (err.message.includes('çŸ¥è¯†æ˜Ÿçƒ')) {
    return res.status(502).json(errorResponse(502, err.message));
  }

  // å‚æ•°æ ¡éªŒé”™è¯¯
  if (err.message.includes('å‚æ•°')) {
    return res.status(400).json(errorResponse(400, err.message));
  }

  // é»˜è®¤é”™è¯¯
  return res.status(500).json(errorResponse(500, 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'));
}

module.exports = errorMiddleware;
```

---

#### 4.1.6 ç»Ÿä¸€å“åº”æ ¼å¼ (response.util.js)

```javascript
// æˆåŠŸå“åº”
function successResponse(data, message = 'æˆåŠŸ') {
  return {
    code: 200,
    message,
    data,
    timestamp: Date.now()
  };
}

// å¤±è´¥å“åº”
function errorResponse(code, message) {
  return {
    code,
    message,
    data: null,
    timestamp: Date.now()
  };
}

module.exports = {
  successResponse,
  errorResponse
};
```

---

#### 4.1.7 è·¯ç”±é…ç½® (camps.route.js)

```javascript
const express = require('express');
const router = express.Router();
const zsxqService = require('../services/zsxq.service');
const refundService = require('../services/refund.service');
const { successResponse, errorResponse } = require('../utils/response.util');

// è·å–è®­ç»ƒè¥åˆ—è¡¨
router.get('/camps', async (req, res, next) => {
  try {
    const { scope = 'over' } = req.query;

    // å‚æ•°æ ¡éªŒ
    if (!['ongoing', 'over', 'closed'].includes(scope)) {
      return res.status(400).json(errorResponse(400, 'scope å‚æ•°æ— æ•ˆ,å¯é€‰å€¼: ongoing/over/closed'));
    }

    // è°ƒç”¨æœåŠ¡
    const camps = await zsxqService.getCamps(scope, 100);

    // ç»„è£…æ•°æ®
    const data = {
      camps: camps.map(camp => ({
        checkin_id: camp.checkin_id,
        title: camp.title,
        checkin_days: camp.checkin_days,
        status: camp.status,
        joined_count: camp.joined_count,
        expiration_time: camp.expiration_time
      }))
    };

    res.json(successResponse(data));

  } catch (error) {
    next(error);
  }
});

// ç”Ÿæˆé€€æ¬¾åå•
router.post('/camps/:checkin_id/refund-list', async (req, res, next) => {
  try {
    const { checkin_id } = req.params;
    const { required_days } = req.body;

    // å‚æ•°æ ¡éªŒ
    if (!required_days || !Number.isInteger(required_days) || required_days <= 0) {
      return res.status(400).json(errorResponse(400, 'required_days å¿…é¡»ä¸ºæ­£æ•´æ•°'));
    }

    // ç”Ÿæˆé€€æ¬¾åå•
    const result = await refundService.generateRefundList(
      parseInt(checkin_id),
      required_days
    );

    // è·å–è®­ç»ƒè¥ä¿¡æ¯(ç”¨äºè¿”å› camp_info)
    const camps = await zsxqService.getCamps('over', 100);
    const camp = camps.find(c => c.checkin_id === parseInt(checkin_id));

    const data = {
      camp_info: {
        title: camp ? camp.title : 'æœªçŸ¥è®­ç»ƒè¥',
        total_days: camp ? camp.checkin_days : 0,
        joined_count: camp ? camp.joined_count : 0
      },
      refund_list: result.refund_list,
      statistics: result.statistics
    };

    res.json(successResponse(data));

  } catch (error) {
    next(error);
  }
});

module.exports = router;
```

---

#### 4.1.8 Cookie æ›´æ–°æ¥å£ (config.route.js)

```javascript
const express = require('express');
const router = express.Router();
const fs = require('fs');
const path = require('path');
const dotenv = require('dotenv');
const zsxqService = require('../services/zsxq.service');
const { successResponse, errorResponse } = require('../utils/response.util');

// æ›´æ–°çŸ¥è¯†æ˜Ÿçƒ Cookie
router.post('/config/zsxq-cookie', async (req, res, next) => {
  try {
    const { x_timestamp, authorization, x_signature } = req.body;

    // å‚æ•°æ ¡éªŒ
    if (!x_timestamp || !authorization || !x_signature) {
      return res.status(400).json(errorResponse(400, 'ç¼ºå°‘å¿…å¡«å‚æ•°'));
    }

    // è¯»å– .env æ–‡ä»¶
    const envPath = path.join(__dirname, '../../.env');
    let envContent = fs.readFileSync(envPath, 'utf-8');

    // æ›´æ–°ç¯å¢ƒå˜é‡
    envContent = envContent.replace(/ZSXQ_TIMESTAMP=.*/g, `ZSXQ_TIMESTAMP=${x_timestamp}`);
    envContent = envContent.replace(/ZSXQ_AUTHORIZATION=.*/g, `ZSXQ_AUTHORIZATION=${authorization}`);
    envContent = envContent.replace(/ZSXQ_SIGNATURE=.*/g, `ZSXQ_SIGNATURE=${x_signature}`);

    // å†™å›æ–‡ä»¶
    fs.writeFileSync(envPath, envContent);

    // é‡æ–°åŠ è½½ç¯å¢ƒå˜é‡
    dotenv.config({ override: true });

    // éªŒè¯æ–° Cookie æ˜¯å¦æœ‰æ•ˆ
    const isValid = await zsxqService.validateCookie();

    if (!isValid) {
      return res.status(500).json(errorResponse(500, 'Cookie æ›´æ–°å¤±è´¥: æ–° Cookie æ— æ•ˆ,è¯·æ£€æŸ¥æ˜¯å¦å¤åˆ¶å®Œæ•´'));
    }

    res.json(successResponse({
      updated_at: new Date().toISOString()
    }, 'Cookie æ›´æ–°æˆåŠŸ'));

  } catch (error) {
    next(error);
  }
});

module.exports = router;
```

---

### 4.2 å‰ç«¯æ ¸å¿ƒä»£ç 

#### 4.2.1 Axios å°è£… (request.js)

```javascript
import axios from 'axios';
import { ElMessage } from 'element-plus';

const request = axios.create({
  baseURL: '/api',
  timeout: 30000
});

// è¯·æ±‚æ‹¦æˆªå™¨(æ·»åŠ  API Key)
request.interceptors.request.use(
  config => {
    config.headers['X-API-Key'] = import.meta.env.VITE_API_KEY || 'your-secret-api-key';
    return config;
  },
  error => {
    return Promise.reject(error);
  }
);

// å“åº”æ‹¦æˆªå™¨(ç»Ÿä¸€é”™è¯¯å¤„ç†)
request.interceptors.response.use(
  response => {
    const { code, message, data } = response.data;

    if (code === 200) {
      return data;
    } else {
      ElMessage.error(message || 'è¯·æ±‚å¤±è´¥');
      return Promise.reject(new Error(message));
    }
  },
  error => {
    if (error.response) {
      const { status, data } = error.response;

      // Cookieå¤±æ•ˆç‰¹æ®Šå¤„ç†
      if (status === 403 && data.message && data.message.includes('Cookie')) {
        ElMessage.error({
          message: 'çŸ¥è¯†æ˜Ÿçƒ Cookie å·²è¿‡æœŸ,è¯·ç‚¹å‡»å³ä¸Šè§’"æ›´æ–° Cookie"æŒ‰é’®',
          duration: 5000,
          showClose: true
        });
      }
      // API Key æ— æ•ˆ
      else if (status === 401) {
        ElMessage.error('API Key æ— æ•ˆ,è¯·æ£€æŸ¥é…ç½®');
      }
      // å…¶ä»–é”™è¯¯
      else {
        ElMessage.error(data.message || 'è¯·æ±‚å¤±è´¥');
      }
    } else {
      ElMessage.error('ç½‘ç»œé”™è¯¯,è¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨');
    }

    return Promise.reject(error);
  }
);

export default request;
```

---

#### 4.2.2 è®­ç»ƒè¥åˆ—è¡¨é¡µé¢ (CampList.vue)

```vue
<template>
  <div class="camp-list-container">
    <el-card>
      <template #header>
        <div class="header">
          <span class="title">è®­ç»ƒè¥é€€æ¬¾ç³»ç»Ÿ v0</span>
          <el-button type="primary" @click="showConfigDialog = true">
            æ›´æ–° Cookie
          </el-button>
        </div>
      </template>

      <!-- ç­›é€‰è¡¨å• -->
      <el-form inline>
        <el-form-item label="çŠ¶æ€ç­›é€‰:">
          <el-select v-model="scope" placeholder="è¯·é€‰æ‹©">
            <el-option label="è¿›è¡Œä¸­" value="ongoing" />
            <el-option label="å·²ç»“æŸ" value="over" />
            <el-option label="å·²å…³é—­" value="closed" />
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="fetchCamps" :loading="loading">
            åˆ·æ–°åˆ—è¡¨
          </el-button>
        </el-form-item>
      </el-form>

      <!-- è®­ç»ƒè¥åˆ—è¡¨è¡¨æ ¼ -->
      <el-table :data="camps" v-loading="loading" border stripe>
        <el-table-column prop="title" label="è®­ç»ƒè¥åç§°" min-width="200" />
        <el-table-column prop="status" label="çŠ¶æ€" width="100">
          <template #default="{ row }">
            <el-tag v-if="row.status === 'ongoing'" type="success">è¿›è¡Œä¸­</el-tag>
            <el-tag v-else-if="row.status === 'over'" type="info">å·²ç»“æŸ</el-tag>
            <el-tag v-else type="warning">å·²å…³é—­</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="checkin_days" label="æ‰“å¡å¤©æ•°" width="100">
          <template #default="{ row }">{{ row.checkin_days }} å¤©</template>
        </el-table-column>
        <el-table-column prop="joined_count" label="å‚ä¸äººæ•°" width="100">
          <template #default="{ row }">{{ row.joined_count }} äºº</template>
        </el-table-column>
        <el-table-column label="æ“ä½œ" width="150">
          <template #default="{ row }">
            <el-button
              type="primary"
              size="small"
              @click="goToRefundList(row)"
              :disabled="row.status === 'ongoing'"
            >
              ç”Ÿæˆåå•
            </el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <!-- Cookie é…ç½®å¼¹çª— -->
    <ConfigDialog v-model="showConfigDialog" />
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { useRouter } from 'vue-router';
import { getCamps } from '@/api/camps.api';
import ConfigDialog from '@/components/ConfigDialog.vue';

const router = useRouter();
const scope = ref('over');
const camps = ref([]);
const loading = ref(false);
const showConfigDialog = ref(false);

// è·å–è®­ç»ƒè¥åˆ—è¡¨
const fetchCamps = async () => {
  loading.value = true;
  try {
    const data = await getCamps(scope.value);
    camps.value = data.camps;
  } finally {
    loading.value = false;
  }
};

// è·³è½¬åˆ°é€€æ¬¾åå•é¡µé¢
const goToRefundList = (camp) => {
  router.push({
    name: 'RefundList',
    params: { checkin_id: camp.checkin_id },
    query: {
      title: camp.title,
      total_days: camp.checkin_days,
      joined_count: camp.joined_count
    }
  });
};

onMounted(() => {
  fetchCamps();
});
</script>

<style scoped>
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.title {
  font-size: 18px;
  font-weight: bold;
}
</style>
```

---

#### 4.2.3 é€€æ¬¾åå•é¡µé¢ (RefundList.vue) - éƒ¨åˆ†ä»£ç 

```vue
<template>
  <div class="refund-list-container">
    <el-card>
      <template #header>
        <el-page-header @back="$router.back()" title="è¿”å›">
          <template #content>
            <span class="page-title">ç”Ÿæˆé€€æ¬¾åå• - {{ campTitle }}</span>
          </template>
        </el-page-header>
      </template>

      <!-- è®­ç»ƒè¥ä¿¡æ¯ -->
      <el-descriptions :column="2" border>
        <el-descriptions-item label="æ‰“å¡æ€»å¤©æ•°">{{ totalDays }} å¤©</el-descriptions-item>
        <el-descriptions-item label="å‚ä¸äººæ•°">{{ joinedCount }} äºº</el-descriptions-item>
      </el-descriptions>

      <!-- å®Œæˆæ ‡å‡†è¡¨å• -->
      <el-form inline style="margin-top: 20px;">
        <el-form-item label="å®Œæˆæ ‡å‡†:">
          <el-input-number
            v-model="requiredDays"
            :min="1"
            :max="totalDays"
            placeholder="è¾“å…¥å¤©æ•°"
          />
          <span style="margin-left: 10px;">å¤©å®Œæˆæ‰“å¡ç®—åˆæ ¼</span>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="handleCalculate" :loading="loading">
            å¼€å§‹è®¡ç®—
          </el-button>
        </el-form-item>
      </el-form>

      <!-- æ•°æ®æ€»è§ˆå¡ç‰‡ -->
      <el-card v-if="refundList.length > 0" class="statistics-card">
        <template #header>ğŸ“Š æ•°æ®æ€»è§ˆ</template>

        <!-- ç»Ÿè®¡æ•°å­— -->
        <el-row :gutter="20" class="statistics-row">
          <el-col :span="6">
            <el-statistic title="æ€»äººæ•°" :value="statistics.total_count" suffix="äºº" />
          </el-col>
          <el-col :span="6">
            <el-statistic title="åˆæ ¼äººæ•°" :value="statistics.qualified_count" suffix="äºº" />
          </el-col>
          <el-col :span="6">
            <el-statistic
              title="åˆæ ¼ç‡"
              :value="statistics.qualified_rate"
              suffix="%"
              :precision="2"
            />
          </el-col>
          <el-col :span="6">
            <el-statistic title="ä¸åˆæ ¼äººæ•°" :value="statistics.unqualified_count" suffix="äºº" />
          </el-col>
        </el-row>

        <el-divider />

        <!-- åˆæ ¼äººå‘˜åå• -->
        <div class="qualified-names">
          <p><strong>å®Œæˆæ‰“å¡äººå‘˜åå•:</strong></p>
          <p class="names-text">{{ qualifiedNames }}</p>
          <el-button type="success" @click="copyQualifiedNames" style="margin-top: 10px;">
            ä¸€é”®å¤åˆ¶
          </el-button>
        </div>
      </el-card>

      <!-- è¯¦ç»†åå•è¡¨æ ¼ -->
      <el-card v-if="refundList.length > 0" style="margin-top: 20px;">
        <template #header>ğŸ“‹ è¯¦ç»†åå•</template>

        <el-table :data="refundList" border stripe max-height="500">
          <el-table-column type="index" label="åºå·" width="60" />
          <el-table-column prop="planet_nickname" label="æ˜Ÿçƒæ˜µç§°" min-width="150" />
          <el-table-column prop="planet_user_id" label="æ˜ŸçƒID" width="150" />
          <el-table-column prop="checkined_days" label="æ‰“å¡å¤©æ•°" width="100">
            <template #default="{ row }">{{ row.checkined_days }} å¤©</template>
          </el-table-column>
          <el-table-column prop="is_qualified" label="æ˜¯å¦åˆæ ¼" width="100">
            <template #default="{ row }">
              <el-tag v-if="row.is_qualified" type="success">âœ… åˆæ ¼</el-tag>
              <el-tag v-else type="danger">âŒ ä¸åˆæ ¼</el-tag>
            </template>
          </el-table-column>
        </el-table>

        <!-- å¯¼å‡ºæŒ‰é’® -->
        <div style="margin-top: 20px; text-align: center;">
          <el-button type="primary" @click="downloadImage">ä¸‹è½½å›¾ç‰‡</el-button>
          <el-button type="success" @click="exportExcel">å¯¼å‡º Excel</el-button>
        </div>
      </el-card>
    </el-card>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue';
import { useRoute } from 'vue-router';
import { ElMessage, ElMessageBox } from 'element-plus';
import { getRefundList } from '@/api/camps.api';
import { exportToExcel } from '@/utils/export-excel';
import { exportToImage } from '@/utils/export-image';

const route = useRoute();
const checkinId = route.params.checkin_id;
const campTitle = ref(route.query.title || '');
const totalDays = ref(parseInt(route.query.total_days) || 9);
const joinedCount = ref(parseInt(route.query.joined_count) || 0);

const requiredDays = ref(7);
const loading = ref(false);
const refundList = ref([]);
const statistics = ref({
  total_count: 0,
  qualified_count: 0,
  qualified_rate: 0,
  unqualified_count: 0
});

// åˆæ ¼äººå‘˜æ˜µç§°åˆ—è¡¨(é¡¿å·åˆ†éš”)
const qualifiedNames = computed(() => {
  return refundList.value
    .filter(item => item.is_qualified)
    .map(item => item.planet_nickname)
    .join('ã€');
});

// å¼€å§‹è®¡ç®—
const handleCalculate = async () => {
  // æ ¡éªŒ: å®Œæˆå¤©æ•°ä¸èƒ½è¶…è¿‡æ€»å¤©æ•°
  if (requiredDays.value > totalDays.value) {
    ElMessage.warning(`å®Œæˆå¤©æ•°ä¸èƒ½è¶…è¿‡è®­ç»ƒè¥æ€»å¤©æ•°(${totalDays.value}å¤©)`);
    return;
  }

  // æ“ä½œç¡®è®¤
  try {
    await ElMessageBox.confirm(
      `ç¡®å®šè¦æŒ‰ç…§ ${requiredDays.value} å¤©çš„æ ‡å‡†ç”Ÿæˆé€€æ¬¾åå•å—?`,
      'æ“ä½œç¡®è®¤',
      {
        type: 'warning',
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ'
      }
    );
  } catch {
    return; // ç”¨æˆ·å–æ¶ˆ
  }

  // è°ƒç”¨æ¥å£
  loading.value = true;
  try {
    const data = await getRefundList(checkinId, requiredDays.value);
    refundList.value = data.refund_list;
    statistics.value = data.statistics;
    campTitle.value = data.camp_info.title;
    ElMessage.success('è®¡ç®—å®Œæˆ!');
  } finally {
    loading.value = false;
  }
};

// ä¸€é”®å¤åˆ¶åˆæ ¼äººå‘˜æ˜µç§°
const copyQualifiedNames = () => {
  navigator.clipboard.writeText(qualifiedNames.value).then(() => {
    ElMessage.success('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
  }).catch(() => {
    ElMessage.error('å¤åˆ¶å¤±è´¥,è¯·æ‰‹åŠ¨å¤åˆ¶');
  });
};

// ä¸‹è½½å›¾ç‰‡
const downloadImage = () => {
  const element = document.querySelector('.refund-list-container');
  const filename = `é€€æ¬¾åå•-${campTitle.value}-${new Date().toISOString().split('T')[0]}`;
  exportToImage(element, filename);
};

// å¯¼å‡º Excel
const exportExcel = () => {
  const filename = `é€€æ¬¾åå•-${campTitle.value}-${new Date().toISOString().split('T')[0]}`;
  exportToExcel(refundList.value, statistics.value, campTitle.value, requiredDays.value, filename);
};
</script>

<style scoped>
.page-title {
  font-size: 16px;
  font-weight: bold;
}

.statistics-card {
  margin-top: 20px;
}

.statistics-row {
  margin-bottom: 20px;
}

.qualified-names {
  margin-top: 10px;
}

.names-text {
  padding: 10px;
  background-color: #f5f7fa;
  border-radius: 4px;
  line-height: 1.8;
}
</style>
```

---

#### 4.2.4 Excel å¯¼å‡ºå·¥å…· (export-excel.js)

```javascript
import * as XLSX from 'xlsx';
import { ElMessage } from 'element-plus';

export function exportToExcel(refundList, statistics, campTitle, requiredDays, filename) {
  try {
    // æ„å»ºæ•°æ®(åŒ…å«ç»Ÿè®¡ä¿¡æ¯)
    const data = [
      ['è®­ç»ƒè¥åç§°', campTitle],
      ['å®Œæˆè¦æ±‚', `${requiredDays}å¤©`],
      ['æ€»äººæ•°', statistics.total_count],
      ['åˆæ ¼äººæ•°', statistics.qualified_count],
      ['åˆæ ¼ç‡', `${statistics.qualified_rate}%`],
      ['ä¸åˆæ ¼äººæ•°', statistics.unqualified_count],
      [], // ç©ºè¡Œ
      ['åºå·', 'æ˜Ÿçƒæ˜µç§°', 'æ˜ŸçƒID', 'æ‰“å¡å¤©æ•°', 'æ˜¯å¦åˆæ ¼'] // è¡¨å¤´
    ];

    // æ·»åŠ è¯¦ç»†æ•°æ®
    refundList.forEach((item, index) => {
      data.push([
        index + 1,
        item.planet_nickname,
        item.planet_user_id,
        item.checkined_days,
        item.is_qualified ? 'åˆæ ¼' : 'ä¸åˆæ ¼'
      ]);
    });

    // åˆ›å»ºå·¥ä½œè¡¨
    const ws = XLSX.utils.aoa_to_sheet(data);

    // è®¾ç½®åˆ—å®½
    ws['!cols'] = [
      { wch: 8 },   // åºå·
      { wch: 20 },  // æ˜µç§°
      { wch: 18 },  // ID
      { wch: 12 },  // æ‰“å¡å¤©æ•°
      { wch: 12 }   // æ˜¯å¦åˆæ ¼
    ];

    // è®¾ç½®è¡¨å¤´æ ·å¼(æ·±è‰²èƒŒæ™¯ + é»„è‰²æ–‡å­—) - ç¬¬8è¡Œæ˜¯è¡¨å¤´
    const headerCells = ['A8', 'B8', 'C8', 'D8', 'E8'];
    headerCells.forEach(cell => {
      if (!ws[cell]) ws[cell] = {};
      ws[cell].s = {
        fill: { fgColor: { rgb: '333333' } },
        font: { color: { rgb: 'FFFF00' }, bold: true },
        alignment: { horizontal: 'center', vertical: 'center' }
      };
    });

    // åˆ›å»ºå·¥ä½œç°¿
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'é€€æ¬¾åå•');

    // å¯¼å‡ºæ–‡ä»¶
    XLSX.writeFile(wb, `${filename}.xlsx`);
    ElMessage.success('Excel å¯¼å‡ºæˆåŠŸ');

  } catch (error) {
    ElMessage.error('Excel å¯¼å‡ºå¤±è´¥');
    console.error(error);
  }
}
```

---

#### 4.2.5 å›¾ç‰‡å¯¼å‡ºå·¥å…· (export-image.js)

```javascript
import html2canvas from 'html2canvas';
import { ElMessage } from 'element-plus';

export async function exportToImage(element, filename) {
  try {
    ElMessage.info('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡,è¯·ç¨å€™...');

    const canvas = await html2canvas(element, {
      backgroundColor: '#ffffff',
      scale: 2, // æé«˜æ¸…æ™°åº¦
      useCORS: true,
      width: 1200,
      logging: false,
      allowTaint: true
    });

    // è½¬æ¢ä¸º Blob å¹¶ä¸‹è½½
    canvas.toBlob((blob) => {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.download = `${filename}.png`;
      link.href = url;
      link.click();
      URL.revokeObjectURL(url);
      ElMessage.success('å›¾ç‰‡ä¸‹è½½æˆåŠŸ');
    });

  } catch (error) {
    ElMessage.error('å›¾ç‰‡ç”Ÿæˆå¤±è´¥');
    console.error(error);
  }
}
```

---

## äº”ã€API æ¥å£è®¾è®¡

### 5.1 æ¥å£é‰´æƒ

**æ‰€æœ‰æ¥å£éƒ½éœ€è¦åœ¨è¯·æ±‚å¤´æºå¸¦ API Key**:

```
Headers:
  X-API-Key: your-secret-api-key
```

**é‰´æƒå¤±è´¥å“åº”**:
```json
{
  "code": 401,
  "message": "API Key æ— æ•ˆæˆ–ç¼ºå¤±",
  "data": null,
  "timestamp": 1698765432
}
```

### 5.2 ç»Ÿä¸€å“åº”æ ¼å¼

**æˆåŠŸå“åº”**:
```json
{
  "code": 200,
  "message": "æˆåŠŸ",
  "data": { ... },
  "timestamp": 1698765432
}
```

**å¤±è´¥å“åº”**:
```json
{
  "code": 500,
  "message": "çŸ¥è¯†æ˜Ÿçƒ API è°ƒç”¨å¤±è´¥: Cookie å·²è¿‡æœŸ",
  "data": null,
  "timestamp": 1698765432
}
```

### 5.3 æ¥å£åˆ—è¡¨

#### 5.3.1 è·å–è®­ç»ƒè¥åˆ—è¡¨

**æ¥å£**: `GET /api/camps`

**è¯·æ±‚å‚æ•°** (Query String):
```
scope: string  // å¿…å¡«,å€¼: ongoing | over | closed
```

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X GET "https://zsxq.dc401.com/api/camps?scope=over" \
  -H "X-API-Key: your-secret-api-key"
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "æˆåŠŸ",
  "data": {
    "camps": [
      {
        "checkin_id": 2424424541,
        "title": "2510 AIå°ç»¿ä¹¦çˆ†æ–‡",
        "checkin_days": 9,
        "status": "over",
        "joined_count": 115,
        "expiration_time": "2025-11-03T23:59:59.999+0800"
      }
    ]
  },
  "timestamp": 1698765432
}
```

---

#### 5.3.2 ç”Ÿæˆé€€æ¬¾åå•

**æ¥å£**: `POST /api/camps/:checkin_id/refund-list`

**è·¯å¾„å‚æ•°**:
```
checkin_id: number  // è®­ç»ƒè¥ID
```

**è¯·æ±‚ä½“** (JSON):
```json
{
  "required_days": 7  // å®Œæˆå‡ å¤©ç®—åˆæ ¼(å¿…å¡«,æ•´æ•°)
}
```

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST "https://zsxq.dc401.com/api/camps/2424424541/refund-list" \
  -H "X-API-Key: your-secret-api-key" \
  -H "Content-Type: application/json" \
  -d '{"required_days": 7}'
```

**åç«¯å¤„ç†é€»è¾‘**:
1. éªŒè¯ API Key
2. éªŒè¯ `required_days` æ˜¯å¦ä¸ºæ­£æ•´æ•°
3. è°ƒç”¨çŸ¥è¯†æ˜Ÿçƒ API è·å–æ‰“å¡æ’è¡Œæ¦œ
4. **è‡ªåŠ¨ç¿»é¡µ**:å¦‚æœäººæ•°>100,å¾ªç¯è°ƒç”¨ `index=0,1,2...` ç›´åˆ°è·å–å…¨éƒ¨æ•°æ®(æœ€å¤š200äºº)
5. è®¡ç®—æ¯ä¸ªäººæ˜¯å¦åˆæ ¼: `checkined_days >= required_days`
6. ç»Ÿè®¡åˆæ ¼äººæ•°ã€åˆæ ¼ç‡

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "æˆåŠŸ",
  "data": {
    "camp_info": {
      "title": "2510 AIå†™ä½œ",
      "total_days": 9,
      "joined_count": 99
    },
    "refund_list": [
      {
        "planet_user_id": 88455815452182,
        "planet_nickname": "çƒçƒçš„å‰¯ä¸šæ¢ç´¢è·¯",
        "planet_alias": "",
        "rankings": 1,
        "checkined_days": 10,
        "required_days": 7,
        "is_qualified": true
      },
      {
        "planet_user_id": 78901234567890,
        "planet_nickname": "æå››",
        "planet_alias": "",
        "rankings": 50,
        "checkined_days": 5,
        "required_days": 7,
        "is_qualified": false
      }
    ],
    "statistics": {
      "total_count": 99,
      "qualified_count": 85,
      "qualified_rate": 85.86,
      "unqualified_count": 14
    }
  },
  "timestamp": 1698765432
}
```

---

#### 5.3.3 æ›´æ–°çŸ¥è¯†æ˜Ÿçƒ Cookie

**æ¥å£**: `POST /api/config/zsxq-cookie`

**ç”¨é€”**: å½“ Cookie å¤±æ•ˆæ—¶,ç®¡ç†å‘˜é€šè¿‡å‰ç«¯é¡µé¢æ‰‹åŠ¨æ›´æ–°

**è¯·æ±‚ä½“** (JSON):
```json
{
  "x_timestamp": "1698765432",
  "authorization": "Bearer xxx",
  "x_signature": "xxx"
}
```

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST "https://zsxq.dc401.com/api/config/zsxq-cookie" \
  -H "X-API-Key: your-secret-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "x_timestamp": "1698765432",
    "authorization": "Bearer xxx",
    "x_signature": "xxx"
  }'
```

**åç«¯å¤„ç†é€»è¾‘**:
1. éªŒè¯ API Key
2. éªŒè¯å¿…å¡«å­—æ®µ
3. æ›´æ–° `.env` æ–‡ä»¶(ä½¿ç”¨ `fs.writeFileSync`)
4. **é‡æ–°åŠ è½½ç¯å¢ƒå˜é‡**:è°ƒç”¨ `dotenv.config({ override: true })`
5. éªŒè¯æ–° Cookie æ˜¯å¦æœ‰æ•ˆ(è°ƒç”¨çŸ¥è¯†æ˜Ÿçƒ API æµ‹è¯•)

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 200,
  "message": "Cookie æ›´æ–°æˆåŠŸ",
  "data": {
    "updated_at": "2025-10-26T12:00:00+0800"
  },
  "timestamp": 1698765432
}
```

**å¤±è´¥å“åº”**:
```json
{
  "code": 500,
  "message": "Cookie æ›´æ–°å¤±è´¥: æ–° Cookie æ— æ•ˆ,è¯·æ£€æŸ¥æ˜¯å¦å¤åˆ¶å®Œæ•´",
  "data": null,
  "timestamp": 1698765432
}
```

---

### 5.4 é”™è¯¯ç è®¾è®¡

| é”™è¯¯ç  | è¯´æ˜ | å¸¸è§åŸå›  | å‰ç«¯å¤„ç† |
|--------|------|---------|----------|
| 200 | æˆåŠŸ | - | æ­£å¸¸å±•ç¤ºæ•°æ® |
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ | ç¼ºå°‘å¿…å¡«å‚æ•°ã€å‚æ•°ç±»å‹é”™è¯¯ | æç¤ºç”¨æˆ·æ£€æŸ¥è¾“å…¥ |
| 401 | æœªæˆæƒ | API Key æ— æ•ˆæˆ–ç¼ºå¤± | æç¤ºé…ç½® API Key |
| 403 | Cookie å¤±æ•ˆ | çŸ¥è¯†æ˜Ÿçƒ Cookie è¿‡æœŸ | å¼¹çª—æç¤ºæ›´æ–° Cookie |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ | æœåŠ¡å¼‚å¸¸ | æç¤ºç¨åé‡è¯• |
| 502 | çŸ¥è¯†æ˜Ÿçƒ API ä¸å¯ç”¨ | çŸ¥è¯†æ˜ŸçƒæœåŠ¡å¼‚å¸¸ | æç¤ºç¨åé‡è¯• |

---

## å…­ã€éƒ¨ç½²æ–¹æ¡ˆ

### 6.1 æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

**æœåŠ¡å™¨é…ç½®**: 2C4G (å·²æ»¡è¶³éœ€æ±‚)

**ç¯å¢ƒè¦æ±‚**:
- Node.js 18+
- Nginx 1.18+
- Certbot (Let's Encrypt)

---

### 6.2 éƒ¨ç½²æ­¥éª¤è¯¦è§£

#### æ­¥éª¤ 1: å®‰è£… Node.js

```bash
# 1. å®‰è£… Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 2. éªŒè¯å®‰è£…
node -v  # åº”æ˜¾ç¤º v18.x.x
npm -v   # åº”æ˜¾ç¤º 9.x.x

# 3. å®‰è£… PM2(å…¨å±€)
npm install -g pm2
```

---

#### æ­¥éª¤ 2: éƒ¨ç½²åç«¯

```bash
# 1. åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p /var/www/zsxq-refund
cd /var/www/zsxq-refund

# 2. ä¸Šä¼ åç«¯ä»£ç (å‡è®¾ä»£ç å·²é€šè¿‡ Git æ‹‰å–æˆ– scp ä¸Šä¼ )
# å¦‚æœä½¿ç”¨ Git:
# git clone <åç«¯ä»“åº“åœ°å€> api

# å¦‚æœä½¿ç”¨ scp ä¸Šä¼ :
# scp -r zsxq-refund-api root@your-server:/var/www/zsxq-refund/api

cd api

# 3. å®‰è£…ä¾èµ–
npm install --production

# 4. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
vim .env

# ç¼–è¾‘ .env æ–‡ä»¶,å¡«å…¥ä»¥ä¸‹é…ç½®:
```

**.env é…ç½®ç¤ºä¾‹**:
```bash
# çŸ¥è¯†æ˜Ÿçƒé…ç½®
ZSXQ_GROUP_ID=15555411412112
ZSXQ_TIMESTAMP=1698765432
ZSXQ_AUTHORIZATION=Bearer xxxxxxxxxxxxx
ZSXQ_SIGNATURE=xxxxxxxxxxxxx

# API Key é…ç½®(è¯·ä¿®æ”¹ä¸ºå¼ºå¯†ç )
API_KEY=your-secret-api-key-change-me-12345

# æœåŠ¡é…ç½®
PORT=3013
NODE_ENV=production
```

```bash
# 5. åˆ›å»º PM2 é…ç½®æ–‡ä»¶
vim ecosystem.config.js
```

**ecosystem.config.js é…ç½®**:
```javascript
module.exports = {
  apps: [{
    name: 'zsxq-refund-api',
    script: 'src/app.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '500M',
    env: {
      NODE_ENV: 'production',
      PORT: 3013
    },
    error_file: 'logs/pm2-error.log',
    out_file: 'logs/pm2-out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss',
    merge_logs: true
  }]
};
```

```bash
# 6. å¯åŠ¨æœåŠ¡
pm2 start ecosystem.config.js

# 7. ä¿å­˜ PM2 é…ç½®(å¼€æœºè‡ªå¯)
pm2 save
pm2 startup

# 8. éªŒè¯æœåŠ¡
pm2 status  # æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 logs zsxq-refund-api  # æŸ¥çœ‹æ—¥å¿—
curl http://localhost:3013/api/camps?scope=over \
  -H "X-API-Key: your-secret-api-key-change-me-12345"  # æµ‹è¯•æ¥å£
```

---

#### æ­¥éª¤ 3: éƒ¨ç½²å‰ç«¯

**æ–¹å¼1: æœ¬åœ°æ„å»ºåä¸Šä¼ (æ¨è)**

```bash
# åœ¨å¼€å‘æœºå™¨ä¸Šæ‰§è¡Œ:
cd zsxq-refund-web

# 1. é…ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡
vim .env.production

# å¡«å…¥:
VITE_API_KEY=your-secret-api-key-change-me-12345

# 2. å®‰è£…ä¾èµ–å¹¶æ„å»º
npm install
npm run build  # ç”Ÿæˆ dist/ ç›®å½•

# 3. ä¸Šä¼  dist/ åˆ°æœåŠ¡å™¨
scp -r dist/* root@your-server:/var/www/zsxq-refund/web/
```

**æ–¹å¼2: æœåŠ¡å™¨ä¸Šç›´æ¥æ„å»º**

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ:
cd /var/www/zsxq-refund

# 1. ä¸Šä¼ å‰ç«¯ä»£ç 
# git clone <å‰ç«¯ä»“åº“åœ°å€> web-src
# æˆ– scp -r zsxq-refund-web root@your-server:/var/www/zsxq-refund/web-src

cd web-src

# 2. é…ç½®ç¯å¢ƒå˜é‡
vim .env.production
# å¡«å…¥: VITE_API_KEY=your-secret-api-key-change-me-12345

# 3. å®‰è£…ä¾èµ–å¹¶æ„å»º
npm install
npm run build

# 4. å¤åˆ¶æ„å»ºäº§ç‰©
mkdir -p /var/www/zsxq-refund/web
cp -r dist/* /var/www/zsxq-refund/web/

# 5. åˆ é™¤æºç (èŠ‚çœç©ºé—´)
cd ..
rm -rf web-src
```

---

#### æ­¥éª¤ 4: é…ç½® Nginx

```bash
# 1. åˆ›å»º Nginx é…ç½®æ–‡ä»¶
sudo vim /etc/nginx/sites-available/zsxq-refund

# 2. å†™å…¥ä»¥ä¸‹é…ç½®:
```

**Nginx é…ç½®æ–‡ä»¶**:
```nginx
server {
    listen 80;
    server_name zsxq.dc401.com;

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /var/www/zsxq-refund/web;
        try_files $uri $uri/ /index.html;
        index index.html;

        # ç¼“å­˜é…ç½®(ä¼˜åŒ–æ€§èƒ½)
        expires 1h;
        add_header Cache-Control "public, immutable";
    }

    # åç«¯ API ä»£ç†
    location /api/ {
        proxy_pass http://localhost:3013/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # è¶…æ—¶é…ç½®(é˜²æ­¢å¤§æ•°æ®é‡è¯·æ±‚è¶…æ—¶)
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # æ—¥å¿—
    access_log /var/log/nginx/zsxq-refund-access.log;
    error_log /var/log/nginx/zsxq-refund-error.log;
}
```

```bash
# 3. å¯ç”¨ç«™ç‚¹
sudo ln -s /etc/nginx/sites-available/zsxq-refund /etc/nginx/sites-enabled/

# 4. æµ‹è¯•é…ç½®
sudo nginx -t

# 5. é‡å¯ Nginx
sudo systemctl restart nginx

# 6. éªŒè¯(æµè§ˆå™¨è®¿é—®)
# http://zsxq.dc401.com
```

---

#### æ­¥éª¤ 5: é…ç½® HTTPS (Let's Encrypt)

```bash
# 1. ç¡®ä¿åŸŸåå·²è§£æåˆ°æœåŠ¡å™¨
# åœ¨åŸŸåæœåŠ¡å•†(é˜¿é‡Œäº‘/è…¾è®¯äº‘)æ·»åŠ  A è®°å½•:
# zsxq.dc401.com â†’ æœåŠ¡å™¨IP

# 2. å®‰è£… Certbot
sudo apt-get update
sudo apt-get install certbot python3-certbot-nginx

# 3. ç”³è¯·è¯ä¹¦(è‡ªåŠ¨é…ç½® Nginx)
sudo certbot --nginx -d zsxq.dc401.com

# æŒ‰æç¤ºè¾“å…¥:
# - é‚®ç®±åœ°å€(ç”¨äºè¯ä¹¦åˆ°æœŸæé†’)
# - åŒæ„æœåŠ¡æ¡æ¬¾(Y)
# - æ˜¯å¦å¼ºåˆ¶ HTTPS è·³è½¬(æ¨èé€‰ 2: Redirect)

# 4. éªŒè¯è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run

# 5. æŸ¥çœ‹è¯ä¹¦ä¿¡æ¯
sudo certbot certificates
```

**é…ç½®å®Œæˆå,Nginx é…ç½®ä¼šè‡ªåŠ¨å˜ä¸º**:
```nginx
server {
    listen 80;
    server_name zsxq.dc401.com;
    return 301 https://$server_name$request_uri;  # å¼ºåˆ¶è·³è½¬ HTTPS
}

server {
    listen 443 ssl;
    server_name zsxq.dc401.com;

    ssl_certificate /etc/letsencrypt/live/zsxq.dc401.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/zsxq.dc401.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # å…¶ä»–é…ç½®åŒä¸Š...
}
```

---

### 6.3 éƒ¨ç½²éªŒè¯

```bash
# 1. æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€
pm2 status
pm2 logs zsxq-refund-api --lines 50

# 2. æµ‹è¯•åç«¯æ¥å£
curl -H "X-API-Key: your-secret-api-key-change-me-12345" \
  https://zsxq.dc401.com/api/camps?scope=over

# 3. æµè§ˆå™¨è®¿é—®å‰ç«¯
# æ‰“å¼€ https://zsxq.dc401.com
# åº”è¯¥èƒ½çœ‹åˆ°è®­ç»ƒè¥åˆ—è¡¨é¡µé¢

# 4. æ£€æŸ¥ HTTPS è¯ä¹¦
openssl s_client -connect zsxq.dc401.com:443 -servername zsxq.dc401.com
```

---

### 6.4 æ—¥å¿—ç®¡ç†

#### 6.4.1 åç«¯æ—¥å¿—ä½ç½®

- **PM2 æ—¥å¿—**: `/root/.pm2/logs/zsxq-refund-api-*.log`
- **åº”ç”¨æ—¥å¿—**: `/var/www/zsxq-refund/api/logs/app.log`
- **é”™è¯¯æ—¥å¿—**: `/var/www/zsxq-refund/api/logs/error.log`

#### 6.4.2 æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹ PM2 å®æ—¶æ—¥å¿—
pm2 logs zsxq-refund-api

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f /var/www/zsxq-refund/api/logs/app.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /var/www/zsxq-refund/api/logs/error.log
```

#### 6.4.3 è‡ªåŠ¨æ¸…ç†æ—¥å¿—(3å¤©)

```bash
# ç¼–è¾‘ Crontab
crontab -e

# æ·»åŠ å®šæ—¶ä»»åŠ¡(æ¯å¤©å‡Œæ™¨ 2 ç‚¹æ¸…ç† 3 å¤©å‰çš„æ—¥å¿—)
0 2 * * * find /var/www/zsxq-refund/api/logs -name "*.log" -mtime +3 -delete
0 2 * * * pm2 flush  # æ¸…ç† PM2 æ—¥å¿—
```

---

## ä¸ƒã€æµ‹è¯•æ–¹æ¡ˆ

### 7.1 æ¥å£æµ‹è¯•

#### æµ‹è¯• 1: è·å–è®­ç»ƒè¥åˆ—è¡¨

**æµ‹è¯•ç”¨ä¾‹**:
```bash
# æ­£å¸¸è¯·æ±‚(å·²ç»“æŸçš„è®­ç»ƒè¥)
curl -X GET "https://zsxq.dc401.com/api/camps?scope=over" \
  -H "X-API-Key: your-secret-api-key-change-me-12345"

# é¢„æœŸå“åº”:
# {
#   "code": 200,
#   "message": "æˆåŠŸ",
#   "data": {
#     "camps": [...]
#   }
# }
```

**å¼‚å¸¸æµ‹è¯•**:
```bash
# 1. ç¼ºå°‘ API Key
curl -X GET "https://zsxq.dc401.com/api/camps?scope=over"
# é¢„æœŸ: 401 é”™è¯¯

# 2. API Key æ— æ•ˆ
curl -X GET "https://zsxq.dc401.com/api/camps?scope=over" \
  -H "X-API-Key: wrong-key"
# é¢„æœŸ: 401 é”™è¯¯

# 3. scope å‚æ•°æ— æ•ˆ
curl -X GET "https://zsxq.dc401.com/api/camps?scope=invalid" \
  -H "X-API-Key: your-secret-api-key-change-me-12345"
# é¢„æœŸ: 400 é”™è¯¯
```

---

#### æµ‹è¯• 2: ç”Ÿæˆé€€æ¬¾åå•

**æµ‹è¯•ç”¨ä¾‹**:
```bash
# æ­£å¸¸è¯·æ±‚
curl -X POST "https://zsxq.dc401.com/api/camps/2424424541/refund-list" \
  -H "X-API-Key: your-secret-api-key-change-me-12345" \
  -H "Content-Type: application/json" \
  -d '{"required_days": 7}'

# é¢„æœŸå“åº”:
# {
#   "code": 200,
#   "message": "æˆåŠŸ",
#   "data": {
#     "camp_info": {...},
#     "refund_list": [...],
#     "statistics": {...}
#   }
# }
```

**å¼‚å¸¸æµ‹è¯•**:
```bash
# 1. required_days ä¸ºè´Ÿæ•°
curl -X POST "https://zsxq.dc401.com/api/camps/2424424541/refund-list" \
  -H "X-API-Key: your-secret-api-key-change-me-12345" \
  -H "Content-Type: application/json" \
  -d '{"required_days": -1}'
# é¢„æœŸ: 400 é”™è¯¯

# 2. required_days ä¸ºå­—ç¬¦ä¸²
curl -X POST "https://zsxq.dc401.com/api/camps/2424424541/refund-list" \
  -H "X-API-Key: your-secret-api-key-change-me-12345" \
  -H "Content-Type: application/json" \
  -d '{"required_days": "abc"}'
# é¢„æœŸ: 400 é”™è¯¯
```

---

#### æµ‹è¯• 3: Cookie å¤±æ•ˆåœºæ™¯

**æµ‹è¯•æ­¥éª¤**:
1. ä¿®æ”¹ `.env` ä¸­çš„ `ZSXQ_AUTHORIZATION` ä¸ºæ— æ•ˆå€¼
2. é‡å¯æœåŠ¡: `pm2 restart zsxq-refund-api`
3. è¯·æ±‚æ¥å£

```bash
curl -X GET "https://zsxq.dc401.com/api/camps?scope=over" \
  -H "X-API-Key: your-secret-api-key-change-me-12345"

# é¢„æœŸå“åº”:
# {
#   "code": 403,
#   "message": "Cookie å·²è¿‡æœŸ,è¯·åœ¨å‰ç«¯é¡µé¢æ›´æ–° Cookie",
#   "data": null
# }
```

---

### 7.2 åŠŸèƒ½æµ‹è¯•

#### æµ‹è¯• 4: å‰ç«¯é¡µé¢æµ‹è¯•

| æµ‹è¯•é¡¹ | æ­¥éª¤ | é¢„æœŸç»“æœ | éªŒæ”¶æ ‡å‡† |
|--------|------|---------|----------|
| **è®­ç»ƒè¥åˆ—è¡¨** | è®¿é—®é¦–é¡µ â†’ é€‰æ‹©"å·²ç»“æŸ" â†’ ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨" | æ˜¾ç¤ºè®­ç»ƒè¥åˆ—è¡¨,çŠ¶æ€ä¸º"å·²ç»“æŸ" | âœ… åˆ—è¡¨åŠ è½½æˆåŠŸ,æ— æŠ¥é”™ |
| **Loading åŠ¨ç”»** | ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨" | æ˜¾ç¤º Loading åŠ¨ç”» | âœ… åŠ¨ç”»æ˜¾ç¤ºæ­£å¸¸ |
| **ç”Ÿæˆé€€æ¬¾åå•** | ç‚¹å‡»æŸä¸ªè®­ç»ƒè¥çš„"ç”Ÿæˆåå•" â†’ è¾“å…¥7å¤© â†’ ç‚¹å‡»"å¼€å§‹è®¡ç®—" | æ˜¾ç¤ºç¡®è®¤å¼¹çª— â†’ ç¡®è®¤åæ˜¾ç¤ºç»Ÿè®¡æ•°æ®å’Œè¯¦ç»†åå• | âœ… åˆæ ¼äººæ•°æ­£ç¡® |
| **æ•°æ®æ ¡éªŒ** | è¾“å…¥å¤©æ•°è¶…è¿‡æ€»å¤©æ•° â†’ ç‚¹å‡»"å¼€å§‹è®¡ç®—" | æç¤º"å®Œæˆå¤©æ•°ä¸èƒ½è¶…è¿‡è®­ç»ƒè¥æ€»å¤©æ•°" | âœ… æ ¡éªŒæç¤ºæ­£ç¡® |
| **ä¸€é”®å¤åˆ¶** | ç‚¹å‡»"ä¸€é”®å¤åˆ¶" | å¼¹å‡º"å·²å¤åˆ¶åˆ°å‰ªè´´æ¿",ç²˜è´´åä¸ºæ˜µç§°åˆ—è¡¨(é¡¿å·åˆ†éš”) | âœ… å¤åˆ¶æˆåŠŸ,æ ¼å¼æ­£ç¡® |
| **å¯¼å‡º Excel** | ç‚¹å‡»"å¯¼å‡º Excel" | ä¸‹è½½ Excel æ–‡ä»¶,åŒ…å«ç»Ÿè®¡ä¿¡æ¯å’Œè¯¦ç»†åå• | âœ… è¡¨å¤´æ·±è‰²+é»„è‰²,æ•°æ®å®Œæ•´ |
| **ä¸‹è½½å›¾ç‰‡** | ç‚¹å‡»"ä¸‹è½½å›¾ç‰‡" | ä¸‹è½½ PNG å›¾ç‰‡,åŒ…å«å®Œæ•´é¡µé¢å†…å®¹ | âœ… åˆ†è¾¨ç‡ 1200px,å†…å®¹æ¸…æ™° |
| **Cookie æ›´æ–°** | ç‚¹å‡»"æ›´æ–° Cookie" â†’ è¾“å…¥æ–° Cookie â†’ æäº¤ | æç¤º"Cookie æ›´æ–°æˆåŠŸ" | âœ… æ›´æ–°æˆåŠŸ,é‡æ–°è¯·æ±‚æ¥å£æ­£å¸¸ |
| **Cookie å¤±æ•ˆæç¤º** | åç«¯ Cookie å¤±æ•ˆ â†’ è¯·æ±‚æ¥å£ | å¼¹çª—æç¤º"çŸ¥è¯†æ˜Ÿçƒ Cookie å·²è¿‡æœŸ,è¯·ç‚¹å‡»å³ä¸Šè§’æ›´æ–° Cookie" | âœ… æç¤ºæ¸…æ™°,å¼•å¯¼æ­£ç¡® |

---

### 7.3 æ€§èƒ½æµ‹è¯•

#### æµ‹è¯• 5: å¹¶å‘æµ‹è¯•(4-5äººåŒæ—¶ä½¿ç”¨)

**æµ‹è¯•å·¥å…·**: Apache Bench (ab)

```bash
# å®‰è£… ab
sudo apt-get install apache2-utils

# å¹¶å‘æµ‹è¯•(5ä¸ªç”¨æˆ·,æ¯äºº10æ¬¡è¯·æ±‚)
ab -n 50 -c 5 \
  -H "X-API-Key: your-secret-api-key-change-me-12345" \
  https://zsxq.dc401.com/api/camps?scope=over

# é¢„æœŸç»“æœ:
# - æˆåŠŸç‡: 100%
# - å¹³å‡å“åº”æ—¶é—´: < 1ç§’
# - æœåŠ¡å™¨å†…å­˜å ç”¨: < 200MB
```

---

### 7.4 å…¼å®¹æ€§æµ‹è¯•

#### æµ‹è¯• 6: æµè§ˆå™¨å…¼å®¹æ€§

| æµè§ˆå™¨ | ç‰ˆæœ¬ | æµ‹è¯•ç»“æœ |
|--------|------|---------|
| Chrome | 120+ | âœ… å®Œå…¨æ”¯æŒ |
| Edge | 120+ | âœ… å®Œå…¨æ”¯æŒ |
| Firefox | 120+ | âœ… å®Œå…¨æ”¯æŒ |
| Safari | 16+ | âœ… å®Œå…¨æ”¯æŒ |

---

## å…«ã€é£é™©è¯„ä¼°ä¸åº”å¯¹æ–¹æ¡ˆ

### 8.1 é£é™©æ¸…å•

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ä¼˜å…ˆçº§ | åº”å¯¹æ–¹æ¡ˆ |
|------|--------|------|--------|---------|
| **çŸ¥è¯†æ˜Ÿçƒ Cookie å¤±æ•ˆ** | é«˜ | é«˜ | P0 | å‰ç«¯æä¾› Cookie æ›´æ–°ç•Œé¢,ç®¡ç†å‘˜æ‰‹åŠ¨æ›´æ–° `.env` æ–‡ä»¶ + è‡ªåŠ¨éªŒè¯ |
| **çŸ¥è¯†æ˜Ÿçƒ API é™æµ** | ä¸­ | ä¸­ | P1 | æ§åˆ¶è¯·æ±‚é¢‘ç‡(ç¿»é¡µé—´éš”200ms),å•æ¬¡æœ€å¤šç¿»2é¡µ(200äºº) |
| **å•ä¸ªè®­ç»ƒè¥è¶…è¿‡ 200 äºº** | ä½ | ä½ | P2 | æç¤ºç®¡ç†å‘˜åˆ†æ‰¹å¤„ç†,æˆ–æ‰©å±•ç¿»é¡µé€»è¾‘ |
| **æœåŠ¡å™¨èµ„æºä¸è¶³** | ä½ | ä¸­ | P2 | 2C4G è¶³å¤Ÿ(Node.js å•è¿›ç¨‹çº¦ 50MB å†…å­˜),å¯ç›‘æ§åæ‰©å®¹ |
| **HTTPS è¯ä¹¦è¿‡æœŸ** | ä½ | ä¸­ | P2 | Certbot è‡ªåŠ¨ç»­æœŸ,é…ç½® Cron å®šæœŸæ£€æŸ¥ |
| **API Key æ³„éœ²** | ä½ | é«˜ | P1 | å®šæœŸæ›´æ¢ API Key,ä»…å†…éƒ¨ä½¿ç”¨,ä¸å¯¹å¤–å…¬å¼€ |
| **çŸ¥è¯†æ˜Ÿçƒ API æ ¼å¼å˜æ›´** | ä½ | é«˜ | P1 | é™çº§æ–¹æ¡ˆ:æ‰‹åŠ¨å¯¼å…¥ Excel,åç«¯æ—¥å¿—è®°å½•åŸå§‹JSON |

---

### 8.2 Cookie å¤±æ•ˆå¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬1æ­¥: åç«¯æ£€æµ‹åˆ° Cookie å¤±æ•ˆ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ã€åç«¯ã€‘è°ƒç”¨çŸ¥è¯†æ˜Ÿçƒ API â†’ è¿”å› 401 Unauthorized
    â†“
ã€åç«¯ã€‘ZsxqService æ•è·é”™è¯¯ â†’ æŠ›å‡ºå¼‚å¸¸"Cookie å·²è¿‡æœŸ"
    â†“
ã€åç«¯ã€‘ErrorMiddleware æ‹¦æˆª â†’ è¿”å› 403 + æç¤ºä¿¡æ¯
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬2æ­¥: å‰ç«¯æ‹¦æˆªå™¨æ•è·å¹¶æç¤º                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ã€å‰ç«¯ã€‘Axios æ‹¦æˆªå™¨æ•è· 403 é”™è¯¯
    â†“
ã€å‰ç«¯ã€‘å¼¹çª—æç¤º:"çŸ¥è¯†æ˜Ÿçƒ Cookie å·²è¿‡æœŸ,è¯·ç‚¹å‡»å³ä¸Šè§’'æ›´æ–° Cookie'æŒ‰é’®"
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬3æ­¥: ç®¡ç†å‘˜æ‰‹åŠ¨æ›´æ–° Cookie                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ã€ç®¡ç†å‘˜ã€‘ç‚¹å‡»"æ›´æ–° Cookie" â†’ æ‰“å¼€é…ç½®å¼¹çª—
    â†“
ã€ç®¡ç†å‘˜ã€‘ç™»å½•çŸ¥è¯†æ˜Ÿçƒç½‘é¡µç‰ˆ â†’ F12 å¼€å‘è€…å·¥å…· â†’ Network
    â†“
ã€ç®¡ç†å‘˜ã€‘åˆ·æ–°é¡µé¢ â†’ æ‰¾åˆ° API è¯·æ±‚ â†’ å¤åˆ¶è¯·æ±‚å¤´:
    - x-timestamp
    - authorization
    - x-signature
    â†“
ã€ç®¡ç†å‘˜ã€‘å¡«å…¥è¡¨å• â†’ æäº¤
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬4æ­¥: åç«¯éªŒè¯å¹¶æ›´æ–°                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ã€åç«¯ã€‘æ¥æ”¶è¯·æ±‚ â†’ éªŒè¯å¿…å¡«å­—æ®µ
    â†“
ã€åç«¯ã€‘è¯»å– .env æ–‡ä»¶ â†’ æ›¿æ¢æ—§ Cookie â†’ å†™å›æ–‡ä»¶
    â†“
ã€åç«¯ã€‘é‡æ–°åŠ è½½ç¯å¢ƒå˜é‡: dotenv.config({ override: true })
    â†“
ã€åç«¯ã€‘éªŒè¯æ–° Cookie: è°ƒç”¨çŸ¥è¯†æ˜Ÿçƒ API æµ‹è¯•
    â†“
    â”œâ”€ éªŒè¯æˆåŠŸ â†’ è¿”å›"Cookie æ›´æ–°æˆåŠŸ"
    â””â”€ éªŒè¯å¤±è´¥ â†’ è¿”å›"Cookie æ›´æ–°å¤±è´¥: æ–° Cookie æ— æ•ˆ"
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬5æ­¥: å‰ç«¯æç¤ºå¹¶é‡æ–°è¯·æ±‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ã€å‰ç«¯ã€‘æç¤º"Cookie æ›´æ–°æˆåŠŸ" â†’ å…³é—­å¼¹çª—
    â†“
ã€ç®¡ç†å‘˜ã€‘é‡æ–°ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨" â†’ æ¥å£æ­£å¸¸è¿”å›æ•°æ®
```

---

### 8.3 çŸ¥è¯†æ˜Ÿçƒ API é™æµåº”å¯¹

**ç­–ç•¥**:
1. å•æ¬¡ç¿»é¡µæœ€å¤š 2 é¡µ(200 äºº)
2. æ¯æ¬¡ç¿»é¡µé—´éš” 200ms,é¿å…è§¦å‘é™æµ
3. å¦‚æœè¿”å› 429 é”™è¯¯,ç­‰å¾… 1 ç§’åé‡è¯• 1 æ¬¡

**ä»£ç ä¼˜åŒ–** (å·²åœ¨ zsxq.service.js ä¸­å®ç°):
```javascript
async getRankingList(checkinId) {
  const allRankings = [];
  let index = 0;
  const MAX_PAGES = 2; // æœ€å¤šç¿»2é¡µ(200äºº)

  while (index < MAX_PAGES) {
    const rankings = await this.fetchRankingPage(checkinId, index);
    allRankings.push(...rankings);

    if (rankings.length < 100) break;

    // å»¶è¿Ÿ 200ms,é¿å…é™æµ
    await new Promise(resolve => setTimeout(resolve, 200));
    index++;
  }

  return allRankings;
}
```

---

### 8.4 é™çº§æ–¹æ¡ˆ

**åœºæ™¯**: çŸ¥è¯†æ˜Ÿçƒ API å®Œå…¨ä¸å¯ç”¨

**åº”å¯¹æ–¹æ¡ˆ**:
1. ç®¡ç†å‘˜æ‰‹åŠ¨ä»çŸ¥è¯†æ˜Ÿçƒåå°å¯¼å‡ºæ‰“å¡æ•°æ®(Excel)
2. å‰ç«¯å¢åŠ "ä¸Šä¼  Excel"åŠŸèƒ½,ç›´æ¥è§£ææ–‡ä»¶ç”Ÿæˆé€€æ¬¾åå•
3. åç«¯è®°å½•åŸå§‹ JSON æ•°æ®åˆ°æ—¥å¿—,ä¾¿äºé—®é¢˜æ’æŸ¥

---

## ä¹ã€å¼€å‘æ’æœŸ

### 9.1 æ—¶é—´è§„åˆ’(4å¤©å®Œæˆ)

| é˜¶æ®µ | æ—¶é—´ | ä»»åŠ¡ | äº¤ä»˜ç‰© | éªŒæ”¶æ ‡å‡† |
|------|------|------|--------|---------|
| **Day 1 ä¸Šåˆ** | 4h | åç«¯é¡¹ç›®æ­å»º + æ ¸å¿ƒæ¥å£å¼€å‘ | å¯è¿è¡Œçš„åç«¯æœåŠ¡ | âœ… Postman æµ‹è¯•æ¥å£é€šè¿‡ |
| **Day 1 ä¸‹åˆ** | 4h | å‰ç«¯é¡¹ç›®æ­å»º + è®­ç»ƒè¥åˆ—è¡¨é¡µé¢ | å‰ç«¯é¡µé¢èƒ½æ˜¾ç¤ºè®­ç»ƒè¥åˆ—è¡¨ | âœ… æµè§ˆå™¨èƒ½è®¿é—®é¡µé¢ |
| **Day 2 ä¸Šåˆ** | 4h | é€€æ¬¾åå•é¡µé¢ + ç»Ÿè®¡æ•°æ®å±•ç¤º | èƒ½ç”Ÿæˆé€€æ¬¾åå•å¹¶æ˜¾ç¤ºç»Ÿè®¡ | âœ… æ•°æ®è®¡ç®—æ­£ç¡® |
| **Day 2 ä¸‹åˆ** | 4h | ä¸€é”®å¤åˆ¶ + Excelå¯¼å‡º + å›¾ç‰‡å¯¼å‡º | å®Œæˆæ‰€æœ‰å¯¼å‡ºåŠŸèƒ½ | âœ… å¯¼å‡ºåŠŸèƒ½æ­£å¸¸ |
| **Day 3 ä¸Šåˆ** | 4h | Cookie æ›´æ–°ç•Œé¢ + API Key é‰´æƒ | å®Œæˆå®‰å…¨åŠŸèƒ½ | âœ… Cookie æ›´æ–°æˆåŠŸ |
| **Day 3 ä¸‹åˆ** | 4h | éƒ¨ç½²åˆ°æœåŠ¡å™¨ + HTTPS é…ç½® | çº¿ä¸Šç¯å¢ƒå¯è®¿é—® | âœ… https://zsxq.dc401.com å¯è®¿é—® |
| **Day 4** | 8h | æµ‹è¯• + ä¿®å¤ Bug + æ–‡æ¡£ç¼–å†™ | æ­£å¼ä¸Šçº¿ | âœ… é€šè¿‡æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ |

---

### 9.2 ä¼˜å…ˆçº§æ’åº(æŒ‰éœ€æ±‚æ–‡æ¡£)

| ä¼˜å…ˆçº§ | åŠŸèƒ½ | å®Œæˆæ—¶é—´ | çŠ¶æ€ |
|--------|------|---------|------|
| P0 | è·å–è®­ç»ƒè¥åˆ—è¡¨ | Day 1 ä¸Šåˆ | âšª å¾…å¼€å‘ |
| P0 | ç”Ÿæˆé€€æ¬¾åå• | Day 2 ä¸Šåˆ | âšª å¾…å¼€å‘ |
| P1 | ä¸€é”®å¤åˆ¶åˆæ ¼äººå‘˜ | Day 2 ä¸‹åˆ | âšª å¾…å¼€å‘ |
| P1 | å¯¼å‡º Excel | Day 2 ä¸‹åˆ | âšª å¾…å¼€å‘ |
| P1 | ä¸‹è½½å›¾ç‰‡ | Day 2 ä¸‹åˆ | âšª å¾…å¼€å‘ |
| P1 | Cookie å¤±æ•ˆæ£€æµ‹ | Day 3 ä¸Šåˆ | âšª å¾…å¼€å‘ |
| P1 | API é‰´æƒ | Day 3 ä¸Šåˆ | âšª å¾…å¼€å‘ |
| P2 | æ•°æ®ç¼“å­˜ | âŒ v0 ä¸å®ç° | ç•™å¾… v1 |

---

### 9.3 å…³é”®é‡Œç¨‹ç¢‘

- **Day 1 ç»“æŸ**: å‰åç«¯èƒ½è”è°ƒ,è®­ç»ƒè¥åˆ—è¡¨é¡µé¢å¯è®¿é—®
- **Day 2 ç»“æŸ**: æ ¸å¿ƒåŠŸèƒ½å®Œæˆ,èƒ½ç”Ÿæˆé€€æ¬¾åå•å¹¶å¯¼å‡º
- **Day 3 ç»“æŸ**: éƒ¨ç½²åˆ°çº¿ä¸Š,HTTPS é…ç½®å®Œæˆ
- **Day 4 ç»“æŸ**: é€šè¿‡æ‰€æœ‰æµ‹è¯•,æ­£å¼ä¸Šçº¿

---

## åã€æ€»ç»“

### 10.1 æŠ€æœ¯äº®ç‚¹

1. **æ— æ•°æ®åº“æ¶æ„**: é™ä½å¤æ‚åº¦,å¿«é€Ÿä¸Šçº¿,é€‚åˆ v0 MVP ç‰ˆæœ¬
2. **è‡ªåŠ¨ç¿»é¡µ**: æ”¯æŒ 200 äººè®­ç»ƒè¥,è‡ªåŠ¨åˆå¹¶æ•°æ®,æ— éœ€æ‰‹åŠ¨æ“ä½œ
3. **Cookie åŠ¨æ€æ›´æ–°**: å‰ç«¯ç•Œé¢æ‰‹åŠ¨æ›´æ–°,æ— éœ€ç™»å½•æœåŠ¡å™¨,é™ä½è¿ç»´æˆæœ¬
4. **å‰ç«¯å¯¼å‡º**: Excel å’Œå›¾ç‰‡éƒ½åœ¨å‰ç«¯ç”Ÿæˆ,å‡è½»åç«¯å‹åŠ›,æå‡æ€§èƒ½
5. **ç»Ÿä¸€é”™è¯¯å¤„ç†**: æ¸…æ™°çš„é”™è¯¯æç¤º,ä¾¿äºæ’æŸ¥é—®é¢˜,æå‡ç”¨æˆ·ä½“éªŒ
6. **API Key é‰´æƒ**: ç®€å•æœ‰æ•ˆçš„å®‰å…¨æœºåˆ¶,é€‚åˆå†…éƒ¨ç³»ç»Ÿ
7. **æ—¥å¿—è‡ªåŠ¨æ¸…ç†**: 3 å¤©è‡ªåŠ¨æ¸…ç†,èŠ‚çœç£ç›˜ç©ºé—´

---

### 10.2 æ¶æ„ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **å¼€å‘é€Ÿåº¦å¿«** | Node.js + Express + Element Plus,2å¤©å®Œæˆæ ¸å¿ƒåŠŸèƒ½ |
| **èµ„æºå ç”¨ä½** | 2C4G æœåŠ¡å™¨è¶³å¤Ÿ,Node.js å•è¿›ç¨‹çº¦ 50MB å†…å­˜ |
| **éƒ¨ç½²ç®€å•** | `npm install` + `pm2 start`,æ— éœ€æ•°æ®åº“ã€Docker ç­‰å¤æ‚é…ç½® |
| **æ˜“äºç»´æŠ¤** | å‰åç«¯ç»Ÿä¸€ JavaScript,ä»£ç å¯è¯»æ€§é«˜,ä¾¿äºåç»­è¿­ä»£ |
| **å®‰å…¨å¯é ** | HTTPS + API Key + Cookie åŠ¨æ€æ›´æ–°,æ»¡è¶³å†…éƒ¨ä½¿ç”¨éœ€æ±‚ |

---

### 10.3 åç»­ä¼˜åŒ–æ–¹å‘(v1 ç‰ˆæœ¬)

1. **å¼•å…¥æ•°æ®åº“**(PostgreSQL):å­˜å‚¨å†å²æ•°æ®,æ”¯æŒæ•°æ®åˆ†æ
2. **å¯¹æ¥ä¼ä¸šå¾®ä¿¡æ”¯ä»˜ API**:å®ç°è‡ªåŠ¨é€€æ¬¾,å‡å°‘äººå·¥æ“ä½œ
3. **å¢åŠ ç”¨æˆ·è®¤è¯**(JWT):å¤šç®¡ç†å‘˜è´¦å·,è§’è‰²æƒé™ç®¡ç†
4. **å¢åŠ æ•°æ®ç¼“å­˜**(Redis):æå‡æ€§èƒ½,å‡å°‘çŸ¥è¯†æ˜Ÿçƒ API è°ƒç”¨é¢‘ç‡
5. **å¢åŠ å®šæ—¶ä»»åŠ¡**:è‡ªåŠ¨åŒæ­¥æ‰“å¡æ•°æ®,è‡ªåŠ¨ç”Ÿæˆé€€æ¬¾åå•
6. **å¢åŠ æ—¥å¿—ç›‘æ§**(é˜¿é‡Œäº‘æ—¥å¿—æœåŠ¡):å®æ—¶ç›‘æ§,å¿«é€Ÿå®šä½é—®é¢˜
7. **å¢åŠ ä¼šå‘˜åŒ¹é…ç®—æ³•**:è‡ªåŠ¨åŒ¹é…ä¼ä¸šå¾®ä¿¡æ”¯ä»˜è®°å½•å’ŒçŸ¥è¯†æ˜Ÿçƒç”¨æˆ·

---

### 10.4 å…³é”®æˆåŠŸå› ç´ 

1. **æŠ€æœ¯é€‰å‹æ­£ç¡®**: Node.js + Express + Element Plus,é€‚åˆå¿«é€Ÿå¼€å‘
2. **éœ€æ±‚æ˜ç¡®**: 2å¤©æ ¸å¿ƒåŠŸèƒ½,4å¤©å®Œæ•´ä¸Šçº¿,ç›®æ ‡æ¸…æ™°
3. **é£é™©å¯æ§**: Cookie å¤±æ•ˆã€API é™æµç­‰é£é™©éƒ½æœ‰åº”å¯¹æ–¹æ¡ˆ
4. **æµ‹è¯•å……åˆ†**: æ¥å£æµ‹è¯•ã€åŠŸèƒ½æµ‹è¯•ã€æ€§èƒ½æµ‹è¯•å…¨è¦†ç›–
5. **æ–‡æ¡£å®Œå–„**: æŠ€æœ¯æ–¹æ¡ˆã€éƒ¨ç½²æ‰‹å†Œã€æµ‹è¯•æ–¹æ¡ˆé½å…¨

---

## é™„å½•

### A1. ç¯å¢ƒå˜é‡é…ç½®ç¤ºä¾‹

**.env.example**(åç«¯):
```bash
# çŸ¥è¯†æ˜Ÿçƒé…ç½®
ZSXQ_GROUP_ID=15555411412112
ZSXQ_TIMESTAMP=
ZSXQ_AUTHORIZATION=
ZSXQ_SIGNATURE=

# API Key é…ç½®
API_KEY=

# æœåŠ¡é…ç½®
PORT=3013
NODE_ENV=production
```

**.env.development**(å‰ç«¯):
```bash
VITE_API_KEY=your-secret-api-key-change-me-12345
```

---

### A2. PM2 å¸¸ç”¨å‘½ä»¤

```bash
# å¯åŠ¨æœåŠ¡
pm2 start ecosystem.config.js

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs zsxq-refund-api

# é‡å¯æœåŠ¡
pm2 restart zsxq-refund-api

# åœæ­¢æœåŠ¡
pm2 stop zsxq-refund-api

# åˆ é™¤æœåŠ¡
pm2 delete zsxq-refund-api

# ä¿å­˜é…ç½®(å¼€æœºè‡ªå¯)
pm2 save

# æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
pm2 show zsxq-refund-api

# ç›‘æ§
pm2 monit
```

---

### A3. Nginx å¸¸ç”¨å‘½ä»¤

```bash
# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯æœåŠ¡
sudo systemctl restart nginx

# é‡æ–°åŠ è½½é…ç½®(ä¸ä¸­æ–­æœåŠ¡)
sudo systemctl reload nginx

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status nginx

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log

# æŸ¥çœ‹è®¿é—®æ—¥å¿—
sudo tail -f /var/log/nginx/zsxq-refund-access.log
```

---

### A4. å‚è€ƒæ–‡æ¡£

| ç±»å‹ | é“¾æ¥ |
|------|------|
| **Node.js å®˜æ–¹æ–‡æ¡£** | https://nodejs.org/docs/ |
| **Express.js å®˜æ–¹æ–‡æ¡£** | https://expressjs.com/ |
| **Vue 3 å®˜æ–¹æ–‡æ¡£** | https://vuejs.org/ |
| **Element Plus å®˜æ–¹æ–‡æ¡£** | https://element-plus.org/ |
| **Let's Encrypt å®˜æ–¹æ–‡æ¡£** | https://letsencrypt.org/ |
| **PM2 å®˜æ–¹æ–‡æ¡£** | https://pm2.keymetrics.io/ |
| **Nginx å®˜æ–¹æ–‡æ¡£** | https://nginx.org/en/docs/ |

---

**æ–‡æ¡£ç»“æŸ**

---

**ç‰ˆæœ¬å†å²**:
- v0.1 (2025-10-26): åˆå§‹ç‰ˆæœ¬,å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆ