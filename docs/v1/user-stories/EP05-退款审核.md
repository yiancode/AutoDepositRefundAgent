# EP05: 退款审核

## Epic 概述

| 字段 | 内容 |
|------|------|
| **Epic ID** | EP05 |
| **Epic 名称** | 退款审核 |
| **业务目标** | 管理员能够高效地审核和执行退款 |
| **涉及角色** | 管理员、系统 |
| **优先级** | P0 |

---

## Story 5.1: 生成退款名单

| 字段 | 内容 |
|------|------|
| **Story ID** | S5.1 |
| **角色** | 作为一名管理员 |
| **目标** | 我希望能够生成训练营的退款名单 |
| **价值** | 以便于开始退款审核流程 |
| **优先级** | P0 |

### 验收标准

```gherkin
Feature: 生成退款名单
  作为一名管理员
  我希望能够生成训练营的退款名单
  以便于开始退款审核流程

  Background:
    Given 管理员已登录
    And 训练营状态为 "已结束"

  Scenario: 成功生成退款名单
    Given 选择训练营 "21天早起打卡"
    When 点击 "生成退款名单" 按钮
    Then 系统获取打卡统计
    And 筛选合格用户
    And 执行身份匹配
    And 返回退款名单统计

  Scenario: 显示匹配统计
    Given 退款名单生成完成
    Then 显示总合格人数
    And 显示高置信度匹配数（>=80%）
    And 显示待审核匹配数（50-79%）
    And 显示匹配失败数（<50%）
    And 显示自动通过的退款金额

  Scenario: 训练营未结束
    Given 训练营状态为 "进行中"
    When 尝试生成退款名单
    Then 返回错误 "训练营尚未结束"

  Scenario: 已生成过名单
    Given 已生成过退款名单
    When 再次点击生成
    Then 提示 "是否重新生成？（将覆盖现有名单）"
```

### 任务拆分

- [ ] Task 5.1.1: 实现生成退款名单接口
- [ ] Task 5.1.2: 集成打卡统计服务
- [ ] Task 5.1.3: 集成匹配服务
- [ ] Task 5.1.4: 实现统计汇总
- [ ] Task 5.1.5: 编写测试用例

---

## Story 5.2: 查看退款名单

| 字段 | 内容 |
|------|------|
| **Story ID** | S5.2 |
| **角色** | 作为一名管理员 |
| **目标** | 我希望能够查看退款名单详情 |
| **价值** | 以便于了解每条退款记录的状态 |
| **优先级** | P0 |

### 验收标准

```gherkin
Feature: 查看退款名单
  作为一名管理员
  我希望能够查看退款名单详情
  以便于了解每条退款记录的状态

  Scenario: 查看全部列表
    Given 进入退款名单页面
    Then 显示所有退款记录
    And 每条记录显示：会员昵称、打卡天数、匹配置信度、退款状态

  Scenario: 按状态筛选
    Given 选择状态筛选为 "待审核"
    When 查询列表
    Then 只显示状态为 "待审核" 的记录

  Scenario: 按置信度筛选
    Given 选择置信度筛选为 "低（<50%）"
    When 查询列表
    Then 只显示置信度低于 50% 的记录

  Scenario: 查看匹配详情
    Given 点击某条退款记录
    Then 显示详细信息
    And 显示匹配依据（昵称对比、ID对比）
    And 显示置信度评分明细
```

### 任务拆分

- [ ] Task 5.2.1: 实现退款名单查询接口
- [ ] Task 5.2.2: 实现分页和筛选
- [ ] Task 5.2.3: 实现详情查询
- [ ] Task 5.2.4: 实现管理后台页面

---

## Story 5.3: 审核退款

| 字段 | 内容 |
|------|------|
| **Story ID** | S5.3 |
| **角色** | 作为一名管理员 |
| **目标** | 我希望能够审核退款记录 |
| **价值** | 以便于确认或拒绝退款申请 |
| **优先级** | P0 |

### 验收标准

```gherkin
Feature: 审核退款
  作为一名管理员
  我希望能够审核退款记录
  以便于确认或拒绝退款申请

  Background:
    Given 管理员已登录
    And 存在待审核的退款记录

  Scenario: 单条审核通过
    Given 选择一条待审核记录
    When 点击 "通过" 按钮
    Then 记录状态变为 "审核通过"
    And 加入待执行队列

  Scenario: 单条审核拒绝
    Given 选择一条待审核记录
    When 点击 "拒绝" 按钮
    And 填写拒绝原因 "打卡记录异常"
    Then 记录状态变为 "审核拒绝"
    And 保存拒绝原因

  Scenario: 批量审核通过
    Given 选择多条待审核记录
    When 点击 "批量通过" 按钮
    Then 所有选中记录状态变为 "审核通过"
    And 加入待执行队列

  Scenario: 批量审核拒绝
    Given 选择多条待审核记录
    When 点击 "批量拒绝" 按钮
    And 填写统一拒绝原因
    Then 所有选中记录状态变为 "审核拒绝"

  Scenario: 全部通过
    Given 当前页面有 50 条待审核记录
    When 点击 "全部通过" 按钮
    And 确认操作
    Then 所有待审核记录状态变为 "审核通过"
```

### 任务拆分

- [ ] Task 5.3.1: 实现单条审核接口
- [ ] Task 5.3.2: 实现批量审核接口
- [ ] Task 5.3.3: 实现审核记录日志
- [ ] Task 5.3.4: 编写测试用例

---

## Story 5.4: 执行退款

| 字段 | 内容 |
|------|------|
| **Story ID** | S5.4 |
| **角色** | 作为系统 |
| **目标** | 我需要自动执行审核通过的退款 |
| **价值** | 以便于将押金退还给会员 |
| **优先级** | P0 |

### 验收标准

```gherkin
Feature: 执行退款
  作为系统
  我需要自动执行审核通过的退款
  以便于将押金退还给会员

  Background:
    Given 存在审核通过的退款记录
    And 商户账户余额充足

  Scenario: 正常退款
    Given 退款金额为 99 元
    When 执行退款
    Then 调用微信支付退款 API
    And 返回成功
    And 状态变为 "退款成功"
    And 发送退款通知给会员

  Scenario: 退款失败 - 余额不足
    Given 商户账户余额为 50 元
    And 退款金额为 99 元
    When 执行退款
    Then 返回失败
    And 状态变为 "退款失败"
    And 失败原因为 "商户余额不足"
    And 发送告警通知

  Scenario: 退款失败后重试
    Given 存在退款失败的记录
    And 失败原因为网络超时
    When 自动重试（最多3次）
    And 第2次重试成功
    Then 状态变为 "退款成功"

  Scenario: 重试全部失败
    Given 连续重试 3 次失败
    When 重试完成
    Then 状态变为 "退款失败"
    And 标记为需要人工处理
    And 发送告警通知

  Scenario: 批量退款限流
    Given 有 100 条待执行退款
    When 执行批量退款
    Then 按限流规则分批执行
    And 每批间隔 1 秒
    And 避免触发微信限流
```

### 任务拆分

- [ ] Task 5.4.1: 实现退款执行服务
- [ ] Task 5.4.2: 集成微信支付退款 API
- [ ] Task 5.4.3: 实现重试机制
- [ ] Task 5.4.4: 实现限流控制
- [ ] Task 5.4.5: 实现退款通知
- [ ] Task 5.4.6: 编写测试用例

---

## Story 5.5: 退款失败处理

| 字段 | 内容 |
|------|------|
| **Story ID** | S5.5 |
| **角色** | 作为一名管理员 |
| **目标** | 我希望能够处理退款失败的记录 |
| **价值** | 以便于确保所有应退款项都得到处理 |
| **优先级** | P1 |

### 验收标准

```gherkin
Feature: 退款失败处理
  作为一名管理员
  我希望能够处理退款失败的记录
  以便于确保所有应退款项都得到处理

  Scenario: 查看失败列表
    Given 存在退款失败的记录
    When 进入失败处理页面
    Then 显示所有失败记录
    And 显示失败原因
    And 显示失败时间

  Scenario: 手动重试
    Given 选择一条失败记录
    And 失败原因为网络超时
    When 点击 "重试" 按钮
    Then 重新执行退款
    And 更新状态

  Scenario: 标记为已处理
    Given 选择一条失败记录
    And 已通过其他方式（如线下转账）完成退款
    When 点击 "标记已处理" 按钮
    And 填写处理说明
    Then 状态变为 "已手动处理"

  Scenario: 查看处理历史
    Given 选择一条退款记录
    When 查看历史
    Then 显示所有操作记录
    And 包括：操作时间、操作人、操作类型、结果
```

### 任务拆分

- [ ] Task 5.5.1: 实现失败列表查询
- [ ] Task 5.5.2: 实现手动重试接口
- [ ] Task 5.5.3: 实现标记已处理功能
- [ ] Task 5.5.4: 实现操作历史记录
- [ ] Task 5.5.5: 编写测试用例

---

## 接口设计

### 生成退款名单

```
POST /api/admin/camps/{campId}/refund-list

Response:
{
  "code": 200,
  "data": {
    "totalQualified": 120,
    "highConfidence": 100,
    "pendingReview": 15,
    "matchFailed": 5,
    "autoApprovedAmount": 9900
  }
}
```

### 审核退款

```
POST /api/admin/refunds/batch-approve

Request:
{
  "refundIds": [1, 2, 3],
  "action": "approve"  // approve | reject
  "reason": "string"   // reject 时必填
}

Response:
{
  "code": 200,
  "data": {
    "successCount": 3,
    "failedCount": 0
  }
}
```

### 执行退款

```
POST /api/admin/refunds/{refundId}/execute

Response:
{
  "code": 200,
  "data": {
    "refundId": "REFUND123",
    "status": "SUCCESS",
    "wechatRefundId": "WX123456"
  }
}
```

---

## 相关文档

- [技术方案 v1](../技术方案.md)
- [EP04: 身份匹配](./EP04-身份匹配.md)
- [EP06: 统计报表](./EP06-统计报表.md)
