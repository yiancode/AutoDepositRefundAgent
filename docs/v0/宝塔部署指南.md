# 宝塔服务器部署指南 - v0 版本

> **部署方式**: 上传完整源码,在服务器上构建和运行
> **域名**: zsxq.dc401.com
> **环境**: 宝塔面板 + Node.js 18+ + PM2 + Nginx

---

## 📋 部署前准备清单

### 1. 服务器环境检查

登录宝塔 SSH 终端,执行以下命令检查环境:

```bash
# 检查 Node.js 版本 (需要 18+)
node -v

# 检查 npm 版本
npm -v

# 检查 PM2 (进程管理器)
pm2 -v

# 如果缺少 PM2,安装它
npm install -g pm2
```

**环境要求**:
- ✅ Node.js 18+ (宝塔面板 → 软件商店 → Node 版本管理器)
- ✅ npm 9+
- ✅ PM2 (进程管理器)
- ✅ Nginx (宝塔自带)

### 2. 创建网站根目录

在宝塔面板创建网站:

1. **添加网站**: 宝塔面板 → 网站 → 添加站点
   - 域名: `zsxq.dc401.com`
   - 根目录: `/www/wwwroot/zsxq.dc401.com`
   - PHP 版本: 纯静态 (不需要 PHP)
   - 数据库: 不创建

2. **申请 SSL 证书** (如需 HTTPS):
   - 宝塔面板 → 网站 → zsxq.dc401.com → SSL → Let's Encrypt
   - 点击"申请"按钮

### 3. 准备知识星球 Cookie

从浏览器获取知识星球 API 凭证:

1. 浏览器登录 [知识星球](https://wx.zsxq.com)
2. 打开 DevTools (F12) → Network
3. 刷新页面,找到 `checkins` 请求
4. 复制 Request Headers 中的以下字段:
   - `x-timestamp`
   - `authorization`
   - `x-signature`

---

## 🚀 部署步骤

### 步骤 1: 上传源码到服务器

使用宝塔文件管理器或 SFTP 工具上传代码:

```bash
# 目标目录结构
/www/wwwroot/zsxq.dc401.com/
├── zsxq-api/          # 后端源码
│   ├── src/
│   ├── package.json
│   ├── deploy.sh      # 部署脚本
│   └── ecosystem.config.js
└── zsxq-web/          # 前端源码
    ├── src/
    ├── package.json
    └── deploy.sh      # 部署脚本
```

**上传方式**:
- **方式 1 (推荐)**: 宝塔文件管理器上传 ZIP 压缩包,解压
- **方式 2**: SFTP 工具 (FileZilla / WinSCP)
- **方式 3**: Git 克隆 (如果代码已推送到 Git 仓库)

```bash
# 使用 Git 方式 (可选)
cd /www/wwwroot/zsxq.dc401.com
git clone https://github.com/YOUR_REPO.git .
```

### 步骤 2: 配置后端环境变量

在宝塔 SSH 终端执行:

```bash
cd /www/wwwroot/zsxq.dc401.com/zsxq-api

# 复制环境变量模板
cp .env.example .env

# 编辑环境变量
vi .env
```

修改 `.env` 文件内容:

```env
# 服务端口
PORT=3013
NODE_ENV=production

# 知识星球 API 凭证 (从浏览器 DevTools 获取)
ZSXQ_GROUP_ID=15555411412112
ZSXQ_X_TIMESTAMP=1730000000
ZSXQ_AUTHORIZATION=Bearer xxxxxxxxxx
ZSXQ_X_SIGNATURE=xxxxxxxxxx
```

**保存方式**:
- vi 编辑器: 按 `i` 进入编辑模式 → 修改内容 → 按 `ESC` → 输入 `:wq` → 回车

### 步骤 3: 部署后端服务

```bash
cd /www/wwwroot/zsxq.dc401.com/zsxq-api

# 执行部署脚本
bash deploy.sh
```

**部署脚本会自动执行**:
1. 安装 npm 依赖
2. 检查环境变量配置
3. 停止旧服务 (如果存在)
4. 使用 PM2 启动新服务
5. 执行健康检查

**预期输出**:

```
==========================================
✅ 部署完成!
==========================================

📊 服务状态:
┌────┬────────────┬─────────────┬─────────┬─────────┬──────────┐
│ id │ name       │ mode        │ ↺       │ status  │ cpu      │
├────┼────────────┼─────────────┼─────────┼─────────┼──────────┤
│ 0  │ zsxq-api   │ fork        │ 0       │ online  │ 0%       │
└────┴────────────┴─────────────┴─────────┴─────────┴──────────┘

✅ 健康检查通过 - 服务运行正常
```

**常用 PM2 命令**:

```bash
pm2 list                # 查看服务状态
pm2 logs zsxq-api       # 查看实时日志
pm2 logs zsxq-api --err # 查看错误日志
pm2 restart zsxq-api    # 重启服务
pm2 stop zsxq-api       # 停止服务
```

### 步骤 4: 部署前端应用

```bash
cd /www/wwwroot/zsxq.dc401.com/zsxq-web

# 执行部署脚本
bash deploy.sh
```

**部署脚本会自动执行**:
1. 安装 npm 依赖
2. 构建生产版本 (`npm run build`)
3. 生成 `dist/` 目录

**预期输出**:

```
==========================================
✅ 部署完成!
==========================================

📁 构建产物目录: /www/wwwroot/zsxq.dc401.com/zsxq-web/dist
文件数量: 23
总大小: 1.2M
```

### 步骤 5: 配置 Nginx 反向代理

1. **打开配置文件**:
   - 宝塔面板 → 网站 → zsxq.dc401.com → 设置 → 配置文件

2. **替换配置内容**:
   - 复制 `docs/v0/nginx-baota.conf` 的内容
   - 粘贴到配置文件中
   - 点击"保存"

3. **核心配置说明**:

```nginx
# 网站根目录 - 指向前端构建产物
root /www/wwwroot/zsxq.dc401.com/zsxq-web/dist;

# 后端 API 反向代理
location /api/ {
    proxy_pass http://127.0.0.1:3013;
}

# Vue Router History 模式支持
location / {
    try_files $uri $uri/ /index.html;
}
```

4. **重载 Nginx**:

```bash
nginx -t                # 检查配置语法
nginx -s reload         # 重载配置
```

或使用宝塔面板:
- 软件商店 → Nginx → 设置 → 重载配置

### 步骤 6: 验证部署

#### 6.1 检查后端服务

```bash
# 健康检查
curl http://localhost:3013/health

# 预期响应:
# {"code":200,"message":"服务运行正常","timestamp":1730000000000}
```

#### 6.2 检查前端静态文件

```bash
# 检查 index.html 是否存在
ls -lh /www/wwwroot/zsxq.dc401.com/zsxq-web/dist/index.html
```

#### 6.3 浏览器访问测试

打开浏览器访问:

1. **前端页面**: https://zsxq.dc401.com
   - 应该能看到训练营列表页面

2. **API 接口**: https://zsxq.dc401.com/api/health
   - 应该返回 JSON: `{"code":200,"message":"服务运行正常"}`

3. **测试完整流程**:
   - 点击"查看详情"按钮
   - 生成退款名单
   - 导出 Excel / 复制名单

---

## 🔧 故障排查

### 问题 1: 后端服务启动失败

**症状**: PM2 显示 `errored` 或 `stopped`

**排查步骤**:

```bash
# 查看错误日志
pm2 logs zsxq-api --err --lines 50

# 常见原因:
# 1. 端口 3013 被占用
lsof -ti:3013

# 2. .env 配置错误
cat .env | grep ZSXQ

# 3. 依赖安装失败
cd /www/wwwroot/zsxq.dc401.com/zsxq-api
rm -rf node_modules package-lock.json
npm install
```

### 问题 2: 前端页面 404

**症状**: 访问域名显示 404 Not Found

**排查步骤**:

```bash
# 1. 检查 dist 目录是否存在
ls -lh /www/wwwroot/zsxq.dc401.com/zsxq-web/dist/

# 2. 检查 Nginx 配置
nginx -t

# 3. 检查 Nginx 根目录配置
grep "root" /www/server/panel/vhost/nginx/zsxq.dc401.com.conf

# 4. 重新构建前端
cd /www/wwwroot/zsxq.dc401.com/zsxq-web
npm run build
```

### 问题 3: API 接口 502 错误

**症状**: 前端调用 API 返回 502 Bad Gateway

**排查步骤**:

```bash
# 1. 检查后端服务是否运行
pm2 list | grep zsxq-api

# 2. 检查端口是否监听
netstat -tlnp | grep 3013

# 3. 测试本地连接
curl http://127.0.0.1:3013/health

# 4. 检查 Nginx 反向代理配置
grep "proxy_pass" /www/server/panel/vhost/nginx/zsxq.dc401.com.conf
```

### 问题 4: 知识星球 Cookie 过期

**症状**: 生成退款名单时报错 401 Unauthorized

**解决方案**:

1. 重新从浏览器获取 Cookie (参考"部署前准备清单 → 3")
2. 更新 `.env` 文件
3. 重启后端服务:

```bash
cd /www/wwwroot/zsxq.dc401.com/zsxq-api
vi .env    # 更新 Cookie
pm2 restart zsxq-api
```

### 问题 5: 前端路由刷新 404

**症状**: 访问 `https://zsxq.dc401.com/camps/xxx` 刷新后 404

**原因**: Nginx 未配置 Vue Router History 模式支持

**解决方案**:

检查 Nginx 配置是否包含:

```nginx
location / {
    try_files $uri $uri/ /index.html;
}
```

---

## 📊 性能优化建议

### 1. 启用 Gzip 压缩

Nginx 配置已包含 Gzip 配置,确保已启用:

```nginx
gzip on;
gzip_types text/plain text/css application/json application/javascript;
```

### 2. 静态资源缓存

```nginx
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
}
```

### 3. PM2 Cluster 模式 (可选)

如果流量较大,可以使用 PM2 Cluster 模式:

```bash
# 修改 ecosystem.config.js
instances: 2,  # 启动 2 个实例
exec_mode: 'cluster'

# 重启服务
pm2 reload zsxq-api
```

---

## 🔄 更新部署

### 更新后端代码

```bash
cd /www/wwwroot/zsxq.dc401.com/zsxq-api

# 拉取最新代码 (如果使用 Git)
git pull

# 重新部署
bash deploy.sh
```

### 更新前端代码

```bash
cd /www/wwwroot/zsxq.dc401.com/zsxq-web

# 拉取最新代码 (如果使用 Git)
git pull

# 重新构建
bash deploy.sh
```

---

## 🔐 安全加固建议

### 1. 限制 API 访问频率

在宝塔面板安装"Nginx 防火墙"插件,设置 API 访问频率限制:

- 路径: `/api/*`
- 限制: 60 次/分钟

### 2. 配置 HTTPS 强制跳转

Nginx 配置已包含 HTTPS 强制跳转:

```nginx
if ($server_port !~ 443){
    rewrite ^(/.*)$ https://$host$1 permanent;
}
```

### 3. 禁止访问敏感文件

```nginx
location ~* \.(env|git|gitignore)$ {
    deny all;
}
```

### 4. 定期更新知识星球 Cookie

建议每月更新一次 Cookie,防止过期导致服务中断。

---

## 📞 技术支持

### 查看服务状态

```bash
# 后端服务
pm2 list
pm2 logs zsxq-api

# Nginx 服务
systemctl status nginx
nginx -t

# 查看资源占用
htop
```

### 日志位置

- **后端日志**: `/www/wwwroot/zsxq.dc401.com/zsxq-api/logs/`
- **PM2 日志**: `~/.pm2/logs/`
- **Nginx 访问日志**: `/www/wwwlogs/zsxq.dc401.com.log`
- **Nginx 错误日志**: `/www/wwwlogs/zsxq.dc401.com.error.log`

---

## ✅ 部署完成检查清单

- [ ] 后端服务运行正常 (`pm2 list` 显示 `online`)
- [ ] 健康检查通过 (`curl http://localhost:3013/health`)
- [ ] 前端页面可以访问 (`https://zsxq.dc401.com`)
- [ ] API 接口可以访问 (`https://zsxq.dc401.com/api/health`)
- [ ] 功能测试通过 (生成退款名单、导出 Excel)
- [ ] SSL 证书配置正确 (HTTPS 生效)
- [ ] Nginx 配置无语法错误 (`nginx -t`)
- [ ] PM2 进程保存 (`pm2 save`)

---

**部署完成!** 🎉

如有问题,请查看"故障排查"章节或联系技术支持。
