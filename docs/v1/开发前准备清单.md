# v1 版本开发前准备清单

**创建时间**: 2025-12-02
**版本**: v1.0 完整生产级系统
**预计开发周期**: 27 天（6 个 Stage + 集成测试）

> **对齐文档**：本清单严格对应《技术方案.md》、《接口文档.md》、《数据库设计.md》

---

## 📋 清单概览

| 类别 | 项目数 | 优先级 | 预计准备时间 |
|------|--------|--------|-------------|
| 🔐 微信支付配置 | 3 项 | ⭐⭐⭐ 必须 | 30 分钟 |
| 🔑 微信公众号OAuth配置 | 4 项 | ⭐⭐⭐ 必须 | 30 分钟 |
| 🌐 服务器环境 | 5 项 | ⭐⭐⭐ 必须 | 1-2 天（购买+配置） |
| 💾 数据库环境 | 2 项 | ⭐⭐⭐ 必须 | 1 小时 |
| 🔧 开发工具 | 4 项 | ⭐⭐⭐ 必须 | 2 小时 |
| 🐰 消息队列环境 | 4 项 | ⭐ 可选 | 30 分钟 |
| 💻 前端开发环境 | 4 项 | ⭐⭐⭐ 必须 | 1 小时 |
| 📦 第三方服务 | 3 项 | ⭐⭐ 推荐 | 1 小时 |
| 📝 业务数据 | 2 项 | ⭐⭐ 推荐 | 提前准备 |
| 🎨 UI资源 | 3 项 | ⭐ 可选 | 1-2 天（设计） |

**总计准备时间**: 4-6 天（含服务器采购和设计资源）

---

## 🔐 一、微信支付配置（必须，30分钟）

### ✅ 您已确认拥有的信息

根据您提供的商户平台截图，您已经有：
- ✅ 正式微信支付商户号
- ✅ 已开通 JSAPI 支付、Native 支付
- ✅ 有 API 安全配置权限

### 📦 需要获取的 3 项配置

#### 1.1 商户号 (MCHID)

**获取路径**:
```
登录 https://pay.weixin.qq.com
→ 账户中心 → 商户信息
→ 复制"商户号"（10位数字）
```

**示例**: `1234567890`

**用途**: 所有微信支付 API 调用的身份标识

---

#### 1.2 API 证书（重要！）

**获取路径**:
```
登录 https://pay.weixin.qq.com
→ 账户中心 → API安全 → 申请API证书
→ 下载"证书工具"（Windows/Mac）
→ 输入商户号 → 扫码验证
→ 自动生成 3 个文件
```

**需要的文件**:
- `apiclient_cert.pem` - 商户 API 证书（公钥）
- `apiclient_key.pem` - 商户私钥（⚠️ 极其重要）
- 证书序列号 - 配置时需要填写（工具会显示）

**存储位置**:
- 开发环境: `backend/src/main/resources/certs/`
- 生产环境: 服务器 `/opt/camp/certs/`（权限 600）

**安全提醒**:
- ❌ 绝对不能提交到 Git
- ❌ 不能通过邮件/聊天发送
- ✅ 使用加密压缩包传输
- ✅ 服务器文件权限设为 600

---

#### 1.3 API v3 密钥

**获取路径**:
```
登录 https://pay.weixin.qq.com
→ 账户中心 → API安全 → 设置APIv3密钥
→ 输入 32 位字符串（自定义）
→ 保存（⚠️ 只显示一次！）
```

**生成方式**:
```bash
# macOS/Linux 命令行生成
openssl rand -base64 32 | head -c 32

# 或使用在线工具
https://www.random.org/strings/
```

**示例**: `a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6`

**用途**: API 请求签名和响应解密

---

### ✅ 准备完成检查

- [ ] 商户号: `___________` 已复制
- [ ] API 证书: `apiclient_cert.pem` 和 `apiclient_key.pem` 已下载
- [ ] 证书序列号: `___________` 已复制
- [ ] API v3 密钥: 已设置 32 位密钥

---

## 🔑 一点五、微信公众号OAuth配置（必须，30分钟）

> **用途**：通过微信公众号 OAuth 2.0 授权获取用户微信身份，建立微信用户与知识星球会员的绑定关系。

### 1.5.1 微信公众号 AppID

**获取路径**:
```
登录 https://mp.weixin.qq.com
→ 开发 → 基本配置
→ 复制"开发者ID(AppID)"
```

**示例**: `wx1234567890abcdef`

**用途**: OAuth 授权请求的身份标识

---

### 1.5.2 微信公众号 AppSecret

**获取路径**:
```
登录 https://mp.weixin.qq.com
→ 开发 → 基本配置
→ 点击"重置"生成新的 AppSecret
→ 立即复制保存（⚠️ 只显示一次！）
```

**示例**: `a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6`

**用途**: OAuth 授权的密钥，用于换取 access_token

**安全提醒**:
- ❌ 绝对不能提交到 Git
- ❌ 不能通过邮件/聊天发送
- ✅ 使用环境变量配置
- ✅ 生产环境使用密钥管理服务

---

### 1.5.3 网页授权域名配置

**配置路径**:
```
登录 https://mp.weixin.qq.com
→ 设置与开发 → 公众号设置 → 功能设置
→ 网页授权域名 → 修改
→ 下载 MP_verify_xxx.txt 文件
→ 将文件放到域名根目录
→ 填写授权域名（不带 https://）
```

**配置示例**:
- 域名: `api.yourdomain.com`（不带协议前缀）
- 验证文件: 放置于 `https://api.yourdomain.com/MP_verify_xxx.txt`

**注意事项**:
- ⚠️ 域名必须已备案（中国大陆服务器）
- ⚠️ 必须配置 HTTPS
- ⚠️ 每月只能修改 5 次

---

### 1.5.4 OAuth 回调 URL 配置

**回调地址格式**:
```
https://api.yourdomain.com/api/auth/callback/wechat-mp
```

**配置位置**: 应用配置文件或环境变量
```yaml
# application.yml
wechat:
  mp:
    app-id: wx1234567890abcdef
    app-secret: ${WECHAT_MP_SECRET}
    oauth-callback-url: https://api.yourdomain.com/api/auth/callback/wechat-mp
```

**环境变量**:
```bash
WECHAT_MP_APPID=wx1234567890abcdef
WECHAT_MP_SECRET=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
WECHAT_MP_OAUTH_CALLBACK_URL=https://api.yourdomain.com/api/auth/callback/wechat-mp
```

---

### ✅ 准备完成检查

- [ ] 微信公众号 AppID: `___________` 已复制
- [ ] 微信公众号 AppSecret: 已生成并安全保存
- [ ] 网页授权域名: `___________` 已配置
- [ ] MP_verify 验证文件: 已上传到服务器根目录
- [ ] OAuth 回调 URL: 已配置

---

## 🌐 二、服务器环境（必须，1-2天）

### 2.1 服务器配置（腾讯云轻量级单服务器）

**服务器选择**: 腾讯云轻量应用服务器（Lighthouse）

**推荐配置**:
- CPU: 2 核
- 内存: 4 GB
- 硬盘: 60 GB SSD
- 带宽: 4 Mbps
- 操作系统: **OpenCloudOS 8**（腾讯云官方维护）

**适用场景**:
- 同时在线用户 < 100 人
- 训练营数量 < 10 个
- 日交易量 < 500 笔

**成本**: 约 ¥60-100/月（腾讯云轻量服务器新用户优惠）

**服务部署（全部在同一台机器）**:
```
单服务器部署架构：
├── Java 应用（Spring Boot 3.2）
├── PostgreSQL 15 数据库
├── Redis 7.x 缓存
├── RabbitMQ 3.12 消息队列（可选，初期不需要）
└── Nginx 反向代理
```

> **说明**：RabbitMQ 为可选组件，初期使用 Spring 内置异步任务替代，待并发量增加（QPS > 100）或异步任务积压时再启用。

**为什么选择 OpenCloudOS**:
- 腾讯云官方维护，与轻量服务器深度集成
- 基于 CentOS/RHEL 生态，软件兼容性好
- 长期支持（LTS），稳定可靠
- 内置腾讯云优化，性能更佳

---

### 2.2 域名和 SSL 证书

#### 2.2.1 域名（必须）

**用途**:
- H5 会员端: `https://camp.yourdomain.com`
- 管理后台: `https://admin-camp.yourdomain.com`
- API 接口: `https://api-camp.yourdomain.com`

**备案**:
- ⚠️ 服务器在中国大陆必须备案
- ⚠️ 备案时间约 10-20 天
- ✅ 如不备案，可选择香港/海外服务器

---

#### 2.2.2 SSL 证书（必须）

**用途**: HTTPS 加密（微信支付强制要求 HTTPS）

**获取方式**:
- **免费**: Let's Encrypt（有效期 90 天，可自动续期）
- **付费**: 阿里云/腾讯云 SSL 证书（约 ¥1000/年）

**推荐**: 使用 Let's Encrypt + Certbot 自动续期

---

### 2.3 服务器软件环境

#### 需要安装的软件

| 软件 | 版本 | 用途 |
|------|------|------|
| **Java JDK** | 17+ | 运行 Spring Boot |
| **Maven** 或 **Gradle** | 3.8+ / 8.x | 构建项目 |
| **PostgreSQL** | 15+ | 数据库（16 张表） |
| **Redis** | 7.x | 缓存和会话管理 |
| **Nginx** | 1.24+ | 反向代理和静态资源 |
| **Git** | 2.x | 代码管理 |
| **Node.js** | 18+ | 前端构建（可选，本地构建后上传） |

#### 安装命令（OpenCloudOS 8）

```bash
# 更新系统
sudo dnf update -y

# 安装 Java 17
sudo dnf install java-17-openjdk-devel -y
java -version

# 安装 Maven（或 Gradle）
sudo dnf install maven -y
mvn -version

# 安装 PostgreSQL 15
# 添加 PostgreSQL 官方仓库
sudo dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm
sudo dnf -qy module disable postgresql
sudo dnf install -y postgresql15-server postgresql15
sudo /usr/pgsql-15/bin/postgresql-15-setup initdb
sudo systemctl enable postgresql-15
sudo systemctl start postgresql-15

# 安装 Redis
sudo dnf install redis -y
sudo systemctl enable redis
sudo systemctl start redis

# 安装 Nginx
sudo dnf install nginx -y
sudo systemctl enable nginx
sudo systemctl start nginx

# 安装 Git
sudo dnf install git -y

# 可选：安装 RabbitMQ（详见 4.5 节，初期可跳过）
```

---

### ✅ 准备完成检查

- [ ] 服务器已购买（配置: ___核___GB）
- [ ] 操作系统: ___________ 已安装
- [ ] 域名已购买: ___________
- [ ] 域名已备案（或选择海外服务器）
- [ ] SSL 证书已获取
- [ ] Java、PostgreSQL、Redis、Nginx 已安装

---

## 💾 三、数据库环境（必须，1小时）

### 3.1 数据库表结构概览（共 16 张表）

> **对齐文档**：严格按照《数据库设计.md》创建

#### 核心业务表（6 张）

| 表名 | 说明 | 关键字段 |
|------|------|----------|
| `training_camp` | 训练营 | status, planet_project_id |
| `camp_member` | 训练营会员 | match_status, eligible_for_refund |
| `planet_user` | 知识星球用户 | planet_user_id, planet_nickname |
| `payment_record` | 支付记录 | **bind_status**, **bind_method**, bind_deadline |
| `refund_record` | 退款记录 | refund_status, audit_status |
| `checkin_record` | 打卡记录 | checkin_date, checkin_time |

#### 系统管理表（4 张）

| 表名 | 说明 |
|------|------|
| `system_user` | 系统用户（管理员/教练/志愿者） |
| `system_config` | 系统配置（Cookie、API密钥等） |
| `operation_log` | 操作日志 |
| `camp_member_relation` | 训练营人员关系（教练/志愿者） |

#### 状态日志表（5 张）

| 表名 | 说明 | 记录内容 |
|------|------|----------|
| `camp_status_log` | 训练营状态日志 | from_status → to_status |
| `payment_bind_status_log` | 支付绑定状态日志 | 绑定状态变更审计 |
| `order_status_log` | 订单状态日志 | 支付状态变更审计 |
| `refund_status_log` | 退款状态日志 | 退款流程审计 |
| `member_status_log` | 会员状态日志 | 会员生命周期审计 |

#### 通知表（1 张）

| 表名 | 说明 | 关键字段 |
|------|------|----------|
| `notification_message` | 通知消息 | recipient_type, message_type, send_status |

---

### 3.2 PostgreSQL 数据库配置

#### 3.2.1 创建数据库

```bash
# 切换到 postgres 用户
sudo -i -u postgres

# 创建数据库
createdb camp_db

# 创建用户并设置密码
psql
CREATE USER camp_user WITH PASSWORD 'your_strong_password';
GRANT ALL PRIVILEGES ON DATABASE camp_db TO camp_user;
ALTER DATABASE camp_db OWNER TO camp_user;
\q
exit
```

#### 3.2.2 配置远程访问（可选）

```bash
# 编辑 PostgreSQL 配置
sudo nano /var/lib/pgsql/15/data/postgresql.conf

# 修改监听地址
listen_addresses = '*'

# 编辑访问控制
sudo nano /var/lib/pgsql/15/data/pg_hba.conf

# 添加远程访问规则
host    all             all             0.0.0.0/0            md5

# 重启 PostgreSQL
sudo systemctl restart postgresql-15
```

#### 3.2.3 导入初始化 SQL

```bash
# 导入数据库结构（16 张表）
psql -U camp_user -d camp_db -f /path/to/init-database.sql

# 导入初始数据（管理员账号、系统配置）
psql -U camp_user -d camp_db -f /path/to/seed-data.sql
```

---

### 3.3 Redis 配置

#### 3.3.1 配置密码

```bash
# 编辑 Redis 配置
sudo nano /etc/redis/redis.conf

# 设置密码
requirepass your_redis_password

# 重启 Redis
sudo systemctl restart redis
```

#### 3.3.2 Redis 键设计（参考接口文档）

| 键模式 | 用途 | TTL |
|--------|------|-----|
| `access_token:{token}` | H5 访问票据 | 训练营结束 +7 天 |
| `payment:callback:{order_no}` | 支付回调幂等 | 5 分钟 |
| `sync:lock:{camp_id}` | 打卡同步分布式锁 | 5 分钟 |
| `camp:detail:{camp_id}` | 训练营详情缓存 | 10 分钟 |

#### 3.3.3 测试连接

```bash
redis-cli
AUTH your_redis_password
PING
# 应返回 PONG
```

---

### ✅ 准备完成检查

- [ ] PostgreSQL 数据库 `camp_db` 已创建
- [ ] 数据库用户 `camp_user` 已创建，密码: ___________
- [ ] 16 张表结构已了解
- [ ] Redis 已配置密码: ___________
- [ ] 数据库连接测试通过

---

## 🔧 四、开发工具（必须，2小时）

### 4.1 后端开发工具

| 工具 | 版本 | 用途 |
|------|------|------|
| **IntelliJ IDEA** | 2023.3+ | Java 开发（推荐 Ultimate 版） |
| **Maven** 或 **Gradle** | 3.8+ / 8.x | 依赖管理 |
| **Postman** | 最新版 | API 测试（48 个接口） |
| **DBeaver** | 最新版 | 数据库管理 |

**IntelliJ IDEA 插件推荐**:
- Lombok
- MyBatis Plus
- Alibaba Java Coding Guidelines
- GitToolBox

---

### 4.2 前端开发工具

| 工具 | 版本 | 用途 |
|------|------|------|
| **Node.js** | 18+ | 运行环境 |
| **pnpm** | 8.x | 包管理器（推荐，比 npm 快） |
| **VS Code** | 最新版 | 前端开发 |

**VS Code 插件推荐**:
- Volar（Vue 3）
- ESLint
- Prettier
- Auto Rename Tag
- GitLens

---

### 4.3 安装命令

#### macOS

```bash
# 安装 Homebrew（如果没有）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装 Java 17
brew install openjdk@17

# 安装 Maven
brew install maven

# 安装 Node.js
brew install node@18

# 安装 pnpm
npm install -g pnpm

# 安装 PostgreSQL（本地开发）
brew install postgresql@15
brew services start postgresql@15

# 安装 Redis（本地开发）
brew install redis
brew services start redis
```

#### Windows

```powershell
# 使用 Chocolatey 包管理器
# 安装 Java 17
choco install openjdk17

# 安装 Maven
choco install maven

# 安装 Node.js
choco install nodejs-lts

# 安装 pnpm
npm install -g pnpm

# 安装 PostgreSQL
choco install postgresql15

# 安装 Redis
choco install redis-64
```

---

### ✅ 准备完成检查

- [ ] IntelliJ IDEA 已安装
- [ ] Maven 已安装: `mvn -version`
- [ ] Node.js 已安装: `node -v` (v18+)
- [ ] pnpm 已安装: `pnpm -v`
- [ ] VS Code 已安装
- [ ] Postman 已安装
- [ ] DBeaver 已安装

---

## 🐰 四点五、消息队列环境（可选，30分钟）

> **说明**：RabbitMQ 为可选组件，初期可跳过。使用 Spring 内置的 `@Async` 异步任务即可满足需求。待系统负载增加或需要可靠消息投递时再启用。

### 4.5.1 RabbitMQ 配置

**用途**：异步任务处理、退款队列、通知队列

#### 队列设计

| 队列名称 | Exchange | 用途 |
|----------|----------|------|
| `refund.execute` | `camp.topic` | 退款执行任务 |
| `refund.retry` | `camp.topic` | 退款重试（延迟队列） |
| `match.smart` | `camp.topic` | 智能匹配任务 |
| `notify.send` | `camp.topic` | 通知发送任务 |
| `stats.update` | `camp.topic` | 统计更新任务 |

#### 安装命令（OpenCloudOS 8）

```bash
# 启用 EPEL 和 RabbitMQ 仓库
sudo dnf install -y epel-release
sudo dnf install -y https://github.com/rabbitmq/erlang-rpm/releases/download/v26.2.1/erlang-26.2.1-1.el8.x86_64.rpm

# 添加 RabbitMQ 仓库
sudo tee /etc/yum.repos.d/rabbitmq.repo <<EOF
[rabbitmq-server]
name=rabbitmq-server
baseurl=https://packagecloud.io/rabbitmq/rabbitmq-server/el/8/\$basearch
gpgcheck=0
enabled=1
EOF

# 安装 RabbitMQ
sudo dnf install -y rabbitmq-server

# 启动服务
sudo systemctl enable rabbitmq-server
sudo systemctl start rabbitmq-server

# 启用管理插件
sudo rabbitmq-plugins enable rabbitmq_management

# 创建 VHost 和用户
sudo rabbitmqctl add_vhost /camp
sudo rabbitmqctl add_user camp_user your_password
sudo rabbitmqctl set_permissions -p /camp camp_user ".*" ".*" ".*"
```

### ✅ 准备完成检查（可选，初期可跳过）

- [ ] RabbitMQ 已安装并启动: `rabbitmqctl status`
- [ ] 管理界面可访问: http://localhost:15672
- [ ] VHost `/camp` 已创建
- [ ] 用户 `camp_user` 已创建

---

## 💻 四点六、前端开发环境详细配置（必须，1小时）

### 4.6.1 H5 会员端项目初始化

**技术栈**: Vue 3 + Vite + Vant 4 + TypeScript

```bash
# 创建项目
npm create vite@latest h5-member -- --template vue-ts

# 进入目录
cd h5-member

# 安装依赖
pnpm install

# 安装 UI 组件库
pnpm add vant @vant/use

# 安装路由
pnpm add vue-router@4

# 安装状态管理
pnpm add pinia

# 安装 HTTP 客户端
pnpm add axios

# 安装工具库
pnpm add dayjs
```

**Vant 按需引入配置**:
```bash
pnpm add -D unplugin-vue-components @vant/auto-import-resolver
```

```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import Components from 'unplugin-vue-components/vite'
import { VantResolver } from '@vant/auto-import-resolver'

export default defineConfig({
  plugins: [
    vue(),
    Components({
      resolvers: [VantResolver()],
    }),
  ],
})
```

### 4.6.2 管理后台项目初始化

**技术栈**: Vue 3 + Vite + Element Plus + TypeScript

```bash
# 创建项目
npm create vite@latest web-admin -- --template vue-ts

# 进入目录
cd web-admin

# 安装依赖
pnpm install

# 安装 UI 组件库
pnpm add element-plus @element-plus/icons-vue

# 安装路由
pnpm add vue-router@4

# 安装状态管理
pnpm add pinia pinia-plugin-persistedstate

# 安装 HTTP 客户端
pnpm add axios

# 安装工具库
pnpm add dayjs lodash-es xlsx

# 安装图表库（可选）
pnpm add echarts vue-echarts
```

### 4.6.3 Axios 封装要求（参考接口文档）

```typescript
// H5 端 utils/request.ts
import axios from 'axios'

const request = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || '/api',
  timeout: 10000
})

// 请求拦截器：添加 X-Access-Token
request.interceptors.request.use(config => {
  const accessToken = localStorage.getItem('accessToken')
  if (accessToken) {
    config.headers['X-Access-Token'] = accessToken
  }
  return config
})

// 响应拦截器：处理 accessToken
request.interceptors.response.use(response => {
  // 支付成功时保存 accessToken
  if (response.data?.data?.accessToken) {
    localStorage.setItem('accessToken', response.data.data.accessToken)
  }
  return response.data
})

export default request
```

### 4.6.4 代理配置（解决跨域）

**H5 端 vite.config.ts**:
```typescript
export default defineConfig({
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true
      }
    }
  }
})
```

**管理后台 vite.config.ts**:
```typescript
export default defineConfig({
  server: {
    port: 5174,
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true
      }
    }
  }
})
```

### ✅ 准备完成检查

- [ ] H5 项目已创建: `pnpm dev` 可正常启动
- [ ] 管理后台项目已创建: `pnpm dev` 可正常启动
- [ ] Axios 封装包含 X-Access-Token Header
- [ ] API 代理配置正确

---

## 📦 五、第三方服务（推荐，1小时）

### 5.1 对象存储（推荐）

**用途**: 存储训练营海报、群二维码、用户头像

**推荐服务**:
- 腾讯云 COS（按量付费）
- 阿里云 OSS（按量付费）

**成本**: 约 ¥5-20/月（1000 人训练营）

**配置**:
```yaml
# application.yml
cloud:
  storage:
    type: tencent-cos  # 或 aliyun-oss
    bucket: your-bucket-name
    region: ap-guangzhou
    secret-id: xxx
    secret-key: xxx
```

---

### 5.2 企业微信应用（推荐）

**用途**:
- 发送打卡提醒
- 发送退款通知
- Cookie 过期告警

**申请流程**:
```
1. 登录企业微信管理后台
2. 应用管理 → 应用 → 创建应用
3. 获取 AgentId 和 Secret
4. 配置可信域名
```

**配置到**:
```yaml
# application.yml
wechat:
  work:
    corp-id: xxx
    agent-id: xxx
    secret: xxx
```

---

### 5.3 短信服务（可选）

**用途**: 发送支付成功短信、打卡提醒短信

**推荐服务**: 阿里云短信 / 腾讯云短信

**成本**: 约 ¥0.03-0.05/条

---

### ✅ 准备完成检查

- [ ] 对象存储已开通（Bucket: ___________）
- [ ] 企业微信应用已创建（AgentId: ___________）
- [ ] 短信服务已开通（可选）

---

## 🔧 五点五、CI/CD 配置（推荐，新增）

> **用途**：自动化构建、测试和部署，提高开发效率，减少人为错误。

### 5.5.1 Git 仓库配置

**推荐平台**:
- GitHub（国际）
- Gitee（国内）
- GitLab（自托管）

**分支策略**:
```
main          # 生产环境分支
├── develop   # 开发环境分支
├── feature/* # 功能分支
└── hotfix/*  # 紧急修复分支
```

**Git Hooks（本地验证）**:

```bash
# .git/hooks/pre-commit
#!/bin/bash
echo "运行代码检查..."

# 后端检查
cd backend
./gradlew spotlessCheck || exit 1
cd ..

# 前端检查
cd frontend/h5-member
npm run lint || exit 1
cd ../..

echo "✅ 代码检查通过"
```

---

### 5.5.2 GitHub Actions CI/CD（推荐）

**配置文件**: `.github/workflows/ci.yml`

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}

      - name: Run backend tests
        run: |
          cd backend
          ./gradlew check

      - name: Upload test reports
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: backend-test-reports
          path: backend/build/reports/

  frontend-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Test H5
        run: |
          cd frontend/h5-member
          npm ci
          npm run lint
          npm run type-check
          npm run test:unit

      - name: Test Admin
        run: |
          cd frontend/admin-web
          npm ci
          npm run lint
          npm run type-check
          npm run test:unit

  deploy-dev:
    needs: [backend-test, frontend-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    steps:
      - name: Deploy to dev server
        run: |
          # SSH 部署到开发环境
          # 详见部署脚本 scripts/deploy-dev.sh
```

---

### 5.5.3 自动化部署脚本

**部署脚本**: `scripts/deploy-dev.sh`

```bash
#!/bin/bash
set -e

echo "========== 开始部署到开发环境 =========="

# 构建后端
echo "1. 构建后端..."
cd backend
./gradlew bootJar
cd ..

# 构建前端
echo "2. 构建前端..."
cd frontend/h5-member
npm run build
cd ../admin-web
npm run build
cd ../..

# 上传到服务器
echo "3. 上传文件..."
scp backend/build/libs/*.jar user@dev-server:/opt/camp/backend/
scp -r frontend/h5-member/dist/* user@dev-server:/opt/camp/h5/
scp -r frontend/admin-web/dist/* user@dev-server:/opt/camp/admin/

# 重启服务
echo "4. 重启服务..."
ssh user@dev-server "systemctl restart camp-backend"
ssh user@dev-server "systemctl reload nginx"

echo "========== 部署完成 =========="
```

---

### 5.5.4 Docker 部署（可选）

**Dockerfile（后端）**:

```dockerfile
FROM openjdk:17-jdk-slim

WORKDIR /app

COPY build/libs/*.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```

**docker-compose.yml**:

```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=jdbc:postgresql://db:5432/camp_db
      - REDIS_HOST=redis
    depends_on:
      - db
      - redis

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=camp_db
      - POSTGRES_USER=camp_user
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./frontend/h5-member/dist:/usr/share/nginx/html/h5
      - ./frontend/admin-web/dist:/usr/share/nginx/html/admin

volumes:
  postgres-data:
```

---

### ✅ 准备完成检查

- [ ] Git 仓库已创建（GitHub/Gitee）
- [ ] 分支策略已明确
- [ ] CI/CD Pipeline 已配置（GitHub Actions/GitLab CI）
- [ ] 部署脚本已编写（deploy-dev.sh, deploy-prod.sh）
- [ ] Docker 配置已完成（可选）

---

## 📊 五点六、日志监控配置（推荐，新增）

> **用途**：实时监控系统运行状态，快速定位问题，保障系统稳定性。

### 5.6.1 应用日志配置

**日志框架**: Logback（Spring Boot 默认）

**配置文件**: `backend/src/main/resources/logback-spring.xml`

```xml
<configuration>
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>

    <!-- 控制台输出 -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <!-- 文件输出 -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>/var/log/camp/application.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>/var/log/camp/application.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>

    <!-- 错误日志单独输出 -->
    <appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>/var/log/camp/error.log</file>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>ERROR</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>/var/log/camp/error.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>90</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n%ex</pattern>
        </encoder>
    </appender>

    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="FILE"/>
        <appender-ref ref="ERROR_FILE"/>
    </root>
</configuration>
```

---

### 5.6.2 日志级别配置

**配置文件**: `application.yml`

```yaml
logging:
  level:
    root: INFO
    com.camp: DEBUG                      # 业务代码详细日志
    com.camp.service: DEBUG              # Service 层日志
    com.camp.mapper: DEBUG               # SQL 日志
    org.springframework.web: INFO
    org.springframework.security: INFO
  file:
    path: /var/log/camp
    max-size: 100MB
    max-history: 30
```

---

### 5.6.3 监控指标（推荐）

**Spring Boot Actuator**:

```yaml
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
```

**监控端点**:
- `/actuator/health` - 健康检查
- `/actuator/metrics` - 性能指标
- `/actuator/prometheus` - Prometheus 格式指标

**关键指标**:
- JVM 内存使用率
- 数据库连接池状态
- Redis 连接状态
- HTTP 请求 QPS 和响应时间
- 支付成功率
- 退款成功率
- 同步任务成功率

---

### 5.6.4 告警配置（推荐）

**监控指标告警阈值**:

| 指标 | 告警阈值 | 告警方式 |
|------|----------|----------|
| JVM 堆内存使用率 | > 85% | 企业微信 |
| 数据库连接池使用率 | > 90% | 企业微信 |
| 错误日志数量 | > 10/分钟 | 企业微信 |
| 支付成功率 | < 95% | 企业微信 + 短信 |
| 知识星球 Cookie 过期 | API 401/403 | 企业微信（紧急） |
| 同步任务失败 | 连续失败 3 次 | 企业微信 |

**告警通知示例**（企业微信）:

```java
// 伪代码：告警服务
@Service
public class AlertService {

    public void sendAlert(String title, String message, AlertLevel level) {
        // 构造企业微信消息
        WechatWorkMessage msg = WechatWorkMessage.builder()
            .msgtype("markdown")
            .markdown(Map.of(
                "content", String.format(
                    "## ⚠️ %s\n\n" +
                    "**等级**: %s\n" +
                    "**内容**: %s\n" +
                    "**时间**: %s\n" +
                    "**服务器**: %s",
                    title, level, message,
                    LocalDateTime.now(),
                    Environment.getHostName()
                )
            ))
            .build();

        // 发送到企业微信
        wechatWorkApi.send(msg);
    }
}
```

---

### 5.6.5 日志分析工具（可选）

**推荐工具**:
- **ELK Stack**（Elasticsearch + Logstash + Kibana）- 功能强大，但资源消耗大
- **Loki + Grafana**（轻量级）- 推荐用于小型项目
- **云服务日志**（腾讯云 CLS / 阿里云 SLS）- 按量付费

**简单日志分析命令**（无需额外工具）:

```bash
# 统计今日错误数量
grep "ERROR" /var/log/camp/application.log | grep "$(date +%Y-%m-%d)" | wc -l

# 查看最近 10 条错误
tail -100 /var/log/camp/error.log

# 统计今日支付成功数量
grep "支付成功" /var/log/camp/application.log | grep "$(date +%Y-%m-% d)" | wc -l

# 监控实时日志
tail -f /var/log/camp/application.log
```

---

### ✅ 准备完成检查

- [ ] Logback 日志配置已完成
- [ ] 日志文件路径: `/var/log/camp/` 已创建
- [ ] Spring Boot Actuator 已启用
- [ ] 监控指标端点可访问: `/actuator/health`
- [ ] 告警规则已配置（企业微信通知）
- [ ] 日志分析工具已安装（可选）

---

## 📝 六、业务数据准备（推荐，提前准备）

### 6.1 知识星球 API 配置

**需要信息**:
- 知识星球 Group ID
- 知识星球 Cookie（zsxq_access_token）

**获取方式**:
```
1. 浏览器登录知识星球
2. 打开 DevTools → Network
3. 刷新页面，找到 checkins 请求
4. 复制 Request Headers 中的 Cookie
```

**配置到**:
```yaml
# application.yml（从 system_config 表读取）
zsxq:
  group-id: 15555411412112
  cookie: zsxq_access_token=xxx
```

**注意**：Cookie 会过期，需要在 system_config 表中配置，支持热更新。

---

### 6.2 初始训练营数据

**准备内容**:
- 训练营名称和简介
- 训练营海报（设计稿）
- 押金金额
- 打卡要求天数
- 训练营时长
- 群二维码

**示例 Excel**:

| 训练营名称 | 押金金额 | 打卡要求 | 时长 | 海报URL |
|-----------|---------|---------|------|---------|
| AI学习营第1期 | 99元 | 15天 | 21天 | https://... |
| 副业探索营第2期 | 199元 | 21天 | 30天 | https://... |

---

### 6.3 FastAuth 会员同步配置（新增）

> **用途**：定时从知识星球同步会员数据，用于 FastAuth 身份绑定和会员验证。详见 [FastAuth接入方案](./FastAuth接入方案.md) §2。

**需要配置**:

#### 6.3.1 会员同步定时任务

**配置位置**: `application.yml` 或 `application.properties`

```yaml
# 会员同步配置（参考 FastAuth接入方案 §2.6）
sync:
  member:
    enabled: true                      # 是否启用会员同步
    cron: "0 0 2 * * ?"               # 每天凌晨2点同步
    page-size: 100                     # 每页数量（知识星球 API 限制）
    retry-times: 3                     # 失败重试次数
    timeout-seconds: 30                # 请求超时时间

# 数据库表（参考 FastAuth接入方案 §2.3）
# - planet_user: 知识星球会员表
# - sync_log: 同步日志表
# - user_planet_binding: 用户绑定关系表（FastAuth + 星球会员）
```

#### 6.3.2 会员验证接口

**接口清单**（参考 [接口文档](./接口文档.md) §3.7、§5）:
1. `POST /api/h5/members/verify` - H5 会员验证（§3.7）
2. `GET /api/h5/members/search?keyword=xxx` - H5 搜索会员（§3.8）
3. `POST /api/admin/members/sync` - 管理后台手动触发同步（§5.7）
4. `GET /api/admin/members/sync/status` - 管理后台查询同步状态（§5.8）
5. `POST /api/admin/members/batch-verify` - 管理后台批量验证会员（§5.4）

#### 6.3.3 会员同步环境变量

```bash
# 知识星球 API 配置（参考 §6.1）
ZSXQ_GROUP_ID=15555411412112
ZSXQ_COOKIE=zsxq_access_token=xxx

# FastAuth 数据库表（参考 FastAuth接入方案 §2.3）
# 确保以下表已创建：
# - planet_user（扩展字段：user_number, avatar_url, joined_at, role, member_status, raw_data, synced_at）
# - sync_log（新增表）
# - user_planet_binding（新增表）
```

#### 6.3.4 会员同步监控

**监控指标**:
- 同步任务成功率（通过 sync_log 表查询）
- 会员数据更新时间（synced_at 字段）
- Cookie 过期告警（API 返回 401/403）

**告警机制**:
- Cookie 过期 → 企业微信通知管理员
- 同步失败超过 3 次 → 记录到 operation_log 表

---

### ✅ 准备完成检查

- [ ] 知识星球 API 配置已获取
- [ ] 至少准备 1 个训练营的完整信息
- [ ] **FastAuth 会员同步配置已完成**（新增）
- [ ] **planet_user, sync_log, user_planet_binding 表已创建**（新增）

---

## 🎨 七、UI 设计资源（可选，1-2天）

### 7.1 H5 会员端设计

**需要页面**（参考接口文档 H5 接口）:
1. 训练营列表页（首页）
2. 训练营详情页（含预填信息）
3. 支付后绑定页（固定二维码用户）
4. 群二维码展示页
5. 打卡进度页

**设计工具**: Figma / Sketch / 即时设计

**参考**: Vant UI 组件库风格

---

### 7.2 管理后台设计

**需要页面**（参考接口文档管理端接口）:
1. 登录页
2. 仪表盘（数据概览）
3. 训练营管理页
4. 会员管理页（含匹配状态筛选）
5. 退款审核页（含批量审核）
6. 数据报表页

**设计工具**: Element Plus 组件库风格

**参考**: Vue Element Admin

---

### 7.3 素材准备

**需要资源**:
- Logo（应用图标）
- 训练营海报模板
- 群二维码
- 默认头像
- 空状态插图

---

### ✅ 准备完成检查

- [ ] UI 设计稿已完成（至少核心页面）
- [ ] 素材资源已准备

---

## 📊 八、准备情况总结

### 优先级分级

#### 🔴 P0 - 必须立即准备（开发前）

- [ ] 微信支付商户号配置（3项）
- [ ] API 证书下载
- [ ] 本地开发环境搭建（Java 17、PostgreSQL 15、Redis 7.x）
- [ ] IntelliJ IDEA / VS Code 安装

**预计时间**: 半天（4小时）

---

#### 🟡 P1 - 开发初期需要（第1周）

- [ ] 服务器购买和配置
- [ ] 域名购买和备案
- [ ] SSL 证书获取
- [ ] 数据库初始化（16 张表）
- [ ] 知识星球 API 配置

**预计时间**: 3-5 天（含备案等待期）

---

#### 🟢 P2 - 开发中期需要（第2-3周）

- [ ] 对象存储开通
- [ ] 企业微信应用配置
- [ ] 初始训练营数据准备
- [ ] UI 设计稿

**预计时间**: 1-2 天

---

## 🎯 开发时间线规划（对应 6 个 Stage）

### 阶段零：准备阶段（3天）

**Day 0-1**:
- ✅ 微信支付配置（30分钟）
- ✅ 本地开发环境（2小时）
- ✅ 服务器购买（1小时）

**Day 2-3**:
- ⏳ 域名备案（等待审核，10-20天）
- ✅ 服务器环境配置（1天）
- ✅ 数据库初始化 16 张表（1小时）

---

### Stage 1：基础框架 + 训练营 CRUD（4天）

- 后端框架搭建
- JWT 认证实现
- 训练营 CRUD 接口

---

### Stage 2：支付集成（混合方案）（5天）

- 微信支付 SDK 封装
- 动态二维码支付（attach 携带 planet_user_id）
- 支付回调处理（区分有/无 attach）
- 用户绑定接口
- 绑定超时定时任务

---

### Stage 3：打卡同步（4天）

- 知识星球 API 封装
- 定时同步任务
- 手动同步接口

---

### Stage 4：混合匹配算法（3天）

- bind_status 优先匹配
- 智能匹配算法（Levenshtein）
- 手动匹配接口

---

### Stage 5：退款流程（4天）

- 退款名单生成
- 审核接口
- 退款执行
- 通知服务

---

### Stage 6：前端开发 + 系统管理（4天）

- H5 会员端
- Web 管理后台
- 统计报表

---

## 💰 成本预算

| 项目 | 成本 | 周期 |
|------|------|------|
| 服务器（单机） | ¥100-150/月 | 按月 |
| 域名 | ¥50-100/年 | 按年 |
| SSL 证书 | 免费（Let's Encrypt） | - |
| 对象存储 | ¥5-10/月 | 按量 |
| 短信服务 | - | - |
| **总计（首月）** | **约 ¥200-300** | - |

---

## 📞 需要帮助？

如果在准备过程中遇到问题，请确认：

1. **服务器选型**: 推荐腾讯云轻量服务器（单机部署）
2. **域名备案**: 中国大陆服务器需备案，约 10-20 天
3. **数据库设计**: 参考《数据库设计.md》，共 16 张表
4. **接口开发**: 参考《接口文档.md》，共 48 个接口
5. **开发规划**: 参考《AI辅助敏捷开发计划.md》，共 6 个 Stage

---

## ✅ 最终检查清单

在开始开发前，请确认：

### 核心配置（必须）

- [ ] 微信支付商户号: ___________
- [ ] API 证书: `apiclient_cert.pem` 和 `apiclient_key.pem`
- [ ] 证书序列号: ___________
- [ ] API v3 密钥: ___________

### 微信公众号OAuth配置（必须）

- [ ] 微信公众号 AppID: ___________
- [ ] 微信公众号 AppSecret: 已生成并安全保存
- [ ] 网页授权域名: ___________ 已配置
- [ ] OAuth 回调 URL: 已配置

### FastAuth 会员同步配置（必须，新增）

- [ ] 知识星球 Group ID: ___________ 已配置
- [ ] 知识星球 Cookie: 已获取并配置
- [ ] 会员同步定时任务: 已配置（cron 表达式）
- [ ] planet_user 表: 已创建并包含 FastAuth 扩展字段
- [ ] sync_log 表: 已创建
- [ ] user_planet_binding 表: 已创建
- [ ] 会员验证接口: 已了解（5个接口）

### 开发环境（必须）

- [ ] Java 17: `java -version`
- [ ] Maven/Gradle: `mvn -version`
- [ ] PostgreSQL 15: `psql --version`
- [ ] Redis 7.x: `redis-cli ping`
- [ ] Node.js 18+: `node -v`
- [ ] IntelliJ IDEA / VS Code

### 生产环境（P1）

- [ ] 服务器: _____（配置）
- [ ] 域名: ___________
- [ ] 备案状态: ___________
- [ ] SSL 证书: ___________

### 业务数据（P1）

- [ ] 知识星球 API 配置
- [ ] 初始训练营数据

### 数据库（P1）

- [ ] 了解 16 张表结构
- [ ] 了解 5 张状态日志表用途
- [ ] 了解 bind_status、bind_method 字段含义

---

**准备完成后，即可开始 v1 开发！** 🚀

> **提示**：开发过程中请参考《AI辅助敏捷开发计划.md》中的 AI 提示词，可大幅提升开发效率。
