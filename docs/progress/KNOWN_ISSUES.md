# 已知问题和遗留任务

本文档记录项目开发过程中发现的已知问题、限制和待解决的遗留任务。

---

## 🚨 严重问题

### 1. 知识星球 API 分页限制导致数据不完整

**发现时间**: 2025-10-27

**问题描述**:
知识星球打卡排行榜 API (`/ranking_list`) 存在分页限制,导致无法获取完整的参与人数:
- 第 1 页成功返回 21 个用户
- 尝试获取第 2 页时,API 返回失败 (`succeeded: false`)
- 导致参与人数统计不准确,合格率计算错误

**影响范围**:
- ❌ **参与人数统计不准确** (例如实际 75 人,只获取到 21 人)
- ❌ **合格率计算错误** (21/21 = 100%,实际应该是 X/75)
- ❌ **退款名单不完整** (缺失 54 人的数据)

**复现步骤**:
1. 访问训练营: `http://localhost:5174/camps/8424485212/refund?title=2510+AI编程&totalDays=9`
2. 生成退款名单 (完成要求 7 天)
3. 观察统计结果:
   - 显示总人数: 21 人
   - 实际参与人数: 75 人
   - 缺失: 54 人

**技术细节**:
```javascript
// 当前代码 (zsxq-api/src/services/zsxq.service.js:112-143)
while (hasMore && index < 10) {
  const response = await this.axios.get(url, {
    params: { type: 'accumulated', index },
    headers: this.getHeaders()
  });

  // 第 1 页: 成功返回 21 个用户
  // 第 2 页: response.data.succeeded === false ❌
}
```

**日志输出**:
```
2025-10-27 18:57:11 [INFO]: 第 1 页获取 21 个用户，累计 21 个用户
2025-10-27 18:57:12 [ERROR]: 获取打卡排行榜失败: 知识星球 API 返回失败
```

**可能原因**:
1. **限制显示前 N 名**: 知识星球 API 可能只返回排行榜前 20-30 名用户
2. **不支持 index 分页**: `index` 参数不是简单的页码递增,可能需要其他游标参数
3. **需要不同的 API**: 可能存在另一个接口用于获取完整参与列表(非排行榜)
4. **Cookie 权限限制**: 当前使用的 Cookie 可能无权访问完整数据

**待验证**:
- [ ] 在知识星球网页端能否看到完整 75 人?
- [ ] 网页端使用的 API 接口是什么?
- [ ] 是否存在 `members` 或 `participants` 等其他接口?
- [ ] 是否需要不同的认证参数?

**解决方案 (待实施)**:

**方案 1: 抓包分析网页端 API** (推荐)
1. 使用浏览器 DevTools → Network
2. 访问知识星球训练营完整参与列表页面
3. 找到实际使用的 API 接口和参数
4. 对比与当前 `ranking_list` 的差异

**方案 2: 尝试其他 API 端点**
```javascript
// 可能的替代接口
GET /groups/{groupId}/checkins/{checkinId}/members
GET /groups/{groupId}/checkins/{checkinId}/participants
GET /groups/{groupId}/checkins/{checkinId}/users
```

**方案 3: 修改分页参数**
```javascript
// 尝试不同的参数组合
params: {
  type: 'all',           // 而不是 'accumulated'
  count: 100,            // 明确指定数量
  offset: 0,             // 使用 offset 代替 index
  cursor: '...'          // 使用游标分页
}
```

**方案 4: 降级方案 - 明确说明限制**
如果无法获取完整数据,在前端显示警告:
```
⚠️ 注意: 由于知识星球 API 限制,当前只显示前 21 名用户数据
实际参与人数可能更多,请以知识星球官方数据为准
```

**临时解决方案**:
- 代码已回滚到安全状态,不会导致 API 被限流
- 当前仅显示第 1 页数据 (最多 21 人)
- 统计结果基于不完整数据,仅供参考

**优先级**: 🔴 **P0 (严重)** - 影响核心功能

**状态**: ⏸️ **阻塞中** - 需要用户提供网页端抓包数据

---

## ⚠️ 中等问题

### 2. 星球 ID 在 Excel 中显示为科学计数法

**发现时间**: 2025-10-27

**问题描述**:
Excel 导出时,星球 ID (例如 `841858284282812`) 被自动识别为数值类型,显示为科学计数法 `8.41858E+14`

**解决方案**: ✅ **已修复**

在 ID 前添加单引号强制 Excel 识别为文本:
```javascript
// zsxq-web/src/utils/export.js:38
`'${item.planet_user_id}`  // 例如: '841858284282812
```

**优先级**: ✅ **已解决**

---

## 📝 优化建议

### 3. 默认完成天数应为 7 天

**发现时间**: 2025-10-27

**问题描述**:
进入退款名单页面时,默认完成天数为训练营总天数,应改为固定 7 天

**解决方案**: ✅ **已修复**
```javascript
// zsxq-web/src/views/RefundList.vue:140
const form = ref({
  requiredDays: 7  // 固定为 7 天
});
```

**优先级**: ✅ **已解决**

---

### 4. Excel 标题应显示训练营名称

**发现时间**: 2025-10-27

**问题描述**:
Excel 第一行标题显示为"知识星球训练营退款名单",应改为具体训练营名称

**解决方案**: ✅ **已修复**
```javascript
// zsxq-web/src/utils/export.js:16
const data = [
  [campInfo.title],  // 例如: "2508 AI写作(计算机VBA)"
  // ...
];
```

**优先级**: ✅ **已解决**

---

## 🔮 未来优化

### 5. 添加单元测试 (Mock 数据)

**优先级**: 🟡 P2 (重要)

**描述**:
当前只有集成测试(调用真实 API),缺少单元测试:
- 退款计算逻辑单元测试
- 工具函数单元测试
- 边界条件测试

**参考**:
- 使用 Jest Mock 模拟知识星球 API 响应
- 测试覆盖率目标: 90%+

---

### 6. 集成 ESLint + Prettier

**优先级**: 🟢 P3 (可选)

**描述**:
前端项目已有 ESLint + Prettier 配置,后端尚未配置:
- 统一代码风格
- 自动格式化
- Husky + lint-staged (Git hooks)

---

### 7. 添加 API 文档 (Swagger)

**优先级**: 🟢 P3 (可选)

**描述**:
为后端 API 添加 Swagger 文档:
- 自动生成交互式 API 文档
- 支持在线测试
- 生成 API 客户端代码

---

## 📌 待办任务

### Sprint 3 剩余任务

- [ ] **Task 3.3**: 准备部署文件包 (0.5h)
- [ ] **Task 3.4**: 宝塔部署后端 Node.js 项目 (0.5h)
- [ ] **Task 3.5**: 宝塔部署前端静态网站 (0.5h)
- [ ] **Task 3.6**: 生产环境测试 (0.5h)

### 缓冲时间任务

- [ ] 修复知识星球 API 分页问题 ⚠️ **阻塞中**
- [ ] 添加单元测试 (Mock 数据)
- [ ] 集成 ESLint + Prettier
- [ ] 添加 API 文档 (Swagger)

---

## 🆘 需要用户协助

### 知识星球 API 分页问题排查

**需要用户提供**:
1. ✅ 确认网页端能否看到完整 75 人
2. 📸 提供浏览器 DevTools 抓包截图:
   - Network 面板
   - 找到获取完整参与列表的 API 请求
   - 请求 URL、Headers、Query Parameters
3. 📋 提供完整的 API 响应示例 (JSON)

**抓包步骤**:
```
1. 打开知识星球网页端
2. 按 F12 打开 DevTools
3. 切换到 Network 面板
4. 访问训练营参与列表页面
5. 筛选 XHR 请求
6. 找到类似 /checkins/{id}/xxx 的请求
7. 复制 Request Headers、Response
```

---

## 📅 更新日志

| 日期 | 问题编号 | 状态 | 说明 |
|------|---------|------|------|
| 2025-10-27 | #1 | ⏸️ 阻塞中 | 知识星球 API 分页限制,需用户抓包 |
| 2025-10-27 | #2 | ✅ 已解决 | 星球 ID 科学计数法问题 |
| 2025-10-27 | #3 | ✅ 已解决 | 默认完成天数改为 7 天 |
| 2025-10-27 | #4 | ✅ 已解决 | Excel 标题改为训练营名称 |

---

**最后更新**: 2025-10-27 19:00
**负责人**: Claude Code
**文档版本**: v1.0
