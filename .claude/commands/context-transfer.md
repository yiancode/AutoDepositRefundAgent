# 上下文迁移指令

当检测到上下文即将耗尽或用户输入 `/context-transfer` 时，执行此指令。

## 任务目标

生成一份完整的上下文迁移文档，用于在新会话中快速恢复工作状态。

## 执行步骤

### 1. 读取关键文件状态

读取以下文件的当前状态：
- `CLAUDE.md` - 项目概述和规范
- `docs/开发进度.md` - 当前开发进度（如果存在）
- `docs/Bug经验库.md` - 已知问题和解决方案（如果存在）
- `.git/` - Git 提交历史

### 2. 生成上下文迁移文档

在 `docs/sessions/` 目录下创建新的会话快照文件：`session-{YYYYMMDD-HHMMSS}.md`

文档应包含以下内容：

```markdown
# 会话上下文快照 - {日期时间}

## 📋 项目基本信息

- **项目名称**: 知识星球训练营自动押金退款系统
- **当前阶段**: [阶段零/阶段一/阶段二/阶段三]
- **开发进度**: [百分比]
- **最后更新**: {时间戳}

## 🎯 当前工作状态

### 正在进行的任务
- [ ] 任务1（详细描述）
- [ ] 任务2（详细描述）

### 最近完成的任务
- [x] 任务A - {完成时间}
- [x] 任务B - {完成时间}

### 待办任务列表
1. 任务X（优先级：高）
2. 任务Y（优先级：中）

## 📁 重要文件变更

### 最近修改的文件
- `backend/xxx.js` - {修改说明}
- `frontend/xxx.vue` - {修改说明}

### 最近创建的文件
- `backend/xxx.js` - {文件用途}

### 需要关注的文件
- `xxx.js:123` - {存在的问题或待优化点}

## 🐛 已知问题和解决方案

### 问题1: {问题标题}
- **文件位置**: `xxx.js:行号`
- **问题描述**: ...
- **解决方案**: ...
- **状态**: 已解决/待解决

### 问题2: {问题标题}
- ...

## 🔧 最近的技术决策

1. **决策**: 选择 XXX 而不是 YYY
   - **原因**: ...
   - **影响范围**: ...

2. **决策**: ...

## 📝 开发笔记

### 重要提醒
- 注意事项1
- 注意事项2

### 下一步建议
1. 建议1
2. 建议2

## 💾 Git 状态

### 最近 5 次提交
```
{git log 输出}
```

### 未提交的更改
```
{git status 输出}
```

## 🔗 相关文档链接

- [PRD.md](../PRD.md)
- [技术架构设计.md](../v1/技术架构设计.md)
- [数据库设计.md](../v1/数据库设计.md)
- [开发进度.md](../开发进度.md)

## 🚀 快速恢复指令

在新会话中执行以下命令快速恢复上下文：

```bash
# 1. 切换到项目目录
cd D:\code\webwork\AutoDepositRefundAgent

# 2. 查看当前分支和状态
git status

# 3. 阅读本文档了解当前进度

# 4. 继续开发：[具体指令]
```

## 📊 统计信息

- **总代码行数**: {统计}
- **测试覆盖率**: {百分比}
- **API 接口数**: {数量}
- **数据库表数**: {数量}
```

### 3. 更新 CLAUDE.md

在 CLAUDE.md 的顶部添加"最后会话快照"引用：

```markdown
## 📸 最后会话快照

**上次工作时间**: {时间戳}
**会话快照文档**: [session-{YYYYMMDD-HHMMSS}.md](docs/sessions/session-{YYYYMMDD-HHMMSS}.md)

**快速回顾**:
- 当前阶段: {阶段}
- 正在做: {任务}
- 下一步: {任务}
```

### 4. 输出迁移摘要

向用户输出简洁的摘要：

```
✅ 上下文迁移文档已生成

📄 会话快照: docs/sessions/session-{时间}.md
📊 当前进度: {阶段} - {百分比}%
🎯 正在做: {任务}
📝 下一步: {任务}

---

🔗 在新会话中的操作：
1. 告诉 Claude: "请读取最新的会话快照文档"
2. Claude 会自动读取 CLAUDE.md 中引用的快照文件
3. 继续工作

或者直接说: "继续上次的开发工作"
```

## 触发条件

- 用户输入: `/context-transfer`
- Token 使用率超过 80%（自动提示）
- 用户说: "保存当前进度"、"生成会话快照"、"迁移上下文"

## 注意事项

1. 确保创建 `docs/sessions/` 目录
2. 文件名包含完整时间戳，避免覆盖
3. 敏感信息（API Key、密码）不要记录在快照中
4. 快照文件应该可以独立阅读，包含所有必要的上下文
5. 定期清理 30 天前的旧快照文件

## 示例用法

```
用户: /context-transfer
Claude: [执行上述步骤，生成快照文档]

用户: (在新会话中) 继续上次的开发工作
Claude: [读取 CLAUDE.md 中的快照引用，恢复上下文]
```
