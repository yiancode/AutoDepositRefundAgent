# v0.1 ä¼ä¸šå¾®ä¿¡é€€æ¬¾åŠŸèƒ½æŠ€æœ¯æ–¹æ¡ˆ

**åˆ›å»ºæ—¶é—´**: 2025-10-30
**ç‰ˆæœ¬**: v1.0
**çŠ¶æ€**: è®¾è®¡ä¸­

---

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

### ç›®æ ‡

åœ¨ v0 ç‰ˆæœ¬åŸºç¡€ä¸Š,å¯¹æ¥ä¼ä¸šå¾®ä¿¡æ”¯ä»˜é€€æ¬¾ API,å®ç°è‡ªåŠ¨é€€æ¬¾åŠŸèƒ½ã€‚

### æ ¸å¿ƒåŠŸèƒ½

1. âœ… ä¼ä¸šå¾®ä¿¡æ”¯ä»˜é…ç½®ç®¡ç†
2. âœ… é€€æ¬¾ API è°ƒç”¨å°è£…
3. âœ… é€€æ¬¾è®°å½•æŒä¹…åŒ–å­˜å‚¨
4. âœ… é˜²é‡å¤é€€æ¬¾æœºåˆ¶
5. âœ… é€€æ¬¾å¤±è´¥é‡è¯•
6. âœ… å‰ç«¯é€€æ¬¾æ“ä½œæµç¨‹

### è®¾è®¡åŸåˆ™

- **ç®€å•ä¼˜å…ˆ**: ä½¿ç”¨ JSON æ–‡ä»¶å­˜å‚¨,é¿å…å¼•å…¥æ•°æ®åº“
- **å¹‚ç­‰æ€§**: ç¡®ä¿é€€æ¬¾æ“ä½œä¸ä¼šé‡å¤æ‰§è¡Œ
- **å®‰å…¨æ€§**: è¯ä¹¦æ–‡ä»¶å®‰å…¨ç®¡ç†,æ•æ„Ÿä¿¡æ¯åŠ å¯†
- **å¯é æ€§**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- **å¯è¿½æº¯**: å®Œæ•´çš„é€€æ¬¾è®°å½•å’Œæ—¥å¿—

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯ (zsxq-web)                       â”‚
â”‚                                                           â”‚
â”‚  é€€æ¬¾åå•é¡µé¢ (RefundList.vue)                            â”‚
â”‚    â†“                                                     â”‚
â”‚  [æ‰§è¡Œé€€æ¬¾] æŒ‰é’® â†’ ç¡®è®¤å¼¹çª— â†’ æ‰¹é‡é€€æ¬¾                     â”‚
â”‚    â†“                                                     â”‚
â”‚  æ˜¾ç¤ºè¿›åº¦æ¡ â†’ æ˜¾ç¤ºé€€æ¬¾ç»“æœ                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ HTTP POST
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åç«¯ (zsxq-api)                       â”‚
â”‚                                                           â”‚
â”‚  è·¯ç”±å±‚ (routes/refunds.js)                              â”‚
â”‚    â†“                                                     â”‚
â”‚  æœåŠ¡å±‚:                                                  â”‚
â”‚    â€¢ wework-pay.service.js  (ä¼å¾®æ”¯ä»˜ API å°è£…)          â”‚
â”‚    â€¢ refund-record.service.js  (é€€æ¬¾è®°å½•ç®¡ç†)            â”‚
â”‚    â€¢ refund.service.js  (ä¸šåŠ¡é€»è¾‘åè°ƒ)                   â”‚
â”‚    â†“                                                     â”‚
â”‚  æ•°æ®å­˜å‚¨ (data/refund-records.json)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ä¼ä¸šå¾®ä¿¡æ”¯ä»˜ API (pay.weixin.qq.com)             â”‚
â”‚                                                           â”‚
â”‚  POST /v3/refund/domestic/refunds  (ç”³è¯·é€€æ¬¾)            â”‚
â”‚  GET /v3/refund/domestic/refunds/{out_refund_no} (æŸ¥è¯¢)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"æ‰§è¡Œé€€æ¬¾"
  â†’ å‰ç«¯æ˜¾ç¤ºç¡®è®¤å¼¹çª—
  â†’ è°ƒç”¨åç«¯ POST /api/refunds/batch
  â†’ æ£€æŸ¥é€€æ¬¾è®°å½• (é˜²é‡å¤)
  â†’ å¾ªç¯è°ƒç”¨ä¼å¾®é€€æ¬¾ API
  â†’ ä¿å­˜é€€æ¬¾è®°å½•åˆ° JSON æ–‡ä»¶
  â†’ è¿”å›é€€æ¬¾ç»“æœç»™å‰ç«¯
  â†’ å‰ç«¯æ˜¾ç¤ºæˆåŠŸ/å¤±è´¥è¯¦æƒ…
```

---

## ğŸ“¦ æŠ€æœ¯é€‰å‹

### åç«¯ä¾èµ–

| åº“ | ç‰ˆæœ¬ | ç”¨é€” |
|---|---|---|
| **wechatpay-node-v3** | ^2.1.8 | å¾®ä¿¡æ”¯ä»˜ v3 SDK |
| **uuid** | ^9.0.0 | ç”Ÿæˆå”¯ä¸€é€€æ¬¾å•å· |
| **fs-extra** | ^11.0.0 | JSON æ–‡ä»¶è¯»å†™ |

### æ•°æ®å­˜å‚¨æ–¹æ¡ˆ

**é€‰æ‹©**: JSON æ–‡ä»¶å­˜å‚¨

**ç†ç”±**:
- âœ… v0 ç‰ˆæœ¬æ— æ•°æ®åº“,ä¿æŒä¸€è‡´æ€§
- âœ… é€€æ¬¾è®°å½•æ•°é‡ä¸å¤§ (å•ä¸ªè®­ç»ƒè¥æœ€å¤š 200 äºº)
- âœ… æ— éœ€å¤æ‚æŸ¥è¯¢,ç®€å•è¯»å†™å³å¯
- âœ… ä¾¿äºè¿ç§»åˆ° v1 ç‰ˆæœ¬ (å¯å¯¼å…¥æ•°æ®åº“)

**æ–‡ä»¶è·¯å¾„**: `zsxq-api/data/refund-records.json`

**å¤‡ä»½ç­–ç•¥**: æ¯æ¬¡å†™å…¥å‰å¤‡ä»½åˆ° `data/backups/refund-records-{timestamp}.json`

---

## ğŸ’¾ æ•°æ®æ¨¡å‹è®¾è®¡

### é€€æ¬¾è®°å½•æ•°æ®ç»“æ„

```json
{
  "records": [
    {
      "id": "refund_20251030_abc123",
      "camp_id": "8424485212",
      "camp_title": "2510 AIç¼–ç¨‹",
      "planet_user_id": "88455815452182",
      "planet_nickname": "çƒçƒçš„å‰¯ä¸šæ¢ç´¢è·¯",
      "transaction_id": "4200001234567890",
      "out_trade_no": "ORDER_20251001_001",
      "refund_amount": 9900,
      "refund_reason": "å®Œæˆ7å¤©æ‰“å¡è¦æ±‚",
      "out_refund_no": "REFUND_20251030_abc123",
      "refund_status": "SUCCESS",
      "wechat_refund_id": "50000012345678901234567890",
      "refund_time": "2025-10-30T15:30:00.000Z",
      "retry_count": 0,
      "error_message": null,
      "created_at": "2025-10-30T15:30:00.000Z",
      "updated_at": "2025-10-30T15:30:05.000Z"
    }
  ],
  "meta": {
    "total_count": 1,
    "last_updated": "2025-10-30T15:30:05.000Z",
    "version": "1.0"
  }
}
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|-----|------|
| **id** | String | è®°å½•å”¯ä¸€ ID |
| **camp_id** | String | è®­ç»ƒè¥ ID |
| **camp_title** | String | è®­ç»ƒè¥æ ‡é¢˜ |
| **planet_user_id** | String | æ˜Ÿçƒç”¨æˆ· ID |
| **planet_nickname** | String | æ˜Ÿçƒæ˜µç§° |
| **transaction_id** | String | å¾®ä¿¡æ”¯ä»˜è®¢å•å· (å¿…éœ€) |
| **out_trade_no** | String | å•†æˆ·è®¢å•å· (å¯é€‰) |
| **refund_amount** | Number | é€€æ¬¾é‡‘é¢ (åˆ†) |
| **refund_reason** | String | é€€æ¬¾åŸå›  |
| **out_refund_no** | String | å•†æˆ·é€€æ¬¾å•å· (å”¯ä¸€) |
| **refund_status** | String | é€€æ¬¾çŠ¶æ€: PENDING/SUCCESS/FAILED |
| **wechat_refund_id** | String | å¾®ä¿¡é€€æ¬¾å•å· |
| **refund_time** | String | é€€æ¬¾æ—¶é—´ (ISO 8601) |
| **retry_count** | Number | é‡è¯•æ¬¡æ•° |
| **error_message** | String | é”™è¯¯ä¿¡æ¯ |
| **created_at** | String | åˆ›å»ºæ—¶é—´ |
| **updated_at** | String | æ›´æ–°æ—¶é—´ |

---

## ğŸ”§ ç¯å¢ƒå˜é‡é…ç½®

### æ–°å¢é…ç½® (.env)

```env
#######################################################
# å¾®ä¿¡æ”¯ä»˜é…ç½® (v0.1 æ–°å¢)
#######################################################

# åº”ç”¨ ID (å…¬ä¼—å·/å°ç¨‹åº/APP)
WECHAT_APP_ID=wx1234567890abcdef

# å•†æˆ·å·
WECHAT_MCH_ID=1234567890

# API v3 å¯†é’¥ (32ä½å­—ç¬¦ä¸²)
WECHAT_API_V3_KEY=your_api_v3_key_32_characters

# å•†æˆ·è¯ä¹¦åºåˆ—å·
WECHAT_SERIAL_NO=1234567890ABCDEF

# è¯ä¹¦æ–‡ä»¶è·¯å¾„ (ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•)
WECHAT_CERT_PATH=./certs/apiclient_cert.pem
WECHAT_KEY_PATH=./certs/apiclient_key.pem

# é€€æ¬¾é€šçŸ¥ URL (å¯é€‰ - v1 ç‰ˆæœ¬ä½¿ç”¨)
# WECHAT_REFUND_NOTIFY_URL=https://your-domain.com/api/webhook/wechat/refund

# é€€æ¬¾è‡ªåŠ¨é‡è¯•æ¬¡æ•° (é»˜è®¤: 1)
REFUND_RETRY_COUNT=1

# é€€æ¬¾è®°å½•æ–‡ä»¶è·¯å¾„ (é»˜è®¤: ./data/refund-records.json)
REFUND_RECORDS_PATH=./data/refund-records.json
```

### è¯ä¹¦æ–‡ä»¶ç®¡ç†

**è¯ä¹¦ç›®å½•ç»“æ„**:
```
zsxq-api/
â”œâ”€â”€ certs/                         # è¯ä¹¦ç›®å½• (æ·»åŠ åˆ° .gitignore)
â”‚   â”œâ”€â”€ apiclient_cert.pem         # å•†æˆ·APIè¯ä¹¦
â”‚   â”œâ”€â”€ apiclient_key.pem          # å•†æˆ·ç§é’¥
â”‚   â””â”€â”€ README.md                  # è¯ä¹¦è·å–è¯´æ˜
â””â”€â”€ data/                          # æ•°æ®ç›®å½•
    â”œâ”€â”€ refund-records.json        # é€€æ¬¾è®°å½•
    â””â”€â”€ backups/                   # å¤‡ä»½ç›®å½•
```

**å®‰å…¨æªæ–½**:
- âœ… è¯ä¹¦æ–‡ä»¶ä¸æäº¤åˆ° Git (`.gitignore`)
- âœ… ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–åŠ å¯†å­˜å‚¨
- âœ… æ–‡ä»¶æƒé™è®¾ç½®ä¸º 600 (ä»…æ‰€æœ‰è€…å¯è¯»å†™)

---

## ğŸ”Œ API æ¥å£è®¾è®¡

### 1. æ‰¹é‡æ‰§è¡Œé€€æ¬¾

**æ¥å£**: `POST /api/refunds/batch`

**è¯·æ±‚å‚æ•°**:
```json
{
  "camp_id": "8424485212",
  "camp_title": "2510 AIç¼–ç¨‹",
  "refunds": [
    {
      "planet_user_id": "88455815452182",
      "planet_nickname": "çƒçƒçš„å‰¯ä¸šæ¢ç´¢è·¯",
      "transaction_id": "4200001234567890",
      "refund_amount": 9900,
      "refund_reason": "å®Œæˆ7å¤©æ‰“å¡è¦æ±‚"
    }
  ]
}
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "æ‰¹é‡é€€æ¬¾å®Œæˆ",
  "data": {
    "total": 10,
    "success": 8,
    "failed": 2,
    "results": [
      {
        "planet_user_id": "88455815452182",
        "planet_nickname": "çƒçƒçš„å‰¯ä¸šæ¢ç´¢è·¯",
        "status": "SUCCESS",
        "out_refund_no": "REFUND_20251030_abc123",
        "wechat_refund_id": "50000012345678901234567890"
      },
      {
        "planet_user_id": "88455815452183",
        "planet_nickname": "ç”¨æˆ·B",
        "status": "FAILED",
        "error_code": "INVALID_REQUEST",
        "error_message": "è®¢å•å·ä¸å­˜åœ¨"
      }
    ]
  },
  "timestamp": 1730000000000
}
```

### 2. æŸ¥è¯¢é€€æ¬¾è®°å½•

**æ¥å£**: `GET /api/refunds?camp_id={camp_id}&status={status}`

**æŸ¥è¯¢å‚æ•°**:
- `camp_id` (å¯é€‰): è®­ç»ƒè¥ ID
- `status` (å¯é€‰): é€€æ¬¾çŠ¶æ€ (PENDING/SUCCESS/FAILED)
- `planet_user_id` (å¯é€‰): ç”¨æˆ· ID

**å“åº”**:
```json
{
  "code": 200,
  "message": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "records": [...],
    "total": 10,
    "success_count": 8,
    "failed_count": 2
  },
  "timestamp": 1730000000000
}
```

### 3. æŸ¥è¯¢å•ä¸ªé€€æ¬¾è¯¦æƒ…

**æ¥å£**: `GET /api/refunds/:out_refund_no`

**å“åº”**:
```json
{
  "code": 200,
  "message": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "record": { /* é€€æ¬¾è®°å½•è¯¦æƒ… */ },
    "wechat_status": {
      "refund_id": "50000012345678901234567890",
      "status": "SUCCESS",
      "success_time": "2025-10-30T15:30:05+08:00",
      "amount": {
        "refund": 9900,
        "payer_refund": 9900
      }
    }
  },
  "timestamp": 1730000000000
}
```

### 4. é‡è¯•å¤±è´¥çš„é€€æ¬¾

**æ¥å£**: `POST /api/refunds/:out_refund_no/retry`

**å“åº”**:
```json
{
  "code": 200,
  "message": "é‡è¯•æˆåŠŸ",
  "data": {
    "out_refund_no": "REFUND_20251030_abc123",
    "status": "SUCCESS",
    "retry_count": 1
  },
  "timestamp": 1730000000000
}
```

---

## ğŸ“ æ ¸å¿ƒä»£ç å®ç°

### 1. å¾®ä¿¡æ”¯ä»˜æœåŠ¡ (wework-pay.service.js)

```javascript
const WxPay = require('wechatpay-node-v3');
const fs = require('fs');
const logger = require('../utils/logger');

class WeworkPayService {
  constructor() {
    this.pay = new WxPay({
      appid: process.env.WECHAT_APP_ID,
      mchid: process.env.WECHAT_MCH_ID,
      publicKey: fs.readFileSync(process.env.WECHAT_CERT_PATH),
      privateKey: fs.readFileSync(process.env.WECHAT_KEY_PATH),
      key: process.env.WECHAT_API_V3_KEY,
    });
  }

  /**
   * ç”³è¯·é€€æ¬¾
   * @param {Object} params - é€€æ¬¾å‚æ•°
   * @returns {Promise<Object>} é€€æ¬¾ç»“æœ
   */
  async refund(params) {
    const { transaction_id, out_refund_no, refund_amount, total_amount, reason } = params;

    try {
      logger.info(`ç”³è¯·é€€æ¬¾: ${out_refund_no}, é‡‘é¢: ${refund_amount}åˆ†`);

      const result = await this.pay.refund({
        transaction_id,
        out_refund_no,
        reason,
        amount: {
          refund: refund_amount,
          total: total_amount,
          currency: 'CNY'
        }
      });

      logger.info(`é€€æ¬¾æˆåŠŸ: ${out_refund_no}, å¾®ä¿¡é€€æ¬¾å•å·: ${result.refund_id}`);
      return {
        success: true,
        refund_id: result.refund_id,
        status: result.status,
        success_time: result.success_time
      };

    } catch (error) {
      logger.error(`é€€æ¬¾å¤±è´¥: ${out_refund_no}`, error);
      return {
        success: false,
        error_code: error.code || 'UNKNOWN_ERROR',
        error_message: error.message
      };
    }
  }

  /**
   * æŸ¥è¯¢é€€æ¬¾çŠ¶æ€
   * @param {String} out_refund_no - å•†æˆ·é€€æ¬¾å•å·
   * @returns {Promise<Object>} é€€æ¬¾çŠ¶æ€
   */
  async queryRefund(out_refund_no) {
    try {
      const result = await this.pay.queryRefund({ out_refund_no });
      return {
        success: true,
        data: result
      };
    } catch (error) {
      logger.error(`æŸ¥è¯¢é€€æ¬¾å¤±è´¥: ${out_refund_no}`, error);
      return {
        success: false,
        error_message: error.message
      };
    }
  }
}

module.exports = new WeworkPayService();
```

### 2. é€€æ¬¾è®°å½•æœåŠ¡ (refund-record.service.js)

```javascript
const fs = require('fs-extra');
const path = require('path');
const logger = require('../utils/logger');

class RefundRecordService {
  constructor() {
    this.recordsPath = process.env.REFUND_RECORDS_PATH || './data/refund-records.json';
    this.backupDir = path.join(path.dirname(this.recordsPath), 'backups');
    this.ensureDataFile();
  }

  /**
   * ç¡®ä¿æ•°æ®æ–‡ä»¶å­˜åœ¨
   */
  async ensureDataFile() {
    await fs.ensureDir(path.dirname(this.recordsPath));
    await fs.ensureDir(this.backupDir);

    if (!await fs.pathExists(this.recordsPath)) {
      await this.saveRecords({ records: [], meta: { total_count: 0, last_updated: new Date().toISOString(), version: '1.0' } });
    }
  }

  /**
   * è¯»å–æ‰€æœ‰è®°å½•
   */
  async getRecords() {
    const data = await fs.readJson(this.recordsPath);
    return data;
  }

  /**
   * ä¿å­˜è®°å½• (å¸¦å¤‡ä»½)
   */
  async saveRecords(data) {
    // å¤‡ä»½ç°æœ‰æ–‡ä»¶
    if (await fs.pathExists(this.recordsPath)) {
      const backupPath = path.join(this.backupDir, `refund-records-${Date.now()}.json`);
      await fs.copy(this.recordsPath, backupPath);
    }

    // æ›´æ–°å…ƒæ•°æ®
    data.meta.last_updated = new Date().toISOString();
    data.meta.total_count = data.records.length;

    // ä¿å­˜æ–°æ•°æ®
    await fs.writeJson(this.recordsPath, data, { spaces: 2 });
    logger.info(`é€€æ¬¾è®°å½•å·²ä¿å­˜: ${data.records.length} æ¡`);
  }

  /**
   * æ·»åŠ é€€æ¬¾è®°å½•
   */
  async addRecord(record) {
    const data = await this.getRecords();
    record.id = `refund_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    record.created_at = new Date().toISOString();
    record.updated_at = record.created_at;
    data.records.push(record);
    await this.saveRecords(data);
    return record;
  }

  /**
   * æ£€æŸ¥é€€æ¬¾å•å·æ˜¯å¦å­˜åœ¨
   */
  async exists(out_refund_no) {
    const data = await this.getRecords();
    return data.records.some(r => r.out_refund_no === out_refund_no);
  }

  /**
   * æ ¹æ®å•†æˆ·é€€æ¬¾å•å·æŸ¥è¯¢è®°å½•
   */
  async findByOutRefundNo(out_refund_no) {
    const data = await this.getRecords();
    return data.records.find(r => r.out_refund_no === out_refund_no);
  }

  /**
   * æ›´æ–°è®°å½•çŠ¶æ€
   */
  async updateStatus(out_refund_no, updates) {
    const data = await this.getRecords();
    const index = data.records.findIndex(r => r.out_refund_no === out_refund_no);

    if (index !== -1) {
      data.records[index] = {
        ...data.records[index],
        ...updates,
        updated_at: new Date().toISOString()
      };
      await this.saveRecords(data);
      return data.records[index];
    }

    return null;
  }
}

module.exports = new RefundRecordService();
```

### 3. é€€æ¬¾è·¯ç”± (routes/refunds.js)

```javascript
const express = require('express');
const router = express.Router();
const { v4: uuidv4 } = require('uuid');
const weworkPayService = require('../services/wework-pay.service');
const refundRecordService = require('../services/refund-record.service');
const { success, error } = require('../utils/response');
const logger = require('../utils/logger');

/**
 * æ‰¹é‡æ‰§è¡Œé€€æ¬¾
 */
router.post('/batch', async (req, res, next) => {
  try {
    const { camp_id, camp_title, refunds } = req.body;

    const results = [];
    let successCount = 0;
    let failedCount = 0;

    for (const refund of refunds) {
      const out_refund_no = `REFUND_${Date.now()}_${uuidv4().substr(0, 8)}`;

      // æ£€æŸ¥æ˜¯å¦å·²é€€æ¬¾
      const exists = await refundRecordService.exists(out_refund_no);
      if (exists) {
        results.push({
          ...refund,
          status: 'SKIPPED',
          error_message: 'è¯¥è®¢å•å·²ç”³è¯·é€€æ¬¾'
        });
        continue;
      }

      // è°ƒç”¨å¾®ä¿¡é€€æ¬¾ API
      const result = await weworkPayService.refund({
        transaction_id: refund.transaction_id,
        out_refund_no,
        refund_amount: refund.refund_amount,
        total_amount: refund.refund_amount,
        reason: refund.refund_reason
      });

      // ä¿å­˜é€€æ¬¾è®°å½•
      const record = {
        camp_id,
        camp_title,
        planet_user_id: refund.planet_user_id,
        planet_nickname: refund.planet_nickname,
        transaction_id: refund.transaction_id,
        refund_amount: refund.refund_amount,
        refund_reason: refund.refund_reason,
        out_refund_no,
        refund_status: result.success ? 'SUCCESS' : 'FAILED',
        wechat_refund_id: result.refund_id || null,
        refund_time: result.success_time || new Date().toISOString(),
        retry_count: 0,
        error_message: result.error_message || null
      };

      await refundRecordService.addRecord(record);

      results.push({
        planet_user_id: refund.planet_user_id,
        planet_nickname: refund.planet_nickname,
        status: result.success ? 'SUCCESS' : 'FAILED',
        out_refund_no,
        wechat_refund_id: result.refund_id,
        error_code: result.error_code,
        error_message: result.error_message
      });

      if (result.success) successCount++;
      else failedCount++;
    }

    res.json(success({
      total: refunds.length,
      success: successCount,
      failed: failedCount,
      results
    }, 'æ‰¹é‡é€€æ¬¾å®Œæˆ'));

  } catch (err) {
    next(err);
  }
});

/**
 * æŸ¥è¯¢é€€æ¬¾è®°å½•
 */
router.get('/', async (req, res, next) => {
  try {
    const { camp_id, status, planet_user_id } = req.query;
    const data = await refundRecordService.getRecords();

    let records = data.records;

    // è¿‡æ»¤
    if (camp_id) records = records.filter(r => r.camp_id === camp_id);
    if (status) records = records.filter(r => r.refund_status === status);
    if (planet_user_id) records = records.filter(r => r.planet_user_id === planet_user_id);

    const successCount = records.filter(r => r.refund_status === 'SUCCESS').length;
    const failedCount = records.filter(r => r.refund_status === 'FAILED').length;

    res.json(success({
      records,
      total: records.length,
      success_count: successCount,
      failed_count: failedCount
    }));

  } catch (err) {
    next(err);
  }
});

/**
 * æŸ¥è¯¢å•ä¸ªé€€æ¬¾è¯¦æƒ…
 */
router.get('/:out_refund_no', async (req, res, next) => {
  try {
    const { out_refund_no } = req.params;
    const record = await refundRecordService.findByOutRefundNo(out_refund_no);

    if (!record) {
      return res.json(error('é€€æ¬¾è®°å½•ä¸å­˜åœ¨', 404));
    }

    // æŸ¥è¯¢å¾®ä¿¡é€€æ¬¾çŠ¶æ€
    const wechatStatus = await weworkPayService.queryRefund(out_refund_no);

    res.json(success({
      record,
      wechat_status: wechatStatus.success ? wechatStatus.data : null
    }));

  } catch (err) {
    next(err);
  }
});

/**
 * é‡è¯•å¤±è´¥çš„é€€æ¬¾
 */
router.post('/:out_refund_no/retry', async (req, res, next) => {
  try {
    const { out_refund_no } = req.params;
    const record = await refundRecordService.findByOutRefundNo(out_refund_no);

    if (!record) {
      return res.json(error('é€€æ¬¾è®°å½•ä¸å­˜åœ¨', 404));
    }

    if (record.refund_status === 'SUCCESS') {
      return res.json(error('è¯¥é€€æ¬¾å·²æˆåŠŸ,æ— éœ€é‡è¯•', 400));
    }

    // é‡æ–°è°ƒç”¨é€€æ¬¾ API
    const result = await weworkPayService.refund({
      transaction_id: record.transaction_id,
      out_refund_no: record.out_refund_no,
      refund_amount: record.refund_amount,
      total_amount: record.refund_amount,
      reason: record.refund_reason
    });

    // æ›´æ–°è®°å½•
    const updated = await refundRecordService.updateStatus(out_refund_no, {
      refund_status: result.success ? 'SUCCESS' : 'FAILED',
      wechat_refund_id: result.refund_id || record.wechat_refund_id,
      refund_time: result.success_time || record.refund_time,
      retry_count: record.retry_count + 1,
      error_message: result.error_message || record.error_message
    });

    res.json(success(updated, 'é‡è¯•å®Œæˆ'));

  } catch (err) {
    next(err);
  }
});

module.exports = router;
```

---

## ğŸ¨ å‰ç«¯å®ç°

### é€€æ¬¾æ“ä½œæµç¨‹

**RefundList.vue ä¿®æ”¹**:

```vue
<template>
  <div class="refund-list-page">
    <!-- ç°æœ‰å†…å®¹ä¿æŒä¸å˜ -->

    <!-- æ–°å¢: æ‰§è¡Œé€€æ¬¾æŒ‰é’® -->
    <el-row :gutter="20" style="margin-top: 20px">
      <el-col :span="24">
        <el-button
          type="danger"
          size="large"
          @click="handleExecuteRefund"
          :disabled="!hasQualifiedUsers"
          :loading="refundLoading">
          <el-icon><Money /></el-icon>
          æ‰§è¡Œé€€æ¬¾ ({{ statistics.qualified_count }}äºº)
        </el-button>
      </el-col>
    </el-row>

    <!-- é€€æ¬¾ç¡®è®¤å¯¹è¯æ¡† -->
    <el-dialog
      v-model="refundDialogVisible"
      title="ç¡®è®¤æ‰§è¡Œé€€æ¬¾"
      width="600px">
      <el-alert type="warning" :closable="false" style="margin-bottom: 20px">
        <p><strong>å³å°†ä¸ºä»¥ä¸‹ {{ refundList.length }} ä½ç”¨æˆ·é€€æ¬¾</strong></p>
        <p>æ€»é‡‘é¢: Â¥{{ totalRefundAmount / 100 }} å…ƒ</p>
        <p style="color: red;">âš ï¸ æ­¤æ“ä½œä¸å¯æ’¤é”€,è¯·ç¡®è®¤æ— è¯¯åå†æ‰§è¡Œ!</p>
      </el-alert>

      <el-table :data="refundList" height="300" border>
        <el-table-column prop="planet_nickname" label="ç”¨æˆ·æ˜µç§°" width="200" />
        <el-table-column prop="checkined_days" label="æ‰“å¡å¤©æ•°" width="100" />
        <el-table-column label="é€€æ¬¾é‡‘é¢" width="120">
          <template #default="scope">
            <el-input
              v-model="scope.row.refund_amount"
              placeholder="é‡‘é¢(å…ƒ)"
              size="small" />
          </template>
        </el-table-column>
        <el-table-column label="å¾®ä¿¡è®¢å•å·" width="180">
          <template #default="scope">
            <el-input
              v-model="scope.row.transaction_id"
              placeholder="å¿…å¡«"
              size="small" />
          </template>
        </el-table-column>
      </el-table>

      <template #footer>
        <el-button @click="refundDialogVisible = false">å–æ¶ˆ</el-button>
        <el-button
          type="danger"
          @click="confirmRefund"
          :loading="refundLoading">
          ç¡®è®¤é€€æ¬¾
        </el-button>
      </template>
    </el-dialog>

    <!-- é€€æ¬¾è¿›åº¦å¯¹è¯æ¡† -->
    <el-dialog
      v-model="progressDialogVisible"
      title="é€€æ¬¾è¿›åº¦"
      width="500px"
      :close-on-click-modal="false">
      <el-progress
        :percentage="refundProgress"
        :status="refundProgressStatus" />
      <p style="margin-top: 10px; text-align: center;">
        {{ refundProgressText }}
      </p>
    </el-dialog>

    <!-- é€€æ¬¾ç»“æœå¯¹è¯æ¡† -->
    <el-dialog
      v-model="resultDialogVisible"
      title="é€€æ¬¾ç»“æœ"
      width="600px">
      <el-result
        :icon="refundResult.success > 0 ? 'success' : 'error'"
        :title="`æˆåŠŸ ${refundResult.success} ç¬”, å¤±è´¥ ${refundResult.failed} ç¬”`">
        <template #extra>
          <el-button type="primary" @click="resultDialogVisible = false">
            ç¡®å®š
          </el-button>
        </template>
      </el-result>

      <el-table :data="refundResult.results" border>
        <el-table-column prop="planet_nickname" label="ç”¨æˆ·" width="150" />
        <el-table-column label="çŠ¶æ€" width="100">
          <template #default="scope">
            <el-tag :type="scope.row.status === 'SUCCESS' ? 'success' : 'danger'">
              {{ scope.row.status }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="error_message" label="è¯´æ˜" />
      </el-table>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue';
import { executeRefund } from '@/api/camps';
import { ElMessage, ElMessageBox } from 'element-plus';

// ... ç°æœ‰ä»£ç  ...

const refundDialogVisible = ref(false);
const progressDialogVisible = ref(false);
const resultDialogVisible = ref(false);
const refundLoading = ref(false);
const refundList = ref([]);
const refundProgress = ref(0);
const refundProgressStatus = ref('');
const refundProgressText = ref('');
const refundResult = ref({ success: 0, failed: 0, results: [] });

const hasQualifiedUsers = computed(() => {
  return statistics.value.qualified_count > 0;
});

const totalRefundAmount = computed(() => {
  return refundList.value.reduce((sum, item) => sum + (item.refund_amount * 100 || 0), 0);
});

/**
 * å¤„ç†æ‰§è¡Œé€€æ¬¾
 */
const handleExecuteRefund = () => {
  // å‡†å¤‡é€€æ¬¾åˆ—è¡¨ (ä»…åˆæ ¼ç”¨æˆ·)
  refundList.value = refundData.value.refund_list
    .filter(user => user.is_qualified)
    .map(user => ({
      planet_user_id: user.planet_user_id,
      planet_nickname: user.planet_nickname,
      checkined_days: user.checkined_days,
      refund_amount: 99, // é»˜è®¤99å…ƒ,å¯ç¼–è¾‘
      transaction_id: '', // éœ€è¦ç”¨æˆ·å¡«å…¥
      refund_reason: `å®Œæˆ${form.value.requiredDays}å¤©æ‰“å¡è¦æ±‚`
    }));

  refundDialogVisible.value = true;
};

/**
 * ç¡®è®¤é€€æ¬¾
 */
const confirmRefund = async () => {
  // éªŒè¯å¾®ä¿¡è®¢å•å·
  const missingTransactionIds = refundList.value.filter(item => !item.transaction_id);
  if (missingTransactionIds.length > 0) {
    ElMessage.error(`æœ‰ ${missingTransactionIds.length} ä¸ªç”¨æˆ·æœªå¡«å†™å¾®ä¿¡è®¢å•å·`);
    return;
  }

  refundDialogVisible.value = false;
  progressDialogVisible.value = true;
  refundLoading.value = true;

  try {
    refundProgress.value = 0;
    refundProgressText.value = 'æ­£åœ¨æ‰§è¡Œé€€æ¬¾...';
    refundProgressStatus.value = '';

    // è°ƒç”¨é€€æ¬¾ API
    const response = await executeRefund({
      camp_id: route.params.id,
      camp_title: route.query.title,
      refunds: refundList.value.map(item => ({
        planet_user_id: item.planet_user_id,
        planet_nickname: item.planet_nickname,
        transaction_id: item.transaction_id,
        refund_amount: item.refund_amount * 100, // è½¬ä¸ºåˆ†
        refund_reason: item.refund_reason
      }))
    });

    refundProgress.value = 100;
    refundProgressStatus.value = 'success';
    refundProgressText.value = 'é€€æ¬¾å®Œæˆ';

    // æ˜¾ç¤ºç»“æœ
    refundResult.value = response.data;

    setTimeout(() => {
      progressDialogVisible.value = false;
      resultDialogVisible.value = true;
    }, 1000);

  } catch (error) {
    refundProgress.value = 100;
    refundProgressStatus.value = 'exception';
    refundProgressText.value = 'é€€æ¬¾å¤±è´¥';
    ElMessage.error(error.response?.data?.message || 'é€€æ¬¾å¤±è´¥');
  } finally {
    refundLoading.value = false;
  }
};
</script>
```

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

1. **wework-pay.service.js**
   - âœ… æ­£å¸¸é€€æ¬¾æˆåŠŸ
   - âœ… é€€æ¬¾é‡‘é¢é”™è¯¯
   - âœ… è®¢å•å·ä¸å­˜åœ¨
   - âœ… è¯ä¹¦æ–‡ä»¶ç¼ºå¤±
   - âœ… API è¶…æ—¶

2. **refund-record.service.js**
   - âœ… æ·»åŠ è®°å½•
   - âœ… æŸ¥è¯¢è®°å½•
   - âœ… æ›´æ–°è®°å½•
   - âœ… é˜²é‡å¤æ£€æŸ¥
   - âœ… æ–‡ä»¶å¤‡ä»½

### é›†æˆæµ‹è¯•

1. **é€€æ¬¾æµç¨‹**
   - âœ… æ‰¹é‡é€€æ¬¾æˆåŠŸ
   - âœ… éƒ¨åˆ†æˆåŠŸéƒ¨åˆ†å¤±è´¥
   - âœ… å…¨éƒ¨å¤±è´¥
   - âœ… é‡å¤é€€æ¬¾æ‹¦æˆª

2. **å¼‚å¸¸åœºæ™¯**
   - âœ… ç½‘ç»œå¼‚å¸¸
   - âœ… API é™æµ
   - âœ… è¯ä¹¦è¿‡æœŸ
   - âœ… JSON æ–‡ä»¶æŸå

### æ‰‹åŠ¨æµ‹è¯•

1. **å‰ç«¯äº¤äº’**
   - âœ… é€€æ¬¾ç¡®è®¤å¼¹çª—
   - âœ… è¿›åº¦æ¡æ˜¾ç¤º
   - âœ… ç»“æœå±•ç¤º
   - âœ… å¤±è´¥é‡è¯•

---

## ğŸ“‹ å¼€å‘ä»»åŠ¡æ¸…å•

### åç«¯å¼€å‘ (é¢„è®¡ 6-8 å°æ—¶)

- [ ] **Task 1**: å®‰è£…ä¾èµ– (0.5h)
  - `npm install wechatpay-node-v3 uuid fs-extra`

- [ ] **Task 2**: å®ç° wework-pay.service.js (2h)
  - é€€æ¬¾æ¥å£å°è£…
  - æŸ¥è¯¢é€€æ¬¾çŠ¶æ€
  - é”™è¯¯å¤„ç†

- [ ] **Task 3**: å®ç° refund-record.service.js (1.5h)
  - JSON æ–‡ä»¶è¯»å†™
  - è®°å½•å¢åˆ æ”¹æŸ¥
  - è‡ªåŠ¨å¤‡ä»½

- [ ] **Task 4**: å®ç° routes/refunds.js (2h)
  - æ‰¹é‡é€€æ¬¾æ¥å£
  - æŸ¥è¯¢è®°å½•æ¥å£
  - é‡è¯•å¤±è´¥æ¥å£

- [ ] **Task 5**: å•å…ƒæµ‹è¯• (1h)
  - æœåŠ¡å±‚æµ‹è¯•
  - è·¯ç”±æµ‹è¯•

### å‰ç«¯å¼€å‘ (é¢„è®¡ 4-5 å°æ—¶)

- [ ] **Task 6**: RefundList.vue ä¿®æ”¹ (3h)
  - æ‰§è¡Œé€€æ¬¾æŒ‰é’®
  - ç¡®è®¤å¼¹çª—
  - è¿›åº¦æ˜¾ç¤º
  - ç»“æœå±•ç¤º

- [ ] **Task 7**: API å°è£… (1h)
  - `executeRefund()` æ–¹æ³•
  - `queryRefunds()` æ–¹æ³•

- [ ] **Task 8**: å‰ç«¯æµ‹è¯• (1h)
  - äº¤äº’æµ‹è¯•
  - è¾¹ç•Œæµ‹è¯•

### éƒ¨ç½²å’Œæµ‹è¯• (é¢„è®¡ 2-3 å°æ—¶)

- [ ] **Task 9**: å‡†å¤‡è¯ä¹¦æ–‡ä»¶ (0.5h)
  - ä¸‹è½½è¯ä¹¦
  - é…ç½®è·¯å¾„

- [ ] **Task 10**: ç¯å¢ƒå˜é‡é…ç½® (0.5h)
  - æ›´æ–° .env.example
  - é…ç½®ç”Ÿäº§ç¯å¢ƒ

- [ ] **Task 11**: ç”Ÿäº§éƒ¨ç½² (1h)
  - éƒ¨ç½²åˆ°æœåŠ¡å™¨
  - ç”Ÿäº§æµ‹è¯•

---

## âš ï¸ é£é™©å’Œæ³¨æ„äº‹é¡¹

### å®‰å…¨é£é™©

1. **è¯ä¹¦æ³„éœ²**
   - âŒ ä¸è¦æäº¤è¯ä¹¦åˆ° Git
   - âœ… ä½¿ç”¨ .gitignore æ’é™¤
   - âœ… ç”Ÿäº§ç¯å¢ƒä½¿ç”¨åŠ å¯†å­˜å‚¨

2. **é‡å¤é€€æ¬¾**
   - âœ… ä½¿ç”¨å”¯ä¸€é€€æ¬¾å•å·
   - âœ… é€€æ¬¾å‰æ£€æŸ¥è®°å½•
   - âœ… å¹‚ç­‰æ€§ä¿è¯

3. **æ•°æ®ä¸¢å¤±**
   - âœ… æ¯æ¬¡å†™å…¥å‰è‡ªåŠ¨å¤‡ä»½
   - âœ… ä¿ç•™æœ€è¿‘ 30 å¤©å¤‡ä»½
   - âœ… å®šæœŸå¯¼å‡ºåˆ°å®‰å…¨ä½ç½®

### ä¸šåŠ¡é£é™©

1. **é€€æ¬¾é‡‘é¢é”™è¯¯**
   - âœ… å‰ç«¯äºŒæ¬¡ç¡®è®¤
   - âœ… é€€æ¬¾é‡‘é¢ä¸åŸè®¢å•åŒ¹é…
   - âœ… æ”¯æŒæ‰‹åŠ¨ä¿®æ­£

2. **è®¢å•å·ç¼ºå¤±**
   - âš ï¸ **v0.1 é™åˆ¶**: éœ€è¦æ‰‹åŠ¨è¾“å…¥å¾®ä¿¡è®¢å•å·
   - ğŸ“Œ v1 ç‰ˆæœ¬: ä»æ”¯ä»˜è®°å½•è‡ªåŠ¨å…³è”

3. **é€€æ¬¾å¤±è´¥å¤„ç†**
   - âœ… è‡ªåŠ¨é‡è¯• 1 æ¬¡
   - âœ… å¤±è´¥è®°å½•æ ‡è®°
   - âœ… æ”¯æŒæ‰‹åŠ¨é‡è¯•

### æŠ€æœ¯é£é™©

1. **JSON æ–‡ä»¶å¹¶å‘å†™å…¥**
   - âš ï¸ å•è¿›ç¨‹åº”ç”¨,æš‚æ— å¹¶å‘é—®é¢˜
   - ğŸ“Œ v1 ç‰ˆæœ¬: ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡

2. **æ–‡ä»¶å¤§å°å¢é•¿**
   - âœ… å•ä¸ªè®­ç»ƒè¥æœ€å¤š 200 æ¡è®°å½•
   - âœ… å®šæœŸå½’æ¡£å†å²æ•°æ®
   - ğŸ“Œ v1 ç‰ˆæœ¬: è¿ç§»åˆ°æ•°æ®åº“

---

## ğŸ”„ è¿ç§»åˆ° v1 ç‰ˆæœ¬

### æ•°æ®è¿ç§»è„šæœ¬

```javascript
// scripts/migrate-refund-records-to-v1.js

const fs = require('fs-extra');
const { Pool } = require('pg');

async function migrate() {
  // è¯»å– JSON æ–‡ä»¶
  const data = await fs.readJson('./data/refund-records.json');

  // è¿æ¥æ•°æ®åº“
  const pool = new Pool({
    host: 'localhost',
    database: 'camp_db',
    user: 'postgres',
    password: 'your_password'
  });

  // æ’å…¥è®°å½•
  for (const record of data.records) {
    await pool.query(`
      INSERT INTO refund_record (
        camp_id, planet_user_id, transaction_id,
        refund_amount, out_refund_no, refund_status,
        wechat_refund_id, refund_time, created_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    `, [
      record.camp_id,
      record.planet_user_id,
      record.transaction_id,
      record.refund_amount,
      record.out_refund_no,
      record.refund_status,
      record.wechat_refund_id,
      record.refund_time,
      record.created_at
    ]);
  }

  console.log(`å·²è¿ç§» ${data.records.length} æ¡é€€æ¬¾è®°å½•`);
  await pool.end();
}

migrate().catch(console.error);
```

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [å¾®ä¿¡æ”¯ä»˜ API v3 å®˜æ–¹æ–‡æ¡£](https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml)
- [ç”³è¯·é€€æ¬¾æ¥å£](https://pay.weixin.qq.com/doc/v3/merchant/4013071036)
- [wechatpay-node-v3 SDK](https://github.com/klover2/wechatpay-node-v3-ts)
- [å¾®ä¿¡æ”¯ä»˜è¯ä¹¦è·å–æŒ‡å—](https://pay.weixin.qq.com/doc/v3/merchant/4012456946)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-30
**ä¸‹ä¸€æ­¥**: å¼€å§‹åç«¯ä»£ç å®ç°