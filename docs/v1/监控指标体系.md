# ç›‘æ§æŒ‡æ ‡ä½“ç³»

> **æ–‡æ¡£ç›®çš„**ï¼šå®šä¹‰ç³»ç»Ÿç›‘æ§æŒ‡æ ‡ï¼Œæ”¯æ’‘StageéªŒæ”¶å’Œç”Ÿäº§è¿ç»´
> **å¯¹åº”å†³ç­–**ï¼šè®¾è®¡ä¼˜åŒ–å†³ç­–æ–‡æ¡£ P2-1ï¼ˆç›‘æ§æŒ‡æ ‡ç»†ç²’åº¦æå‡ï¼‰

---

## ğŸ“Š ç›‘æ§åˆ†å±‚ä½“ç³»

```
Layer 5: ç”¨æˆ·ä½“éªŒæŒ‡æ ‡
    â†‘
Layer 4: ä¸šåŠ¡æŒ‡æ ‡ â­ æ ¸å¿ƒ
    â†‘
Layer 3: åº”ç”¨æŒ‡æ ‡
    â†‘
Layer 2: åŸºç¡€è®¾æ–½æŒ‡æ ‡
    â†‘
Layer 1: ç³»ç»ŸæŒ‡æ ‡
```

---

## Layer 1 - ç³»ç»ŸæŒ‡æ ‡ï¼ˆå·²æœ‰ï¼‰

| æŒ‡æ ‡ | é˜ˆå€¼ | å‘Šè­¦çº§åˆ« |
|------|------|---------|
| CPUä½¿ç”¨ç‡ | >80% | ğŸŸ  P1 |
| å†…å­˜ä½¿ç”¨ç‡ | >85% | ğŸŸ  P1 |
| ç£ç›˜ä½¿ç”¨ç‡ | >90% | ğŸŸ¡ P2 |
| ç½‘ç»œå¼‚å¸¸ | >10æ¬¡/åˆ†é’Ÿ | ğŸŸ¡ P2 |

---

## Layer 2 - åŸºç¡€è®¾æ–½æŒ‡æ ‡ï¼ˆæ–°å¢ï¼‰

### PostgreSQL

| æŒ‡æ ‡ | é˜ˆå€¼ | å‘Šè­¦çº§åˆ« | PrometheusæŒ‡æ ‡ |
|------|------|---------|---------------|
| æ…¢æŸ¥è¯¢æ•°é‡ | >50æ¬¡/å°æ—¶ | ğŸŸ¡ P2 | `pg_stat_statements_slow_queries` |
| è¿æ¥æ± ä½¿ç”¨ç‡ | >80% | ğŸŸ  P1 | `hikaricp_connections_active / hikaricp_connections_max` |
| æ­»é”æ¬¡æ•° | >5æ¬¡/å°æ—¶ | ğŸŸ  P1 | `pg_stat_database_deadlocks` |
| æ•°æ®åº“å¤§å° | >80% | ğŸŸ¡ P2 | `pg_database_size_bytes` |

### Redis

| æŒ‡æ ‡ | é˜ˆå€¼ | å‘Šè­¦çº§åˆ« | PrometheusæŒ‡æ ‡ |
|------|------|---------|---------------|
| ç¼“å­˜å‘½ä¸­ç‡ | <90% | ğŸŸ¡ P2 | `redis_keyspace_hits / (redis_keyspace_hits + redis_keyspace_misses)` |
| Keyé©±é€ç‡ | >10/ç§’ | ğŸŸ  P1 | `redis_evicted_keys_total` |
| å†…å­˜ä½¿ç”¨ç‡ | >80% | ğŸŸ  P1 | `redis_memory_used_bytes / redis_memory_max_bytes` |
| è¿æ¥æ•° | >1000 | ğŸŸ¡ P2 | `redis_connected_clients` |

---

## Layer 3 - åº”ç”¨æŒ‡æ ‡ï¼ˆæ–°å¢ï¼‰

### æ¥å£æ€§èƒ½

| æŒ‡æ ‡ | é˜ˆå€¼ | å‘Šè­¦çº§åˆ« | PrometheusæŒ‡æ ‡ |
|------|------|---------|---------------|
| P99å“åº”æ—¶é—´ | >2s | ğŸŸ  P1 | `http_server_requests_seconds{quantile="0.99"}` |
| æ¥å£é”™è¯¯ç‡ | >1% | ğŸŸ  P1 | `http_server_requests_total{status=~"5.."}` |
| QPS | ç¿»å€ï¼ˆ5åˆ†é’Ÿï¼‰ | ğŸŸ¡ P2 | `rate(http_server_requests_total[5m])` |
| å¹¶å‘è¿æ¥æ•° | >500 | ğŸŸ¡ P2 | `tomcat_threads_busy_threads` |

### å¼‚æ­¥ä»»åŠ¡

| æŒ‡æ ‡ | é˜ˆå€¼ | å‘Šè­¦çº§åˆ« | PrometheusæŒ‡æ ‡ |
|------|------|---------|---------------|
| ä»»åŠ¡é˜Ÿåˆ—ç§¯å‹ | >100 | ğŸŸ  P1 | `executor_queue_remaining_tasks` |
| ä»»åŠ¡å¤±è´¥ç‡ | >5% | ğŸŸ  P1 | `task_execution_failed_total / task_execution_total` |
| ä»»åŠ¡æ‰§è¡Œæ—¶é•¿ | P95>10s | ğŸŸ¡ P2 | `task_execution_seconds{quantile="0.95"}` |

---

## Layer 4 - ä¸šåŠ¡æŒ‡æ ‡ï¼ˆé‡ç‚¹æ–°å¢ï¼‰â­

### æ”¯ä»˜æµç¨‹

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å‘Šè­¦é˜ˆå€¼ | è®¡ç®—å…¬å¼ |
|------|--------|---------|---------|
| **æ”¯ä»˜æˆåŠŸç‡** | >95% | <90% | `(pay_status=SUCCESS) / (æ€»è®¢å•æ•°)` |
| **æ”¯ä»˜å›è°ƒå»¶è¿Ÿ** | P95<3s | P95>5s | `æ”¯ä»˜å›è°ƒæ—¶é—´ - æ”¯ä»˜å®Œæˆæ—¶é—´` |
| **è®¢å•ç»‘å®šå®Œæˆç‡** | >85% | <80% | `(bind_status=completed) / (7å¤©å†…è®¢å•æ•°)` |
| æ”¯ä»˜è¶…æ—¶è®¢å•æ•° | <5% | >10% | `(pay_status=PENDINGä¸”è¶…30åˆ†é’Ÿ) / æ€»è®¢å•` |

**PrometheusæŒ‡æ ‡**ï¼š
```promql
# æ”¯ä»˜æˆåŠŸç‡
sum(payment_status{status="SUCCESS"}) / sum(payment_status)

# è®¢å•ç»‘å®šå®Œæˆç‡ï¼ˆ7å¤©å†…ï¼‰
sum(bind_status{status="completed", created_within="7d"}) / sum(payment_status{status="SUCCESS", created_within="7d"})
```

### èº«ä»½åŒ¹é…

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å‘Šè­¦é˜ˆå€¼ | è®¡ç®—å…¬å¼ |
|------|--------|---------|---------|
| **è‡ªåŠ¨åŒ¹é…æˆåŠŸç‡** | >80% | <70% | `(bind_method IN ('user_fill','smart_match')) / æ€»è®¢å•` |
| **äººå·¥å®¡æ ¸å æ¯”** | <15% | >20% | `(bind_status='manual_review') / æ€»è®¢å•` |
| åŒ¹é…ç½®ä¿¡åº¦å¹³å‡å€¼ | >85% | <75% | `AVG(match_confidence WHERE bind_method='smart_match')` |

### æ‰“å¡åŒæ­¥

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å‘Šè­¦é˜ˆå€¼ | è®¡ç®—å…¬å¼ |
|------|--------|---------|---------|
| **æ‰“å¡æ•°æ®åŒæ­¥å»¶è¿Ÿ** | <10åˆ†é’Ÿ | >30åˆ†é’Ÿ | `NOW() - MAX(checkin_record.synced_at)` |
| **åŒæ­¥å¤±è´¥ç‡** | <1% | >5% | `(å¤±è´¥æ¬¡æ•°) / (æ€»åŒæ­¥ä»»åŠ¡æ•°)` |
| å•æ¬¡åŒæ­¥è€—æ—¶ | <30s | >60s | `sync_task_duration` |

### é€€æ¬¾å¤„ç†

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å‘Šè­¦é˜ˆå€¼ | è®¡ç®—å…¬å¼ |
|------|--------|---------|---------|
| **é€€æ¬¾æ‰§è¡Œå¹³å‡è€—æ—¶** | <30åˆ†é’Ÿ | >2å°æ—¶ | `AVG(processed_at - created_at)` |
| **é€€æ¬¾æˆåŠŸç‡** | >99% | <95% | `(refund_status='SUCCESS') / æ€»é€€æ¬¾æ•°` |
| å¾…å®¡æ ¸é€€æ¬¾ç§¯å‹ | <10 | >50 | `COUNT(*) WHERE audit_status='PENDING'` |

---

## Layer 5 - ç”¨æˆ·ä½“éªŒæŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å‘Šè­¦é˜ˆå€¼ | ç›‘æ§å·¥å…· |
|------|--------|---------|---------|
| H5é¡µé¢åŠ è½½æ—¶é—´ | P95<2s | P95>3s | Lighthouse |
| æ”¯ä»˜è·³è½¬æˆåŠŸç‡ | >98% | <95% | å‰ç«¯åŸ‹ç‚¹ |
| é¡µé¢JSé”™è¯¯ç‡ | <0.1% | >1% | Sentry |

---

## ğŸ”” å‘Šè­¦ç­–ç•¥

### å‘Šè­¦çº§åˆ«

| çº§åˆ« | å“åº”æ—¶é—´ | é€šçŸ¥æ–¹å¼ | ç¤ºä¾‹ |
|------|---------|---------|------|
| **P0-ç´§æ€¥** | ç«‹å³å¤„ç† | ç”µè¯+ä¼ä¸šå¾®ä¿¡+çŸ­ä¿¡ | æ”¯ä»˜å›è°ƒå¤±è´¥ç‡>10%ã€æ•°æ®åº“è¿æ¥æ± è€—å°½ |
| **P1-ä¸¥é‡** | 15åˆ†é’Ÿå†… | ä¼ä¸šå¾®ä¿¡+é‚®ä»¶ | æ”¯ä»˜æˆåŠŸç‡<90%ã€é€€æ¬¾æˆåŠŸç‡<95% |
| **P2-è­¦å‘Š** | 1å°æ—¶å†… | ä¼ä¸šå¾®ä¿¡ | æ‰“å¡åŒæ­¥å»¶è¿Ÿ>30åˆ†é’Ÿã€ç¼“å­˜å‘½ä¸­ç‡<80% |
| **P3-ä¿¡æ¯** | å·¥ä½œæ—¶é—´å¤„ç† | é‚®ä»¶ | äººå·¥å®¡æ ¸è®¢å•ç§¯å‹>10ã€ç£ç›˜ä½¿ç”¨ç‡>70% |

### å‘Šè­¦é…ç½®ç¤ºä¾‹ï¼ˆPrometheus AlertManagerï¼‰

```yaml
groups:
  - name: payment_alerts
    interval: 30s
    rules:
      - alert: PaymentSuccessRateLow
        expr: |
          (
            sum(rate(payment_status{status="SUCCESS"}[5m]))
            /
            sum(rate(payment_status[5m]))
          ) < 0.90
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "æ”¯ä»˜æˆåŠŸç‡è¿‡ä½"
          description: "å½“å‰æ”¯ä»˜æˆåŠŸç‡ä¸º {{ $value | humanizePercentage }}ï¼Œä½äº90%é˜ˆå€¼"

      - alert: BindStatusExpiredHigh
        expr: |
          (
            count(bind_status{status="expired"})
            /
            count(payment_status{status="SUCCESS"})
          ) > 0.15
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "ç»‘å®šè¶…æ—¶è®¢å•è¿‡å¤š"
          description: "{{ $value | humanizePercentage }} çš„è®¢å•è¶…æ—¶æœªç»‘å®š"
```

---

## ğŸ“ˆ Grafanaä»ªè¡¨ç›˜æ¨¡æ¿

### ä»ªè¡¨ç›˜1ï¼šæ”¯ä»˜æµç¨‹ç›‘æ§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ”¯ä»˜æˆåŠŸç‡: 96.5% â†‘    è®¢å•ç»‘å®šç‡: 88.2% â†“              â”‚
â”‚  æ”¯ä»˜æ€»æ•°: 1,234        å¾…ç»‘å®šè®¢å•: 45                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ”¯ä»˜æˆåŠŸç‡è¶‹åŠ¿ï¼ˆ24å°æ—¶ï¼‰  â”‚ â”‚ è®¢å•ç»‘å®šçŠ¶æ€åˆ†å¸ƒ           â”‚
â”‚                        â”‚ â”‚                             â”‚
â”‚ [æŠ˜çº¿å›¾]               â”‚ â”‚ [é¥¼å›¾]                      â”‚
â”‚ ç›®æ ‡çº¿: 95%            â”‚ â”‚ completed: 75%              â”‚
â”‚                        â”‚ â”‚ pending: 15%                â”‚
â”‚                        â”‚ â”‚ expired: 8%                 â”‚
â”‚                        â”‚ â”‚ manual_review: 2%           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ”¯ä»˜å›è°ƒå“åº”æ—¶é—´åˆ†å¸ƒï¼ˆP50/P90/P99ï¼‰                      â”‚
â”‚ [çƒ­åŠ›å›¾]                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»ªè¡¨ç›˜2ï¼šè®­ç»ƒè¥è¿è¥ç›‘æ§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ´»è·ƒè®­ç»ƒè¥: 3ä¸ª        æ€»ä¼šå‘˜æ•°: 456                      â”‚
â”‚  ä»Šæ—¥æ‰“å¡: 312æ¬¡        å¾…å®¡æ ¸é€€æ¬¾: 5ç¬”                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®­ç»ƒè¥æ‰“å¡è¶‹åŠ¿           â”‚ â”‚ é€€æ¬¾å®¡æ ¸çŠ¶æ€                â”‚
â”‚ [å¤šæŠ˜çº¿å›¾]              â”‚ â”‚ [æ¡å½¢å›¾]                    â”‚
â”‚ è®­ç»ƒè¥A: 120äºº          â”‚ â”‚ å¾…å®¡æ ¸: 5                   â”‚
â”‚ è®­ç»ƒè¥B: 98äºº           â”‚ â”‚ å®¡æ ¸ä¸­: 2                   â”‚
â”‚ è®­ç»ƒè¥C: 94äºº           â”‚ â”‚ å·²å®Œæˆ: 48                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› ï¸ å®æ–½æ­¥éª¤

### Stage 0-1: åŸºç¡€ç›‘æ§

- [ ] é›†æˆSpring Boot Actuator
- [ ] é…ç½®Prometheusæ•°æ®é‡‡é›†
- [ ] éƒ¨ç½²Grafana + åŸºç¡€ä»ªè¡¨ç›˜
- [ ] é…ç½®AlertManagerå‘Šè­¦è§„åˆ™

### Stage 2-3: ä¸šåŠ¡ç›‘æ§

- [ ] å®ç°è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡é‡‡é›†
- [ ] åˆ›å»ºæ”¯ä»˜æµç¨‹ä»ªè¡¨ç›˜
- [ ] åˆ›å»ºè®­ç»ƒè¥è¿è¥ä»ªè¡¨ç›˜
- [ ] é…ç½®ä¼ä¸šå¾®ä¿¡å‘Šè­¦

### Stage 4-6: ä¼˜åŒ–ç›‘æ§

- [ ] é›†æˆSentryé”™è¯¯è¿½è¸ª
- [ ] å‰ç«¯æ€§èƒ½ç›‘æ§ï¼ˆLighthouseï¼‰
- [ ] ç”¨æˆ·è¡Œä¸ºåˆ†æï¼ˆå¯é€‰ï¼‰
- [ ] ç›‘æ§æ•°æ®ç•™å­˜ç­–ç•¥

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¼€å‘å‰å‡†å¤‡æ¸…å• - ç›‘æ§å·¥å…·](./å¼€å‘å‰å‡†å¤‡æ¸…å•.md)
- [è®¾è®¡ä¼˜åŒ–å†³ç­–æ–‡æ¡£ - P2-1](./è®¾è®¡ä¼˜åŒ–å†³ç­–æ–‡æ¡£.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æœ€åæ›´æ–°**ï¼š2025-12-04
**ç»´æŠ¤è€…**ï¼šæŠ€æœ¯æ¶æ„ç»„ + è¿ç»´å›¢é˜Ÿ
