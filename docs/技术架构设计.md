# 知识星球训练营自动押金退款系统 - 技术架构设计文档

## 文档信息
- **文档版本**：v1.0
- **创建日期**：2025-10-24
- **更新日期**：2025-10-24

---

## 一、整体架构设计

### 1.1 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                          客户端层                                 │
│  ┌──────────────────┐           ┌──────────────────┐            │
│  │  H5会员端         │           │  Web管理后台      │            │
│  │  (Vue 3 + Vant)  │           │  (Vue 3 + EP)    │            │
│  └──────────────────┘           └──────────────────┘            │
└─────────────────────────────────────────────────────────────────┘
                              ↓ HTTPS
┌─────────────────────────────────────────────────────────────────┐
│                       Nginx反向代理层                             │
│  - SSL终止                                                       │
│  - 负载均衡                                                      │
│  - 静态资源服务                                                  │
│  - 限流防刷                                                      │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        应用服务层                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │           Spring Boot应用（Java 17+）                     │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │  │
│  │  │ API服务      │  │ 定时任务     │  │ Webhook服务 │     │  │
│  │  │ - RESTful   │  │ - 打卡同步   │  │ - 支付回调  │     │  │
│  │  │ - 鉴权      │  │ - 数据统计   │  │ - 签名验证  │     │  │
│  │  │ - 业务逻辑  │  │ - 自动提醒   │  │             │     │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        中间件层                                   │
│  ┌──────────────────┐           ┌──────────────────┐            │
│  │  Redis           │           │  RabbitMQ        │            │
│  │  - 缓存          │           │  - 异步任务      │            │
│  │  - 会话管理      │           │  - 消息队列      │            │
│  │  - 防刷限流      │           │  (推荐默认启用)  │            │
│  └──────────────────┘           └──────────────────┘            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        数据存储层                                 │
│  ┌──────────────────┐           ┌──────────────────┐            │
│  │  PostgreSQL      │           │  对象存储 (COS)   │            │
│  │  - 业务数据      │           │  - 图片文件      │            │
│  │  - 主从复制      │           │  - 海报          │            │
│  │  - 自动备份      │           │  - 二维码        │            │
│  └──────────────────┘           └──────────────────┘            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        外部服务层                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ 企业微信支付     │  │ 知识星球API      │  │ 企业微信通知     │ │
│  │ - 收款          │  │ - 打卡数据       │  │ - 应用消息       │ │
│  │ - 退款          │  │ - 用户信息       │  │ - 群机器人       │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈汇总

| 层级 | 技术选型 | 版本 |
|------|---------|------|
| **前端框架** | Vue 3 | 3.3+ |
| **H5 UI组件** | Vant | 4.x |
| **后台UI组件** | Element Plus | 2.4+ |
| **前端构建** | Vite | 5.x |
| **状态管理** | Pinia | 2.x |
| **HTTP客户端** | Axios | 1.x |
| **后端语言** | Java | 17+ |
| **后端框架** | Spring Boot | 3.2+ |
| **安全框架** | Spring Security | 6.x |
| **ORM框架** | MyBatis Plus | 3.5+ |
| **数据库** | PostgreSQL | 15+ |
| **缓存** | Redis | 7.x |
| **任务调度** | Spring Scheduler | - |
| **任务队列** | RabbitMQ（推荐默认启用） | 3.12+ |
| **HTTP客户端** | OkHttp3 | 4.x |
| **JSON处理** | Jackson | - |
| **日志框架** | Logback | - |
| **API文档** | Knife4j | 4.x |
| **限流与熔断** | Bucket4j / Resilience4j | - |
| **可观测性** | Spring Boot Actuator + Micrometer + Prometheus | - |
| **Web服务器** | Nginx | 1.24+ |
| **容器化** | Docker | (可选) |

---

## 二、后端架构设计

### 2.1 分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Controller层                            │
│  - 接口路由                                                   │
│  - 参数校验                                                   │
│  - 响应封装                                                   │
│  - 异常处理                                                   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      Service层                               │
│  - 业务逻辑                                                   │
│  - 事务管理                                                   │
│  - 数据组装                                                   │
│  - 外部调用                                                   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      Manager层（可选）                        │
│  - 复杂业务编排                                               │
│  - 跨Service调用                                              │
│  - 第三方API封装                                              │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      DAO层 (Mapper)                          │
│  - 数据库访问                                                 │
│  - SQL执行                                                    │
│  - 结果映射                                                   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 项目结构

```
src/main/java/com/example/camp/
├── CampApplication.java                    # 启动类
├── config/                                 # 配置类
│   ├── WebMvcConfig.java                   # Web配置
│   ├── SecurityConfig.java                 # 安全配置
│   ├── RedisConfig.java                    # Redis配置
│   ├── MyBatisPlusConfig.java              # MyBatis Plus配置
│   ├── SchedulerConfig.java                # 定时任务配置
│   └── Knife4jConfig.java                  # API文档配置
├── controller/                             # 控制器层
│   ├── admin/                              # 管理端接口
│   │   ├── CampController.java             # 训练营管理
│   │   ├── MemberController.java           # 会员管理
│   │   ├── CheckinController.java          # 打卡管理
│   │   ├── RefundController.java           # 退款审核
│   │   ├── StatisticsController.java       # 统计报表
│   │   ├── SystemController.java           # 系统管理
│   │   └── UserController.java             # 用户管理
│   ├── h5/                                 # H5端接口
│   │   ├── CampH5Controller.java           # 训练营列表
│   │   ├── PaymentH5Controller.java        # 支付接口
│   │   └── ProgressH5Controller.java       # 进度查询
│   └── webhook/                            # Webhook接口
│       ├── WechatPayWebhookController.java # 企业微信支付回调
│       └── PlanetWebhookController.java    # 知识星球回调(可选)
├── service/                                # 服务层
│   ├── CampService.java                    # 训练营服务
│   ├── MemberService.java                  # 会员服务
│   ├── PaymentService.java                 # 支付服务
│   ├── CheckinService.java                 # 打卡服务
│   ├── RefundService.java                  # 退款服务
│   ├── MatchService.java                   # 匹配服务
│   ├── NotificationService.java            # 通知服务
│   ├── StatisticsService.java              # 统计服务
│   └── impl/                               # 实现类
├── manager/                                # 管理层（可选）
│   ├── WechatPayManager.java               # 企业微信支付封装
│   ├── PlanetApiManager.java               # 知识星球API封装
│   └── WechatNotifyManager.java            # 企业微信通知封装
├── mapper/                                 # 数据访问层
│   ├── CampMapper.java
│   ├── MemberMapper.java
│   ├── PaymentMapper.java
│   ├── CheckinMapper.java
│   ├── RefundMapper.java
│   └── ...
├── entity/                                 # 实体类
│   ├── Camp.java                           # 训练营
│   ├── Member.java                         # 会员
│   ├── Payment.java                        # 支付记录
│   ├── Checkin.java                        # 打卡记录
│   ├── Refund.java                         # 退款记录
│   ├── User.java                           # 系统用户
│   ├── Role.java                           # 角色
│   └── OperationLog.java                   # 操作日志
├── dto/                                    # 数据传输对象
│   ├── request/                            # 请求DTO
│   │   ├── CreateCampRequest.java
│   │   ├── PaymentRequest.java
│   │   └── ...
│   └── response/                           # 响应DTO
│       ├── CampResponse.java
│       ├── MemberResponse.java
│       └── ...
├── vo/                                     # 视图对象
│   ├── CampVO.java
│   ├── MemberVO.java
│   └── ...
├── common/                                 # 公共类
│   ├── Result.java                         # 统一响应结果
│   ├── PageResult.java                     # 分页结果
│   ├── Constants.java                      # 常量
│   ├── ErrorCode.java                      # 错误码
│   └── exception/                          # 异常类
│       ├── BusinessException.java
│       ├── GlobalExceptionHandler.java
│       └── ...
├── enums/                                  # 枚举类
│   ├── CampStatus.java                     # 训练营状态
│   ├── PaymentStatus.java                  # 支付状态
│   ├── MatchStatus.java                    # 匹配状态
│   ├── RefundStatus.java                   # 退款状态
│   └── ...
├── schedule/                               # 定时任务
│   ├── CheckinSyncTask.java                # 打卡数据同步
│   ├── RefundTriggerTask.java              # 退款触发
│   └── NotificationTask.java               # 提醒通知
├── security/                               # 安全相关
│   ├── JwtTokenProvider.java               # JWT工具
│   ├── UserDetailsServiceImpl.java         # 用户认证
│   └── SecurityUtils.java                  # 安全工具类
├── interceptor/                            # 拦截器
│   ├── AuthInterceptor.java                # 认证拦截
│   ├── RateLimitInterceptor.java           # 限流拦截
│   └── LogInterceptor.java                 # 日志拦截
├── aspect/                                 # 切面
│   ├── OperationLogAspect.java             # 操作日志切面
│   └── ...
└── util/                                   # 工具类
    ├── HttpUtil.java                       # HTTP工具
    ├── RedisUtil.java                      # Redis工具
    ├── EncryptUtil.java                    # 加密工具
    ├── QRCodeUtil.java                     # 二维码工具
    └── DateUtil.java                       # 日期工具

src/main/resources/
├── application.yml                         # 主配置文件
├── application-dev.yml                     # 开发环境配置
├── application-prod.yml                    # 生产环境配置
├── mapper/                                 # MyBatis XML文件
│   ├── CampMapper.xml
│   └── ...
└── logback-spring.xml                      # 日志配置
```

### 2.3 核心服务设计

#### 2.3.1 CampService（训练营服务）
```java
public interface CampService {
    // 创建训练营
    Long createCamp(CreateCampRequest request);

    // 更新训练营
    void updateCamp(Long campId, UpdateCampRequest request);

    // 获取训练营详情
    CampVO getCampDetail(Long campId);

    // 获取训练营列表（分页）
    PageResult<CampVO> listCamps(CampQueryRequest request);

    // 生成H5报名链接
    String generateEnrollUrl(Long campId);

    // 获取有效的训练营列表（H5用）
    List<CampVO> listActiveCamps();
}
```

#### 2.3.2 PaymentService（支付服务）
```java
public interface PaymentService {
    // 创建支付订单
    PaymentVO createPayment(PaymentRequest request);

    // 获取支付参数
    PaymentParamsVO getPaymentParams(Long paymentId);

    // 处理支付回调
    void handlePaymentCallback(PaymentCallbackDTO callbackData);

    // 定时轮询支付记录
    void syncPaymentRecords();

    // 查询支付状态
    PaymentStatus queryPaymentStatus(String orderNo);
}
```

#### 2.3.3 CheckinService（打卡服务）
```java
public interface CheckinService {
    // 同步打卡数据（定时任务调用）
    void syncCheckinData(Long campId);

    // 获取会员打卡记录
    List<CheckinVO> getMemberCheckins(Long memberId, Long campId);

    // 获取训练营打卡统计
    CheckinStatisticsVO getCampCheckinStats(Long campId);

    // 计算会员是否满足退款条件
    boolean checkRefundEligibility(Long memberId, Long campId);
}
```

#### 2.3.4 MatchService（匹配服务）
```java
public interface MatchService {
    // 自动匹配会员身份
    MatchResult autoMatch(Long paymentId);

    // 批量匹配
    void batchMatch(Long campId);

    // 手动匹配
    void manualMatch(Long paymentId, String planetUserId);

    // 计算匹配置信度
    int calculateConfidence(PaymentRecord payment, PlanetUser planetUser);
}
```

#### 2.3.5 RefundService（退款服务）
```java
public interface RefundService {
    // 生成退款审核列表
    void generateRefundList(Long campId);

    // 审核通过
    void approveRefund(Long refundId, Long operatorId);

    // 批量审核
    void batchApprove(List<Long> refundIds, Long operatorId);

    // 执行退款
    void executeRefund(Long refundId);

    // 重试失败的退款
    void retryFailedRefund(Long refundId);
}
```

#### 2.3.6 NotificationService（通知服务）
```java
public interface NotificationService {
    // 发送企业微信应用消息
    void sendAppMessage(String userId, String content);

    // 发送群机器人消息
    void sendGroupMessage(String webhookUrl, String content);

    // 退款成功通知
    void notifyRefundSuccess(Long refundId);

    // 异常通知管理员
    void notifyAdminError(String errorMsg);
}
```

### 2.4 幂等与一致性策略
- 事件驱动处理链：Webhook 验签 → 记录原始事件 `event_id`（唯一索引）→ 入队 → Worker 幂等更新 → 业务后置（如展示二维码）。
- 支付幂等：
  - 唯一约束：`unique (camp_id, planet_user_id)`；订单号 `order_no` 唯一索引。
  - 状态机：`CREATED -> PAID -> REFUNDING -> REFUNDED / REFUND_FAILED`，仅允许合法跃迁。
  - 重复回调：以 `order_no` 为幂等键忽略重复，记录审计日志。
- 打卡幂等：
  - 唯一约束：`unique (camp_id, planet_user_id, checkin_date)`；拉取时使用 UPSERT。
  - 失败重试：最多 3 次，超限标记失败并告警。
- 退款幂等：
  - 唯一约束：`refund_no` 唯一索引；执行前检查 `status in (APPROVED)`。
  - 重试策略：失败重试 1 次；二次仍失败转人工处理。
- 事务与一致性：
  - 关键写操作使用数据库事务；消息入队与 DB 写采用“先写 DB 再入队”的模式，避免丢消息。
  - 对于“至少一次投递”，通过幂等键与事件去重保证“效果上恰好一次”。

### 2.5 限流与防刷设计
- Nginx 层限流：为 `/api/webhook/*`、`/api/payment/*`、`/api/auth/*` 配置 `limit_req` 与连接数限制，阻断明显的刷请求。
- 应用层限流（Redis 滑动窗口）：
  - 全局：每 IP 每分钟 ≤ 100 次；敏感接口单独配额。
  - 登录接口：每 IP 每分钟 ≤ 10 次，失败达到阈值触发临时封禁或验证码。
  - 支付创建与 WebHook：按 `IP` 与 `order_no` 维度限流与去重；WebHook 通道放宽连接但做好幂等。
  - 管理端批量审核：加入令牌桶控制并发与速率，避免 DB 写入尖峰。
- 稳健性保护：
  - 熔断/隔离：对第三方（企业微信、知识星球）调用使用 `Resilience4j` 的 `retry + circuitBreaker + rateLimiter` 组合。
  - 防机器人：校验 `User-Agent` 与 `Referer`，对异常流量返回 `429`；重要操作加 CSRF 与 nonce。

### 2.6 配置与密钥管理
- 敏感配置项：
  - 企业微信支付：`mch_id`、`api_key`、证书（`apiclient_cert`/`key`）。
  - 知识星球：`cookie`（加密存储），项目 ID。
  - 通知：企业微信应用 `corp_id`、`app_secret`、回调 URL。
- 存储与加密：
  - 使用 `AES-GCM` 在服务端加密后入库，密钥来源于环境变量或云 KMS；
  - 仅在进程内解密到内存；日志与错误信息不打印明文。
- 访问与审计：
  - 管理端“系统配置”仅对超级管理员开放；每次读取/修改记录操作日志（操作者、时间、IP、字段差异）。
  - 支持密钥轮换：新增密钥 → 双写生效 → 旧密钥下线。
- 配置加载：
  - `application-prod.yml` 通过环境变量注入敏感字段；不在代码库保存明文。
  - 提供“API 接口测试”按钮触发最小权限的连通性校验，失败告警到企业微信。

### 2.7 数据库约束与索引（补充）
- `payment` 表：
  - 索引：`unique(camp_id, planet_user_id)`、`unique(order_no)`；`status` 普通索引用于查询。
- `checkin` 表：
  - 索引：`unique(camp_id, planet_user_id, checkin_date)`；`planet_user_id` + `camp_id` 组合索引。
- `refund` 表：
  - 索引：`unique(refund_no)`；`status` 与 `camp_id` 查询索引。
- `operation_log` 表：
  - 索引：`operator_id`、`created_at`；确保审计查询高效。

---

## 三、前端架构设计

### 3.1 H5会员端架构

#### 3.1.1 项目结构
```
h5-member/
├── src/
│   ├── api/                        # API接口
│   │   ├── camp.js                 # 训练营接口
│   │   ├── payment.js              # 支付接口
│   │   └── progress.js             # 进度查询接口
│   ├── assets/                     # 静态资源
│   │   ├── images/
│   │   └── styles/
│   ├── components/                 # 公共组件
│   │   ├── CampCard.vue            # 训练营卡片
│   │   ├── ProgressBar.vue         # 进度条
│   │   └── ...
│   ├── views/                      # 页面
│   │   ├── CampList.vue            # 训练营列表
│   │   ├── EnrollForm.vue          # 报名表单
│   │   ├── QRCode.vue              # 群二维码
│   │   └── Progress.vue            # 打卡进度
│   ├── router/                     # 路由
│   │   └── index.js
│   ├── store/                      # 状态管理
│   │   ├── modules/
│   │   │   ├── camp.js
│   │   │   └── user.js
│   │   └── index.js
│   ├── utils/                      # 工具函数
│   │   ├── request.js              # 封装axios
│   │   ├── wechat.js               # 微信SDK
│   │   └── ...
│   ├── App.vue
│   └── main.js
├── package.json
└── vite.config.js
```

#### 3.1.2 路由设计
```javascript
const routes = [
  {
    path: '/',
    name: 'CampList',
    component: () => import('@/views/CampList.vue'),
    meta: { title: '训练营列表' }
  },
  {
    path: '/enroll/:campId',
    name: 'EnrollForm',
    component: () => import('@/views/EnrollForm.vue'),
    meta: { title: '报名支付' }
  },
  {
    path: '/qrcode/:paymentId',
    name: 'QRCode',
    component: () => import('@/views/QRCode.vue'),
    meta: { title: '加入群聊' }
  },
  {
    path: '/progress/:memberId',
    name: 'Progress',
    component: () => import('@/views/Progress.vue'),
    meta: { title: '打卡进度' }
  }
]
```

### 3.2 Web管理后台架构

#### 3.2.1 项目结构
```
admin-web/
├── src/
│   ├── api/                        # API接口
│   │   ├── camp.js
│   │   ├── member.js
│   │   ├── checkin.js
│   │   ├── refund.js
│   │   ├── statistics.js
│   │   ├── system.js
│   │   └── user.js
│   ├── assets/                     # 静态资源
│   ├── components/                 # 公共组件
│   │   ├── Layout/                 # 布局组件
│   │   ├── Table/                  # 表格组件
│   │   └── ...
│   ├── views/                      # 页面
│   │   ├── login/                  # 登录
│   │   ├── camp/                   # 训练营管理
│   │   │   ├── List.vue
│   │   │   ├── Create.vue
│   │   │   └── Detail.vue
│   │   ├── member/                 # 会员管理
│   │   ├── checkin/                # 打卡管理
│   │   ├── refund/                 # 退款审核
│   │   ├── statistics/             # 统计报表
│   │   └── system/                 # 系统管理
│   ├── router/                     # 路由
│   │   ├── index.js
│   │   └── modules/
│   ├── store/                      # 状态管理
│   │   ├── modules/
│   │   │   ├── user.js
│   │   │   ├── permission.js
│   │   │   └── ...
│   │   └── index.js
│   ├── utils/                      # 工具函数
│   │   ├── request.js
│   │   ├── permission.js
│   │   ├── validate.js
│   │   └── ...
│   ├── directives/                 # 自定义指令
│   │   └── permission.js           # 权限指令
│   ├── App.vue
│   └── main.js
├── package.json
└── vite.config.js
```

#### 3.2.2 路由设计
```javascript
const routes = [
  {
    path: '/login',
    component: () => import('@/views/login/index.vue'),
    hidden: true
  },
  {
    path: '/',
    component: Layout,
    redirect: '/dashboard',
    children: [
      {
        path: 'dashboard',
        name: 'Dashboard',
        component: () => import('@/views/dashboard/index.vue'),
        meta: { title: '首页', icon: 'dashboard' }
      }
    ]
  },
  {
    path: '/camp',
    component: Layout,
    meta: { title: '训练营管理', icon: 'camp' },
    children: [
      {
        path: 'list',
        name: 'CampList',
        component: () => import('@/views/camp/List.vue'),
        meta: { title: '训练营列表', permission: ['admin', 'manager'] }
      },
      {
        path: 'create',
        name: 'CampCreate',
        component: () => import('@/views/camp/Create.vue'),
        meta: { title: '创建训练营', permission: ['admin', 'manager'] }
      },
      {
        path: 'detail/:id',
        name: 'CampDetail',
        component: () => import('@/views/camp/Detail.vue'),
        hidden: true,
        meta: { title: '训练营详情', permission: ['admin', 'manager', 'coach'] }
      }
    ]
  },
  {
    path: '/member',
    component: Layout,
    meta: { title: '会员管理', icon: 'member' },
    children: [
      {
        path: 'list',
        name: 'MemberList',
        component: () => import('@/views/member/List.vue'),
        meta: { title: '会员列表', permission: ['admin', 'manager', 'coach'] }
      }
    ]
  },
  {
    path: '/refund',
    component: Layout,
    meta: { title: '退款审核', icon: 'refund' },
    children: [
      {
        path: 'pending',
        name: 'RefundPending',
        component: () => import('@/views/refund/Pending.vue'),
        meta: { title: '待审核列表', permission: ['admin', 'manager', 'coach'] }
      },
      {
        path: 'records',
        name: 'RefundRecords',
        component: () => import('@/views/refund/Records.vue'),
        meta: { title: '退款记录', permission: ['admin', 'manager'] }
      }
    ]
  },
  {
    path: '/statistics',
    component: Layout,
    meta: { title: '统计报表', icon: 'statistics' },
    children: [
      {
        path: 'camp',
        name: 'StatisticsCamp',
        component: () => import('@/views/statistics/Camp.vue'),
        meta: { title: '训练营报表', permission: ['admin', 'manager'] }
      }
    ]
  },
  {
    path: '/system',
    component: Layout,
    meta: { title: '系统管理', icon: 'system', permission: ['admin'] },
    children: [
      {
        path: 'user',
        name: 'SystemUser',
        component: () => import('@/views/system/User.vue'),
        meta: { title: '用户管理' }
      },
      {
        path: 'config',
        name: 'SystemConfig',
        component: () => import('@/views/system/Config.vue'),
        meta: { title: '系统配置' }
      },
      {
        path: 'log',
        name: 'SystemLog',
        component: () => import('@/views/system/Log.vue'),
        meta: { title: '操作日志' }
      }
    ]
  }
]
```

---

## 四、数据库设计

### 4.1 数据库选型：PostgreSQL

**选择理由**：
- 完善的JSON支持（存储打卡数据、配置等）
- 强大的全文搜索
- 更好的并发性能
- 丰富的数据类型
- 完善的事务支持

### 4.2 核心表设计

详见《数据库设计文档》（单独文档）

---

## 五、接口设计

### 5.1 RESTful API设计规范

#### 5.1.1 URL规范
```
# 管理端
/api/admin/camps                    # 训练营资源
/api/admin/members                  # 会员资源
/api/admin/refunds                  # 退款资源

# H5端
/api/h5/camps                       # H5训练营
/api/h5/payments                    # H5支付
/api/h5/progress                    # H5进度

# Webhook
/api/webhook/wechat/payment         # 企业微信支付回调
```

#### 5.1.2 HTTP方法
- **GET**：查询资源
- **POST**：创建资源
- **PUT**：更新资源（完整更新）
- **PATCH**：更新资源（部分更新）
- **DELETE**：删除资源

#### 5.1.3 统一响应格式
```json
{
  "code": 200,              // 业务状态码
  "message": "成功",         // 提示信息
  "data": {},               // 响应数据
  "timestamp": 1234567890   // 时间戳
}
```

**状态码定义**：
- `200`：成功
- `400`：请求参数错误
- `401`：未认证
- `403`：无权限
- `404`：资源不存在
- `500`：服务器错误
- `1001-1999`：业务错误码（自定义）

### 5.2 核心接口列表

#### 5.2.1 训练营管理接口
```
# 创建训练营
POST /api/admin/camps
Request Body:
{
  "name": "21天早起训练营",
  "posterUrl": "https://...",
  "deposit": 99,
  "startDate": "2025-01-01",
  "endDate": "2025-01-21",
  "totalDays": 21,
  "requiredDays": 15,
  "groupQrCodeUrl": "https://...",
  "description": "...",
  "coachIds": [1, 2],
  "volunteerIds": [3, 4],
  "planetProjectId": "12345",
  "wechatPayCodeId": "67890"
}

# 获取训练营列表
GET /api/admin/camps?status=ongoing&page=1&size=20

# 获取训练营详情
GET /api/admin/camps/{campId}

# 生成H5报名链接
GET /api/admin/camps/{campId}/enroll-url
```

#### 5.2.2 会员管理接口
```
# 获取会员列表
GET /api/admin/members?campId=1&matchStatus=matched&page=1&size=20

# 获取会员详情
GET /api/admin/members/{memberId}

# 手动匹配会员
POST /api/admin/members/{memberId}/match
Request Body:
{
  "planetUserId": "12345"
}

# 标记进群状态
POST /api/admin/members/{memberId}/mark-joined
```

#### 5.2.3 退款审核接口
```
# 获取待审核列表
GET /api/admin/refunds/pending?campId=1&page=1&size=20

# 审核通过
POST /api/admin/refunds/{refundId}/approve

# 批量审核
POST /api/admin/refunds/batch-approve
Request Body:
{
  "refundIds": [1, 2, 3]
}

# 获取退款记录
GET /api/admin/refunds/records?status=success&page=1&size=20

# 重试失败退款
POST /api/admin/refunds/{refundId}/retry
```

#### 5.2.4 H5端接口
```
# 获取训练营列表
GET /api/h5/camps

# 获取训练营详情
GET /api/h5/camps/{campId}

# 创建支付订单
POST /api/h5/payments
Request Body:
{
  "campId": 1,
  "planetNickname": "张三",
  "planetUserId": "12345",
  "wechatNickname": "微信昵称"
}

# 获取支付参数
GET /api/h5/payments/{paymentId}/params

# 获取群二维码
GET /api/h5/payments/{paymentId}/qrcode

# 查询打卡进度
GET /api/h5/progress/{memberId}?campId=1
```

#### 5.2.5 Webhook接口
```
# 企业微信支付回调
POST /api/webhook/wechat/payment
Request Body: (企业微信定义的格式)
```

### 5.3 接口认证

#### 5.3.1 管理后台认证
- 使用JWT Token
- 登录后返回Token
- 每次请求携带Token：`Authorization: Bearer {token}`

#### 5.3.2 H5端认证
- 支付前无需认证（游客模式）
- 查询进度时需要验证身份（通过memberId + campId）
- 防刷：限制同一IP请求频率

#### 5.3.3 Webhook认证
- 企业微信：验证签名
- 知识星球：IP白名单（如适用）

---

## 六、安全设计

### 6.1 身份认证
- 管理后台：JWT Token认证
- 密码加密：BCrypt
- Token有效期：24小时
- Refresh Token机制（可选）

### 6.2 权限控制
- 基于角色的访问控制（RBAC）
- 接口级权限校验
- 数据级权限校验（如：教练只能看自己负责的训练营）

### 6.3 数据安全
- HTTPS通信
- 敏感数据加密存储（如：企业微信密钥、知识星球Cookie）
- SQL注入防护（MyBatis Plus参数化查询）
- XSS防护（前端输入过滤）
- CSRF防护（Token验证）

### 6.4 接口防刷
```java
@RateLimiter(key = "#request.ip", limit = 100, period = 60)
public Result<?> someApi(HttpServletRequest request) {
    // 同一IP每分钟最多100次请求
}
```

实现方式：
- Redis + Lua脚本
- 滑动窗口算法

### 6.5 操作审计
- 记录所有敏感操作：
  - 创建/修改/删除训练营
  - 手动匹配会员
  - 审核退款
  - 修改系统配置
- 日志字段：
  - 操作人
  - 操作时间
  - 操作类型
  - 操作对象
  - 操作详情
  - IP地址

---

## 七、定时任务设计

### 7.1 打卡数据同步任务
```java
@Scheduled(cron = "0 0 1 * * ?")  // 每天01:00执行
public void syncCheckinData() {
    // 1. 获取所有进行中的训练营
    // 2. 逐个调用知识星球API获取打卡数据
    // 3. 更新数据库
    // 4. 计算会员打卡进度
    // 5. 失败通知管理员
}
```

### 7.2 退款触发任务
```java
@Scheduled(cron = "0 0 2 * * ?")  // 每天02:00执行
public void triggerRefund() {
    // 1. 查询昨天结束的训练营
    // 2. 获取完整打卡数据
    // 3. 生成退款审核列表
    // 4. 通知管理员审核
}
```

### 7.3 提醒通知任务
```java
@Scheduled(cron = "0 0 10 * * ?")  // 每天10:00执行
public void sendReminders() {
    // 1. 未进群提醒（支付后24小时未进群）
    // 2. 项目即将结束提醒（提前1天）
}
```

### 7.4 支付轮询任务
```java
@Scheduled(cron = "0 0 * * * ?")  // 每小时执行
public void syncPaymentRecords() {
    // 1. 调用企业微信接口获取支付记录
    // 2. 对比数据库，补录缺失数据
}
```

---

## 八、部署架构

### 8.1 服务器配置建议

#### 8.1.1 生产环境（单机版）
```
服务器配置：
- CPU：4核
- 内存：8GB
- 硬盘：100GB SSD
- 带宽：5Mbps

服务部署：
- Nginx：80/443端口
- Spring Boot：8080端口
- PostgreSQL：5432端口
- Redis：6379端口
```

#### 8.1.2 目录结构
```
/data/
├── app/                          # 应用目录
│   ├── camp-api.jar              # 后端JAR包
│   ├── h5/                       # H5前端静态文件
│   └── admin/                    # 管理后台静态文件
├── logs/                         # 日志目录
│   ├── api/
│   ├── nginx/
│   └── postgresql/
├── uploads/                      # 上传文件目录
│   ├── posters/
│   └── qrcodes/
├── backups/                      # 备份目录
│   └── db/
└── config/                       # 配置文件目录
    ├── application.yml
    └── nginx.conf
```

### 8.2 Nginx配置示例

```nginx
# /etc/nginx/conf.d/camp.conf

# HTTP重定向到HTTPS
server {
    listen 80;
    server_name camp.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS配置
server {
    listen 443 ssl http2;
    server_name camp.yourdomain.com;

    # SSL证书
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    # SSL安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # 日志
    access_log /data/logs/nginx/access.log;
    error_log /data/logs/nginx/error.log;

    # 限流配置
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=webhook_limit:10m rate=30r/m;

    # H5前端
    location /h5 {
        alias /data/app/h5;
        try_files $uri $uri/ /index.html;
    }

    # 管理后台
    location /admin {
        alias /data/app/admin;
        try_files $uri $uri/ /index.html;
    }

    # Webhook单独限流
    location /api/webhook {
        limit_req zone=webhook_limit burst=10 nodelay;
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # API代理（通用）
    location /api {
        limit_req zone=api_limit burst=20 nodelay;

        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 上传文件访问
    location /uploads {
        alias /data/uploads;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

### 8.3 SystemD服务配置

```ini
# /etc/systemd/system/camp-api.service

[Unit]
Description=Camp API Service
After=network.target

[Service]
Type=simple
User=camp
WorkingDirectory=/data/app
ExecStart=/usr/bin/java -jar \
    -Xms2g -Xmx4g \
    -XX:+UseG1GC \
    -Dspring.profiles.active=prod \
    camp-api.jar
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动命令：
```bash
sudo systemctl daemon-reload
sudo systemctl enable camp-api
sudo systemctl start camp-api
sudo systemctl status camp-api
```

### 8.4 数据库备份脚本

```bash
#!/bin/bash
# /data/scripts/backup-db.sh

BACKUP_DIR="/data/backups/db"
DATE=$(date +%Y%m%d_%H%M%S)
FILENAME="camp_backup_${DATE}.sql.gz"

# 创建备份
pg_dump -U camp_user -h localhost camp_db | gzip > "${BACKUP_DIR}/${FILENAME}"

# 只保留最近7天的备份
find ${BACKUP_DIR} -name "camp_backup_*.sql.gz" -mtime +7 -delete

echo "Backup completed: ${FILENAME}"
```

添加到crontab：
```bash
# 每天凌晨3点自动备份
0 3 * * * /data/scripts/backup-db.sh >> /data/logs/backup.log 2>&1
```

---

## 九、监控和日志

### 9.1 应用日志

#### 9.1.1 日志级别
- **ERROR**：系统错误、异常
- **WARN**：警告信息
- **INFO**：关键业务流程
- **DEBUG**：调试信息（仅开发环境）

#### 9.1.2 日志格式
```
[时间] [级别] [线程] [类名] - 日志内容
[2025-10-24 10:30:00.123] [INFO] [http-nio-8080-exec-1] [c.e.c.service.PaymentService] - 创建支付订单成功，订单号: 123456
```

#### 9.1.3 日志分类
- **api.log**：API请求日志
- **service.log**：业务逻辑日志
- **error.log**：错误日志
- **scheduled.log**：定时任务日志

### 9.2 关键业务日志

必须记录的业务日志：
1. 支付成功/失败
2. 打卡数据同步成功/失败
3. 会员匹配结果
4. 退款审核操作
5. 退款执行结果
6. 外部API调用失败

### 9.3 监控指标（可选）

如果后期需要更完善的监控，可以集成：
- **Spring Boot Actuator**：健康检查、指标收集
- **Prometheus + Grafana**：可视化监控
- **ELK Stack**：日志分析

---

## 十、开发规范

### 10.1 代码规范
- 遵循阿里巴巴Java开发手册
- 使用Lombok简化代码
- 统一异常处理
- RESTful API规范

### 10.2 Git规范

#### 10.2.1 分支策略
```
main        # 主分支（生产环境）
├── develop # 开发分支
    ├── feature/xxx  # 功能分支
    └── bugfix/xxx   # 修复分支
```

#### 10.2.2 提交信息格式
```
feat: 新增功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 重构
test: 测试相关
chore: 构建/工具链相关

示例：
feat: 新增训练营创建接口
fix: 修复支付回调签名验证错误
```

### 10.3 数据库规范
- 表名：小写 + 下划线分隔
- 字段名：小写 + 下划线分隔
- 主键：统一使用`id`
- 时间字段：`created_at`、`updated_at`
- 软删除：`deleted_at`
- 必备字段：`id`、`created_at`、`updated_at`

---

## 十一、性能优化

### 11.1 数据库优化
- 合理创建索引（详见数据库设计文档）
- 避免N+1查询
- 分页查询
- 连接池配置：HikariCP

### 11.2 缓存策略
- Redis缓存热点数据：
  - 训练营列表（H5）
  - 系统配置
  - 用户权限
- 缓存过期时间：根据业务设定
- 缓存更新策略：主动更新 + 定时刷新

### 11.3 接口优化
- 分页加载
- 字段裁剪（只返回必要字段）
- 异步处理耗时操作（如：发送通知）
- 接口响应压缩（Gzip）

---

## 十二、技术选型说明

### 12.1 为什么选Java + Spring Boot？
1. **生态成熟**：丰富的类库和工具
2. **企业级**：适合长期维护
3. **并发性能好**：适合处理支付、退款等高并发场景
4. **社区活跃**：问题容易解决

### 12.2 为什么选PostgreSQL？
1. **功能强大**：JSON支持、全文搜索
2. **开源免费**：无授权费用
3. **性能优秀**：适合复杂查询
4. **数据一致性强**：ACID特性完善

### 12.3 为什么选Vue 3？
1. **学习成本低**：对初学者友好
2. **生态完善**：丰富的UI组件库
3. **性能优秀**：Composition API
4. **社区活跃**：中文资料丰富

---

## 十三、开发环境搭建

### 13.1 本地开发环境

#### 13.1.1 后端环境
```bash
# 安装Java 17+
java -version

# 安装Maven
mvn -version

# 安装PostgreSQL
brew install postgresql@15  # macOS
# 或使用Docker
docker run -d --name postgres \
  -e POSTGRES_PASSWORD=password \
  -p 5432:5432 \
  postgres:15

# 安装Redis
brew install redis  # macOS
# 或使用Docker
docker run -d --name redis -p 6379:6379 redis:7
```

#### 13.1.2 前端环境
```bash
# 安装Node.js 18+
node -v
npm -v

# 或使用nvm管理Node版本
nvm install 18
nvm use 18
```

### 13.2 项目启动

#### 13.2.1 后端启动
```bash
# 克隆项目
git clone xxx

# 进入项目目录
cd camp-api

# 修改配置文件
vim src/main/resources/application-dev.yml

# 创建数据库
createdb camp_db

# 启动项目
mvn spring-boot:run
```

#### 13.2.2 前端启动
```bash
# H5端
cd h5-member
npm install
npm run dev

# 管理后台
cd admin-web
npm install
npm run dev
```

---

**文档结束**

下一步：请参考《数据库设计文档》了解详细的表结构设计。
