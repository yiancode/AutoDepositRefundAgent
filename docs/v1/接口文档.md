# 知识星球训练营自动押金退款系统 - 接口文档

| **版本** | v1.0 |
| -------- | ---- |
| **作者** | 系统架构师 |
| **日期** | 2025-12-01 |
| **状态** | 评审中 |

---

## 目录

1. [概述](#一概述)
2. [接口总览](#二接口总览)
3. [H5会员端接口](#三h5会员端接口)
4. [训练营管理接口](#四训练营管理接口)
5. [会员管理接口](#五会员管理接口)
6. [打卡管理接口](#六打卡管理接口)
7. [退款管理接口](#七退款管理接口)
8. [统计报表接口](#八统计报表接口)
9. [系统管理接口](#九系统管理接口)
10. [认证管理接口](#十认证管理接口)
11. [Webhook接口](#十一webhook接口)
12. [流程图](#十二流程图)
13. [使用场景](#十三使用场景)
14. [错误码说明](#十四错误码说明)

---

# 一、概述

## 1.1 文档说明

本文档定义了知识星球训练营自动押金退款系统的所有 RESTful API 接口，供前后端开发人员参考。

## 1.2 接口规范

### 基础URL

| 环境 | URL |
|------|-----|
| 开发环境 | `http://localhost:8080/api` |
| 测试环境 | `https://test-api.example.com/api` |
| 生产环境 | `https://api.example.com/api` |

### 请求格式

- **Content-Type**: `application/json`
- **字符编码**: UTF-8
- **时间格式**: ISO 8601（`yyyy-MM-dd'T'HH:mm:ss`）

### 统一响应格式

```json
{
  "code": 200,
  "message": "成功",
  "data": {},
  "timestamp": 1730000000
}
```

### 分页响应格式

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "list": [],
    "total": 100,
    "page": 1,
    "pageSize": 20,
    "totalPages": 5
  },
  "timestamp": 1730000000
}
```

## 1.3 认证方式

| 接口类型 | 认证方式 | Header |
|----------|----------|--------|
| 管理后台 | JWT Token | `Authorization: Bearer {token}` |
| H5会员端 | 访问票据（部分接口） | `X-Access-Token: {accessToken}` |
| Webhook | 签名验证 | 验证微信签名 |

### JWT Token 格式

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsInVzZXJuYW1lIjoiYWRtaW4iLCJyb2xlIjoiYWRtaW4iLCJleHAiOjE3MzAwMDAwMDB9.xxxxx
```

### H5 访问票据机制（Access Token）

> ⚠️ **安全设计**：为防止订单号枚举和抢绑定攻击，敏感 H5 接口需要验证访问票据。

**票据生成时机**：
- 支付成功后，系统在支付回调中生成 `accessToken`
- 票据与 `orderNo` 绑定，仅能访问对应订单的资源

**票据交付方式**：
- 前端在支付发起后轮询 `GET /payments/{orderNo}/status`（无需票据）
- 支付成功时，该接口响应中包含 `accessToken` 字段
- 前端拿到 `accessToken` 后，用于后续敏感接口的访问

**票据规格**：
| 属性 | 值 |
|------|-----|
| 格式 | UUID v4（128位随机），前缀 `tk_` |
| 签名 | 无签名（UUID 本身不可预测，存储在 Redis 验证） |
| 有效期 | **训练营结束后 7 天**（动态计算，覆盖整个训练营周期） |
| 绑定关系 | 1 票据 : 1 订单 |
| 存储位置 | Redis（`access_token:{token}` → JSON 对象） |

> **有效期说明**：典型训练营持续 21-30 天，固定 7 天有效期无法满足"整个周期可查进度"的需求。因此有效期设计为训练营结束后 7 天，确保会员在整个训练营期间及结算期都能正常使用。

**Redis 存储结构**：
```json
// Key: access_token:tk_550e8400-e29b-41d4-a716-446655440000
// TTL: 训练营结束时间 + 7天 - 当前时间
{
  "orderNo": "ord_a1b2c3d4-5678-...",
  "campId": 101,
  "status": "active",  // active | bound | expired
  "campEndDate": "2025-01-31",
  "openid": "wx_oABC123...",  // 用于绑定验证
  "createdAt": "2025-01-10T15:30:00",
  "boundAt": null  // 绑定时间（绑定后填充）
}
```

**验证流程**：
1. 从请求 Header 提取 `X-Access-Token`
2. Redis 查询 `access_token:{token}`，不存在则返回 401
3. 检查 `status` 是否为 `active` 或 `bound`，否则返回 403
4. 验证 Redis 的 TTL，若已过期则返回 401
5. 校验通过，允许访问资源

**刷新策略**（自动延期）：
- 训练营时间延长时，系统自动更新所有相关 token 的 TTL
- 实现方式：定时任务扫描 `camp_id` 索引，批量更新 Redis TTL
- 无需用户主动刷新，保证训练营期间始终可用

**票据状态机**：
```
[active] ---(绑定成功)---> [bound]
   |                         |
   +---(训练营结束+7天)---> [expired]
```
- `active`：票据有效，可用于绑定和查询
- `bound`：已完成绑定，仍可用于查询（qrcode、progress）
- `expired`：票据过期，所有接口不可用

**安全措施**：
1. **订单号不可枚举**：`orderNo` 使用 UUID 格式（如 `ord_a1b2c3d4-5678-...`）
2. **票据绑定校验**：`bind` 接口需验证票据对应的 `openid/corpUserId` 与支付时一致
3. **接口限流**：敏感接口每 IP 每分钟 ≤ 10 次
4. **绑定操作幂等**：同一票据多次调用 `bind` 接口返回相同结果，不重复绑定

---

# 二、接口总览

## 2.1 接口清单

| 模块 | 接口数量 | 说明 |
|------|----------|------|
| H5会员端 | 10 | 报名、支付、进度查询、会员验证 |
| 训练营管理 | 6 | 训练营CRUD |
| 会员管理 | 9 | 会员查询、匹配、同步 |
| 打卡管理 | 4 | 打卡同步、统计 |
| 退款管理 | 6 | 退款审核、执行 |
| 统计报表 | 3 | 数据统计、导出 |
| 系统管理 | 5 | 用户、配置、日志 |
| 认证管理 | 3 | OAuth登录、星球绑定 |
| Webhook | 2 | 支付回调 |
| **合计** | **48** | |

## 2.2 接口列表

### H5会员端接口（/api/h5）

| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| GET | /camps | 训练营列表 | 否 |
| GET | /camps/{id} | 训练营详情 | 否 |
| POST | /payments | 创建支付订单 | 否 |
| GET | /payments/{orderNo}/params | 获取支付参数 | 否 |
| GET | /payments/{orderNo}/status | 查询支付状态 | 否* |
| POST | /payments/bind | 用户绑定星球信息 | **票据** |
| GET | /payments/{orderNo}/qrcode | 获取群二维码 | **票据** |
| GET | /progress/{memberId} | 查询打卡进度 | **票据** |
| POST | /members/verify | 验证会员身份 | 否 |
| GET | /members/search | 搜索会员 | 否 |

> **说明**：
> - 标注"票据"的接口需要在 Header 中传递 `X-Access-Token`
> - *`/payments/{orderNo}/status` 无需票据，支付成功时响应中包含 `accessToken`，作为后续接口的票据来源
> - 为防止订单号枚举，`orderNo` 使用不可预测的 UUID 格式

### 管理后台接口（/api/admin）

| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| POST | /camps | 创建训练营 | JWT |
| GET | /camps | 训练营列表 | JWT |
| GET | /camps/{id} | 训练营详情 | JWT |
| PUT | /camps/{id} | 更新训练营 | JWT |
| DELETE | /camps/{id} | 删除训练营 | JWT |
| POST | /camps/{id}/publish | 发布训练营 | JWT |
| GET | /members | 会员列表 | JWT |
| GET | /members/{id} | 会员详情 | JWT |
| POST | /members/{id}/match | 手动匹配 | JWT |
| PUT | /members/{id}/join-group | 标记进群 | JWT |
| GET | /members/export | 导出会员 | JWT |
| POST | /members/sync | 同步知识星球会员 | JWT |
| GET | /members/sync/status | 查询同步状态 | JWT |
| GET | /members/sync/history | 查询同步历史 | JWT |
| POST | /members/batch-verify | 批量验证会员 | JWT |
| POST | /checkins/sync | 同步打卡数据 | JWT |
| GET | /checkins/stats/{campId} | 打卡统计 | JWT |
| GET | /checkins/records | 打卡记录 | JWT |
| POST | /checkins/sync/{campId} | 手动同步 | JWT |
| GET | /refunds/pending | 待审核列表 | JWT |
| POST | /refunds/{id}/approve | 审核通过 | JWT |
| POST | /refunds/{id}/reject | 审核拒绝 | JWT |
| POST | /refunds/batch-approve | 批量审核 | JWT |
| POST | /refunds/{id}/retry | 重试退款 | JWT |
| GET | /refunds/records | 退款记录 | JWT |
| GET | /stats/overview | 数据概览 | JWT |
| GET | /stats/camps/{id} | 训练营统计 | JWT |
| GET | /stats/export | 导出报表 | JWT |
| POST | /auth/login | 登录 | 否 |
| POST | /auth/logout | 登出 | JWT |
| GET | /users | 用户列表 | JWT |
| POST | /users | 创建用户 | JWT |
| PUT | /config | 更新配置 | JWT |

### 认证管理接口（/api/auth）

| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| GET | /authorize | 获取微信公众号授权地址 | 否 |
| GET | /callback/wechat-mp | 微信OAuth回调处理 | 否 |
| POST | /bindPlanet | 绑定知识星球账号 | JWT |

### Webhook接口（/api/webhook）

| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /wechat/payment | 支付结果通知 |
| POST | /wechat/refund | 退款结果通知 |

---

# 三、H5会员端接口

## 3.1 获取训练营列表

获取当前可报名的训练营列表。

**请求**

```
GET /api/h5/camps
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | string | 否 | 状态筛选：enrolling（报名中） |
| page | int | 否 | 页码，默认1 |
| pageSize | int | 否 | 每页条数，默认10 |

**请求示例**

```bash
GET /api/h5/camps?status=enrolling&page=1&pageSize=10
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "list": [
      {
        "id": 1,
        "name": "21天早起打卡训练营",
        "posterUrl": "https://cdn.example.com/posters/camp1.jpg",
        "description": "每天早上6点前打卡，坚持21天养成早起习惯",
        "deposit": 99.00,
        "startDate": "2025-12-10",
        "endDate": "2025-12-31",
        "totalDays": 21,
        "requiredDays": 15,
        "memberCount": 156,
        "status": "enrolling",
        "enrollUrl": "https://h5.example.com/enroll/1"
      },
      {
        "id": 2,
        "name": "30天读书训练营",
        "posterUrl": "https://cdn.example.com/posters/camp2.jpg",
        "description": "每天阅读30分钟，分享读书笔记",
        "deposit": 199.00,
        "startDate": "2025-12-15",
        "endDate": "2026-01-14",
        "totalDays": 30,
        "requiredDays": 21,
        "memberCount": 89,
        "status": "enrolling",
        "enrollUrl": "https://h5.example.com/enroll/2"
      }
    ],
    "total": 5,
    "page": 1,
    "pageSize": 10,
    "totalPages": 1
  },
  "timestamp": 1730000000
}
```

---

## 3.2 获取训练营详情

获取指定训练营的详细信息。

**请求**

```
GET /api/h5/camps/{id}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 训练营ID |

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| planetUserId | string | 否 | 星球用户ID（OAuth登录后自动填充） |

**请求示例**

```bash
GET /api/h5/camps/1?planetUserId=123456789
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "id": 1,
    "name": "21天早起打卡训练营",
    "posterUrl": "https://cdn.example.com/posters/camp1.jpg",
    "description": "每天早上6点前打卡，坚持21天养成早起习惯",
    "deposit": 99.00,
    "startDate": "2025-12-10",
    "endDate": "2025-12-31",
    "totalDays": 21,
    "requiredDays": 15,
    "groupQrcodeUrl": null,
    "memberCount": 156,
    "status": "enrolling",
    "rules": [
      "每天早上6:00前完成打卡",
      "打卡内容需包含起床时间",
      "连续3天未打卡视为放弃"
    ],
    "prefillInfo": {
      "planetUserId": "123456789",
      "planetNickname": "小明同学",
      "editable": false
    }
  },
  "timestamp": 1730000000
}
```

---

## 3.3 创建支付订单

创建押金支付订单。

**请求**

```
POST /api/h5/payments
```

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| campId | long | 是 | 训练营ID |
| planetUserId | string | 是 | 星球用户ID |
| planetNickname | string | 是 | 星球昵称 |
| wechatNickname | string | 否 | 微信昵称 |

**请求示例**

```json
{
  "campId": 1,
  "planetUserId": "123456789",
  "planetNickname": "小明同学",
  "wechatNickname": "小明"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "orderId": 10001,
    "orderNo": "ord_a1b2c3d4-5678-90ab-cdef",
    "amount": 99.00,
    "status": "pending",
    "expireTime": "2025-12-01T12:30:00",
    "payUrl": "/api/h5/payments/ord_a1b2c3d4-5678-90ab-cdef/params"
  },
  "timestamp": 1730000000
}
```

**错误响应**

```json
{
  "code": 1001,
  "message": "您已报名该训练营，无需重复报名",
  "data": null,
  "timestamp": 1730000000
}
```

---

## 3.4 获取支付参数

获取微信支付所需参数。

> **安全设计**：此接口使用不可预测的 `orderNo`（UUID 格式）作为路径参数，无法被枚举攻击。`orderNo` 在创建订单时返回给前端，仅当前用户知道。

**请求**

```
GET /api/h5/payments/{orderNo}/params
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| orderNo | string | 是 | 订单号（UUID格式，创建订单时返回） |

**请求示例**

```bash
GET /api/h5/payments/ord_a1b2c3d4-5678-90ab-cdef/params
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "orderNo": "ord_a1b2c3d4-5678-90ab-cdef",
    "amount": 99.00,
    "description": "21天早起打卡训练营 - 押金",
    "payType": "wechat_work",
    "payParams": {
      "appId": "wwxxxxxxxxxx",
      "timeStamp": "1730000000",
      "nonceStr": "abc123xyz",
      "package": "prepay_id=wx20251201120000abcdef",
      "signType": "RSA",
      "paySign": "xxxxxxxxxxxxxxxx"
    },
    "qrcodeUrl": "https://pay.weixin.qq.com/xxxxx",
    "expireTime": "2025-12-01T12:30:00"
  },
  "timestamp": 1730000000
}
```

---

## 3.5 查询支付状态

查询订单支付状态。支付成功时响应中包含 `accessToken`，作为后续敏感接口的凭证。

> **安全设计**：此接口无需票据验证。由于 `orderNo` 使用不可预测的 UUID 格式，无法被枚举攻击。

**请求**

```
GET /api/h5/payments/{orderNo}/status
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| orderNo | string | 是 | 订单号（UUID格式） |

**请求示例**

```bash
GET /api/h5/payments/ord_a1b2c3d4-5678-90ab-cdef/status
```

**响应示例（支付成功）**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "orderNo": "ord_a1b2c3d4-5678-90ab-cdef",
    "payStatus": "success",
    "bindStatus": "completed",
    "bindMethod": "h5_bindplanet",
    "payTime": "2025-12-01T12:05:30",
    "memberId": 1001,
    "showQrcode": true,
    "accessToken": "tk_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
  },
  "timestamp": 1730000000
}
```

**响应示例（待绑定）**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "orderNo": "ord_a1b2c3d4-5678-90ab-cdef",
    "payStatus": "success",
    "bindStatus": "pending",
    "bindMethod": null,
    "payTime": "2025-12-01T12:05:30",
    "memberId": null,
    "showQrcode": false,
    "bindDeadline": "2025-12-08T12:05:30",
    "bindUrl": "/api/h5/payments/bind",
    "accessToken": "tk_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
  },
  "timestamp": 1730000000
}
```

**响应示例（待支付/支付中）**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "orderNo": "ord_a1b2c3d4-5678-90ab-cdef",
    "payStatus": "pending",
    "bindStatus": null,
    "accessToken": null
  },
  "timestamp": 1730000000
}
```

> **说明**：`accessToken` 仅在支付成功后返回，待支付状态时为 `null`。

---

## 3.6 用户绑定星球信息

固定二维码支付后，用户手动绑定星球信息。

> ⚠️ **安全要求**：需要访问票据验证，防止抢绑定攻击。

**请求**

```
POST /api/h5/payments/bind
Header: X-Access-Token: {accessToken}
```

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| orderNo | string | 是 | 订单号 |
| planetUserId | string | 是 | 星球用户ID |
| planetNickname | string | 是 | 星球昵称 |

**安全校验逻辑**：
1. 验证 `accessToken` 有效且未过期（状态为 `active` 或 `bound`）
2. 验证 `accessToken` 绑定的 `orderNo` 与请求一致
3. 若订单已绑定，返回已绑定信息（幂等设计）
4. 绑定成功后将票据状态更新为 `bound`（仍可用于查询）

**请求示例**

```json
{
  "orderNo": "ord_a1b2c3d4-5678-90ab-cdef",
  "planetUserId": "123456789",
  "planetNickname": "小明同学"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "绑定成功",
  "data": {
    "orderNo": "ord_a1b2c3d4-5678-90ab-cdef",
    "bindStatus": "completed",
    "bindMethod": "user_fill",
    "memberId": 1001,
    "showQrcode": true
  },
  "timestamp": 1730000000
}
```

**错误响应**

```json
{
  "code": 1002,
  "message": "该订单已绑定其他星球用户",
  "data": null,
  "timestamp": 1730000000
}
```

```json
{
  "code": 1003,
  "message": "绑定已过期，请联系管理员处理",
  "data": null,
  "timestamp": 1730000000
}
```

---

## 3.7 获取群二维码

支付成功且绑定完成后，获取群二维码。

> ⚠️ **安全要求**：需要访问票据验证，防止订单号枚举获取群入口。

**请求**

```
GET /api/h5/payments/{orderNo}/qrcode
Header: X-Access-Token: {accessToken}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| orderNo | string | 是 | 订单号 |

**请求示例**

```bash
GET /api/h5/payments/ord_a1b2c3d4-5678-90ab-cdef/qrcode
Header: X-Access-Token: tk_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "orderNo": "ord_a1b2c3d4-5678-90ab-cdef",
    "campName": "21天早起打卡训练营",
    "groupQrcodeUrl": "https://cdn.example.com/qrcodes/group1.jpg",
    "memberInfo": {
      "memberId": 1001,
      "planetNickname": "小明同学",
      "planetUserId": "123456789",
      "amount": 99.00
    },
    "tips": "长按保存二维码，微信扫码加入训练营群"
  },
  "timestamp": 1730000000
}
```

**错误响应（未绑定）**

```json
{
  "code": 1004,
  "message": "请先完成星球信息绑定",
  "data": {
    "bindUrl": "/api/h5/payments/bind"
  },
  "timestamp": 1730000000
}
```

---

## 3.8 查询打卡进度

查询会员在训练营中的打卡进度。

> ⚠️ **安全要求**：需要访问票据验证，防止 memberId 枚举泄露用户打卡和退款数据。

**请求**

```
GET /api/h5/progress/{memberId}
Header: X-Access-Token: {accessToken}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| memberId | long | 是 | 会员ID |

**请求示例**

```bash
GET /api/h5/progress/1001
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "memberId": 1001,
    "campId": 1,
    "campName": "21天早起打卡训练营",
    "planetNickname": "小明同学",
    "startDate": "2025-12-10",
    "endDate": "2025-12-31",
    "currentDay": 15,
    "totalDays": 21,
    "requiredDays": 15,
    "checkinCount": 12,
    "checkinRate": 80.00,
    "remainingDays": 6,
    "gap": 3,
    "status": "ongoing",
    "eligibleForRefund": false,
    "refundStatus": null,
    "checkinCalendar": [
      {"date": "2025-12-10", "checked": true},
      {"date": "2025-12-11", "checked": true},
      {"date": "2025-12-12", "checked": false},
      {"date": "2025-12-13", "checked": true},
      {"date": "2025-12-14", "checked": true},
      {"date": "2025-12-15", "checked": true},
      {"date": "2025-12-16", "checked": false},
      {"date": "2025-12-17", "checked": true},
      {"date": "2025-12-18", "checked": true},
      {"date": "2025-12-19", "checked": true},
      {"date": "2025-12-20", "checked": true},
      {"date": "2025-12-21", "checked": true},
      {"date": "2025-12-22", "checked": true},
      {"date": "2025-12-23", "checked": true},
      {"date": "2025-12-24", "checked": false}
    ],
    "lastCheckinTime": "2025-12-23T06:30:00"
  },
  "timestamp": 1730000000
}
```

---

## 3.9 验证会员身份

验证用户是否为知识星球会员。

**请求**

```
POST /api/h5/members/verify
```

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| identifier | string | 是 | 标识符（星球编号、昵称或用户ID） |
| identifierType | string | 是 | 标识符类型：number/nickname/userId |

**请求示例**

```json
{
  "identifier": "12345",
  "identifierType": "number"
}
```

**响应示例（验证通过）**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "verified": true,
    "member": {
      "id": 1,
      "planetUserId": "454511121545",
      "userNumber": 12345,
      "nickname": "张三",
      "avatarUrl": "https://images.zsxq.com/xxx.jpg",
      "role": "member",
      "joinedAt": "2024-01-15T10:30:00",
      "memberStatus": "active"
    }
  },
  "timestamp": 1730000000
}
```

**响应示例（验证失败）**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "verified": false,
    "member": null
  },
  "timestamp": 1730000000
}
```

---

## 3.10 搜索会员

搜索会员（支持昵称模糊查询）。

**请求**

```
GET /api/h5/members/search
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| keyword | string | 是 | 搜索关键词（昵称） |
| page | int | 否 | 页码，默认1 |
| size | int | 否 | 每页数量，默认20，最大100 |

**请求示例**

```bash
GET /api/h5/members/search?keyword=张三&page=1&size=20
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "list": [
      {
        "id": 1,
        "planetUserId": "454511121545",
        "userNumber": 12345,
        "nickname": "张三",
        "avatarUrl": "https://images.zsxq.com/xxx.jpg",
        "role": "member",
        "joinedAt": "2024-01-15T10:30:00",
        "memberStatus": "active"
      }
    ],
    "total": 1,
    "page": 1,
    "pageSize": 20,
    "totalPages": 1
  },
  "timestamp": 1730000000
}
```

---

# 四、训练营管理接口

## 4.1 创建训练营

创建新的训练营。

**请求**

```
POST /api/admin/camps
```

**请求头**

```
Authorization: Bearer {token}
Content-Type: application/json
```

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| name | string | 是 | 训练营名称（最长100字符） |
| posterUrl | string | 是 | 海报图片URL |
| description | string | 否 | 训练营介绍 |
| deposit | decimal | 是 | 押金金额（单位：元） |
| startDate | string | 是 | 开始日期（yyyy-MM-dd） |
| endDate | string | 是 | 结束日期（yyyy-MM-dd） |
| requiredDays | int | 是 | 要求打卡天数 |
| groupQrcodeUrl | string | 是 | 群二维码URL |
| planetProjectId | string | 是 | 知识星球项目ID |

**请求示例**

```json
{
  "name": "21天早起打卡训练营",
  "posterUrl": "https://cdn.example.com/posters/camp1.jpg",
  "description": "每天早上6点前打卡，坚持21天养成早起习惯",
  "deposit": 99.00,
  "startDate": "2025-12-10",
  "endDate": "2025-12-31",
  "requiredDays": 15,
  "groupQrcodeUrl": "https://cdn.example.com/qrcodes/group1.jpg",
  "planetProjectId": "15555411412112"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 1,
    "name": "21天早起打卡训练营",
    "posterUrl": "https://cdn.example.com/posters/camp1.jpg",
    "description": "每天早上6点前打卡，坚持21天养成早起习惯",
    "deposit": 99.00,
    "startDate": "2025-12-10",
    "endDate": "2025-12-31",
    "totalDays": 21,
    "requiredDays": 15,
    "groupQrcodeUrl": "https://cdn.example.com/qrcodes/group1.jpg",
    "planetProjectId": "15555411412112",
    "status": "draft",
    "enrollUrl": null,
    "memberCount": 0,
    "paidAmount": 0,
    "refundedAmount": 0,
    "createdAt": "2025-12-01T10:00:00",
    "updatedAt": "2025-12-01T10:00:00"
  },
  "timestamp": 1730000000
}
```

---

## 4.2 获取训练营列表

获取训练营列表（管理端）。

**请求**

```
GET /api/admin/camps
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | string | 否 | 状态筛选 |
| keyword | string | 否 | 关键词搜索（名称） |
| startDate | string | 否 | 开始日期范围起始 |
| endDate | string | 否 | 开始日期范围结束 |
| page | int | 否 | 页码，默认1 |
| pageSize | int | 否 | 每页条数，默认20 |

**请求示例**

```bash
GET /api/admin/camps?status=ongoing&page=1&pageSize=20
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "list": [
      {
        "id": 1,
        "name": "21天早起打卡训练营",
        "deposit": 99.00,
        "startDate": "2025-12-10",
        "endDate": "2025-12-31",
        "totalDays": 21,
        "requiredDays": 15,
        "status": "ongoing",
        "memberCount": 156,
        "paidAmount": 15444.00,
        "refundedAmount": 0,
        "matchedCount": 150,
        "pendingMatchCount": 6,
        "createdAt": "2025-12-01T10:00:00"
      },
      {
        "id": 2,
        "name": "30天读书训练营",
        "deposit": 199.00,
        "startDate": "2025-12-15",
        "endDate": "2026-01-14",
        "totalDays": 30,
        "requiredDays": 21,
        "status": "enrolling",
        "memberCount": 89,
        "paidAmount": 17711.00,
        "refundedAmount": 0,
        "matchedCount": 85,
        "pendingMatchCount": 4,
        "createdAt": "2025-12-05T10:00:00"
      }
    ],
    "total": 10,
    "page": 1,
    "pageSize": 20,
    "totalPages": 1
  },
  "timestamp": 1730000000
}
```

---

## 4.3 获取训练营详情

获取训练营详细信息（管理端）。

**请求**

```
GET /api/admin/camps/{id}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 训练营ID |

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "id": 1,
    "name": "21天早起打卡训练营",
    "posterUrl": "https://cdn.example.com/posters/camp1.jpg",
    "description": "每天早上6点前打卡，坚持21天养成早起习惯",
    "deposit": 99.00,
    "startDate": "2025-12-10",
    "endDate": "2025-12-31",
    "totalDays": 21,
    "requiredDays": 15,
    "groupQrcodeUrl": "https://cdn.example.com/qrcodes/group1.jpg",
    "planetProjectId": "15555411412112",
    "status": "ongoing",
    "enrollUrl": "https://h5.example.com/enroll/1",
    "memberCount": 156,
    "paidAmount": 15444.00,
    "refundedAmount": 0,
    "statistics": {
      "totalMembers": 156,
      "matchedMembers": 150,
      "pendingMatchMembers": 6,
      "joinedGroupMembers": 148,
      "eligibleForRefund": 120,
      "avgCheckinRate": 75.5
    },
    "coaches": [
      {"id": 2, "name": "张教练"},
      {"id": 3, "name": "李教练"}
    ],
    "volunteers": [
      {"id": 4, "name": "王志愿者"}
    ],
    "createdAt": "2025-12-01T10:00:00",
    "updatedAt": "2025-12-01T10:00:00"
  },
  "timestamp": 1730000000
}
```

---

## 4.4 更新训练营

更新训练营信息。

**请求**

```
PUT /api/admin/camps/{id}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 训练营ID |

**请求体**

```json
{
  "name": "21天早起打卡训练营（第2期）",
  "posterUrl": "https://cdn.example.com/posters/camp1_v2.jpg",
  "description": "更新后的训练营介绍",
  "groupQrcodeUrl": "https://cdn.example.com/qrcodes/group1_v2.jpg"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "更新成功",
  "data": {
    "id": 1,
    "name": "21天早起打卡训练营（第2期）",
    "updatedAt": "2025-12-01T15:00:00"
  },
  "timestamp": 1730000000
}
```

---

## 4.5 删除训练营

删除训练营（软删除）。

**请求**

```
DELETE /api/admin/camps/{id}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 训练营ID |

**响应示例**

```json
{
  "code": 200,
  "message": "删除成功",
  "data": null,
  "timestamp": 1730000000
}
```

**错误响应（已有会员）**

```json
{
  "code": 1101,
  "message": "该训练营已有会员报名，无法删除",
  "data": null,
  "timestamp": 1730000000
}
```

---

## 4.6 发布训练营

发布训练营，生成报名链接。

**请求**

```
POST /api/admin/camps/{id}/publish
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 训练营ID |

**响应示例**

```json
{
  "code": 200,
  "message": "发布成功",
  "data": {
    "id": 1,
    "status": "enrolling",
    "enrollUrl": "https://h5.example.com/enroll/1",
    "dynamicQrcodeUrl": "https://h5.example.com/enroll/1?source=qrcode",
    "publishedAt": "2025-12-01T10:30:00"
  },
  "timestamp": 1730000000
}
```

---

# 五、会员管理接口

## 5.1 获取会员列表

获取训练营会员列表。

**请求**

```
GET /api/admin/members
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| campId | long | 否 | 训练营ID |
| matchStatus | string | 否 | 匹配状态：pending/matched/failed |
| keyword | string | 否 | 关键词搜索（昵称） |
| eligibleForRefund | boolean | 否 | 是否符合退款条件 |
| page | int | 否 | 页码 |
| pageSize | int | 否 | 每页条数 |

**请求示例**

```bash
GET /api/admin/members?campId=1&matchStatus=pending&page=1&pageSize=20
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "list": [
      {
        "id": 1001,
        "campId": 1,
        "campName": "21天早起打卡训练营",
        "filledPlanetNickname": "小明同学",
        "filledPlanetUserId": "123456789",
        "filledWechatNickname": "小明",
        "matchStatus": "matched",
        "matchConfidence": 100,
        "matchedPlanetNickname": "小明同学",
        "joinedGroup": true,
        "joinedAt": "2025-12-10T08:30:00",
        "checkinCount": 12,
        "checkinRate": 80.00,
        "eligibleForRefund": false,
        "payAmount": 99.00,
        "payTime": "2025-12-09T18:00:00",
        "refundStatus": null,
        "createdAt": "2025-12-09T18:00:00"
      },
      {
        "id": 1002,
        "campId": 1,
        "campName": "21天早起打卡训练营",
        "filledPlanetNickname": "张三",
        "filledPlanetUserId": "987654321",
        "filledWechatNickname": "张三三",
        "matchStatus": "pending",
        "matchConfidence": 0,
        "matchedPlanetNickname": null,
        "joinedGroup": false,
        "joinedAt": null,
        "checkinCount": 0,
        "checkinRate": 0,
        "eligibleForRefund": false,
        "payAmount": 99.00,
        "payTime": "2025-12-10T10:00:00",
        "refundStatus": null,
        "createdAt": "2025-12-10T10:00:00"
      }
    ],
    "total": 156,
    "page": 1,
    "pageSize": 20,
    "totalPages": 8
  },
  "timestamp": 1730000000
}
```

---

## 5.2 获取会员详情

获取会员详细信息。

**请求**

```
GET /api/admin/members/{id}
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "id": 1001,
    "campId": 1,
    "campName": "21天早起打卡训练营",
    "filledInfo": {
      "planetNickname": "小明同学",
      "planetUserId": "123456789",
      "wechatNickname": "小明"
    },
    "matchInfo": {
      "status": "matched",
      "confidence": 100,
      "method": "dynamic_qrcode",
      "matchedPlanetUser": {
        "id": 501,
        "planetUserId": "123456789",
        "planetNickname": "小明同学",
        "wechatNickname": "小明"
      },
      "matchTime": "2025-12-09T18:00:30"
    },
    "groupInfo": {
      "joined": true,
      "joinedAt": "2025-12-10T08:30:00"
    },
    "checkinInfo": {
      "count": 12,
      "rate": 80.00,
      "requiredDays": 15,
      "lastCheckinTime": "2025-12-23T06:30:00",
      "eligible": false
    },
    "paymentInfo": {
      "orderId": 10001,
      "orderNo": "ord_a1b2c3d4-5678-90ab-cdef",
      "amount": 99.00,
      "status": "success",
      "payTime": "2025-12-09T18:00:00",
      "bindStatus": "completed",
      "bindMethod": "dynamic_qrcode"
    },
    "refundInfo": null,
    "createdAt": "2025-12-09T18:00:00",
    "updatedAt": "2025-12-23T06:30:00"
  },
  "timestamp": 1730000000
}
```

---

## 5.3 手动匹配会员

管理员手动绑定会员与星球用户。

**请求**

```
POST /api/admin/members/{id}/match
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 会员ID |

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| planetUserId | long | 是 | 星球用户表ID |

**请求示例**

```json
{
  "planetUserId": 501
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "匹配成功",
  "data": {
    "memberId": 1002,
    "matchStatus": "matched",
    "matchConfidence": 100,
    "matchMethod": "manual",
    "matchedPlanetUser": {
      "id": 501,
      "planetUserId": "987654321",
      "planetNickname": "张三"
    }
  },
  "timestamp": 1730000000
}
```

---

## 5.4 标记进群

标记会员已加入训练营群。

**请求**

```
PUT /api/admin/members/{id}/join-group
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 会员ID |

**响应示例**

```json
{
  "code": 200,
  "message": "标记成功",
  "data": {
    "memberId": 1002,
    "joinedGroup": true,
    "joinedAt": "2025-12-10T15:00:00"
  },
  "timestamp": 1730000000
}
```

---

## 5.5 导出会员列表

导出会员列表为Excel。

**请求**

```
GET /api/admin/members/export
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| campId | long | 是 | 训练营ID |
| format | string | 否 | 导出格式：xlsx（默认）/csv |

**响应**

返回文件流，Content-Type: `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`

**响应头**

```
Content-Disposition: attachment; filename="members_camp1_20251201.xlsx"
```

---

## 5.6 同步知识星球会员

手动触发知识星球会员数据同步。

**请求**

```
POST /api/admin/members/sync
```

**请求头**

```
Authorization: Bearer {token}
Content-Type: application/json
```

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| planetId | string | 否 | 星球ID（默认使用配置的星球ID） |
| syncType | string | 是 | 同步类型：full-全量/incremental-增量 |

**请求示例**

```json
{
  "planetId": "28855511455142",
  "syncType": "full"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "id": 1,
    "syncType": "full",
    "status": "success",
    "totalCount": 1500,
    "successCount": 1500,
    "newCount": 50,
    "updateCount": 1450,
    "errorMessage": null,
    "startedAt": "2025-12-01T02:30:00",
    "finishedAt": "2025-12-01T02:35:30",
    "durationMs": 330000
  },
  "timestamp": 1730000000
}
```

---

## 5.7 查询同步状态

查询最近一次会员同步状态。

**请求**

```
GET /api/admin/members/sync/status
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| planetId | string | 否 | 星球ID（默认使用配置的星球ID） |

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "id": 1,
    "syncType": "full",
    "status": "running",
    "totalCount": 800,
    "successCount": 800,
    "newCount": 20,
    "updateCount": 780,
    "errorMessage": null,
    "startedAt": "2025-12-01T02:30:00",
    "finishedAt": null,
    "durationMs": null
  },
  "timestamp": 1730000000
}
```

---

## 5.8 查询同步历史

查询会员同步历史记录。

**请求**

```
GET /api/admin/members/sync/history
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| planetId | string | 否 | 星球ID |
| page | int | 否 | 页码，默认1 |
| pageSize | int | 否 | 每页条数，默认20 |

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "list": [
      {
        "id": 10,
        "syncType": "incremental",
        "status": "success",
        "totalCount": 100,
        "successCount": 100,
        "newCount": 5,
        "updateCount": 0,
        "startedAt": "2025-12-01T08:00:00",
        "finishedAt": "2025-12-01T08:00:30",
        "durationMs": 30000
      },
      {
        "id": 9,
        "syncType": "full",
        "status": "success",
        "totalCount": 1500,
        "successCount": 1500,
        "newCount": 50,
        "updateCount": 1450,
        "startedAt": "2025-12-01T02:30:00",
        "finishedAt": "2025-12-01T02:35:30",
        "durationMs": 330000
      }
    ],
    "total": 50,
    "page": 1,
    "pageSize": 20,
    "totalPages": 3
  },
  "timestamp": 1730000000
}
```

---

## 5.9 批量验证会员

批量验证会员身份。

**请求**

```
POST /api/admin/members/batch-verify
```

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| identifiers | string[] | 是 | 标识符列表（最多100个） |
| identifierType | string | 是 | 标识符类型：number/nickname/userId |

**请求示例**

```json
{
  "identifiers": ["12345", "12346", "12347"],
  "identifierType": "number"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "12345": {
      "verified": true,
      "member": {
        "id": 1,
        "planetUserId": "454511121545",
        "userNumber": 12345,
        "nickname": "张三",
        "avatarUrl": "https://images.zsxq.com/xxx.jpg",
        "role": "member",
        "joinedAt": "2024-01-15T10:30:00",
        "memberStatus": "active"
      }
    },
    "12346": {
      "verified": false,
      "member": null
    },
    "12347": {
      "verified": true,
      "member": {
        "id": 3,
        "planetUserId": "454511121547",
        "userNumber": 12347,
        "nickname": "王五",
        "avatarUrl": "https://images.zsxq.com/yyy.jpg",
        "role": "member",
        "joinedAt": "2024-02-20T14:00:00",
        "memberStatus": "active"
      }
    }
  },
  "timestamp": 1730000000
}
```

---

# 六、打卡管理接口

## 6.1 同步打卡数据

手动触发打卡数据同步。

**请求**

```
POST /api/admin/checkins/sync/{campId}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| campId | long | 是 | 训练营ID |

**响应示例**

```json
{
  "code": 200,
  "message": "同步成功",
  "data": {
    "campId": 1,
    "syncTime": "2025-12-24T10:00:00",
    "totalUsers": 156,
    "newCheckins": 45,
    "updatedMembers": 45,
    "duration": 3500
  },
  "timestamp": 1730000000
}
```

**错误响应（同步进行中）**

```json
{
  "code": 1201,
  "message": "同步进行中，请稍后再试",
  "data": null,
  "timestamp": 1730000000
}
```

---

## 6.2 获取打卡统计

获取训练营打卡统计数据。

**请求**

```
GET /api/admin/checkins/stats/{campId}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| campId | long | 是 | 训练营ID |

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "campId": 1,
    "campName": "21天早起打卡训练营",
    "currentDay": 15,
    "totalDays": 21,
    "totalMembers": 156,
    "todayCheckins": 120,
    "todayCheckinRate": 76.92,
    "avgCheckinRate": 75.50,
    "eligibleCount": 98,
    "eligibleRate": 62.82,
    "distribution": [
      {"checkinDays": "0-5", "count": 10},
      {"checkinDays": "6-10", "count": 28},
      {"checkinDays": "11-15", "count": 70},
      {"checkinDays": "16-21", "count": 48}
    ],
    "dailyStats": [
      {"date": "2025-12-10", "checkinCount": 150, "rate": 96.15},
      {"date": "2025-12-11", "checkinCount": 145, "rate": 92.95},
      {"date": "2025-12-12", "checkinCount": 138, "rate": 88.46}
    ],
    "lastSyncTime": "2025-12-24T01:00:00"
  },
  "timestamp": 1730000000
}
```

---

## 6.3 获取打卡记录

获取打卡记录列表。

**请求**

```
GET /api/admin/checkins/records
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| campId | long | 是 | 训练营ID |
| memberId | long | 否 | 会员ID |
| date | string | 否 | 打卡日期 |
| page | int | 否 | 页码 |
| pageSize | int | 否 | 每页条数 |

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "list": [
      {
        "id": 10001,
        "campId": 1,
        "memberId": 1001,
        "planetNickname": "小明同学",
        "checkinDate": "2025-12-24",
        "checkinTime": "2025-12-24T05:58:30",
        "checkinContent": "今天5点58分起床，完成晨跑3公里！",
        "syncedAt": "2025-12-24T01:00:00"
      },
      {
        "id": 10002,
        "campId": 1,
        "memberId": 1003,
        "planetNickname": "李四",
        "checkinDate": "2025-12-24",
        "checkinTime": "2025-12-24T05:45:00",
        "checkinContent": "5:45 打卡成功",
        "syncedAt": "2025-12-24T01:00:00"
      }
    ],
    "total": 1200,
    "page": 1,
    "pageSize": 20,
    "totalPages": 60
  },
  "timestamp": 1730000000
}
```

---

## 6.4 批量同步所有训练营

同步所有进行中的训练营打卡数据。

**请求**

```
POST /api/admin/checkins/sync
```

**响应示例**

```json
{
  "code": 200,
  "message": "批量同步已启动",
  "data": {
    "taskId": "sync_1730000000",
    "campCount": 5,
    "status": "processing",
    "startTime": "2025-12-24T10:00:00"
  },
  "timestamp": 1730000000
}
```

---

# 七、退款管理接口

## 7.1 获取待审核退款列表

获取待审核的退款申请列表。

**请求**

```
GET /api/admin/refunds/pending
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| campId | long | 否 | 训练营ID |
| page | int | 否 | 页码 |
| pageSize | int | 否 | 每页条数 |

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "list": [
      {
        "id": 5001,
        "campId": 1,
        "campName": "21天早起打卡训练营",
        "memberId": 1001,
        "planetNickname": "小明同学",
        "refundAmount": 99.00,
        "auditStatus": "pending",
        "matchConfidence": 100,
        "matchMethod": "dynamic_qrcode",
        "checkinCount": 16,
        "requiredDays": 15,
        "payTime": "2025-12-09T18:00:00",
        "createdAt": "2025-12-31T03:00:00"
      },
      {
        "id": 5002,
        "campId": 1,
        "campName": "21天早起打卡训练营",
        "memberId": 1003,
        "planetNickname": "李四",
        "refundAmount": 99.00,
        "auditStatus": "pending",
        "matchConfidence": 75,
        "matchMethod": "smart_match",
        "checkinCount": 15,
        "requiredDays": 15,
        "payTime": "2025-12-09T20:00:00",
        "createdAt": "2025-12-31T03:00:00"
      }
    ],
    "total": 98,
    "page": 1,
    "pageSize": 20,
    "totalPages": 5,
    "summary": {
      "totalAmount": 9702.00,
      "highConfidenceCount": 85,
      "lowConfidenceCount": 13
    }
  },
  "timestamp": 1730000000
}
```

---

## 7.2 审核通过退款

审核通过单个退款申请。

**请求**

```
POST /api/admin/refunds/{id}/approve
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 退款记录ID |

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| comment | string | 否 | 审核备注 |

**请求示例**

```json
{
  "comment": "打卡达标，审核通过"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "审核通过",
  "data": {
    "refundId": 5001,
    "auditStatus": "approved",
    "refundStatus": "pending",
    "auditor": "admin",
    "auditTime": "2025-12-31T10:00:00"
  },
  "timestamp": 1730000000
}
```

---

## 7.3 审核拒绝退款

审核拒绝退款申请。

**请求**

```
POST /api/admin/refunds/{id}/reject
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 退款记录ID |

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| reason | string | 是 | 拒绝原因 |

**请求示例**

```json
{
  "reason": "身份匹配置信度过低，需人工核实"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "已拒绝",
  "data": {
    "refundId": 5002,
    "auditStatus": "rejected",
    "refundStatus": "rejected",
    "reason": "身份匹配置信度过低，需人工核实",
    "auditor": "admin",
    "auditTime": "2025-12-31T10:05:00"
  },
  "timestamp": 1730000000
}
```

---

## 7.4 批量审核退款

批量审核通过退款申请。

**请求**

```
POST /api/admin/refunds/batch-approve
```

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| refundIds | long[] | 是 | 退款记录ID列表 |
| minConfidence | int | 否 | 最低置信度阈值（默认80） |
| comment | string | 否 | 审核备注 |

**请求示例**

```json
{
  "refundIds": [5001, 5003, 5004, 5005],
  "minConfidence": 80,
  "comment": "批量审核通过"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "批量审核完成",
  "data": {
    "total": 4,
    "approved": 3,
    "skipped": 1,
    "skippedDetails": [
      {
        "refundId": 5004,
        "reason": "置信度(75)低于阈值(80)"
      }
    ],
    "auditor": "admin",
    "auditTime": "2025-12-31T10:10:00"
  },
  "timestamp": 1730000000
}
```

---

## 7.5 重试失败退款

重试执行失败的退款。

**请求**

```
POST /api/admin/refunds/{id}/retry
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 退款记录ID |

**响应示例**

```json
{
  "code": 200,
  "message": "已加入重试队列",
  "data": {
    "refundId": 5010,
    "refundStatus": "processing",
    "retryCount": 2,
    "lastRetryTime": "2025-12-31T10:15:00"
  },
  "timestamp": 1730000000
}
```

---

## 7.6 获取退款记录

获取退款记录列表。

**请求**

```
GET /api/admin/refunds/records
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| campId | long | 否 | 训练营ID |
| refundStatus | string | 否 | 退款状态 |
| auditStatus | string | 否 | 审核状态 |
| startDate | string | 否 | 开始日期 |
| endDate | string | 否 | 结束日期 |
| page | int | 否 | 页码 |
| pageSize | int | 否 | 每页条数 |

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "list": [
      {
        "id": 5001,
        "campId": 1,
        "campName": "21天早起打卡训练营",
        "memberId": 1001,
        "planetNickname": "小明同学",
        "refundAmount": 99.00,
        "auditStatus": "approved",
        "refundStatus": "success",
        "auditor": "admin",
        "auditTime": "2025-12-31T10:00:00",
        "executeTime": "2025-12-31T10:05:00",
        "wechatRefundId": "50000000001",
        "notified": true,
        "notifyTime": "2025-12-31T10:05:30",
        "createdAt": "2025-12-31T03:00:00"
      }
    ],
    "total": 500,
    "page": 1,
    "pageSize": 20,
    "totalPages": 25,
    "summary": {
      "totalRefunded": 45000.00,
      "successCount": 450,
      "failedCount": 5,
      "pendingCount": 45
    }
  },
  "timestamp": 1730000000
}
```

---

# 八、统计报表接口

## 8.1 获取数据概览

获取系统整体数据概览。

**请求**

```
GET /api/admin/stats/overview
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "summary": {
      "totalCamps": 25,
      "activeCamps": 5,
      "totalMembers": 3500,
      "totalPaid": 320000.00,
      "totalRefunded": 180000.00,
      "netIncome": 140000.00
    },
    "recentCamps": [
      {
        "id": 1,
        "name": "21天早起打卡训练营",
        "status": "ongoing",
        "memberCount": 156,
        "avgCheckinRate": 75.5
      },
      {
        "id": 2,
        "name": "30天读书训练营",
        "status": "enrolling",
        "memberCount": 89,
        "avgCheckinRate": 0
      }
    ],
    "trend": {
      "members": [
        {"date": "2025-11", "count": 500},
        {"date": "2025-12", "count": 800}
      ],
      "revenue": [
        {"date": "2025-11", "amount": 45000.00},
        {"date": "2025-12", "amount": 75000.00}
      ]
    },
    "generatedAt": "2025-12-24T10:00:00"
  },
  "timestamp": 1730000000
}
```

---

## 8.2 获取训练营统计

获取单个训练营的详细统计数据。

**请求**

```
GET /api/admin/stats/camps/{id}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 训练营ID |

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "campId": 1,
    "campName": "21天早起打卡训练营",
    "status": "finished",
    "period": {
      "startDate": "2025-12-10",
      "endDate": "2025-12-31",
      "totalDays": 21
    },
    "enrollment": {
      "totalMembers": 156,
      "matchedMembers": 150,
      "matchRate": 96.15,
      "joinedGroupMembers": 148,
      "joinRate": 94.87
    },
    "checkin": {
      "avgCheckinRate": 75.50,
      "eligibleMembers": 98,
      "eligibleRate": 62.82,
      "distribution": [
        {"range": "0-5天", "count": 10, "percentage": 6.41},
        {"range": "6-10天", "count": 28, "percentage": 17.95},
        {"range": "11-15天", "count": 70, "percentage": 44.87},
        {"range": "16-21天", "count": 48, "percentage": 30.77}
      ]
    },
    "finance": {
      "totalPaid": 15444.00,
      "totalRefunded": 9702.00,
      "netIncome": 5742.00,
      "refundRate": 62.82
    },
    "refund": {
      "totalRefunds": 98,
      "successRefunds": 95,
      "failedRefunds": 3,
      "successRate": 96.94
    },
    "dailyTrend": [
      {"date": "2025-12-10", "checkinCount": 150, "checkinRate": 96.15},
      {"date": "2025-12-11", "checkinCount": 145, "checkinRate": 92.95}
    ],
    "generatedAt": "2025-12-31T12:00:00"
  },
  "timestamp": 1730000000
}
```

---

## 8.3 导出统计报表

导出训练营统计报表。

**请求**

```
GET /api/admin/stats/export
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| campId | long | 否 | 训练营ID（不传则导出全部） |
| startDate | string | 否 | 开始日期 |
| endDate | string | 否 | 结束日期 |
| type | string | 否 | 报表类型：summary/detail |
| format | string | 否 | 导出格式：xlsx/pdf |

**响应**

返回文件流

---

# 九、系统管理接口

## 9.1 用户登录

管理员登录。

**请求**

```
POST /api/admin/auth/login
```

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| username | string | 是 | 用户名 |
| password | string | 是 | 密码 |

**请求示例**

```json
{
  "username": "admin",
  "password": "admin123"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "userId": 1,
    "username": "admin",
    "realName": "超级管理员",
    "role": "admin",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresIn": 86400,
    "permissions": ["camp:*", "member:*", "refund:*", "stats:*", "system:*"]
  },
  "timestamp": 1730000000
}
```

**错误响应**

```json
{
  "code": 401,
  "message": "用户名或密码错误",
  "data": null,
  "timestamp": 1730000000
}
```

---

## 9.2 用户登出

管理员登出。

**请求**

```
POST /api/admin/auth/logout
```

**响应示例**

```json
{
  "code": 200,
  "message": "登出成功",
  "data": null,
  "timestamp": 1730000000
}
```

---

## 9.3 获取用户列表

获取系统用户列表。

**请求**

```
GET /api/admin/users
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "list": [
      {
        "id": 1,
        "username": "admin",
        "realName": "超级管理员",
        "role": "admin",
        "status": "active",
        "lastLoginTime": "2025-12-24T09:00:00",
        "createdAt": "2025-01-01T00:00:00"
      },
      {
        "id": 2,
        "username": "manager1",
        "realName": "张管理",
        "role": "manager",
        "status": "active",
        "lastLoginTime": "2025-12-24T08:30:00",
        "createdAt": "2025-06-01T00:00:00"
      }
    ],
    "total": 10,
    "page": 1,
    "pageSize": 20,
    "totalPages": 1
  },
  "timestamp": 1730000000
}
```

---

## 9.4 创建用户

创建系统用户。

**请求**

```
POST /api/admin/users
```

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| username | string | 是 | 用户名 |
| password | string | 是 | 密码 |
| realName | string | 是 | 真实姓名 |
| role | string | 是 | 角色：admin/manager/coach/volunteer |

**请求示例**

```json
{
  "username": "coach1",
  "password": "coach123",
  "realName": "李教练",
  "role": "coach"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 5,
    "username": "coach1",
    "realName": "李教练",
    "role": "coach",
    "status": "active",
    "createdAt": "2025-12-24T10:00:00"
  },
  "timestamp": 1730000000
}
```

---

## 9.5 更新系统配置

更新系统配置项。

**请求**

```
PUT /api/admin/config
```

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| key | string | 是 | 配置键 |
| value | string | 是 | 配置值 |

**请求示例**

```json
{
  "key": "planet.cookie",
  "value": "new_cookie_value_here"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "配置更新成功",
  "data": {
    "key": "planet.cookie",
    "updatedAt": "2025-12-24T10:00:00"
  },
  "timestamp": 1730000000
}
```

---

# 十、认证管理接口

## 10.1 获取微信授权地址

获取微信公众号OAuth授权跳转URL。

**请求**

```
GET /api/auth/authorize?returnUrl={url}
```

**请求参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| returnUrl | string | 否 | 授权成功后的前端跳转地址，必须在白名单内 |

**安全说明**：
- `returnUrl` 会经过白名单验证（配置见 `application.yml` 的 `app.auth.allowed-return-urls`）
- 系统将 returnUrl 存储在 Redis（5分钟过期），state 中仅携带短 ID
- 防止开放重定向攻击和 token 泄露

**响应参数**

| 字段 | 类型 | 说明 |
|------|------|------|
| authorize_url | string | 完整的微信授权跳转URL |

**响应示例（成功）**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "authorize_url": "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx123&redirect_uri=...&state=abc123%7Cuuid456"
  },
  "timestamp": 1730000000
}
```

**响应示例（returnUrl 非法）**

```json
{
  "code": 400,
  "message": "非法的重定向地址",
  "data": null,
  "timestamp": 1730000000
}
```

**错误码**

| 错误码 | 说明 |
|--------|------|
| 400 | returnUrl 不在白名单内 |

---

## 10.2 微信OAuth回调处理

处理微信公众号OAuth授权回调，换取用户信息并创建会话。

**请求**

```
GET /api/auth/callback/wechat-mp
```

**请求参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| code | string | 是 | 微信授权临时票据 |
| state | string | 是 | 授权请求时传入的state参数 |

**响应参数**

| 字段 | 类型 | 说明 |
|------|------|------|
| access_token | string | 系统访问票据，格式 `tk_` + UUID |
| expires_in | number | 票据有效期（秒），默认7天 |
| member | object | 会员信息（如已绑定知识星球） |
| need_bindPlanet | boolean | 是否需要绑定知识星球账号 |

**响应示例（新用户，需绑定）**

```json
{
  "code": 200,
  "message": "授权成功",
  "data": {
    "access_token": "tk_550e8400-e29b-41d4-a716-446655440000",
    "expires_in": 604800,
    "need_bindPlanet": true,
    "member": null
  },
  "timestamp": 1730000000
}
```

**响应示例（已绑定用户）**

```json
{
  "code": 200,
  "message": "授权成功",
  "data": {
    "access_token": "tk_550e8400-e29b-41d4-a716-446655440000",
    "expires_in": 604800,
    "need_bindPlanet": false,
    "member": {
      "id": 1001,
      "nickname": "用户昵称",
      "avatar_url": "https://...",
      "planet_nickname": "星球昵称",
      "bindStatus": "BINDID",
      "bindMethod": "WECHAT_OAUTH"
    }
  },
  "timestamp": 1730000000
}
```

**错误码**

| 错误码 | 说明 |
|--------|------|
| 400001 | 缺少code参数 |
| 400002 | state无效或已过期 |
| 500001 | 微信接口调用失败 |

---

## 10.3 绑定知识星球账号

将微信身份与知识星球会员账号绑定，建立支付身份映射关系。

**请求**

```
POST /api/auth/bindPlanet
```

**请求头**

```
Authorization: Bearer tk_550e8400-e29b-41d4-a716-446655440000
Content-Type: application/json
```

**请求体**

```json
{
  "planet_user_id": "123456789",
  "planet_nickname": "星球昵称"
}
```

**请求参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| planet_user_id | string | 是 | 知识星球用户ID |
| planet_nickname | string | 是 | 知识星球昵称，用于人工核验 |

**响应参数**

| 字段 | 类型 | 说明 |
|------|------|------|
| member_id | number | 系统会员ID |
| bindStatus | string | 绑定状态：BINDID |
| bindMethod | string | 绑定方式：WECHAT_OAUTH |
| bindAt | string | 绑定时间（ISO8601） |

**响应示例**

```json
{
  "code": 200,
  "message": "绑定成功",
  "data": {
    "member_id": 1001,
    "bindStatus": "BINDID",
    "bindMethod": "WECHAT_OAUTH",
    "bindAt": "2025-12-24T10:30:00"
  },
  "timestamp": 1730000000
}
```

**错误码**

| 错误码 | 说明 | 详细说明 |
|--------|------|----------|
| 400001 | 缺少必填参数 | planet_user_id 或 planet_nickname 未提供 |
| 400003 | 知识星球用户ID不存在 | 系统中未同步该星球用户，请联系管理员 |
| 400004 | 该知识星球账号已被其他用户绑定 | 一个星球账号只能绑定一个系统用户（UNIQUE约束） |
| 400005 | 您已绑定星球账号 | 当前用户已绑定，无法重复绑定 |
| 401001 | 未登录或票据已过期 | 请重新进行微信授权登录 |

**安全机制**：
- 数据库层：`UNIQUE(user_id)` 和 `UNIQUE(planet_user_id)` 双向唯一约束
- 应用层：绑定前主动检查双向冲突 + 捕获 DuplicateKeyException

---

# 十一、Webhook接口

## 11.0 Webhook 通用说明

### 安全机制

**签名验证算法（微信支付 V3）**：

微信支付使用 **SHA256-RSA2048** 签名算法，验证流程如下：

1. **构造验签名串**：
```
HTTP请求方法\n
URL\n
请求时间戳\n
请求随机串\n
请求报文主体\n
```

2. **获取平台证书公钥**：
   - 从微信支付平台下载证书（首次需手动配置）
   - 系统启动时加载公钥到内存
   - 定期更新证书（微信会提前通知）

3. **验证签名**：
```java
// 伪代码示例
String message = String.format("%s\n%s\n%s\n%s\n%s\n",
    method,           // POST
    url,              // /api/webhook/wechat/payment
    timestamp,        // Header: Wechatpay-Timestamp
    nonce,            // Header: Wechatpay-Nonce
    body              // 原始请求体（未解密）
);

boolean valid = Signature.getInstance("SHA256withRSA")
    .verify(Base64.decode(signatureFromHeader));

if (!valid) {
    return Response.fail("SIGNATURE_FAIL", "签名验证失败");
}
```

4. **解密报文**：
   - 使用商户 API v3 密钥（APIv3Key）解密
   - 算法：`AEAD_AES_256_GCM`
   - 解密后得到业务数据（JSON格式）

**请求体加密格式**：
```json
{
  "id": "EV-2018022511223320873",
  "create_time": "2018-02-25T11:22:33+08:00",
  "resource_type": "encrypt-resource",
  "event_type": "TRANSACTION.SUCCESS",
  "resource": {
    "algorithm": "AEAD_AES_256_GCM",
    "ciphertext": "...",  // 加密的业务数据
    "associated_data": "transaction",
    "nonce": "..."
  }
}
```

### 重试策略

**微信支付重试机制**：
- 首次回调失败后，微信会进行最多 **8 次重试**
- 重试间隔：15s, 15s, 30s, 3min, 10min, 20min, 30min, 30min
- 系统必须在 **5 秒内** 返回成功响应，否则视为失败

**系统处理策略**：
1. **幂等性保证**：
   - 使用 `out_trade_no`（订单号）或 `transaction_id`（微信流水号）作为唯一标识
   - 处理前先查询数据库，已处理则直接返回成功
   - 使用数据库事务确保原子性

2. **异步处理**（可选）：
   ```
   接收回调 → 验签解密 → 写入消息队列 → 立即返回成功 → 异步处理业务
   ```

3. **失败降级**：
   - 若业务处理失败（如数据库异常），返回 `SYSTEM_ERROR`
   - 微信会继续重试，系统记录日志并发送告警
   - 超过最大重试次数后，需人工介入处理

### 返回码规范

系统必须严格按照微信要求返回以下格式：

**成功响应**：
```json
{
  "code": "SUCCESS",
  "message": "成功"
}
```

**失败响应**：
```json
{
  "code": "错误码",
  "message": "错误描述"
}
```

**错误码列表**：

| 错误码 | 说明 | 微信重试 | 处理建议 |
|--------|------|----------|----------|
| `SUCCESS` | 成功 | 否 | - |
| `SIGNATURE_FAIL` | 签名验证失败 | 否 | 检查证书配置，记录原始数据 |
| `DECRYPT_FAIL` | 解密失败 | 否 | 检查 APIv3Key 配置 |
| `INVALID_REQUEST` | 请求参数错误 | 否 | 记录请求体，排查数据格式 |
| `DUPLICATE_CALLBACK` | 重复回调（已处理） | 否 | 返回成功，幂等性保证 |
| `ORDER_NOT_FOUND` | 订单不存在 | 否 | 记录日志，可能是测试回调 |
| `SYSTEM_ERROR` | 系统内部错误 | **是** | 发送告警，人工介入 |

### 幂等性要求

**关键字段唯一性检查**：
- 支付回调：`out_trade_no` + `transaction_id`
- 退款回调：`out_refund_no` + `refund_id`

**处理流程**：
```java
@Transactional
public void handlePaymentCallback(PaymentNotification notification) {
    // 1. 查询订单是否已处理
    PaymentRecord record = paymentRepository.findByOrderNo(notification.getOutTradeNo());

    if (record.getPayStatus() == "success"
        && record.getWechatTransactionId().equals(notification.getTransactionId())) {
        log.info("订单已处理，幂等返回成功: {}", notification.getOutTradeNo());
        return; // 直接返回，不重复处理
    }

    // 2. 业务处理（仅首次执行）
    record.setPayStatus("success");
    record.setWechatTransactionId(notification.getTransactionId());
    record.setPayTime(notification.getSuccessTime());
    paymentRepository.save(record);

    // 3. 生成 access_token（若为动态二维码支付）
    if (notification.getAttach() != null) {
        AccessToken token = generateAccessToken(record);
        redisTemplate.opsForValue().set("access_token:" + token.getToken(), ...);
    }
}
```

---

## 11.1 支付结果通知

微信支付结果回调。

**请求**

```
POST /api/webhook/wechat/payment
```

**请求头**

```
Wechatpay-Signature: xxxxxx
Wechatpay-Timestamp: 1730000000
Wechatpay-Nonce: abc123
Wechatpay-Serial: xxxxx
Content-Type: application/json
```

**请求体（原始加密格式）**

```json
{
  "id": "EV-2018022511223320873",
  "create_time": "2025-12-01T12:05:35+08:00",
  "resource_type": "encrypt-resource",
  "event_type": "TRANSACTION.SUCCESS",
  "summary": "支付成功",
  "resource": {
    "algorithm": "AEAD_AES_256_GCM",
    "ciphertext": "sGF4eKLlLd7R...(Base64编码的密文)",
    "associated_data": "transaction",
    "nonce": "a13c91db6b2f"
  }
}
```

**请求体（解密后）**

```json
{
  "mchid": "1234567890",
  "appid": "wwxxxxxxxxxx",
  "out_trade_no": "ord_a1b2c3d4-5678-90ab-cdef",
  "transaction_id": "4200001234567890",
  "trade_type": "JSAPI",
  "trade_state": "SUCCESS",
  "trade_state_desc": "支付成功",
  "bank_type": "OTHERS",
  "attach": "{\"campId\":1,\"planetUserId\":\"123456789\",\"planetNickname\":\"小明同学\"}",
  "success_time": "2025-12-01T12:05:30+08:00",
  "payer": {
    "openid": "oxxxxxxxxxx"
  },
  "amount": {
    "total": 9900,
    "payer_total": 9900,
    "currency": "CNY",
    "payer_currency": "CNY"
  }
}
```

**关键字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| out_trade_no | string | **订单号（系统生成）** - 幂等性关键字段 |
| transaction_id | string | **微信支付交易号** - 退款时需要 |
| trade_state | string | 交易状态：SUCCESS-成功, REFUND-转入退款, CLOSED-已关闭 |
| attach | string | **附加数据（动态二维码支付）** - JSON 格式，见下表 |
| success_time | string | 支付完成时间（ISO8601格式） |
| payer.openid | string | **支付者 openid** - 用于绑定验证 |
| amount.total | int | 订单金额（单位：分） |

**attach 字段格式**（动态二维码支付时携带）：

```json
{
  "campId": 1,                       // 训练营ID
  "planetUserId": "123456789",       // 星球用户ID（长整型字符串）
  "planetNickname": "小明同学"        // 星球昵称（用于显示）
}
```

> **说明**：固定二维码支付时 `attach` 为空，需后续用户手动绑定。

**业务处理要点**：

1. **幂等性检查**：
   ```sql
   SELECT * FROM payment_record
   WHERE order_no = ? AND wechat_transaction_id = ?
   ```

2. **订单状态更新**：
   - `pay_status`: `pending` → `success`
   - `pay_time`: 设置为 `success_time`
   - `wechat_transaction_id`: 保存微信流水号
   - `callback_data`: 保存完整回调 JSON（便于排查）

3. **动态二维码处理**（attach 不为空）：
   - 解析 attach JSON
   - 创建 `camp_member` 记录
   - 自动匹配 `planet_user`（置信度 100%）
   - 生成 `access_token` 并存入 Redis
   - 发送支付成功通知

4. **固定二维码处理**（attach 为空）：
   - 仅更新 `payment_record`
   - 设置 `bind_status` = `pending`
   - 设置 `bind_deadline` = 7 天后
   - 生成 `access_token`（status = `active`）

**响应（成功）**

```json
{
  "code": "SUCCESS",
  "message": "成功"
}
```

**响应（失败）**

| 场景 | 响应 |
|------|------|
| 签名验证失败 | `{"code": "SIGNATURE_FAIL", "message": "签名验证失败"}` |
| 订单不存在 | `{"code": "ORDER_NOT_FOUND", "message": "订单不存在"}` |
| 重复回调 | `{"code": "SUCCESS", "message": "成功"}` （幂等返回） |
| 系统异常 | `{"code": "SYSTEM_ERROR", "message": "系统处理失败"}` |

**测试回调示例**（开发环境）：

```bash
# 使用微信支付沙箱环境
curl -X POST http://localhost:8080/api/webhook/wechat/payment \
  -H "Wechatpay-Signature: xxxx" \
  -H "Wechatpay-Timestamp: 1730000000" \
  -H "Wechatpay-Nonce: abc123" \
  -H "Wechatpay-Serial: xxxx" \
  -H "Content-Type: application/json" \
  -d @test-payment-callback.json
```

---

## 11.2 退款结果通知

微信支付退款结果回调。

**请求**

```
POST /api/webhook/wechat/refund
```

**请求头**

```
Wechatpay-Signature: xxxxxx
Wechatpay-Timestamp: 1730000000
Wechatpay-Nonce: abc123
Wechatpay-Serial: xxxxx
Content-Type: application/json
```

**请求体（原始加密格式）**

```json
{
  "id": "EV-2018022511223320874",
  "create_time": "2025-12-31T10:05:05+08:00",
  "resource_type": "encrypt-resource",
  "event_type": "REFUND.SUCCESS",
  "summary": "退款成功",
  "resource": {
    "algorithm": "AEAD_AES_256_GCM",
    "ciphertext": "xGt7oPqL9sR...(Base64编码的密文)",
    "associated_data": "refund",
    "nonce": "b24d92ec7c3g"
  }
}
```

**请求体（解密后）**

```json
{
  "mchid": "1234567890",
  "out_trade_no": "ord_a1b2c3d4-5678-90ab-cdef",
  "transaction_id": "4200001234567890",
  "out_refund_no": "REFUND_1730000000_5001",
  "refund_id": "50000000001",
  "refund_status": "SUCCESS",
  "success_time": "2025-12-31T10:05:00+08:00",
  "user_received_account": "招商银行储蓄卡0403",
  "amount": {
    "total": 9900,
    "refund": 9900,
    "payer_total": 9900,
    "payer_refund": 9900
  }
}
```

**关键字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| out_trade_no | string | 原支付订单号 |
| transaction_id | string | 微信支付交易号 |
| out_refund_no | string | **退款单号（系统生成）** - 幂等性关键字段 |
| refund_id | string | **微信退款单号** |
| refund_status | string | 退款状态：SUCCESS-成功, CLOSED-已关闭, ABNORMAL-异常 |
| success_time | string | 退款成功时间（ISO8601格式） |
| user_received_account | string | 退款入账账户（用户视角） |
| amount.refund | int | 退款金额（单位：分） |

**业务处理要点**：

1. **幂等性检查**：
   ```sql
   SELECT * FROM refund_record
   WHERE id = (
     SELECT id FROM refund_record
     WHERE CONCAT('REFUND_', unix_timestamp(created_at), '_', id) = ?
   ) AND wechat_refund_id = ?
   ```

2. **退款状态更新**：
   - `refund_status`: `processing` → `success` / `failed`
   - `execute_time`: 设置为 `success_time`
   - `wechat_refund_id`: 保存微信退款单号

3. **SUCCESS 处理**：
   - 更新 `refund_record.refund_status` = `success`
   - 更新 `payment_record.pay_status` = `refunded`（可选）
   - 发送退款成功通知（企业微信/站内信）
   - 记录到 `refund_status_log`

4. **CLOSED / ABNORMAL 处理**：
   - 更新 `refund_record.refund_status` = `failed`
   - 记录失败原因到 `failure_reason`
   - 触发告警，需人工介入处理
   - `retry_count` < 3 时可尝试重新发起退款

**响应（成功）**

```json
{
  "code": "SUCCESS",
  "message": "成功"
}
```

**响应（失败）**

| 场景 | 响应 |
|------|------|
| 签名验证失败 | `{"code": "SIGNATURE_FAIL", "message": "签名验证失败"}` |
| 退款单不存在 | `{"code": "ORDER_NOT_FOUND", "message": "退款单不存在"}` |
| 重复回调 | `{"code": "SUCCESS", "message": "成功"}` （幂等返回） |
| 系统异常 | `{"code": "SYSTEM_ERROR", "message": "系统处理失败"}` |

**异常退款状态处理**：

```java
// 伪代码示例
if ("ABNORMAL".equals(refundStatus)) {
    // 1. 记录异常原因
    refundRecord.setRefundStatus("failed");
    refundRecord.setFailureReason("微信退款异常: " + refundStatusDesc);

    // 2. 发送告警
    alertService.send("退款异常", String.format(
        "订单 %s 退款异常，退款单号 %s，原因：%s",
        outTradeNo, outRefundNo, refundStatusDesc
    ));

    // 3. 标记需人工处理
    if (refundRecord.getRetryCount() >= 3) {
        refundRecord.setNeedManualHandle(true);
    }
}
```

**测试回调示例**（开发环境）：

```bash
# 使用微信支付沙箱环境
curl -X POST http://localhost:8080/api/webhook/wechat/refund \
  -H "Wechatpay-Signature: xxxx" \
  -H "Wechatpay-Timestamp: 1730000000" \
  -H "Wechatpay-Nonce: abc123" \
  -H "Wechatpay-Serial: xxxx" \
  -H "Content-Type: application/json" \
  -d @test-refund-callback.json
```

---

# 十二、流程图

## 12.1 报名支付流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant H5 as H5前端
    participant API as API服务
    participant WX as 微信支付

    U->>H5: 访问报名页
    H5->>API: GET /api/h5/camps/{id}
    API-->>H5: 返回训练营详情

    U->>H5: 填写信息并支付
    H5->>API: POST /api/h5/payments
    API-->>H5: 返回订单信息（含orderNo）

    H5->>API: GET /api/h5/payments/{orderNo}/params
    API-->>H5: 返回支付参数

    H5->>WX: 调起支付
    U->>WX: 完成支付
    WX->>API: POST /api/webhook/wechat/payment
    API-->>WX: 返回SUCCESS

    loop 轮询支付状态
        H5->>API: GET /api/h5/payments/{orderNo}/status
        API-->>H5: 返回支付状态（含accessToken）
    end

    H5->>API: GET /api/h5/payments/{orderNo}/qrcode
    Note right of H5: Header: X-Access-Token
    API-->>H5: 返回群二维码
    H5-->>U: 显示群二维码
```

## 12.2 退款审核流程

```mermaid
flowchart TD
    A[训练营结束] --> B[系统生成退款名单]
    B --> C{bind_status?}
    C -->|completed| D[置信度100%]
    C -->|其他| E[智能匹配]
    E --> F{匹配评分}
    F -->|>=80%| G[置信度=评分]
    F -->|50-79%| H[待人工审核]
    F -->|<50%| I[人工处理]

    D --> J[管理员审核]
    G --> J
    H --> J
    I --> K[手动匹配]
    K --> J

    J --> L{审核结果}
    L -->|通过| M[执行退款]
    L -->|拒绝| N[记录原因]

    M --> O{退款结果}
    O -->|成功| P[通知会员]
    O -->|失败| Q{重试次数}
    Q -->|<3| M
    Q -->|>=3| R[人工处理]
```

## 12.3 打卡数据同步流程

```mermaid
flowchart TD
    A[定时任务触发] --> B[获取进行中训练营]
    B --> C[遍历训练营]
    C --> D[调用知识��球API]
    D --> E{API成功?}
    E -->|是| F[解析打卡数据]
    E -->|否| G{重试次数<3?}
    G -->|是| D
    G -->|否| H[发送告警]

    F --> I[更新打卡记录]
    I --> J[更新会员统计]
    J --> K[计算退款资格]
    K --> L{还有训练营?}
    L -->|是| C
    L -->|否| M[同步完成]
```

---

# 十三、使用场景

## 13.1 OAuth登录报名场景

**场景描述**：用户通过微信公众号OAuth登录后报名，系统自动绑定微信和星球账号。

**流程**：
1. 用户在知识星球看到训练营海报，点击报名链接
2. 链接格式：`https://h5.example.com/enroll/1`
3. H5页面引导用户微信OAuth登录
4. 登录成功后，用户填写星球ID和昵称
5. 调用 `POST /api/h5/payments` 创建订单
6. 支付成功后，系统自动完成绑定，`bind_status=completed, bind_method=h5_bindplanet`
7. 用户直接获取群二维码

**优点**：用户体验最佳，身份验证可靠，支持后续自动退款。

---

## 13.2 固定二维码报名场景

**场景描述**：用户通过固定收款码支付，支付后需要手动填写星球信息。

**流程**：
1. 用户扫描固定收款码支付押金
2. 支付成功后，Webhook 回调中 attach 为空
3. 系统创建支付记录，`bind_status=pending, bind_deadline=7天后`
4. 用户跳转到绑定页面，调用 `POST /api/h5/payments/bind` 提交星球信息
5. 系统验证信息后完成绑定，`bind_status=completed, bind_method=user_fill`
6. 用户获取群二维码

**注意事项**：
- 用户需在7天内完成绑定，否则状态变为 `expired`
- 过期后需要人工处理或等待智能匹配

---

## 13.3 批量退款审核场景

**场景描述**：训练营结束后，管理员批量审核退款申请。

**流程**：
1. 训练营结束，系统自动生成退款名单
2. 管理员调用 `GET /admin/refunds/pending` 查看待审核列表
3. 对于高置信度（>=80%）的申请，调用 `POST /admin/refunds/batch-approve` 批量通过
4. 对于低置信度的申请，逐个审核或手动匹配后再审核
5. 系统自动执行退款并发送通知

**最佳实践**：
- 先处理高置信度申请，提高效率
- 低置信度申请需仔细核对打卡记录
- 退款失败时检查商户余额

---

# 十四、错误码说明

## 14.1 通用错误码

| 错误码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未认证或Token过期 |
| 403 | 无权限 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

## 14.2 业务错误码

### H5端（1001-1099）

| 错误码 | 说明 |
|--------|------|
| 1001 | 您已报名该训练营，无需重复报名 |
| 1002 | 该订单已绑定其他星球用户 |
| 1003 | 绑定已过期，请联系管理员处理 |
| 1004 | 请先完成星球信息绑定 |
| 1005 | 订单不存在或已取消 |
| 1006 | 训练营不在报名期 |

### 训练营管理（1101-1199）

| 错误码 | 说明 |
|--------|------|
| 1101 | 该训练营已有会员报名，无法删除 |
| 1102 | 训练营状态不允许此操作 |
| 1103 | 训练营信息不完整，无法发布 |

### 打卡管理（1201-1299）

| 错误码 | 说明 |
|--------|------|
| 1201 | 同步进行中，请稍后再试 |
| 1202 | 知识星球Cookie已过期，请更新 |
| 1203 | 知识星球API调用失败 |

### 退款管理（1301-1399）

| 错误码 | 说明 |
|--------|------|
| 1301 | 退款记录不存在 |
| 1302 | 退款状态不允许此操作 |
| 1303 | 商户余额不足 |
| 1304 | 退款API调用失败 |
| 1305 | 退款金额超过原支付金额 |

### 系统管理（1401-1499）

| 错误码 | 说明 |
|--------|------|
| 1401 | 用户名已存在 |
| 1402 | 用户不存在 |
| 1403 | 原密码错误 |
| 1404 | 配置项不存在 |

---

**文档结束**

*本文档包含48个API接口的完整定义，供前后端开发参考。*
