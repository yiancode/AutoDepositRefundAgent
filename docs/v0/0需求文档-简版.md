# 知识星球训练营退款系统 - v0 简版需求文档

## 文档信息
- **版本**：v0.1（简化版）
- **创建日期**：2025-10-26
- **目标**：实现最小可用退款功能（MVP）

---

## 一、项目背景

知识星球每月举办多个训练营项目，目前**退款流程完全手工操作**：
1. 人工从知识星球导出打卡数据
2. 人工核对每个会员的打卡天数
3. 人工在企业微信后台一个个点击退款

**痛点**：耗时、易错、效率低下。

---

## 二、v0 版本目标

**核心诉求**：封装知识星球 API,提供简单的退款名单生成服务

### 2.1 技术方案

**架构**：无数据库,纯 API 服务
- 部署域名: `zsxq.dc401.com`
- 技术栈: Node.js / Python + FastAPI（轻量级）
- 数据来源: 实时调用知识星球 API
- 无需存储: 不保存任何数据,仅提供代理和计算服务

### 2.2 范围界定

✅ **v0 包含的功能**：
1. 封装知识星球 API（获取训练营列表、打卡排行榜）
2. 提供计算接口（根据完成天数计算合格名单）
3. 返回 JSON 数据供前端展示

❌ **v0 不包含的功能**（留待 v1）：
- 数据库存储
- 企业微信支付对接
- 会员报名和支付流程
- 自动退款功能
- 定时任务


---

## 三、核心业务流程

```
【前端】管理员打开 Web 页面
    ↓
【前端 → API】调用 GET /api/camps 获取训练营列表
    ↓
【API → 知识星球】实时调用知识星球 API（3个状态：ongoing/over/closed）
    ↓
【API → 前端】返回训练营列表（名称、状态、打卡天数、参与人数）
    ↓
【前端】管理员选择某个训练营，输入"完成几天算合格"
    ↓
【前端 → API】调用 POST /api/camps/{checkin_id}/refund-list
    ↓
【API → 知识星球】实时调用打卡排行榜接口
    ↓
【API】计算合格名单（打卡天数 >= 要求天数）
    ↓
【API → 前端】返回退款名单 JSON
    ↓
【前端】展示表格（星球昵称、星球ID、打卡天数、是否合格）
    ↓
【人工操作】管理员导出 Excel，线下手动退款
```

---

## 四、API 接口设计

### 4.1 获取训练营列表

**接口**: `GET /api/camps`

**请求参数**:
```json
{
  "scope": "ongoing",  // ongoing: 进行中, over: 已结束, closed: 已关闭
  "count": 100
}
```

**后端逻辑**:
1. 调用知识星球 API: `GET https://api.zsxq.com/v2/groups/15555411412112/checkins?scope={scope}&count={count}`
2. 解析返回的 JSON 数据
3. 提取关键字段返回

**响应示例**:
```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "camps": [
      {
        "checkin_id": 2424424541,
        "title": "2510 AI小绿书爆文",
        "checkin_days": 9,
        "status": "ongoing",
        "joined_count": 115,
        "expiration_time": "2025-11-03T23:59:59.999+0800"
      }
    ]
  }
}
```

---

### 4.2 获取打卡排行榜并计算退款名单

**接口**: `POST /api/camps/{checkin_id}/refund-list`

**请求参数**:
```json
{
  "required_days": 7  // 完成几天算合格
}
```

**后端逻辑**:
1. 调用知识星球 API: `GET https://api.zsxq.com/v2/groups/15555411412112/checkins/{checkin_id}/ranking_list?type=accumulated&index=0`
2. 获取所有打卡记录
3. 根据 `required_days` 计算是否合格: `checkined_days >= required_days`
4. 返回完整名单

**响应示例**:
```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "camp_info": {
      "title": "2510 AI写作",
      "total_days": 9,
      "joined_count": 99
    },
    "refund_list": [
      {
        "planet_user_id": 88455815452182,
        "planet_nickname": "球球的副业探索路",
        "planet_alias": "",
        "rankings": 1,
        "checkined_days": 10,
        "required_days": 7,
        "is_qualified": true
      },
      {
        "planet_user_id": 78901234567890,
        "planet_nickname": "李四",
        "planet_alias": "",
        "rankings": 50,
        "checkined_days": 5,
        "required_days": 7,
        "is_qualified": false
      }
    ],
    "statistics": {
      "total_count": 99,
      "qualified_count": 85
    }
  }
}
```

---

### 4.3 前端页面功能

#### 4.3.1 训练营列表页面
- 下拉选择状态（进行中/已结束/已关闭）
- 点击"刷新"按钮调用 API 获取列表
- 表格展示：训练营名称、状态、打卡天数、参与人数
- 操作按钮：[生成退款名单]

#### 4.3.2 退款名单页面
- 显示训练营基本信息
- 输入框：完成几天算合格（数字，不超过总天数）
- 点击"开始计算"调用 API
- **数据总览区域**：
  - 统计卡片：总人数、合格人数、合格率、不合格人数
  - 合格人员名单（文本展示，昵称用顿号分隔）
  - [一键复制] 按钮（复制合格人员昵称到剪贴板）
- **详细名单表格**：
  - 表格展示：序号、星球昵称、星球ID、打卡天数、是否合格
  - 支持筛选：全部/合格/不合格
- **导出功能**：
  - [下载图片] 按钮：使用 html2canvas 生成整个页面的PNG图片
  - [导出Excel] 按钮：导出详细名单为Excel文件


---

## 五、配置说明

### 5.1 后端配置（环境变量）

```bash
# 知识星球配置
ZSXQ_GROUP_ID=15555411412112                    # 星球圈子ID
ZSXQ_COOKIE="x-timestamp=...; authorization=..."  # 从浏览器抓包获取

# 服务配置
PORT=3013                                        # API 服务端口
NODE_ENV=production                              # 生产环境
```

### 5.2 Cookie 获取方法

**步骤**：
1. 打开知识星球网页版，登录账号
2. 打开浏览器开发者工具（F12）→ Network
3. 刷新页面，找到任意 `api.zsxq.com` 请求
4. 复制 Request Headers 中的以下字段：
   - `x-timestamp`
   - `authorization`
   - `x-signature`
   - `x-request-id`

**配置示例**（后端代码中使用）：
```javascript
const headers = {
  'Host': 'api.zsxq.com',
  'content-type': 'application/json; charset=utf-8',
  'x-timestamp': process.env.ZSXQ_TIMESTAMP,
  'authorization': process.env.ZSXQ_AUTHORIZATION,
  'x-signature': process.env.ZSXQ_SIGNATURE,
  'x-request-id': generateRequestId(),
  'user-agent': 'xiaomiquan/5.28.1'
}
```

---

## 六、知识星球 API 参考

### 6.1 获取训练营列表

**原始接口**（知识星球）：
```
GET https://api.zsxq.com/v2/groups/15555411412112/checkins?scope={scope}&count=100
```

**参数说明**：
- `scope`: `ongoing`（进行中）/ `over`（已结束）/ `closed`（已关闭）
- `count`: 返回数量（最大100）

**返回数据**（参考 `prompts/v0/interface_decoded.md`）：
```json
{
  "succeeded": true,
  "resp_data": {
    "checkins": [
      {
        "checkin_id": 2424424541,
        "group": { "group_id": 15555411412112, "name": "AI私域赚钱" },
        "owner": { "user_id": 582884445452854, "name": "深圳大冲" },
        "title": "2510 AI小绿书爆文",
        "text": "打卡规则...",
        "checkin_days": 9,
        "status": "ongoing",
        "joined_count": 115,
        "expiration_time": "2025-11-03T23:59:59.999+0800"
      }
    ]
  }
}
```

### 6.2 获取打卡排行榜

**原始接口**（知识星球）：
```
GET https://api.zsxq.com/v2/groups/15555411412112/checkins/{checkin_id}/ranking_list?type=accumulated&index=0
```

**参数说明**：
- `type`: `accumulated`（累计打卡榜）
- `index`: 分页索引（0开始）

**返回数据**：
```json
{
  "succeeded": true,
  "resp_data": {
    "ranking_list": [
      {
        "user": {
          "user_id": 88455815452182,
          "name": "球球的副业探索路",
          "alias": "",
          "avatar_url": "https://..."
        },
        "rankings": 1,
        "checkined_days": 10
      }
    ],
    "user_specific": {
      "user": { "user_id": 184444848828412, "name": "易安" },
      "rankings": 0,
      "checkined_days": 0
    }
  }
}
```

---

## 七、界面原型（简化版）

### 7.1 训练营列表页面

```
┌─────────────────────────────────────────────────────────┐
│  训练营退款系统 - v0                                      │
├─────────────────────────────────────────────────────────┤
│  状态筛选: [已结束▼]  [刷新列表]                          │
│                                                          │
│  训练营名称            状态      打卡天数   参与人数      操作 │
│  ─────────────────────────────────────────────────────  │
│  2510 AI小绿书爆文    进行中      9天       115人     [查看] │
│  2510 AI写作          已结束      9天        99人     [生成名单] │
│  2510 AI编程          已结束      9天        75人     [生成名单] │
└─────────────────────────────────────────────────────────┘
```

### 7.2 退款名单生成页面

```
┌─────────────────────────────────────────────────────────┐
│  生成退款名单 - 2510 AI写作                               │
├─────────────────────────────────────────────────────────┤
│  训练营信息：                                             │
│  - 打卡总天数：9天                                        │
│  - 参与人数：99人                                         │
│                                                          │
│  完成标准：[7▼] 天完成打卡算合格  [开始计算]              │
│                                                          │
│  ─────────────────────────────────────────────────────  │
│  📊 数据总览                                              │
│  ┌───────────────────────────────────────────────────┐  │
│  │ 总人数: 99人  |  合格: 85人 (85.9%)  |  不合格: 14人│  │
│  │ 完成打卡人员名单:                                   │  │
│  │ 球球的副业探索路、Aaron、向阳、Catherine、两个俩、  │  │
│  │ 木鱼非零、殷紫东、壮壮0928... (共85人)  [一键复制]  │  │
│  └───────────────────────────────────────────────────┘  │
│                                                          │
│  📋 详细名单                                              │
│  序号  星球昵称          星球ID         打卡天数  是否合格   │
│  ─────────────────────────────────────────────────────  │
│  1    球球的副业探索路   88455815...     10天    ✅ 合格   │
│  2    Aaron            11851222...     10天    ✅ 合格   │
│  3    向阳              21585481...     10天    ✅ 合格   │
│  4    Catherine        54884111...      9天    ✅ 合格   │
│  ...                                                     │
│  86   李四              78901234...      5天    ❌ 不合格  │
│                                                          │
│  [下载图片]  [导出Excel]  [关闭]                          │
└─────────────────────────────────────────────────────────┘
```

**功能说明**：

1. **总览栏位**：
   - 显示统计信息（总人数、合格人数、合格率、不合格人数）
   - 显示合格人员名单（昵称用顿号分隔）
   - [一键复制] 按钮：复制所有合格人员昵称到剪贴板

2. **导出功能**：
   - **[下载图片]**：将整个页面（包括总览和详细名单）生成为PNG图片
   - **[导出Excel]**：导出详细名单为Excel文件（包含统计信息）

3. **图片生成规格**：
   - 使用 `html2canvas` 库将页面转为图片
   - 图片尺寸：自适应内容高度，宽度1200px
   - 文件命名：`退款名单-{训练营名称}-{日期}.png`

---

## 八、技术实现

### 8.1 技术栈选择

**后端**（2选1）：
- **方案1（推荐）**：Node.js + Express
  - 轻量级、部署简单
  - 适合无数据库的 API 代理服务

- **方案2**：Python + FastAPI
  - 异步高性能
  - 适合数据处理

**前端**：
- Vue 3 + Vite
- Element Plus（UI组件库）
- XLSX.js（Excel导出）
- html2canvas（页面截图生成图片）

**部署**：
- 域名：`zsxq.dc401.com`
- 服务器：腾讯云轻量应用服务器
- 反向代理：Nginx

### 8.2 目录结构（Node.js 示例）

```
zsxq-api/
├── src/
│   ├── index.js              # 入口文件
│   ├── routes/
│   │   └── camps.js          # 路由：训练营相关接口
│   ├── services/
│   │   └── zsxq.service.js   # 服务：调用知识星球API
│   └── utils/
│       ├── request.js        # HTTP请求封装
│       └── response.js       # 统一响应格式
├── .env                      # 环境变量配置
├── package.json
└── README.md
```

### 8.3 核心代码示例

#### 8.3.1 后端服务层（zsxq.service.js）

```javascript
const axios = require('axios');

class ZsxqService {
  constructor() {
    this.baseURL = 'https://api.zsxq.com/v2';
    this.groupId = process.env.ZSXQ_GROUP_ID;
    this.headers = {
      'x-timestamp': process.env.ZSXQ_TIMESTAMP,
      'authorization': process.env.ZSXQ_AUTHORIZATION,
      // ... 其他headers
    };
  }

  // 获取训练营列表
  async getCamps(scope = 'over', count = 100) {
    const url = `${this.baseURL}/groups/${this.groupId}/checkins`;
    const response = await axios.get(url, {
      params: { scope, count },
      headers: this.headers
    });
    return response.data.resp_data.checkins;
  }

  // 获取打卡排行榜
  async getRankingList(checkinId) {
    const url = `${this.baseURL}/groups/${this.groupId}/checkins/${checkinId}/ranking_list`;
    const response = await axios.get(url, {
      params: { type: 'accumulated', index: 0 },
      headers: this.headers
    });
    return response.data.resp_data.ranking_list;
  }
}

module.exports = new ZsxqService();
```

#### 8.3.2 前端功能代码（RefundList.vue）

**一键复制功能**：
```javascript
// 复制合格人员名单
const copyQualifiedNames = () => {
  const qualifiedUsers = refundList.value.filter(item => item.is_qualified);
  const names = qualifiedUsers.map(item => item.planet_nickname).join('、');

  navigator.clipboard.writeText(names).then(() => {
    ElMessage.success('已复制到剪贴板');
  }).catch(() => {
    ElMessage.error('复制失败，请手动复制');
  });
};
```

**下载图片功能**：
```javascript
import html2canvas from 'html2canvas';

// 生成图片并下载
const downloadImage = async () => {
  const element = document.querySelector('.refund-list-container');
  const canvas = await html2canvas(element, {
    backgroundColor: '#ffffff',
    scale: 2, // 提高清晰度
    useCORS: true,
    width: 1200
  });

  // 转换为 Blob 并下载
  canvas.toBlob((blob) => {
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    const date = new Date().toISOString().split('T')[0];
    link.download = `退款名单-${campInfo.value.title}-${date}.png`;
    link.href = url;
    link.click();
    URL.revokeObjectURL(url);
  });
};
```

**导出 Excel 功能**：
```javascript
import * as XLSX from 'xlsx';

// 导出 Excel
const exportExcel = () => {
  // 构建数据（包含统计信息）
  const data = [
    ['训练营名称', campInfo.value.title],
    ['打卡总天数', campInfo.value.total_days],
    ['完成要求', `${requiredDays.value}天`],
    ['总人数', statistics.value.total_count],
    ['合格人数', statistics.value.qualified_count],
    ['合格率', `${statistics.value.qualified_rate}%`],
    [],
    ['序号', '星球昵称', '星球ID', '打卡天数', '是否合格']
  ];

  refundList.value.forEach((item, index) => {
    data.push([
      index + 1,
      item.planet_nickname,
      item.planet_user_id,
      item.checkined_days,
      item.is_qualified ? '合格' : '不合格'
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '退款名单');

  const date = new Date().toISOString().split('T')[0];
  XLSX.writeFile(wb, `退款名单-${campInfo.value.title}-${date}.xlsx`);
};
```

---

## 九、验收标准

✅ **v0 版本完成标准**：

### 9.1 后端接口
1. ✅ 后端API部署到 `zsxq.dc401.com`，可正常访问
2. ✅ 调用 `GET /api/camps?scope=over` 能返回已结束的训练营列表
3. ✅ 调用 `POST /api/camps/{checkin_id}/refund-list` 能返回完整的打卡排行榜数据
4. ✅ API调用失败时有明确的错误提示

### 9.2 前端页面
5. ✅ 训练营列表页面能展示所有训练营（名称、状态、天数、人数）
6. ✅ 能设置"完成几天算合格"并计算合格名单
7. ✅ 数据总览区域能正确显示统计信息和合格人员名单
8. ✅ 点击"一键复制"能复制合格人员昵称到剪贴板，并提示成功

### 9.3 导出功能
9. ✅ 点击"下载图片"能生成PNG图片（包含总览和详细名单）
10. ✅ 点击"导出Excel"能生成Excel文件（包含统计信息和详细名单）
11. ✅ 图片和Excel文件命名格式正确：`退款名单-{训练营名称}-{日期}.png/xlsx`

### 9.4 数据准确性
12. ✅ 合格人数计算准确（打卡天数 >= 要求天数）
13. ✅ 合格率计算准确（合格人数 / 总人数 * 100%）
14. ✅ 合格人员名单拼接正确（昵称用顿号分隔）

---

## 十、部署说明

### 10.1 服务器环境准备

```bash
# 1. 安装 Node.js (v18+)
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 2. 克隆项目代码
git clone <项目仓库地址>
cd zsxq-api

# 3. 安装依赖
npm install

# 4. 配置环境变量
cp .env.example .env
vim .env  # 填入知识星球 Cookie 等配置
```

### 10.2 启动服务

```bash
# 开发模式
npm run dev

# 生产模式（使用 PM2）
npm install -g pm2
pm2 start src/index.js --name zsxq-api
pm2 save
pm2 startup  # 开机自启
```

### 10.3 Nginx 配置

```nginx
server {
    listen 80;
    server_name zsxq.dc401.com;

    location /api/ {
        proxy_pass http://localhost:3000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location / {
        root /var/www/zsxq-web;
        try_files $uri $uri/ /index.html;
    }
}
```

---

## 附录：关键问题和解决方案

### Q1：为什么不用数据库？
**A**：
- v0 版本仅提供实时查询，无需存储历史数据
- 简化架构，快速上线
- v1 版本如需自动退款功能，再引入数据库

### Q2：知识星球 Cookie 会过期吗？
**A**：
- 会过期，通常有效期 7-30 天
- 过期后需要重新抓包获取
- 可以在后端增加"Cookie失效检测"并通知管理员

### Q3：如何处理大量数据（1000+人）？
**A**：
- 知识星球 API 支持分页（`index` 参数）
- 可以循环调用多次，合并结果
- v0 版本暂不处理，v1 版本优化

### Q4：前端如何导出 Excel 和图片？
**A**：
- **Excel导出**：使用 `xlsx.js` 库，前端直接将表格数据转换为 Excel 文件
- **图片生成**：使用 `html2canvas` 库，将页面元素渲染为Canvas，再转为PNG图片
- 两种方式都在前端实现，无需后端支持

### Q5：部署域名 `zsxq.dc401.com` 需要 HTTPS 吗？
**A**：
- 推荐配置 HTTPS（使用 Let's Encrypt 免费证书）
- 避免 Cookie 泄露风险
- 使用 Certbot 一键配置

---

**文档结束**
