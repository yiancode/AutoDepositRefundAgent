# 前端路由设计

## 一、H5 会员端路由配置

### 1.1 路由表

| 路径 | 组件 | 名称 | 说明 | 权限 |
|------|------|------|------|------|
| `/` | Home | 首页 | 训练营列表入口 | 公开 |
| `/camps` | CampList | 训练营列表 | 查看所有可报名的训练营 | 公开 |
| `/camps/:id` | CampDetail | 训练营详情 | 查看训练营详细信息 | 公开 |
| `/enroll/:campId` | Enroll | 报名页面 | 填写报名信息并支付 | 需登录 |
| `/payment/:orderId` | Payment | 支付页面 | 完成微信支付 | 需登录 |
| `/payment/:orderId/result` | PaymentResult | 支付结果 | 显示支付成功/失败 | 需登录 |
| `/bind-planet` | BindPlanet | 绑定星球 | 绑定知识星球账号 | 需登录 |
| `/progress` | Progress | 打卡进度 | 查看个人打卡进度 | 需登录 |
| `/profile` | Profile | 个人中心 | 查看个人信息和订单 | 需登录 |
| `/refunds` | RefundList | 退款记录 | 查看退款历史 | 需登录 |
| `/auth/callback` | AuthCallback | OAuth回调 | 处理微信OAuth回调 | 公开 |

### 1.2 路由配置示例

```javascript
// router/index.js
import { createRouter, createWebHistory } from 'vue-router'
import { useUserStore } from '@/stores/user'

const routes = [
  {
    path: '/',
    name: 'Home',
    component: () => import('@/views/Home.vue'),
    meta: { title: '首页' }
  },
  {
    path: '/camps',
    name: 'CampList',
    component: () => import('@/views/CampList.vue'),
    meta: { title: '训练营列表' }
  },
  {
    path: '/camps/:id',
    name: 'CampDetail',
    component: () => import('@/views/CampDetail.vue'),
    meta: { title: '训练营详情' }
  },
  {
    path: '/enroll/:campId',
    name: 'Enroll',
    component: () => import('@/views/Enroll.vue'),
    meta: { requiresAuth: true, title: '报名' }
  },
  {
    path: '/payment/:orderId',
    name: 'Payment',
    component: () => import('@/views/Payment.vue'),
    meta: { requiresAuth: true, title: '支付' }
  },
  {
    path: '/bind-planet',
    name: 'BindPlanet',
    component: () => import('@/views/BindPlanet.vue'),
    meta: { requiresAuth: true, title: '绑定星球账号' }
  },
  {
    path: '/progress',
    name: 'Progress',
    component: () => import('@/views/Progress.vue'),
    meta: { requiresAuth: true, title: '我的进度' }
  },
  {
    path: '/profile',
    name: 'Profile',
    component: () => import('@/views/Profile.vue'),
    meta: { requiresAuth: true, title: '个人中心' }
  },
  {
    path: '/refunds',
    name: 'RefundList',
    component: () => import('@/views/RefundList.vue'),
    meta: { requiresAuth: true, title: '退款记录' }
  },
  {
    path: '/auth/callback',
    name: 'AuthCallback',
    component: () => import('@/views/AuthCallback.vue'),
    meta: { title: '登录中...' }
  }
]

const router = createRouter({
  history: createWebHistory(),
  routes
})

export default router
```

### 1.3 路由守卫

```javascript
// router/guards.js
import { useUserStore } from '@/stores/user'
import { showToast } from 'vant'

export function setupRouterGuards(router) {
  // 全局前置守卫
  router.beforeEach(async (to, from, next) => {
    const userStore = useUserStore()

    // 设置页面标题
    document.title = to.meta.title || '训练营押金退款系统'

    // 检查是否需要登录
    if (to.meta.requiresAuth) {
      if (!userStore.isLoggedIn) {
        // 未登录，重定向到登录页
        showToast('请先登录')

        // 保存目标路由，登录后跳转
        const returnUrl = to.fullPath

        // 触发OAuth登录
        const authUrl = await userStore.getAuthUrl(returnUrl)
        window.location.href = authUrl
        return
      }

      // Token过期检查
      if (userStore.isTokenExpired()) {
        showToast('登录已过期，请重新登录')
        await userStore.refreshToken()

        if (!userStore.isLoggedIn) {
          const returnUrl = to.fullPath
          const authUrl = await userStore.getAuthUrl(returnUrl)
          window.location.href = authUrl
          return
        }
      }
    }

    next()
  })

  // 全局后置守卫
  router.afterEach((to, from) => {
    // 页面切换后滚动到顶部
    window.scrollTo(0, 0)
  })
}
```

---

## 二、管理后台路由配置

### 2.1 路由表

| 路径 | 组件 | 名称 | 说明 | 权限 |
|------|------|------|------|------|
| `/login` | Login | 登录页 | 管理员登录 | 公开 |
| `/` | Layout | 布局容器 | 主框架 | 需登录 |
| `/dashboard` | Dashboard | 仪表盘 | 数据概览 | admin, manager |
| `/camps` | CampManage | 训练营管理 | 训练营列表 | admin, manager |
| `/camps/create` | CampCreate | 创建训练营 | 新建训练营 | admin |
| `/camps/:id/edit` | CampEdit | 编辑训练营 | 修改训练营 | admin |
| `/members` | MemberManage | 会员管理 | 会员列表 | admin, manager |
| `/members/:id` | MemberDetail | 会员详情 | 查看会员信息 | admin, manager |
| `/refunds` | RefundManage | 退款管理 | 退款审核 | admin, manager |
| `/refunds/:id/approve` | RefundApprove | 退款审核 | 审批退款 | admin |
| `/reports` | Reports | 统计报表 | 数据分析 | admin, manager |
| `/settings` | Settings | 系统设置 | 配置管理 | admin |
| `/logs` | Logs | 操作日志 | 审计日志 | admin |

### 2.2 路由配置示例

```javascript
// router/index.js (管理后台)
import { createRouter, createWebHistory } from 'vue-router'
import { useAdminStore } from '@/stores/admin'

const routes = [
  {
    path: '/login',
    name: 'Login',
    component: () => import('@/views/Login.vue'),
    meta: { title: '登录', public: true }
  },
  {
    path: '/',
    component: () => import('@/layouts/MainLayout.vue'),
    meta: { requiresAuth: true },
    children: [
      {
        path: '',
        redirect: '/dashboard'
      },
      {
        path: 'dashboard',
        name: 'Dashboard',
        component: () => import('@/views/Dashboard.vue'),
        meta: { title: '仪表盘', roles: ['admin', 'manager'] }
      },
      {
        path: 'camps',
        name: 'CampManage',
        component: () => import('@/views/camps/CampList.vue'),
        meta: { title: '训练营管理', roles: ['admin', 'manager'] }
      },
      {
        path: 'camps/create',
        name: 'CampCreate',
        component: () => import('@/views/camps/CampCreate.vue'),
        meta: { title: '创建训练营', roles: ['admin'] }
      },
      {
        path: 'camps/:id/edit',
        name: 'CampEdit',
        component: () => import('@/views/camps/CampEdit.vue'),
        meta: { title: '编辑训练营', roles: ['admin'] }
      },
      {
        path: 'members',
        name: 'MemberManage',
        component: () => import('@/views/members/MemberList.vue'),
        meta: { title: '会员管理', roles: ['admin', 'manager'] }
      },
      {
        path: 'refunds',
        name: 'RefundManage',
        component: () => import('@/views/refunds/RefundList.vue'),
        meta: { title: '退款管理', roles: ['admin', 'manager'] }
      },
      {
        path: 'reports',
        name: 'Reports',
        component: () => import('@/views/Reports.vue'),
        meta: { title: '统计报表', roles: ['admin', 'manager'] }
      },
      {
        path: 'settings',
        name: 'Settings',
        component: () => import('@/views/Settings.vue'),
        meta: { title: '系统设置', roles: ['admin'] }
      },
      {
        path: 'logs',
        name: 'Logs',
        component: () => import('@/views/Logs.vue'),
        meta: { title: '操作日志', roles: ['admin'] }
      }
    ]
  }
]

const router = createRouter({
  history: createWebHistory('/admin'),
  routes
})

export default router
```

### 2.3 权限守卫

```javascript
// router/guards.js (管理后台)
import { useAdminStore } from '@/stores/admin'
import { ElMessage } from 'element-plus'

export function setupRouterGuards(router) {
  router.beforeEach(async (to, from, next) => {
    const adminStore = useAdminStore()

    document.title = to.meta.title ? `${to.meta.title} - 训练营管理后台` : '训练营管理后台'

    // 公开页面直接放行
    if (to.meta.public) {
      next()
      return
    }

    // 检查登录状态
    if (!adminStore.isLoggedIn) {
      ElMessage.warning('请先登录')
      next({ name: 'Login', query: { redirect: to.fullPath } })
      return
    }

    // Token过期检查
    if (adminStore.isTokenExpired()) {
      ElMessage.error('登录已过期，请重新登录')
      await adminStore.logout()
      next({ name: 'Login', query: { redirect: to.fullPath } })
      return
    }

    // 角色权限检查
    if (to.meta.roles && to.meta.roles.length > 0) {
      if (!to.meta.roles.includes(adminStore.userInfo.role)) {
        ElMessage.error('您没有权限访问此页面')
        next({ name: 'Dashboard' })
        return
      }
    }

    next()
  })
}
```

---

## 三、路由守卫设计

### 3.1 JWT Token 验证逻辑

```javascript
// utils/auth.js
import { jwtDecode } from 'jwt-decode'

export function isTokenExpired(token) {
  if (!token) return true

  try {
    const decoded = jwtDecode(token)
    const currentTime = Date.now() / 1000

    // 提前5分钟判定为过期，留出刷新时间
    return decoded.exp < (currentTime + 300)
  } catch (error) {
    return true
  }
}

export function getTokenInfo(token) {
  try {
    return jwtDecode(token)
  } catch (error) {
    return null
  }
}
```

### 3.2 重定向规则

| 场景 | 处理逻辑 |
|------|----------|
| 未登录访问需授权页面 | 跳转到登录页，保存 returnUrl |
| Token过期 | 尝试刷新Token，失败则重新登录 |
| 权限不足 | 显示错误提示，跳转到首页 |
| OAuth回调 | 提取Token，跳转到 returnUrl 或首页 |

### 3.3 Token过期处理流程

```javascript
// stores/user.js
export const useUserStore = defineStore('user', {
  state: () => ({
    token: localStorage.getItem('token'),
    userInfo: null
  }),

  getters: {
    isLoggedIn: (state) => !!state.token,
    isTokenExpired: (state) => isTokenExpired(state.token)
  },

  actions: {
    async refreshToken() {
      try {
        const { data } = await api.post('/auth/refresh', {
          token: this.token
        })

        this.token = data.token
        localStorage.setItem('token', data.token)
        return true
      } catch (error) {
        this.logout()
        return false
      }
    },

    logout() {
      this.token = null
      this.userInfo = null
      localStorage.removeItem('token')
    }
  }
})
```

---

## 四、路由拦截器配置

### 4.1 Axios请求拦截器

```javascript
// utils/request.js
import axios from 'axios'
import { useUserStore } from '@/stores/user'
import { showToast } from 'vant'

const request = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 10000
})

// 请求拦截器
request.interceptors.request.use(
  async (config) => {
    const userStore = useUserStore()

    if (userStore.isLoggedIn) {
      // Token即将过期，先刷新
      if (userStore.isTokenExpired()) {
        await userStore.refreshToken()
      }

      config.headers.Authorization = `Bearer ${userStore.token}`
    }

    return config
  },
  (error) => {
    return Promise.reject(error)
  }
)

// 响应拦截器
request.interceptors.response.use(
  (response) => {
    return response.data
  },
  async (error) => {
    if (error.response) {
      switch (error.response.status) {
        case 401:
          showToast('登录已过期，请重新登录')
          const userStore = useUserStore()
          await userStore.logout()

          // 跳转登录
          const returnUrl = window.location.pathname
          const authUrl = await userStore.getAuthUrl(returnUrl)
          window.location.href = authUrl
          break

        case 403:
          showToast('您没有权限执行此操作')
          break

        case 404:
          showToast('请求的资源不存在')
          break

        case 500:
          showToast('服务器错误，请稍后重试')
          break

        default:
          showToast(error.response.data.message || '请求失败')
      }
    } else {
      showToast('网络错误，请检查您的网络连接')
    }

    return Promise.reject(error)
  }
)

export default request
```

---

## 五、最佳实践

### 5.1 路由懒加载

所有路由组件使用动态导入（`() => import()`），减少初始加载体积。

### 5.2 路由元信息

统一使用 `meta` 定义路由元信息：
- `title`: 页面标题
- `requiresAuth`: 是否需要登录
- `roles`: 允许访问的角色列表
- `public`: 是否公开页面

### 5.3 路由命名规范

- 使用 PascalCase 命名路由 name
- 路径使用 kebab-case
- 嵌套路由避免以 `/` 开头

### 5.4 404处理

```javascript
{
  path: '/:pathMatch(.*)*',
  name: 'NotFound',
  component: () => import('@/views/NotFound.vue'),
  meta: { title: '页面未找到' }
}
```

---

## 六、与技术方案的关联

本文档补充了 `技术方案.md` 第 5.5 章节（前端设计）的路由部分细节。

详见：`docs/v1/技术方案.md` §5.5
