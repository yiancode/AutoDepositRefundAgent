# 架构设计图

本文档使用 C4 模型展示知识星球训练营自动押金退款系统的架构设计。

---

## 一、C4 模型概述

C4 模型是一种分层的软件架构可视化方法，包含四个层次：

| 层次 | 英文 | 描述 | 受众 |
|------|------|------|------|
| Level 1 | System Context | 系统上下文 | 所有人 |
| Level 2 | Container | 容器图 | 技术人员 |
| Level 3 | Component | 组件图 | 开发人员 |
| Level 4 | Code | 代码图 | 开发人员 |

---

## 二、Level 1: 系统上下文图

### 2.1 系统上下文

```mermaid
C4Context
    title 系统上下文图 - 知识星球训练营押金退款系统

    Person(member, "会员", "知识星球会员，参与训练营打卡")
    Person(admin, "管理员", "运营人员，管理训练营和审核退款")
    Person(coach, "教练", "项目教练，查看负责项目数据")

    System(campSystem, "训练营押金退款系统", "自动化处理报名支付、打卡同步、身份匹配、退款审核")

    System_Ext(zsxq, "知识星球", "提供打卡数据API")
    System_Ext(wechatPay, "微信支付", "处理收款和退款")
    System_Ext(wechatWork, "企业微信", "消息通知推送")

    Rel(member, campSystem, "报名支付、查看进度", "H5/HTTPS")
    Rel(admin, campSystem, "管理训练营、审核退款", "Web/HTTPS")
    Rel(coach, campSystem, "查看项目数据", "Web/HTTPS")

    Rel(campSystem, zsxq, "同步打卡数据", "REST API")
    Rel(campSystem, wechatPay, "创建支付、执行退款", "REST API")
    Rel(campSystem, wechatWork, "发送通知消息", "REST API")

    UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="1")
```

### 2.2 上下文说明

| 元素 | 类型 | 描述 |
|------|------|:-----|
| 会员 | 用户 | 知识星球会员，通过 H5 页面报名参与训练营 |
| 管理员 | 用户 | 运营人员，通过 Web 后台管理训练营 |
| 教练 | 用户 | 项目教练，查看负责项目的打卡数据 |
| 训练营系统 | 核心系统 | 本系统，处理完整的训练营生命周期 |
| 知识星球 | 外部系统 | 提供会员打卡数据的来源 |
| 微信支付 | 外部系统 | 处理押金收取和退款 |
| 企业微信 | 外部系统 | 发送退款通知等消息 |

---

## 三、Level 2: 容器图

### 3.1 容器架构

> **部署形态说明**：v1 采用单节点部署，所有服务运行在一台服务器上。消息队列（RabbitMQ）为**可选扩展**，初期使用 Spring 内置的异步任务替代，后续根据负载情况启用。

```mermaid
C4Container
    title 容器图 - 系统内部结构（单节点部署）

    Person(member, "会员")
    Person(admin, "管理员")

    System_Boundary(system, "训练营押金退款系统") {
        Container(h5Web, "H5 会员端", "Vue 3, Vant UI", "报名支付、进度查询、退款查看")
        Container(adminWeb, "Web 管理后台", "Vue 3, Element Plus", "训练营管理、退款审核、统计报表")

        Container(apiServer, "API 服务", "Spring Boot 3.2, Java 17", "核心业务逻辑、RESTful API、SSL 终止、限流")

        Container(scheduler, "定时任务", "Spring Scheduler", "打卡同步、退款执行、数据清理")

        ContainerDb(postgres, "PostgreSQL", "PostgreSQL 15", "业务数据存储")
        ContainerDb(redis, "Redis", "Redis 7", "缓存、会话、限流计数")
    }

    System_Ext(zsxq, "知识星球 API")
    System_Ext(wechatPay, "微信支付")
    System_Ext(wechatWork, "企业微信通知")

    Rel(member, h5Web, "使用", "HTTPS")
    Rel(admin, adminWeb, "使用", "HTTPS")

    Rel(h5Web, apiServer, "调用", "HTTPS/REST")
    Rel(adminWeb, apiServer, "调用", "HTTPS/REST")

    Rel(apiServer, postgres, "读写", "JDBC")
    Rel(apiServer, redis, "缓存", "Redis Protocol")

    Rel(scheduler, apiServer, "调用", "内部方法")

    Rel(apiServer, zsxq, "同步打卡", "HTTPS/REST")
    Rel(apiServer, wechatPay, "支付/退款", "HTTPS/REST")
    Rel(apiServer, wechatWork, "通知", "HTTPS/REST")
```

### 3.2 容器说明

| 容器 | 技术 | 职责 | 部署方式 |
|------|------|------|----------|
| H5 会员端 | Vue 3 + Vant | 会员报名、支付、进度查询 | 与 API 服务同机 |
| Web 管理后台 | Vue 3 + Element Plus | 训练营管理、退款审核 | 与 API 服务同机 |
| API 服务 | Spring Boot 3.2 | 核心业务逻辑、SSL 终止 | 云主机单节点 |
| 定时任务 | Spring Scheduler | 打卡同步、定时退款 | 与 API 服务同进程 |
| PostgreSQL | PostgreSQL 15 | 业务数据持久化 | 云数据库 |
| Redis | Redis 7 | 缓存、会话、限流 | 云 Redis |

**扩展路径**（后续容量提升时启用）：

| 阶段 | 触发条件 | 扩展组件 |
|------|----------|----------|
| 阶段 1 | 当前 | 单节点 API + PostgreSQL + Redis |
| 阶段 2 | 并发 > 100 QPS | 添加 Nginx 反向代理 |
| 阶段 3 | 异步任务积压 | 引入 RabbitMQ 消息队列 |
| 阶段 4 | 需要高可用 | 双节点 API + PostgreSQL 主从 |

---

## 四、Level 3: 组件图

### 4.1 API 服务组件

```mermaid
C4Component
    title API 服务组件图

    Container_Boundary(api, "API 服务") {
        Component(campCtrl, "CampController", "Controller", "训练营 CRUD 接口")
        Component(payCtrl, "PaymentController", "Controller", "支付相关接口")
        Component(bindCtrl, "BindController", "Controller", "支付绑定接口")
        Component(authCtrl, "AuthController", "Controller", "OAuth认证接口")
        Component(refundCtrl, "RefundController", "Controller", "退款相关接口")
        Component(statsCtrl, "StatsController", "Controller", "统计报表接口")
        Component(webhookCtrl, "WebhookController", "Controller", "回调处理接口")

        Component(campSvc, "CampService", "Service", "训练营业务逻辑")
        Component(paySvc, "PaymentService", "Service", "支付业务逻辑")
        Component(bindSvc, "PaymentBindService", "Service", "支付绑定服务")
        Component(authSvc, "FastAuthService", "Service", "OAuth认证服务")
        Component(checkinSvc, "CheckinService", "Service", "打卡业务逻辑")
        Component(refundSvc, "RefundService", "Service", "退款业务逻辑")
        Component(statsSvc, "StatsService", "Service", "统计业务逻辑")

        Component(campMapper, "CampMapper", "DAO", "训练营数据访问")
        Component(memberMapper, "MemberMapper", "DAO", "会员数据访问")
        Component(paymentMapper, "PaymentMapper", "DAO", "支付记录数据访问（含绑定信息）")
        Component(bindLogMapper, "PaymentBindStatusLogMapper", "DAO", "绑定状态日志访问")
        Component(authSessionMapper, "AuthSessionMapper", "DAO", "认证会话数据访问")
        Component(refundMapper, "RefundMapper", "DAO", "退款数据访问")

        Component(zsxqMgr, "PlanetApiManager", "Manager", "知识星球 API 封装")
        Component(wxPayMgr, "WechatPayManager", "Manager", "微信支付 API 封装")
        Component(wxMsgMgr, "WechatMsgManager", "Manager", "企业微信消息封装")
        Component(wxOAuthMgr, "WechatOAuthManager", "Manager", "微信公众号 OAuth 封装")
    }

    Rel(campCtrl, campSvc, "调用")
    Rel(payCtrl, paySvc, "调用")
    Rel(bindCtrl, bindSvc, "调用")
    Rel(authCtrl, authSvc, "调用")
    Rel(refundCtrl, refundSvc, "调用")
    Rel(statsCtrl, statsSvc, "调用")
    Rel(webhookCtrl, paySvc, "调用")
    Rel(webhookCtrl, bindSvc, "调用")

    Rel(campSvc, campMapper, "调用")
    Rel(paySvc, paymentMapper, "调用")
    Rel(paySvc, wxPayMgr, "调用")
    Rel(bindSvc, paymentMapper, "调用")
    Rel(bindSvc, bindLogMapper, "调用")
    Rel(authSvc, authSessionMapper, "调用")
    Rel(authSvc, wxOAuthMgr, "调用")
    Rel(authSvc, memberMapper, "调用")
    Rel(checkinSvc, zsxqMgr, "调用")
    Rel(checkinSvc, memberMapper, "调用")
    Rel(refundSvc, refundMapper, "调用")
    Rel(refundSvc, wxPayMgr, "调用")
    Rel(refundSvc, wxMsgMgr, "调用")
```

### 4.2 组件说明

#### Controller 层

| 组件 | 职责 | 主要接口 |
|------|------|----------|
| CampController | 训练营管理 | CRUD、发布、归档 |
| PaymentController | 支付处理 | 创建订单、支付状态查询 |
| BindController | 支付绑定 | 用户填写绑定、查询绑定状态 |
| AuthController | OAuth认证 | 授权地址、回调处理、星球绑定 |
| RefundController | 退款处理 | 生成名单、审核、执行 |
| StatsController | 统计报表 | 各维度数据统计 |
| WebhookController | 回调处理 | 支付回调、退款回调 |

#### Service 层

| 组件 | 职责 | 依赖 |
|------|------|------|
| CampService | 训练营生命周期管理 | CampMapper |
| PaymentService | 支付订单处理 | PaymentMapper, WechatPayManager |
| PaymentBindService | 支付绑定服务 | PaymentMapper, PaymentBindStatusLogMapper |
| FastAuthService | OAuth认证服务 | AuthSessionMapper, WechatOAuthManager, MemberMapper |
| CheckinService | 打卡数据同步 | PlanetApiManager, MemberMapper |
| RefundService | 退款流程处理 | RefundMapper, PaymentMapper, WechatPayManager |
| StatsService | 统计计算 | 多个 Mapper |

#### Manager 层（外部 API 封装）

| 组件 | 职责 | 外部系统 |
|------|------|----------|
| PlanetApiManager | 知识星球 API 调用 | 知识星球 |
| WechatPayManager | 微信支付 API 调用 | 微信支付 |
| WechatMsgManager | 企业微信消息发送 | 企业微信 |
| WechatOAuthManager | 微信公众号 OAuth 封装 | 微信公众号 |

### 4.3 核心模块交互

```mermaid
flowchart TB
    subgraph 接入层
        H5[H5 会员端]
        Admin[管理后台]
        Webhook[外部回调]
    end

    subgraph 控制层
        Controllers[Controllers]
        AuthCtrl[AuthController]
        BindCtrl[BindController]
    end

    subgraph 业务层
        CampSvc[CampService]
        PaySvc[PaymentService]
        BindSvc[PaymentBindService]
        AuthSvc[FastAuthService]
        CheckinSvc[CheckinService]
        RefundSvc[RefundService]
    end

    subgraph 集成层
        ZsxqMgr[PlanetApiManager]
        WxPayMgr[WechatPayManager]
        WxMsgMgr[WechatMsgManager]
        WxOAuthMgr[WechatOAuthManager]
    end

    subgraph 数据层
        Mappers[MyBatis Mappers]
        Cache[Redis Cache]
    end

    subgraph 存储层
        DB[(PostgreSQL)]
        Redis[(Redis)]
    end

    H5 --> Controllers
    H5 --> AuthCtrl
    H5 --> BindCtrl
    Admin --> Controllers
    Webhook --> Controllers

    AuthCtrl --> AuthSvc
    BindCtrl --> BindSvc

    Controllers --> CampSvc
    Controllers --> PaySvc
    Controllers --> CheckinSvc
    Controllers --> RefundSvc

    Webhook --> BindSvc

    AuthSvc --> WxOAuthMgr
    AuthSvc --> Mappers

    BindSvc --> Mappers

    CampSvc --> Mappers
    PaySvc --> Mappers
    CheckinSvc --> Mappers
    RefundSvc --> Mappers

    PaySvc --> WxPayMgr
    CheckinSvc --> ZsxqMgr
    RefundSvc --> WxPayMgr
    RefundSvc --> WxMsgMgr

    Mappers --> DB
    Cache --> Redis
```

---

## 五、Level 4: 代码级设计

### 5.1 核心领域模型

```mermaid
classDiagram
    class Camp {
        +Long id
        +String name
        +String description
        +Integer depositAmount
        +Integer requiredDays
        +Integer totalDays
        +LocalDate startDate
        +LocalDate endDate
        +CampStatus status
        +String qrCodeUrl
        +create()
        +publish()
        +start()
        +end()
        +archive()
    }

    class Member {
        +Long id
        +Long campId
        +String planetNickname
        +String planetId
        +String wechatNickname
        +Integer checkinDays
        +MemberStatus status
        +register()
        +checkin()
        +isQualified()
    }

    class PaymentRecord {
        +Long id
        +Long memberId
        +Long campId
        +String orderNo
        +String transactionId
        +Integer amount
        +PayStatus payStatus
        +BindStatus bindStatus
        +BindMethod bindMethod
        +LocalDateTime bindDeadline
        +LocalDateTime payTime
        +create()
        +pay()
        +bind()
        +expire()
        +refund()
    }

    class RefundRecord {
        +Long id
        +Long paymentId
        +Long memberId
        +Integer amount
        +RefundStatus status
        +String refundId
        +generate()
        +approve()
        +reject()
        +execute()
    }

    class CheckinRecord {
        +Long id
        +Long memberId
        +LocalDate checkinDate
        +String content
    }

    Camp "1" --> "*" Member : 包含
    Member "1" --> "1" PaymentRecord : 关联
    Member "1" --> "*" CheckinRecord : 打卡记录
    PaymentRecord "1" --> "0..1" RefundRecord : 退款
```

### 5.2 核心服务接口

```mermaid
classDiagram
    class CampService {
        <<interface>>
        +createCamp(CampDTO) Camp
        +publishCamp(Long) void
        +getCampDetail(Long) CampVO
        +listCamps(CampQuery) PageResult
        +syncCheckins(Long) SyncResult
    }

    class PaymentService {
        <<interface>>
        +createOrder(OrderDTO) PaymentRecord
        +handlePaymentCallback(CallbackDTO) void
        +queryOrderStatus(String) PayStatus
    }

    class RefundService {
        <<interface>>
        +generateRefundList(Long) RefundListVO
        +approveRefunds(List~Long~) void
        +rejectRefunds(List~Long~, String) void
        +executeRefund(Long) RefundResult
    }

    class PaymentBindService {
        <<interface>>
        +handlePaymentCallback(CallbackDTO) void
        +bindByUserFill(BindRequest) BindResult
        +checkAndExpireBindings() Integer
        +getBindStatus(String) BindStatusVO
        +manualBind(Long, String, Long) void
        +closePayment(Long, String, Long) void
    }

    class FastAuthService {
        <<interface>>
        +generateAuthorizeUrl(String, String) AuthorizeUrlVO
        +handleOAuthCallback(String, String) AuthCallbackResult
        +bindPlanetAccount(String, String, String) BindPlanetResult
        +validateAccessToken(String) AuthSession
    }

    class CampServiceImpl {
        -CampMapper campMapper
        -MemberMapper memberMapper
        -PlanetApiManager planetApi
    }

    class RefundServiceImpl {
        -RefundMapper refundMapper
        -PaymentMapper paymentMapper
        -WechatPayManager wechatPay
    }

    class PaymentBindServiceImpl {
        -PaymentMapper paymentMapper
        -PaymentBindStatusLogMapper bindLogMapper
    }

    CampService <|.. CampServiceImpl
    RefundService <|.. RefundServiceImpl
    PaymentBindService <|.. PaymentBindServiceImpl
```

---

## 六、部署架构

### 6.1 部署图

> **部署形态说明**：v1 采用单节点部署，所有服务运行在一台云服务器上。

```mermaid
flowchart TB
    subgraph Cloud["云服务器 (单节点)"]
        api["API 服务<br/>Spring Boot 3.2<br/>内置 Tomcat + SSL"]
        h5Static["H5 前端<br/>静态资源"]
        adminStatic["管理后台<br/>静态资源"]
    end

    subgraph RDS["云数据库"]
        postgres[("PostgreSQL 15<br/>单实例")]
    end

    subgraph Cache["云缓存"]
        redis[("Redis 7<br/>单实例")]
    end

    User["用户"] -->|HTTPS| api
    api -->|JDBC| postgres
    api -->|Redis| redis
    api -.->|静态文件| h5Static
    api -.->|静态文件| adminStatic
```

### 6.2 部署说明

**当前形态（单节点）**：

| 层级 | 组件 | 规格 | 数量 |
|------|------|------|------|
| 应用 | API 服务 | 2C4G | 1 |
| 数据库 | PostgreSQL | 云 RDS | 1 |
| 缓存 | Redis | 云 Redis | 1 |

**扩展路径**（后续容量提升时启用）：

| 阶段 | 触发条件 | 扩展组件 |
|------|----------|----------|
| 阶段 1 | 当前 | 单节点 API + PostgreSQL + Redis |
| 阶段 2 | 并发 > 100 QPS | 添加 Nginx 反向代理 |
| 阶段 3 | 异步任务积压 | 引入 RabbitMQ 消息队列 |
| 阶段 4 | 需要高可用 | 双节点 API + PostgreSQL 主从 |

---

## 七、数据流架构

### 7.1 核心数据流

```mermaid
flowchart LR
    subgraph 数据输入
        A1[会员报名]
        A2[支付回调]
        A3[打卡同步]
    end

    subgraph 数据处理
        B1[报名服务]
        B2[支付绑定服务]
        B3[打卡服务]
        B4[退款服务]
    end

    subgraph 数据存储
        C1[(支付表)]
        C2[(会员表)]
        C3[(打卡表)]
        C4[(退款表)]
    end

    subgraph 数据输出
        D1[退款执行]
        D2[通知推送]
        D3[统计报表]
    end

    A1 --> B1 --> C2
    A2 --> B2 --> C1
    A3 --> B3 --> C3

    C2 --> B4
    C1 --> B4
    B4 --> C4

    C4 --> D1
    C4 --> D2
    C1 --> D3
    C2 --> D3
    C4 --> D3
```

### 7.2 异步数据流

> **设计说明**：移除智能匹配流程，绑定超时检查直接触发通知和人工审核列表更新。v1 初期使用 Spring 异步任务，消息队列为可选扩展。

```mermaid
flowchart LR
    subgraph 生产者
        P1[支付回调处理]
        P2[退款审核通过]
        P3[绑定超时检查]
        P4[打卡同步完成]
    end

    subgraph 消息队列
        Q1[refund.execute]
        Q3[notify.send]
        Q4[stats.update]
    end

    subgraph 消费者
        C1[退款执行器]
        C3[通知发送器]
        C4[统计更新器]
    end

    P1 --> Q3
    P2 --> Q1
    P3 --> Q3
    P4 --> Q4

    Q1 --> C1
    Q3 --> C3
    Q4 --> C4

    C1 -->|成功| Q3
    C1 -->|失败| Q1
```

---

## 八、安全架构

### 8.1 安全分层

```mermaid
flowchart TB
    subgraph 网络层安全
        N1[HTTPS/TLS 1.3]
        N2[WAF 防护]
        N3[DDoS 防护]
    end

    subgraph 接入层安全
        A1[JWT 认证]
        A2[RBAC 授权]
        A3[接口限流]
        A4[请求签名]
    end

    subgraph 应用层安全
        B1[参数校验]
        B2[SQL 注入防护]
        B3[XSS 防护]
        B4[敏感数据脱敏]
    end

    subgraph 数据层安全
        D1[数据加密存储]
        D2[访问控制]
        D3[审计日志]
    end

    N1 --> A1
    N2 --> A1
    N3 --> A1
    A1 --> B1
    A2 --> B1
    A3 --> B1
    A4 --> B1
    B1 --> D1
    B2 --> D1
    B3 --> D1
    B4 --> D1
```

### 8.2 认证授权流程

```mermaid
sequenceDiagram
    participant Client as 客户端
    participant Gateway as API网关
    participant Auth as 认证服务
    participant API as 业务API

    Client->>Gateway: 请求 + Token
    Gateway->>Gateway: Token 格式校验
    Gateway->>Auth: 验证 Token
    Auth->>Auth: 解析 JWT
    Auth-->>Gateway: 返回用户信息
    Gateway->>Gateway: 权限检查
    Gateway->>API: 转发请求
    API-->>Gateway: 返回结果
    Gateway-->>Client: 响应
```

---

## 相关文档

- [用户旅程图](./用户旅程图.md)
- [业务流程图](./业务流程图.md)
- [时序图](./时序图.md)
- [状态机](./状态机.md)
