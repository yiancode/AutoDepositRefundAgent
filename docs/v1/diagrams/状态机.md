# 状态机

本文档展示知识星球训练营自动押金退款系统的核心实体状态机设计。

---

## 一、训练营状态机

### 1.1 状态图

```mermaid
stateDiagram-v2
    [*] --> 草稿: 创建训练营

    草稿 --> 待发布: 完善信息
    草稿 --> [*]: 删除

    待发布 --> 报名中: 发布
    待发布 --> 草稿: 编辑
    待发布 --> [*]: 删除

    报名中 --> 进行中: 训练营开始
    报名中 --> 已取消: 取消发布

    进行中 --> 已结束: 训练营结束
    进行中 --> 已取消: 异常终止

    已结束 --> 结算中: 开始结算
    结算中 --> 已归档: 结算完成

    已取消 --> [*]: 清理数据
    已归档 --> [*]: 归档存储
```

### 1.2 状态说明

| 状态 | 编码 | 描述 | 可执行操作 |
|------|------|------|-----------|
| 草稿 | `DRAFT` | 初始创建状态 | 编辑、删除、完善信息 |
| 待发布 | `PENDING` | 信息完善，等待发布 | 发布、编辑、删除 |
| 报名中 | `ENROLLING` | 已发布，接受报名 | 取消发布 |
| 进行中 | `ONGOING` | 训练营进行中 | 异常终止 |
| 已结束 | `ENDED` | 训练营结束 | 开始结算 |
| 结算中 | `SETTLING` | 正在处理退款 | - |
| 已归档 | `ARCHIVED` | 结算完成，已归档 | - |
| 已取消 | `CANCELLED` | 取消状态 | - |

### 1.3 状态转换规则

```mermaid
flowchart TD
    subgraph 触发条件
        T1[完善信息] --> |所有必填项已填写| A1[DRAFT → PENDING]
        T2[发布] --> |管理员操作| A2[PENDING → ENROLLING]
        T3[训练营开始] --> |���达开始时间| A3[ENROLLING → ONGOING]
        T4[训练营结束] --> |到达结束时间| A4[ONGOING → ENDED]
        T5[开始结算] --> |管理员触发| A5[ENDED → SETTLING]
        T6[结算完成] --> |所有退款处理完| A6[SETTLING → ARCHIVED]
    end
```

---

## 二、支付映射绑定状态机（新增）

> 混合方案核心：追踪支付记录与星球用户的绑定状态

### 2.1 绑定状态图

```mermaid
stateDiagram-v2
    [*] --> 待绑定: 支付回调（无attach）

    state 已绑定 {
        [*] --> 动态二维码绑定
        [*] --> 用户填写绑定
        [*] --> 智能匹配绑定
        [*] --> 人工绑定
    }

    待绑定 --> 已绑定: 用户填写提交<br/>bind_method=user_fill
    待绑定 --> 已过期: 超过7天未绑定

    已过期 --> 已绑定: 智能匹配成功<br/>bind_method=smart_match
    已过期 --> 人工处理中: 智能匹配失败

    人工处理中 --> 已绑定: 管理员手动绑定<br/>bind_method=manual
    人工处理中 --> 已关闭: 无法匹配

    note right of 待绑定: planet_user_id=null<br/>bind_deadline=now+7d

    note right of 已绑定: planet_user_id!=null<br/>confidence=100%

    已绑定 --> [*]
    已关闭 --> [*]
```

### 2.2 支付回调时的绑定处理

```mermaid
stateDiagram-v2
    [*] --> 解析attach

    state 解析attach {
        [*] --> 有attach数据
        [*] --> 无attach数据
    }

    有attach数据 --> 已绑定: 保存映射<br/>bind_status=completed<br/>bind_method=h5_bindplanet

    无attach数据 --> 待绑定: 保存映射<br/>bind_status=pending<br/>bind_deadline=now+7d
```

### 2.3 绑定状态说明

| 状态 | 编码 | 描述 | bind_method | 可执行操作 |
|------|------|------|-------------|-----------|
| 已绑定（H5） | `COMPLETED` | H5主路径OAuth登录后支付 | `h5_bindplanet` | - |
| 已绑定（填写） | `COMPLETED` | 降级路径用户支付后填写绑定 | `user_fill` | - |
| 已绑定（人工） | `COMPLETED` | 管理员手动绑定 | `manual` | - |
| 待绑定 | `PENDING` | 等待用户填写（降级路径） | `null` | 填写、等待超时 |
| 已过期 | `EXPIRED` | 超过绑定期限（7天） | `null` | 转人工审核 |
| 人工审核中 | `MANUAL_REVIEW` | 超时未绑定，等待管理员处理 | `null` | 人工绑定、关闭 |
| 已关闭 | `CLOSED` | 无法匹配 | `null` | - |

### 2.4 绑定超时处理流程

```mermaid
stateDiagram-v2
    state 定时检查 {
        [*] --> 查询待绑定记录
        查询待绑定记录 --> 检查截止时间

        state 检查截止时间 <<choice>>
        检查截止时间 --> 未过期: deadline > now
        检查截止时间 --> 已过期: deadline <= now

        未过期 --> 保持待绑定
        已过期 --> 更新为已过期
        更新为已过期 --> 转入人工审核
    }
```

---

## 三、订单/支付状态机

### 3.1 状态图

```mermaid
stateDiagram-v2
    [*] --> 待支付: 创建订单

    待支付 --> 支付中: 发起支付
    待支付 --> 已取消: 超时取消
    待支付 --> 已取消: 用户取消

    支付中 --> 已支付: 支付成功
    支付中 --> 支付失败: 支付失败
    支付中 --> 待支付: 支付超时

    支付失败 --> 支付中: 重新支付
    支付失败 --> 已取消: 放弃支付

    已支付 --> 退款中: 发起退款
    退款中 --> 已退款: 退款成功
    退款中 --> 退款失败: 退款失败

    退款失败 --> 退款中: 重试退款
    退款失败 --> 已支付: 取消退款

    已取消 --> [*]
    已退款 --> [*]
```

### 3.2 状态说明

| 状态 | 编码 | 描述 | 可执行操作 |
|------|------|------|-----------|
| 待支付 | `PENDING` | 订单创建，等待支付 | 发起支付、取消 |
| 支付中 | `PAYING` | 正在支付过程中 | - |
| 已支付 | `PAID` | 支付成功 | 发起退款 |
| 支付失败 | `PAY_FAILED` | 支付失败 | 重新支付、放弃 |
| 退款中 | `REFUNDING` | 正在退款 | - |
| 已退款 | `REFUNDED` | 退款成功 | - |
| 退款失败 | `REFUND_FAILED` | 退款失败 | 重试、取消 |
| 已取消 | `CANCELLED` | 订单取消 | - |

### 3.3 支付状态详细转换

```mermaid
stateDiagram-v2
    state 支付流程 {
        [*] --> 待支付

        待支付 --> 支付请求中: 调用支付API

        state 支付请求中 {
            [*] --> 等待用户操作
            等待用户操作 --> 验证支付: 用户完成
            等待用户操作 --> 支付取消: 用户取消
            验证支付 --> [*]: 验证完成
        }

        支付请求中 --> 已支付: Webhook确认成功
        支付请求中 --> 支付失败: Webhook确认失败

        支付失败 --> 待支付: 重新发起
    }
```

---

## 四、退款状态机

### 4.1 状态图

```mermaid
stateDiagram-v2
    [*] --> 待生成: 训练营结束

    待生成 --> 待匹配: 生成退款名单
    待匹配 --> 匹配完成: 自动匹配

    state 匹配完成 {
        [*] --> 高置信度
        [*] --> 待审核
        [*] --> 匹配失败

        高置信度 --> 自动通过: 置信度>=80%
        待审核 --> 审核通过: 管理员通过
        待审核 --> 审核拒绝: 管理员拒绝
        匹配失败 --> 人工处理: 手动匹配
        人工处理 --> 审核通过: 匹配成功
        人工处理 --> 审核拒绝: 无法匹配
    }

    匹配完成 --> 待退款: 审核通过
    匹配完成 --> 已拒绝: 审核拒绝

    待退款 --> 退款中: 执行退款
    退款中 --> 退款成功: API返回成功
    退款中 --> 退款失败: API返回失败

    退款失败 --> 退款中: 重试
    退款失败 --> 人工处理中: 超过重试次数

    人工处理中 --> 退款成功: 手动处理成功
    人工处理中 --> 已关闭: 手动关闭

    退款成功 --> [*]
    已拒绝 --> [*]
    已关闭 --> [*]
```

### 4.2 状态说明

| 状态 | 编码 | 描述 | 可执行操作 |
|------|------|------|-----------|
| 待生成 | `INIT` | 初始状态 | 生成退款名单 |
| 待匹配 | `MATCHING` | 等待身份匹配 | - |
| 高置信度 | `HIGH_CONFIDENCE` | 匹配置信度>=80% | 自动审核通过 |
| 待审核 | `PENDING_REVIEW` | 需要人工审核 | 通过、拒绝 |
| 匹配失败 | `MATCH_FAILED` | 自动匹配失败 | 人工匹配 |
| 待退款 | `APPROVED` | 审核通过，等待退款 | 执行退款 |
| 退款中 | `REFUNDING` | 正在退款 | - |
| 退款成功 | `REFUNDED` | 退款完成 | - |
| 退款失败 | `REFUND_FAILED` | 退款失败 | 重试、人工处理 |
| 人工处理中 | `MANUAL_PROCESSING` | 需要人工介入 | 手动退款、关闭 |
| 已拒绝 | `REJECTED` | 审核拒绝 | - |
| 已关闭 | `CLOSED` | 手动关闭 | - |

### 4.3 退款处理详细流程

```mermaid
stateDiagram-v2
    state 退款执行 {
        [*] --> 准备退款

        准备退款 --> 调用API: 构建请求

        state 调用API {
            [*] --> 发送请求
            发送请求 --> 等待响应
            等待响应 --> 解析结果
            解析结果 --> [*]
        }

        调用API --> 处理成功: 返回成功
        调用API --> 处理失败: 返回失败

        处理失败 --> 判断重试: 分析错误

        state 判断重试 {
            [*] --> 可重试错误
            [*] --> 不可重试错误

            可重试错误 --> 延迟重试: 重试次数<3
            可重试错误 --> 标记失败: 重试次数>=3

            不可重试错误 --> 标记失败
        }

        延迟重试 --> 准备退款: 等待后重试
        标记失败 --> [*]
        处理成功 --> [*]
    }
```

---

## 五、打卡同步状态机

### 5.1 状态图

```mermaid
stateDiagram-v2
    [*] --> 待同步: 定时触发

    待同步 --> 同步中: 开始同步

    state 同步中 {
        [*] --> 请求API
        请求API --> 解析数据: 成功
        请求API --> 重试: 失败
        重试 --> 请求API: 重试次数<3
        重试 --> 同步失败: 重试次数>=3
        解析数据 --> 保存数据
        保存数据 --> [*]
    }

    同步中 --> 同步成功: 完成
    同步中 --> 同步失败: 错误

    同步成功 --> [*]
    同步失败 --> 待人工处理: 需要介入

    待人工处理 --> 待同步: 问题解决
    待人工处理 --> [*]: 跳过
```

### 5.2 状态说明

| 状态 | 编码 | 描述 | 可执行操作 |
|------|------|------|-----------|
| 待同步 | `PENDING` | 等待同步 | 触发同步 |
| 同步中 | `SYNCING` | 正在同步 | - |
| 同步成功 | `SUCCESS` | 同步完成 | - |
| 同步失败 | `FAILED` | 同步失败 | 重试 |
| 待人工处理 | `MANUAL` | 需要人工介入 | 处理、跳过 |

---

## 六、用户打卡状态机

### 6.1 状态图

```mermaid
stateDiagram-v2
    [*] --> 未开始: 报名成功

    未开始 --> 进行中: 训练营开始

    state 进行中 {
        [*] --> 今日未打卡
        今日未打卡 --> 今日已打卡: 打卡
        今日已打卡 --> 今日未打卡: 新的一天
    }

    进行中 --> 已完成: 达到要求天数
    进行中 --> 未达标: 训练营结束且未达标

    已完成 --> 待退款: 生成退款名单
    未达标 --> [*]

    待退款 --> 已退款: 退款成功
    已退款 --> [*]
```

### 6.2 状态说明

| 状态 | 编码 | 描述 | 可执行操作 |
|------|------|------|-----------|
| 未开始 | `NOT_STARTED` | 已报名，训练营未开始 | - |
| 进行中 | `IN_PROGRESS` | 训练营进行中 | 打卡 |
| 已完成 | `COMPLETED` | 达到打卡要求 | - |
| 未达标 | `FAILED` | 未达到打卡要求 | - |
| 待退款 | `PENDING_REFUND` | 等待退款 | - |
| 已退款 | `REFUNDED` | 退款完成 | - |

---

## 七、状态转换事件汇总

### 7.1 训练营状态事件

| 事件 | 触发方式 | 来源状态 | 目标状态 | 备注 |
|------|----------|----------|----------|------|
| CREATE | 管理员操作 | - | DRAFT | 创建训练营 |
| COMPLETE_INFO | 管理员操作 | DRAFT | PENDING | 信息完善 |
| PUBLISH | 管理员操作 | PENDING | ENROLLING | 发布 |
| START | 系统定时 | ENROLLING | ONGOING | 到达开始时间 |
| END | 系统定时 | ONGOING | ENDED | 到达结束时间 |
| SETTLE | 管理员触发 | ENDED | SETTLING | 开始结算 |
| ARCHIVE | 系统自动 | SETTLING | ARCHIVED | 结算完成 |
| CANCEL | 管理员操作 | ENROLLING/ONGOING | CANCELLED | 取消 |

### 7.2 支付映射绑定事件（新增）

| 事件 | 触发方式 | 来源状态 | 目标状态 | 备注 |
|------|----------|----------|----------|------|
| CREATE_H5 | Webhook | - | COMPLETED | H5主路径支付，自动绑定 |
| CREATE_FALLBACK | Webhook | - | PENDING | 降级路径支付，待绑定 |
| USER_BIND | 用户操作 | PENDING | COMPLETED | 用户填写绑定 |
| EXPIRE | 定时任务 | PENDING | EXPIRED | 超过7天未绑定 |
| TO_MANUAL_REVIEW | 定时任务 | EXPIRED | MANUAL_REVIEW | 转入人工审核 |
| MANUAL_BIND | 管理员操作 | MANUAL_REVIEW | COMPLETED | 人工绑定 |
| CLOSE | 管理员操作 | MANUAL_REVIEW | CLOSED | 无法匹配关闭 |

### 7.3 订单状态事件

| 事件 | 触发方式 | 来源状态 | 目标状态 | 备注 |
|------|----------|----------|----------|------|
| CREATE | 用户操作 | - | PENDING | 创建订单 |
| PAY | 用户操作 | PENDING | PAYING | 发起支付 |
| PAY_SUCCESS | Webhook | PAYING | PAID | 支付成功 |
| PAY_FAIL | Webhook | PAYING | PAY_FAILED | 支付失败 |
| REFUND | 系统触发 | PAID | REFUNDING | 发起退款 |
| REFUND_SUCCESS | Webhook | REFUNDING | REFUNDED | 退款成功 |
| REFUND_FAIL | Webhook | REFUNDING | REFUND_FAILED | 退款失败 |
| CANCEL | 用户/系统 | PENDING | CANCELLED | 取消订单 |

### 7.4 退款状态事件

| 事件 | 触发方式 | 来源状态 | 目标状态 | 备注 |
|------|----------|----------|----------|------|
| GENERATE | 管理员触发 | INIT | MATCHING | 生成名单 |
| MATCH | 系统自动 | MATCHING | HIGH_CONFIDENCE/PENDING_REVIEW/MATCH_FAILED | 匹配结果 |
| APPROVE | 系统/管理员 | HIGH_CONFIDENCE/PENDING_REVIEW | APPROVED | 审核通过 |
| REJECT | 管理员操作 | PENDING_REVIEW | REJECTED | 审核拒绝 |
| EXECUTE | 系统触发 | APPROVED | REFUNDING | 执行退款 |
| SUCCESS | Webhook | REFUNDING | REFUNDED | 退款成功 |
| FAIL | Webhook | REFUNDING | REFUND_FAILED | 退款失败 |
| RETRY | 系统自动 | REFUND_FAILED | REFUNDING | 重试 |
| ESCALATE | 系统自动 | REFUND_FAILED | MANUAL_PROCESSING | 升级人工 |

---

## 八、状态持久化设计

### 8.1 状态表结构

```sql
-- 训练营状态记录
CREATE TABLE camp_status_log (
    id BIGSERIAL PRIMARY KEY,
    camp_id BIGINT NOT NULL,
    from_status VARCHAR(32),
    to_status VARCHAR(32) NOT NULL,
    event VARCHAR(64) NOT NULL,
    operator_id BIGINT,
    remark TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 支付映射绑定记录（新增）
CREATE TABLE payment_mapping (
    id BIGSERIAL PRIMARY KEY,
    out_trade_no VARCHAR(64) NOT NULL UNIQUE,
    transaction_id VARCHAR(64),
    planet_user_id VARCHAR(32),
    planet_nickname VARCHAR(128),
    wechat_nickname VARCHAR(128),
    amount INTEGER NOT NULL,
    checkin_id BIGINT NOT NULL,
    bind_status VARCHAR(32) NOT NULL DEFAULT 'pending',
    bind_method VARCHAR(32),
    bind_deadline TIMESTAMP,
    confidence_score INTEGER,
    payment_time TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 支付映射绑定状态日志（新增）
CREATE TABLE payment_mapping_status_log (
    id BIGSERIAL PRIMARY KEY,
    mapping_id BIGINT NOT NULL,
    from_status VARCHAR(32),
    to_status VARCHAR(32) NOT NULL,
    event VARCHAR(64) NOT NULL,
    operator_id BIGINT,
    extra_data JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 订单状态记录
CREATE TABLE order_status_log (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL,
    from_status VARCHAR(32),
    to_status VARCHAR(32) NOT NULL,
    event VARCHAR(64) NOT NULL,
    extra_data JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 退款状态记录
CREATE TABLE refund_status_log (
    id BIGSERIAL PRIMARY KEY,
    refund_id BIGINT NOT NULL,
    from_status VARCHAR(32),
    to_status VARCHAR(32) NOT NULL,
    event VARCHAR(64) NOT NULL,
    operator_id BIGINT,
    remark TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 8.2 状态变更审计

```mermaid
flowchart TD
    A[状态变更请求] --> B[验证状态转换合法性]
    B --> C{转换是否合法}
    C -->|否| D[抛出异常]
    C -->|是| E[执行状态变更]
    E --> F[记录状态日志]
    F --> G[发送状态变更事件]
    G --> H[通知相关订阅者]
```

---

## 相关文档

- [用户旅程图](./用户旅程图.md)
- [业务流程图](./业务流程图.md)
- [时序图](./时序图.md)
- [架构设计图](./架构设计图.md)
