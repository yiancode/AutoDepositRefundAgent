version: '3.8'

# 知识星球训练营自动押金退款系统 - 本地开发环境
# 包含：PostgreSQL, Redis, Adminer (数据库管理界面)

services:
  # PostgreSQL 数据库
  postgres:
    image: postgres:15-alpine
    container_name: camp-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: camp_db
      POSTGRES_USER: camp_user
      POSTGRES_PASSWORD: dev_password
      TZ: Asia/Shanghai
    ports:
      - "5432:5432"
    volumes:
      # 数据持久化
      - postgres_data:/var/lib/postgresql/data
      # 数据库初始化脚本（项目创建后取消注释）
      # - ./scripts/init-database.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - camp-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U camp_user -d camp_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: camp-redis
    restart: unless-stopped
    command: redis-server --requirepass dev_password --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - camp-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Adminer - 数据库管理界面
  adminer:
    image: adminer:latest
    container_name: camp-adminer
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres
      ADMINER_DESIGN: dracula
    networks:
      - camp-network
    depends_on:
      postgres:
        condition: service_healthy

  # pgAdmin - PostgreSQL 图形化管理工具（可选，资源占用较大）
  # 如需使用，取消下面的注释
  # pgadmin:
  #   image: dpage/pgadmin4:latest
  #   container_name: camp-pgadmin
  #   restart: unless-stopped
  #   environment:
  #     PGADMIN_DEFAULT_EMAIL: admin@example.com
  #     PGADMIN_DEFAULT_PASSWORD: dev_password
  #     PGADMIN_CONFIG_SERVER_MODE: 'False'
  #   ports:
  #     - "5050:80"
  #   volumes:
  #     - pgadmin_data:/var/lib/pgadmin
  #   networks:
  #     - camp-network
  #   depends_on:
  #     postgres:
  #       condition: service_healthy

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  # pgadmin_data:
  #   driver: local

networks:
  camp-network:
    driver: bridge

# 使用说明：
#
# 1. 启动所有服务：
#    docker-compose up -d
#
# 2. 查看服务状态：
#    docker-compose ps
#
# 3. 查看日志：
#    docker-compose logs -f [postgres|redis|adminer]
#
# 4. 停止所有服务：
#    docker-compose down
#
# 5. 停止并删除数据卷（⚠️ 谨慎使用，会清空数据）：
#    docker-compose down -v
#
# 6. 重启单个服务：
#    docker-compose restart postgres
#
# 访问地址：
# - PostgreSQL: localhost:5432
#   - 数据库: camp_db
#   - 用户名: camp_user
#   - 密码: dev_password
#
# - Redis: localhost:6379
#   - 密码: dev_password
#
# - Adminer (数据库管理): http://localhost:8081
#   - 系统: PostgreSQL
#   - 服务器: postgres
#   - 用户名: camp_user
#   - 密码: dev_password
#   - 数据库: camp_db
#
# - pgAdmin (可选): http://localhost:5050
#   - 邮箱: admin@example.com
#   - 密码: dev_password
#
# 开发环境变量配置（backend/src/main/resources/application-dev.yml）:
# spring:
#   datasource:
#     url: jdbc:postgresql://localhost:5432/camp_db
#     username: camp_user
#     password: dev_password
#   redis:
#     host: localhost
#     port: 6379
#     password: dev_password
