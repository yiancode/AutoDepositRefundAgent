# 企业微信退款 API 方案分析

**创建时间**: 2025-11-02
**状态**: 调研分析

---

## 🔍 发现的 API

用户提供的企业微信退款接口:

```
POST https://qyapi.weixin.qq.com/cgi-bin/miniapppay/refund?access_token=ACCESS_TOKEN
```

**文档地址**: https://developer.work.weixin.qq.com/document/path/97333

---

## 📊 两种退款方案对比

| 对比项 | 企业微信小程序支付 | 微信支付商户号 |
|-------|-------------------|---------------|
| **API 域名** | `qyapi.weixin.qq.com` | `api.mch.weixin.qq.com` |
| **适用场景** | 企业微信小程序内支付 | 通用支付（H5/扫码/APP等） |
| **是否需要商户号** | ✅ 需要 | ✅ 需要 |
| **是否需要证书** | ❓ 待确认 | ✅ 需要 |
| **认证方式** | `access_token` (企业微信) | 证书 + 签名 |
| **支持收款方式** | 企业微信小程序支付 | 所有微信支付方式 |
| **支持收款码退款** | ❌ 不支持 | ❓ 视商户号类型 |

---

## 🎯 关键问题

### 问题 1: 您当前的收款方式是什么？

请确认以下哪种情况：

#### 情况 A: 企业微信收款码 (静态二维码)
```
特点:
- 打印的固定二维码
- 用户扫码直接支付
- 在"微信支付商户平台"查看收款记录
- 可能显示为"收款商业版"账户

结论:
❌ 企业微信小程序退款 API 不适用
❌ 此类收款无法通过 API 自动退款
✅ 必须申请正式商户号才能 API 退款
```

#### 情况 B: 企业微信小程序支付
```
特点:
- 用户在企业微信小程序内下单
- 通过"企业微信小程序支付"完成付款
- 需要开发小程序支付功能

结论:
✅ 可以使用 qyapi.weixin.qq.com 的退款 API
✅ 需要企业微信 corpid + secret
⚠️ 仍需要微信支付商户号（关联到企业微信）
```

#### 情况 C: 第三方 H5 页面支付
```
特点:
- 用户在外部网页完成支付
- 跳转到微信支付收银台

结论:
❌ 企业微信小程序退款 API 不适用
✅ 需要使用微信支付商户号 API
```

---

## 📝 API 使用前提条件分析

### 企业微信小程序支付退款 API 的前提

根据企业微信文档，使用 `miniapppay/refund` 接口需要：

1. **已开通企业微信小程序支付**
   - 需要在企业微信管理后台开通
   - 需要关联微信支付商户号

2. **拥有微信支付商户号**
   - 即使用企业微信 API，底层仍需要商户号
   - 商户号需要绑定到企业微信账号

3. **获取企业微信 access_token**
   - 使用 `corpid` + `corpsecret` 换取
   - 有效期 7200 秒

4. **拥有支付权限**
   - 需要在企业微信后台配置应用权限
   - 需要配置支付授权目录

---

## 🔐 认证方式对比

### 企业微信 API 认证

```javascript
// 1. 获取 access_token
GET https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=ID&corpsecret=SECRET

// 2. 使用 access_token 调用退款
POST https://qyapi.weixin.qq.com/cgi-bin/miniapppay/refund?access_token=ACCESS_TOKEN
```

**优点**:
- ✅ 不需要证书文件
- ✅ 使用 access_token 认证，相对简单

**缺点**:
- ❌ 仍需要商户号
- ❌ 只适用于企业微信小程序支付
- ❌ 不适用于收款码

### 微信支付商户号 API 认证

```javascript
// 使用证书 + 签名认证
const wxpay = new WxPay({
  mchid: 'xxx',
  serial: 'xxx',
  privateKey: fs.readFileSync('apiclient_key.pem'),
  certs: {
    'serial': fs.readFileSync('apiclient_cert.pem')
  }
});
```

**优点**:
- ✅ 支持所有微信支付方式
- ✅ 功能完整，文档齐全

**缺点**:
- ❌ 需要下载和管理证书
- ❌ 认证相对复杂

---

## 💡 判断方法：如何确定您的收款方式

### 方法 1: 查看收款记录来源

登录 **微信支付商户平台** (https://pay.weixin.qq.com):

1. 查看"交易中心" → "交易记录"
2. 查看交易类型：
   - 如果显示 **"收款商业版"** → ❌ 不能用企业微信 API
   - 如果显示 **"小程序支付"** → ✅ 可能可以用
   - 如果显示 **"Native支付"** (扫码) → ❌ 不能用企业微信 API

### 方法 2: 查看企业微信后台

登录 **企业微信管理后台**:

1. 进入"应用管理" → "小程序"
2. 如果没有小程序 → ❌ 不能用企业微信小程序 API
3. 如果有小程序且开通了支付 → ✅ 可以考虑使用

### 方法 3: 查看用户支付场景

回忆用户如何支付押金:

- **扫固定二维码 → 直接完成支付** → ❌ 收款码，不能用企业微信 API
- **在小程序内点击支付按钮** → ✅ 小程序支付，可以用
- **在 H5 页面点击支付，跳转微信收银台** → ❌ 不能用企业微信 API

---

## 🎯 结论和建议

### 如果您是"情况 A"（收款码）

**结论**:
- ❌ **无法使用**企业微信 `miniapppay/refund` API
- ❌ **无法通过任何 API** 实现自动退款
- ✅ **必须申请微信支付商户号**

**操作建议**:
1. 申请微信支付商户号（前面提供的流程）
2. 等待审核通过（1-7 天）
3. 下载 API 证书
4. 按照 v0.1 技术方案开发退款功能

---

### 如果您是"情况 B"（小程序支付）

**结论**:
- ✅ **可以使用**企业微信 `miniapppay/refund` API
- ⚠️ **仍需要商户号**（已绑定到企业微信）
- ✅ **不需要下载证书**（使用 access_token）

**操作建议**:
1. 确认企业微信后台已开通小程序支付
2. 获取 `corpid` 和 `corpsecret`
3. 修改 v0.1 技术方案，使用企业微信 API
4. 开发时间可能缩短（不需要处理证书）

---

## 📋 下一步行动

请用户确认以下信息：

1. **当前收款方式**:
   - [ ] 企业微信收款码（静态二维码）
   - [ ] 企业微信小程序支付
   - [ ] H5 页面微信支付
   - [ ] 不确定，需要查看后台

2. **是否有商户号**:
   - [ ] 有商户号，商户号: ___________
   - [ ] 没有商户号
   - [ ] 不确定

3. **是否开通了企业微信小程序**:
   - [ ] 有小程序，小程序名称: ___________
   - [ ] 没有小程序
   - [ ] 不确定

4. **是否能访问企业微信管理后台**:
   - [ ] 可以访问，有管理员权限
   - [ ] 可以访问，权限有限
   - [ ] 无法访问

---

## 🔄 技术方案调整

### 如果确认是小程序支付

需要修改 v0.1 技术方案的以下部分：

1. **认证方式**:
   ```
   旧方案: 证书 + 签名
   新方案: corpid + corpsecret → access_token
   ```

2. **API 地址**:
   ```
   旧方案: https://api.mch.weixin.qq.com/v3/refund/domestic/refunds
   新方案: https://qyapi.weixin.qq.com/cgi-bin/miniapppay/refund
   ```

3. **依赖库**:
   ```
   旧方案: wechatpay-node-v3
   新方案: axios (直接调用企业微信 API)
   ```

4. **配置文件**:
   ```env
   # 企业微信配置
   WEWORK_CORPID=xxx
   WEWORK_CORPSECRET=xxx

   # 微信支付商户号（仍需要）
   WECHAT_MCHID=xxx
   ```

---

## 📚 参考资料

- 企业微信小程序支付文档: https://developer.work.weixin.qq.com/document/path/97333
- 微信支付 API v3: https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml
- 企业微信开发文档: https://developer.work.weixin.qq.com/document/

---

---

## ✅ 用户确认信息 (2025-11-02)

**收款方式**: 扫固定二维码支付（用户用微信扫码）
**是否有小程序**: 否

**结论**:
- ❌ **无法使用**企业微信 `miniapppay/refund` API
- ❌ 此 API 仅支持企业微信小程序支付场景
- ⚠️ 需要确认商户号类型，判断是否支持 API 退款

**下一步**:
1. 登录微信支付商户平台 (pay.weixin.qq.com)
2. 确认商户号类型（收款商业版 vs 普通商户号）
3. 根据商户号类型决定技术方案

---

## 🎯 最终方案判断

### 如果是"收款商业版"

**特征**:
- 开通简单，无需营业执照
- 商户平台显示"收款商业版"字样
- 仅支持扫码收款，无其他产品

**退款能力**:
- ❌ 无 API 接口
- ❌ 无法自动退款
- ✅ 只能手动在商户平台退款

**解决方案**:
1. **方案 A**: 保持现状，使用 v0 版本 + 手动退款
2. **方案 B**: 升级为普通商户号（需要企业资质）

### 如果是"普通商户号"

**特征**:
- 需要营业执照申请
- 产品中心有"Native支付"等产品
- 可以下载 API 证书

**退款能力**:
- ✅ 支持 API 退款
- ✅ 可以自动化

**解决方案**:
1. 在商户平台下载 API 证书
2. 按照 v0.1 技术方案开发
3. 使用微信支付 API v3 退款接口

---

**待确认**: 等待用户提供商户号类型信息（截图或文字描述）。