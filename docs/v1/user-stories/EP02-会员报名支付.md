# EP02: 会员报名支付

## Epic 概述

| 字段 | 内容 |
|------|------|
| **Epic ID** | EP02 |
| **Epic 名称** | 会员报名支付 |
| **业务目标** | 会员能够便捷地报名参加训练营并完成押金支付 |
| **涉及角色** | 会员 |
| **优先级** | P0 |

---

## Story 2.1: 浏览训练营列表

| 字段 | 内容 |
|------|------|
| **Story ID** | S2.1 |
| **角色** | 作为一名会员 |
| **目标** | 我希望能够浏览可报名的训练营列表 |
| **价值** | 以便于选择感兴趣的训练营报名 |
| **优先级** | P0 |

### 验收标准

```gherkin
Feature: 浏览训练营列表
  作为一名会员
  我希望能够浏览可报名的训练营列表
  以便于选择感兴趣的训练营报名

  Scenario: 查看报名中的训练营
    Given 存在状态为 "报名中" 的训练营
    When 访问训练营列表页
    Then 只显示状态为 "报名中" 的训练营
    And 显示训练营名称、押金金额、打卡要求

  Scenario: 没有可报名的训练营
    Given 没有状态为 "报名中" 的训练营
    When 访问训练营列表页
    Then 显示 "暂无可报名的训练营"

  Scenario: 显示训练营详情
    Given 点击某个训练营
    When 进入详情页
    Then 显示完整的训练营信息
    And 显示报名按钮
```

### 任务拆分

- [ ] Task 2.1.1: 实现 H5 训练营列表接口
- [ ] Task 2.1.2: 实现 H5 列表页面
- [ ] Task 2.1.3: 实现详情页面
- [ ] Task 2.1.4: 编写测试用例

---

## Story 2.2: 填写报名信息

| 字段 | 内容 |
|------|------|
| **Story ID** | S2.2 |
| **角色** | 作为一名会员 |
| **目标** | 我希望能够填写报名信息 |
| **价值** | 以便于系统记录我的参与信息 |
| **优先级** | P0 |

### 验收标准

```gherkin
Feature: 填写报名信息
  作为一名会员
  我希望能够填写报名信息
  以便于系统记录我的参与信息

  Background:
    Given 会员进入报名页面
    And 训练营状态为 "报名中"

  Scenario: 成功填写报名信息
    Given 填写星球昵称为 "小明"
    And 填写星球ID为 "12345678"
    And 填写微信昵称为 "小明同学"
    When 点击下一步
    Then 进入支付页面

  Scenario: 星球昵称为空
    Given 星球昵称为空
    When 点击下一步
    Then 显示错误 "请填写星球昵称"

  Scenario: 星球ID格式错误
    Given 填写星球ID为 "abc"
    When 点击下一步
    Then 显示错误 "星球ID格式不正确"

  Scenario: 重复报名
    Given 该会员已报名此训练营
    When 填写信息并点击下一步
    Then 显示错误 "您已报名此训练营"

  Scenario: 训练营已满员
    Given 训练营已达到报名上限
    When 尝试报名
    Then 显示错误 "训练营已满员"
```

### 任务拆分

- [ ] Task 2.2.1: 实现报名信息校验接口
- [ ] Task 2.2.2: 实现 H5 报名表单页面
- [ ] Task 2.2.3: 实现前端表单校验
- [ ] Task 2.2.4: 编写测试用例

---

## Story 2.3: 支付押金

| 字段 | 内容 |
|------|------|
| **Story ID** | S2.3 |
| **角色** | 作为一名会员 |
| **目标** | 我希望能够支付训练营押金 |
| **价值** | 以便于完成报名并获取入群二维码 |
| **优先级** | P0 |

### 验收标准

```gherkin
Feature: 支付押金
  作为一名会员
  我希望能够支付训练营押金
  以便于完成报名并获取入群二维码

  Background:
    Given 会员已填写报名信息
    And 报名信息校验通过

  Scenario: 成功支付
    Given 点击支付按钮
    When 完成企业微信支付
    Then 显示支付成功页面
    And 显示群二维码
    And 保存支付映射到数据库

  Scenario: 取消支付
    Given 点击支付按钮
    When 在支付页面取消
    Then 返回报名页面
    And 保留已填写的信息

  Scenario: 支付失败
    Given 点击支付按钮
    When 支付失败（余额不足等）
    Then 显示支付失败原因
    And 提供重试按钮

  Scenario: 支付超时
    Given 点击支付按钮
    When 超过30分钟未完成支付
    Then 订单自动取消
    And 需要重新报名
```

### 任务拆分

- [ ] Task 2.3.1: 实现创建订单接口
- [ ] Task 2.3.2: 集成企业微信支付
- [ ] Task 2.3.3: 实现支付页面
- [ ] Task 2.3.4: 实现订单超时处理
- [ ] Task 2.3.5: 编写测试用例

---

## Story 2.4: 处理支付回调

| 字段 | 内容 |
|------|------|
| **Story ID** | S2.4 |
| **角色** | 作为系统 |
| **目标** | 我需要正确处理企业微信支付回调 |
| **价值** | 以便于保存支付映射并更新订单状态 |
| **优先级** | P0 |

### 验收标准

```gherkin
Feature: 处理支付回调
  作为系统
  我需要正确处理企业微信支付回调
  以便于保存支付映射并更新订单状态

  Scenario: 正常支付回调
    Given 收到企业微信支付回调
    And 签名验证通过
    When 处理回调
    Then 保存支付映射到数据库
    And 更新订单状态为 "已支付"
    And 返回 "SUCCESS"

  Scenario: 签名验证失败
    Given 收到回调请求
    And 签名验证失败
    When 处理回调
    Then 返回 "FAIL"
    And 记录告警日志

  Scenario: 重复回调（幂等）
    Given 收到重复的支付回调
    And 该订单已处理过
    When 处理回调
    Then 跳过处理
    And 返回 "SUCCESS"

  Scenario: 订单不存在
    Given 收到回调
    And 订单号不存在
    When 处理回调
    Then 返回 "FAIL"
    And 记录错误日志

  Scenario: 回调处理超时
    Given 收到回调
    When 处理时间超过 3 秒
    Then 记录告警
    And 优先返回 "SUCCESS"
    And 异步重试处理
```

### 任务拆分

- [ ] Task 2.4.1: 实现 Webhook 接口
- [ ] Task 2.4.2: 实现签名验证
- [ ] Task 2.4.3: 实现幂等处理
- [ ] Task 2.4.4: 实现支付映射保存
- [ ] Task 2.4.5: 实现超时处理机制
- [ ] Task 2.4.6: 编写单元测试
- [ ] Task 2.4.7: 编写集成测试

---

## 接口设计

### 创建订单

```
POST /api/orders

Request:
{
  "campId": 1,
  "planetNickname": "小明",
  "planetId": "12345678",
  "wechatNickname": "小明同学"
}

Response:
{
  "code": 200,
  "data": {
    "orderId": "ORDER123456",
    "payParams": {
      // 企业微信支付参数
    }
  }
}
```

### 支付回调

```
POST /api/webhook/payment

Request: XML格式（企业微信标准）

Response:
<xml>
  <return_code>SUCCESS</return_code>
</xml>
```

### 查询订单状态

```
GET /api/orders/{orderId}/status

Response:
{
  "code": 200,
  "data": {
    "status": "PAID",
    "qrCodeUrl": "https://..."
  }
}
```

---

## 相关文档

- [技术方案 v1](../技术方案.md)
- [EP01: 训练营管理](./EP01-训练营管理.md)
- [EP03: 打卡数据同步](./EP03-打卡数据同步.md)
