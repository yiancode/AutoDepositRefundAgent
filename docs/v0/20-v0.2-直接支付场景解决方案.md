# ç›´æ¥æ”¯ä»˜åœºæ™¯è§£å†³æ–¹æ¡ˆ

## é—®é¢˜æè¿°

**åœºæ™¯**ï¼šç”¨æˆ·ä¸é€šè¿‡æŠ¥åç³»ç»Ÿï¼Œè€Œæ˜¯ç›´æ¥æ‰«æå›ºå®šçš„ä¼ä¸šå¾®ä¿¡æ”¯ä»˜äºŒç»´ç å®Œæˆæ”¯ä»˜ã€‚

**é—®é¢˜**ï¼šç³»ç»Ÿæ— æ³•è‡ªåŠ¨å»ºç«‹æ”¯ä»˜è®¢å•ä¸çŸ¥è¯†æ˜Ÿçƒç”¨æˆ·çš„æ˜ å°„å…³ç³»ã€‚

**å½±å“**ï¼šé€€æ¬¾æ—¶æ— æ³•ç¡®å®šè¯¥æ”¯ä»˜è®¢å•å¯¹åº”å“ªä¸ªçŸ¥è¯†æ˜Ÿçƒç”¨æˆ·ã€‚

---

## ğŸ¯ æ¨èæ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å®ç°éš¾åº¦ | ç”¨æˆ·ä½“éªŒ | å‡†ç¡®ç‡ | æ¨èåº¦ |
|------|---------|---------|--------|--------|
| æ–¹æ¡ˆ1: åŠ¨æ€äºŒç»´ç  | â­â­â­ | â­â­â­â­â­ | 100% | â­â­â­â­â­ |
| æ–¹æ¡ˆ2: æ”¯ä»˜åä¿¡æ¯å¡«å†™ | â­â­ | â­â­â­ | 95% | â­â­â­â­ |
| æ–¹æ¡ˆ3: çº¯æ™ºèƒ½åŒ¹é… | â­ | â­â­â­â­â­ | 60-80% | â­â­â­ |
| æ–¹æ¡ˆ4: äººå·¥å½•å…¥ | â­ | â­ | 100% | â­â­ |

---

## æ–¹æ¡ˆ 1: åŠ¨æ€äºŒç»´ç ï¼ˆæ¨èï¼‰â­â­â­â­â­

### æ ¸å¿ƒæ€è·¯

æ¯ä¸ªç”¨æˆ·ç”Ÿæˆ**å”¯ä¸€çš„æ”¯ä»˜äºŒç»´ç **ï¼Œåœ¨äºŒç»´ç ä¸­ç¼–ç ç”¨æˆ·æ ‡è¯†ï¼ˆæ˜ŸçƒIDï¼‰ï¼Œæ”¯ä»˜å›è°ƒæ—¶è‡ªåŠ¨å»ºç«‹æ˜ å°„ã€‚

### å®ç°æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant ZSXQ as çŸ¥è¯†æ˜Ÿçƒ
    participant API as åç«¯API
    participant WX as å¾®ä¿¡æ”¯ä»˜
    participant DB as SQLite

    U->>ZSXQ: ç‚¹å‡»æŠ¥åé“¾æ¥
    ZSXQ->>API: æºå¸¦ planet_user_id
    API->>WX: åˆ›å»ºæ”¯ä»˜è®¢å•<br/>attach={planet_user_id}
    WX-->>API: è¿”å›æ”¯ä»˜äºŒç»´ç URL
    API-->>U: æ˜¾ç¤ºæ”¯ä»˜äºŒç»´ç 

    U->>WX: æ‰«ç æ”¯ä»˜
    WX->>API: Webhookå›è°ƒ<br/>åŒ…å« attach å‚æ•°
    API->>API: è§£æ attach è·å– planet_user_id
    API->>DB: ä¿å­˜æ”¯ä»˜æ˜ å°„

    API-->>U: æ˜¾ç¤ºç¾¤äºŒç»´ç 
```

### æŠ€æœ¯å®ç°

#### 1. ç”ŸæˆåŠ¨æ€æ”¯ä»˜äºŒç»´ç 

```javascript
// src/services/wechat-payment.service.js

class WechatPaymentService {
  /**
   * åˆ›å»ºæ”¯ä»˜è®¢å•ï¼ˆNative æ”¯ä»˜ï¼‰
   * @param {Object} params - æ”¯ä»˜å‚æ•°
   * @param {string} params.planet_user_id - çŸ¥è¯†æ˜Ÿçƒç”¨æˆ·ID
   * @param {string} params.planet_nickname - çŸ¥è¯†æ˜Ÿçƒæ˜µç§°
   * @param {string} params.checkin_id - è®­ç»ƒè¥ID
   * @param {number} params.amount - é‡‘é¢ï¼ˆå…ƒï¼‰
   */
  async createPayment(params) {
    const out_trade_no = this.generateOrderNo();

    // å°†ç”¨æˆ·ä¿¡æ¯ç¼–ç åˆ° attach å­—æ®µ
    const attach = JSON.stringify({
      planet_user_id: params.planet_user_id,
      planet_nickname: params.planet_nickname,
      checkin_id: params.checkin_id
    });

    const requestBody = {
      appid: process.env.WECHAT_PAY_APPID,
      mchid: this.mchid,
      description: `çŸ¥è¯†æ˜Ÿçƒè®­ç»ƒè¥æŠ¼é‡‘-${params.checkin_id}`,
      out_trade_no: out_trade_no,
      attach: attach,  // å…³é”®ï¼šé™„åŠ ç”¨æˆ·ä¿¡æ¯
      notify_url: `${process.env.API_BASE_URL}/api/payment/webhook`,
      amount: {
        total: Math.round(params.amount * 100),  // å…ƒ â†’ åˆ†
        currency: 'CNY'
      }
    };

    const url = '/v3/pay/transactions/native';
    const response = await this.request('POST', url, requestBody);

    // è¿”å›äºŒç»´ç  URL
    return {
      qr_code_url: response.code_url,
      out_trade_no: out_trade_no
    };
  }

  /**
   * ç”Ÿæˆå”¯ä¸€è®¢å•å·
   */
  generateOrderNo() {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2, 8).toUpperCase();
    return `CAMP_${timestamp}_${random}`;
  }
}
```

#### 2. å¤„ç†æ”¯ä»˜å›è°ƒ

```javascript
// src/routes/payment.js

router.post('/webhook', async (req, res) => {
  try {
    // 1. éªŒè¯ç­¾å
    const verified = wechatPaymentService.verifySignature(
      req.headers,
      req.body
    );

    if (!verified) {
      logger.error('å¾®ä¿¡æ”¯ä»˜ç­¾åéªŒè¯å¤±è´¥');
      return res.json({ code: 'FAIL', message: 'ç­¾åéªŒè¯å¤±è´¥' });
    }

    // 2. è§£å¯†æ•°æ®
    const decrypted = wechatPaymentService.decryptData(
      req.body.resource.ciphertext,
      req.body.resource.nonce,
      req.body.resource.associated_data
    );

    const payment = JSON.parse(decrypted);

    // 3. æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
    if (payment.trade_state !== 'SUCCESS') {
      logger.info('æ”¯ä»˜æœªæˆåŠŸ', { trade_state: payment.trade_state });
      return res.json({ code: 'SUCCESS', message: 'å·²æ¥æ”¶' });
    }

    // 4. è§£æ attach è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå…³é”®ï¼‰
    let userInfo = {};
    try {
      userInfo = JSON.parse(payment.attach);
    } catch (e) {
      logger.warn('attach è§£æå¤±è´¥ï¼Œå°†ä½¿ç”¨æ™ºèƒ½åŒ¹é…', { attach: payment.attach });
    }

    // 5. ä¿å­˜æ”¯ä»˜æ˜ å°„
    await paymentMappingService.saveMapping({
      out_trade_no: payment.out_trade_no,
      transaction_id: payment.transaction_id,
      planet_user_id: userInfo.planet_user_id || null,
      planet_nickname: userInfo.planet_nickname || null,
      wechat_nickname: payment.payer?.name || null,
      amount: payment.amount.total,
      checkin_id: userInfo.checkin_id,
      payment_time: payment.success_time
    });

    logger.info('æ”¯ä»˜æ˜ å°„ä¿å­˜æˆåŠŸ', {
      out_trade_no: payment.out_trade_no,
      planet_user_id: userInfo.planet_user_id
    });

    // 6. è¿”å›æˆåŠŸ
    res.json({ code: 'SUCCESS', message: 'æˆåŠŸ' });

  } catch (error) {
    logger.error('æ”¯ä»˜å›è°ƒå¤„ç†å¤±è´¥', error);
    res.json({ code: 'FAIL', message: 'å¤„ç†å¤±è´¥' });
  }
});
```

#### 3. ç”ŸæˆäºŒç»´ç é¡µé¢

```javascript
// src/routes/payment.js

/**
 * ç”Ÿæˆæ”¯ä»˜äºŒç»´ç 
 * GET /api/payment/qrcode?planet_user_id=xxx&checkin_id=xxx
 */
router.get('/qrcode', async (req, res) => {
  try {
    const { planet_user_id, checkin_id } = req.query;

    // å‚æ•°æ ¡éªŒ
    if (!planet_user_id || !checkin_id) {
      return res.status(400).json(
        error('ç¼ºå°‘å¿…éœ€å‚æ•°', 400)
      );
    }

    // è·å–è®­ç»ƒè¥ä¿¡æ¯
    const checkinInfo = await zsxqService.getCheckinInfo(checkin_id);

    // åˆ›å»ºæ”¯ä»˜è®¢å•
    const payment = await wechatPaymentService.createPayment({
      planet_user_id,
      planet_nickname: req.query.planet_nickname || '',
      checkin_id,
      amount: checkinInfo.deposit_amount || 99
    });

    res.json(success({
      qr_code_url: payment.qr_code_url,
      out_trade_no: payment.out_trade_no,
      amount: checkinInfo.deposit_amount
    }, 'æ”¯ä»˜äºŒç»´ç ç”ŸæˆæˆåŠŸ'));

  } catch (err) {
    logger.error('ç”Ÿæˆæ”¯ä»˜äºŒç»´ç å¤±è´¥', err);
    next(err);
  }
});
```

### çŸ¥è¯†æ˜Ÿçƒé›†æˆ

**æ–¹å¼ 1: åœ¨çŸ¥è¯†æ˜Ÿçƒå‘å¸ƒå¸–å­ï¼Œå¸¦ä¸ŠåŠ¨æ€é“¾æ¥**

```
ğŸ“¢ ç¬¬42æœŸæ—©èµ·æ‰“å¡è¥æŠ¥åé€šé“

ğŸ’° æŠ¼é‡‘ï¼š99å…ƒ
ğŸ“… æ—¶é—´ï¼š2025-12-01 ~ 2025-12-21
âœ… å®Œæˆ7å¤©å³å¯é€€æ¬¾

ğŸ‘‰ ç‚¹å‡»é“¾æ¥æŠ¥åï¼š
https://your-domain.com/payment?planet_user_id={ä½ çš„æ˜ŸçƒID}&checkin_id=842448118

âš ï¸ é‡è¦ï¼šè¯·ç¡®è®¤é“¾æ¥ä¸­åŒ…å«ä½ çš„æ˜ŸçƒID
```

**æ–¹å¼ 2: ä½¿ç”¨çŸ¥è¯†æ˜Ÿçƒçš„"è‡ªå®šä¹‰èœå•"åŠŸèƒ½**

åœ¨çŸ¥è¯†æ˜Ÿçƒåå°é…ç½®è‡ªå®šä¹‰èœå•ï¼Œé“¾æ¥æŒ‡å‘ï¼š
```
https://your-domain.com/payment?planet_user_id={{planet_user_id}}&checkin_id=842448118
```

çŸ¥è¯†æ˜Ÿçƒä¼šè‡ªåŠ¨æ›¿æ¢ `{{planet_user_id}}` ä¸ºç”¨æˆ·çš„çœŸå®IDã€‚

**æ–¹å¼ 3: ä½¿ç”¨çŸ­é“¾æ¥æœåŠ¡**

```javascript
// ç”ŸæˆçŸ­é“¾æ¥
const shortUrl = await shortLinkService.create({
  url: `https://your-domain.com/payment?planet_user_id=${planet_user_id}&checkin_id=${checkin_id}`,
  planet_user_id: planet_user_id
});

// çŸ­é“¾æ¥ç¤ºä¾‹ï¼šhttps://s.your-domain.com/p42
```

### ä¼˜åŠ¿

âœ… **å‡†ç¡®ç‡ 100%**ï¼šæ”¯ä»˜ä¸ç”¨æˆ·ç›´æ¥å…³è”
âœ… **è‡ªåŠ¨åŒ–**ï¼šæ— éœ€ç”¨æˆ·å¡«å†™é¢å¤–ä¿¡æ¯
âœ… **ç”¨æˆ·ä½“éªŒå¥½**ï¼šæ‰«ç å³ä»˜ï¼Œæµç¨‹ç®€å•
âœ… **å¯è¿½æº¯**ï¼šæ¯ç¬”æ”¯ä»˜éƒ½æœ‰æ˜ç¡®çš„ç”¨æˆ·æ ‡è¯†

### åŠ£åŠ¿

âš ï¸ **éœ€è¦ç”¨æˆ·ç‚¹å‡»é“¾æ¥**ï¼šä¸èƒ½ä½¿ç”¨å›ºå®šäºŒç»´ç 
âš ï¸ **çŸ¥è¯†æ˜Ÿçƒé™åˆ¶**ï¼šéœ€è¦ç¡®è®¤çŸ¥è¯†æ˜Ÿçƒæ˜¯å¦æ”¯æŒåŠ¨æ€é“¾æ¥

---

## æ–¹æ¡ˆ 2: æ”¯ä»˜åä¿¡æ¯å¡«å†™ â­â­â­â­

### æ ¸å¿ƒæ€è·¯

ç”¨æˆ·æ‰«ç æ”¯ä»˜åï¼Œè·³è½¬åˆ°ä¿¡æ¯å¡«å†™é¡µé¢ï¼Œå¡«å†™æ˜ŸçƒIDå»ºç«‹æ˜ å°„ã€‚

### å®ç°æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant WX as å¾®ä¿¡æ”¯ä»˜
    participant API as åç«¯API
    participant H5 as H5å¡«å†™é¡µé¢
    participant DB as SQLite

    U->>WX: æ‰«å›ºå®šäºŒç»´ç æ”¯ä»˜
    WX->>API: Webhookå›è°ƒ
    API->>DB: ä¿å­˜æ”¯ä»˜è®°å½•<br/>ï¼ˆplanet_user_id=nullï¼‰

    WX-->>U: æ”¯ä»˜æˆåŠŸï¼Œè·³è½¬å¡«å†™é¡µé¢
    U->>H5: æ‰“å¼€å¡«å†™é¡µé¢
    H5->>U: æ˜¾ç¤ºè¡¨å•<br/>ï¼ˆæ˜ŸçƒIDã€æ˜µç§°ï¼‰

    U->>H5: å¡«å†™ä¿¡æ¯å¹¶æäº¤
    H5->>API: POST /api/payment/bind
    API->>DB: æ›´æ–°æ”¯ä»˜æ˜ å°„<br/>ï¼ˆè¡¥å…… planet_user_idï¼‰

    API-->>U: æ˜¾ç¤ºç¾¤äºŒç»´ç 
```

### æŠ€æœ¯å®ç°

#### 1. æ”¯ä»˜å›è°ƒæ—¶è®°å½•å¾…ç»‘å®šè®¢å•

```javascript
router.post('/webhook', async (req, res) => {
  // ... éªŒè¯ç­¾åå’Œè§£å¯† ...

  // ä¿å­˜æ”¯ä»˜è®°å½•ï¼ˆplanet_user_id ä¸º nullï¼‰
  await paymentMappingService.saveMapping({
    out_trade_no: payment.out_trade_no,
    transaction_id: payment.transaction_id,
    planet_user_id: null,  // å¾…ç»‘å®š
    wechat_nickname: payment.payer?.name,
    amount: payment.amount.total,
    checkin_id: extractCheckinIdFromDescription(payment.description),
    payment_time: payment.success_time
  });

  res.json({ code: 'SUCCESS', message: 'æˆåŠŸ' });
});
```

#### 2. ç”¨æˆ·å¡«å†™ä¿¡æ¯ç»‘å®š

```javascript
/**
 * ç»‘å®šæ”¯ä»˜è®¢å•ä¸æ˜Ÿçƒç”¨æˆ·
 * POST /api/payment/bind
 */
router.post('/bind', async (req, res) => {
  try {
    const { out_trade_no, planet_user_id, planet_nickname } = req.body;

    // å‚æ•°æ ¡éªŒ
    if (!out_trade_no || !planet_user_id) {
      return res.status(400).json(error('ç¼ºå°‘å¿…éœ€å‚æ•°', 400));
    }

    // æŸ¥è¯¢æ”¯ä»˜è®°å½•
    const payment = await paymentMappingService.getByOrderNo(out_trade_no);

    if (!payment) {
      return res.status(404).json(error('æ”¯ä»˜è®°å½•ä¸å­˜åœ¨', 404));
    }

    if (payment.planet_user_id) {
      return res.status(400).json(error('è¯¥è®¢å•å·²ç»‘å®š', 400));
    }

    // æ›´æ–°ç»‘å®šå…³ç³»
    await paymentMappingService.bindUser({
      out_trade_no,
      planet_user_id,
      planet_nickname
    });

    logger.info('æ”¯ä»˜è®¢å•ç»‘å®šæˆåŠŸ', { out_trade_no, planet_user_id });

    res.json(success({}, 'ç»‘å®šæˆåŠŸ'));

  } catch (err) {
    logger.error('ç»‘å®šå¤±è´¥', err);
    next(err);
  }
});
```

#### 3. H5 å¡«å†™é¡µé¢

```vue
<template>
  <div class="bind-page">
    <div class="header">
      <h2>âœ… æ”¯ä»˜æˆåŠŸ</h2>
      <p>è¯·å¡«å†™æ‚¨çš„çŸ¥è¯†æ˜Ÿçƒä¿¡æ¯ï¼Œä»¥ä¾¿é€€æ¬¾</p>
    </div>

    <el-form :model="form" :rules="rules" ref="formRef">
      <el-form-item label="è®¢å•å·" prop="out_trade_no">
        <el-input v-model="form.out_trade_no" disabled />
      </el-form-item>

      <el-form-item label="æ”¯ä»˜é‡‘é¢">
        <el-input :value="`Â¥${amount}`" disabled />
      </el-form-item>

      <el-form-item label="çŸ¥è¯†æ˜ŸçƒID" prop="planet_user_id" required>
        <el-input
          v-model="form.planet_user_id"
          placeholder="è¯·è¾“å…¥æ‚¨çš„æ˜Ÿçƒç”¨æˆ·ID"
        />
        <div class="help-text">
          åœ¨çŸ¥è¯†æ˜ŸçƒAPP â†’ æˆ‘çš„ â†’ ç‚¹å‡»å¤´åƒå³å¯çœ‹åˆ°
        </div>
      </el-form-item>

      <el-form-item label="æ˜Ÿçƒæ˜µç§°" prop="planet_nickname" required>
        <el-input
          v-model="form.planet_nickname"
          placeholder="è¯·è¾“å…¥æ‚¨çš„æ˜Ÿçƒæ˜µç§°"
        />
      </el-form-item>

      <el-button type="primary" @click="handleSubmit" :loading="loading">
        ç¡®è®¤å¹¶è·å–ç¾¤äºŒç»´ç 
      </el-button>
    </el-form>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import { bindPayment } from '@/api/payment';

const route = useRoute();
const router = useRouter();

const form = ref({
  out_trade_no: route.query.out_trade_no || '',
  planet_user_id: '',
  planet_nickname: ''
});

const loading = ref(false);

async function handleSubmit() {
  try {
    loading.value = true;
    await bindPayment(form.value);

    // è·³è½¬åˆ°ç¾¤äºŒç»´ç é¡µé¢
    router.push(`/qrcode?out_trade_no=${form.value.out_trade_no}`);

  } catch (error) {
    console.error('ç»‘å®šå¤±è´¥', error);
  } finally {
    loading.value = false;
  }
}
</script>
```

### ä¼˜åŠ¿

âœ… **å®ç°ç®€å•**ï¼šæ— éœ€åŠ¨æ€äºŒç»´ç 
âœ… **å…¼å®¹å›ºå®šäºŒç»´ç **ï¼šå¯ä»¥æ‰“å°å¼ è´´
âœ… **å‡†ç¡®ç‡é«˜**ï¼šç”¨æˆ·ä¸»åŠ¨å¡«å†™ï¼Œ95%+ å‡†ç¡®ç‡

### åŠ£åŠ¿

âš ï¸ **ç”¨æˆ·ä½“éªŒä¸€èˆ¬**ï¼šéœ€è¦é¢å¤–å¡«å†™æ­¥éª¤
âš ï¸ **å¯èƒ½é—æ¼**ï¼šç”¨æˆ·æ”¯ä»˜åå¯èƒ½ä¸å¡«å†™
âš ï¸ **éœ€è¦å¼•å¯¼**ï¼šéœ€è¦æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·å¡«å†™

### æ”¹è¿›æªæ–½

1. **è®¾ç½®å¡«å†™æœŸé™**ï¼š7å¤©å†…æœªå¡«å†™è‡ªåŠ¨é€€æ¬¾
2. **å¤šæ¬¡æé†’**ï¼šé€šè¿‡çŸ¥è¯†æ˜Ÿçƒç§ä¿¡æé†’
3. **ç®€åŒ–æµç¨‹**ï¼šè‡ªåŠ¨è¯†åˆ«å¾®ä¿¡æ˜µç§°ï¼Œç”¨æˆ·åªéœ€ç¡®è®¤

---

## æ–¹æ¡ˆ 3: çº¯æ™ºèƒ½åŒ¹é… â­â­â­

### æ ¸å¿ƒæ€è·¯

å®Œå…¨ä¾èµ–æ™ºèƒ½åŒ¹é…ç®—æ³•ï¼Œé€šè¿‡å¾®ä¿¡æ˜µç§°ã€æ”¯ä»˜æ—¶é—´ç­‰ä¿¡æ¯åŒ¹é…ã€‚

### å®ç°è¦ç‚¹

è¯¦è§ [æ··åˆæ–¹æ¡ˆæŠ€æœ¯è®¾è®¡.md](./19-v0.2-æ··åˆæ–¹æ¡ˆæŠ€æœ¯è®¾è®¡.md) ä¸­çš„æ™ºèƒ½åŒ¹é…ç®—æ³•ã€‚

### ä¼˜åŠ¿

âœ… **ç”¨æˆ·ä½“éªŒæœ€å¥½**ï¼šæ— éœ€ä»»ä½•é¢å¤–æ“ä½œ
âœ… **å…¼å®¹æ€§æœ€å¥½**ï¼šé€‚ç”¨äºä»»ä½•æ”¯ä»˜åœºæ™¯

### åŠ£åŠ¿

âš ï¸ **å‡†ç¡®ç‡ä½**ï¼š60-80%ï¼Œéœ€è¦å¤§é‡äººå·¥å®¡æ ¸
âš ï¸ **ä¾èµ–æ˜µç§°**ï¼šå¦‚æœæ˜µç§°å·®å¼‚å¤§åˆ™æ— æ³•åŒ¹é…

---

## æ–¹æ¡ˆ 4: äººå·¥å½•å…¥ â­â­

### æ ¸å¿ƒæ€è·¯

ç®¡ç†å‘˜åœ¨åå°æ‰‹åŠ¨å½•å…¥æ”¯ä»˜è®¢å•ä¸ç”¨æˆ·çš„æ˜ å°„å…³ç³»ã€‚

### å®ç°

```javascript
/**
 * äººå·¥ç»‘å®š
 * POST /api/payment/manual-bind
 */
router.post('/manual-bind', async (req, res) => {
  const { out_trade_no, planet_user_id, planet_nickname } = req.body;

  await paymentMappingService.bindUser({
    out_trade_no,
    planet_user_id,
    planet_nickname
  });

  logger.info('äººå·¥ç»‘å®šæˆåŠŸ', { out_trade_no, planet_user_id, operator: req.user.id });

  res.json(success({}, 'ç»‘å®šæˆåŠŸ'));
});
```

### ä¼˜åŠ¿

âœ… **å‡†ç¡®ç‡ 100%**ï¼šäººå·¥æ ¸å¯¹
âœ… **å…œåº•æ–¹æ¡ˆ**ï¼šå…¶ä»–æ–¹æ¡ˆå¤±è´¥æ—¶ä½¿ç”¨

### åŠ£åŠ¿

âš ï¸ **æ•ˆç‡ä½**ï¼šéœ€è¦é€ä¸ªå¤„ç†
âš ï¸ **äººåŠ›æˆæœ¬é«˜**ï¼šä¸é€‚åˆå¤§è§„æ¨¡ä½¿ç”¨

---

## ğŸ’¡ æœ€ä½³å®è·µï¼šæ··åˆä½¿ç”¨

### æ¨èç»„åˆ

```
ä¸»æ–¹æ¡ˆï¼šæ–¹æ¡ˆ1ï¼ˆåŠ¨æ€äºŒç»´ç ï¼‰
      â†“ å¦‚æœç”¨æˆ·ä¸èµ°æ­£å¸¸æµç¨‹
å¤‡é€‰æ–¹æ¡ˆï¼šæ–¹æ¡ˆ2ï¼ˆæ”¯ä»˜åå¡«å†™ï¼‰
      â†“ å¦‚æœç”¨æˆ·æ²¡å¡«å†™
å…œåº•æ–¹æ¡ˆï¼šæ–¹æ¡ˆ3ï¼ˆæ™ºèƒ½åŒ¹é…ï¼‰+ æ–¹æ¡ˆ4ï¼ˆäººå·¥å¤„ç†ï¼‰
```

### å®æ–½æ­¥éª¤

#### é˜¶æ®µ 1: å®ç°åŠ¨æ€äºŒç»´ç ï¼ˆä¼˜å…ˆï¼‰

- çŸ¥è¯†æ˜Ÿçƒå‘å¸ƒæŠ¥åå¸–ï¼Œå¸¦åŠ¨æ€é“¾æ¥
- ç”Ÿæˆå¸¦ planet_user_id çš„æ”¯ä»˜äºŒç»´ç 
- æ”¯ä»˜å›è°ƒè‡ªåŠ¨å»ºç«‹æ˜ å°„

#### é˜¶æ®µ 2: å¢åŠ æ”¯ä»˜åå¡«å†™ï¼ˆå¤‡é€‰ï¼‰

- å¯¹äºç›´æ¥æ‰«å›ºå®šç æ”¯ä»˜çš„ç”¨æˆ·
- æ”¯ä»˜æˆåŠŸåè·³è½¬å¡«å†™é¡µé¢
- 7å¤©å†…æœªå¡«å†™è‡ªåŠ¨é€€æ¬¾

#### é˜¶æ®µ 3: æ™ºèƒ½åŒ¹é… + äººå·¥å®¡æ ¸ï¼ˆå…œåº•ï¼‰

- å¯¹äºä»æœªå»ºç«‹æ˜ å°„çš„ç”¨æˆ·
- ä½¿ç”¨æ™ºèƒ½åŒ¹é…ç®—ï¿½ï¿½
- ä½ç½®ä¿¡åº¦çš„äººå·¥å®¡æ ¸

### é¢„æœŸæ•ˆæœ

| æ–¹æ¡ˆ | è¦†ç›–æ¯”ä¾‹ | å‡†ç¡®ç‡ |
|------|---------|--------|
| åŠ¨æ€äºŒç»´ç  | 80% | 100% |
| æ”¯ä»˜åå¡«å†™ | 15% | 95% |
| æ™ºèƒ½åŒ¹é… | 4% | 70% |
| äººå·¥å¤„ç† | 1% | 100% |

---

## ğŸ”§ é…ç½®ç¤ºä¾‹

### ç¯å¢ƒå˜é‡

```env
# åŠ¨æ€äºŒç»´ç é…ç½®
PAYMENT_QRCODE_BASE_URL=https://your-domain.com/payment

# æ”¯ä»˜åå¡«å†™é…ç½®
PAYMENT_BIND_REQUIRED=true
PAYMENT_BIND_DEADLINE_DAYS=7

# æ™ºèƒ½åŒ¹é…é…ç½®
SMART_MATCH_ENABLED=true
SMART_MATCH_CONFIDENCE_THRESHOLD=50
```

### çŸ¥è¯†æ˜ŸçƒæŠ¥åå¸–æ¨¡æ¿

```markdown
# ğŸ”¥ ç¬¬42æœŸæ—©èµ·æ‰“å¡è¥æŠ¥åå¼€å§‹ï¼

## æ´»åŠ¨è§„åˆ™
- æŠ¼é‡‘ï¼š99å…ƒ
- æ—¶é—´ï¼š2025-12-01 ~ 2025-12-21ï¼ˆ21å¤©ï¼‰
- å®Œæˆ7å¤©æ‰“å¡å³å¯å…¨é¢é€€æ¬¾

## æŠ¥åæ–¹å¼

### æ–¹å¼ä¸€ï¼šæ¨èâ­â­â­â­â­
ç‚¹å‡»ä¸“å±é“¾æ¥æŠ¥åï¼ˆè‡ªåŠ¨ç»‘å®šï¼‰ï¼š
https://your-domain.com/payment?planet_user_id={{ä½ çš„æ˜ŸçƒID}}&checkin_id=842448118

ğŸ“Œ å¦‚ä½•è·å–ä½ çš„æ˜ŸçƒIDï¼š
çŸ¥è¯†æ˜ŸçƒAPP â†’ æˆ‘çš„ â†’ ç‚¹å‡»å¤´åƒ â†’ é•¿æŒ‰å¤åˆ¶ID

### æ–¹å¼äºŒï¼šç›´æ¥æ‰«ç 
[æ”¯ä»˜äºŒç»´ç å›¾ç‰‡]

âš ï¸ æ‰«ç åè¯·åŠ¡å¿…å¡«å†™æ˜ŸçƒIDï¼Œï¿½ï¿½ï¿½åˆ™æ— æ³•é€€æ¬¾ï¼

---

æœ‰é—®é¢˜è¯·è”ç³»ç®¡ç†å‘˜ @æ˜Ÿä¸»
```

---

## ğŸ“Š æ•°æ®åº“è°ƒæ•´

éœ€è¦åœ¨ `payment_mapping` è¡¨ä¸­å¢åŠ å­—æ®µï¼š

```sql
ALTER TABLE payment_mapping ADD COLUMN bind_status TEXT DEFAULT 'pending';
-- å€¼: pending | completed | expired

ALTER TABLE payment_mapping ADD COLUMN bind_deadline DATETIME;
-- ç»‘å®šæˆªæ­¢æ—¶é—´

ALTER TABLE payment_mapping ADD COLUMN bind_method TEXT;
-- å€¼: dynamic_qrcode | user_fill | smart_match | manual
```

---

## ç›¸å…³æ–‡æ¡£

- [æ··åˆæ–¹æ¡ˆæŠ€æœ¯è®¾è®¡.md](./19-v0.2-æ··åˆæ–¹æ¡ˆæŠ€æœ¯è®¾è®¡.md) - å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆ
- [ç”¨æˆ·æ—…ç¨‹å›¾.md](./18-v0.2-ç”¨æˆ·æ—…ç¨‹å›¾.md) - ç”¨æˆ·æµç¨‹å›¾
- [æ•°æ®åº“è®¾è®¡.md](./æ•°æ®åº“è®¾è®¡.md) - æ•°æ®åº“è®¾è®¡