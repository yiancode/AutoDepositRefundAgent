# v0.1 开发前准备清单

**创建时间**: 2025-11-02
**状态**: 待准备

---

## ✅ 确认信息

根据用户提供的微信支付商户平台截图：

- ✅ 有正式微信支付商户号
- ✅ 已开通 JSAPI 支付、Native 支付
- ✅ 有 API 安全配置权限
- ✅ 支付方式为扫码支付（Native 支付）

**结论**: 完全支持 API 退款功能！

---

## 📦 需要准备的材料

### 1️⃣ 商户基本信息（从商户平台获取）

#### 获取路径：商户平台首页 → 账户中心 → 商户信息

需要获取：

| 信息项 | 说明 | 示例 | 用途 |
|-------|------|------|------|
| **商户号** | 微信支付分配的商户号 | 1234567890 | API 调用身份标识 |
| **商户名称** | 商户全称 | XX科技有限公司 | 日志记录 |
| **商家简称** | 显示在支付界面的名称 | XX教育 | 用户识别 |

**操作步骤**:
```
1. 登录 https://pay.weixin.qq.com
2. 点击右上角账户名 → "商户信息"
3. 复制"商户号"（10位数字）
4. 记录下来备用
```

---

### 2️⃣ API 证书（核心必需）

#### 获取路径：账户中心 → API 安全 → 管理证书

需要下载 3 个文件：

| 文件 | 文件名 | 说明 |
|------|--------|------|
| **商户 API 证书** | `apiclient_cert.pem` | 公钥证书 |
| **商户私钥** | `apiclient_key.pem` | 私钥文件（重要！） |
| **证书序列号** | - | 配置时需要填写 |

**操作步骤**:

```
步骤 1: 下载证书工具
1. 登录 https://pay.weixin.qq.com
2. 账户中心 → API安全 → 申请API证书
3. 下载"证书工具"（Windows/Mac 版本）

步骤 2: 生成证书
1. 运行证书工具
2. 输入商户号
3. 登录商户平台扫码验证
4. 工具自动生成证书文件：
   - apiclient_cert.pem
   - apiclient_key.pem
   - apiclient_cert.p12

步骤 3: 获取证书序列号
方法 A: 使用工具查看
- 工具会直接显示证书序列号

方法 B: 在商户平台查看
- API安全 → 查看证书 → 复制序列号

步骤 4: 保存文件
- 将 apiclient_cert.pem 和 apiclient_key.pem 保存到本地
- 妥善保管，不要泄露！
```

**重要提示**:
- ⚠️ **私钥文件绝对不能泄露！**
- ⚠️ **不要提交到 Git 仓库！**
- ⚠️ **证书有效期 5 年，到期需重新生成**

---

### 3️⃣ API v3 密钥（用于签名）

#### 获取路径：账户中心 → API 安全 → 设置APIv3密钥

**操作步骤**:

```
1. 登录 https://pay.weixin.qq.com
2. 账户中心 → API安全 → 设置APIv3密钥
3. 点击"设置密钥"
4. 输入 32 位字符串作为密钥（自定义）

推荐生成方式:
方法 A: 在线生成随机字符串
- 访问 https://www.random.org/strings/
- 生成 32 位字母数字混合字符串

方法 B: 使用命令行生成
- macOS/Linux:
  openssl rand -base64 32 | head -c 32

- 示例: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6

5. 复制并保存（只显示一次！）
6. 填写到商户平台并确认
```

**重要提示**:
- ⚠️ **密钥只显示一次，务必保存好**
- ⚠️ **密钥不能找回，丢失需重新设置**
- ⚠️ **不要使用简单密码**

---

### 4️⃣ 支付授权目录（可选，暂时不需要）

如果未来要做 H5 支付，需要配置授权目录。

目前扫码退款不需要此配置，**跳过**。

---

### 5️⃣ 环境变量配置文件

将上述信息整理到 `.env` 文件：

```env
# ========================
# v0.1 企业微信退款配置
# ========================

# 微信支付商户号
WECHAT_MCHID=1234567890

# API v3 密钥（32位）
WECHAT_APIV3_KEY=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6

# 证书序列号
WECHAT_SERIAL_NO=1234567890ABCDEF1234567890ABCDEF12345678

# 证书文件路径（相对路径或绝对路径）
WECHAT_CERT_PATH=./certs/apiclient_cert.pem
WECHAT_KEY_PATH=./certs/apiclient_key.pem

# 商户名称（用于日志）
WECHAT_MCH_NAME=XX教育

# ========================
# 原有的知识星球配置（保留）
# ========================
ZSXQ_GROUP_ID=15555411412112
ZSXQ_X_TIMESTAMP=1730000000
ZSXQ_AUTHORIZATION=Bearer xxx
ZSXQ_X_SIGNATURE=xxx

# 打卡天数宽限配置
GRACE_DAYS=1
```

---

## 📂 证书文件存储结构

在项目根目录创建证书文件夹：

```
zsxq-api/
├── certs/                         # 证书文件夹（不提交到 Git）
│   ├── apiclient_cert.pem         # 商户 API 证书
│   ├── apiclient_key.pem          # 商户私钥
│   └── .gitkeep                   # 保留文件夹
├── .env                           # 环境变量（不提交到 Git）
└── .gitignore                     # 确保 certs/ 和 .env 被忽略
```

**更新 .gitignore**:

```gitignore
# 证书文件（敏感）
certs/
*.pem
*.p12

# 环境变量（敏感）
.env
.env.local
.env.production

# API 密钥（敏感）
*apikey*
*secret*
```

---

## ✅ 准备完成检查清单

完成以下检查后即可开始开发：

- [ ] **商户号**: 已获取 10 位商户号 (1234567890)
- [ ] **API 证书**: 已下载 `apiclient_cert.pem` 和 `apiclient_key.pem`
- [ ] **证书序列号**: 已复制保存
- [ ] **API v3 密钥**: 已设置 32 位密钥
- [ ] **证书存储**: 已创建 `zsxq-api/certs/` 文件夹并放入证书
- [ ] **.env 配置**: 已更新环境变量配置
- [ ] **.gitignore**: 已添加证书和密钥的忽略规则
- [ ] **测试访问**: 已确认可以登录商户平台

---

## 🔐 安全注意事项

1. **证书保护**:
   - ❌ 绝对不要提交到 Git
   - ❌ 不要通过邮件/聊天工具发送
   - ✅ 使用加密的方式传输（如 1Password、LastPass）
   - ✅ 本地文件权限设置为 600（仅所有者可读写）

2. **密钥保护**:
   - ❌ 不要硬编码到代码中
   - ❌ 不要打印到日志
   - ✅ 使用环境变量存储
   - ✅ 生产环境使用密钥管理服务

3. **访问权限**:
   - 仅授权人员可访问商户平台
   - 定期更换 API 密钥（建议每年一次）

---

## 📞 遇到问题？

### 问题 1: 找不到"管理证书"按钮

**原因**: 账号权限不足

**解决方案**:
- 联系商户号管理员添加"API 安全"权限
- 或使用超级管理员账号操作

---

### 问题 2: 证书工具无法运行

**原因**: 系统环境问题

**解决方案**:
- Windows: 右键 → 以管理员身份运行
- macOS: 系统偏好设置 → 安全性与隐私 → 允许运行

---

### 问题 3: 忘记 API v3 密钥

**解决方案**:
- 密钥无法找回，只能重新设置
- 账户中心 → API安全 → 重新设置APIv3密钥

---

## 🎯 下一步

准备完成后，开始开发：

1. 安装依赖: `npm install wechatpay-node-v3 uuid fs-extra`
2. 创建退款服务: `src/services/wework-pay.service.js`
3. 测试 API 连接: 调用查询订单接口验证配置

---

**准备完成后，请告知我即可开始 v0.1 开发！**