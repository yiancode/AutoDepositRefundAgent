# 业务流程图

> **文档版本**: v1.1
> **最后更新**: 2025-12-06
> **SSOT引用**: [状态枚举定义.md](../design/状态枚举定义.md) - 流程中涉及的 bind_status、pay_status 等状态值

本文档展示知识星球训练营自动押金退款系统的核心业务流程。

---

## 一、训练营全生命周期流程

```mermaid
flowchart TB
    subgraph 准备阶段
        A1[创建训练营] --> A2[配置打卡要求]
        A2 --> A3[设置押金金额]
        A3 --> A4[生成报名链接]
        A4 --> A5[发布训练营]
    end

    subgraph 报名阶段
        B1[会员扫码] --> B2[填写报名信息]
        B2 --> B3[支付押金]
        B3 --> B4[获取群二维码]
        B4 --> B5[加入训练营群]
    end

    subgraph 进行阶段
        C1[每日打卡提醒] --> C2[会员打卡]
        C2 --> C3[打卡数据同步]
        C3 --> C4[进度统计更新]
        C4 --> C1
    end

    subgraph 结算阶段
        D1[训练营结束] --> D2[获取打卡数据]
        D2 --> D3[计算合格名单]
        D3 --> D4[匹配支付记录]
        D4 --> D5[生成退款名单]
        D5 --> D6[管理员审核]
        D6 --> D7[执行退款]
        D7 --> D8[通知会员]
    end

    A5 --> B1
    B5 --> C1
    C4 -.->|训练营结束| D1
```

---

## 二、会员报名支付流程（混合方案）

> 采用**OAuth绑定 + 支付后信息填写**混合方案，覆盖率与准确率最优

### 2.1 支付方式选择

> **设计说明**：H5 主路径与降级路径互斥，同一用户只会走其中一条路径。

```mermaid
flowchart TD
    A[会员准备报名] --> B{支付入口}

    B -->|H5 报名链接| C[H5 主路径<br/>80%用户]
    B -->|扫固定收款码| D[降级路径<br/>15%用户]

    C --> E[自动建立映射<br/>准确率100%]
    D --> F[用户填写绑定<br/>准确率95%]

    E --> G[显示群二维码]
    F --> G

    D -.->|超时未绑定| H[人工审核<br/>5%用户]
    H --> I[管理员处理<br/>准确率100%]
```

### 2.2 H5主路径支付流程（推荐路径）

```mermaid
flowchart TD
    A["会员点击报名链接
    含 planet_user_id"] --> B[进入 H5 报名页面]
    B --> C[显示训练营详情]
    C --> D["填写补充信息
    确认星球昵称"]

    D --> E{信息校验}
    E -->|校验失败| F[显示错误提示]
    F --> D

    E -->|校验通过| G[点击支付按钮]
    G --> H["生成支付订单
    attach 含用户ID和昵称"]
    H --> I[调用微信支付]

    I --> J{支付结果}
    J -->|支付成功| K[接收 Webhook 回调]
    J -->|支付取消| L[返回报名页]
    J -->|支付失败| M[显示失败原因]

    K --> N[验证签名]
    N --> O{签名验证}
    O -->|失败| P[记录告警日志]
    O -->|成功| Q[解析 attach 字段]

    Q --> R["保存支付映射
    bind_status: completed
    bind_method: h5_bindplanet"]
    R --> S[更新订单状态]
    S --> T[显示群二维码]
    T --> U[会员扫码进群]

    M --> V{是否重试}
    V -->|是| G
    V -->|否| L

    L --> W[保留已填信息]
```

### 2.3 支付后信息填写流程（固定二维码用户）

```mermaid
flowchart TD
    A[会员扫固定收款码] --> B[微信支付]
    B --> C{支付结果}

    C -->|支付成功| D[Webhook 回调]
    C -->|支付失败| E[支付失败提示]

    D --> F["保存支付记录
    planet_user_id: null
    bind_status: pending"]
    F --> G["设置绑定截止时间
    7天后过期"]
    G --> H[跳转 H5 绑定页面]

    H --> I[显示绑定表单]
    I --> J[会员填写星球ID和昵称]
    J --> K{信息校验}

    K -->|校验失败| L[显示错误提示]
    L --> J

    K -->|校验通过| M[调用绑定接口]
    M --> N["更新支付映射
    bind_status: completed
    bind_method: user_fill"]
    N --> O[显示群二维码]
    O --> P[会员扫码进群]

    subgraph 绑定超时处理
        Q[定时任务检查] --> R{是否超过7天}
        R -->|是| S["更新 bind_status: expired"]
        S --> T["转入人工审核
        bind_status: manual_review"]
    end
```

### 2.4 报名信息校验规则

```mermaid
flowchart TD
    A[接收报名信息] --> B{星球昵称校验}
    B -->|为空| C[返回: 请输入星球昵称]
    B -->|通过| D{星球ID校验}

    D -->|为空| E[返回: 请输入星球ID]
    D -->|格式错误| F[返回: 星球ID格式不正确]
    D -->|通过| G{微信昵称校验}

    G -->|为空| H[返回: 请输入微信昵称]
    G -->|通过| I{重复报名检查}

    I -->|已报名| J[返回: 您已报名该训练营]
    I -->|未报名| K[校验通过]

    K --> L[进入支付流程]
```

---

## 三、打卡数据同步流程

### 3.1 定时同步流程

```mermaid
flowchart TD
    A[定时任务触发<br/>每日 01:00] --> B[获取进行中的训练营列表]

    B --> C{是否有训练营}
    C -->|无| D[记录日志并结束]
    C -->|有| E[遍历训练营]

    E --> F[调用知识星球 API]
    F --> G{API 响应}

    G -->|成功| H[解析打卡数据]
    G -->|失败| I{重试次数}

    I -->|< 3次| J[等待后重试]
    J --> F
    I -->|>= 3次| K[标记同步失败]
    K --> L[发送告警通知]

    H --> M[计算打卡统计]
    M --> N[更新数据库]
    N --> O[记录同步日志]

    O --> P{是否有下一个}
    P -->|是| E
    P -->|否| Q[同步完成]

    L --> P
```

### 3.2 打卡数据处理流程

```mermaid
flowchart TD
    A[接收 API 返回数据] --> B[解析 JSON 响应]

    B --> C{是否需要翻页}
    C -->|是| D[获取下一页数据]
    D --> B
    C -->|否| E[合并所有数据]

    E --> F[遍历打卡记录]
    F --> G[提取用户信息]
    G --> H[提取打卡天数]

    H --> I[应用宽限规则]
    I --> J[实际打卡天数 = API天数 + GRACE_DAYS]

    J --> K[判断是否合格]
    K --> L{打卡天数 >= 要求天数}

    L -->|是| M[标记为合格]
    L -->|否| N[标记为不合格]

    M --> O[加入合格列表]
    N --> P[加入不合格列表]

    O --> Q{是否有下一条}
    P --> Q
    Q -->|是| F
    Q -->|否| R[返回处理结果]
```

---

## 四、退款审核流程

> **设计说明**：不使用智能匹配，仅已绑定用户可自动退款，未绑定用户需人工处理。

### 4.1 退款名单生成流程

```mermaid
flowchart TD
    A[管理员点击<br/>生成退款名单] --> B[获取训练营信息]

    B --> C{训练营状态}
    C -->|进行中| D[返回: 训练营未结束]
    C -->|已结束| E[获取打卡数据]

    E --> F[计算合格用户]
    F --> G[检查支付记录绑定状态]

    G --> H{bind_status?}
    H -->|completed| I[已绑定: 加入退款名单]
    H -->|pending| J{超过7天?}
    H -->|expired/manual_review| K[转人工审核]

    J -->|否| L[继续等待用户绑定]
    J -->|是| M[更新为 expired]
    M --> K

    I --> N[生成退款名单]
    K --> O[生成人工处理列表]

    N --> P[返回结果统计]
    O --> P
```

### 4.2 审核与执行流程

```mermaid
flowchart TD
    A[管理员进入审核页面] --> B[查看退款名单]

    B --> C{选择操作}
    C -->|查看详情| D[显示匹配明细]
    C -->|批量审核| E[选择多条记录]
    C -->|单条审核| F[选择单条记录]

    D --> G{审核决定}
    E --> G
    F --> G

    G -->|通过| H[标记审核通过]
    G -->|拒绝| I[填写拒绝原因]

    H --> J[加入待退款队列]
    I --> K[记录拒绝原因]
    K --> L[通知相关人员]

    J --> M[调用退款 API]
    M --> N{退款结果}

    N -->|成功| O[更新退款状态]
    N -->|失败| P{失败原因}

    P -->|余额不足| Q[暂停并告警]
    P -->|其他错误| R{重试次数}

    R -->|< 3次| S[等待后重试]
    S --> M
    R -->|>= 3次| T[标记失败]
    T --> U[加入人工处理]

    O --> V[发送退款通知]
    V --> W[更新统计数据]
```

---

## 五、异常处理流程

### 5.1 支付异常处理

```mermaid
flowchart TD
    A[支付异常发生] --> B{异常类型}

    B -->|网络超时| C[显示超时提示]
    B -->|余额不足| D[提示充值]
    B -->|支付取消| E[返回报名页]
    B -->|系统错误| F[显示客服联系方式]

    C --> G{用户选择}
    G -->|重试| H[重新发起支付]
    G -->|取消| E

    D --> I{用户选择}
    I -->|去充值| J[跳转充值页]
    I -->|取消| E

    E --> K[保留用户信息]
    K --> L[等待用户再次操作]

    F --> M[记录异常日志]
    M --> N[发送告警]
```

### 5.2 同步异常处理

```mermaid
flowchart TD
    A[同步异常发生] --> B{异常类型}

    B -->|Cookie 过期| C[发送更新提醒]
    B -->|API 限流| D[延迟重试]
    B -->|网络错误| E[立即重试]
    B -->|数据格式错误| F[记录并跳过]

    C --> G[暂停同步任务]
    G --> H[等待 Cookie 更新]
    H --> I[恢复同步]

    D --> J[等待 N 秒]
    J --> K[重试请求]

    E --> L{重试次数}
    L -->|< 3| K
    L -->|>= 3| M[标记同步失败]

    F --> N[记录异常数据]
    N --> O[继续处理下一条]

    M --> P[发送告警通知]
```

### 5.3 退款异常处理

```mermaid
flowchart TD
    A[退款异常发生] --> B{异常类型}

    B -->|商户余额不足| C[暂停所有退款]
    B -->|订单不存在| D[标记为无效]
    B -->|已退款| E[更新状态为已退款]
    B -->|退款金额超限| F[调整金额重试]
    B -->|系统错误| G[延迟重试]

    C --> H[发送紧急告警]
    H --> I[通知财务充值]
    I --> J[等待恢复]
    J --> K[继续退款队列]

    D --> L[从退款列表移除]
    L --> M[记录异常原因]

    E --> N[跳过处理]

    F --> O{调整后金额}
    O -->|有效| P[重新发起]
    O -->|无效| Q[标记失败]

    G --> R{重试次数}
    R -->|< 3| S[等待后重试]
    R -->|>= 3| T[标记失败]
    T --> U[加入人工处理]
```

---

## 六、统计报表流程

```mermaid
flowchart TD
    A[管理员进入报表页] --> B[选择统计维度]

    B --> C{统计类型}
    C -->|训练营统计| D[查询训练营数据]
    C -->|退款统计| E[查询退款数据]
    C -->|时间趋势| F[查询时间序列]

    D --> G[计算报名人数]
    D --> H[计算完成率]
    D --> I[计算退款率]

    E --> J[计算退款金额]
    E --> K[计算成功率]
    E --> L[计算平均时长]

    F --> M[按日/周/月聚合]

    G --> N[生成可视化图表]
    H --> N
    I --> N
    J --> N
    K --> N
    L --> N
    M --> N

    N --> O{导出操作}
    O -->|导出 Excel| P[生成 Excel 文件]
    O -->|导出 PDF| Q[生成 PDF 报告]
    O -->|仅查看| R[显示报表页面]
```

---

## 相关文档

- [用户旅程图](./用户旅程图.md)
- [时序图](./时序图.md)
- [状态机](./状态机.md)
- [架构设计图](./架构设计图.md)

---

**变更历史**：
| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v1.1 | 2025-12-06 | 添加 SSOT 引用、版本信息、变更历史 |
| v1.0 | 2025-11-xx | 初始版本 |
