# EP03: 打卡数据同步

## Epic 概述

| 字段 | 内容 |
|------|------|
| **Epic ID** | EP03 |
| **Epic 名称** | 打卡数据同步 |
| **业务目标** | 系统能够自动同步知识星球的打卡数据 |
| **涉及角色** | 系统、管理员 |
| **优先级** | P0 |

---

## Story 3.1: 定时自动同步

| 字段 | 内容 |
|------|------|
| **Story ID** | S3.1 |
| **角色** | 作为系统 |
| **目标** | 我需要每日自动同步打卡数据 |
| **价值** | 以便于保持打卡统计的准确性 |
| **优先级** | P0 |

### 验收标准

```gherkin
Feature: 定时自动同步
  作为系统
  我需要每日自动同步打卡数据
  以便于保持打卡统计的准确性

  Background:
    Given 存在进行中的训练营
    And 知识星球 Cookie 有效

  Scenario: 正常同步
    Given 定时任务触发（每日 01:00）
    When 执行同步任务
    Then 调用知识星球 API 获取打卡数据
    And 更新会员打卡天数
    And 记录同步日志
    And 同步成功率 100%

  Scenario: API 调用失败后重试
    Given 知识星球 API 调用失败
    When 自动重试（最多3次）
    And 第2次重试成功
    Then 同步成功完成
    And 记录重试日志

  Scenario: 重试全部失败
    Given 知识星球 API 连续调用失败 3 次
    When 重试全部失败
    Then 标记同步失败
    And 发送告警通知到企业微信
    And 记录失败原因

  Scenario: Cookie 过期
    Given 知识星球返回 401/403
    When 识别为 Cookie 过期
    Then 暂停同步任务
    And 发送紧急告警
    And 提示管理员更新 Cookie

  Scenario: 数据翻页处理
    Given 训练营参与人数超过 100 人
    When 执行同步
    Then 自动翻页获取全部数据
    And 合并所有页的打卡记录
```

### 任务拆分

- [ ] Task 3.1.1: 实现定时任务配置
- [ ] Task 3.1.2: 实现知识星球 API 调用
- [ ] Task 3.1.3: 实现翻页逻辑
- [ ] Task 3.1.4: 实现重试机制
- [ ] Task 3.1.5: 实现告警通知
- [ ] Task 3.1.6: 编写单元测试
- [ ] Task 3.1.7: 编写集成测试

---

## Story 3.2: 手动触发同步

| 字段 | 内容 |
|------|------|
| **Story ID** | S3.2 |
| **角色** | 作为一名管理员 |
| **目标** | 我希望能够手动触发打卡数据同步 |
| **价值** | 以便于在需要时获取最新数据 |
| **优先级** | P1 |

### 验收标准

```gherkin
Feature: 手动触发同步
  作为一名管理员
  我希望能够手动触发打卡数据同步
  以便于在需要时获取最新数据

  Background:
    Given 管理员已登录
    And 管理员具有同步权限

  Scenario: 成功触发同步
    Given 选择训练营 "21天早起打卡"
    When 点击 "同步打卡数据" 按钮
    Then 显示同步进度
    And 同步完成后显示结果
    And 显示更新的记录数

  Scenario: 频繁触发限制
    Given 5分钟内已触发过同步
    When 再次点击同步按钮
    Then 显示 "请稍后再试（距离上次同步不足5分钟）"

  Scenario: 同步过程中查看进度
    Given 同步任务正在执行
    When 查看同步状态
    Then 显示当前进度（已处理/总数）
    And 显示预计剩余时间
```

### 任务拆分

- [ ] Task 3.2.1: 实现手动同步接口
- [ ] Task 3.2.2: 实现限流控制
- [ ] Task 3.2.3: 实现进度查询
- [ ] Task 3.2.4: 编写测试用例

---

## Story 3.3: 打卡统计计算

| 字段 | 内容 |
|------|------|
| **Story ID** | S3.3 |
| **角色** | 作为系统 |
| **目标** | 我需要正确计算每个会员的打卡统计 |
| **价值** | 以便于判断会员是否达到退款条件 |
| **优先级** | P0 |

### 验收标准

```gherkin
Feature: 打卡统计计算
  作为系统
  我需要正确计算每个会员的打卡统计
  以便于判断会员是否达到退款条件

  Background:
    Given 训练营要求打卡 15 天
    And 宽限天数为 1 天

  Scenario: 正好达到要求
    Given 会员实际打卡 15 天
    When 计算打卡统计
    Then 实际天数 = 15 + 1（宽限）= 16 天
    And 标记为 "合格"

  Scenario: 刚好不合格
    Given 会员实际打卡 13 天
    When 计算打卡统计
    Then 实际天数 = 13 + 1（宽限）= 14 天
    And 标记为 "不合格"

  Scenario: 超额完成
    Given 会员实际打卡 21 天（全勤）
    When 计算打卡统计
    Then 实际天数 = 21 + 1（宽限）= 22 天
    And 标记为 "合格"
    And 标记为 "全勤"

  Scenario: 边界情况 - 宽限后刚好合格
    Given 会员实际打卡 14 天
    And 宽限天数为 1 天
    And 要求打卡 15 天
    When 计算打卡统计
    Then 实际天数 = 14 + 1 = 15 天
    And 标记为 "合格"

  Scenario: 无打卡记录
    Given 会员打卡 0 天
    When 计算打卡统计
    Then 实际天数 = 0 + 1（宽限）= 1 天
    And 标记为 "不合格"
```

### 任务拆分

- [ ] Task 3.3.1: 实现打卡统计计算逻辑
- [ ] Task 3.3.2: 实现宽限天数配置
- [ ] Task 3.3.3: 实现合格状态判断
- [ ] Task 3.3.4: 编写单元测试（覆盖边界情况）

---

## 技术实现细节

### 知识星球 API 封装

```java
public interface PlanetApiManager {
    /**
     * 获取训练营打卡排行榜
     * @param campId 训练营ID
     * @return 打卡数据列表
     */
    List<CheckinData> getCheckinRanking(Long campId);

    /**
     * 检查 Cookie 是否有效
     * @return true 有效，false 无效
     */
    boolean validateCookie();
}
```

### 同步任务配置

```yaml
# application.yml
scheduler:
  checkin-sync:
    cron: "0 0 1 * * ?"  # 每日 01:00
    retry-count: 3
    retry-interval: 5000  # 毫秒

checkin:
  grace-days: 1  # 宽限天数
```

### 同步日志结构

```json
{
  "syncId": "SYNC20250101010000",
  "campId": 1,
  "campName": "21天早起打卡训练营",
  "startTime": "2025-01-01T01:00:00",
  "endTime": "2025-01-01T01:00:05",
  "status": "SUCCESS",
  "totalMembers": 150,
  "updatedCount": 150,
  "failedCount": 0,
  "retryCount": 0,
  "message": "同步成功"
}
```

---

## 相关文档

- [技术方案 v1.1](../技术方案_v1.1.md)
- [EP02: 会员报名支付](./EP02-会员报名支付.md)
- [EP04: 身份匹配](./EP04-身份匹配.md)
