一、文档一致性问题（严重）

  1.1 用户表设计冲突

  | 位置              | 设计                                             | 冲突点                          |
  |-----------------|------------------------------------------------|------------------------------|
  | 技术方案 §5.6.2 ER图 | system_user + planet_user 独立                   | 引用 数据库设计.md §5.1 wechat_user |
  | FastAuth方案 §3.5 | system_user + user_oauth + user_planet_binding | 三表设计                         |
  | FastAuth方案 §2.3 | 扩展 planet_user 表                               | 与上面又不同                       |

  问题：至少存在 3 种不同的用户表设计方案，最终采用哪个不明确。

最终采用system_user+planet_user+wechat_user

  1.2 术语不统一

  技术方案: wechat_user 表
  FastAuth: system_user 表 + user_oauth 表
           ↓
  这两个是同一个东西还是不同的东西？
  wechat_user是微信服务号用户（OAuth登录 + 星球绑定），system_user是系统用户表（管理员，教练，志愿者），user_auth我理解暂时没有用了

  ---
  二、流程设计问题

  2.1 主路径（OAuth + 绑定）逻辑缺陷

  flowchart TD
      A[用户点击 H5 链接] --> B{是否已登录?}
      B -->|否| C[跳转微信 OAuth 授权]
      C --> D[创建/获取 wechat_user]
      D --> E{星球是否已绑定?}
      E -->|否| F[显示绑定页面]
      F --> G[用户填写星球昵称/ID]
      G --> H{本地验证}
      H -->|验证通过| I[绑定成功]

  问题：
  - 步骤 G "用户填写星球昵称/ID" - 如何本地验证？需要先同步星球会员数据
  - 但 §5.8.1 定时任务显示会员同步是每天凌晨 2:30 
  - 如果用户是新加入星球的会员，可能还没同步到本地，验证会失败，确实会失败，因此可以开放用户自己填写

通过星球运营后台导出excel，上传落库，不通过api同步，表头为：
成员编号	用户昵称	微信昵称	星球名片昵称	星球内备注昵称	知识号	身份	是否付费加入	首次加入时间	首次来源	到期时间	距离可续期的天数	已续期次数	最后活跃时间	在本星球成功付费的总金额	是否被拉黑	用户是否退出星球	是否关注知识星球公众号	是否开启消息通知	粉丝数	主题数	评论数	提问数	提问金额	回答数	回答收入	点赞数	获赞数	赞赏金额	获得赞赏金额	普通分享带来的用户数	普通分享带来的金额	分享有赏带来的用户数	分享有赏带来的订单数	分享有赏带来的金额
重新设计星球会员表，同时增加离线导入功能；

  2.2 降级路径 Access Token 设计问题

  技术方案 §5.7.4 代码：
  // member_id 可能为 null（支付成功时尚未绑定），先写空串，绑定后再更新
  data.put("member_id", payment.getMemberId() != null ? String.valueOf(payment.getMemberId()) : "");

  问题：
  - member_id 为空意味着 Token 无法关联到会员
  - 绑定后需要更新 Token，但没有描述这个更新流程
  - Redis Key 设计中没有体现这个更新逻辑

  2.3 两条路径的入口混乱

  | 入口      | 预期路径            | 实际可能             |
  |---------|-----------------|------------------|
  | H5 报名链接 | 主路径（OAuth + 绑定） | ✓                |
  | 固定二维码   | 降级路径            | 如果用户先扫码再打开 H5 呢？ |

  问题：用户可能混用两条路径，但文档没有描述这种交叉场景的处理。
这两个不存在交叉，是互斥的

  ---
  三、状态机设计问题

  3.1 支付映射状态转换不完整

  §5.4.2 状态机显示：
  [*] --> 待绑定: 支付回调（无attach）
  待绑定 --> 已绑定: 用户填写提交

  缺失场景：
  - 动态二维码支付时，直接进入 已绑定，没有 待绑定 过渡
  - 但 §5.4.11 事件表显示有 CREATE_WITH_ATTACH 事件

  矛盾：状态机图和事件表描述不一致。

  3.2 bind_method 与 bind_status 对应关系不清

  | bind_status | 可能的 bind_method                                   |
  |-------------|---------------------------------------------------|
  | completed   | dynamic_qrcode / user_fill / smart_match / manual |
  | pending     | null                                              |
  | expired     | null                                              |

  问题：
  - expired 状态后如果智能匹配成功，bind_status 变为 completed：这个设计不合理，重新设计这块
  - 但状态日志表 payment_bind_status_log 没有记录 bind_method 的变化：需要记录

  ---
  四、数据模型问题

  4.1 1:1 关系假设过于理想

  ER 图显示：
  camp_member 1:1 payment_record
  camp_member 1:0..1 refund_record

  现实场景未覆盖：
  - 用户报名 → 退款 → 重新报名？ 退款只有打卡结束才会给他退
  - 用户重复支付（网络原因）？需要做幂等校验
  - 同一用户参加多期训练营？允许这个情况，需要补充

  4.2 planet_user 表设计冲突

  FastAuth §2.3.1 扩展字段：
  ALTER TABLE planet_user ADD COLUMN IF NOT EXISTS user_number VARCHAR(20);
  ALTER TABLE planet_user ADD COLUMN IF NOT EXISTS role VARCHAR(20) DEFAULT 'member';

  但技术方案 §5.5.5 领域模型显示：
  class PlanetUser {
      +String planetUserId
      +String planetNickname
      +String wechatNickname
  }

  问题：user_number、role、member_status 等字段在领域模型中缺失。

评估是否需要补充

  ---
  五、安全设计问题

  5.1 Access Token 安全风险

  Access Token 格式: tk_ + UUID
  存储位置: Redis
  有效期: 训练营结束后 7 天

  风险：
  1. Token 泄露：如果用户分享了带 Token 的链接，他人可以查看其进度 :查看进度没有风险
  2. 无 IP 绑定：没有验证请求来源 IP 。：无需验证IP
  3. 无设备绑定：没有 device fingerprint  :无需绑定设备

  5.2 returnUrl 白名单配置位置不一致

  FastAuth §3.4.3 有详细的白名单验证逻辑，但技术方案中没有体现这个配置在哪里。

补充这个配置

  ---
  六、缺失内容

  6.1 关键文档引用但未提供

  | 引用位置   | 引用文档           | 状态    |
  |--------|----------------|-------|
  | §5.6.3 | 数据库设计.md 完整表结构 | ❓ 未读取 |
  | §5.7   | 接口文档.md 详细 API | ❓ 未读取 |
  | §A.3   | AI辅助敏捷开发计划.md  | ❓ 未读取 |

  6.2 技术方案缺失部分

  - 前端路由设计：只有目录结构，没有路由表              ：补充
  - 错误码定义：只说了范围（1001-1999），没有具体列表 。 ：补充
  - 消息模板：通知功能提到了模板，但没有具体内容
  - 监控告警阈值：有表格但值是否合理未验证              ：开发过程再补充工

  ---
  七、废弃内容未清理 （直接移除）

  7.1 §5.1.1 动态二维码路径

  文档明确标注 【已废弃】 但仍保留 100+ 行内容：
  ### 5.1.1 会员用户旅程（动态二维码路径 - ~~推荐~~）【已废弃】

  > **⚠️ 注意**：此流程假设 H5 能获取星球登录态，实际不可行。

  建议：移至附录或单独的废弃方案文档。

  7.2 FastAuth 文档定位模糊

  文档开头：
  保留原因：作为历史参考和详细实现细节备查。
  建议：优先参考 技术方案.md 和 数据库设计.md 的最新设计。

  但文档中仍有大量正在使用的设计细节（如 MemberSyncService），这些是否已迁移到技术方案？
迁移到技术方案

  ---
  八、建议改进项

  优先级 P0（阻塞开发）

  1. 统一用户表设计 - 明确 wechat_user + system_user 的最终方案
  2. 补充数据库设计.md 
  3. 明确 planet_user 扩展字段 - 与领域模型对齐

  优先级 P1（影响实现）

  4. 补充新会员验证失败场景处理
  5. 完善 Access Token 绑定后更新流程
  6. 清理废弃内容，避免混淆

  优先级 P2（完善文档）

  7. 补充前端路由设计
  8. 补充错误码定义
  9. 补充消息模板内容