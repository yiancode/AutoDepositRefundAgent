# 知识星球训练营自动押金退款系统 - 接口文档

| **版本** | v1.0 |
| -------- | ---- |
| **作者** | 系统架构师 |
| **日期** | 2025-12-01 |
| **状态** | 评审中 |

---

## 目录

1. [概述](#一概述)
2. [接口总览](#二接口总览)
3. [H5会员端接口](#三h5会员端接口)
4. [训练营管理接口](#四训练营管理接口)
5. [会员管理接口](#五会员管理接口)
6. [打卡管理接口](#六打卡管理接口)
7. [退款管理接口](#七退款管理接口)
8. [统计报表接口](#八统计报表接口)
9. [系统管理接口](#九系统管理接口)
10. [Webhook接口](#十webhook接口)
11. [流程图](#十一流程图)
12. [使用场景](#十二使用场景)
13. [错误码说明](#十三错误码说明)

---

# 一、概述

## 1.1 文档说明

本文档定义了知识星球训练营自动押金退款系统的所有 RESTful API 接口，供前后端开发人员参考。

## 1.2 接口规范

### 基础URL

| 环境 | URL |
|------|-----|
| 开发环境 | `http://localhost:8080/api` |
| 测试环境 | `https://test-api.example.com/api` |
| 生产环境 | `https://api.example.com/api` |

### 请求格式

- **Content-Type**: `application/json`
- **字符编码**: UTF-8
- **时间格式**: ISO 8601（`yyyy-MM-dd'T'HH:mm:ss`）

### 统一响应格式

```json
{
  "code": 200,
  "message": "成功",
  "data": {},
  "timestamp": 1730000000
}
```

### 分页响应格式

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "list": [],
    "total": 100,
    "page": 1,
    "pageSize": 20,
    "totalPages": 5
  },
  "timestamp": 1730000000
}
```

## 1.3 认证方式

| 接口类型 | 认证方式 | Header |
|----------|----------|--------|
| 管理后台 | JWT Token | `Authorization: Bearer {token}` |
| H5会员端 | 访问票据（部分接口） | `X-Access-Token: {accessToken}` |
| Webhook | 签名验证 | 验证微信签名 |

### JWT Token 格式

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsInVzZXJuYW1lIjoiYWRtaW4iLCJyb2xlIjoiYWRtaW4iLCJleHAiOjE3MzAwMDAwMDB9.xxxxx
```

### H5 访问票据机制（Access Token）

> ⚠️ **安全设计**：为防止订单号枚举和抢绑定攻击，敏感 H5 接口需要验证访问票据。

**票据生成时机**：
- 支付成功后，系统在回调中生成 `accessToken` 并返回给前端
- 票据与 `orderNo` 绑定，仅能访问对应订单的资源

**票据规格**：
| 属性 | 值 |
|------|-----|
| 格式 | UUID v4（128位随机） |
| 有效期 | 7 天 |
| 绑定关系 | 1 票据 : 1 订单 |
| 存储位置 | Redis（`access_token:{token}` → `orderNo`） |

**安全措施**：
1. **订单号不可枚举**：`orderNo` 使用 UUID 格式（如 `ord_a1b2c3d4-5678-...`）
2. **票据一次性绑定**：`bind` 接口需验证票据对应的 `openid/corpUserId` 与支付时一致
3. **接口限流**：敏感接口每 IP 每分钟 ≤ 10 次
4. **失效机制**：绑定成功后票据标记为已使用，不可重复绑定

---

# 二、接口总览

## 2.1 接口清单

| 模块 | 接口数量 | 说明 |
|------|----------|------|
| H5会员端 | 8 | 报名、支付、进度查询 |
| 训练营管理 | 6 | 训练营CRUD |
| 会员管理 | 5 | 会员查询、匹配 |
| 打卡管理 | 4 | 打卡同步、统计 |
| 退款管理 | 6 | 退款审核、执行 |
| 统计报表 | 3 | 数据统计、导出 |
| 系统管理 | 5 | 用户、配置、日志 |
| Webhook | 2 | 支付回调 |
| **合计** | **39** | |

## 2.2 接口列表

### H5会员端接口（/api/h5）

| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| GET | /camps | 训练营列表 | 否 |
| GET | /camps/{id} | 训练营详情 | 否 |
| POST | /payments | 创建支付订单 | 否 |
| GET | /payments/{id}/params | 获取支付参数 | 否 |
| GET | /payments/{orderNo}/status | 查询支付状态 | **票据** |
| POST | /payments/bind | 用户绑定星球信息 | **票据** |
| GET | /payments/{orderNo}/qrcode | 获取群二维码 | **票据** |
| GET | /progress/{memberId} | 查询打卡进度 | **票据** |

> **说明**：标注"票据"的接口需要在 Header 中传递 `X-Access-Token`，票据在支付成功后返回。

### 管理后台接口（/api/admin）

| 方法 | 路径 | 描述 | 认证 |
|------|------|------|------|
| POST | /camps | 创建训练营 | JWT |
| GET | /camps | 训练营列表 | JWT |
| GET | /camps/{id} | 训练营详情 | JWT |
| PUT | /camps/{id} | 更新训练营 | JWT |
| DELETE | /camps/{id} | 删除训练营 | JWT |
| POST | /camps/{id}/publish | 发布训练营 | JWT |
| GET | /members | 会员列表 | JWT |
| GET | /members/{id} | 会员详情 | JWT |
| POST | /members/{id}/match | 手动匹配 | JWT |
| PUT | /members/{id}/join-group | 标记进群 | JWT |
| GET | /members/export | 导出会员 | JWT |
| POST | /checkins/sync | 同步打卡数据 | JWT |
| GET | /checkins/stats/{campId} | 打卡统计 | JWT |
| GET | /checkins/records | 打卡记录 | JWT |
| POST | /checkins/sync/{campId} | 手动同步 | JWT |
| GET | /refunds/pending | 待审核列表 | JWT |
| POST | /refunds/{id}/approve | 审核通过 | JWT |
| POST | /refunds/{id}/reject | 审核拒绝 | JWT |
| POST | /refunds/batch-approve | 批量审核 | JWT |
| POST | /refunds/{id}/retry | 重试退款 | JWT |
| GET | /refunds/records | 退款记录 | JWT |
| GET | /stats/overview | 数据概览 | JWT |
| GET | /stats/camps/{id} | 训练营统计 | JWT |
| GET | /stats/export | 导出报表 | JWT |
| POST | /auth/login | 登录 | 否 |
| POST | /auth/logout | 登出 | JWT |
| GET | /users | 用户列表 | JWT |
| POST | /users | 创建用户 | JWT |
| PUT | /config | 更新配置 | JWT |

### Webhook接口（/api/webhook）

| 方法 | 路径 | 描述 |
|------|------|------|
| POST | /wechat/payment | 支付结果通知 |
| POST | /wechat/refund | 退款结果通知 |

---

# 三、H5会员端接口

## 3.1 获取训练营列表

获取当前可报名的训练营列表。

**请求**

```
GET /api/h5/camps
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | string | 否 | 状态筛选：enrolling（报名中） |
| page | int | 否 | 页码，默认1 |
| pageSize | int | 否 | 每页条数，默认10 |

**请求示例**

```bash
GET /api/h5/camps?status=enrolling&page=1&pageSize=10
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "list": [
      {
        "id": 1,
        "name": "21天早起打卡训练营",
        "posterUrl": "https://cdn.example.com/posters/camp1.jpg",
        "description": "每天早上6点前打卡，坚持21天养成早起习惯",
        "deposit": 99.00,
        "startDate": "2025-12-10",
        "endDate": "2025-12-31",
        "totalDays": 21,
        "requiredDays": 15,
        "memberCount": 156,
        "status": "enrolling",
        "enrollUrl": "https://h5.example.com/enroll/1"
      },
      {
        "id": 2,
        "name": "30天读书训练营",
        "posterUrl": "https://cdn.example.com/posters/camp2.jpg",
        "description": "每天阅读30分钟，分享读书笔记",
        "deposit": 199.00,
        "startDate": "2025-12-15",
        "endDate": "2026-01-14",
        "totalDays": 30,
        "requiredDays": 21,
        "memberCount": 89,
        "status": "enrolling",
        "enrollUrl": "https://h5.example.com/enroll/2"
      }
    ],
    "total": 5,
    "page": 1,
    "pageSize": 10,
    "totalPages": 1
  },
  "timestamp": 1730000000
}
```

---

## 3.2 获取训练营详情

获取指定训练营的详细信息。

**请求**

```
GET /api/h5/camps/{id}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 训练营ID |

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| planetUserId | string | 否 | 星球用户ID（动态二维码场景） |

**请求示例**

```bash
GET /api/h5/camps/1?planetUserId=123456789
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "id": 1,
    "name": "21天早起打卡训练营",
    "posterUrl": "https://cdn.example.com/posters/camp1.jpg",
    "description": "每天早上6点前打卡，坚持21天养成早起习惯",
    "deposit": 99.00,
    "startDate": "2025-12-10",
    "endDate": "2025-12-31",
    "totalDays": 21,
    "requiredDays": 15,
    "groupQrcodeUrl": null,
    "memberCount": 156,
    "status": "enrolling",
    "rules": [
      "每天早上6:00前完成打卡",
      "打卡内容需包含起床时间",
      "连续3天未打卡视为放弃"
    ],
    "prefillInfo": {
      "planetUserId": "123456789",
      "planetNickname": "小明同学",
      "editable": false
    }
  },
  "timestamp": 1730000000
}
```

---

## 3.3 创建支付订单

创建押金支付订单。

**请求**

```
POST /api/h5/payments
```

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| campId | long | 是 | 训练营ID |
| planetUserId | string | 是 | 星球用户ID |
| planetNickname | string | 是 | 星球昵称 |
| wechatNickname | string | 否 | 微信昵称 |

**请求示例**

```json
{
  "campId": 1,
  "planetUserId": "123456789",
  "planetNickname": "小明同学",
  "wechatNickname": "小明"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "orderId": 10001,
    "orderNo": "CAMP_1730000000_ABC123",
    "amount": 99.00,
    "status": "pending",
    "expireTime": "2025-12-01T12:30:00",
    "payUrl": "/api/h5/payments/10001/params"
  },
  "timestamp": 1730000000
}
```

**错误响应**

```json
{
  "code": 1001,
  "message": "您已报名该训练营，无需重复报名",
  "data": null,
  "timestamp": 1730000000
}
```

---

## 3.4 获取支付参数

获取企业微信支付所需参数。

**请求**

```
GET /api/h5/payments/{id}/params
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 订单ID |

**请求示例**

```bash
GET /api/h5/payments/10001/params
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "orderNo": "CAMP_1730000000_ABC123",
    "amount": 99.00,
    "description": "21天早起打卡训练营 - 押金",
    "payType": "wechat_work",
    "payParams": {
      "appId": "wwxxxxxxxxxx",
      "timeStamp": "1730000000",
      "nonceStr": "abc123xyz",
      "package": "prepay_id=wx20251201120000abcdef",
      "signType": "RSA",
      "paySign": "xxxxxxxxxxxxxxxx"
    },
    "qrcodeUrl": "https://pay.weixin.qq.com/xxxxx",
    "expireTime": "2025-12-01T12:30:00"
  },
  "timestamp": 1730000000
}
```

---

## 3.5 查询支付状态

查询订单支付状态。

> ⚠️ **安全要求**：需要访问票据验证。票据在支付成功后通过回调返回给前端。

**请求**

```
GET /api/h5/payments/{orderNo}/status
Header: X-Access-Token: {accessToken}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| orderNo | string | 是 | 订单号 |

**请求示例**

```bash
GET /api/h5/payments/ord_a1b2c3d4-5678-90ab-cdef/status
Header: X-Access-Token: tk_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

**响应示例（支付成功）**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "orderNo": "CAMP_1730000000_ABC123",
    "payStatus": "success",
    "bindStatus": "completed",
    "bindMethod": "dynamic_qrcode",
    "payTime": "2025-12-01T12:05:30",
    "memberId": 1001,
    "showQrcode": true
  },
  "timestamp": 1730000000
}
```

**响应示例（待绑定）**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "orderNo": "CAMP_1730000000_ABC123",
    "payStatus": "success",
    "bindStatus": "pending",
    "bindMethod": null,
    "payTime": "2025-12-01T12:05:30",
    "memberId": null,
    "showQrcode": false,
    "bindDeadline": "2025-12-08T12:05:30",
    "bindUrl": "/api/h5/payments/bind"
  },
  "timestamp": 1730000000
}
```

---

## 3.6 用户绑定星球信息

固定二维码支付后，用户手动绑定星球信息。

> ⚠️ **安全要求**：需要访问票据验证，防止抢绑定攻击。

**请求**

```
POST /api/h5/payments/bind
Header: X-Access-Token: {accessToken}
```

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| orderNo | string | 是 | 订单号 |
| planetUserId | string | 是 | 星球用户ID |
| planetNickname | string | 是 | 星球昵称 |

**安全校验逻辑**：
1. 验证 `accessToken` 有效且未过期
2. 验证 `accessToken` 绑定的 `orderNo` 与请求一致
3. 验证该票据未被使用过（防止重复绑定）
4. 绑定成功后标记票据为已使用

**请求示例**

```json
{
  "orderNo": "CAMP_1730000000_ABC123",
  "planetUserId": "123456789",
  "planetNickname": "小明同学"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "绑定成功",
  "data": {
    "orderNo": "CAMP_1730000000_ABC123",
    "bindStatus": "completed",
    "bindMethod": "user_fill",
    "memberId": 1001,
    "showQrcode": true
  },
  "timestamp": 1730000000
}
```

**错误响应**

```json
{
  "code": 1002,
  "message": "该订单已绑定其他星球用户",
  "data": null,
  "timestamp": 1730000000
}
```

```json
{
  "code": 1003,
  "message": "绑定已过期，请联系管理员处理",
  "data": null,
  "timestamp": 1730000000
}
```

---

## 3.7 获取群二维码

支付成功且绑定完成后，获取群二维码。

> ⚠️ **安全要求**：需要访问票据验证，防止订单号枚举获取群入口。

**请求**

```
GET /api/h5/payments/{orderNo}/qrcode
Header: X-Access-Token: {accessToken}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| orderNo | string | 是 | 订单号 |

**请求示例**

```bash
GET /api/h5/payments/ord_a1b2c3d4-5678-90ab-cdef/qrcode
Header: X-Access-Token: tk_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "orderNo": "CAMP_1730000000_ABC123",
    "campName": "21天早起打卡训练营",
    "groupQrcodeUrl": "https://cdn.example.com/qrcodes/group1.jpg",
    "memberInfo": {
      "memberId": 1001,
      "planetNickname": "小明同学",
      "planetUserId": "123456789",
      "amount": 99.00
    },
    "tips": "长按保存二维码，微信扫码加入训练营群"
  },
  "timestamp": 1730000000
}
```

**错误响应（未绑定）**

```json
{
  "code": 1004,
  "message": "请先完成星球信息绑定",
  "data": {
    "bindUrl": "/api/h5/payments/bind"
  },
  "timestamp": 1730000000
}
```

---

## 3.8 查询打卡进度

查询会员在训练营中的打卡进度。

> ⚠️ **安全要求**：需要访问票据验证，防止 memberId 枚举泄露用户打卡和退款数据。

**请求**

```
GET /api/h5/progress/{memberId}
Header: X-Access-Token: {accessToken}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| memberId | long | 是 | 会员ID |

**请求示例**

```bash
GET /api/h5/progress/1001
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "memberId": 1001,
    "campId": 1,
    "campName": "21天早起打卡训练营",
    "planetNickname": "小明同学",
    "startDate": "2025-12-10",
    "endDate": "2025-12-31",
    "currentDay": 15,
    "totalDays": 21,
    "requiredDays": 15,
    "checkinCount": 12,
    "checkinRate": 80.00,
    "remainingDays": 6,
    "gap": 3,
    "status": "ongoing",
    "eligibleForRefund": false,
    "refundStatus": null,
    "checkinCalendar": [
      {"date": "2025-12-10", "checked": true},
      {"date": "2025-12-11", "checked": true},
      {"date": "2025-12-12", "checked": false},
      {"date": "2025-12-13", "checked": true},
      {"date": "2025-12-14", "checked": true},
      {"date": "2025-12-15", "checked": true},
      {"date": "2025-12-16", "checked": false},
      {"date": "2025-12-17", "checked": true},
      {"date": "2025-12-18", "checked": true},
      {"date": "2025-12-19", "checked": true},
      {"date": "2025-12-20", "checked": true},
      {"date": "2025-12-21", "checked": true},
      {"date": "2025-12-22", "checked": true},
      {"date": "2025-12-23", "checked": true},
      {"date": "2025-12-24", "checked": false}
    ],
    "lastCheckinTime": "2025-12-23T06:30:00"
  },
  "timestamp": 1730000000
}
```

---

# 四、训练营管理接口

## 4.1 创建训练营

创建新的训练营。

**请求**

```
POST /api/admin/camps
```

**请求头**

```
Authorization: Bearer {token}
Content-Type: application/json
```

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| name | string | 是 | 训练营名称（最长100字符） |
| posterUrl | string | 是 | 海报图片URL |
| description | string | 否 | 训练营介绍 |
| deposit | decimal | 是 | 押金金额（单位：元） |
| startDate | string | 是 | 开始日期（yyyy-MM-dd） |
| endDate | string | 是 | 结束日期（yyyy-MM-dd） |
| requiredDays | int | 是 | 要求打卡天数 |
| groupQrcodeUrl | string | 是 | 群二维码URL |
| planetProjectId | string | 是 | 知识星球项目ID |

**请求示例**

```json
{
  "name": "21天早起打卡训练营",
  "posterUrl": "https://cdn.example.com/posters/camp1.jpg",
  "description": "每天早上6点前打卡，坚持21天养成早起习惯",
  "deposit": 99.00,
  "startDate": "2025-12-10",
  "endDate": "2025-12-31",
  "requiredDays": 15,
  "groupQrcodeUrl": "https://cdn.example.com/qrcodes/group1.jpg",
  "planetProjectId": "15555411412112"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 1,
    "name": "21天早起打卡训练营",
    "posterUrl": "https://cdn.example.com/posters/camp1.jpg",
    "description": "每天早上6点前打卡，坚持21天养成早起习惯",
    "deposit": 99.00,
    "startDate": "2025-12-10",
    "endDate": "2025-12-31",
    "totalDays": 21,
    "requiredDays": 15,
    "groupQrcodeUrl": "https://cdn.example.com/qrcodes/group1.jpg",
    "planetProjectId": "15555411412112",
    "status": "draft",
    "enrollUrl": null,
    "memberCount": 0,
    "paidAmount": 0,
    "refundedAmount": 0,
    "createdAt": "2025-12-01T10:00:00",
    "updatedAt": "2025-12-01T10:00:00"
  },
  "timestamp": 1730000000
}
```

---

## 4.2 获取训练营列表

获取训练营列表（管理端）。

**请求**

```
GET /api/admin/camps
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | string | 否 | 状态筛选 |
| keyword | string | 否 | 关键词搜索（名称） |
| startDate | string | 否 | 开始日期范围起始 |
| endDate | string | 否 | 开始日期范围结束 |
| page | int | 否 | 页码，默认1 |
| pageSize | int | 否 | 每页条数，默认20 |

**请求示例**

```bash
GET /api/admin/camps?status=ongoing&page=1&pageSize=20
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "list": [
      {
        "id": 1,
        "name": "21天早起打卡训练营",
        "deposit": 99.00,
        "startDate": "2025-12-10",
        "endDate": "2025-12-31",
        "totalDays": 21,
        "requiredDays": 15,
        "status": "ongoing",
        "memberCount": 156,
        "paidAmount": 15444.00,
        "refundedAmount": 0,
        "matchedCount": 150,
        "pendingMatchCount": 6,
        "createdAt": "2025-12-01T10:00:00"
      },
      {
        "id": 2,
        "name": "30天读书训练营",
        "deposit": 199.00,
        "startDate": "2025-12-15",
        "endDate": "2026-01-14",
        "totalDays": 30,
        "requiredDays": 21,
        "status": "enrolling",
        "memberCount": 89,
        "paidAmount": 17711.00,
        "refundedAmount": 0,
        "matchedCount": 85,
        "pendingMatchCount": 4,
        "createdAt": "2025-12-05T10:00:00"
      }
    ],
    "total": 10,
    "page": 1,
    "pageSize": 20,
    "totalPages": 1
  },
  "timestamp": 1730000000
}
```

---

## 4.3 获取训练营详情

获取训练营详细信息（管理端）。

**请求**

```
GET /api/admin/camps/{id}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 训练营ID |

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "id": 1,
    "name": "21天早起打卡训练营",
    "posterUrl": "https://cdn.example.com/posters/camp1.jpg",
    "description": "每天早上6点前打卡，坚持21天养成早起习惯",
    "deposit": 99.00,
    "startDate": "2025-12-10",
    "endDate": "2025-12-31",
    "totalDays": 21,
    "requiredDays": 15,
    "groupQrcodeUrl": "https://cdn.example.com/qrcodes/group1.jpg",
    "planetProjectId": "15555411412112",
    "status": "ongoing",
    "enrollUrl": "https://h5.example.com/enroll/1",
    "memberCount": 156,
    "paidAmount": 15444.00,
    "refundedAmount": 0,
    "statistics": {
      "totalMembers": 156,
      "matchedMembers": 150,
      "pendingMatchMembers": 6,
      "joinedGroupMembers": 148,
      "eligibleForRefund": 120,
      "avgCheckinRate": 75.5
    },
    "coaches": [
      {"id": 2, "name": "张教练"},
      {"id": 3, "name": "李教练"}
    ],
    "volunteers": [
      {"id": 4, "name": "王志愿者"}
    ],
    "createdAt": "2025-12-01T10:00:00",
    "updatedAt": "2025-12-01T10:00:00"
  },
  "timestamp": 1730000000
}
```

---

## 4.4 更新训练营

更新训练营信息。

**请求**

```
PUT /api/admin/camps/{id}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 训练营ID |

**请求体**

```json
{
  "name": "21天早起打卡训练营（第2期）",
  "posterUrl": "https://cdn.example.com/posters/camp1_v2.jpg",
  "description": "更新后的训练营介绍",
  "groupQrcodeUrl": "https://cdn.example.com/qrcodes/group1_v2.jpg"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "更新成功",
  "data": {
    "id": 1,
    "name": "21天早起打卡训练营（第2期）",
    "updatedAt": "2025-12-01T15:00:00"
  },
  "timestamp": 1730000000
}
```

---

## 4.5 删除训练营

删除训练营（软删除）。

**请求**

```
DELETE /api/admin/camps/{id}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 训练营ID |

**响应示例**

```json
{
  "code": 200,
  "message": "删除成功",
  "data": null,
  "timestamp": 1730000000
}
```

**错误响应（已有会员）**

```json
{
  "code": 1101,
  "message": "该训练营已有会员报名，无法删除",
  "data": null,
  "timestamp": 1730000000
}
```

---

## 4.6 发布训练营

发布训练营，生成报名链接。

**请求**

```
POST /api/admin/camps/{id}/publish
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 训练营ID |

**响应示例**

```json
{
  "code": 200,
  "message": "发布成功",
  "data": {
    "id": 1,
    "status": "enrolling",
    "enrollUrl": "https://h5.example.com/enroll/1",
    "dynamicQrcodeUrl": "https://h5.example.com/enroll/1?source=qrcode",
    "publishedAt": "2025-12-01T10:30:00"
  },
  "timestamp": 1730000000
}
```

---

# 五、会员管理接口

## 5.1 获取会员列表

获取训练营会员列表。

**请求**

```
GET /api/admin/members
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| campId | long | 否 | 训练营ID |
| matchStatus | string | 否 | 匹配状态：pending/matched/failed |
| keyword | string | 否 | 关键词搜索（昵称） |
| eligibleForRefund | boolean | 否 | 是否符合退款条件 |
| page | int | 否 | 页码 |
| pageSize | int | 否 | 每页条数 |

**请求示例**

```bash
GET /api/admin/members?campId=1&matchStatus=pending&page=1&pageSize=20
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "list": [
      {
        "id": 1001,
        "campId": 1,
        "campName": "21天早起打卡训练营",
        "filledPlanetNickname": "小明同学",
        "filledPlanetUserId": "123456789",
        "filledWechatNickname": "小明",
        "matchStatus": "matched",
        "matchConfidence": 100,
        "matchedPlanetNickname": "小明同学",
        "joinedGroup": true,
        "joinedAt": "2025-12-10T08:30:00",
        "checkinCount": 12,
        "checkinRate": 80.00,
        "eligibleForRefund": false,
        "payAmount": 99.00,
        "payTime": "2025-12-09T18:00:00",
        "refundStatus": null,
        "createdAt": "2025-12-09T18:00:00"
      },
      {
        "id": 1002,
        "campId": 1,
        "campName": "21天早起打卡训练营",
        "filledPlanetNickname": "张三",
        "filledPlanetUserId": "987654321",
        "filledWechatNickname": "张三三",
        "matchStatus": "pending",
        "matchConfidence": 0,
        "matchedPlanetNickname": null,
        "joinedGroup": false,
        "joinedAt": null,
        "checkinCount": 0,
        "checkinRate": 0,
        "eligibleForRefund": false,
        "payAmount": 99.00,
        "payTime": "2025-12-10T10:00:00",
        "refundStatus": null,
        "createdAt": "2025-12-10T10:00:00"
      }
    ],
    "total": 156,
    "page": 1,
    "pageSize": 20,
    "totalPages": 8
  },
  "timestamp": 1730000000
}
```

---

## 5.2 获取会员详情

获取会员详细信息。

**请求**

```
GET /api/admin/members/{id}
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "id": 1001,
    "campId": 1,
    "campName": "21天早起打卡训练营",
    "filledInfo": {
      "planetNickname": "小明同学",
      "planetUserId": "123456789",
      "wechatNickname": "小明"
    },
    "matchInfo": {
      "status": "matched",
      "confidence": 100,
      "method": "dynamic_qrcode",
      "matchedPlanetUser": {
        "id": 501,
        "planetUserId": "123456789",
        "planetNickname": "小明同学",
        "wechatNickname": "小明"
      },
      "matchTime": "2025-12-09T18:00:30"
    },
    "groupInfo": {
      "joined": true,
      "joinedAt": "2025-12-10T08:30:00"
    },
    "checkinInfo": {
      "count": 12,
      "rate": 80.00,
      "requiredDays": 15,
      "lastCheckinTime": "2025-12-23T06:30:00",
      "eligible": false
    },
    "paymentInfo": {
      "orderId": 10001,
      "orderNo": "CAMP_1730000000_ABC123",
      "amount": 99.00,
      "status": "success",
      "payTime": "2025-12-09T18:00:00",
      "bindStatus": "completed",
      "bindMethod": "dynamic_qrcode"
    },
    "refundInfo": null,
    "createdAt": "2025-12-09T18:00:00",
    "updatedAt": "2025-12-23T06:30:00"
  },
  "timestamp": 1730000000
}
```

---

## 5.3 手动匹配会员

管理员手动绑定会员与星球用户。

**请求**

```
POST /api/admin/members/{id}/match
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 会员ID |

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| planetUserId | long | 是 | 星球用户表ID |

**请求示例**

```json
{
  "planetUserId": 501
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "匹配成功",
  "data": {
    "memberId": 1002,
    "matchStatus": "matched",
    "matchConfidence": 100,
    "matchMethod": "manual",
    "matchedPlanetUser": {
      "id": 501,
      "planetUserId": "987654321",
      "planetNickname": "张三"
    }
  },
  "timestamp": 1730000000
}
```

---

## 5.4 标记进群

标记会员已加入训练营群。

**请求**

```
PUT /api/admin/members/{id}/join-group
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 会员ID |

**响应示例**

```json
{
  "code": 200,
  "message": "标记成功",
  "data": {
    "memberId": 1002,
    "joinedGroup": true,
    "joinedAt": "2025-12-10T15:00:00"
  },
  "timestamp": 1730000000
}
```

---

## 5.5 导出会员列表

导出会员列表为Excel。

**请求**

```
GET /api/admin/members/export
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| campId | long | 是 | 训练营ID |
| format | string | 否 | 导出格式：xlsx（默认）/csv |

**响应**

返回文件流，Content-Type: `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`

**响应头**

```
Content-Disposition: attachment; filename="members_camp1_20251201.xlsx"
```

---

# 六、打卡管理接口

## 6.1 同步打卡数据

手动触发打卡数据同步。

**请求**

```
POST /api/admin/checkins/sync/{campId}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| campId | long | 是 | 训练营ID |

**响应示例**

```json
{
  "code": 200,
  "message": "同步成功",
  "data": {
    "campId": 1,
    "syncTime": "2025-12-24T10:00:00",
    "totalUsers": 156,
    "newCheckins": 45,
    "updatedMembers": 45,
    "duration": 3500
  },
  "timestamp": 1730000000
}
```

**错误响应（同步进行中）**

```json
{
  "code": 1201,
  "message": "同步进行中，请稍后再试",
  "data": null,
  "timestamp": 1730000000
}
```

---

## 6.2 获取打卡统计

获取训练营打卡统计数据。

**请求**

```
GET /api/admin/checkins/stats/{campId}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| campId | long | 是 | 训练营ID |

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "campId": 1,
    "campName": "21天早起打卡训练营",
    "currentDay": 15,
    "totalDays": 21,
    "totalMembers": 156,
    "todayCheckins": 120,
    "todayCheckinRate": 76.92,
    "avgCheckinRate": 75.50,
    "eligibleCount": 98,
    "eligibleRate": 62.82,
    "distribution": [
      {"checkinDays": "0-5", "count": 10},
      {"checkinDays": "6-10", "count": 28},
      {"checkinDays": "11-15", "count": 70},
      {"checkinDays": "16-21", "count": 48}
    ],
    "dailyStats": [
      {"date": "2025-12-10", "checkinCount": 150, "rate": 96.15},
      {"date": "2025-12-11", "checkinCount": 145, "rate": 92.95},
      {"date": "2025-12-12", "checkinCount": 138, "rate": 88.46}
    ],
    "lastSyncTime": "2025-12-24T01:00:00"
  },
  "timestamp": 1730000000
}
```

---

## 6.3 获取打卡记录

获取打卡记录列表。

**请求**

```
GET /api/admin/checkins/records
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| campId | long | 是 | 训练营ID |
| memberId | long | 否 | 会员ID |
| date | string | 否 | 打卡日期 |
| page | int | 否 | 页码 |
| pageSize | int | 否 | 每页条数 |

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "list": [
      {
        "id": 10001,
        "campId": 1,
        "memberId": 1001,
        "planetNickname": "小明同学",
        "checkinDate": "2025-12-24",
        "checkinTime": "2025-12-24T05:58:30",
        "checkinContent": "今天5点58分起床，完成晨跑3公里！",
        "syncedAt": "2025-12-24T01:00:00"
      },
      {
        "id": 10002,
        "campId": 1,
        "memberId": 1003,
        "planetNickname": "李四",
        "checkinDate": "2025-12-24",
        "checkinTime": "2025-12-24T05:45:00",
        "checkinContent": "5:45 打卡成功",
        "syncedAt": "2025-12-24T01:00:00"
      }
    ],
    "total": 1200,
    "page": 1,
    "pageSize": 20,
    "totalPages": 60
  },
  "timestamp": 1730000000
}
```

---

## 6.4 批量同步所有训练营

同步所有进行中的训练营打卡数据。

**请求**

```
POST /api/admin/checkins/sync
```

**响应示例**

```json
{
  "code": 200,
  "message": "批量同步已启动",
  "data": {
    "taskId": "sync_1730000000",
    "campCount": 5,
    "status": "processing",
    "startTime": "2025-12-24T10:00:00"
  },
  "timestamp": 1730000000
}
```

---

# 七、退款管理接口

## 7.1 获取待审核退款列表

获取待审核的退款申请列表。

**请求**

```
GET /api/admin/refunds/pending
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| campId | long | 否 | 训练营ID |
| page | int | 否 | 页码 |
| pageSize | int | 否 | 每页条数 |

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "list": [
      {
        "id": 5001,
        "campId": 1,
        "campName": "21天早起打卡训练营",
        "memberId": 1001,
        "planetNickname": "小明同学",
        "refundAmount": 99.00,
        "auditStatus": "pending",
        "matchConfidence": 100,
        "matchMethod": "dynamic_qrcode",
        "checkinCount": 16,
        "requiredDays": 15,
        "payTime": "2025-12-09T18:00:00",
        "createdAt": "2025-12-31T03:00:00"
      },
      {
        "id": 5002,
        "campId": 1,
        "campName": "21天早起打卡训练营",
        "memberId": 1003,
        "planetNickname": "李四",
        "refundAmount": 99.00,
        "auditStatus": "pending",
        "matchConfidence": 75,
        "matchMethod": "smart_match",
        "checkinCount": 15,
        "requiredDays": 15,
        "payTime": "2025-12-09T20:00:00",
        "createdAt": "2025-12-31T03:00:00"
      }
    ],
    "total": 98,
    "page": 1,
    "pageSize": 20,
    "totalPages": 5,
    "summary": {
      "totalAmount": 9702.00,
      "highConfidenceCount": 85,
      "lowConfidenceCount": 13
    }
  },
  "timestamp": 1730000000
}
```

---

## 7.2 审核通过退款

审核通过单个退款申请。

**请求**

```
POST /api/admin/refunds/{id}/approve
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 退款记录ID |

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| comment | string | 否 | 审核备注 |

**请求示例**

```json
{
  "comment": "打卡达标，审核通过"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "审核通过",
  "data": {
    "refundId": 5001,
    "auditStatus": "approved",
    "refundStatus": "pending",
    "auditor": "admin",
    "auditTime": "2025-12-31T10:00:00"
  },
  "timestamp": 1730000000
}
```

---

## 7.3 审核拒绝退款

审核拒绝退款申请。

**请求**

```
POST /api/admin/refunds/{id}/reject
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 退款记录ID |

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| reason | string | 是 | 拒绝原因 |

**请求示例**

```json
{
  "reason": "身份匹配置信度过低，需人工核实"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "已拒绝",
  "data": {
    "refundId": 5002,
    "auditStatus": "rejected",
    "refundStatus": "rejected",
    "reason": "身份匹配置信度过低，需人工核实",
    "auditor": "admin",
    "auditTime": "2025-12-31T10:05:00"
  },
  "timestamp": 1730000000
}
```

---

## 7.4 批量审核退款

批量审核通过退款申请。

**请求**

```
POST /api/admin/refunds/batch-approve
```

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| refundIds | long[] | 是 | 退款记录ID列表 |
| minConfidence | int | 否 | 最低置信度阈值（默认80） |
| comment | string | 否 | 审核备注 |

**请求示例**

```json
{
  "refundIds": [5001, 5003, 5004, 5005],
  "minConfidence": 80,
  "comment": "批量审核通过"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "批量审核完成",
  "data": {
    "total": 4,
    "approved": 3,
    "skipped": 1,
    "skippedDetails": [
      {
        "refundId": 5004,
        "reason": "置信度(75)低于阈值(80)"
      }
    ],
    "auditor": "admin",
    "auditTime": "2025-12-31T10:10:00"
  },
  "timestamp": 1730000000
}
```

---

## 7.5 重试失败退款

重试执行失败的退款。

**请求**

```
POST /api/admin/refunds/{id}/retry
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 退款记录ID |

**响应示例**

```json
{
  "code": 200,
  "message": "已加入重试队列",
  "data": {
    "refundId": 5010,
    "refundStatus": "processing",
    "retryCount": 2,
    "lastRetryTime": "2025-12-31T10:15:00"
  },
  "timestamp": 1730000000
}
```

---

## 7.6 获取退款记录

获取退款记录列表。

**请求**

```
GET /api/admin/refunds/records
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| campId | long | 否 | 训练营ID |
| refundStatus | string | 否 | 退款状态 |
| auditStatus | string | 否 | 审核状态 |
| startDate | string | 否 | 开始日期 |
| endDate | string | 否 | 结束日期 |
| page | int | 否 | 页码 |
| pageSize | int | 否 | 每页条数 |

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "list": [
      {
        "id": 5001,
        "campId": 1,
        "campName": "21天早起打卡训练营",
        "memberId": 1001,
        "planetNickname": "小明同学",
        "refundAmount": 99.00,
        "auditStatus": "approved",
        "refundStatus": "success",
        "auditor": "admin",
        "auditTime": "2025-12-31T10:00:00",
        "executeTime": "2025-12-31T10:05:00",
        "wechatRefundId": "50000000001",
        "notified": true,
        "notifyTime": "2025-12-31T10:05:30",
        "createdAt": "2025-12-31T03:00:00"
      }
    ],
    "total": 500,
    "page": 1,
    "pageSize": 20,
    "totalPages": 25,
    "summary": {
      "totalRefunded": 45000.00,
      "successCount": 450,
      "failedCount": 5,
      "pendingCount": 45
    }
  },
  "timestamp": 1730000000
}
```

---

# 八、统计报表接口

## 8.1 获取数据概览

获取系统整体数据概览。

**请求**

```
GET /api/admin/stats/overview
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "summary": {
      "totalCamps": 25,
      "activeCamps": 5,
      "totalMembers": 3500,
      "totalPaid": 320000.00,
      "totalRefunded": 180000.00,
      "netIncome": 140000.00
    },
    "recentCamps": [
      {
        "id": 1,
        "name": "21天早起打卡训练营",
        "status": "ongoing",
        "memberCount": 156,
        "avgCheckinRate": 75.5
      },
      {
        "id": 2,
        "name": "30天读书训练营",
        "status": "enrolling",
        "memberCount": 89,
        "avgCheckinRate": 0
      }
    ],
    "trend": {
      "members": [
        {"date": "2025-11", "count": 500},
        {"date": "2025-12", "count": 800}
      ],
      "revenue": [
        {"date": "2025-11", "amount": 45000.00},
        {"date": "2025-12", "amount": 75000.00}
      ]
    },
    "generatedAt": "2025-12-24T10:00:00"
  },
  "timestamp": 1730000000
}
```

---

## 8.2 获取训练营统计

获取单个训练营的详细统计数据。

**请求**

```
GET /api/admin/stats/camps/{id}
```

**路径参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | long | 是 | 训练营ID |

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "campId": 1,
    "campName": "21天早起打卡训练营",
    "status": "finished",
    "period": {
      "startDate": "2025-12-10",
      "endDate": "2025-12-31",
      "totalDays": 21
    },
    "enrollment": {
      "totalMembers": 156,
      "matchedMembers": 150,
      "matchRate": 96.15,
      "joinedGroupMembers": 148,
      "joinRate": 94.87
    },
    "checkin": {
      "avgCheckinRate": 75.50,
      "eligibleMembers": 98,
      "eligibleRate": 62.82,
      "distribution": [
        {"range": "0-5天", "count": 10, "percentage": 6.41},
        {"range": "6-10天", "count": 28, "percentage": 17.95},
        {"range": "11-15天", "count": 70, "percentage": 44.87},
        {"range": "16-21天", "count": 48, "percentage": 30.77}
      ]
    },
    "finance": {
      "totalPaid": 15444.00,
      "totalRefunded": 9702.00,
      "netIncome": 5742.00,
      "refundRate": 62.82
    },
    "refund": {
      "totalRefunds": 98,
      "successRefunds": 95,
      "failedRefunds": 3,
      "successRate": 96.94
    },
    "dailyTrend": [
      {"date": "2025-12-10", "checkinCount": 150, "checkinRate": 96.15},
      {"date": "2025-12-11", "checkinCount": 145, "checkinRate": 92.95}
    ],
    "generatedAt": "2025-12-31T12:00:00"
  },
  "timestamp": 1730000000
}
```

---

## 8.3 导出统计报表

导出训练营统计报表。

**请求**

```
GET /api/admin/stats/export
```

**查询参数**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| campId | long | 否 | 训练营ID（不传则导出全部） |
| startDate | string | 否 | 开始日期 |
| endDate | string | 否 | 结束日期 |
| type | string | 否 | 报表类型：summary/detail |
| format | string | 否 | 导出格式：xlsx/pdf |

**响应**

返回文件流

---

# 九、系统管理接口

## 9.1 用户登录

管理员登录。

**请求**

```
POST /api/admin/auth/login
```

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| username | string | 是 | 用户名 |
| password | string | 是 | 密码 |

**请求示例**

```json
{
  "username": "admin",
  "password": "admin123"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "userId": 1,
    "username": "admin",
    "realName": "超级管理员",
    "role": "admin",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresIn": 86400,
    "permissions": ["camp:*", "member:*", "refund:*", "stats:*", "system:*"]
  },
  "timestamp": 1730000000
}
```

**错误响应**

```json
{
  "code": 401,
  "message": "用户名或密码错误",
  "data": null,
  "timestamp": 1730000000
}
```

---

## 9.2 用户登出

管理员登出。

**请求**

```
POST /api/admin/auth/logout
```

**响应示例**

```json
{
  "code": 200,
  "message": "登出成功",
  "data": null,
  "timestamp": 1730000000
}
```

---

## 9.3 获取用户列表

获取系统用户列表。

**请求**

```
GET /api/admin/users
```

**响应示例**

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "list": [
      {
        "id": 1,
        "username": "admin",
        "realName": "超级管理员",
        "role": "admin",
        "status": "active",
        "lastLoginTime": "2025-12-24T09:00:00",
        "createdAt": "2025-01-01T00:00:00"
      },
      {
        "id": 2,
        "username": "manager1",
        "realName": "张管理",
        "role": "manager",
        "status": "active",
        "lastLoginTime": "2025-12-24T08:30:00",
        "createdAt": "2025-06-01T00:00:00"
      }
    ],
    "total": 10,
    "page": 1,
    "pageSize": 20,
    "totalPages": 1
  },
  "timestamp": 1730000000
}
```

---

## 9.4 创建用户

创建系统用户。

**请求**

```
POST /api/admin/users
```

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| username | string | 是 | 用户名 |
| password | string | 是 | 密码 |
| realName | string | 是 | 真实姓名 |
| role | string | 是 | 角色：admin/manager/coach/volunteer |

**请求示例**

```json
{
  "username": "coach1",
  "password": "coach123",
  "realName": "李教练",
  "role": "coach"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": 5,
    "username": "coach1",
    "realName": "李教练",
    "role": "coach",
    "status": "active",
    "createdAt": "2025-12-24T10:00:00"
  },
  "timestamp": 1730000000
}
```

---

## 9.5 更新系统配置

更新系统配置项。

**请求**

```
PUT /api/admin/config
```

**请求体**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| key | string | 是 | 配置键 |
| value | string | 是 | 配置值 |

**请求示例**

```json
{
  "key": "planet.cookie",
  "value": "new_cookie_value_here"
}
```

**响应示例**

```json
{
  "code": 200,
  "message": "配置更新成功",
  "data": {
    "key": "planet.cookie",
    "updatedAt": "2025-12-24T10:00:00"
  },
  "timestamp": 1730000000
}
```

---

# 十、Webhook接口

## 10.1 支付结果通知

企业微信支付结果回调。

**请求**

```
POST /api/webhook/wechat/payment
```

**请求头**

```
Wechatpay-Signature: xxxxxx
Wechatpay-Timestamp: 1730000000
Wechatpay-Nonce: abc123
Wechatpay-Serial: xxxxx
```

**请求体（解密后）**

```json
{
  "mchid": "1234567890",
  "appid": "wwxxxxxxxxxx",
  "out_trade_no": "CAMP_1730000000_ABC123",
  "transaction_id": "4200001234567890",
  "trade_type": "JSAPI",
  "trade_state": "SUCCESS",
  "trade_state_desc": "支付成功",
  "bank_type": "OTHERS",
  "attach": "{\"campId\":1,\"planetUserId\":\"123456789\",\"planetNickname\":\"小明同学\"}",
  "success_time": "2025-12-01T12:05:30+08:00",
  "payer": {
    "openid": "oxxxxxxxxxx"
  },
  "amount": {
    "total": 9900,
    "payer_total": 9900,
    "currency": "CNY",
    "payer_currency": "CNY"
  }
}
```

**响应（成功）**

```json
{
  "code": "SUCCESS",
  "message": "成功"
}
```

**响应（失败）**

```json
{
  "code": "FAIL",
  "message": "签名验证失败"
}
```

---

## 10.2 退款结果通知

企业微信退款结果回调。

**请求**

```
POST /api/webhook/wechat/refund
```

**请求体（解密后）**

```json
{
  "mchid": "1234567890",
  "out_trade_no": "CAMP_1730000000_ABC123",
  "transaction_id": "4200001234567890",
  "out_refund_no": "REFUND_1730000000_5001",
  "refund_id": "50000000001",
  "refund_status": "SUCCESS",
  "success_time": "2025-12-31T10:05:00+08:00",
  "amount": {
    "total": 9900,
    "refund": 9900,
    "payer_total": 9900,
    "payer_refund": 9900
  }
}
```

**响应**

```json
{
  "code": "SUCCESS",
  "message": "成功"
}
```

---

# 十一、流程图

## 11.1 报名支付流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant H5 as H5前端
    participant API as API服务
    participant WX as 企业微信

    U->>H5: 访问报名页
    H5->>API: GET /h5/camps/{id}
    API-->>H5: 返回训练营详情

    U->>H5: 填写信息并支付
    H5->>API: POST /h5/payments
    API-->>H5: 返回订单信息

    H5->>API: GET /h5/payments/{id}/params
    API-->>H5: 返回支付参数

    H5->>WX: 调起支付
    U->>WX: 完成支付
    WX->>API: POST /webhook/wechat/payment
    API-->>WX: 返回SUCCESS

    loop 轮询支付状态
        H5->>API: GET /h5/payments/{orderNo}/status
        API-->>H5: 返回支付状态
    end

    H5->>API: GET /h5/payments/{orderNo}/qrcode
    API-->>H5: 返回群二维码
    H5-->>U: 显示群二维码
```

## 11.2 退款审核流程

```mermaid
flowchart TD
    A[训练营结束] --> B[系统生成退款名单]
    B --> C{bind_status?}
    C -->|completed| D[置信度100%]
    C -->|其他| E[智能匹配]
    E --> F{匹配评分}
    F -->|>=80%| G[置信度=评分]
    F -->|50-79%| H[待人工审核]
    F -->|<50%| I[人工处理]

    D --> J[管理员审核]
    G --> J
    H --> J
    I --> K[手动匹配]
    K --> J

    J --> L{审核结果}
    L -->|通过| M[执行退款]
    L -->|拒绝| N[记录原因]

    M --> O{退款结果}
    O -->|成功| P[通知会员]
    O -->|失败| Q{重试次数}
    Q -->|<3| M
    Q -->|>=3| R[人工处理]
```

## 11.3 打卡数据同步流程

```mermaid
flowchart TD
    A[定时任务触发] --> B[获取进行中训练营]
    B --> C[遍历训练营]
    C --> D[调用知识��球API]
    D --> E{API成功?}
    E -->|是| F[解析打卡数据]
    E -->|否| G{重试次数<3?}
    G -->|是| D
    G -->|否| H[发送告警]

    F --> I[更新打卡记录]
    I --> J[更新会员统计]
    J --> K[计算退款资格]
    K --> L{还有训练营?}
    L -->|是| C
    L -->|否| M[同步完成]
```

---

# 十二、使用场景

## 12.1 动态二维码报名场景

**场景描述**：用户通过知识星球内的专属链接报名，链接中已包含用户的星球ID。

**流程**：
1. 用户在知识星球看到训练营海报，点击专属报名链接
2. 链接格式：`https://h5.example.com/enroll/1?planetUserId=123456789`
3. H5页面调用 `GET /h5/camps/1?planetUserId=123456789` 获取详情
4. 页面预填星球信息，用户确认后点击支付
5. 调用 `POST /h5/payments` 创建订单，请求体包含 planetUserId
6. 支付成功后，Webhook 回调中的 attach 字段包含用户信息
7. 系统自动完成绑定，`bind_status=completed, bind_method=dynamic_qrcode`
8. 用户直接获取群二维码

**优点**：用户体验最佳，无需手动填写信息，身份匹配准确率 100%。

---

## 12.2 固定二维码报名场景

**场景描述**：用户通过固定收款码支付，支付后需要手动填写星球信息。

**流程**：
1. 用户扫描固定收款码支付押金
2. 支付成功后，Webhook 回调中 attach 为空
3. 系统创建支付记录，`bind_status=pending, bind_deadline=7天后`
4. 用户跳转到绑定页面，调用 `POST /h5/payments/bind` 提交星球信息
5. 系统验证信息后完成绑定，`bind_status=completed, bind_method=user_fill`
6. 用户获取群二维码

**注意事项**：
- 用户需在7天内完成绑定，否则状态变为 `expired`
- 过期后需要人工处理或等待智能匹配

---

## 12.3 批量退款审核场景

**场景描述**：训练营结束后，管理员批量审核退款申请。

**流程**：
1. 训练营结束，系统自动生成退款名单
2. 管理员调用 `GET /admin/refunds/pending` 查看待审核列表
3. 对于高置信度（>=80%）的申请，调用 `POST /admin/refunds/batch-approve` 批量通过
4. 对于低置信度的申请，逐个审核或手动匹配后再审核
5. 系统自动执行退款并发送通知

**最佳实践**：
- 先处理高置信度申请，提高效率
- 低置信度申请需仔细核对打卡记录
- 退款失败时检查商户余额

---

# 十三、错误码说明

## 13.1 通用错误码

| 错误码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未认证或Token过期 |
| 403 | 无权限 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

## 13.2 业务错误码

### H5端（1001-1099）

| 错误码 | 说明 |
|--------|------|
| 1001 | 您已报名该训练营，无需重复报名 |
| 1002 | 该订单已绑定其他星球用户 |
| 1003 | 绑定已过期，请联系管理员处理 |
| 1004 | 请先完成星球信息绑定 |
| 1005 | 订单不存在或已取消 |
| 1006 | 训练营不在报名期 |

### 训练营管理（1101-1199）

| 错误码 | 说明 |
|--------|------|
| 1101 | 该训练营已有会员报名，无法删除 |
| 1102 | 训练营状态不允许此操作 |
| 1103 | 训练营信息不完整，无法发布 |

### 打卡管理（1201-1299）

| 错误码 | 说明 |
|--------|------|
| 1201 | 同步进行中，请稍后再试 |
| 1202 | 知识星球Cookie已过期，请更新 |
| 1203 | 知识星球API调用失败 |

### 退款管理（1301-1399）

| 错误码 | 说明 |
|--------|------|
| 1301 | 退款记录不存在 |
| 1302 | 退款状态不允许此操作 |
| 1303 | 商户余额不足 |
| 1304 | 退款API调用失败 |
| 1305 | 退款金额超过原支付金额 |

### 系统管理（1401-1499）

| 错误码 | 说明 |
|--------|------|
| 1401 | 用户名已存在 |
| 1402 | 用户不存在 |
| 1403 | 原密码错误 |
| 1404 | 配置项不存在 |

---

**文档结束**

*本文档包含39个API接口的完整定义，供前后端开发参考。*
