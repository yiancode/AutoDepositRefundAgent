# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 项目概述

这是一个**知识星球训练营自动押金退款系统**，用于自动化管理训练营的押金收取、打卡统计和退款流程。系统采用前后端分离架构，支持每月5-10个训练营同时运行，单个训练营最多1000人参与。

**核心业务流程**：
1. 会员通过H5扫码报名 → 企业微信支付押金 → 获得群二维码
2. 每日01:00自动同步知识星球打卡数据 → 计算退款资格
3. 项目结束后生成退款列表 → 管理员审核 → 自动执行退款

## 项目状态

🟡 **需求分析完成，准备进入开发阶段**

- ✅ 需求分析完成（PRD）
- ✅ 技术架构设计完成
- ✅ 数据库设计完成（10张核心表）
- ✅ 实施计划完成（30天分4阶段）
- ⚪ 后端项目骨架未创建（待阶段零）
- ⚪ 前端项目骨架未创建（待阶段零）
- ⚪ 数据库未初始化（待阶段零）

## 技术架构

### 后端技术栈
- **语言**：Java 17+
- **框架**：Spring Boot 3.2+ / Spring Security 6.x / MyBatis Plus 3.5+
- **数据库**：PostgreSQL 15+
- **缓存**：Redis 7.x
- **认证**：JWT Token
- **文档**：Knife4j 4.x

### 前端技术栈
- **框架**：Vue 3.3+ / Vite 5.x / Pinia 2.x
- **H5 UI**：Vant 4.x（会员端）
- **后台 UI**：Element Plus 2.4+（管理后台）
- **图表**：ECharts 5.x

### 后端分层架构
```
Controller（接口路由、参数校验）
    ↓
Service（业务逻辑、事务管理）
    ↓
Manager（第三方API封装：企业微信支付、知识星球API）
    ↓
Mapper（数据库访问）
```

## 项目结构

```
AutoDepositRefundAgent/
├── docs/                          # 完整的设计文档
│   ├── PRD.md                     # 产品需求文档（70+页）
│   ├── 技术架构设计.md             # 技术架构和项目结构
│   ├── 数据库设计.md               # 10张表的完整设计+SQL
│   └── 分阶段实施计划.md           # 30天开发计划
├── backend/                       # 后端项目（待创建）
├── frontend/                      # 前端项目（待创建）
│   ├── h5-member/                 # H5会员端
│   └── admin-web/                 # Web管理后台
└── sql/                           # 数据库脚本（待创建）
```

## 核心业务概念

### 10张核心数据表
1. **training_camp**：训练营基本信息（名称、押金、日期、打卡要求）
2. **camp_member**：会员与训练营关系（匹配状态、打卡统计、退款资格）⭐ 核心表
3. **planet_user**：知识星球用户信息（用于匹配）
4. **payment_record**：支付流水记录（企业微信支付订单）
5. **checkin_record**：打卡记录（从知识星球同步）
6. **refund_record**：退款记录（审核状态、退款状态）
7. **system_user**：管理员/教练/志愿者账号
8. **operation_log**：操作审计日志
9. **system_config**：系统配置（知识星球Cookie、企业微信密钥）
10. **camp_member_relation**：训练营与教练/志愿者关系

### 智能匹配算法
系统通过多维度匹配会员身份（支付记录 ↔ 知识星球用户）：
- **星球ID匹配** → 置信度100%
- **星球昵称匹配** → 置信度66%
- **微信昵称匹配** → 置信度33%
- **匹配失败** → 人工介入

### 核心Service层设计
- **CampService**：训练营CRUD、生成H5链接
- **PaymentService**：创建支付订单、处理Webhook回调、定时轮询
- **CheckinService**：同步打卡数据（定时任务）、计算退款资格
- **MatchService**：自动匹配算法、手动匹配
- **RefundService**：生成退款列表、审核、执行退款、失败重试
- **NotificationService**：企业微信通知（应用消息、群机器人）

### 定时任务
1. **打卡同步**：每天01:00同步前一天打卡数据
2. **退款触发**：每天02:00检查结束的训练营，生成退款列表
3. **提醒通知**：每天10:00发送未进群提醒、项目即将结束提醒
4. **支付轮询**：每小时同步企业微信支付记录（兜底）

## 开发计划（30天）

**阶段零**（Day 0-2）：环境搭建和基础框架
- 创建Spring Boot项目骨架
- 创建Vue 3前端项目（H5 + 后台）
- 初始化PostgreSQL数据库
- 配置Redis、MyBatis Plus、Knife4j

**阶段一**（Day 3-16）：核心功能MVP
- Day 3-4: 用户认证和权限（JWT + Spring Security）
- Day 5-6: 训练营管理（CRUD + 文件上传）
- Day 7-8: H5会员端（列表、报名、二维码）
- Day 9-10: 企业微信支付集成（Webhook + 轮询）
- Day 11-12: 知识星球API集成（定时同步打卡）
- Day 13: 会员匹配算法
- Day 14-16: 退款审核和执行

**阶段二**（Day 17-23）：数据统计和优化
- 打卡进度查询（H5）
- 统计报表（ECharts图表）
- 企业微信通知集成

**阶段三**（Day 24-30）：系统管理和安全
- 用户管理、操作日志
- 接口防刷（Redis限流）
- 敏感数据加密
- 性能优化、部署上线

## 关键设计决策

### 为什么是半自动化退款？
- **自动判断**：系统计算是否满足退款条件（打卡天数≥要求）
- **人工审核**：管理员最终确认，确保100%准确（处理边界情况）
- **自动执行**：审核通过后自动调用企业微信退款API

### 为什么需要匹配算法？
企业微信支付记录和知识星球打卡记录是两个独立系统的数据，需要通过"星球ID + 昵称 + 微信名"进行匹配，识别同一个人。

### 为什么用PostgreSQL而不是MySQL？
- 更好的JSON支持（存储打卡数据、配置等）
- 强大的全文搜索
- 更好的并发性能
- 完善的事务支持

### 异常处理策略
每个关键环节都有容错机制：
- 支付回调丢失 → 定时轮询兜底
- 打卡同步失败 → 通知管理员
- 退款失败 → 自动重试1次 → 仍失败则人工处理
- API异常 → 降级方案（手动导入）

## API接口规范

### URL设计
- 管理端：`/api/admin/{resource}`
- H5端：`/api/h5/{resource}`
- Webhook：`/api/webhook/{source}/{event}`

### 统一响应格式
```json
{
  "code": 200,
  "message": "成功",
  "data": {},
  "timestamp": 1234567890
}
```

### 认证方式
- 管理后台：JWT Token（Header: `Authorization: Bearer {token}`）
- H5端：游客模式（查询进度时验证身份）
- Webhook：签名验证

## 当前待办事项（阶段零任务）

当用户说"开始阶段零"或"开始环境搭建"时，执行以下任务：

1. **创建后端项目**：
   - 使用Spring Initializr生成项目骨架
   - 配置pom.xml依赖（Spring Boot、MyBatis Plus、Redis、JWT等）
   - 创建分层目录结构（controller/service/mapper/entity等）
   - 配置application.yml（数据源、Redis、端口等）

2. **创建前端项目**：
   - H5会员端：Vite + Vue 3 + Vant
   - Web管理后台：Vite + Vue 3 + Element Plus
   - 配置路由、Axios、状态管理

3. **初始化数据库**：
   - 创建PostgreSQL数据库
   - 生成10张表的建表SQL（参考docs/数据库设计.md）
   - 创建触发器、视图、存储过程
   - 插入初始数据（默认管理员账号）

4. **配置开发环境**：
   - 配置Knife4j API文档
   - 配置跨域和拦截器
   - 配置日志输出
   - 封装统一响应结果和异常处理

## 开发规范

### Git提交规范
遵循Conventional Commits：
- `feat`: 新功能
- `fix`: 修复Bug
- `docs`: 文档更新
- `refactor`: 重构
- `test`: 测试相关

### 代码规范
- 遵循阿里巴巴Java开发手册
- 使用Lombok简化代码
- 所有敏感操作记录操作日志（使用AOP切面）
- RESTful API遵循统一规范

### 数据库规范
- 表名和字段名：小写+下划线
- 主键统一使用`id`（BIGSERIAL）
- 必备字段：`created_at`、`updated_at`、`deleted_at`（软删除）
- 金额字段：DECIMAL(10,2)

## 重要文档链接

详细的设计文档位于`docs/`目录：
- **产品需求文档（PRD）**：完整的功能需求和业务流程
- **技术架构设计**：技术选型、项目结构、接口设计
- **数据库设计**：10张表的完整SQL和ER图
- **分阶段实施计划**：30天详细任务分解和验收标准

## 外部服务集成

### 企业微信支付
- **创建订单**：调用企业微信支付API
- **Webhook回调**：验证签名 → 更新支付状态 → 创建会员记录
- **退款**：调用退款API，失败重试1次
- **轮询兜底**：每小时同步支付记录

### 知识星球API
- **认证方式**：Cookie（配置在system_config表）
- **获取打卡数据**：返回用户列表、每个用户的打卡次数和时间
- **定时同步**：每天01:00执行

### 企业微信通知
- **应用消息**：通知管理员（同步失败、退款失败等）
- **群机器人**：通知会员（退款成功）

## 性能要求

- H5页面首屏加载时间 < 2秒
- 管理后台响应时间 < 1秒
- 支付回调处理时间 < 3秒
- 支持单个训练营1000人同时报名
- 系统可用性：12小时/天 × 7天/周

## 安全要求

- JWT Token认证
- 基于角色的访问控制（RBAC）：超级管理员、管理员、教练、志愿者
- Redis限流：同一IP每分钟最多100次请求
- 敏感数据AES-256加密（企业微信密钥、知识星球Cookie）
- Webhook签名验证
- SQL注入防护（MyBatis Plus参数化查询）
- 操作审计日志（记录所有敏感操作）
