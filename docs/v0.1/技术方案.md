# v0.1 企业微信退款功能技术方案

**创建时间**: 2025-10-30
**版本**: v1.0
**状态**: 设计中

---

## 📋 方案概述

### 目标

在 v0 版本基础上,对接企业微信支付退款 API,实现自动退款功能。

### 核心功能

1. ✅ 企业微信支付配置管理
2. ✅ 退款 API 调用封装
3. ✅ 退款记录持久化存储
4. ✅ 防重复退款机制
5. ✅ 退款失败重试
6. ✅ 前端退款操作流程

### 设计原则

- **简单优先**: 使用 JSON 文件存储,避免引入数据库
- **幂等性**: 确保退款操作不会重复执行
- **安全性**: 证书文件安全管理,敏感信息加密
- **可靠性**: 完善的错误处理和重试机制
- **可追溯**: 完整的退款记录和日志

---

## 🏗️ 技术架构

### 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    前端 (zsxq-web)                       │
│                                                           │
│  退款名单页面 (RefundList.vue)                            │
│    ↓                                                     │
│  [执行退款] 按钮 → 确认弹窗 → 批量退款                     │
│    ↓                                                     │
│  显示进度条 → 显示退款结果                                 │
└─────────────────────────────────────────────────────────┘
                            ↓ HTTP POST
┌─────────────────────────────────────────────────────────┐
│                    后端 (zsxq-api)                       │
│                                                           │
│  路由层 (routes/refunds.js)                              │
│    ↓                                                     │
│  服务层:                                                  │
│    • wework-pay.service.js  (企微支付 API 封装)          │
│    • refund-record.service.js  (退款记录管理)            │
│    • refund.service.js  (业务逻辑协调)                   │
│    ↓                                                     │
│  数据存储 (data/refund-records.json)                     │
└─────────────────────────────────────────────────────────┘
                            ↓ HTTPS
┌─────────────────────────────────────────────────────────┐
│          企业微信支付 API (pay.weixin.qq.com)             │
│                                                           │
│  POST /v3/refund/domestic/refunds  (申请退款)            │
│  GET /v3/refund/domestic/refunds/{out_refund_no} (查询)  │
└─────────────────────────────────────────────────────────┘
```

### 数据流程

```
用户点击"执行退款"
  → 前端显示确认弹窗
  → 调用后端 POST /api/refunds/batch
  → 检查退款记录 (防重复)
  → 循环调用企微退款 API
  → 保存退款记录到 JSON 文件
  → 返回退款结果给前端
  → 前端显示成功/失败详情
```

---

## 📦 技术选型

### 后端依赖

| 库 | 版本 | 用途 |
|---|---|---|
| **wechatpay-node-v3** | ^2.1.8 | 微信支付 v3 SDK |
| **uuid** | ^9.0.0 | 生成唯一退款单号 |
| **fs-extra** | ^11.0.0 | JSON 文件读写 |

### 数据存储方案

**选择**: JSON 文件存储

**理由**:
- ✅ v0 版本无数据库,保持一致性
- ✅ 退款记录数量不大 (单个训练营最多 200 人)
- ✅ 无需复杂查询,简单读写即可
- ✅ 便于迁移到 v1 版本 (可导入数据库)

**文件路径**: `zsxq-api/data/refund-records.json`

**备份策略**: 每次写入前备份到 `data/backups/refund-records-{timestamp}.json`

---

## 💾 数据模型设计

### 退款记录数据结构

```json
{
  "records": [
    {
      "id": "refund_20251030_abc123",
      "camp_id": "8424485212",
      "camp_title": "2510 AI编程",
      "planet_user_id": "88455815452182",
      "planet_nickname": "球球的副业探索路",
      "transaction_id": "4200001234567890",
      "out_trade_no": "ORDER_20251001_001",
      "refund_amount": 9900,
      "refund_reason": "完成7天打卡要求",
      "out_refund_no": "REFUND_20251030_abc123",
      "refund_status": "SUCCESS",
      "wechat_refund_id": "50000012345678901234567890",
      "refund_time": "2025-10-30T15:30:00.000Z",
      "retry_count": 0,
      "error_message": null,
      "created_at": "2025-10-30T15:30:00.000Z",
      "updated_at": "2025-10-30T15:30:05.000Z"
    }
  ],
  "meta": {
    "total_count": 1,
    "last_updated": "2025-10-30T15:30:05.000Z",
    "version": "1.0"
  }
}
```

### 字段说明

| 字段 | 类型 | 说明 |
|-----|-----|------|
| **id** | String | 记录唯一 ID |
| **camp_id** | String | 训练营 ID |
| **camp_title** | String | 训练营标题 |
| **planet_user_id** | String | 星球用户 ID |
| **planet_nickname** | String | 星球昵称 |
| **transaction_id** | String | 微信支付订单号 (必需) |
| **out_trade_no** | String | 商户订单号 (可选) |
| **refund_amount** | Number | 退款金额 (分) |
| **refund_reason** | String | 退款原因 |
| **out_refund_no** | String | 商户退款单号 (唯一) |
| **refund_status** | String | 退款状态: PENDING/SUCCESS/FAILED |
| **wechat_refund_id** | String | 微信退款单号 |
| **refund_time** | String | 退款时间 (ISO 8601) |
| **retry_count** | Number | 重试次数 |
| **error_message** | String | 错误信息 |
| **created_at** | String | 创建时间 |
| **updated_at** | String | 更新时间 |

---

## 🔧 环境变量配置

### 新增配置 (.env)

```env
#######################################################
# 微信支付配置 (v0.1 新增)
#######################################################

# 应用 ID (公众号/小程序/APP)
WECHAT_APP_ID=wx1234567890abcdef

# 商户号
WECHAT_MCH_ID=1234567890

# API v3 密钥 (32位字符串)
WECHAT_API_V3_KEY=your_api_v3_key_32_characters

# 商户证书序列号
WECHAT_SERIAL_NO=1234567890ABCDEF

# 证书文件路径 (相对于项目根目录)
WECHAT_CERT_PATH=./certs/apiclient_cert.pem
WECHAT_KEY_PATH=./certs/apiclient_key.pem

# 退款通知 URL (可选 - v1 版本使用)
# WECHAT_REFUND_NOTIFY_URL=https://your-domain.com/api/webhook/wechat/refund

# 退款自动重试次数 (默认: 1)
REFUND_RETRY_COUNT=1

# 退款记录文件路径 (默认: ./data/refund-records.json)
REFUND_RECORDS_PATH=./data/refund-records.json
```

### 证书文件管理

**证书目录结构**:
```
zsxq-api/
├── certs/                         # 证书目录 (添加到 .gitignore)
│   ├── apiclient_cert.pem         # 商户API证书
│   ├── apiclient_key.pem          # 商户私钥
│   └── README.md                  # 证书获取说明
└── data/                          # 数据目录
    ├── refund-records.json        # 退款记录
    └── backups/                   # 备份目录
```

**安全措施**:
- ✅ 证书文件不提交到 Git (`.gitignore`)
- ✅ 生产环境使用环境变量或加密存储
- ✅ 文件权限设置为 600 (仅所有者可读写)

---

## 🔌 API 接口设计

### 1. 批量执行退款

**接口**: `POST /api/refunds/batch`

**请求参数**:
```json
{
  "camp_id": "8424485212",
  "camp_title": "2510 AI编程",
  "refunds": [
    {
      "planet_user_id": "88455815452182",
      "planet_nickname": "球球的副业探索路",
      "transaction_id": "4200001234567890",
      "refund_amount": 9900,
      "refund_reason": "完成7天打卡要求"
    }
  ]
}
```

**响应**:
```json
{
  "code": 200,
  "message": "批量退款完成",
  "data": {
    "total": 10,
    "success": 8,
    "failed": 2,
    "results": [
      {
        "planet_user_id": "88455815452182",
        "planet_nickname": "球球的副业探索路",
        "status": "SUCCESS",
        "out_refund_no": "REFUND_20251030_abc123",
        "wechat_refund_id": "50000012345678901234567890"
      },
      {
        "planet_user_id": "88455815452183",
        "planet_nickname": "用户B",
        "status": "FAILED",
        "error_code": "INVALID_REQUEST",
        "error_message": "订单号不存在"
      }
    ]
  },
  "timestamp": 1730000000000
}
```

### 2. 查询退款记录

**接口**: `GET /api/refunds?camp_id={camp_id}&status={status}`

**查询参数**:
- `camp_id` (可选): 训练营 ID
- `status` (可选): 退款状态 (PENDING/SUCCESS/FAILED)
- `planet_user_id` (可选): 用户 ID

**响应**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "records": [...],
    "total": 10,
    "success_count": 8,
    "failed_count": 2
  },
  "timestamp": 1730000000000
}
```

### 3. 查询单个退款详情

**接口**: `GET /api/refunds/:out_refund_no`

**响应**:
```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "record": { /* 退款记录详情 */ },
    "wechat_status": {
      "refund_id": "50000012345678901234567890",
      "status": "SUCCESS",
      "success_time": "2025-10-30T15:30:05+08:00",
      "amount": {
        "refund": 9900,
        "payer_refund": 9900
      }
    }
  },
  "timestamp": 1730000000000
}
```

### 4. 重试失败的退款

**接口**: `POST /api/refunds/:out_refund_no/retry`

**响应**:
```json
{
  "code": 200,
  "message": "重试成功",
  "data": {
    "out_refund_no": "REFUND_20251030_abc123",
    "status": "SUCCESS",
    "retry_count": 1
  },
  "timestamp": 1730000000000
}
```

---

## 📝 核心代码实现

### 1. 微信支付服务 (wework-pay.service.js)

```javascript
const WxPay = require('wechatpay-node-v3');
const fs = require('fs');
const logger = require('../utils/logger');

class WeworkPayService {
  constructor() {
    this.pay = new WxPay({
      appid: process.env.WECHAT_APP_ID,
      mchid: process.env.WECHAT_MCH_ID,
      publicKey: fs.readFileSync(process.env.WECHAT_CERT_PATH),
      privateKey: fs.readFileSync(process.env.WECHAT_KEY_PATH),
      key: process.env.WECHAT_API_V3_KEY,
    });
  }

  /**
   * 申请退款
   * @param {Object} params - 退款参数
   * @returns {Promise<Object>} 退款结果
   */
  async refund(params) {
    const { transaction_id, out_refund_no, refund_amount, total_amount, reason } = params;

    try {
      logger.info(`申请退款: ${out_refund_no}, 金额: ${refund_amount}分`);

      const result = await this.pay.refund({
        transaction_id,
        out_refund_no,
        reason,
        amount: {
          refund: refund_amount,
          total: total_amount,
          currency: 'CNY'
        }
      });

      logger.info(`退款成功: ${out_refund_no}, 微信退款单号: ${result.refund_id}`);
      return {
        success: true,
        refund_id: result.refund_id,
        status: result.status,
        success_time: result.success_time
      };

    } catch (error) {
      logger.error(`退款失败: ${out_refund_no}`, error);
      return {
        success: false,
        error_code: error.code || 'UNKNOWN_ERROR',
        error_message: error.message
      };
    }
  }

  /**
   * 查询退款状态
   * @param {String} out_refund_no - 商户退款单号
   * @returns {Promise<Object>} 退款状态
   */
  async queryRefund(out_refund_no) {
    try {
      const result = await this.pay.queryRefund({ out_refund_no });
      return {
        success: true,
        data: result
      };
    } catch (error) {
      logger.error(`查询退款失败: ${out_refund_no}`, error);
      return {
        success: false,
        error_message: error.message
      };
    }
  }
}

module.exports = new WeworkPayService();
```

### 2. 退款记录服务 (refund-record.service.js)

```javascript
const fs = require('fs-extra');
const path = require('path');
const logger = require('../utils/logger');

class RefundRecordService {
  constructor() {
    this.recordsPath = process.env.REFUND_RECORDS_PATH || './data/refund-records.json';
    this.backupDir = path.join(path.dirname(this.recordsPath), 'backups');
    this.ensureDataFile();
  }

  /**
   * 确保数据文件存在
   */
  async ensureDataFile() {
    await fs.ensureDir(path.dirname(this.recordsPath));
    await fs.ensureDir(this.backupDir);

    if (!await fs.pathExists(this.recordsPath)) {
      await this.saveRecords({ records: [], meta: { total_count: 0, last_updated: new Date().toISOString(), version: '1.0' } });
    }
  }

  /**
   * 读取所有记录
   */
  async getRecords() {
    const data = await fs.readJson(this.recordsPath);
    return data;
  }

  /**
   * 保存记录 (带备份)
   */
  async saveRecords(data) {
    // 备份现有文件
    if (await fs.pathExists(this.recordsPath)) {
      const backupPath = path.join(this.backupDir, `refund-records-${Date.now()}.json`);
      await fs.copy(this.recordsPath, backupPath);
    }

    // 更新元数据
    data.meta.last_updated = new Date().toISOString();
    data.meta.total_count = data.records.length;

    // 保存新数据
    await fs.writeJson(this.recordsPath, data, { spaces: 2 });
    logger.info(`退款记录已保存: ${data.records.length} 条`);
  }

  /**
   * 添加退款记录
   */
  async addRecord(record) {
    const data = await this.getRecords();
    record.id = `refund_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    record.created_at = new Date().toISOString();
    record.updated_at = record.created_at;
    data.records.push(record);
    await this.saveRecords(data);
    return record;
  }

  /**
   * 检查退款单号是否存在
   */
  async exists(out_refund_no) {
    const data = await this.getRecords();
    return data.records.some(r => r.out_refund_no === out_refund_no);
  }

  /**
   * 根据商户退款单号查询记录
   */
  async findByOutRefundNo(out_refund_no) {
    const data = await this.getRecords();
    return data.records.find(r => r.out_refund_no === out_refund_no);
  }

  /**
   * 更新记录状态
   */
  async updateStatus(out_refund_no, updates) {
    const data = await this.getRecords();
    const index = data.records.findIndex(r => r.out_refund_no === out_refund_no);

    if (index !== -1) {
      data.records[index] = {
        ...data.records[index],
        ...updates,
        updated_at: new Date().toISOString()
      };
      await this.saveRecords(data);
      return data.records[index];
    }

    return null;
  }
}

module.exports = new RefundRecordService();
```

### 3. 退款路由 (routes/refunds.js)

```javascript
const express = require('express');
const router = express.Router();
const { v4: uuidv4 } = require('uuid');
const weworkPayService = require('../services/wework-pay.service');
const refundRecordService = require('../services/refund-record.service');
const { success, error } = require('../utils/response');
const logger = require('../utils/logger');

/**
 * 批量执行退款
 */
router.post('/batch', async (req, res, next) => {
  try {
    const { camp_id, camp_title, refunds } = req.body;

    const results = [];
    let successCount = 0;
    let failedCount = 0;

    for (const refund of refunds) {
      const out_refund_no = `REFUND_${Date.now()}_${uuidv4().substr(0, 8)}`;

      // 检查是否已退款
      const exists = await refundRecordService.exists(out_refund_no);
      if (exists) {
        results.push({
          ...refund,
          status: 'SKIPPED',
          error_message: '该订单已申请退款'
        });
        continue;
      }

      // 调用微信退款 API
      const result = await weworkPayService.refund({
        transaction_id: refund.transaction_id,
        out_refund_no,
        refund_amount: refund.refund_amount,
        total_amount: refund.refund_amount,
        reason: refund.refund_reason
      });

      // 保存退款记录
      const record = {
        camp_id,
        camp_title,
        planet_user_id: refund.planet_user_id,
        planet_nickname: refund.planet_nickname,
        transaction_id: refund.transaction_id,
        refund_amount: refund.refund_amount,
        refund_reason: refund.refund_reason,
        out_refund_no,
        refund_status: result.success ? 'SUCCESS' : 'FAILED',
        wechat_refund_id: result.refund_id || null,
        refund_time: result.success_time || new Date().toISOString(),
        retry_count: 0,
        error_message: result.error_message || null
      };

      await refundRecordService.addRecord(record);

      results.push({
        planet_user_id: refund.planet_user_id,
        planet_nickname: refund.planet_nickname,
        status: result.success ? 'SUCCESS' : 'FAILED',
        out_refund_no,
        wechat_refund_id: result.refund_id,
        error_code: result.error_code,
        error_message: result.error_message
      });

      if (result.success) successCount++;
      else failedCount++;
    }

    res.json(success({
      total: refunds.length,
      success: successCount,
      failed: failedCount,
      results
    }, '批量退款完成'));

  } catch (err) {
    next(err);
  }
});

/**
 * 查询退款记录
 */
router.get('/', async (req, res, next) => {
  try {
    const { camp_id, status, planet_user_id } = req.query;
    const data = await refundRecordService.getRecords();

    let records = data.records;

    // 过滤
    if (camp_id) records = records.filter(r => r.camp_id === camp_id);
    if (status) records = records.filter(r => r.refund_status === status);
    if (planet_user_id) records = records.filter(r => r.planet_user_id === planet_user_id);

    const successCount = records.filter(r => r.refund_status === 'SUCCESS').length;
    const failedCount = records.filter(r => r.refund_status === 'FAILED').length;

    res.json(success({
      records,
      total: records.length,
      success_count: successCount,
      failed_count: failedCount
    }));

  } catch (err) {
    next(err);
  }
});

/**
 * 查询单个退款详情
 */
router.get('/:out_refund_no', async (req, res, next) => {
  try {
    const { out_refund_no } = req.params;
    const record = await refundRecordService.findByOutRefundNo(out_refund_no);

    if (!record) {
      return res.json(error('退款记录不存在', 404));
    }

    // 查询微信退款状态
    const wechatStatus = await weworkPayService.queryRefund(out_refund_no);

    res.json(success({
      record,
      wechat_status: wechatStatus.success ? wechatStatus.data : null
    }));

  } catch (err) {
    next(err);
  }
});

/**
 * 重试失败的退款
 */
router.post('/:out_refund_no/retry', async (req, res, next) => {
  try {
    const { out_refund_no } = req.params;
    const record = await refundRecordService.findByOutRefundNo(out_refund_no);

    if (!record) {
      return res.json(error('退款记录不存在', 404));
    }

    if (record.refund_status === 'SUCCESS') {
      return res.json(error('该退款已成功,无需重试', 400));
    }

    // 重新调用退款 API
    const result = await weworkPayService.refund({
      transaction_id: record.transaction_id,
      out_refund_no: record.out_refund_no,
      refund_amount: record.refund_amount,
      total_amount: record.refund_amount,
      reason: record.refund_reason
    });

    // 更新记录
    const updated = await refundRecordService.updateStatus(out_refund_no, {
      refund_status: result.success ? 'SUCCESS' : 'FAILED',
      wechat_refund_id: result.refund_id || record.wechat_refund_id,
      refund_time: result.success_time || record.refund_time,
      retry_count: record.retry_count + 1,
      error_message: result.error_message || record.error_message
    });

    res.json(success(updated, '重试完成'));

  } catch (err) {
    next(err);
  }
});

module.exports = router;
```

---

## 🎨 前端实现

### 退款操作流程

**RefundList.vue 修改**:

```vue
<template>
  <div class="refund-list-page">
    <!-- 现有内容保持不变 -->

    <!-- 新增: 执行退款按钮 -->
    <el-row :gutter="20" style="margin-top: 20px">
      <el-col :span="24">
        <el-button
          type="danger"
          size="large"
          @click="handleExecuteRefund"
          :disabled="!hasQualifiedUsers"
          :loading="refundLoading">
          <el-icon><Money /></el-icon>
          执行退款 ({{ statistics.qualified_count }}人)
        </el-button>
      </el-col>
    </el-row>

    <!-- 退款确认对话框 -->
    <el-dialog
      v-model="refundDialogVisible"
      title="确认执行退款"
      width="600px">
      <el-alert type="warning" :closable="false" style="margin-bottom: 20px">
        <p><strong>即将为以下 {{ refundList.length }} 位用户退款</strong></p>
        <p>总金额: ¥{{ totalRefundAmount / 100 }} 元</p>
        <p style="color: red;">⚠️ 此操作不可撤销,请确认无误后再执行!</p>
      </el-alert>

      <el-table :data="refundList" height="300" border>
        <el-table-column prop="planet_nickname" label="用户昵称" width="200" />
        <el-table-column prop="checkined_days" label="打卡天数" width="100" />
        <el-table-column label="退款金额" width="120">
          <template #default="scope">
            <el-input
              v-model="scope.row.refund_amount"
              placeholder="金额(元)"
              size="small" />
          </template>
        </el-table-column>
        <el-table-column label="微信订单号" width="180">
          <template #default="scope">
            <el-input
              v-model="scope.row.transaction_id"
              placeholder="必填"
              size="small" />
          </template>
        </el-table-column>
      </el-table>

      <template #footer>
        <el-button @click="refundDialogVisible = false">取消</el-button>
        <el-button
          type="danger"
          @click="confirmRefund"
          :loading="refundLoading">
          确认退款
        </el-button>
      </template>
    </el-dialog>

    <!-- 退款进度对话框 -->
    <el-dialog
      v-model="progressDialogVisible"
      title="退款进度"
      width="500px"
      :close-on-click-modal="false">
      <el-progress
        :percentage="refundProgress"
        :status="refundProgressStatus" />
      <p style="margin-top: 10px; text-align: center;">
        {{ refundProgressText }}
      </p>
    </el-dialog>

    <!-- 退款结果对话框 -->
    <el-dialog
      v-model="resultDialogVisible"
      title="退款结果"
      width="600px">
      <el-result
        :icon="refundResult.success > 0 ? 'success' : 'error'"
        :title="`成功 ${refundResult.success} 笔, 失败 ${refundResult.failed} 笔`">
        <template #extra>
          <el-button type="primary" @click="resultDialogVisible = false">
            确定
          </el-button>
        </template>
      </el-result>

      <el-table :data="refundResult.results" border>
        <el-table-column prop="planet_nickname" label="用户" width="150" />
        <el-table-column label="状态" width="100">
          <template #default="scope">
            <el-tag :type="scope.row.status === 'SUCCESS' ? 'success' : 'danger'">
              {{ scope.row.status }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="error_message" label="说明" />
      </el-table>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue';
import { executeRefund } from '@/api/camps';
import { ElMessage, ElMessageBox } from 'element-plus';

// ... 现有代码 ...

const refundDialogVisible = ref(false);
const progressDialogVisible = ref(false);
const resultDialogVisible = ref(false);
const refundLoading = ref(false);
const refundList = ref([]);
const refundProgress = ref(0);
const refundProgressStatus = ref('');
const refundProgressText = ref('');
const refundResult = ref({ success: 0, failed: 0, results: [] });

const hasQualifiedUsers = computed(() => {
  return statistics.value.qualified_count > 0;
});

const totalRefundAmount = computed(() => {
  return refundList.value.reduce((sum, item) => sum + (item.refund_amount * 100 || 0), 0);
});

/**
 * 处理执行退款
 */
const handleExecuteRefund = () => {
  // 准备退款列表 (仅合格用户)
  refundList.value = refundData.value.refund_list
    .filter(user => user.is_qualified)
    .map(user => ({
      planet_user_id: user.planet_user_id,
      planet_nickname: user.planet_nickname,
      checkined_days: user.checkined_days,
      refund_amount: 99, // 默认99元,可编辑
      transaction_id: '', // 需要用户填入
      refund_reason: `完成${form.value.requiredDays}天打卡要求`
    }));

  refundDialogVisible.value = true;
};

/**
 * 确认退款
 */
const confirmRefund = async () => {
  // 验证微信订单号
  const missingTransactionIds = refundList.value.filter(item => !item.transaction_id);
  if (missingTransactionIds.length > 0) {
    ElMessage.error(`有 ${missingTransactionIds.length} 个用户未填写微信订单号`);
    return;
  }

  refundDialogVisible.value = false;
  progressDialogVisible.value = true;
  refundLoading.value = true;

  try {
    refundProgress.value = 0;
    refundProgressText.value = '正在执行退款...';
    refundProgressStatus.value = '';

    // 调用退款 API
    const response = await executeRefund({
      camp_id: route.params.id,
      camp_title: route.query.title,
      refunds: refundList.value.map(item => ({
        planet_user_id: item.planet_user_id,
        planet_nickname: item.planet_nickname,
        transaction_id: item.transaction_id,
        refund_amount: item.refund_amount * 100, // 转为分
        refund_reason: item.refund_reason
      }))
    });

    refundProgress.value = 100;
    refundProgressStatus.value = 'success';
    refundProgressText.value = '退款完成';

    // 显示结果
    refundResult.value = response.data;

    setTimeout(() => {
      progressDialogVisible.value = false;
      resultDialogVisible.value = true;
    }, 1000);

  } catch (error) {
    refundProgress.value = 100;
    refundProgressStatus.value = 'exception';
    refundProgressText.value = '退款失败';
    ElMessage.error(error.response?.data?.message || '退款失败');
  } finally {
    refundLoading.value = false;
  }
};
</script>
```

---

## 🧪 测试计划

### 单元测试

1. **wework-pay.service.js**
   - ✅ 正常退款成功
   - ✅ 退款金额错误
   - ✅ 订单号不存在
   - ✅ 证书文件缺失
   - ✅ API 超时

2. **refund-record.service.js**
   - ✅ 添加记录
   - ✅ 查询记录
   - ✅ 更新记录
   - ✅ 防重复检查
   - ✅ 文件备份

### 集成测试

1. **退款流程**
   - ✅ 批量退款成功
   - ✅ 部分成功部分失败
   - ✅ 全部失败
   - ✅ 重复退款拦截

2. **异常场景**
   - ✅ 网络异常
   - ✅ API 限流
   - ✅ 证书过期
   - ✅ JSON 文件损坏

### 手动测试

1. **前端交互**
   - ✅ 退款确认弹窗
   - ✅ 进度条显示
   - ✅ 结果展示
   - ✅ 失败重试

---

## 📋 开发任务清单

### 后端开发 (预计 6-8 小时)

- [ ] **Task 1**: 安装依赖 (0.5h)
  - `npm install wechatpay-node-v3 uuid fs-extra`

- [ ] **Task 2**: 实现 wework-pay.service.js (2h)
  - 退款接口封装
  - 查询退款状态
  - 错误处理

- [ ] **Task 3**: 实现 refund-record.service.js (1.5h)
  - JSON 文件读写
  - 记录增删改查
  - 自动备份

- [ ] **Task 4**: 实现 routes/refunds.js (2h)
  - 批量退款接口
  - 查询记录接口
  - 重试失败接口

- [ ] **Task 5**: 单元测试 (1h)
  - 服务层测试
  - 路由测试

### 前端开发 (预计 4-5 小时)

- [ ] **Task 6**: RefundList.vue 修改 (3h)
  - 执行退款按钮
  - 确认弹窗
  - 进度显示
  - 结果展示

- [ ] **Task 7**: API 封装 (1h)
  - `executeRefund()` 方法
  - `queryRefunds()` 方法

- [ ] **Task 8**: 前端测试 (1h)
  - 交互测试
  - 边界测试

### 部署和测试 (预计 2-3 小时)

- [ ] **Task 9**: 准备证书文件 (0.5h)
  - 下载证书
  - 配置路径

- [ ] **Task 10**: 环境变量配置 (0.5h)
  - 更新 .env.example
  - 配置生产环境

- [ ] **Task 11**: 生产部署 (1h)
  - 部署到服务器
  - 生产测试

---

## ⚠️ 风险和注意事项

### 安全风险

1. **证书泄露**
   - ❌ 不要提交证书到 Git
   - ✅ 使用 .gitignore 排除
   - ✅ 生产环境使用加密存储

2. **重复退款**
   - ✅ 使用唯一退款单号
   - ✅ 退款前检查记录
   - ✅ 幂等性保证

3. **数据丢失**
   - ✅ 每次写入前自动备份
   - ✅ 保留最近 30 天备份
   - ✅ 定期导出到安全位置

### 业务风险

1. **退款金额错误**
   - ✅ 前端二次确认
   - ✅ 退款金额与原订单匹配
   - ✅ 支持手动修正

2. **订单号缺失**
   - ⚠️ **v0.1 限制**: 需要手动输入微信订单号
   - 📌 v1 版本: 从支付记录自动关联

3. **退款失败处理**
   - ✅ 自动重试 1 次
   - ✅ 失败记录标记
   - ✅ 支持手动重试

### 技术风险

1. **JSON 文件并发写入**
   - ⚠️ 单进程应用,暂无并发问题
   - 📌 v1 版本: 使用数据库事务

2. **文件大小增长**
   - ✅ 单个训练营最多 200 条记录
   - ✅ 定期归档历史数据
   - 📌 v1 版本: 迁移到数据库

---

## 🔄 迁移到 v1 版本

### 数据迁移脚本

```javascript
// scripts/migrate-refund-records-to-v1.js

const fs = require('fs-extra');
const { Pool } = require('pg');

async function migrate() {
  // 读取 JSON 文件
  const data = await fs.readJson('./data/refund-records.json');

  // 连接数据库
  const pool = new Pool({
    host: 'localhost',
    database: 'camp_db',
    user: 'postgres',
    password: 'your_password'
  });

  // 插入记录
  for (const record of data.records) {
    await pool.query(`
      INSERT INTO refund_record (
        camp_id, planet_user_id, transaction_id,
        refund_amount, out_refund_no, refund_status,
        wechat_refund_id, refund_time, created_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    `, [
      record.camp_id,
      record.planet_user_id,
      record.transaction_id,
      record.refund_amount,
      record.out_refund_no,
      record.refund_status,
      record.wechat_refund_id,
      record.refund_time,
      record.created_at
    ]);
  }

  console.log(`已迁移 ${data.records.length} 条退款记录`);
  await pool.end();
}

migrate().catch(console.error);
```

---

## 📚 参考文档

- [微信支付 API v3 官方文档](https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml)
- [申请退款接口](https://pay.weixin.qq.com/doc/v3/merchant/4013071036)
- [wechatpay-node-v3 SDK](https://github.com/klover2/wechatpay-node-v3-ts)
- [微信支付证书获取指南](https://pay.weixin.qq.com/doc/v3/merchant/4012456946)

---

**文档版本**: v1.0
**最后更新**: 2025-10-30
**下一步**: 开始后端代码实现