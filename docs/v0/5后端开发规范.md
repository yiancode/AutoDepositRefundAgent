# 后端开发规范 - Node.js/Express 项目

## 📋 文档信息
- **版本**: v1.0
- **创建日期**: 2025-10-27
- **适用项目**: 知识星球训练营退款系统 v0
- **技术栈**: Node.js 18+ / Express.js 4.x
- **参考标准**: 阿里巴巴开发规约

---

## 目录

- [一、编程规约](#一编程规约)
- [二、代码结构规范](#二代码结构规范)
- [三、命名规范](#三命名规范)
- [四、注释规范](#四注释规范)
- [五、异常处理规范](#五异常处理规范)
- [六、日志规范](#六日志规范)
- [七、安全规范](#七安全规范)
- [八、测试规范](#八测试规范)
- [九、Git 规范](#九git-规范)

---

## 一、编程规约

### 1.1 核心原则

#### ✅ 文档先行原则
- **【强制】** 开发新功能前,必须先编写 API 文档(使用 JSDoc 或 Markdown)
- **【强制】** API 文档必须包含: 接口路径、请求参数、响应格式、错误码
- **【推荐】** 使用 Swagger/OpenAPI 自动生成 API 文档

**示例**:
```javascript
/**
 * 获取训练营列表
 *
 * @route GET /api/camps
 * @param {string} scope - 状态筛选: ongoing(进行中) / over(已结束) / closed(已关闭)
 * @returns {Object} 训练营列表
 * @returns {Object[]} data.camps - 训练营数组
 * @returns {number} data.camps[].checkin_id - 训练营ID
 * @returns {string} data.camps[].title - 训练营名称
 * @throws {400} scope 参数无效
 * @throws {403} Cookie 已过期
 *
 * @example
 * GET /api/camps?scope=over
 * Response: { code: 200, data: { camps: [...] } }
 */
router.get('/camps', async (req, res, next) => {
  // 实现代码
});
```

---

#### ✅ 测试驱动开发(TDD)原则
- **【强制】** 核心业务逻辑必须先写测试用例,再写实现代码
- **【推荐】** 使用 Jest 或 Mocha + Chai 作为测试框架
- **【推荐】** 测试覆盖率至少达到 70%

**TDD 开发流程**:
```
1. 编写测试用例(Red) → 测试失败
   ↓
2. 编写最小实现代码(Green) → 测试通过
   ↓
3. 重构优化代码(Refactor) → 测试仍然通过
   ↓
4. 循环迭代
```

**示例**:
```javascript
// 1. 先写测试 (camps.service.test.js)
describe('CampsService', () => {
  describe('getCamps', () => {
    it('应该返回已结束的训练营列表', async () => {
      const camps = await campsService.getCamps('over');
      expect(camps).toBeInstanceOf(Array);
      expect(camps.length).toBeGreaterThan(0);
      expect(camps[0]).toHaveProperty('checkin_id');
      expect(camps[0]).toHaveProperty('title');
    });

    it('scope参数无效时应该抛出异常', async () => {
      await expect(campsService.getCamps('invalid'))
        .rejects
        .toThrow('scope 参数无效');
    });
  });
});

// 2. 再写实现 (camps.service.js)
async getCamps(scope) {
  if (!['ongoing', 'over', 'closed'].includes(scope)) {
    throw new Error('scope 参数无效');
  }
  // 实现逻辑...
}
```

---

### 1.2 基本编码规范

#### 【强制】使用 ESLint 代码检查
```json
// .eslintrc.json
{
  "extends": "eslint:recommended",
  "env": {
    "node": true,
    "es2021": true
  },
  "parserOptions": {
    "ecmaVersion": 2021
  },
  "rules": {
    "indent": ["error", 2],
    "quotes": ["error", "single"],
    "semi": ["error", "always"],
    "no-unused-vars": "error",
    "no-console": "warn"
  }
}
```

#### 【强制】使用 Prettier 代码格式化
```json
// .prettierrc
{
  "semi": true,
  "singleQuote": true,
  "trailingComma": "es5",
  "printWidth": 100,
  "tabWidth": 2
}
```

---

## 二、代码结构规范

### 2.1 分层架构

```
Controller(控制器层)
    ↓ 职责: 路由映射、参数校验、调用Service
Service(业务逻辑层)
    ↓ 职责: 业务逻辑、事务管理、调用Manager
Manager(第三方服务封装层)
    ↓ 职责: API调用、数据转换、错误处理
Utils(工具层)
    ↓ 职责: 通用工具函数、常量定义
```

#### 【强制】职责单一原则
- **Controller**: 只负责接收请求和返回响应,不包含业务逻辑
- **Service**: 只负责业务逻辑,不直接调用第三方API
- **Manager**: 只负责封装第三方API,不包含业务逻辑

**反例**:
```javascript
// ❌ 错误: Controller 中包含业务逻辑
router.get('/camps', async (req, res) => {
  const { scope } = req.query;

  // 直接调用知识星球API - 错误!
  const response = await axios.get(`https://api.zsxq.com/v2/groups/xxx/checkins?scope=${scope}`);
  const camps = response.data.resp_data.checkins;

  // 业务逻辑处理 - 错误!
  const filteredCamps = camps.filter(camp => camp.status === 'over');

  res.json({ code: 200, data: { camps: filteredCamps } });
});
```

**正例**:
```javascript
// ✅ 正确: Controller 只负责调用 Service
router.get('/camps', async (req, res, next) => {
  try {
    const { scope } = req.query;
    const camps = await campsService.getCamps(scope);
    res.json(successResponse({ camps }));
  } catch (error) {
    next(error);
  }
});

// ✅ Service 负责业务逻辑
class CampsService {
  async getCamps(scope) {
    const camps = await zsxqManager.fetchCamps(scope);
    return camps.filter(camp => this.isValidCamp(camp));
  }
}

// ✅ Manager 负责API调用
class ZsxqManager {
  async fetchCamps(scope) {
    const response = await axios.get(this.buildUrl(scope), {
      headers: this.getHeaders()
    });
    return response.data.resp_data.checkins;
  }
}
```

---

### 2.2 文件组织规范

#### 【强制】文件命名规范
- 文件名使用 **小写字母 + 短横线**
- Service 类文件: `xxx.service.js`
- Manager 类文件: `xxx.manager.js`
- 工具函数: `xxx.util.js`
- 中间件: `xxx.middleware.js`
- 路由: `xxx.route.js`

**示例**:
```
src/
├── services/
│   ├── camps.service.js
│   ├── refund.service.js
│   └── checkin.service.js
├── managers/
│   └── zsxq.manager.js
├── middlewares/
│   ├── auth.middleware.js
│   └── error.middleware.js
└── utils/
    ├── response.util.js
    └── validator.util.js
```

---

## 三、命名规范

### 3.1 变量命名

#### 【强制】使用小驼峰命名法(camelCase)
```javascript
// ✅ 正确
const userName = 'John';
const checkinCount = 10;
const isQualified = true;

// ❌ 错误
const user_name = 'John';  // 不使用下划线
const CheckinCount = 10;   // 不使用大驼峰
const is_qualified = true; // 不使用下划线
```

#### 【强制】布尔变量使用 is/has/should 前缀
```javascript
// ✅ 正确
const isValid = true;
const hasPermission = false;
const shouldRetry = true;

// ❌ 错误
const valid = true;
const permission = false;
```

#### 【推荐】常量使用全大写+下划线
```javascript
// ✅ 正确
const MAX_RETRY_COUNT = 3;
const API_BASE_URL = 'https://api.zsxq.com';
const DEFAULT_PAGE_SIZE = 100;

// ❌ 错误
const maxRetryCount = 3;
const ApiBaseUrl = 'https://api.zsxq.com';
```

---

### 3.2 函数命名

#### 【强制】使用动词或动词短语
```javascript
// ✅ 正确
async function getCamps() { }
async function createRefundList() { }
async function validateCookie() { }
async function calculateQualifiedCount() { }

// ❌ 错误
async function camps() { }       // 缺少动词
async function refundList() { } // 缺少动词
```

#### 【推荐】函数命名遵循一词一义
- `get`: 获取数据(查询)
- `create`: 创建新数据
- `update`: 更新已有数据
- `delete`: 删除数据
- `validate`: 校验数据
- `calculate`: 计算结果
- `generate`: 生成数据

---

### 3.3 类命名

#### 【强制】使用大驼峰命名法(PascalCase)
```javascript
// ✅ 正确
class CampsService { }
class ZsxqManager { }
class AuthMiddleware { }

// ❌ 错误
class campsService { }
class zsxq_manager { }
```

---

## 四、注释规范

### 4.1 JSDoc 注释

#### 【强制】所有导出的函数/类必须有 JSDoc 注释
```javascript
/**
 * 生成退款名单
 *
 * @param {number} checkinId - 训练营ID
 * @param {number} requiredDays - 要求打卡天数
 * @returns {Promise<Object>} 退款名单和统计数据
 * @returns {Array<Object>} data.refund_list - 退款名单数组
 * @returns {Object} data.statistics - 统计数据
 * @throws {Error} 训练营不存在
 * @throws {Error} requiredDays 参数无效
 *
 * @example
 * const result = await refundService.generateRefundList(123, 7);
 * // result: { refund_list: [...], statistics: {...} }
 */
async generateRefundList(checkinId, requiredDays) {
  // 实现代码
}
```

#### 【推荐】复杂业务逻辑添加行内注释
```javascript
async getRankingList(checkinId) {
  const allRankings = [];
  let index = 0;
  const MAX_PAGES = 2; // 最多翻2页(200人)

  while (index < MAX_PAGES) {
    // 调用知识星球API获取单页数据
    const rankings = await this.fetchRankingPage(checkinId, index);
    allRankings.push(...rankings);

    // 判断是否还有更多数据
    if (rankings.length < 100) break;

    // 延迟200ms,避免触发API限流
    await new Promise(resolve => setTimeout(resolve, 200));
    index++;
  }

  return allRankings;
}
```

---

### 4.2 TODO 注释

#### 【推荐】使用统一的 TODO 格式
```javascript
// TODO(张三): 需要优化查询性能,添加Redis缓存 - 2025-10-30
// FIXME(李四): Cookie过期检测逻辑有bug,需修复 - 2025-10-27
// HACK: 临时方案,知识星球API返回格式不稳定,后续优化
```

---

## 五、异常处理规范

### 5.1 统一异常处理

#### 【强制】使用统一的错误处理中间件
```javascript
// error.middleware.js
function errorMiddleware(err, req, res, next) {
  logger.error(`请求失败: ${req.method} ${req.path}`, {
    error: err.message,
    stack: err.stack
  });

  // Cookie 失效错误
  if (err.message.includes('Cookie 已过期')) {
    return res.status(403).json(errorResponse(403, err.message));
  }

  // 参数校验错误
  if (err.message.includes('参数')) {
    return res.status(400).json(errorResponse(400, err.message));
  }

  // 默认错误
  return res.status(500).json(errorResponse(500, '服务器内部错误'));
}
```

---

### 5.2 异常抛出规范

#### 【强制】使用语义化的错误信息
```javascript
// ✅ 正确: 明确的错误信息
if (!requiredDays || requiredDays <= 0) {
  throw new Error('required_days 必须为正整数');
}

if (requiredDays > campInfo.checkin_days) {
  throw new Error(`完成天数不能超过训练营总天数(${campInfo.checkin_days}天)`);
}

// ❌ 错误: 模糊的错误信息
if (!requiredDays) {
  throw new Error('参数错误');
}
```

#### 【推荐】自定义错误类
```javascript
// custom-error.js
class BusinessError extends Error {
  constructor(code, message) {
    super(message);
    this.code = code;
    this.name = 'BusinessError';
  }
}

class ValidationError extends BusinessError {
  constructor(message) {
    super(400, message);
    this.name = 'ValidationError';
  }
}

class AuthError extends BusinessError {
  constructor(message) {
    super(401, message);
    this.name = 'AuthError';
  }
}

// 使用
throw new ValidationError('required_days 必须为正整数');
throw new AuthError('API Key 无效');
```

---

## 六、日志规范

### 6.1 日志级别

#### 【强制】使用正确的日志级别
- **error**: 系统错误,需要立即处理(如API调用失败、数据库连接失败)
- **warn**: 警告信息,需要关注(如Cookie即将过期、参数可疑)
- **info**: 重要业务信息(如用户登录、订单创建)
- **debug**: 调试信息(仅开发环境)

```javascript
// ✅ 正确
logger.error('知识星球 API 调用失败', { error: err.message });
logger.warn('Cookie 将在3天后过期,请及时更新');
logger.info(`生成退款名单成功,训练营ID=${checkinId},合格人数=${qualifiedCount}`);
logger.debug('请求参数:', req.body);

// ❌ 错误
logger.info('知识星球 API 调用失败'); // 应该用 error
logger.error('用户点击了按钮');        // 应该用 debug
```

---

### 6.2 日志格式

#### 【强制】日志必须包含关键信息
```javascript
// ✅ 正确: 结构化日志
logger.info('生成退款名单完成', {
  checkin_id: checkinId,
  required_days: requiredDays,
  total_count: statistics.total_count,
  qualified_count: statistics.qualified_count,
  duration: Date.now() - startTime
});

// ❌ 错误: 非结构化日志
logger.info('生成退款名单完成');
```

---

## 七、安全规范

### 7.1 敏感信息保护

#### 【强制】禁止在代码中硬编码敏感信息
```javascript
// ❌ 错误: 硬编码
const API_KEY = 'abc123';
const PASSWORD = 'admin123';

// ✅ 正确: 使用环境变量
const API_KEY = process.env.API_KEY;
const PASSWORD = process.env.PASSWORD;
```

#### 【强制】禁止在日志中输出敏感信息
```javascript
// ❌ 错误
logger.info('Cookie:', process.env.ZSXQ_AUTHORIZATION);
logger.info('用户密码:', user.password);

// ✅ 正确
logger.info('Cookie 已加载');
logger.info('用户登录成功', { user_id: user.id });
```

---

### 7.2 输入校验

#### 【强制】所有外部输入必须校验
```javascript
// ✅ 正确: 严格校验
router.post('/camps/:checkin_id/refund-list', async (req, res, next) => {
  try {
    const { checkin_id } = req.params;
    const { required_days } = req.body;

    // 校验 checkin_id
    if (!checkin_id || !Number.isInteger(Number(checkin_id))) {
      return res.status(400).json(errorResponse(400, 'checkin_id 必须为整数'));
    }

    // 校验 required_days
    if (!required_days || !Number.isInteger(required_days) || required_days <= 0) {
      return res.status(400).json(errorResponse(400, 'required_days 必须为正整数'));
    }

    // 业务逻辑...
  } catch (error) {
    next(error);
  }
});
```

---

## 八、测试规范

### 8.1 单元测试

#### 【强制】核心业务逻辑必须有单元测试
```javascript
// refund.service.test.js
const RefundService = require('../services/refund.service');

describe('RefundService', () => {
  let refundService;

  beforeEach(() => {
    refundService = new RefundService();
  });

  describe('generateRefundList', () => {
    it('应该正确计算合格人数', async () => {
      const result = await refundService.generateRefundList(123, 7);

      expect(result.statistics.total_count).toBe(99);
      expect(result.statistics.qualified_count).toBe(85);
      expect(result.statistics.qualified_rate).toBe(85.86);
    });

    it('打卡天数>=要求天数的用户应该被标记为合格', async () => {
      const result = await refundService.generateRefundList(123, 7);

      const qualifiedUsers = result.refund_list.filter(u => u.is_qualified);
      qualifiedUsers.forEach(user => {
        expect(user.checkined_days).toBeGreaterThanOrEqual(7);
      });
    });
  });
});
```

---

### 8.2 测试覆盖率

#### 【推荐】测试覆盖率要求
- **核心业务逻辑**: ≥ 80%
- **工具函数**: ≥ 90%
- **整体项目**: ≥ 70%

```bash
# 运行测试并生成覆盖率报告
npm run test:coverage

# package.json
{
  "scripts": {
    "test": "jest",
    "test:coverage": "jest --coverage",
    "test:watch": "jest --watch"
  },
  "jest": {
    "coverageThreshold": {
      "global": {
        "branches": 70,
        "functions": 70,
        "lines": 70,
        "statements": 70
      }
    }
  }
}
```

---

## 九、Git 规范

### 9.1 分支管理

#### 【强制】分支命名规范
- **主分支**: `main` 或 `master`
- **功能分支**: `feature/功能名称`
- **修复分支**: `fix/bug描述`
- **重构分支**: `refactor/模块名称`

**示例**:
```bash
feature/cookie-update
feature/refund-list-generation
fix/cookie-validation-bug
refactor/zsxq-manager
```

---

### 9.2 提交规范(Conventional Commits)

#### 【强制】提交信息格式
```
<type>(<scope>): <subject>

<body>

<footer>
```

**type 类型**:
- `feat`: 新功能
- `fix`: 修复 Bug
- `docs`: 文档更新
- `style`: 代码格式(不影响功能)
- `refactor`: 重构(不是新功能也不是修复)
- `test`: 测试相关
- `chore`: 构建/工具配置

**示例**:
```bash
feat(api): 添加Cookie更新接口

- 新增 POST /api/config/zsxq-cookie 接口
- 支持动态更新知识星球Cookie
- 自动验证新Cookie是否有效

Closes #123

---

fix(service): 修复打卡排行榜翻页逻辑

修复当人数>100时无法获取全部数据的bug

---

docs(readme): 更新部署文档

添加Let's Encrypt HTTPS配置步骤
```

---

### 9.3 代码审查(Code Review)

#### 【推荐】Pull Request 必须经过审查
- **【强制】** PR 必须至少1人审查通过才能合并
- **【推荐】** 使用 PR 模板

**PR 模板示例**:
```markdown
## 变更类型
- [ ] 新功能
- [ ] Bug 修复
- [ ] 重构
- [ ] 文档更新

## 变更说明
简要描述本次变更的内容...

## 测试
- [ ] 已添加单元测试
- [ ] 已通过所有测试
- [ ] 已手动测试

## Checklist
- [ ] 代码符合 ESLint 规范
- [ ] 已更新相关文档
- [ ] 已添加必要的注释
```

---

## 附录A: 代码审查清单

### 功能性
- [ ] 代码是否实现了需求?
- [ ] 边界条件是否处理?
- [ ] 错误处理是否完善?

### 可读性
- [ ] 命名是否语义化?
- [ ] 注释是否充分?
- [ ] 代码逻辑是否清晰?

### 性能
- [ ] 是否有性能瓶颈?
- [ ] 循环是否可优化?
- [ ] 是否有内存泄漏风险?

### 安全性
- [ ] 输入是否校验?
- [ ] 敏感信息是否加密?
- [ ] SQL注入/XSS 是否防护?

### 测试
- [ ] 是否有单元测试?
- [ ] 测试覆盖率是否达标?
- [ ] 测试用例是否充分?

---

## 附录B: 常用工具配置

### package.json
```json
{
  "scripts": {
    "start": "node src/app.js",
    "dev": "nodemon src/app.js",
    "test": "jest",
    "test:coverage": "jest --coverage",
    "lint": "eslint src/**/*.js",
    "lint:fix": "eslint src/**/*.js --fix",
    "format": "prettier --write \"src/**/*.js\""
  },
  "devDependencies": {
    "eslint": "^8.0.0",
    "prettier": "^3.0.0",
    "jest": "^29.0.0",
    "nodemon": "^3.0.0"
  }
}
```

---

**文档结束**

**版本历史**:
- v1.0 (2025-10-27): 初始版本,参考阿里巴巴开发规约
