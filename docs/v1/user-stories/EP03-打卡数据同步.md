# EP03: 打卡数据同步

## Epic 概述

| 字段 | 内容 |
|------|------|
| **Epic ID** | EP03 |
| **Epic 名称** | 打卡数据同步 |
| **业务目标** | 系统能够自动同步知识星球的打卡数据 |
| **涉及角色** | 系统、管理员 |
| **优先级** | P0 |

---

## Story 3.1: 定时自动同步

| 字段 | 内容 |
|------|------|
| **Story ID** | S3.1 |
| **角色** | 作为系统 |
| **目标** | 我需要每日自动同步打卡数据 |
| **价值** | 以便于保持打卡统计的准确性 |
| **优先级** | P0 |

### 验收标准

```gherkin
Feature: 定时自动同步
  作为系统
  我需要每日自动同步打卡数据
  以便于保持打卡统计的准确性

  Background:
    Given 存在进行中的训练营
    And 知识星球 Token 有效

  Scenario: 正常同步
    Given 定时任务触发（每日 01:00）
    When 执行同步任务
    Then 调用知识星球 API 获取打卡数据
    And 更新会员打卡天数
    And 记录同步日志
    And 同步成功率 100%

  Scenario: API 调用失败后重试
    Given 知识星球 API 调用失败
    When 自动重试（最多3次）
    And 第2次重试成功
    Then 同步成功完成
    And 记录重试日志

  Scenario: 重试全部失败
    Given 知识星球 API 连续调用失败 3 次
    When 重试全部失败
    Then 标记同步失败
    And 发送告警通知到企业微信
    And 记录失败原因

  Scenario: Token 过期
    Given 知识星球返回 TokenExpiredException
    When 识别为 Token 过期
    Then 暂停同步任务
    And 发送紧急告警
    And 提示管理员更新 Token

  Scenario: 数据翻页处理
    Given 训练营参与人数超过 100 人
    When 执行同步
    Then 自动翻页获取全部数据
    And 合并所有页的打卡记录
```

### 任务拆分

- [ ] Task 3.1.1: 实现定时任务配置
- [ ] Task 3.1.2: 集成 zsxq-sdk（参见 [集成指南](../guides/dev-zsxq-sdk集成指南.md)）
- [ ] Task 3.1.3: 实现翻页逻辑（SDK 内置支持）
- [ ] Task 3.1.4: 实现重试机制（SDK 内置支持）
- [ ] Task 3.1.5: 实现告警通知
- [ ] Task 3.1.6: 编写单元测试
- [ ] Task 3.1.7: 编写集成测试

---

## Story 3.2: 手动触发同步

| 字段 | 内容 |
|------|------|
| **Story ID** | S3.2 |
| **角色** | 作为一名管理员 |
| **目标** | 我希望能够手动触发打卡数据同步 |
| **价值** | 以便于在需要时获取最新数据 |
| **优先级** | P1 |

### 验收标准

```gherkin
Feature: 手动触发同步
  作为一名管理员
  我希望能够手动触发打卡数据同步
  以便于在需要时获取最新数据

  Background:
    Given 管理员已登录
    And 管理员具有同步权限

  Scenario: 成功触发同步
    Given 选择训练营 "21天早起打卡"
    When 点击 "同步打卡数据" 按钮
    Then 显示同步进度
    And 同步完成后显示结果
    And 显示更新的记录数

  Scenario: 频繁触发限制
    Given 5分钟内已触发过同步
    When 再次点击同步按钮
    Then 显示 "请稍后再试（距离上次同步不足5分钟）"

  Scenario: 同步过程中查看进度
    Given 同步任务正在执行
    When 查看同步状态
    Then 显示当前进度（已处理/总数）
    And 显示预计剩余时间
```

### 任务拆分

- [ ] Task 3.2.1: 实现手动同步接口
- [ ] Task 3.2.2: 实现限流控制
- [ ] Task 3.2.3: 实现进度查询
- [ ] Task 3.2.4: 编写测试用例

---

## Story 3.3: 打卡统计计算

| 字段 | 内容 |
|------|------|
| **Story ID** | S3.3 |
| **角色** | 作为系统 |
| **目标** | 我需要正确计算每个会员的打卡统计 |
| **价值** | 以便于判断会员是否达到退款条件 |
| **优先级** | P0 |

### 验收标准

> **宽限天数说明**：宽限天数表示允许漏打的天数。
> **合格判定公式**：`实际打卡天数 >= (要求天数 - 宽限天数)`
> **合格状态**：参见 [状态枚举定义](../design/状态枚举定义.md) - checkin_status

```gherkin
Feature: 打卡统计计算
  作为系统
  我需要正确计算每个会员的打卡统计
  以便于判断会员是否达到退款条件

  Background:
    Given 训练营要求打卡 15 天
    And 宽限天数为 1 天
    # 合格条件：实际打卡 >= 15 - 1 = 14 天

  Scenario: 超额完成（全勤）
    Given 会员实际打卡 15 天
    When 计算打卡统计
    Then 判断 15 >= 14（合格线）
    And checkin_status = "qualified"
    And 标记为全勤（full_attendance = true）

  Scenario: 刚好合格
    Given 会员实际打卡 14 天
    When 计算打卡统计
    Then 判断 14 >= 14（合格线）
    And checkin_status = "qualified"

  Scenario: 刚好不合格
    Given 会员实际打卡 13 天
    When 计算打卡统计
    Then 判断 13 < 14（合格线）
    And checkin_status = "unqualified"

  Scenario: 无打卡记录
    Given 会员打卡 0 天
    When 计算打卡统计
    Then 判断 0 < 14（合格线）
    And checkin_status = "unqualified"

  Scenario: 数据不一致处理
    Given 本地记录打卡 10 天
    And 知识星球 API 返回打卡 12 天
    When 同步并计算
    Then 以知识星球数据为准，更新为 12 天
    And 记录数据变更日志
```

### 任务拆分

- [ ] Task 3.3.1: 实现打卡统计计算逻辑
- [ ] Task 3.3.2: 实现宽限天数配置
- [ ] Task 3.3.3: 实现合格状态判断
- [ ] Task 3.3.4: 编写单元测试（覆盖边界情况）

---

## 技术实现细节

### 知识星球 SDK 集成

> **详细指南**：[dev-zsxq-sdk集成指南.md](../guides/dev-zsxq-sdk集成指南.md)

采用 zsxq-sdk 替代自实现 HTTP 调用，提供类型安全的 API 封装：

```java
// Spring Bean 配置
@Configuration
public class ZsxqSdkConfig {
    @Bean
    public ZsxqClient zsxqClient(@Value("${zsxq.token}") String token) {
        return new ZsxqClientBuilder()
            .token(token)
            .timeout(10000)
            .retryCount(3)
            .build();
    }
}

// 打卡同步服务
@Service
@RequiredArgsConstructor
public class CheckinSyncService {
    private final ZsxqClient zsxqClient;

    /**
     * 获取训练营打卡排行榜
     */
    public List<RankingItem> getCheckinRanking(String groupId, String checkinId) {
        return zsxqClient.checkins()
            .getRankingList(groupId, checkinId, "accumulated");
    }

    /**
     * 验证 Token 是否有效
     */
    public boolean validateToken() {
        try {
            return zsxqClient.users().self() != null;
        } catch (TokenExpiredException | TokenInvalidException e) {
            return false;
        }
    }
}
```

### 同步任务配置

```yaml
# application.yml
scheduler:
  checkin-sync:
    cron: "0 0 1 * * ?"  # 每日 01:00
    retry-count: 3
    retry-interval: 5000  # 毫秒

checkin:
  grace-days: 1  # 宽限天数
```

### 同步状态枚举 (sync_status)

| 枚举值 | 含义 | 说明 |
|--------|------|------|
| `RUNNING` | 进行中 | 同步任务正在执行 |
| `SUCCESS` | 成功 | 同步完成，无错误 |
| `PARTIAL` | 部分成功 | 部分数据同步成功，部分失败 |
| `FAILED` | 失败 | 同步失败（重试耗尽或严重错误） |
| `CANCELLED` | 已取消 | 手动取消或系统中断 |

### 同步日志结构

```json
{
  "syncId": "SYNC20250101010000",
  "campId": 1,
  "campName": "21天早起打卡训练营",
  "startTime": "2025-01-01T01:00:00",
  "endTime": "2025-01-01T01:00:05",
  "status": "SUCCESS",           // sync_status 枚举值
  "triggerType": "SCHEDULED",    // SCHEDULED | MANUAL
  "totalMembers": 150,
  "updatedCount": 150,
  "failedCount": 0,
  "retryCount": 0,
  "message": "同步成功"
}
```

---

## 相关文档

- [状态枚举定义](../design/状态枚举定义.md) - **SSOT**: checkin_status、sync_status
- [技术方案](../design/技术方案.md)
- [数据库设计](../design/数据库设计.md) - camp_member 表字段
- [dev-zsxq-sdk集成指南](../guides/dev-zsxq-sdk集成指南.md) - **知识星球 SDK 集成**
- [EP02: 会员报名与支付](./EP02-会员报名与支付.md)
- [EP04: 身份匹配](./EP04-身份匹配.md)

---

**文档版本**: v1.2
**最后更新**: 2025-12-12
**变更历史**:
- v1.2: 改为集成 zsxq-sdk，Cookie→Token，添加 SDK 集成指南引用
- v1.1: 修正宽限天数计算逻辑表述，添加状态枚举定义引用
- v1.0: 初始版本
