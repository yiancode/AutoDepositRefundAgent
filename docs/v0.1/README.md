# v0.1 版本文档

**版本**: v0.1 (企微退款增强版)
**基于**: v0 版本
**创建时间**: 2025-10-30
**状态**: 开发中

---

## 📋 版本概述

v0.1 是在 v0 (简化版) 基础上的增强版本,主要新增**企业微信支付退款**功能,实现真正的自动退款。

### 与 v0 的区别

| 特性 | v0 | v0.1 |
|-----|-------|-------|
| **训练营列表** | ✅ | ✅ |
| **打卡数据获取** | ✅ | ✅ |
| **退款名单生成** | ✅ | ✅ |
| **Excel/图片导出** | ✅ | ✅ |
| **企微支付对接** | ❌ | ✅ **新增** |
| **自动退款执行** | ❌ | ✅ **新增** |
| **退款记录管理** | ❌ | ✅ **新增** |
| **退款失败重试** | ❌ | ✅ **新增** |
| **数据库** | ❌ | ❌ (仍使用 JSON) |

### 核心新增功能

1. ✅ **企业微信支付配置管理**
   - 商户号、API Key、证书文件配置
   - 环境变量管理

2. ✅ **退款 API 集成**
   - 微信支付 v3 退款接口封装
   - 退款状态查询
   - 自动重试机制

3. ✅ **退款记录持久化**
   - JSON 文件存储 (保持无数据库特性)
   - 自动备份机制
   - 防重复退款

4. ✅ **前端退款流程**
   - 退款操作确认弹窗
   - 批量退款进度显示
   - 退款结果展示

---

## 📚 文档列表

| 文档 | 路径 | 说明 |
|------|------|------|
| **技术方案** | [技术方案.md](./技术方案.md) | 完整的技术架构、API 设计、代码实现 |
| **开发计划** | [开发计划.md](./开发计划.md) | 详细的任务清单和时间估算 (待创建) |
| **部署指南** | [部署指南.md](./部署指南.md) | 生产环境部署步骤 (待创建) |
| **API 文档** | [API文档.md](./API文档.md) | 退款接口详细文档 (待创建) |

---

## 🏗️ 技术架构

### 技术栈

**后端**:
- Node.js 18+ + Express.js 4.x
- **wechatpay-node-v3** (微信支付 SDK)
- fs-extra (JSON 文件管理)
- uuid (唯一标识生成)

**前端**:
- Vue 3 + Vite + Element Plus (与 v0 一致)

**数据存储**:
- JSON 文件 (无数据库)

### 新增服务

```
zsxq-api/
├── src/
│   ├── services/
│   │   ├── wework-pay.service.js       # 企微支付 API 封装
│   │   ├── refund-record.service.js    # 退款记录管理
│   │   └── refund.service.js           # 退款业务协调 (已有,增强)
│   ├── routes/
│   │   └── refunds.js                  # 退款路由 (新增)
│   └── config/
│       └── wechat.js                   # 微信支付配置 (新增)
├── certs/                              # 证书目录 (新增)
│   ├── apiclient_cert.pem
│   ├── apiclient_key.pem
│   └── README.md
└── data/                               # 数据目录 (新增)
    ├── refund-records.json
    └── backups/
```

---

## 🚀 快速开始

### 环境要求

- Node.js 18+
- 微信支付商户账号
- 商户 API 证书

### 安装依赖

```bash
cd zsxq-api

# 安装新增依赖
npm install wechatpay-node-v3 uuid fs-extra
```

### 配置证书

1. 下载微信支付商户证书
2. 放置到 `zsxq-api/certs/` 目录
3. 配置 `.env` 文件

```env
# 微信支付配置
WECHAT_APP_ID=wx1234567890abcdef
WECHAT_MCH_ID=1234567890
WECHAT_API_V3_KEY=your_api_v3_key_32_characters
WECHAT_SERIAL_NO=1234567890ABCDEF
WECHAT_CERT_PATH=./certs/apiclient_cert.pem
WECHAT_KEY_PATH=./certs/apiclient_key.pem
```

### 启动服务

```bash
# 开发环境
npm run dev

# 生产环境
npm run pm2:start
```

---

## 📋 开发进度

### 当前状态: 设计完成,准备开发

- [x] 技术方案设计
- [x] API 接口设计
- [x] 数据模型设计
- [ ] 后端代码实现
- [ ] 前端界面实现
- [ ] 测试
- [ ] 部署

### 预计开发时间

- 后端实现: 6-8 小时
- 前端实现: 4-5 小时
- 测试部署: 2-3 小时
- **总计**: 12-16 小时

---

## ⚠️ 重要限制

### v0.1 版本限制

1. **手动输入微信订单号**
   - 由于没有支付记录表,需要用户在退款时手动输入 `transaction_id`
   - v1 版本将自动从数据库关联

2. **JSON 文件存储**
   - 单个训练营最多支持 200 人退款记录
   - 不支持复杂查询
   - v1 版本将迁移到 PostgreSQL

3. **单进程运行**
   - JSON 文件读写无并发控制
   - 建议单进程部署 (PM2 instances=1)

---

## 🔄 迁移到 v1

v0.1 的退款记录可以平滑迁移到 v1 版本的数据库:

```bash
# 使用迁移脚本
node scripts/migrate-refund-records-to-v1.js
```

详见: [技术方案.md - 迁移到 v1 版本](./技术方案.md#迁移到-v1-版本)

---

## 📞 支持

如有问题,请查看:
- [技术方案.md](./技术方案.md) - 完整技术文档
- [已知问题](../progress/KNOWN_ISSUES.md) - 常见问题解决方案

---

**最后更新**: 2025-10-30
**维护者**: Claude Code
